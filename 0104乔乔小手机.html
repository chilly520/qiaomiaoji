<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹”ä¹”å°æ‰‹æœº OS</title>

    <meta http-equiv="Content-Security-Policy"
        content="connect-src * data: blob: 'unsafe-inline'; default-src * data: blob: 'unsafe-inline' 'unsafe-eval';">
    <meta name="referrer" content="no-referrer">

    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1b4b">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden {
            display: none !important;
        }
    </style>


    <!-- Tone.js éŸ³é¢‘åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- LZString Compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Embed Manifest -->
    <link rel="manifest" id="manifest-placeholder">



    <style>
        /* Base Fonts & Vars */

        :root {
            --app-bg-color: #f0fdf4;
            --text-color: #166534;
            --glass-border: rgba(16, 185, 129, 0.3);
            --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(217, 249, 233, 0.8));
            --accent-color: #34d399;
            --input-bg: rgba(255, 255, 255, 0.95);
            --wechat-green: #10b981;
            --bubble-self: #d1fae5;
            --bubble-other: #ffffff;
            --transfer-color: #f59e0b;
            --redpacket-color: #ef4444;
            --light-pink: #fce7f3;
            --light-green: #d1fae5;
            --light-yellow: #fef3c7;
            --light-purple: #ede9fe;
            --blue-pink-gradient: linear-gradient(135deg, #bae6fd, #fbcfe8);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            background-color: var(--app-bg-color);
            color: var(--text-color);
        }

        /* Wallpaper */
        #wallpaper-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%);
            background-size: cover;
            background-position: center;
            z-index: -2;
            transition: background-image 0.5s ease;
        }

        /* UI Components */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 20px 0 rgba(56, 189, 248, 0.15);
        }

        .glass-bar {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(56, 189, 248, 0.2);
        }

        .glass-icon {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15),
                inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .glass-icon::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.4) 0%, transparent 60%);
            pointer-events: none;
        }

        .glass-icon:active {
            transform: scale(0.9) translateY(2px);
            box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.2);
        }

        .glass-icon i,
        .glass-icon svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            transition: transform 0.3s ease;
        }

        .glass-icon:hover i,
        .glass-icon:hover svg {
            transform: scale(1.1);
        }

        .glass-icon:active {
            transform: scale(0.92);
            filter: brightness(1.1);
        }

        .glass-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .widget-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* App Window */
        .app-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(40px);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        .app-window.active {
            transform: translateX(0);
        }

        .app-header {
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            margin-top: 30px;
            border-bottom: 1px solid rgba(56, 189, 248, 0.2);
            background: rgba(255, 255, 255, 0.9);
            flex-shrink: 0;
            z-index: 50;
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: visible;
            padding: 16px;
            padding-bottom: 80px;
        }

        /* Inputs */
        .setting-input {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            padding: 10px;
            border-radius: 8px;
            color: var(--text-color);
            margin-bottom: 8px;
            font-size: 13px;
            transition: 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.15);
        }

        /* Fullscreen Input Mode */
        .fullscreen-input {
            transition: all 0.3s ease;
            resize: none;
        }

        /* Chat Input Specific Styles */
        #chat-input {
            transition: all 0.3s ease;
        }

        .url-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .url-input-group input {
            margin-bottom: 0;
            flex: 1;
        }

        .url-input-group button {
            width: auto;
            padding: 0 16px;
        }

        select.setting-input {
            appearance: none !important;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 1rem center !important;
            background-size: 1em !important;
            min-height: 40px !important;
            padding: 10px !important;
        }

        select.setting-input option {
            background-color: #ffffff !important;
            color: #1e293b !important;
            padding: 8px !important;
            min-height: 30px !important;
        }

        /* ä¸»æŒ‰é’®ï¼šæ¸…æ–°çš„æ·¡è“è‰²æ¸å˜ (Baby Blue) */
        .setting-btn {
            background: linear-gradient(135deg, #A5D8FF, #74C0FC);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(165, 216, 255, 0.3), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .setting-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(165, 216, 255, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .setting-btn:active {
            transform: scale(0.98) translateY(0);
            box-shadow: 0 2px 8px rgba(165, 216, 255, 0.3);
        }

        /* æ¬¡çº§æŒ‰é’®ï¼šææ·¡çš„è“ç°è‰²èƒŒæ™¯ */
        .setting-btn.secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 249, 255, 0.8));
            border: 1px solid rgba(165, 216, 255, 0.6);
            color: #5c7cfa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .setting-btn.secondary:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(240, 249, 255, 1));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .setting-btn.danger {
            background: linear-gradient(135deg, #ef4444, #be123c);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .setting-btn.danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .section-title {
            font-size: 12px;
            color: #0ea5e9;
            margin: 16px 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            opacity: 0.8;
        }

        /* Desktop Swiper */
        .app-pages-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .app-pages-container.active {
            cursor: grabbing;
        }



        .dock-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        /* Adjust app page to not overlap dock */
        .app-page {
            min-width: 100%;
            height: 100%;
            scroll-snap-align: start;
            padding: 1.5rem 1rem 120px 1rem;
            /* Added bottom padding */
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-template-rows: min-content min-content min-content auto;
            gap: 1rem;
            align-content: start;
            overflow-y: auto;
        }

        /* WeChat Specific */
        .wechat-tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 10px;
            gap: 2px;
        }

        .wechat-tab-btn.active {
            color: var(--wechat-green);
        }

        .sub-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .sub-view.active {
            transform: translateX(0);
        }

        /* è®¾ç½®èŠå¤©å­é¡µé¢èƒŒæ™¯ä¸ºç™½è‰² */
        #subpage-chat-detail {
            background: white !important;
        }

        #subpage-char-settings {
            z-index: 300;
        }

        /* Mirror of the global wallpaper inside subpages to avoid showing underlying app content */
        #subpage-wallpaper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            z-index: 0;
            pointer-events: none;
        }

        #subpage-char-settings {
            background: #ffffff;
        }

        #subpage-char-settings>.app-header {
            position: relative;
            z-index: 20;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        #subpage-char-settings>.p-4,
        #subpage-char-settings .app-content {
            position: relative;
            z-index: 10;
            background: #ffffff;
        }

        /* When char-settings is active, block interaction with underlying layers */
        #subpage-char-settings.active~#subpage-chat-detail {
            pointer-events: none;
        }

        /* Chat Bubble System */
        .msg-row {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            align-items: flex-start;
            padding: 0 5px;
            transition: background 0.2s;
        }

        .msg-row.self {
            flex-direction: row-reverse;
        }

        /* æ”¯ä»˜/çº¢åŒ…å¡ç‰‡æ ·å¼ - è¡¥ä¸ */
        .pay-card {
            width: 230px;
            background-color: #fa9d3b;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            margin: 2px 0;
            position: relative;
        }

        .pay-card.received {
            opacity: 0.6;
        }

        .pay-top {
            display: flex;
            align-items: center;
            padding: 15px 12px;
        }

        .pay-icon {
            width: 36px;
            height: 36px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: white;
            margin-right: 10px;
        }

        .pay-info {
            flex: 1;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pay-title {
            font-size: 15px;
            font-weight: 500;
            line-height: 1.2;
        }

        .pay-desc {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .pay-bottom {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ°”æ³¡å†…çš„ç‰¹æ®Šæ ·å¼ä¿®æ­£ */
        .bubble-redpacket .pay-card,
        .pay-card[onclick*="redpacket"] {
            background-color: #fa9d3b;
        }


        /* æ”¯ä»˜/çº¢åŒ…å¡ç‰‡æ ·å¼ */
        .pay-card {
            width: 230px;
            background-color: var(--wechat-green);
            /* é»˜è®¤ç”¨ä¹‹å‰çš„å˜é‡æˆ–ç›´æ¥å†™ #fa9d3b */
            background-color: #fa9d3b;
            /* æ˜ç¡®æŒ‡å®šæ©™è‰² */
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            margin: 2px 0;
            position: relative;
        }

        .pay-card.received {
            opacity: 0.6;
        }

        .pay-top {
            display: flex;
            align-items: center;
            padding: 15px 12px;
        }

        .pay-icon {
            width: 36px;
            height: 36px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: white;
            margin-right: 10px;
        }

        .pay-info {
            flex: 1;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pay-title {
            font-size: 15px;
            font-weight: 500;
            line-height: 1.2;
        }

        .pay-desc {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .pay-bottom {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* æ°”æ³¡å†…çš„ç‰¹æ®Šæ ·å¼ä¿®æ­£ */
        .bubble-redpacket .pay-card,
        .pay-card[onclick*="redpacket"] {
            background-color: #fa9d3b;
            /* çº¢åŒ…é€šå¸¸ä¹Ÿæ˜¯æ©™è‰² */
        }

        /* é’ˆå¯¹type=redpacketç‰¹åˆ«å¤„ç†é¢œè‰²ï¼Œå¦‚æœéœ€è¦æ›´çº¢ä¸€ç‚¹å¯ä»¥è¿™é‡Œçš„ */



        /* Checkbox for Multi-select */
        .msg-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #666;
            margin-top: 10px;
            margin-right: 10px;
            flex-shrink: 0;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .msg-row.self .msg-checkbox {
            margin-right: 0;
            margin-left: 10px;
        }

        .multiselect-mode .msg-checkbox {
            display: flex;
        }

        .msg-checkbox.checked {
            background: var(--wechat-green);
            border-color: var(--wechat-green);
        }

        .msg-checkbox.checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 10px;
            color: white;
        }

        /* Unread Badge */
        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- å¾®ä¿¡æ°”æ³¡æ ·å¼ (ä¿®æ­£ç‰ˆ) --- */
        /* å³ä¾§ (æˆ‘/User)ï¼šæ·±è‰²é£æ ¼ */
        .chat-bubble-right {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            /* æ·±ç°/æ·±è“ */
            color: #f3f4f6;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px 14px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-family: "SimSun", "Songti SC", "Noto Serif SC", serif;
        }

        .chat-bubble-right::after {
            content: "";
            position: absolute;
            right: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 0 6px 8px;
            border-color: transparent transparent transparent #1f2937;
        }

        /* å·¦ä¾§ (æˆ‘/User/NPC)ï¼šé»‘é‡‘é£æ ¼ */
        /* å·¦ä¾§ (æˆ‘/User/NPC)ï¼šé»‘é‡‘é£æ ¼ */
        .chat-bubble-left {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: #f0e6d2;
            /* æ·¡é¦™æ§Ÿé‡‘ */
            border: 1px solid rgba(240, 230, 210, 0.3);
            border-radius: 6px;
            padding: 10px 14px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-family: "SimSun", "Songti SC", "Noto Serif SC", serif;
            font-weight: 500;
        }

        .chat-bubble-left::after {
            content: "";
            position: absolute;
            left: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 8px 6px 0;
            border-color: transparent #1a1a1a transparent transparent;
        }

        .chat-bubble-left::before {
            content: "";
            position: absolute;
            left: -7px;
            top: 14px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 8px 6px 0;
            border-color: transparent rgba(212, 175, 55, 0.4) transparent transparent;
            z-index: -1;
        }



        .msg-avatar {
            width: 40px;
            height: 40px;
            overflow: hidden;
            flex-shrink: 0;
            background: #333;
        }

        .msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .msg-avatar.circle {
            border-radius: 50%;
        }

        .msg-avatar.square {
            border-radius: 6px;
        }

        /* Avatar Box for Chat List and Contacts */
        .avatar-box {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* --- å¥½å‹ç”³è¯·å¡ç‰‡æ ¸å¿ƒæ ·å¼ --- */
        /* æé«˜ä¼˜å…ˆçº§ï¼Œç¡®ä¿å¡ç‰‡æ ·å¼ç”Ÿæ•ˆ */
        .msg-row .msg-content .friend-request-card,
        .friend-request-card {
            /* é‡ç½®flexå¸ƒå±€ */
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: space-between !important;
            width: auto !important;
            max-width: 90vw !important;
            min-width: 280px !important;
            padding: 12px 16px !important;
            margin: 0 auto !important;

            /* å¢å¼ºåŠé€æ˜ç£¨ç ‚ç»ç’ƒèƒŒæ™¯ - æ›´æ˜æ˜¾çš„é€æ˜æ•ˆæœ */
            background: rgba(147, 197, 253, 0.3) !important;
            /* é™ä½é€æ˜åº¦ï¼Œè®©ä¸‹é¢å†…å®¹æ›´æ¸…æ™°å¯è§ */
            backdrop-filter: blur(16px) !important;
            /* å¢å¼ºæ¨¡ç³Šæ•ˆæœ */
            -webkit-backdrop-filter: blur(16px) !important;

            /* è¾¹æ¡†ä¸åœ†è§’ */
            border-radius: 16px !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
            /* æ›´é€æ˜çš„è¾¹æ¡† */
            box-shadow: 0 6px 20px rgba(31, 38, 135, 0.15) !important;
            /* è°ƒæ•´é˜´å½±ï¼Œå¢å¼ºå±‚æ¬¡æ„Ÿ */
            position: relative !important;
            box-sizing: border-box !important;
            z-index: 1 !important;
        }

        /* Moments Share Card Styles */
        .moment-share-card {
            width: 240px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .moment-share-card:active {
            transform: scale(0.98);
        }

        .moment-share-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .moment-share-card .p-3 {
            padding: 12px;
        }

        /* Inner Voice Trigger Card Styles */
        .inner-voice-trigger-card {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            border: 1px solid #ddd;
            border-radius: 14px;
            padding: 15px;
            width: 220px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .inner-voice-trigger-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .inner-voice-trigger-card::before {
            content: 'ğŸ’­';
            position: absolute;
            right: -5px;
            bottom: -5px;
            font-size: 40px;
            opacity: 0.1;
        }


        /* å¤´åƒä¸ä¿¡æ¯åŒºåŸŸ */
        .friend-request-card .user-info {
            display: flex !important;
            align-items: center !important;
            gap: 12px !important;
            flex-shrink: 0 !important;
        }

        /* ä¿®å¤è¡¨æƒ…åŒ…åº“åˆ†ç±»ä¸‹æ‹‰èœå•è¢«æŒ¡ä½çš„é—®é¢˜ */
        /* ç¡®ä¿çˆ¶å®¹å™¨ä¸ä¼šè£å‰ªselectçš„ä¸‹æ‹‰èœå• */
        #subpage-char-settings .flex-1.overflow-y-auto {
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        /* ç¡®ä¿è¡¨æƒ…åŒ…åº“åˆ†ç±»ä¸‹æ‹‰èœå•èƒ½æ­£å¸¸æ˜¾ç¤º */
        /* ä½¿ç”¨å®¹å™¨åŒ…è£…selectå…ƒç´ ï¼Œç¡®ä¿ä¸‹æ‹‰èœå•æ˜¾ç¤º */
        #emoji-category-select {
            position: relative;
            z-index: 99999;
            display: block !important;
            transform: none !important;
        }

        /* ç¡®ä¿selectå…ƒç´ çš„å®¹å™¨æœ‰è¶³å¤Ÿé«˜çš„z-index */
        .flex.gap-2.mb-2 {
            position: relative;
            z-index: 99999;
        }

        /* ç¡®ä¿åˆ†ç±»å’Œä¸Šä¼ æŒ‰é’®ä¿æŒæ°´å¹³æ’åˆ— */
        .flex.gap-2.mb-2 {
            display: flex !important;
            flex-wrap: nowrap !important;
            gap: 8px !important;
        }

        /* ç¡®ä¿selectå…ƒç´ å æ»¡å¯ç”¨ç©ºé—´ */
        #emoji-category-select {
            flex: 1 !important;
            min-width: 150px !important;
        }

        /* ä¿®å¤è¡¨æƒ…åŒ…åº“åˆ†ç±»å’Œä¸Šä¼ æŒ‰é’®ä¸Šä¸‹æ’åˆ—çš„é—®é¢˜ */
        /* ç¡®ä¿è¡¨æƒ…åŒ…åº“å®¹å™¨æ˜¯flexå¸ƒå±€ï¼Œåˆ†ç±»å’Œä¸Šä¼ æŒ‰é’®æ°´å¹³æ’åˆ— */
        div.flex.gap-2.mb-2 {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            align-items: flex-start !important;
            gap: 8px !important;
        }

        /* ç¡®ä¿selectå…ƒç´ å’Œä¸Šä¼ æŒ‰é’®åœ¨åŒä¸€è¡Œ */
        div.flex.gap-2.mb-2>select {
            display: inline-block !important;
            flex: 1 !important;
            height: 40px !important;
        }

        /* ç¡®ä¿ä¸Šä¼ æŒ‰é’®åœ¨åŒä¸€è¡Œ */
        div.flex.gap-2.mb-2>button.setting-btn.secondary.text-sm {
            white-space: nowrap !important;
            height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* ç¡®ä¿flexå®¹å™¨çš„æ‰€æœ‰å­å…ƒç´ éƒ½åœ¨åŒä¸€è¡Œ */
        div.flex.gap-2.mb-2>* {
            display: inline-block !important;
            vertical-align: top !important;
        }

        .friend-request-card .avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }

        .friend-request-card .text-group {
            display: flex !important;
            flex-direction: column !important;
            flex-shrink: 1 !important;
            min-width: 0 !important;
        }

        .friend-request-card .name {
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #2c3e50 !important;
            margin-bottom: 2px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .friend-request-card .status {
            font-size: 12px !important;
            color: #4b5563 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .friend-request-card .action-group {
            display: flex !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        }

        .friend-request-card .btn {
            border: none !important;
            padding: 6px 14px !important;
            border-radius: 20px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            white-space: nowrap !important;
        }

        /* åŒæ„æŒ‰é’® */
        .friend-request-card .btn-accept {
            background: #3b82f6 !important;
            color: #fff !important;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
        }

        /* æ‹’ç»æŒ‰é’® */
        .friend-request-card .btn-decline {
            background: rgba(255, 255, 255, 0.7) !important;
            color: #6b7280 !important;
        }

        /* ç¡®ä¿å¡ç‰‡åœ¨æ¶ˆæ¯è¡Œä¸­å±…ä¸­æ˜¾ç¤º */
        .msg-row.other .msg-content {
            display: flex !important;
            justify-content: center !important;
            max-width: 100% !important;
        }

        /* ç¡®ä¿æ¶ˆæ¯å®¹å™¨ä¸é™åˆ¶å¡ç‰‡å®½åº¦ */
        .msg-row .msg-content {
            max-width: 100% !important;
        }

        /* Moments Image Container (å·²ä¿®å¤ï¼šå…è®¸HTMLå¡ç‰‡å›¾ç‰‡å…¨å®½) */
        .msg-content img {
            max-width: 100% !important;
            height: auto !important;
            display: block !important;
        }

        .msg-content>div {
            max-width: 100% !important;
            overflow: hidden !important;
        }

        /* Chat List Item - Fixed Height */
        #tab-chat>div[onclick] {
            min-height: 72px;
            height: 72px;
            box-sizing: border-box;
        }

        /* Chat List Preview Text - Prevent Overflow */
        #tab-chat>div[onclick] .text-sm.truncate {
            max-height: 20px;
            overflow: hidden;
            line-height: 20px;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Chat Image Messages */
        /* å®¹å™¨ï¼šé™åˆ¶æœ€å¤§å°ºå¯¸ï¼Œç¡®ä¿å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º */
        .msg-image {
            max-width: 100px !important;
            max-height: 100px !important;
            width: fit-content !important;
            height: auto !important;
            border-radius: 8px !important;
            overflow: visible !important;
            display: inline-block !important;
        }

        /* ========== Moments (æœ‹å‹åœˆ) Styles ========== */

        /* Moments Navigation Bar */
        .moments-nav {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
        }

        .moments-nav-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .moments-nav-btn:hover {
            background: #e5e7eb;
            color: #374151;
            transform: scale(1.05);
        }

        .moments-nav-btn:active {
            transform: scale(0.95);
        }

        /* Moment Card */
        .moment-card {
            background: white;
            border-bottom: 1px solid #f3f4f6;
            padding: 16px;
            display: flex;
            gap: 12px;
        }

        .moment-card:hover {
            background: #fafafa;
        }

        .moment-avatar {
            width: 44px;
            height: 44px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
        }

        .moment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-body {
            flex: 1;
            min-width: 0;
        }

        .moment-author {
            font-size: 15px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .moment-author:hover {
            text-decoration: underline;
        }

        .moment-content {
            font-size: 15px;
            line-height: 1.5;
            color: #1f2937;
            margin-bottom: 8px;
            word-wrap: break-word;
        }

        /* Moment Images Grid */
        .moment-images {
            margin-bottom: 8px;
            display: grid;
            gap: 4px;
        }

        /* 1å¼ å›¾ï¼šå¤§å›¾ */
        .moment-images.count-1 {
            grid-template-columns: 1fr;
            max-width: 280px;
        }

        .moment-images.count-1 img {
            width: 100%;
            max-height: 350px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* 2-4å¼ å›¾ï¼š2åˆ—ç½‘æ ¼ */
        .moment-images.count-2,
        .moment-images.count-3,
        .moment-images.count-4 {
            grid-template-columns: repeat(2, 1fr);
            max-width: 200px;
        }

        .moment-images.count-2 img,
        .moment-images.count-3 img,
        .moment-images.count-4 img {
            width: 100%;
            height: 95px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* 5-9å¼ å›¾ï¼š3åˆ—ç½‘æ ¼ */
        .moment-images.count-5,
        .moment-images.count-6,
        .moment-images.count-7,
        .moment-images.count-8,
        .moment-images.count-9 {
            grid-template-columns: repeat(3, 1fr);
            max-width: 240px;
        }

        .moment-images.count-5 img,
        .moment-images.count-6 img,
        .moment-images.count-7 img,
        .moment-images.count-8 img,
        .moment-images.count-9 img {
            width: 100%;
            height: 75px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        /* Moments Settings Modal Styles */
        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group-title {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 10px;
            padding-left: 4px;
        }

        .settings-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .settings-item-label {
            font-size: 15px;
            color: #1e293b;
            font-weight: 500;
        }

        .settings-item-desc {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }

        .settings-profile-preview {
            width: 100%;
            height: 120px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .settings-profile-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .settings-profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            border: 2px solid white;
            position: absolute;
            bottom: 10px;
            right: 10px;
            object-fit: cover;
            background: #ddd;
        }

        .settings-profile-name {
            position: absolute;
            bottom: 30px;
            right: 80px;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            font-size: 16px;
        }

        /* Custom Select */
        .settings-select {
            appearance: none;
            background: transparent;
            border: none;
            font-size: 14px;
            color: #64748b;
            text-align: right;
            padding-right: 15px;
            cursor: pointer;
        }

        .moment-images img:hover {
            opacity: 0.9;
        }

        /* Moment Location */
        .moment-location {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .moment-location i {
            font-size: 12px;
        }

        /* Moment Time */
        .moment-time {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        /* Moment Actions Bar */
        .moment-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
            padding: 8px 0;
        }

        .moment-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            background: none;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .moment-action-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .moment-action-btn.liked {
            color: #ef4444;
        }

        .moment-action-btn i {
            font-size: 16px;
        }

        /* Moment Interactions Box */
        .moment-interactions {
            background: #f7f8fa;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 8px;
        }

        .moment-interactions:empty {
            display: none;
        }

        /* Likes List */
        .moment-likes {
            font-size: 13px;
            color: #1f2937;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 8px;
        }

        .moment-likes:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .moment-likes i {
            color: #ef4444;
            margin-right: 4px;
        }

        .moment-likes .like-name {
            color: #4a5568;
            margin-right: 4px;
        }

        /* Comments List */
        .moment-comments {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .moment-comment {
            font-size: 13px;
            line-height: 1.4;
        }

        .moment-comment .comment-author {
            color: #4a5568;
            font-weight: 500;
            cursor: pointer;
        }

        .moment-comment .comment-author:hover {
            text-decoration: underline;
        }

        .moment-comment .comment-content {
            color: #1f2937;
        }

        /* My Moment Actions (Edit/Delete) */
        .moment-my-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f3f4f6;
        }

        .moment-my-action-btn {
            font-size: 12px;
            color: #6b7280;
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .moment-my-action-btn:hover {
            color: #ef4444;
        }

        /* Publish Moment Modal */
        #modal-publish-moment {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #modal-publish-moment .modal-box {
            max-width: 500px;
            width: 90vw;
        }

        #moment-content-input {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            resize: vertical;
            margin-bottom: 12px;
        }

        #moment-content-input:focus {
            outline: none;
            border-color: #10b981;
        }

        #moment-images-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .moment-image-preview-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 6px;
            overflow: hidden;
            background: #f3f4f6;
        }

        .moment-image-preview-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .moment-image-preview-item .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .moment-image-preview-item .remove-btn:hover {
            background: rgba(239, 68, 68, 0.9);
        }

        /* å›¾ç‰‡ï¼šè®©å®½é«˜è‡ªé€‚åº”ï¼Œç¡®ä¿æ˜¾ç¤ºå…¨å›¾ï¼Œç»å¯¹ä¸è£å‰ª */
        .msg-image img {
            width: auto !important;
            height: auto !important;
            max-width: 100px !important;
            max-height: 100px !important;
            object-fit: contain !important;
            display: block !important;
        }

        /* Ensure image container doesn't exceed bubble width */
        .msg-content .msg-image {
            max-width: 100px !important;
        }

        /* ç»Ÿä¸€çš„ .msg-content æ ·å¼å®šä¹‰ */
        .msg-content {
            max-width: 100% !important;
            overflow: hidden !important;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* è¡¨æƒ…åŒ…åº“åˆ†ç±»ä¸‹æ‹‰æ¡†æ ·å¼ */
        #emoji-category-select {
            font-size: 16px !important;
            padding: 8px 12px !important;
            min-height: 40px !important;
            min-width: 150px !important;
            position: static !important;
        }

        /* ç¡®ä¿ä¸‹æ‹‰èœå•èƒ½å¤Ÿçªç ´çˆ¶å®¹å™¨é™åˆ¶ */
        .flex-1.overflow-y-auto {
            overflow-y: auto;
            overflow-x: visible;
            contain: size layout style;
        }

        /* --- è¯­éŸ³æ¡æ ·å¼é‡æ„ (ä»¿é»‘é‡‘èƒ¶å›Šé£æ ¼) --- */
        .voice-container {
            display: flex;
            flex-direction: column;
            width: auto;
        }

        .voice-bubble {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 16px;
            height: 40px;
            /* å›ºå®šé«˜åº¦å¢åŠ è´¨æ„Ÿ */
            border-radius: 20px;
            /* èƒ¶å›Šå½¢çŠ¶ */
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            min-width: 70px;
            max-width: 220px;
        }

        /* å¯¹æ–¹è¯­éŸ³æ¡ï¼šé»‘é‡‘æ¸å˜ + é‡‘è‰²å¾®è¾¹æ¡† */
        .msg-row.other .voice-bubble {
            background: linear-gradient(135deg, #2b2623 0%, #1a1a1c 100%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: #e6dcc0;
        }

        /* è‡ªå·±è¯­éŸ³æ¡ï¼šæ·±ç°æ¸å˜ */
        .msg-row.self .voice-bubble {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            flex-direction: row-reverse;
            /* å›¾æ ‡é å³ */
        }

        .voice-icon {
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        .voice-playing .voice-icon i {
            animation: wifi-pulse 1s infinite;
            /* æ’­æ”¾æ³¢çº¹ */
        }

        .voice-duration {
            font-size: 14px;
            font-weight: 500;
            font-family: Arial, sans-serif;
        }

        /* æ–‡å­—åŒºåŸŸï¼šæ·±è‰²åŠé€æ˜èƒŒæ™¯ */
        .voice-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            margin-top: 6px;
            padding: 10px 12px;
            border-radius: 12px;
            background-color: rgba(0, 0, 0, 0.3);
            /* å…³é”®ï¼šæ¯”å‘¨å›´æ›´æš— */
            border: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            display: none;
            line-height: 1.5;
        }

        .voice-text.expanded {
            display: block;
        }

        @keyframes wifi-pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.3;
            }
        }

        /* Chat Bubble System (Custom Dark Gold Style) */
        .chat-bubble {
            padding: 10px 14px;
            font-size: 15px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            min-height: 36px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
        }

        /* å¯¹æ–¹æ°”æ³¡ (å·¦ä¾§ - æš—é‡‘) */
        .msg-row.other .chat-bubble {
            background: radial-gradient(circle at top left, #2a2520 0%, #0e0e10 100%);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-top: 1px solid rgba(212, 175, 55, 0.4);
            color: #e6dcc0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            font-family: 'Noto Serif SC', serif;
            font-weight: 300;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            border-radius: 2px 12px 12px 12px;
        }

        /* è‡ªå·±æ°”æ³¡ (å³ä¾§ - æ·±ç°) */
        .msg-row.self .chat-bubble {
            background: radial-gradient(circle at top right, #374151 0%, #1f2937 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: #e5e7eb;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            font-family: 'Noto Serif SC', serif;
            font-weight: 300;
            letter-spacing: 0.5px;
            border-radius: 12px 2px 12px 12px;
        }

        /* Timestamp Outside Bubble */
        .msg-time-outside {
            font-size: 9px;
            opacity: 0.8;
            color: #64748b;
            margin-top: 4px;
            padding: 0 2px;
        }

        .msg-row.self .msg-time-outside {
            align-self: flex-end;
            text-align: right;
        }

        .msg-row.other .msg-time-outside {
            align-self: flex-start;
            text-align: left;
        }

        /* System Message */
        .msg-system {
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
            margin: 10px 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .msg-system span {
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: default;
        }

        .msg-system.clickable span {
            cursor: pointer;
            text-decoration: underline;
        }

        .msg-system .time {
            font-size: 9px;
            margin-bottom: 4px;
            opacity: 0.7;
            background: transparent;
            padding: 0;
            text-decoration: none !important;
        }

        .msg-error span {
            background: rgba(220, 38, 38, 0.6);
            color: white;
        }

        /* Triangles (å·²ç¦ç”¨ï¼Œé€‚é…æ¸å˜æ°”æ³¡) */
        .msg-row.other .chat-bubble::before,
        .msg-row.self .chat-bubble::before {
            display: none;
        }

        /* Red Packet & Transfer Styles */
        .pay-card {
            width: 230px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 4px;
            padding: 0 !important;
            background: transparent !important;
            cursor: pointer;
            transition: opacity 0.2s, filter 0.2s, transform 0.1s, box-shadow 0.1s;
            position: relative;
        }

        /* æ·»åŠ ç‚¹å‡»åé¦ˆæ•ˆæœ */
        .pay-card:not(.received):not(.rejected):active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* æ·»åŠ æ‚¬åœæ•ˆæœ */
        .pay-card:not(.received):not(.rejected):hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .pay-card.received,
        .pay-card.rejected {
            opacity: 0.7;
            filter: grayscale(0.8);
            cursor: default;
        }

        .pay-top {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            height: 60px;
        }

        .pay-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 18px;
        }

        .pay-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .pay-title {
            font-size: 15px;
            font-weight: 500;
            line-height: 1.2;
        }

        .pay-desc {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.2;
            margin-top: 2px;
        }

        .pay-bottom {
            background: white;
            padding: 6px 12px;
            font-size: 11px;
            color: #888;
        }

        /* Specific Bubble Colors & Triangles */
        .bubble-transfer {
            background-color: var(--transfer-color) !important;
            padding: 0 !important;
        }

        .bubble-redpacket {
            background-color: var(--redpacket-color) !important;
            padding: 0 !important;
        }

        /* HTMLä¸“ç”¨æ°”æ³¡æ ·å¼ */
        .bubble-html {
            padding: 12px !important;
            border-radius: 8px !important;
            overflow: hidden !important;
        }

        /* ä¸ºHTMLæ°”æ³¡æ·»åŠ ç‰¹æ®ŠèƒŒæ™¯æ•ˆæœ */
        .msg-row.other .bubble-html {
            background: linear-gradient(135deg, #ffffff, #f8fafc) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        }

        .msg-row.self .bubble-html {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15) !important;
        }

        /* ç§»é™¤å¥½å‹ç”³è¯·å¡ç‰‡çš„æ°”æ³¡ä¸‰è§’å½¢ */
        .friend-request-card::before {
            content: none !important;
        }

        /* HTMLæ°”æ³¡çš„ä¸‰è§’æ ·å¼ */
        .msg-row.other .bubble-html::before {
            border-right-color: #ffffff !important;
        }

        .msg-row.self .bubble-html::before {
            border-left-color: #d1fae5 !important;
        }

        /* HTMLéš”ç¦»å®¹å™¨æ ·å¼ */
        .html-isolated-container {
            all: initial !important;
            width: 100% !important;
            height: auto !important;
            overflow: auto !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            color: #333 !important;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }

        /* åŸºç¡€é‡ç½®ï¼Œä½†å…è®¸3Då˜æ¢å…ƒç´ ä¾‹å¤– */
        .html-isolated-container *:not(.diary-container):not(.diary-book):not(.cover):not(.page-first):not(.page-second):not(.back-cover):not(.cover-content):not(.page-first-content) {
            all: initial !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            color: #333 !important;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            display: inline !important;
        }

        /* å…è®¸3Då˜æ¢ç›¸å…³å…ƒç´ æ­£å¸¸å·¥ä½œ */
        .html-isolated-container .diary-container,
        .html-isolated-container .diary-book,
        .html-isolated-container .cover,
        .html-isolated-container .page-first,
        .html-isolated-container .page-second,
        .html-isolated-container .back-cover,
        .html-isolated-container .cover-content,
        .html-isolated-container .page-first-content {
            all: unset !important;
            box-sizing: border-box !important;
        }

        /* ç¡®ä¿å—çº§å…ƒç´ æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container .diary-container,
        .html-isolated-container .diary-book,
        .html-isolated-container .cover,
        .html-isolated-container .page-first,
        .html-isolated-container .page-second,
        .html-isolated-container .back-cover,
        .html-isolated-container .cover-content,
        .html-isolated-container .page-first-content {
            display: block !important;
            position: relative !important;
        }

        /* å…è®¸å°é¢å†…å®¹ä¸­çš„æ ‡é¢˜æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container .cover-content h3 {
            font-size: 16px !important;
            font-weight: bold !important;
            margin: 0 0 5px 0 !important;
            color: #5a6782 !important;
            display: block !important;
        }

        /* å…è®¸å°é¢å†…å®¹ä¸­çš„æ®µè½æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container .cover-content p {
            font-size: 12px !important;
            color: #7889a4 !important;
            margin: 0 !important;
            line-height: 1.2 !important;
            display: block !important;
        }

        /* å…è®¸ç¬¬ä¸€é¡µå†…å®¹ä¸­çš„æ®µè½æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container .page-first-content p {
            font-size: 12px !important;
            color: #333 !important;
            line-height: 1.5 !important;
            margin-bottom: 10px !important;
            display: block !important;
        }

        /* å…è®¸ç¬¬äºŒé¡µä¸­çš„å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container .page-second img {
            width: 80% !important;
            height: auto !important;
            border-radius: 8px !important;
            object-fit: cover !important;
            display: block !important;
        }

        /* ç¡®ä¿æŒ‰é’®æ­£å¸¸æ˜¾ç¤ºå’Œäº¤äº’ */
        .html-isolated-container button {
            margin-top: 20px !important;
            padding: 5px 10px !important;
            border: 1px solid #7889a4 !important;
            border-radius: 5px !important;
            background-color: white !important;
            color: #5a6782 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 12px !important;
            display: inline-block !important;
        }

        .html-isolated-container button:hover {
            background-color: #f0f0f0 !important;
        }

        /* é‡ç½®éƒ¨åˆ†å¸¸ç”¨æ ‡ç­¾ */
        .html-isolated-container h1,
        .html-isolated-container h2,
        .html-isolated-container h3 {
            font-size: 20px !important;
            font-weight: bold !important;
            margin: 10px 0 !important;
            display: block !important;
        }

        .html-isolated-container p {
            margin: 10px 0 !important;
            display: block !important;
        }

        .html-isolated-container button {
            background: #34d399 !important;
            color: white !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            margin: 5px 0 !important;
            display: inline-block !important;
        }

        /* 3Dæ—¥è®°ä¸“ç”¨æ ·å¼ */
        .html-isolated-container .diary-container {
            max-width: 300px !important;
            margin: 0 auto !important;
            background-color: white !important;
            border-radius: 10px !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            overflow: hidden !important;
            perspective: 1000px !important;
        }

        /* çº¢åŒ…å¤´åƒä¿®å¤ */
        #rp-open-avatar img,
        #rp-user-avatar img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            object-position: center !important;
        }

        .html-isolated-container .diary-book {
            width: 100% !important;
            height: 200px !important;
            transform-style: preserve-3d !important;
            transition: transform 1s !important;
        }

        .html-isolated-container .cover {
            width: 50% !important;
            height: 100% !important;
            backface-visibility: hidden !important;
            background: linear-gradient(135deg, #f3e7e9, #e3eeff) !important;
            border-radius: 0 10px 10px 0 !important;
            left: 50% !important;
            transform-origin: left center !important;
            transition: transform 1s !important;
            z-index: 4 !important;
        }

        .html-isolated-container .page-first {
            width: 50% !important;
            height: 100% !important;
            background: #f9f9f9 !important;
            left: 50% !important;
            transform-origin: left center !important;
            transform: rotateY(180deg) !important;
            backface-visibility: hidden !important;
            z-index: 3 !important;
            border-radius: 0 10px 10px 0 !important;
        }

        .html-isolated-container .page-second {
            width: 50% !important;
            height: 100% !important;
            background: #f9f9f9 !important;
            left: 0 !important;
            border-radius: 10px 0 0 10px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 2 !important;
        }

        .html-isolated-container .back-cover {
            width: 50% !important;
            height: 100% !important;
            background: linear-gradient(135deg, #e3eeff, #f3e7e9) !important;
            left: 0 !important;
            border-radius: 10px 0 0 10px !important;
            z-index: 1 !important;
            transform: rotateY(180deg) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }

        .html-isolated-container .cover-content {
            padding: 20px !important;
            text-align: center !important;
        }

        .html-isolated-container .page-first-content {
            padding: 15px !important;
        }

        .html-isolated-container .diary-image {
            text-align: center !important;
            padding: 15px !important;
            background-color: #f9f9f9 !important;
        }

        /* ç¡®ä¿å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º */
        .html-isolated-container img {
            width: auto !important;
            height: auto !important;
            max-width: 100% !important;
            border-radius: 8px !important;
            display: block !important;
            margin: 0 auto !important;
        }

        .msg-row.self .bubble-transfer::before {
            border-left-color: var(--transfer-color) !important;
        }

        .msg-row.other .bubble-transfer::before {
            border-right-color: var(--transfer-color) !important;
        }

        .msg-row.self .bubble-redpacket::before {
            border-left-color: var(--redpacket-color) !important;
        }

        .msg-row.other .bubble-redpacket::before {
            border-right-color: var(--redpacket-color) !important;
        }

        /* Voice Bubble Styles */
        .voice-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            /* ç§»é™¤ align-items: flex-startï¼Œè®©çˆ¶çº§ msg-row æ§åˆ¶å·¦å³ */
        }

        /* å¢åŠ ä»¥ä¸‹è§„åˆ™ç¡®ä¿å¯¹é½ */
        .msg-row.self .voice-container {
            align-items: flex-end;
        }

        .msg-row.other .voice-container {
            align-items: flex-start;
        }

        .voice-bubble {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            /* å›¾æ ‡å’Œç§’æ•°é å¾—æ›´è¿‘ */
            min-width: 40px;
            /* æœ€å°å®½åº¦å†æ¬¡ç¼©å° */
            max-width: 160px;
            /* æœ€å¤§å®½åº¦é™åˆ¶ä½ */
            width: fit-content;
            /* å…³é”®ï¼šåªå ç”¨å¿…è¦å®½åº¦ */
            padding: 0 10px 0 8px;
            /* æ›´åŠ ç´§å‡‘çš„å†…è¾¹è· */
            height: 32px;
            /* ã€ç˜¦èº«å…³é”®ã€‘é«˜åº¦å›ºå®šä¸º 32pxï¼Œæ˜¾ç»† */
            border-radius: 16px;
            /* ã€åœ†æ¶¦å…³é”®ã€‘å˜æˆèƒ¶å›Šå½¢çŠ¶ */
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            /* åŠ ä¸€ç‚¹ç‚¹å¾®é˜´å½±å¢åŠ è´¨æ„Ÿ */
        }

        /* ä¸ºè¯­éŸ³æ°”æ³¡æ·»åŠ èƒŒæ™¯é¢œè‰² */
        .msg-row.self .voice-bubble {
            background: radial-gradient(circle at top right, #374151 0%, #1f2937 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e5e7eb;
        }

        .msg-row.other .voice-bubble {
            background: radial-gradient(circle at top left, #2a2520 0%, #0e0e10 100%);
            border: 1px solid rgba(212, 175, 55, 0.2);
            color: #e6dcc0;
        }

        /* è¡¥å……ï¼šè®©å›¾æ ‡ä¹Ÿå˜å°ä¸€ç‚¹ */
        .voice-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .voice-duration {
            font-size: 13px;
            font-weight: 500;
        }

        .voice-icon {
            font-size: 16px;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
        }

        .voice-playing .voice-icon i {
            animation: wifi-pulse 1s infinite;
        }

        @keyframes wifi-pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.3;
            }
        }

        .voice-text {
            font-size: 13px;
            color: inherit;
            margin-top: 0;
            padding: 0 12px;
            border-radius: 8px;
            width: fit-content;
            max-width: 100%;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .voice-text.expanded {
            margin-top: 6px;
            padding: 10px 12px;
            max-height: 500px;
            /* Increased limit */
            opacity: 1;
            /* Fully opaque for readability */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* å¯¹æ–¹çš„è¯­éŸ³æ–‡å­—ï¼šç™½åº•é»‘å­— */
        .msg-row.other .voice-text {
            background: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }

        /* è‡ªå·±çš„è¯­éŸ³æ–‡å­—ï¼šæ·±åº•ç™½å­— */
        .msg-row.self .voice-text {
            background: rgba(43, 43, 43, 0.95);
            color: #f3f4f6;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Spinner Fixed */
        .spinner-container {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner-rotate {
            animation: spin 1s linear infinite;
            transform-origin: center;
            font-size: 16px;
            width: 16px;
            height: 16px;
            line-height: 16px;
            text-align: center;
            display: block;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Toggle & Modal */
        .toggle-switch {
            appearance: none;
            width: 40px;
            height: 20px;
            background: #444;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch:checked {
            background: var(--wechat-green);
        }

        .toggle-switch:checked::after {
            transform: translateX(20px);
        }

        /* ç»Ÿä¸€çš„æ¨¡æ€å¼¹çª—èƒŒæ™¯æ ·å¼ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(8px) !important;
            z-index: 9999 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            /* æ·¡è“è‰²ï¼ˆå¤©è“è‰²ï¼‰ç£¨ç ‚ç»ç’ƒèƒŒæ™¯ */
            background: rgba(219, 240, 253, 0.85) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            color: #334155 !important;
            width: 85% !important;
            max-width: 320px !important;
            border-radius: 16px !important;
            padding: 16px !important;
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 4px 20px rgba(147, 197, 253, 0.3) !important;
            font-size: 14px !important;
        }

        /* é’ˆå¯¹ç™½è‰²èƒŒæ™¯æ¨¡æ€æ¡†çš„æ ·å¼ */
        .modal-box.bg-white {
            background: rgba(255, 255, 255, 0.8) !important;
            border-radius: 16px !important;
        }

        /* Open Red Packet Modal */
        .redpacket-modal {
            background: #d95940;
            color: #fce5cd;
            text-align: center;
            border: none;
            position: relative;
            overflow: visible;
            height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 300px;
            border-radius: 16px;
        }

        .rp-top-curve {
            position: absolute;
            top: -50px;
            left: -10%;
            width: 120%;
            height: 100px;
            background: #d95940;
            border-radius: 50%;
            z-index: 0;
            border: 2px solid rgba(0, 0, 0, 0.05);
        }

        .rp-user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #fce5cd;
            margin-top: 40px;
            z-index: 1;
            overflow: hidden;
            background: #333;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
        }

        .rp-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .rp-msg {
            font-size: 16px;
            margin-top: 10px;
            z-index: 1;
            font-weight: bold;
            padding: 0 20px;
        }

        .rp-open-btn {
            width: 90px;
            height: 90px;
            background: #fce5cd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-size: 36px;
            font-weight: bold;
            margin-top: 50px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1;
            transition: transform 0.5s;
        }

        .rp-open-btn.spinning {
            animation: flip-vertical-bck 0.6s infinite;
        }

        @keyframes flip-vertical-bck {
            0% {
                transform: translateZ(0) rotateY(0);
            }

            100% {
                transform: translateZ(-260px) rotateY(-360deg);
            }
        }

        .rp-result {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding-top: 40px;
            background: white;
            border-radius: 16px;
            color: black;
            z-index: 10;
        }

        .rp-result.active {
            display: flex;
        }

        .rp-amount {
            font-size: 48px;
            font-weight: bold;
            color: #d95940;
            margin-top: 20px;
        }

        .rp-amount span {
            font-size: 16px;
            font-weight: normal;
            color: #888;
        }

        /* Payment Action Modal (Unified) */
        #modal-payment-action .modal-box {
            background: #f2f2f2;
            color: black;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .payment-success-icon {
            font-size: 60px;
            color: var(--wechat-green);
            margin-bottom: 20px;
        }

        .payment-amount {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .payment-desc {
            color: #888;
            font-size: 14px;
            margin-bottom: 40px;
        }

        .payment-btn {
            background: var(--wechat-green);
            color: white;
            border-radius: 6px;
            padding: 12px 0;
            width: 80%;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .payment-reject-link {
            color: #576b95;
            font-size: 13px;
            cursor: pointer;
            margin-top: auto;
        }

        /* Worldbook App Styles */
        .wb-list-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
            color: #166534;
        }

        .wb-list-item:active {
            background: rgba(56, 189, 248, 0.15);
            transform: scale(0.98);
        }

        .wb-entry {
            border-left: 3px solid var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            color: #166534;
        }

        /* Collapsible Worldbook in Character Settings */
        .wb-collapsible {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .wb-collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            color: #166534;
        }

        .wb-collapsible-header:hover {
            background: rgba(56, 189, 248, 0.1);
        }

        .wb-collapsible-header:active {
            background: rgba(56, 189, 248, 0.2);
        }

        .wb-collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .wb-collapsible-content.expanded {
            max-height: 500px;
            transition: max-height 0.3s ease-in;
        }

        .wb-collapsible-icon {
            transition: transform 0.3s;
        }

        .wb-collapsible-icon.expanded {
            transform: rotate(90deg);
        }

        /* Context Menu */
        #context-menu {
            position: fixed;
            background: #2b2b2b;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            z-index: 9999;
            width: 140px;
            display: none;
            padding: 5px 0;
            border: 1px solid #333;
        }

        .ctx-item {
            padding: 10px 15px;
            font-size: 14px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ctx-item i {
            width: 16px;
            text-align: center;
            font-size: 12px;
            opacity: 0.7;
        }

        .ctx-item:active {
            background: #444;
        }

        .ctx-divider {
            height: 1px;
            background: #333;
            margin: 4px 0;
        }

        /* Contact Context Menu */
        #contact-context-menu {
            position: fixed;
            background: #2b2b2b;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            z-index: 9999;
            width: 140px;
            border: 1px solid #333;
            display: none;
        }

        /* --- Redundant CSS Removed --- */
        /* --- Consolidated Section END --- */

        /* Toast */
        #toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(147, 197, 253, 0.9) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            color: #2c3e50 !important;
            padding: 14px 28px;
            border-radius: 30px !important;
            font-size: 16px !important;
            font-weight: 700 !important;
            z-index: 999999 !important;
            opacity: 0;
            pointer-events: none !important;
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 8px 30px rgba(31, 38, 135, 0.3) !important;
            display: none;
            align-items: center !important;
            gap: 10px !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
        }

        /* Global Notification Modal */
        #global-notification-modal {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(147, 197, 253, 0.9) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            color: #2c3e50 !important;
            border-radius: 16px !important;
            padding: 15px !important;
            z-index: 99999 !important;
            display: none;
            box-shadow: 0 10px 30px rgba(31, 38, 135, 0.3) !important;
            animation: slideDownNotify 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        @keyframes slideDownNotify {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .notify-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notify-avatar {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: #333;
        }

        .notify-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .notify-text {
            flex: 1;
            min-width: 0;
        }

        .notify-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .notify-msg {
            font-size: 12px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Emoji Panel */
        #emoji-panel,
        #moments-emoji-panel {
            background: #222;
            border-top: 1px solid #333;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 8px;
            margin-top: 8px;
            border-radius: 8px;
            max-height: 200px;
            width: calc(100% - 16px);
            max-width: 100%;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
        }

        .emoji-btn {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #333;
            cursor: pointer;
        }

        .emoji-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Load More Button */
        .msg-load-more {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
        }

        .load-more-btn {
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .load-more-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        /* Multi-select Bar */
        #multiselect-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            display: none;
            align-items: center;
            justify-content: space-around;
            background: #1f1f1f;
            border-top: 1px solid #333;
            z-index: 100;
        }

        .multiselect-mode #multiselect-bar {
            display: flex;
        }

        /* Settings Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .emoji-item {
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .emoji-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border: none;
        }

        #emoji-category-select {
            position: fixed !important;
            transform: translateY(-100%);
            z-index: 99999;
            width: auto;
            min-width: 150px;
            pointer-events: auto;
        }

        /* ä¸ºselectå…ƒç´ çš„çˆ¶å®¹å™¨æ·»åŠ ç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æ­£ç¡®è®¡ç®—fixedå®šä½ */
        .flex.gap-2.mb-2 {
            position: relative;
            z-index: 99999;
        }

        /* ç¡®ä¿ä¸‹æ‹‰èœå•èƒ½å¤Ÿæ˜¾ç¤ºåœ¨æ‰€æœ‰å…ƒç´ ä¹‹ä¸Š */
        #emoji-category-select option {
            z-index: 999999;
            background: white;
            color: black;
        }

        .emoji-grid {
            position: relative;
            z-index: 1;
        }

        /* è‡ªå®šä¹‰è¡¨æƒ…åŒ…åˆ†ç±»ä¸‹æ‹‰èœå•æ ·å¼ */
        #custom-emoji-select {
            cursor: pointer;
        }

        /* ç¡®ä¿è¡¨æƒ…åŒ…åˆ†ç±»selectæ­£å¸¸æ˜¾ç¤º */
        #emoji-category-select {
            position: relative !important;
            transform: none !important;
            z-index: 10;
            display: block !important;
        }

        #custom-emoji-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 99999;
            max-height: 200px;
            overflow-y: auto;
        }

        #custom-emoji-menu div {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        #custom-emoji-menu div:hover {
            background-color: #f3f4f6;
        }

        .emoji-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            cursor: pointer;
            text-align: center;
            font-size: 12px;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .animate-heartbeat {
            animation: heartbeat 1.5s infinite;
        }

        /* æœ‹å‹åœˆèœå•æ ·å¼ */
        .moment-card {
            position: relative;
        }

        .moment-menu-container {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
        }

        .moment-menu-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }

        .moment-menu-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .moment-menu-btn:active {
            transform: scale(0.95);
        }

        .moment-menu-dropdown {
            position: absolute;
            top: 32px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            min-width: 120px;
            z-index: 100;
        }

        .moment-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #333;
        }

        .moment-menu-item:hover {
            background: #f5f5f5;
        }

        .moment-menu-item:active {
            background: #e8e8e8;
        }

        .moment-menu-item i {
            width: 16px;
            text-align: center;
            color: #666;
        }

        .moment-menu-item-danger {
            color: #ef4444;
        }

        .moment-menu-item-danger i {
            color: #ef4444;
        }

        .moment-menu-item-danger:hover {
            background: #fef2f2;
        }


        @keyframes pulse-slow {

            0%,
            100% {
                box-shadow: 0 4px 20px rgba(236, 72, 153, 0.2);
            }

            50% {
                box-shadow: 0 8px 30px rgba(236, 72, 153, 0.35);
            }
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s infinite;
        }

        /* ç»ç’ƒé¢æ¿æ ·å¼ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05) !important;
        }

        /* ç»ç’ƒå›¾æ ‡æ ·å¼ */
        .glass-icon {
            background: rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
        }

        .weather-icon {
            font-size: 36px;
            margin-bottom: 5px;
        }

        /* Recall Viewer */
        #modal-recall-view .modal-box {
            text-align: center;
        }

        /* --- æ­£åœ¨è¾“å…¥åŠ¨ç”» (Typing Indicator) --- */
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            /* ç°è‰²åœ†ç‚¹ */
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes typing-bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- æ‹ä¸€æ‹åŠ¨ç”» --- */
        @keyframes shake-avatar {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(15deg);
            }

            50% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(5deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .avatar-shake {
            animation: shake-avatar 0.4s ease-in-out;
        }

        /* --- æœ‹å‹åœˆæ ¸å¿ƒæ ·å¼ --- */
        /* 1. é¡¶éƒ¨å¯¼èˆª (é€æ˜æ‚¬æµ®) */
        .moments-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            z-index: 50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            pointer-events: none;
            /* è®©ç‚¹å‡»ç©¿é€åˆ°èƒŒæ™¯ */
        }

        .moments-nav-btn {
            pointer-events: auto;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            cursor: pointer;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            /* å¢åŠ æ–‡å­—é˜´å½±é˜²æ­¢èƒŒæ™¯å¤ªäº®çœ‹ä¸æ¸… */
        }

        /* 2. å°é¢ä¸ä¸ªäººä¿¡æ¯åŒº */
        .moments-cover-wrap {
            position: relative;
            width: 100%;
            height: 320px;
            background-color: #333;
            margin-top: -50px;
            /* é¡¶ä¸Šå»è¦†ç›–çŠ¶æ€æ  */
            margin-bottom: 40px;
            /* ç•™å‡ºä¸‹æ–¹å¤´åƒæ‚¬æµ®çš„ç©ºé—´ */
        }

        .moments-cover-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .moments-user-row {
            position: absolute;
            bottom: -20px;
            right: 20px;
            display: flex;
            align-items: flex-end;
            gap: 15px;
            z-index: 10;
        }

        .moments-name {
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 15px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            text-align: right;
        }

        .moments-bio {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            text-align: right;
            margin-right: 10px;
            margin-bottom: 5px;
            font-weight: 300;
            max-width: 200px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
        }

        .moments-avatar-container {
            width: 76px;
            height: 76px;
            border-radius: 12px;
            background: white;
            padding: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            overflow: hidden;
        }

        .moments-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
        }

        /* 3. åŠ¨æ€åˆ—è¡¨ */
        #moments-list-container {
            background: white;
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .moments-item {
            display: flex;
            gap: 12px;
            padding: 15px 20px;
            border-bottom: 1px solid #f2f2f2;
        }

        .moments-left {
            width: 42px;
            height: 42px;
            flex-shrink: 0;
        }

        .moments-right {
            flex: 1;
            min-width: 0;
        }

        /* å­—ä½“æ ·å¼ */
        .moments-author-name {
            color: #576b95;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .moments-text {
            font-size: 15px;
            color: #222;
            line-height: 1.6;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }

        /* 4. å›¾ç‰‡ä¹å®«æ ¼ (æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶å®½é«˜) */
        .moments-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }

        .moments-img {
            object-fit: cover;
            cursor: zoom-in;
            background: #f0f0f0;
            display: block;
            /* é˜²æ­¢å†…è”é—´éš™ */
        }

        /* å•å›¾ï¼šæœ€å¤§å®½åº¦é™åˆ¶ */
        .moments-grid.cols-1 .moments-img {
            max-width: 70%;
            max-height: 200px;
            width: auto;
            height: auto;
            border-radius: 4px;
        }

        /* å¤šå›¾ï¼šæ­£æ–¹å½¢è£å‰ª */
        .moments-grid.cols-2 .moments-img,
        .moments-grid.cols-3 .moments-img {
            width: 90px;
            height: 90px;
            /* å¼ºåˆ¶æ­£æ–¹å½¢ */
        }

        /* 5. åº•éƒ¨æ“ä½œæ  */
        .moments-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }

        .moments-time {
            font-size: 12px;
            color: #a0a0a0;
        }

        .moments-actions-btn {
            background: #f7f7f7;
            padding: 0 8px;
            height: 20px;
            border-radius: 4px;
            color: #576b95;
            font-size: 14px;
            cursor: pointer;
        }

        /* 6. è¯„è®ºåŒº */
        .moments-comments-area {
            background: #f7f7f7;
            border-radius: 4px;
            padding: 6px 10px;
            margin-top: 10px;
            font-size: 14px;
            position: relative;
        }

        .moments-comments-area::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 12px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid #f7f7f7;
        }

        .comment-row {
            margin-bottom: 2px;
            line-height: 1.4;
        }

        .comment-name {
            color: #576b95;
            font-weight: 500;
            cursor: pointer;
        }

        .comment-content {
            color: #222;
        }

        /* 7. è®¾ç½®å¼¹çª— (è¿˜åŸåˆ—è¡¨é£æ ¼) */
        .settings-list-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .settings-list-label {
            font-weight: bold;
            color: #3b82f6;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        /* 8. èœå•æ ·å¼ */
        .moments-menu-pop {
            position: absolute;
            right: 10px;
            top: 25px;
            background: #333;
            color: white;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .moments-menu-item {
            padding: 8px 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            cursor: pointer;
        }

        .moments-menu-item:active {
            background: #444;
        }

        .moments-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 5px 0;
        }

        /* æ–°å¢æ ·å¼ï¼šåŠ¨æ€å¤´éƒ¨å’Œç¼–å· */
        .moments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .dynamic-id {
            font-size: 12px;
            color: #a0a0a0;
        }

        /* æ–°å¢æ ·å¼ï¼šäº’åŠ¨æ  */
        .moments-interaction-bar {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            margin-top: 8px;
        }

        .interaction-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 6px 12px;
            background-color: #f7f7f7;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            color: #576b95;
        }

        .interaction-btn:hover {
            background-color: #e9e9e9;
        }

        /* æ–°å¢æ ·å¼ï¼šè¯„è®ºç¼–å· */
        .comment-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
        }

        .comment-id {
            font-size: 10px;
            color: #a0a0a0;
            margin-left: auto;
        }

        /* --- Timestamps --- */
        .msg-time-outside {
            font-size: 10px;
            color: rgba(160, 160, 160, 0.8);
            margin-top: 4px;
            padding: 0 4px;
            font-family: inherit;
        }

        .self .msg-time-outside {
            text-align: right;
        }

        /* --- Bubble HTML --- */
        .bubble-html {
            max-width: 100%;
            overflow-x: auto;
            word-break: break-word;
        }

        .bubble-html img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
        }

        /* --- Typing Indicator Improved --- */
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            opacity: 0.6;
            animation: typing-bounce 1s infinite ease-in-out;
        }

        @keyframes typing-bounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-4px);
            }
        }
    </style>

    <style id="user-custom-css"></style>
</head>

<body class="h-screen w-screen flex flex-col relative text-shadow-sm"
    onclick="WeChatUI.hideContextMenu(); WeChatUI.hideEmojiPicker()">

    <!-- Wallpaper -->
    <div id="wallpaper-layer"></div>

    <!-- Status Bar -->
    <div id="status-bar"
        class="w-full h-8 flex justify-between items-center px-6 text-xs font-bold tracking-wide pt-2 z-[999] fixed top-0 left-0 text-white drop-shadow-md pointer-events-none">
        <div id="clock-small">00:00</div>
        <div class="flex items-center gap-3"><i class="fa-solid fa-signal"></i><i class="fa-solid fa-wifi"></i>
            <div class="flex items-center gap-1"><span id="battery-level">--%</span><i id="battery-icon"
                    class="fa-solid fa-battery-three-quarters"></i></div>
        </div>
    </div>

    <!-- Global Notification -->
    <div id="global-notification-modal" onclick="WeChatUI.handleNotificationClick()">
        <div class="notify-content">
            <div class="notify-avatar"><img id="notify-avatar-img" src=""></div>
            <div class="notify-text">
                <div class="notify-name" id="notify-title">Title</div>
                <div class="notify-msg" id="notify-body">Message content...</div>
            </div>
            <div class="text-xs text-gray-400">ç°åœ¨</div>
        </div>
    </div>

    <!-- Generic Prompt Modal -->
    <div id="modal-prompt" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="prompt-title" class="font-bold mb-4">è¾“å…¥</h3>
            <input type="text" id="prompt-input" class="setting-input mb-4" placeholder="è¯·è¾“å…¥å†…å®¹">
            <div class="flex gap-2">
                <button onclick="Utils.cancelPrompt()" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                <button onclick="Utils.confirmPrompt()" class="setting-btn flex-1">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Generic Confirm Modal -->
    <div id="modal-confirm" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="confirm-title" class="font-bold mb-3">ç¡®è®¤æ“ä½œ</h3>
            <p id="confirm-message" class="mb-4 text-sm leading-relaxed"></p>
            <div class="flex gap-2">
                <button onclick="Utils.cancelConfirm()" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                <button onclick="Utils.confirmConfirm()" class="setting-btn flex-1">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Share Contact Selection Modal -->
    <div id="modal-share-select" class="modal-overlay hidden">
        <div class="modal-box w-full max-w-sm bg-white h-[60vh] flex flex-col">
            <div class="flex justify-between items-center p-3 border-b">
                <h3 class="font-bold text-gray-700">å‘é€ç»™...</h3>
                <button onclick="document.getElementById('modal-share-select').classList.add('hidden')"
                    class="text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="share-contact-list" class="flex-1 overflow-y-auto p-2 space-y-2">
            </div>
        </div>
    </div>

    <!-- Desktop -->
    <main id="desktop" class="flex-1 w-full h-full z-10 pt-8">
        <div class="app-pages-container" id="app-swiper">
            <!-- Page 1 -->
            <div class="app-page">
                <div id="widget-time"
                    class="col-span-4 glass-panel rounded-[24px] p-6 flex flex-col justify-center items-start h-40 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 opacity-10 text-[9rem] text-gray-800"><i
                            class="fa-regular fa-clock"></i></div>
                    <div id="clock-large" class="text-6xl font-thin tracking-tighter text-gray-800 drop-shadow-sm">12:00
                    </div>
                    <div id="date-large" class="text-lg text-blue-600 mt-2 pl-1 font-medium tracking-widest uppercase">
                        2024å¹´1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
                </div>
                <div id="widget-location" onclick="openApp('settings'); SettingsUI.openPage('weather', 'å¤©æ°”è®¾ç½®')"
                    class="col-span-2 glass-panel rounded-[24px] p-5 flex flex-col justify-between h-32 relative overflow-hidden cursor-pointer">
                    <div class="flex justify-between items-start"><i
                            class="fa-solid fa-location-dot text-xl text-blue-600"></i><span
                            class="text-[10px] bg-blue-500/30 px-2 py-1 rounded-full text-blue-50 backdrop-blur-md border border-blue-400/20">æ˜ å°„</span>
                    </div>
                    <div>
                        <div class="text-sm text-blue-600">å½“å‰ä½ç½®</div>
                        <div class="text-xl font-bold truncate text-gray-800" id="desktop-location-text">è™šæ‹ŸåŸå¸‚</div>
                    </div>
                </div>
                <div id="widget-weather"
                    class="col-span-2 glass-panel rounded-[24px] p-5 flex flex-col justify-between h-32 relative overflow-hidden">
                    <div class="absolute -right-4 -bottom-4 text-7xl opacity-20 text-yellow-500"
                        id="desktop-weather-bg-icon"><i class="fa-solid fa-sun"></i></div>
                    <div class="text-right text-4xl font-light text-gray-800 flex flex-col items-end"><i
                            class="fa-solid fa-sun weather-icon text-yellow-500" id="desktop-weather-icon"></i><span
                            id="desktop-temp">24Â°</span></div>
                    <div>
                        <div class="text-sm text-blue-600" id="desktop-weather-desc">æ™´æœ—</div>
                        <div class="text-xs text-blue-400">AQI 35</div>
                    </div>
                </div>
                <!-- Apps -->
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    onclick="openApp('wechat')">
                    <div id="icon-wechat"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <i class="fa-brands fa-weixin text-[34px] text-[#10b981]"></i>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">å¾®ä¿¡</span>
                </div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    onclick="openApp('search')">
                    <div id="icon-search"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">æŸ¥æ‰‹æœº</span>
                </div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    onclick="openApp('weibo')">
                    <div id="icon-weibo"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <i class="fa-brands fa-weibo text-4xl text-[#E6162D]"></i>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">å¾®åš</span>
                </div>
            </div>
            <!-- Page 2 -->
            <div class="app-page" style="overflow-y: hidden; padding-top: 1rem; align-content: flex-start;">
                <!-- Reduced top spacing -->
                <div class="col-span-4 h-1"></div>


                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    onclick="openApp('couple')">
                    <div id="icon-couple"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="#ec4899">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                        </svg>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">æƒ…ä¾£ç©ºé—´</span>
                </div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    onclick="openApp('games')">
                    <div id="icon-games"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="#8b5cf6">
                            <path
                                d="M21 9h-2V7c0-1.66-1.34-3-3-3s-3 1.34-3 3v2H9V7c0-1.66-1.34-3-3-3S3 5.34 3 7v2H1c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h22c.55 0 1-.45 1-1V10c0-.55-.45-1-1-1zM11 15H9v2c0 .55-.45 1-1 1s-1-.45-1-1v-2H5c-.55 0-1-.45-1-1s.45-1 1-1h2v-2c0-.55.45-1 1-1s1 .45 1 1v2h2c.55 0 1 .45 1 1s-.45 1-1 1zm8-1c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                        </svg>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">å°æ¸¸æˆ</span>
                </div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group"
                    style="display:none;" onclick="resetApp()">
                    <div id="icon-reset"
                        class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 2v6h-6M3 22v-6h6"></path>
                            <path d="M3 10h18a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8 8 8 0 0 1 8 8Z"></path>
                        </svg>
                    </div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">é‡ç½®</span>
                </div>

                <div class="col-span-2 glass-panel rounded-[24px] overflow-hidden relative aspect-[1.33]">
                    <div id="widget-overlay-card1"
                        class="absolute inset-0 flex flex-col items-center justify-center opacity-50 pointer-events-none transition-opacity duration-300">
                        <i class="fa-regular fa-image text-3xl mb-2"></i><span class="text-xs">ç»„ä»¶ 1</span>
                    </div>
                    <div id="widget-img-card1" class="absolute inset-0 w-full h-full pointer-events-none">
                    </div>
                </div>
                <div class="col-span-2 glass-panel rounded-[24px] overflow-hidden relative aspect-[1.33]">
                    <div id="widget-overlay-card2"
                        class="absolute inset-0 flex flex-col items-center justify-center opacity-50 pointer-events-none transition-opacity duration-300">
                        <i class="fa-regular fa-star text-3xl mb-2"></i><span class="text-xs">ç»„ä»¶ 2</span>
                    </div>
                    <div id="widget-img-card2" class="absolute inset-0 w-full h-full pointer-events-none">
                    </div>
                </div>
            </div>
        </div>

        <!-- Dock (Fixed Footer) -->
        <div class="dock-container" style="padding-bottom: 20px;">
            <div class="flex flex-col items-center gap-1 cursor-pointer group" onclick="openApp('settings')">
                <div id="icon-settings"
                    class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </div>
                <span class="text-[10px] text-white font-medium drop-shadow-md">è®¾ç½®</span>
            </div>

            <div class="flex flex-col items-center gap-1 cursor-pointer group" onclick="openApp('worldbook')">
                <div id="icon-worldbook"
                    class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                </div>
                <span class="text-[10px] text-white font-medium drop-shadow-md">ä¸–ç•Œä¹¦</span>
            </div>

            <div class="flex flex-col items-center gap-1 cursor-pointer group"
                onclick="if(confirm('åˆ·æ–°é¡µé¢é‡ç½®æ‰€æœ‰çŠ¶æ€ (Fix Lag)?')) location.reload()">
                <div id="icon-reset"
                    class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#ff4d4f" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </div>
                <span class="text-[10px] text-white font-medium drop-shadow-md">é‡ç½®</span>
            </div>

            <div class="flex flex-col items-center gap-1 cursor-pointer group"
                onclick="document.getElementById('app-syslogs').classList.add('active'); SystemLoggerUI.open();">
                <div id="icon-syslog"
                    class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                </div>
                <span class="text-[10px] text-white font-medium drop-shadow-md">ç³»ç»Ÿæ—¥å¿—</span>
            </div>
        </div>
        <div class="fixed bottom-28 left-0 w-full flex justify-center gap-2 pointer-events-none">
            <div id="dot-1" class="w-1.5 h-1.5 rounded-full bg-white shadow-lg transition-all"></div>
            <div id="dot-2" class="w-1.5 h-1.5 rounded-full bg-white/20 transition-all"></div>
        </div>
    </main>

    <!-- Worldbook App -->
    <div id="app-worldbook" class="app-window text-gray-800">
        <div class="app-header bg-white/95 backdrop-blur-xl border-b border-gray-200 justify-between">
            <button onclick="closeApp()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600"><i
                    class="fa-solid fa-chevron-left"></i></button>
            <div class="font-bold text-lg tracking-wide text-green-600">ä¸–ç•Œä¹¦ç®¡ç†</div>
            <div class="flex gap-2">
                <button onclick="WorldbookUI.showCategoryManager()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-100 text-purple-600"
                    title="ç®¡ç†åˆ†ç±»"><i class="fa-solid fa-tags"></i></button>
                <button onclick="WorldbookUI.showGroupManager()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600"
                    title="ç®¡ç†åˆ†ç»„"><i class="fa-solid fa-layer-group"></i></button>
                <button onclick="WorldbookUI.createNewBook()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600"><i
                        class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div class="app-content p-4">
            <!-- Filter Bar -->
            <div class="flex gap-2 mb-4">
                <select id="wb-category-filter" class="setting-input mb-0 flex-1 text-sm"
                    onchange="WorldbookUI.renderList()">
                    <option value="">æ‰€æœ‰åˆ†ç±»</option>
                </select>
                <select id="wb-group-filter" class="setting-input mb-0 flex-1 text-sm"
                    onchange="WorldbookUI.renderList()">
                    <option value="">æ‰€æœ‰åˆ†ç»„</option>
                </select>
            </div>
            <!-- Book List -->
            <div id="wb-list-container">
                <!-- Book List -->
            </div>
        </div>

        <!-- Edit View (Overlay) -->
        <div id="wb-edit-view" class="fixed inset-0 bg-white z-50 hidden flex-col">
            <div class="app-header bg-white/95 border-b border-gray-200 gap-2">
                <button onclick="WorldbookUI.closeEdit()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 shrink-0"><i
                        class="fa-solid fa-chevron-left"></i></button>

                <input type="text" id="wb-edit-name"
                    class="flex-1 min-w-0 bg-transparent font-bold text-lg text-center outline-none text-gray-800"
                    placeholder="ä¸–ç•Œä¹¦åç§°">

                <button onclick="WorldbookUI.saveBook()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 shrink-0"><i
                        class="fa-solid fa-save"></i></button>

                <button onclick="WorldbookUI.addEntry()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600 shrink-0"><i
                        class="fa-solid fa-plus"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">åˆ†ç±»</label>
                        <select id="wb-edit-category" class="setting-input mb-0 text-sm">
                            <option value="">æ— åˆ†ç±»</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">åˆ†ç»„</label>
                        <select id="wb-edit-group" class="setting-input mb-0 text-sm">
                            <option value="">æ— åˆ†ç»„</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-4" id="wb-entry-list">
                    <!-- Entries -->
                </div>
            </div>
        </div>

        <!-- Category Manager Modal -->
        <div id="wb-category-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ç®¡ç†åˆ†ç±»</h3>
                    <button onclick="WorldbookUI.hideCategoryManager()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-800 text-white/80"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="wb-new-category-name" class="setting-input mb-0 flex-1" placeholder="æ–°åˆ†ç±»åç§°">
                    <button onclick="WorldbookUI.addCategory()"
                        class="setting-btn secondary w-auto whitespace-nowrap">æ·»åŠ </button>
                </div>
                <div id="wb-category-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Category List -->
                </div>
            </div>
        </div>

        <!-- Group Manager Modal -->
        <div id="wb-group-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ç®¡ç†åˆ†ç»„</h3>
                    <button onclick="WorldbookUI.hideGroupManager()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-800 text-white/80"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="wb-new-group-name" class="setting-input mb-0 flex-1" placeholder="æ–°åˆ†ç»„åç§°">
                    <button onclick="WorldbookUI.addGroup()"
                        class="setting-btn secondary w-auto whitespace-nowrap">æ·»åŠ </button>
                </div>
                <div id="wb-group-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Group List -->
                </div>
            </div>
        </div>
    </div>

    <!-- System Log App -->
    <div id="app-syslog" class="app-window bg-[#1e1e1e] text-green-400 font-mono">
        <div class="app-header bg-[#2d2d2d] border-b border-gray-700 justify-between">
            <button onclick="closeApp()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 text-gray-400"><i
                    class="fa-solid fa-chevron-left"></i></button>
            <div class="font-bold text-sm tracking-wide text-gray-300">ç³»ç»Ÿè¿è¡Œæ—¥å¿—</div>
            <div class="flex gap-2">
                <button onclick="SystemLog.clear()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 text-gray-400"
                    title="æ¸…ç©º"><i class="fa-solid fa-trash"></i></button>
                <button onclick="SystemLog.refresh()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 text-gray-400"
                    title="åˆ·æ–°"><i class="fa-solid fa-rotate"></i></button>
            </div>
        </div>

        <div class="px-4 py-2 bg-[#252525] border-b border-gray-700 flex gap-2 overflow-x-auto">
            <button onclick="SystemLog.filter('all')"
                class="px-3 py-1 rounded bg-gray-700 text-xs text-white">å…¨éƒ¨</button>
            <button onclick="SystemLog.filter('AI')"
                class="px-3 py-1 rounded bg-blue-900/50 text-blue-300 text-xs">AIäº¤äº’</button>
            <button onclick="SystemLog.filter('SYS')"
                class="px-3 py-1 rounded bg-green-900/50 text-green-300 text-xs">ç³»ç»Ÿ</button>
            <button onclick="SystemLog.filter('ERR')"
                class="px-3 py-1 rounded bg-red-900/50 text-red-300 text-xs">é”™è¯¯</button>
        </div>
        <div id="syslog-container" class="flex-1 overflow-y-auto p-2 space-y-2 text-xs break-all">
        </div>
    </div>

    <!-- SETTINGS APP (Full) -->
    <div id="app-settings" class="app-window text-gray-800">
        <div class="app-header sticky top-0 z-50 bg-white/95 backdrop-blur-xl"><button onclick="SettingsUI.handleBack()"
                class="w-10 h-10 flex items-center justify-center rounded-full active:bg-gray-100 text-gray-600"><i
                    class="fa-solid fa-chevron-left text-lg"></i></button><span id="settings-title"
                class="ml-2 font-bold text-lg tracking-wider text-gray-800">è®¾ç½®ä¸­å¿ƒ</span></div>
        <div class="app-content" id="settings-main-menu">
            <div class="space-y-4">
                <div onclick="SettingsUI.openPage('api', 'API è¿æ¥')"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center shadow-lg text-xl text-blue-600">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">API è¿æ¥</div>
                            <div class="text-xs text-blue-400/80 mt-1">OpenAI, æ¨¡å‹ç®¡ç†</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
                <div onclick="SettingsUI.openPage('theme', 'ä¸ªæ€§åŒ–')"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-100 to-pink-200 flex items-center justify-center shadow-lg text-xl text-pink-600">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">ä¸ªæ€§åŒ–</div>
                            <div class="text-xs text-pink-400/80 mt-1">å£çº¸, å›¾æ ‡, æ¡Œé¢ç»„ä»¶</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
                <div onclick="SettingsUI.openPage('tts', 'è¯­éŸ³æœåŠ¡')"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center shadow-lg text-xl text-green-600">
                            <i class="fa-solid fa-microphone-lines"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">è¯­éŸ³æœåŠ¡</div>
                            <div class="text-xs text-green-400/80 mt-1">TTS, MiniMax</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
                <div onclick="SettingsUI.openPage('weather', 'å¤©æ°”è®¾ç½®')"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center shadow-lg text-xl text-yellow-600">
                            <i class="fa-solid fa-cloud-sun"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">å¤©æ°”ä¸åœ°ç‚¹</div>
                            <div class="text-xs text-yellow-400/80 mt-1">ä½ç½®æ˜ å°„, è™šæ‹ŸåŸå¸‚</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
                <div onclick="SettingsUI.openPage('storage', 'å­˜å‚¨ç©ºé—´'); SettingsLogic.renderStorageView()"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-100 to-orange-200 flex items-center justify-center shadow-lg text-xl text-orange-600">
                            <i class="fa-solid fa-hard-drive"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">å­˜å‚¨ç©ºé—´</div>
                            <div class="text-xs text-orange-400/80 mt-1">ç¼“å­˜æ¸…ç†, ç©ºé—´é‡Šæ”¾</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
                <div onclick="SettingsUI.openPage('data', 'æ•°æ®ç®¡ç†')"
                    class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer">
                    <div class="flex items-center gap-5">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center shadow-lg text-xl text-purple-600">
                            <i class="fa-solid fa-database"></i>
                        </div>
                        <div>
                            <div class="font-bold text-lg">æ•°æ®ç®¡ç†</div>
                            <div class="text-xs text-purple-400/80 mt-1">å¯¼å‡ºã€å¯¼å…¥ã€é‡ç½®æ•°æ®</div>
                        </div>
                    </div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
                </div>
            </div>
        </div>

        <!-- API Page -->
        <div class="app-content hidden" id="settings-page-api">
            <h3 class="section-title">é…ç½®æ–‡ä»¶</h3>
            <div class="glass-panel p-1 rounded-2xl mb-6"><select id="api-config-select"
                    class="w-full bg-transparent border-none text-green-600 p-3 outline-none text-sm"
                    onchange="window.SettingsLogic.loadAPIConfig(this.value, 'primary')">
                    <option value="default">é»˜è®¤é…ç½®</option>
                </select></div>


            <!-- ä¸» API æ¥å£è¯¦æƒ… (èŠå¤©ä¸“ç”¨) -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="section-title">ä¸» API æ¥å£è¯¦æƒ…</h3>
                    <span class="text-xs text-green-500">èŠå¤©ä¸“ç”¨</span>
                </div>
                <div class="space-y-3" id="primary-api-details">
                    <input type="text" id="primary-api-name" placeholder="é…ç½®åç§° (å¦‚: GPT-4)" class="setting-input">
                    <input type="text" id="primary-api-url" placeholder="æ¥å£åœ°å€ (https://api.openai.com/v1)"
                        class="setting-input">
                    <input type="password" id="primary-api-key" placeholder="API Key (sk-...)" class="setting-input">
                    <div class="flex gap-2">
                        <input type="text" id="primary-api-model" placeholder="æ¨¡å‹ID (è‡ªåŠ¨æ‹‰å–æˆ–æ‰‹å¡«)"
                            class="setting-input flex-1 mb-0 font-mono text-xs">
                        <button onclick="window.SettingsLogic.fetchModels('primary')"
                            class="setting-btn secondary w-auto whitespace-nowrap"><i
                                class="fa-solid fa-cloud-arrow-down mr-1"></i> æ‹‰å–</button>
                    </div>
                    <select id="primary-api-model-select"
                        class="setting-input hidden transition-all border-blue-400/50 bg-blue-900/40 text-blue-100"
                        onchange="document.getElementById('primary-api-model').value = this.value">
                        <option value="" disabled selected>â–¼ é€‰æ‹©æ¨¡å‹</option>
                    </select>
                    <div class="flex justify-between items-center mt-4">
                        <h3 class="section-title">æ€ç»´æ´»è·ƒåº¦ (Temp)</h3>
                        <span id="primary-temp-display" class="text-blue-600">0.7</span>
                    </div>
                    <div class="glass-panel p-4 rounded-2xl mb-3">
                        <input type="range" id="primary-api-temp" min="0" max="2" step="0.1" value="0.7"
                            class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-500"
                            oninput="document.getElementById('primary-temp-display').textContent=this.value">
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <h3 class="section-title">æœ€å¤§è¾“å‡º token</h3>
                        <span id="primary-max-tokens-display" class="text-blue-600">4096</span>
                    </div>
                    <div class="glass-panel p-4 rounded-2xl mb-6">
                        <input type="range" id="primary-api-max-tokens" min="256" max="3000000" step="1000" value="4096"
                            class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-500"
                            oninput="document.getElementById('primary-max-tokens-display').textContent=this.value">
                    </div>
                </div>
            </div>



            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="window.SettingsLogic.saveAPI()"
                    class="setting-btn col-span-2 shadow-lg shadow-blue-500/20">ä¿å­˜é…ç½®</button>
                <button onclick="window.SettingsLogic.createNewAPI()" class="setting-btn secondary">æ–°å»ºé…ç½®</button>
                <button onclick="window.SettingsLogic.deleteAPI()" class="setting-btn danger">åˆ é™¤é…ç½®</button>
            </div>
        </div>

        <!-- Theme Page -->
        <div class="app-content hidden" id="settings-page-theme">
            <h3 class="section-title">å£çº¸</h3>
            <div class="glass-panel rounded-xl p-2 mb-3">
                <div id="wallpaper-preview-box"
                    class="w-full h-32 rounded-lg bg-gray-800/50 flex items-center justify-center overflow-hidden relative border border-white/10">
                    <span class="text-xs text-white/30 absolute">é¢„è§ˆ</span>
                </div>
            </div>
            <div class="space-y-2">
                <div class="url-input-group"><input type="text" id="wallpaper-url-input" placeholder="å£çº¸ URL..."
                        class="setting-input"><button class="setting-btn secondary"
                        onclick="ThemeLogic.applyUrl('wallpaper')"><i class="fa-solid fa-check"></i></button></div>
                <div class="grid grid-cols-2 gap-3"><button class="setting-btn secondary text-xs py-3"
                        onclick="document.getElementById('upload-wallpaper').click()"><i class="fa-solid fa-upload"></i>
                        æœ¬åœ°</button><button class="setting-btn secondary text-xs py-3 bg-red-100 text-red-500"
                        onclick="ThemeLogic.resetWallpaper()"><i class="fa-solid fa-trash"></i> æ¸…é™¤å£çº¸</button></div>
            </div><input type="file" id="upload-wallpaper" accept="image/*" class="hidden"
                onchange="ThemeLogic.handleImageUpload('wallpaper', this)">
            <h3 class="section-title">å›¾æ ‡</h3>
            <div class="glass-panel p-3 rounded-2xl mb-2 flex items-center gap-3">
                <div id="icon-preview-box"
                    class="w-14 h-14 rounded-xl bg-gray-700 shadow-inner flex items-center justify-center overflow-hidden shrink-0 border border-white/20">
                </div>
                <div class="flex-1"><select id="icon-selector"
                        class="w-full bg-gray-50 border border-gray-300 rounded-lg text-gray-700 p-2 text-sm outline-none appearance-none"
                        onchange="ThemeLogic.updateIconPreview()"
                        style="background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%23333\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'%3e%3cpolyline points=\'6 9 12 15 18 9\'%3e%3c/polyline%3e%3c/svg%3e'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em;">
                        <option value="icon-wechat">å¾®ä¿¡</option>
                        <option value="icon-worldbook">ä¸–ç•Œä¹¦</option>
                        <option value="icon-search">æŸ¥æ‰‹æœº</option>
                        <option value="icon-weibo">å¾®åš</option>
                        <option value="icon-settings">è®¾ç½®</option>
                        <option value="icon-couple">æƒ…ä¾£ç©ºé—´</option>
                        <option value="icon-games">å°æ¸¸æˆ</option>
                    </select></div>
            </div>
            <div class="space-y-2">
                <div class="url-input-group"><input type="text" id="icon-url-input" placeholder="å›¾æ ‡ URL..."
                        class="setting-input"><button class="setting-btn secondary"
                        onclick="ThemeLogic.applyUrl('icon')"><i class="fa-solid fa-check"></i></button></div>
                <div class="grid grid-cols-2 gap-2">
                    <button class="setting-btn secondary"
                        onclick="document.getElementById('upload-icon').click()">æœ¬åœ°ä¸Šä¼ </button>
                    <button class="setting-btn secondary bg-red-100 text-red-500"
                        onclick="ThemeLogic.clearIcon()">æ¸…é™¤å›¾æ ‡</button>
                </div>
            </div><input type="file" id="upload-icon" accept="image/*" class="hidden"
                onchange="ThemeLogic.handleImageUpload('icon', this)">
            <h3 class="section-title">ç»„ä»¶</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="space-y-2">
                    <div class="text-xs text-center opacity-70">ç»„ä»¶ 1</div>
                    <div id="widget1-preview-box"
                        class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20">
                    </div><input type="text" id="widget1-url-input" placeholder="å›¾ç‰‡ URL..."
                        class="setting-input text-xs">
                    <div class="grid grid-cols-3 gap-1">
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.applyUrl('card1')">åº”ç”¨</button>
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.triggerWidgetUpload('card1')">ä¸Šä¼ </button>
                        <button class="setting-btn secondary text-xs px-1 bg-red-100 text-red-500"
                            onclick="ThemeLogic.clearWidgetUrl('card1')">æ¸…é™¤</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="text-xs text-center opacity-70">ç»„ä»¶ 2</div>
                    <div id="widget2-preview-box"
                        class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20">
                    </div><input type="text" id="widget2-url-input" placeholder="å›¾ç‰‡ URL..."
                        class="setting-input text-xs">
                    <div class="grid grid-cols-3 gap-1">
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.applyUrl('card2')">åº”ç”¨</button>
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.triggerWidgetUpload('card2')">ä¸Šä¼ </button>
                        <button class="setting-btn secondary text-xs px-1 bg-red-100 text-red-500"
                            onclick="ThemeLogic.clearWidgetUrl('card2')">æ¸…é™¤</button>
                    </div>
                </div>
            </div><input type="file" id="upload-widget" accept="image/*" class="hidden"
                onchange="ThemeLogic.handleWidgetUpload(this)">
            <input type="file" id="upload-widget-card" accept="image/*" class="hidden"
                onchange="ThemeLogic.handleWidgetCardUpload(this)">

            <!-- æ–°å¢ï¼šæ¡Œé¢å°ç»„ä»¶èƒŒæ™¯è®¾ç½® -->
            <h3 class="section-title">æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯</h3>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <!-- æ—¶é—´å¡ç‰‡èƒŒæ™¯ -->
                <div class="space-y-2">
                    <div class="text-xs text-center opacity-70">æ—¶é—´å¡ç‰‡</div>
                    <div id="time-card-preview-box"
                        class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20">
                    </div>
                    <input type="text" id="time-card-bg-url" placeholder="å›¾ç‰‡ URL..." class="setting-input text-xs">
                    <div class="grid grid-cols-3 gap-1">
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.applyWidgetCardBg('timeCard')">åº”ç”¨</button>
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.triggerWidgetCardUpload('timeCard')">ä¸Šä¼ </button>
                        <button class="setting-btn secondary text-xs px-1 bg-red-100 text-red-500"
                            onclick="ThemeLogic.clearWidgetCardBg('timeCard')">æ¸…é™¤</button>
                    </div>
                </div>

                <!-- å®šä½å¡ç‰‡èƒŒæ™¯ -->
                <div class="space-y-2">
                    <div class="text-xs text-center opacity-70">å®šä½å¡ç‰‡</div>
                    <div id="location-card-preview-box"
                        class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20">
                    </div>
                    <input type="text" id="location-card-bg-url" placeholder="å›¾ç‰‡ URL..." class="setting-input text-xs">
                    <div class="grid grid-cols-3 gap-1">
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.applyWidgetCardBg('locationCard')">åº”ç”¨</button>
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.triggerWidgetCardUpload('locationCard')">ä¸Šä¼ </button>
                        <button class="setting-btn secondary text-xs px-1 bg-red-100 text-red-500"
                            onclick="ThemeLogic.clearWidgetCardBg('locationCard')">æ¸…é™¤</button>
                    </div>
                </div>

                <!-- å¤©æ°”å¡ç‰‡èƒŒæ™¯ -->
                <div class="space-y-2">
                    <div class="text-xs text-center opacity-70">å¤©æ°”å¡ç‰‡</div>
                    <div id="weather-card-preview-box"
                        class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20">
                    </div>
                    <input type="text" id="weather-card-bg-url" placeholder="å›¾ç‰‡ URL..." class="setting-input text-xs">
                    <div class="grid grid-cols-3 gap-1">
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.applyWidgetCardBg('weatherCard')">åº”ç”¨</button>
                        <button class="setting-btn secondary text-xs px-1"
                            onclick="ThemeLogic.triggerWidgetCardUpload('weatherCard')">ä¸Šä¼ </button>
                        <button class="setting-btn secondary text-xs px-1 bg-red-100 text-red-500"
                            onclick="ThemeLogic.clearWidgetCardBg('weatherCard')">æ¸…é™¤</button>
                    </div>
                </div>
            </div>
            <h3 class="section-title">å…¨å±€å­—ä½“è®¾ç½®</h3>
            <div class="glass-panel p-4 rounded-2xl mb-4">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">å­—ä½“é¢œè‰²</label>
                        <input type="color" id="font-color" value="#166534"
                            class="w-full h-10 rounded-lg cursor-pointer">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">å­—ä½“é˜´å½±</label>
                        <input type="text" id="font-shadow" placeholder="ä¾‹å¦‚: 0 2px 4px rgba(0,0,0,0.3)"
                            class="setting-input">
                    </div>
                    <div class="url-input-group">
                        <input type="text" id="font-url" placeholder="å­—ä½“ URL..." class="setting-input">
                        <button class="setting-btn secondary" onclick="ThemeLogic.applyFontUrl()"><i
                                class="fa-solid fa-check"></i></button>
                    </div>
                    <button class="setting-btn secondary text-xs w-full bg-red-50 text-red-500"
                        onclick="ThemeLogic.restoreDefaultFont()">æ¸…é™¤/é‡ç½®å­—ä½“</button>
                </div>
            </div>

            <h3 class="section-title">å…¨å±€èƒŒæ™¯ç¾åŒ–</h3>
            <div class="glass-panel rounded-xl p-2 mb-3">
                <div id="global-bg-preview-box"
                    class="w-full h-32 rounded-lg bg-gray-800/50 flex items-center justify-center overflow-hidden relative border border-white/10">
                    <span class="text-xs text-white/30 absolute">é¢„è§ˆ</span>
                </div>
            </div>
            <div class="space-y-2">
                <div class="url-input-group">
                    <input type="text" id="global-bg-url-input" placeholder="å…¨å±€èƒŒæ™¯ URL..." class="setting-input">
                    <button class="setting-btn secondary" onclick="ThemeLogic.applyGlobalBgUrl()"><i
                            class="fa-solid fa-check"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button class="setting-btn secondary text-xs py-3"
                        onclick="document.getElementById('upload-global-bg').click()"><i class="fa-solid fa-upload"></i>
                        æœ¬åœ°</button>
                    <button class="setting-btn secondary text-xs py-3 bg-red-100 text-red-500"
                        onclick="ThemeLogic.resetGlobalBg()"><i class="fa-solid fa-trash"></i> æ¸…é™¤èƒŒæ™¯</button>
                </div>
            </div>
            <input type="file" id="upload-global-bg" accept="image/*" class="hidden"
                onchange="ThemeLogic.handleGlobalBgUpload(this)">

            <h3 class="section-title">ç¾åŒ–é¢„è®¾ç®¡ç†</h3>
            <div class="glass-panel p-4 rounded-2xl mb-4">
                <div class="flex gap-2 mb-3">
                    <input type="text" id="preset-name" placeholder="é¢„è®¾åç§°" class="setting-input flex-1">
                    <button class="setting-btn" onclick="ThemeLogic.savePreset()">ä¿å­˜é¢„è®¾</button>
                </div>
                <div class="mb-3">
                    <select id="preset-select" class="setting-input" onchange="ThemeLogic.loadPreset(this.value)">
                        <option value="">é€‰æ‹©é¢„è®¾...</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button class="setting-btn secondary flex-1" onclick="ThemeLogic.deletePreset()">åˆ é™¤é¢„è®¾</button>
                    <button class="setting-btn secondary flex-1" onclick="ThemeLogic.resetAll()">é‡ç½®å…¨å±€ç¾åŒ–</button>
                </div>
            </div>

            <h3 class="section-title">CSS</h3>
            <textarea id="theme-css" placeholder="è‡ªå®šä¹‰ CSS..." class="setting-input h-20 font-mono text-xs"></textarea>
            <div class="flex gap-2 mb-4">
                <button class="setting-btn flex-1" onclick="ThemeLogic.saveTheme()">ä¿å­˜ç¾åŒ–</button>
                <button class="setting-btn secondary flex-1 bg-red-50 text-red-500"
                    onclick="ThemeLogic.restoreDefaultCSS()">æ¸…é™¤/é‡ç½®CSS</button>
            </div>
        </div>

        <!-- TTS Page -->
        <div class="app-content hidden" id="settings-page-tts">
            <h3 class="section-title">è¯­éŸ³å¼•æ“</h3>
            <div class="glass-panel p-4 rounded-2xl mb-6"><select id="tts-engine"
                    class="bg-blue-900/40 border border-blue-500/30 text-white p-2 rounded-lg outline-none text-sm w-full"
                    onchange="SettingsLogic.toggleTTSSettings()">
                    <option value="browser">æœ¬åœ° Browser TTS</option>
                    <option value="minimax">MiniMax äº‘ç«¯è¯­éŸ³</option>
                </select><button onclick="SettingsLogic.testTTS()"
                    class="setting-btn secondary text-xs w-full mt-4">æµ‹è¯•å‘éŸ³</button></div>
            <div id="minimax-settings" class="space-y-3 hidden">
                <h3 class="section-title">MiniMax å‚æ•°</h3><input type="text" id="minimax-group-id" placeholder="Group ID"
                    class="setting-input"><input type="password" id="minimax-api-key" placeholder="API Key"
                    class="setting-input">
                <h3 class="section-title">æ¨¡å‹ä¸éŸ³è‰²</h3>
                <div class="flex gap-2"><input type="text" id="minimax-model-id" placeholder="Model ID"
                        class="setting-input flex-1 mb-0"><button onclick="SettingsLogic.fetchMinimaxModels()"
                        class="setting-btn secondary w-auto"><i class="fa-solid fa-cloud-arrow-down"></i></button></div>
                <select id="minimax-model-select" class="setting-input hidden"
                    onchange="document.getElementById('minimax-model-id').value = this.value">
                    <option value="" disabled selected>â–¼ é€‰æ‹©æ¨¡å‹</option>
                </select>
                <h3 class="section-title">éŸ³è‰² ID</h3><input type="text" id="minimax-voice-id"
                    placeholder="Voice ID (ä¾‹: male-qn-qingse)" class="setting-input">
            </div><button onclick="SettingsLogic.saveTTS()" class="setting-btn w-full mt-8 shadow-lg">ä¿å­˜è®¾ç½®</button>
        </div>

        <!-- Weather Page -->
        <div class="app-content hidden" id="settings-page-weather">
            <h3 class="section-title">åœ°ç‚¹è®¾ç½®</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-400">æ¡Œé¢æ˜¾ç¤ºçš„è™šæ‹Ÿåœ°ç‚¹</label>
                    <input type="text" id="weather-virtual-loc" placeholder="ä¾‹å¦‚ï¼šå“¥è°­å¸‚" class="setting-input">
                </div>
                <div>
                    <label class="text-xs text-gray-400">æ˜ å°„çš„çœŸå®åœ°ç‚¹ (è·å–å¤©æ°”ç”¨)</label>
                    <input type="text" id="weather-real-loc" placeholder="ä¾‹å¦‚ï¼šNew York" class="setting-input">
                    <p class="text-[10px] text-gray-500 mt-1">* è¯·è¾“å…¥çœŸå®çš„åŸå¸‚è‹±æ–‡åæˆ–æ‹¼éŸ³ï¼Œä»¥ä¾¿å‡†ç¡®è·å–å¤©æ°”</p>
                </div>
                <button onclick="WeatherLogic.saveWeatherConfig()" class="setting-btn mt-4">ä¿å­˜å¹¶æ›´æ–°å¤©æ°”</button>
            </div>
        </div>

        <!-- Data Management Page -->
        <div class="app-content hidden" id="settings-page-data">
            <h3 class="section-title">æ•°æ®ç®¡ç†</h3>
            <div class="space-y-4">
                <!-- å¯¼å‡ºæ•°æ® -->
                <div class="glass-panel p-4 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-3">å¯¼å‡ºæ•°æ®</h4>
                    <button onclick="SettingsLogic.showExportDataModal()" class="setting-btn secondary w-full">
                        <i class="fa-solid fa-download mr-2"></i> å¯¼å‡ºå…¨å±€æ•°æ®
                    </button>
                </div>

                <!-- å¯¼å…¥æ•°æ® -->
                <div class="glass-panel p-4 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-3">å¯¼å…¥æ•°æ®</h4>
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('import-data-file').click()"
                            class="setting-btn secondary flex-1">
                            <i class="fa-solid fa-upload mr-2"></i> é€‰æ‹©æ–‡ä»¶
                        </button>
                        <button onclick="SettingsLogic.importGlobalData()" class="setting-btn secondary flex-1">
                            <i class="fa-solid fa-check mr-2"></i> å¼€å§‹å¯¼å…¥
                        </button>
                    </div>
                    <input type="file" id="import-data-file" accept=".json" class="hidden">
                </div>

                <!-- é‡ç½®æ•°æ® -->
                <div class="glass-panel p-4 rounded-2xl">
                    <h4 class="text-lg font-semibold mb-3">é‡ç½®æ•°æ®</h4>
                    <div class="flex gap-2">
                        <button onclick="SettingsLogic.showResetAppModal()" class="setting-btn danger flex-1">
                            <i class="fa-solid fa-rotate-left mr-2"></i> é‡ç½®åº”ç”¨æ•°æ®
                        </button>
                        <button onclick="SettingsLogic.showResetGlobalModal()" class="setting-btn danger flex-1">
                            <i class="fa-solid fa-database-cross mr-2"></i> é‡ç½®å…¨å±€æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Page -->
        <div class="app-content hidden" id="settings-page-storage">
            <h3 class="section-title">ç©ºé—´ä½¿ç”¨æƒ…å†µ</h3>
            <div class="glass-panel p-5 rounded-2xl mb-6">
                <div class="flex justify-between mb-2 text-xs font-bold text-gray-500">
                    <span>å·²ç”¨</span>
                    <span id="storage-text">calculating...</span>
                </div>
                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div id="storage-bar-inner" class="h-full bg-green-500 rounded-full" style="width: 0%"></div>
                </div>
                <div id="storage-list" class="mt-4 space-y-1">
                </div>
            </div>
            <h3 class="section-title">å›¾ç‰‡å‹ç¼©è®¾ç½®</h3>
            <div class="glass-panel p-5 rounded-2xl mb-6">
                <div class="flex justify-between items-center mb-3">
                    <span class="font-medium">èŠå¤©å›¾ç‰‡å‹ç¼©è´¨é‡</span>
                    <span id="compress-quality-value">70%</span>
                </div>
                <input type="range" id="compress-quality-slider" min="0" max="1" step="0.1" value="0.7"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-2"
                    oninput="SettingsLogic.updateCompressQuality(this.value)">
                <div class="flex justify-between text-xs text-gray-500">
                    <span>0%</span>
                    <span>50%</span>
                    <span>100%</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">è°ƒæ•´èŠå¤©å›¾ç‰‡çš„å‹ç¼©è´¨é‡ï¼Œå½±å“å›¾ç‰‡æ¸…æ™°åº¦å’Œå ç”¨ç©ºé—´ã€‚</p>
                <button onclick="SettingsLogic.showCompressConfirm()" class="setting-btn mt-4 w-full">
                    <i class="fa-solid fa-compress mr-2"></i>å¼€å§‹å‹ç¼©æ‰€æœ‰èŠå¤©å›¾ç‰‡
                </button>
            </div>
            <h3 class="section-title">æ·±åº¦æ¸…ç† (ç˜¦èº«)</h3>
            <div class="space-y-3">
                <button onclick="SettingsLogic.clearCacheByType('logs')"
                    class="setting-btn secondary flex justify-between items-center px-4">
                    <span><i class="fa-solid fa-terminal mr-2"></i>æ¸…ç©ºç³»ç»Ÿæ—¥å¿—</span>
                    <span class="text-xs bg-gray-200 px-2 py-1 rounded">æ¨è</span>
                </button>


                <button onclick="SettingsLogic.clearCacheByType('chats')"
                    class="setting-btn danger flex justify-between items-center px-4">
                    <span><i class="fa-regular fa-comments mr-2"></i>æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•</span>
                    <span class="text-xs bg-red-100 text-red-500 px-2 py-1 rounded">ä¿ç•™è§’è‰²</span>
                </button>
            </div>
        </div>

        <!-- Worldbook Page (NEW) -->
    </div>

    <!-- WECHAT APP (Enhanced) -->
    <div id="app-wechat" class="app-window bg-[#f0fdf4]">
        <div class="app-header justify-between bg-white/95 backdrop-blur-xl border-b border-green-200">
            <button onclick="closeApp()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600"><i
                    class="fa-solid fa-xmark"></i></button>
            <div class="font-bold text-lg tracking-wide text-gray-800" id="wechat-header-title">å¾®ä¿¡</div>
            <div class="flex gap-4 text-xl text-gray-600"><button onclick="WeChatUI.openAddMenu()"><i
                        class="fa-solid fa-circle-plus"></i></button></div>
            <div id="wechat-add-menu"
                class="absolute top-14 right-2 w-40 bg-white rounded-lg shadow-xl hidden z-[100] border border-green-200">
                <div onclick="WeChatUI.startCreateChar()"
                    class="p-3 border-b border-green-100 flex items-center gap-3 text-sm text-gray-800 active:bg-green-50">
                    <i class="fa-solid fa-user-plus text-green-500"></i> åˆ›å»ºè§’è‰²
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-[#f0fdf4]">
            <div id="tab-chat" class="w-full overflow-y-auto pb-4"
                style="height: calc(100% - 50px); background-color: var(--app-bg-color);"></div>
            <div id="tab-contacts" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: var(--app-bg-color);">
                <div class="p-2">
                    <div class="bg-green-100 p-3 rounded-lg flex items-center gap-3 mb-2"
                        onclick="WeChatUI.startCreateChar()">
                        <div class="w-10 h-10 bg-green-500 rounded-md flex items-center justify-center"><i
                                class="fa-solid fa-user-plus text-white"></i></div><span
                            class="text-gray-800">åˆ›å»ºè™šæ‹Ÿè§’è‰²</span>
                    </div>
                    <div id="contacts-list-container"></div>
                </div>
            </div>
            <div id="tab-discovery" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: var(--app-bg-color);">
                <div onclick="WeChatUI.openSubPage('subpage-moments')"
                    class="flex items-center justify-between p-4 border-b border-green-200 bg-white/90 mt-2 cursor-pointer">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-spinner text-green-500 text-xl"></i>
                        <span class="text-gray-800">æœ‹å‹åœˆ</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                </div>
                <div onclick="WeChatUI.openSubPage('subpage-favorites')"
                    class="flex items-center justify-between p-4 border-b border-green-200 bg-white/90 cursor-pointer">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-star text-yellow-500 text-xl"></i>
                        <span class="text-gray-800">æ”¶è—</span>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                </div>
            </div>
            <div id="tab-me" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: var(--app-bg-color);">
                <!-- ä¸ªäººä¿¡æ¯åŒºåŸŸ -->
                <div class="p-6 bg-white/90 flex items-center gap-4 mb-2">
                    <div class="w-16 h-16 rounded-lg bg-gray-700 overflow-hidden cursor-pointer"
                        onclick="WeChatUI.openAvatarUpload()">
                        <img id="user-avatar" src="" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div id="user-name" class="text-xl font-bold cursor-pointer" onclick="WeChatUI.editUserName()">æˆ‘
                        </div>
                        <div class="text-xs text-gray-400 mt-1">å¾®ä¿¡å·: admin</div>
                    </div>
                </div>

                <!-- é’±åŒ…åŠŸèƒ½ -->
                <div class="p-4 bg-[#191919] rounded-lg mx-4 mb-4 cursor-pointer" onclick="WeChatUI.openWallet()">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center text-white">
                                <i class="fa-solid fa-wallet text-xl"></i>
                            </div>
                            <div>
                                <div class="font-medium">é’±åŒ…</div>
                                <div class="text-xs text-gray-400">ç®¡ç†ä½ çš„ä½™é¢å’Œäº¤æ˜“</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-500"></i>
                    </div>
                </div>
            </div>

            <!-- é’±åŒ…é¡µé¢ -->
            <div id="subpage-wallet" class="sub-view bg-[#000]">
                <div class="app-header justify-between bg-white/95 border-b border-gray-200">
                    <button onclick="WeChatUI.closeSubPage('subpage-wallet')" class="w-10 h-full"><i
                            class="fa-solid fa-chevron-left"></i></button>
                    <span class="font-bold">é’±åŒ…</span>
                    <div class="w-10"></div>
                </div>
                <div class="app-content p-4">
                    <!-- ä½™é¢æ˜¾ç¤º -->
                    <div class="bg-[#191919] rounded-lg p-6 mb-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">å½“å‰ä½™é¢</div>
                        <div class="text-4xl font-bold text-green-500 mb-4" id="wallet-balance">Â¥0.00</div>
                        <button onclick="WeChatUI.openRechargeModal()"
                            class="bg-green-500 text-white px-6 py-2 rounded-full font-medium">å……å€¼</button>
                    </div>

                    <!-- äº¤æ˜“è®°å½• -->
                    <div>
                        <div class="font-medium text-lg mb-4">äº¤æ˜“è®°å½•</div>
                        <div id="transaction-list" class="space-y-3">
                            <!-- äº¤æ˜“è®°å½•å°†åŠ¨æ€ç”Ÿæˆ -->
                            <div class="text-center text-gray-500 text-sm py-8">æš‚æ— äº¤æ˜“è®°å½•</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤´åƒä¸Šä¼ æ¨¡æ€æ¡† -->
            <div id="modal-avatar-upload" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">ä¿®æ”¹å¤´åƒ</h3>
                    <div class="space-y-3">
                        <button onclick="document.getElementById('avatar-file-input').click()"
                            class="setting-btn w-full">
                            <i class="fa-solid fa-upload mr-2"></i>ä»ç›¸å†Œé€‰æ‹©
                        </button>
                        <button onclick="WeChatUI.generateRandomAvatar()" class="setting-btn secondary w-full">
                            <i class="fa-solid fa-magic mr-2"></i>éšæœºç”Ÿæˆ
                        </button>
                        <button onclick="document.getElementById('modal-avatar-upload').classList.add('hidden')"
                            class="setting-btn secondary w-full">
                            <i class="fa-solid fa-xmark mr-2"></i>å–æ¶ˆ
                        </button>
                    </div>
                    <input type="file" id="avatar-file-input" class="hidden" accept="image/*"
                        onchange="WeChatUI.handleAvatarUpload(this)">
                </div>
            </div>

            <!-- å……å€¼æ¨¡æ€æ¡† -->
            <div id="modal-recharge" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">å……å€¼</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">å……å€¼é‡‘é¢</label>
                            <input type="number" id="recharge-amount" placeholder="è¯·è¾“å…¥å……å€¼é‡‘é¢" class="setting-input"
                                min="0.01" step="0.01" value="100">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="document.getElementById('recharge-amount').value = '10'"
                                class="setting-btn secondary">Â¥10</button>
                            <button onclick="document.getElementById('recharge-amount').value = '50'"
                                class="setting-btn secondary">Â¥50</button>
                            <button onclick="document.getElementById('recharge-amount').value = '100'"
                                class="setting-btn secondary">Â¥100</button>
                            <button onclick="document.getElementById('recharge-amount').value = '200'"
                                class="setting-btn secondary">Â¥200</button>
                            <button onclick="document.getElementById('recharge-amount').value = '500'"
                                class="setting-btn secondary">Â¥500</button>
                            <button onclick="document.getElementById('recharge-amount').value = '1000'"
                                class="setting-btn secondary">Â¥1000</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="document.getElementById('modal-recharge').classList.add('hidden')"
                                class="setting-btn secondary">å–æ¶ˆ</button>
                            <button onclick="WeChatUI.confirmRecharge()" class="setting-btn">ç¡®è®¤å……å€¼</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡† -->
            <div id="modal-edit-username" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">ä¿®æ”¹ç”¨æˆ·å</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">æ–°ç”¨æˆ·å</label>
                            <input type="text" id="edit-username-input" placeholder="è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å" class="setting-input">
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="WeChatUI.cancelEditUsername()" class="setting-btn secondary">å–æ¶ˆ</button>
                            <button onclick="WeChatUI.confirmEditUsername()" class="setting-btn">ç¡®è®¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="glass-bar h-14 flex w-full pb-2 pt-1 z-50">
            <div onclick="WeChatUI.switchTab('chat')" id="btn-tab-chat" class="wechat-tab-btn active"><i
                    class="fa-regular fa-comment"></i><span>å¾®ä¿¡</span></div>
            <div onclick="WeChatUI.switchTab('contacts')" id="btn-tab-contacts" class="wechat-tab-btn"><i
                    class="fa-regular fa-address-book"></i><span>é€šè®¯å½•</span></div>
            <div onclick="WeChatUI.switchTab('discovery')" id="btn-tab-discovery" class="wechat-tab-btn"><i
                    class="fa-regular fa-compass"></i><span>å‘ç°</span></div>
            <div onclick="WeChatUI.switchTab('me')" id="btn-tab-me" class="wechat-tab-btn"><i
                    class="fa-regular fa-user"></i><span>æˆ‘</span></div>
        </div>

        <!-- Moments Page -->
        <div id="subpage-moments" class="sub-view bg-white overflow-y-auto">
            <div class="moments-nav fixed top-0 left-0 w-full z-10 transition-all duration-300" id="moments-nav-bar">
                <div class="moments-nav-btn" onclick="WeChatUI.closeSubPage('subpage-moments')"><i
                        class="fa-solid fa-chevron-left text-white drop-shadow-md"></i></div>
                <div class="flex gap-4">
                    <div class="moments-nav-btn" onclick="WeChatUI.openMomentsEditor()"><i
                            class="fa-solid fa-camera text-white drop-shadow-md"></i></div>
                    <div class="moments-nav-btn" onclick="WeChatUI.generateMoments()"><i
                            class="fa-solid fa-magic text-white drop-shadow-md"></i>
                    </div>
                    <div class="moments-nav-btn" onclick="WeChatUI.openMomentsSettings()"><i
                            class="fa-solid fa-gear text-white drop-shadow-md"></i></div>
                </div>
            </div>

            <!-- Moments Cover -->
            <div class="relative w-full h-[320px] mb-8 group" onclick="WeChatUI.openMomentsSettings()">
                <img id="moments-cover-img"
                    src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80"
                    class="w-full h-full object-cover">
                <div class="absolute bottom-[-20px] right-4 flex items-end gap-3 z-10">
                    <div class="text-white font-bold text-lg mb-4 drop-shadow-md" id="moments-cover-name">ä¹”ä¹”</div>
                    <img id="moments-cover-avatar" src=""
                        class="w-20 h-20 rounded-xl border-2 border-white bg-white shadow-sm object-cover">
                </div>
                <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors"></div>
            </div>

            <div id="moments-list-container"></div>
        </div>

        <!-- Favorites Page -->
        <div id="subpage-favorites" class="sub-view bg-[#f7f7f7] flex flex-col">
            <div class="app-header justify-between bg-white border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <button onclick="WeChatUI.closeSubPage('subpage-favorites')" class="w-10 h-full"><i
                            class="fa-solid fa-chevron-left"></i></button>
                    <span class="font-bold text-sm">æˆ‘çš„æ”¶è—</span>
                </div>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-3" id="favorites-list-container">
                <!-- æ”¶è—å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Favorite Detail Page -->
        <div id="subpage-favorite-detail" class="sub-view bg-white flex flex-col">
            <div class="app-header justify-between bg-white border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <button onclick="WeChatUI.closeSubPage('subpage-favorite-detail')" class="w-10 h-full"><i
                            class="fa-solid fa-chevron-left"></i></button>
                    <span class="font-bold text-sm">æ”¶è—è¯¦æƒ…</span>
                </div>
                <button onclick="WeChatUI.deleteCurrentFavorite()" class="pr-4 text-red-500 text-xs">åˆ é™¤</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6" id="favorite-detail-body">
                <!-- è¯¦æƒ…å†…å®¹ -->
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100 text-[10px] text-gray-400 flex justify-between">
                <span id="fav-detail-source">æ¥è‡ªï¼š--</span>
                <span id="fav-detail-time">æ”¶è—äºï¼š--</span>
            </div>
        </div>

        <!-- Chat Detail -->
        <div id="subpage-chat-detail" class="sub-view bg-white">
            <div class="app-header justify-between bg-white border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <button onclick="WeChatUI.closeSubPage('subpage-chat-detail')" class="w-10 h-full"><i
                            class="fa-solid fa-chevron-left"></i></button>
                    <div class="flex flex-col items-start"><span class="font-semibold text-gray-800 text-sm"
                            id="chat-title">AI</span><span
                            class="text-[10px] text-green-500 cursor-pointer hover:text-green-600"
                            id="chat-online-status" onclick="window.APIQueue.interrupt()" title="ç‚¹å‡»å¯å¿«é€Ÿä¸­æ–­ç”Ÿæˆ">åœ¨çº¿</span>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-1 pr-1">
                    <button onclick="WeChatUI.toggleAutoTTS()" id="btn-auto-tts"
                        class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 border border-transparent transition-all hover:bg-gray-100"
                        title="è‡ªåŠ¨æœ—è¯»">
                        <i class="fa-solid fa-volume-xmark"></i>
                    </button>

                    <button onclick="InnerVoiceUI.openModal()"
                        class="w-8 h-8 rounded-full bg-pink-500/20 text-pink-500 flex items-center justify-center animate-heartbeat text-xs border border-pink-500/30 relative"
                        title="å¿ƒå£°"><i class="fa-solid fa-heart"></i></button>
                    <button onclick="WeChatUI.openCharSettings()"
                        class="w-8 h-8 rounded-full flex items-center justify-center text-gray-400 border border-transparent transition-all hover:bg-gray-100"><i
                            class="fa-solid fa-gear"></i></button>
                </div>
            </div>

            <!-- Redundant Modal Removed -->

            <div class="relative flex-1 overflow-hidden">
                <!-- Background Layer -->
                <div id="chat-bg-layer" class="absolute inset-0 bg-cover bg-center z-0 transition-all"></div>
                <!-- Messages -->
                <div class="absolute inset-0 overflow-y-auto p-4 space-y-4 z-10" id="chat-messages-container"></div>
            </div>

            <div class="bg-white/90 border-t border-gray-200 p-2 pb-safe relative z-50">
                <!-- Toolbar (Moved Back Up) -->
                <div class="flex gap-6 px-2 pb-2 text-gray-600 text-xl items-center relative">
                    <i class="fa-regular fa-face-smile cursor-pointer hover:text-gray-800"
                        onclick="WeChatUI.showEmojiPicker(); event.stopPropagation()"></i>
                    <i class="fa-regular fa-image cursor-pointer hover:text-gray-800"
                        onclick="document.getElementById('chat-img-upload').click()"></i>
                    <i class="fa-solid fa-arrow-right-arrow-left cursor-pointer hover:text-blue-600"
                        onclick="WeChatUI.showTransferModal('transfer')"></i>
                    <i class="fa-solid fa-envelope cursor-pointer hover:text-red-500"
                        onclick="WeChatUI.showTransferModal('redpacket')"></i>
                    <i class="fa-solid fa-microphone cursor-pointer hover:text-green-500"
                        onclick="WeChatUI.toggleVoiceMode()" id="btn-voice-mode"></i>

                    <!-- Call Menu -->
                    <div class="relative inline-block">
                        <i class="fa-solid fa-phone-volume cursor-pointer hover:text-green-600" title="è¯­éŸ³/è§†é¢‘é€šè¯"
                            onclick="document.getElementById('call-menu-dropdown').classList.toggle('hidden')"></i>
                        <div id="call-menu-dropdown"
                            class="hidden absolute bottom-10 left-[-60px] bg-white/95 backdrop-blur-xl shadow-2xl border border-white/50 rounded-xl p-2 w-40 flex flex-col gap-1 z-[100] transform origin-bottom-left transition-all">
                            <div class="flex items-center gap-3 p-3 hover:bg-green-50 rounded-lg cursor-pointer transition-colors"
                                onclick="CallLogic.startCall(document.getElementById('subpage-chat-detail').dataset.charId, 'audio'); document.getElementById('call-menu-dropdown').classList.add('hidden')">
                                <div
                                    class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center shadow-sm">
                                    <i class="fa-solid fa-phone text-green-600 text-xs"></i>
                                </div>
                                <span class="text-sm font-bold text-gray-700">è¯­éŸ³é€šè¯</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 hover:bg-blue-50 rounded-lg cursor-pointer transition-colors"
                                onclick="CallLogic.startCall(document.getElementById('subpage-chat-detail').dataset.charId, 'video'); document.getElementById('call-menu-dropdown').classList.add('hidden')">
                                <div
                                    class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center shadow-sm">
                                    <i class="fa-solid fa-video text-blue-600 text-xs"></i>
                                </div>
                                <span class="text-sm font-bold text-gray-700">è§†é¢‘é€šè¯</span>
                            </div>
                        </div>
                    </div>
                    <i class="fa-solid fa-rotate-right cursor-pointer hover:text-blue-500"
                        onclick="if(window.isAIGenerating && window.currentAIAbortController){window.currentAIAbortController.abort();console.log('[UI] ç”¨æˆ·ç‚¹å‡»ä¸­æ–­AIç”Ÿæˆ');}else if(WeChatUI.regenerateLastReply){WeChatUI.regenerateLastReply();}"
                        id="btn-regenerate" title="é‡æ–°ç”Ÿæˆ/ä¸­æ–­"></i>
                </div>

                <!-- Quote Display Area -->
                <div id="quote-display" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-2 mb-2 text-sm">
                    <div class="flex justify-between items-start">
                        <div class="text-gray-600">å¼•ç”¨</div>
                        <button onclick="WeChatUI.clearQuote()" class="text-gray-400 hover:text-gray-600 text-xs"><i
                                class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="quote-content" class="text-gray-800 mt-1"></div>
                </div>

                <div class="flex gap-2 items-end">
                    <!-- Chat Input with Fullscreen Handle -->
                    <div class="flex-1 relative">
                        <textarea id="chat-input"
                            class="w-full bg-white border border-gray-300 rounded-lg p-2 text-gray-800 text-sm max-h-24 min-h-[40px] focus:ring-0 resize-none"
                            rows="1" placeholder="å‘é€æ¶ˆæ¯..."></textarea>
                        <!-- Fullscreen Handle (Small Stretching Widget in Top Right) -->
                        <button onclick="WeChatUI.toggleFullscreenInput()"
                            class="absolute right-3 top-2 text-gray-400 hover:text-gray-600 transition-colors p-1 rounded">
                            <i class="fa-solid fa-expand text-xs"></i>
                        </button>
                    </div>

                    <!-- Generate Button (Light Blue, Transparent Frosted Glass) -->
                    <!-- Generate Button (Smart Toggle: Magic / Stop) -->
                    <button
                        onclick="if(window.isAIGenerating){window.APIQueue.interrupt();}else{WeChatUI.sendUserMessage(true);}"
                        id="generate-btn"
                        class="w-8 h-8 rounded-full bg-blue-200/80 backdrop-blur-sm border border-blue-300/50 flex items-center justify-center text-blue-700 hover:bg-blue-300/80 transition-all duration-200"
                        title="ç”Ÿæˆ (ç‚¹å‡»ç”Ÿæˆ / ç”Ÿæˆä¸­ç‚¹å‡»åœæ­¢)">
                        <i class="fa-solid fa-magic text-xs"></i>
                    </button>

                    <!-- Send Button (Light Green, Transparent Frosted Glass) -->
                    <button onclick="WeChatUI.sendUserMessage(false)"
                        class="w-8 h-8 rounded-full bg-green-200/80 backdrop-blur-sm border border-green-300/50 flex items-center justify-center text-green-700 hover:bg-green-300/80 transition-all duration-200"
                        title="å‘é€æ¶ˆæ¯">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>

                <!-- Emoji Panel -->
                <div id="emoji-panel"></div>
            </div>

            <!-- Multi-select Bar -->
            <div id="multiselect-bar">
                <button class="text-gray-400" onclick="WeChatUI.exitMultiSelectMode()"><i
                        class="fa-solid fa-xmark"></i></button>
                <button class="text-red-500" onclick="WeChatUI.deleteSelectedMessages()"><i
                        class="fa-solid fa-trash"></i></button>
            </div>



            <input type="file" id="chat-img-upload" class="hidden" onchange="WeChatUI.handleChatImage(this)">
        </div>

        <!-- Create/Edit Char -->
        <div id="subpage-char-settings" class="sub-view bg-transparent text-gray-800 flex flex-col">
            <!-- Subpage wallpaper layer: mirrors global wallpaper so underlying app content doesn't show through -->
            <div id="subpage-wallpaper" class="absolute inset-0 bg-cover bg-center" style="z-index:0;"></div>
            <div class="app-header bg-white/95 border-b border-gray-200 sticky top-0"><button
                    onclick="WeChatUI.closeSubPage('subpage-char-settings')" class="w-10 h-full text-gray-800"><i
                        class="fa-solid fa-chevron-left"></i></button><span class="font-bold text-gray-800"
                    id="char-settings-title">è§’è‰²è®¾ç½®</span><button onclick="WeChatUI.saveCharacter()"
                    class="ml-auto text-green-600 font-bold text-sm bg-green-100 px-3 py-1 rounded">ä¿å­˜</button></div>
            <div class="flex-1 overflow-y-auto overflow-x-visible p-4 space-y-6">
                <!-- Avatar -->
                <div class="flex items-center gap-4">
                    <div class="w-20 h-20 bg-gray-200 border border-gray-300 flex items-center justify-center overflow-hidden"
                        id="char-avatar-preview"><span class="text-xs text-gray-600">å¤´åƒ</span></div>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="char-name" class="setting-input mb-0" placeholder="è§’è‰²åå­—">
                        <div class="flex gap-2"><button class="setting-btn secondary text-xs py-1"
                                onclick="document.getElementById('char-upload-file').click()">æœ¬åœ°ä¸Šä¼ </button><button
                                class="setting-btn secondary text-xs py-1"
                                onclick="WeChatUI.promptAvatarUrl()">URLä¸Šä¼ </button></div>
                        <input type="file" id="char-upload-file" class="hidden"
                            onchange="WeChatUI.handleAvatarFile(this)">
                        <input type="hidden" id="char-avatar-data">
                        <div class="flex items-center gap-2 mt-1"><span class="text-xs text-gray-600">å½¢çŠ¶:</span><select
                                id="char-avatar-shape" class="bg-white border border-gray-300 text-xs p-1 rounded">
                                <option value="square">æ–¹å½¢</option>
                                <option value="circle">åœ†å½¢</option>
                            </select></div>
                    </div>
                </div>
                <!-- Persona -->
                <div>
                    <h3 class="section-title">æˆ‘çš„äººè®¾ (User Persona)</h3>
                    <input type="text" id="char-user-name" class="setting-input" placeholder="æˆ‘çš„åå­—">
                    <textarea id="char-user-persona" class="setting-input h-16 mt-2" placeholder="æˆ‘çš„äººè®¾..."></textarea>
                    <div class="flex items-center gap-2 mt-2">
                        <div class="w-10 h-10 bg-gray-200 rounded overflow-hidden" id="user-avatar-preview"></div>
                        <div class="flex gap-2 flex-1">
                            <button class="setting-btn secondary text-xs flex-1"
                                onclick="document.getElementById('user-upload-file').click()">æœ¬åœ°ä¸Šä¼ </button>
                            <button class="setting-btn secondary text-xs flex-1"
                                onclick="WeChatUI.promptUserAvatarUrl()">URLä¸Šä¼ </button>
                        </div>
                        <input type="file" id="user-upload-file" class="hidden"
                            onchange="WeChatUI.handleUserAvatarFile(this)">
                        <input type="hidden" id="user-avatar-data">
                    </div>
                </div>
                <div>
                    <h3 class="section-title">è§’è‰²è®¾å®š</h3><input type="text" id="char-nickname" class="setting-input"
                        placeholder="æ˜µç§°å¤‡æ³¨"><textarea id="char-prompt" class="setting-input h-32"
                        placeholder="Prompt..."></textarea>
                </div>
                <div>
                    <h3 class="section-title">å¼€åœºç™½è®¾ç½®</h3><textarea id="char-opening-line" class="setting-input h-20"
                        placeholder="è‡ªå®šä¹‰å¼€åœºAIè¯´çš„ç¬¬ä¸€å¥è¯..."></textarea>
                    <div class="text-xs text-gray-500 mt-1">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å¥½å‹ç”³è¯·å¡ç‰‡</div>
                </div>

                <!-- Worldbook Integration -->
                <div>
                    <h3 class="section-title">å…³è”ä¸–ç•Œä¹¦</h3>
                    <div class="glass-panel p-3 rounded-lg" id="char-worldbook-list">
                        <div class="text-xs text-gray-500 text-center py-2">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·åœ¨æ¡Œé¢Appä¸­åˆ›å»º</div>
                    </div>
                </div>

                <!-- Time Awareness -->
                <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2"><span
                        class="text-sm text-gray-800">æ—¶é—´æ„ŸçŸ¥</span><input type="checkbox" id="char-time-aware"
                        class="toggle-switch"></div>
                <div id="virtual-time-container" class="hidden mb-2"><input type="text" id="char-virtual-time"
                        class="setting-input" placeholder="è™šæ‹Ÿæ—¶é—´ (å¦‚: 2077å¹´ æ™šä¸Š8ç‚¹)"></div>

                <!-- Active Chat -->
                <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2">
                    <span class="text-sm text-gray-800 font-bold">æŸ¥å²—ï¼ˆç¦»å¼€ç•Œé¢åè§¦å‘ï¼‰</span>
                    <input type="checkbox" id="char-active-chat-switch" class="toggle-switch">
                </div>
                <div class="flex items-center gap-2 mb-4 px-2">
                    <span class="text-xs text-gray-600">ç¦»å¼€</span>
                    <input type="number" id="char-active-interval" class="setting-input w-16 text-center mb-0 py-1"
                        value="30">
                    <span class="text-xs text-gray-600">åˆ†é’Ÿåè§¦å‘</span>
                </div>

                <!-- Proactive Chat (æ–°åŠŸèƒ½) -->
                <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2">
                    <span class="text-sm text-gray-800 font-bold">ä¸»åŠ¨å‘æ¶ˆæ¯ï¼ˆç•Œé¢å†…è§¦å‘ï¼‰</span>
                    <input type="checkbox" id="char-proactive-chat-switch" class="toggle-switch">
                </div>
                <div class="flex items-center gap-2 mb-4 px-2">
                    <span class="text-xs text-gray-600">æ¯éš”</span>
                    <input type="number" id="char-proactive-interval" class="setting-input w-16 text-center mb-0 py-1"
                        value="5">
                    <span class="text-xs text-gray-600">åˆ†é’Ÿä¸»åŠ¨å‘ä¸€æ¡æ¶ˆæ¯</span>
                </div>

                <!-- Memory -->
                <div>
                    <h3 class="section-title">è®°å¿†ä¸æ€»ç»“</h3>
                    <div class="grid grid-cols-2 gap-2 text-center mb-3">
                        <div class="glass-panel p-2 rounded-lg">
                            <div class="text-xs text-gray-600">æ€»èŠå¤©æ¡æ•°</div>
                            <div class="font-mono text-blue-600 text-lg" id="stat-chat-count">0</div>
                        </div>
                        <div class="glass-panel p-2 rounded-lg">
                            <div class="text-xs text-gray-600">ä¸Šä¸‹æ–‡Token</div>
                            <div class="font-mono text-purple-600 text-lg" id="stat-token-count">0</div>
                        </div>
                    </div>
                    <div class="mb-2"><label class="text-xs text-gray-600 ml-1">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number"
                            id="char-context-limit" class="setting-input mt-1" placeholder="é»˜è®¤ 20 æ¡"></div>
                    <div class="mb-2"><label class="text-xs text-gray-600 ml-1">ä¸Šä¸‹æ–‡æ˜¾ç¤ºæ¡æ•°</label><input type="number"
                            id="char-display-limit" class="setting-input mt-1" placeholder="é»˜è®¤ 50 æ¡"></div>
                    <div class="mb-2"><label class="text-xs text-gray-600 ml-1">è‡ªåŠ¨æ€»ç»“æ¡æ•°</label><input type="number"
                            id="char-summary-limit" class="setting-input mt-1" placeholder="é»˜è®¤ 50 æ¡"></div>
                    <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2"><span
                            class="text-sm text-gray-800">è‡ªåŠ¨æ€»ç»“</span><input type="checkbox" id="char-auto-summary"
                            class="toggle-switch"></div>
                    <textarea id="char-summary-prompt" class="setting-input h-20" placeholder="æ€»ç»“æç¤ºè¯..."></textarea>
                    <div class="flex gap-2"><button class="setting-btn secondary text-xs"
                            onclick="WeChatUI.triggerManualSummary()">æ‰‹åŠ¨æ€»ç»“</button><button
                            class="setting-btn secondary text-xs" onclick="WeChatUI.openMemoryLib()">è®°å¿†ç®¡ç†åº“</button>
                    </div>
                </div>

                <!-- Memory Link -->
                <div class="mb-2">
                    <h3 class="section-title">è®°å¿†äº’é€š</h3>
                    <div class="glass-panel p-3 rounded-lg">
                        <div class="text-xs text-gray-600 ml-1 mb-2">é€‰æ‹©è¦é“¾æ¥çš„èŠå¤© (AIå°†èƒ½çœ‹åˆ°å¯¹æ–¹æœ€è¿‘çš„æ¶ˆæ¯)</div>
                        <div class="custom-multiselect mb-3">
                            <div
                                class="select-box flex justify-between items-center p-2 bg-gray-50 rounded-lg cursor-pointer">
                                <span class="selected-options-text text-sm text-gray-500">-- ç‚¹å‡»é€‰æ‹©è¦é“¾æ¥çš„èŠå¤© --</span>
                                <span class="arrow-down text-gray-400">â–¼</span>
                            </div>
                            <div
                                class="checkboxes-container hidden bg-white rounded-lg shadow-lg mt-1 p-2 max-h-40 overflow-y-auto">
                                <div id="memory-link-checkboxes-container">
                                    <!-- èŠå¤©é€‰é¡¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-600 ml-1">äº’é€šè®°å¿†æ¡æ•°</label>
                            <input type="number" id="link-memory-depth-input" class="setting-input w-20 text-center"
                                value="5" min="1" max="20" style="padding: 6px;">
                        </div>
                    </div>
                </div>
                <!-- Chat Export/Import -->
                <div>
                    <h3 class="section-title">èŠå¤©è®°å½•</h3>
                    <div class="flex gap-2">
                        <button class="setting-btn secondary flex-1 text-xs"
                            onclick="WeChatUI.exportChatHistory()">å¯¼å‡ºèŠå¤©è®°å½•</button>
                        <button class="setting-btn secondary flex-1 text-xs"
                            onclick="WeChatUI.importChatHistory()">å¯¼å…¥èŠå¤©è®°å½•</button>
                    </div>
                    <div class="mt-2">
                        <button class="setting-btn secondary w-full text-xs" onclick="WeChatUI.openChatSearch()">
                            <i class="fa-solid fa-magnifying-glass mr-2"></i>æœç´¢èŠå¤©è®°å½•
                        </button>
                    </div>
                </div>
                <!-- NPC Binding -->
                <div>
                    <h3 class="section-title flex justify-between">
                        <span>ç»‘å®šNPC</span>
                        <button onclick="WeChatUI.openNPCManager()" class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fa-solid fa-users mr-1"></i>ç®¡ç†NPC
                        </button>
                    </h3>
                    <div class="glass-panel p-3 rounded-lg mb-2">
                        <div id="npc-binding-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- NPC binding list will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Emojis -->
                <div>
                    <h3 class="section-title flex justify-between items-center">
                        <span>è¡¨æƒ…åŒ…åº“</span>
                        <button onclick="WeChatUI.toggleEmojiCategories()"
                            class="px-3 py-1 bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 text-sm rounded-full transition-colors">
                            <i class="fa-solid fa-tags mr-1"></i>åˆ†ç±»
                        </button>
                    </h3>
                    <div class="flex gap-2 mb-2">
                        <select id="emoji-category-select" class="setting-input text-base mb-0 p-2"
                            style="height: 40px; width: 150px; padding: 10px; font-size: 13px; box-sizing: border-box; line-height: normal;"
                            onchange="WeChatUI.filterEmojisByCategory()">
                            <option value="">æ‰€æœ‰åˆ†ç±»</option>
                            <option value="special_exclusive">è§’è‰²ä¸“å±</option>
                            <option value="special_global">å…¨å±€é€šç”¨</option>
                            <option value="default">é»˜è®¤åˆ†ç±»</option>
                        </select>
                        <button class="setting-btn secondary text-sm"
                            onclick="const el = document.getElementById('modal-emoji-upload'); el.classList.remove('hidden'); el.style.display='flex'; document.getElementById('emoji-url-input').focus()">ä¸Šä¼ </button>
                    </div>

                    <!-- Emoji Category Management (ç›´æ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸­) -->
                    <div id="emoji-category-management" class="hidden glass-panel p-3 rounded-lg mb-3">
                        <h4 class="font-bold mb-2">åˆ†ç±»ç®¡ç†</h4>
                        <div class="mb-3">
                            <input type="text" id="new-category-name" class="setting-input" placeholder="æ–°åˆ†ç±»åç§°">
                            <button onclick="WeChatUI.addEmojiCategory()" class="setting-btn w-full mt-2">æ·»åŠ åˆ†ç±»</button>
                        </div>
                        <div id="emoji-categories-list" class="space-y-2 max-h-40 overflow-y-auto mb-3">
                            <!-- Categories will be rendered here -->
                        </div>
                    </div>

                    <div id="emoji-grid" class="emoji-grid mb-2"></div>
                </div>

                <!-- Voice -->
                <div>
                    <h3 class="section-title">è¯­éŸ³ (TTS)</h3>
                    <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2">
                        <span class="text-sm">å¯ç”¨ TTS</span>
                        <input type="checkbox" id="char-tts-enabled" class="toggle-switch">
                    </div>
                    <input type="text" id="char-voice-id" class="setting-input" placeholder="è§’è‰² Voice ID (MiniMax)">
                    <div class="flex items-center gap-2"><span class="text-xs text-gray-400">è¯­é€Ÿ</span><input
                            type="range" id="char-voice-speed" min="0.5" max="2" step="0.1" value="1.0"
                            class="flex-1 h-1 bg-gray-700 rounded-lg accent-green-500"
                            oninput="document.getElementById('val-voice-speed').textContent = this.value"><span
                            class="text-xs w-6 text-right" id="val-voice-speed">1.0</span></div>
                </div>

                <!-- æ‹ä¸€æ‹è®¾ç½® -->
                <div>
                    <h3 class="section-title">æ‹ä¸€æ‹è®¾ç½®</h3>
                    <div class="space-y-2">
                        <input type="text" id="char-pat-action" class="setting-input" placeholder="è‡ªå®šä¹‰åŠ¨ä½œï¼Œå¦‚ï¼šæ•²äº†æ•²ã€æ‘¸äº†æ‘¸">
                        <input type="text" id="char-pat-suffix" class="setting-input" placeholder="è‡ªå®šä¹‰åç¼€ï¼Œå¦‚ï¼šçš„å¤´ã€çš„è‚©è†€">
                    </div>
                </div>

                <!-- Bubble & Background Style (Enhanced) -->
                <div>
                    <h3 class="section-title">æ°”æ³¡ä¸èƒŒæ™¯</h3>
                    <div class="relative w-full h-48 rounded-lg overflow-hidden border border-white/10 mb-3 bg-white flex flex-col justify-center p-3"
                        id="preview-chat-container">
                        <div id="preview-chat-bg"
                            class="absolute inset-0 bg-cover bg-center transition-all duration-300 z-0"></div>
                        <div class="msg-row other relative z-10">
                            <div class="msg-avatar square" id="preview-avatar-other"><img
                                    src="https://picsum.photos/seed/default-other/100/100"></div>
                            <div class="msg-content">
                                <div class="chat-bubble" id="preview-bubble-other">è§’è‰²å›å¤çš„æ¶ˆæ¯<span
                                        class="msg-timestamp">12:00</span></div>
                            </div>
                        </div>
                        <div class="msg-row self relative z-10">
                            <div class="msg-avatar square" id="preview-avatar-self"><img
                                    src="https://picsum.photos/seed/default-self/100/100"></div>
                            <div class="msg-content">
                                <div class="chat-bubble" id="preview-bubble-self">æˆ‘çš„æ¶ˆæ¯<span
                                        class="msg-timestamp">12:01</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-2"><span class="text-xs text-gray-400">å­—ä½“å¤§å°</span><input
                            type="range" id="char-bubble-size" min="12" max="30" step="1" value="15"
                            class="flex-1 h-1 bg-gray-700 rounded-lg accent-green-500"
                            oninput="WeChatUI.updateBgPreview()"><span class="text-xs w-6 text-right"
                            id="val-bubble-size">15</span></div>
                    <input type="text" id="char-bubble-css" class="setting-input" placeholder="æ°”æ³¡ CSS (å®æ—¶é¢„è§ˆ)"
                        oninput="WeChatUI.updateBgPreview()">
                    <div class="flex gap-2 mb-3"><select id="bubble-preset-select" class="setting-input mb-0 flex-1"
                            onchange="WeChatUI.loadBubblePreset()">
                            <option value="" disabled selected>é€‰æ‹©é¢„è®¾...</option>
                        </select><button class="setting-btn secondary w-auto text-xs whitespace-nowrap"
                            onclick="WeChatUI.saveBubblePreset()">ä¿å­˜é¢„è®¾</button><button
                            class="setting-btn danger w-auto text-xs whitespace-nowrap"
                            onclick="WeChatUI.deleteBubblePreset()"><i class="fa-solid fa-trash"></i></button></div>
                    <div class="space-y-3 mt-2">
                        <div class="flex gap-2"><input type="text" id="char-chat-bg" class="setting-input mb-0 flex-1"
                                placeholder="èƒŒæ™¯å›¾ URL" oninput="WeChatUI.updateBgPreview()"><button
                                class="setting-btn secondary w-auto text-xs whitespace-nowrap px-3"
                                onclick="document.getElementById('char-bg-upload').click()">ç›¸å†Œ</button><button
                                class="setting-btn secondary bg-red-100 text-red-500 w-auto text-xs whitespace-nowrap px-3"
                                onclick="WeChatUI.clearChatBg()">æ¸…é™¤</button><input type="file" id="char-bg-upload"
                                class="hidden" onchange="WeChatUI.handleChatBgFile(this)"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="flex justify-between text-xs text-gray-400 mb-1"><span>æ¨¡ç³Šåº¦</span><span
                                        id="val-blur">0px</span></div><input type="range" id="char-bg-blur" min="0"
                                    max="20" step="1" value="0"
                                    class="w-full h-1 bg-gray-700 rounded-lg accent-blue-500"
                                    oninput="WeChatUI.updateBgPreview()">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs text-gray-400 mb-1"><span>é€æ˜åº¦</span><span
                                        id="val-opacity">100%</span></div><input type="range" id="char-bg-opacity"
                                    min="0" max="1" step="0.1" value="1"
                                    class="w-full h-1 bg-gray-700 rounded-lg accent-blue-500"
                                    oninput="WeChatUI.updateBgPreview()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-create-name" class="modal-overlay hidden">
            <div class="modal-box text-center">
                <h3 class="text-lg font-bold mb-4">åˆ›å»ºæ–°è§’è‰²</h3><input type="text" id="new-char-name-input"
                    class="setting-input text-center text-lg" placeholder="è¾“å…¥åå­—">
                <div class="grid grid-cols-2 gap-3 mt-4"><button class="setting-btn secondary"
                        onclick="document.getElementById('modal-create-name').classList.add('hidden')">å–æ¶ˆ</button><button
                        class="setting-btn" onclick="WeChatUI.confirmCreateName()">ç¡®å®š</button></div>
            </div>
        </div>
        <div id="modal-memory-lib" class="modal-overlay hidden">
            <div class="modal-box h-[80vh] flex flex-col max-w-[90vw]">
                <div class="flex justify-between items-center mb-6 px-2">
                    <h3 class="font-bold text-lg text-white/90 tracking-wide">
                        <i class="fa-solid fa-brain text-purple-400 mr-2"></i>è®°å¿†ç®¡ç†åº“
                    </h3>
                    <button onclick="document.getElementById('modal-memory-lib').classList.add('hidden')"
                        class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-white/60 hover:text-white transition-all">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div id="memory-lib-container" class="flex-1 overflow-y-auto custom-scrollbar px-2 space-y-4 mb-4">
                    <!-- Content rendered by JS -->
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-white/5">
                    <button id="memory-batch-delete-btn"
                        class="px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 text-xs flex items-center gap-2 transition-all border border-red-500/20">
                        <i class="fa-solid fa-trash-can"></i> æ‰¹é‡åˆ é™¤
                    </button>
                    <button id="memory-refresh-btn"
                        class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white/70 text-xs flex items-center gap-2 transition-all border border-white/10">
                        <i class="fa-solid fa-rotate-right"></i> åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>
            </div>
        </div>
        <div id="modal-msg-history" class="modal-overlay hidden">
            <div class="modal-box w-full max-w-md bg-white/95 backdrop-blur-xl">
                <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                    <h3 class="font-bold text-gray-700">âœï¸ ç¼–è¾‘å†å²</h3>
                    <button onclick="document.getElementById('modal-msg-history').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div id="msg-history-list" class="space-y-3 max-h-[60vh] overflow-y-auto p-1">
                </div>
            </div>
        </div>
        <div id="modal-emoji-upload" class="modal-overlay hidden">
            <div class="modal-box w-11/12 max-w-sm bg-white rounded-xl p-4 shadow-2xl">
                <h3 class="font-bold mb-2">æ‰¹é‡ä¸Šä¼ è¡¨æƒ…åŒ… URL</h3>
                <div class="mb-2"><label class="block text-sm text-gray-400 mb-1">è¡¨æƒ…åŒ…ç±»å‹</label><select
                        id="emoji-type-select" class="setting-input"
                        style="height: 40px; display: block; width: 100%; padding: 10px; font-size: 13px; box-sizing: border-box; line-height: normal;">
                        <option value="exclusive">ä¸“å±è¡¨æƒ…åŒ… (ä»…å½“å‰è§’è‰²å¯ç”¨)</option>
                        <option value="global">å…¨å±€è¡¨æƒ…åŒ… (æ‰€æœ‰è§’è‰²å¯ç”¨)</option>
                    </select></div><textarea id="emoji-url-input" class="setting-input h-32"
                    placeholder="æ¯è¡Œä¸€ä¸ªé“¾æ¥..."></textarea>
                <div class="grid grid-cols-2 gap-3"><button class="setting-btn secondary"
                        onclick="document.getElementById('modal-emoji-upload').classList.add('hidden')">å–æ¶ˆ</button><button
                        class="setting-btn" onclick="WeChatUI.confirmEmojiUpload()">å¯¼å…¥</button></div>
            </div>
        </div>

        <!-- Manual Summary Modal -->
        <div id="modal-manual-summary" class="modal-overlay hidden">
            <div class="modal-box">
                <h3 class="font-bold mb-4">æ‰‹åŠ¨æ€»ç»“</h3>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">æ€»ç»“åŒºé—´</label>
                    <input type="text" id="summary-range-input" placeholder="ä¾‹å¦‚: 5-20 (æ€»ç»“ç¬¬5åˆ°20æ¡æ¶ˆæ¯)"
                        class="setting-input">
                    <div class="text-xs text-gray-500 mt-1">è¾“å…¥æ ¼å¼: å¼€å§‹ç¼–å·-ç»“æŸç¼–å·</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="WeChatUI.cancelManualSummary()" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                    <button onclick="WeChatUI.confirmManualSummary()" class="setting-btn flex-1">ç¡®å®š</button>
                </div>
            </div>
        </div>

        <!-- Transfer Modal -->
        <div id="modal-transfer" class="modal-overlay hidden">
            <div class="modal-box text-center">
                <h3 class="text-lg font-bold mb-4" id="transfer-title">è½¬è´¦</h3>
                <input type="number" id="transfer-amount"
                    class="setting-input text-center text-2xl font-bold text-yellow-400" placeholder="0.00">
                <input type="text" id="transfer-note" class="setting-input" placeholder="å¤‡æ³¨ (å¯é€‰)">
                <div class="grid grid-cols-2 gap-3 mt-4"><button class="setting-btn secondary"
                        onclick="document.getElementById('modal-transfer').classList.add('hidden')">å–æ¶ˆ</button><button
                        class="setting-btn" onclick="WeChatUI.confirmTransfer()">æ”¯ä»˜</button></div>
            </div>
        </div>

        <!-- Moment Comment Modal -->
        <div id="modal-moment-comment" class="modal-overlay hidden">
            <div class="modal-box">
                <h3 class="font-bold mb-4">è¯„è®º</h3>
                <textarea id="moment-comment-input" class="setting-input h-24 resize-none"
                    placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button class="setting-btn secondary" onclick="ModalManager.close('modal-moment-comment')">
                        å–æ¶ˆ
                    </button>
                    <button class="setting-btn" onclick="WeChatUI.submitMomentComment()">
                        å‘é€
                    </button>
                </div>
            </div>
        </div>

        <!-- Moment Share Modal - Friend Selector -->
        <div id="modal-moment-share" class="modal-overlay hidden">
            <div class="modal-box max-w-md">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold">åˆ†äº«åˆ°</h3>
                    <button onclick="WeChatUI.closeShareModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" id="share-friend-search" class="setting-input" placeholder="æœç´¢å¥½å‹..."
                        oninput="WeChatUI.filterShareFriends(this.value)">
                </div>

                <!-- Friend List -->
                <div id="share-friend-list" class="max-h-96 overflow-y-auto space-y-2">
                    <!-- å¥½å‹åˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <button class="setting-btn secondary w-full mt-4" onclick="WeChatUI.closeShareModal()">
                    å–æ¶ˆ
                </button>
            </div>
        </div>

        <!-- Payment Action Modal (Unified) -->
        <div id="modal-payment-action" class="modal-overlay hidden">
            <div class="modal-box text-center" style="background:#f2f2f2; color:black;">
                <div id="payment-action-icon"
                    class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mx-auto mb-4 text-2xl text-white">
                    <i class="fa-solid fa-sack-dollar"></i>
                </div>
                <h3 class="text-lg font-bold mb-2" id="payment-action-title">æ”¶åˆ°è½¬è´¦</h3>
                <div class="text-3xl font-bold mb-2" id="payment-action-amount">Â¥0.00</div>
                <div class="text-gray-500 text-sm mb-6" id="payment-action-desc">å¤‡æ³¨</div>
                <div class="grid grid-cols-2 gap-3">
                    <button class="setting-btn danger" onclick="WeChatUI.processPaymentAction('rejected')">é€€è¿˜</button>
                    <button class="setting-btn" style="background: #f7931a;"
                        onclick="WeChatUI.processPaymentAction('received')">æ”¶ä¸‹</button>
                </div>
            </div>
        </div>

        <!-- Open Red Packet Modal (QQ Style) -->
        <div id="modal-open-redpacket" class="modal-overlay hidden">
            <div class="redpacket-modal w-[300px] rounded-2xl relative overflow-visible">
                <div class="rp-top-curve"></div>
                <button onclick="document.getElementById('modal-open-redpacket').classList.add('hidden')"
                    class="absolute top-2 left-2 text-white/50 text-xl z-10"><i class="fa-solid fa-xmark"></i></button>
                <div class="rp-user-avatar" id="rp-open-avatar"><img src=""></div>
                <div class="rp-msg text-[#fce5cd] mt-2 font-bold" id="rp-open-msg">æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©</div>
                <div class="rp-open-btn" onclick="WeChatUI.triggerOpenPacket()">é–‹</div>

                <!-- Result View (Initially hidden) -->
                <div id="rp-result-view" class="rp-result">
                    <h3 class="text-[#d95940] font-bold text-lg">å·²å­˜å…¥é›¶é’±</h3>
                    <div class="rp-amount"><span>Â¥</span><span id="rp-result-amount">0.00</span></div>
                    <div class="text-gray-400 text-xs mt-auto mb-4 cursor-pointer"
                        onclick="document.getElementById('modal-open-redpacket').classList.add('hidden')">å…³é—­</div>
                </div>

                <div class="mt-8 text-white/50 text-xs cursor-pointer hover:text-white" id="rp-reject-btn"
                    onclick="WeChatUI.triggerRejectPacket()">æ‹’æ”¶çº¢åŒ…</div>
                <div class="mt-auto text-white/30 text-xs pb-4" id="rp-detail-link">æŸ¥çœ‹é¢†å–è¯¦æƒ… ></div>
            </div>
        </div>

        <!-- Publish Moment Modal -->
        <div id="modal-publish-moment" class="modal-overlay hidden">
            <div class="modal-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">å‘æœ‹å‹åœˆ</h3>
                    <button onclick="WeChatUI.closeMomentsEditor()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <textarea id="moment-content-input" placeholder="åˆ†äº«æ–°é²œäº‹..."></textarea>

                    <div id="moment-images-preview"></div>

                    <div class="flex gap-2">
                        <button onclick="document.getElementById('moment-image-picker').click()"
                            class="setting-btn secondary flex-1 text-sm">
                            <i class="fa-solid fa-image mr-2"></i>é€‰æ‹©å›¾ç‰‡ (æœ€å¤š9å¼ )
                        </button>
                        <input type="file" id="moment-image-picker" multiple accept="image/*" class="hidden">
                    </div>

                    <input type="text" id="moment-location-input" placeholder="æ‰€åœ¨ä½ç½® (å¯é€‰)" class="setting-input">

                    <!-- å‘å¸ƒæŒ‰é’® -->
                    <div class="flex gap-2">
                        <button onclick="WeChatUI.closeMomentsEditor()" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                        <button onclick="WeChatUI.publishMoment()" class="setting-btn flex-1">å‘è¡¨</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Moment to Chat Modal -->
        <div id="modal-share-select" class="modal-overlay hidden">
            <div class="modal-box max-w-sm">
                <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                    <h3 class="font-bold text-gray-700">ğŸ”— åˆ†äº«åˆ°èŠå¤©</h3>
                    <button onclick="document.getElementById('modal-share-select').classList.add('hidden')"
                        class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div id="share-contact-list" class="max-h-96 overflow-y-auto space-y-2">
                    <!-- Contacts will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Recalled Message Viewer -->
        <div id="modal-recall-view" class="modal-overlay hidden">
            <div class="modal-box text-center">
                <h3 class="font-bold mb-4 text-gray-400">æ’¤å›çš„æ¶ˆæ¯</h3>
                <div id="recall-content-text" class="text-white text-sm bg-gray-800 p-4 rounded-lg break-all"></div>
                <button class="setting-btn secondary mt-4"
                    onclick="document.getElementById('modal-recall-view').classList.add('hidden')">å…³é—­</button>
            </div>
        </div>

        <!-- Edit Message Modal -->
        <div id="modal-edit-msg" class="modal-overlay hidden">
            <div class="modal-box w-full max-w-md flex flex-col"
                style="max-height: 85vh; width: 95% !important; max-width: 500px !important;">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700/10">
                    <h3 class="font-bold text-lg">ç¼–è¾‘ä¸æ‹†åˆ†æ¶ˆæ¯</h3>
                    <button onclick="document.getElementById('modal-edit-msg').classList.add('hidden')"
                        class="text-gray-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="edit-msg-list" class="flex-1 overflow-y-auto space-y-3 p-1 pr-2"></div>
                <div class="mt-3 pt-3 border-t border-gray-700/10 flex flex-col gap-3">
                    <button
                        class="setting-btn secondary text-sm py-3 border-dashed border-2 border-gray-300 hover:border-blue-400 hover:text-blue-500 bg-gray-50"
                        onclick="WeChatUI.addEditBlock()"><i class="fa-solid fa-plus mr-1"></i>æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯</button>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="setting-btn secondary"
                            onclick="document.getElementById('modal-edit-msg').classList.add('hidden')">å–æ¶ˆ</button>
                        <button class="setting-btn shadow-lg shadow-blue-500/30"
                            onclick="WeChatUI.confirmEditMsg()">ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="context-menu" class="hidden">
            <div class="ctx-item" onclick="WeChatUI.ctxEdit()"><i class="fa-solid fa-pen"></i> ç¼–è¾‘</div>
            <div class="ctx-item" onclick="WeChatUI.viewMsgHistory()"><i class="fa-solid fa-clock-rotate-left"></i>
                ç¼–è¾‘å†å²
            </div>
            <div class="ctx-item" onclick="WeChatUI.ctxCopy()"><i class="fa-regular fa-copy"></i> å¤åˆ¶</div>
            <div class="ctx-item" onclick="WeChatUI.ctxQuote()"><i class="fa-solid fa-quote-left"></i> å¼•ç”¨</div>
            <div class="ctx-item" onclick="WeChatUI.ctxRevoke()"><i class="fa-solid fa-rotate-left"></i> æ’¤å›</div>
            <div class="ctx-item" onclick="WeChatUI.ctxFav()"><i class="fa-regular fa-star"></i> æ”¶è—</div>
            <div class="ctx-item" onclick="WeChatUI.ctxListen()"><i class="fa-solid fa-volume-high"></i> å¬éŸ³</div>
            <div class="ctx-item" onclick="WeChatUI.enterMultiSelectMode()"><i class="fa-solid fa-check-double"></i>
                å¤šé€‰
            </div>
            <div class="ctx-divider"></div>
            <div class="ctx-item text-red-400" onclick="WeChatUI.ctxDelete()"><i class="fa-solid fa-trash"></i> åˆ é™¤
            </div>
        </div>

        <!-- Contact Context Menu -->
        <div id="contact-context-menu" class="hidden"
            style="position: fixed; background: #2b2b2b; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 9999; width: 140px; border: 1px solid #333;">
            <div class="ctx-item" onclick="WeChatUI.togglePinContact()"><i class="fa-solid fa-thumbtack"></i> ç½®é¡¶å¥½å‹
            </div>
            <div class="ctx-divider"></div>
            <div class="ctx-item text-red-400"><i class="fa-solid fa-trash"></i> <span
                    id="contact-delete-text">åˆ é™¤å¥½å‹</span></div>
        </div>
        <div id="modal-edit-msg" class="modal-overlay hidden" style="z-index: 10000;">
            <div class="modal-box w-full max-w-md flex flex-col"
                style="max-height: 85vh; width: 95% !important; max-width: 500px !important; background: white;">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100">
                    <h3 class="font-bold text-lg text-gray-800">ç¼–è¾‘æ¶ˆæ¯</h3>
                    <button onclick="document.getElementById('modal-edit-msg').classList.add('hidden')"
                        class="text-gray-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div id="edit-msg-list" class="flex-1 overflow-y-auto space-y-3 p-1"></div>

                <div class="mt-3 pt-3 border-t border-gray-100 flex flex-col gap-3">
                    <button
                        class="setting-btn secondary text-sm py-3 border-dashed border-2 border-gray-300 hover:border-blue-400 hover:text-blue-500 bg-gray-50"
                        onclick="WeChatUI.addEditBlock()">
                        <i class="fa-solid fa-plus mr-1"></i>æ·»åŠ ä¸‹ä¸€æ¡æ¶ˆæ¯
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="setting-btn secondary"
                            onclick="document.getElementById('modal-edit-msg').classList.add('hidden')">å–æ¶ˆ</button>
                        <button class="setting-btn shadow-lg shadow-blue-500/30"
                            onclick="WeChatUI.confirmEditMsg()">ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast"></div>

        <!-- NPC Management Modal -->
        <div id="modal-npc-manager" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">NPCç®¡ç†</h3>
                    <button onclick="document.getElementById('modal-npc-manager').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="flex justify-end gap-2 mb-3">
                    <button onclick="WeChatUI.startCreateNPC()" class="setting-btn secondary text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>æ·»åŠ NPC
                    </button>
                    <button onclick="WeChatUI.openRandomNPCModal()" class="setting-btn secondary text-sm">
                        <i class="fa-solid fa-dice mr-1"></i>éšæœºç”Ÿæˆ
                    </button>
                </div>
                <div id="npc-list" class="max-h-60 overflow-y-auto mb-3">
                    <!-- NPC list will be rendered here -->
                </div>
                <button class="setting-btn secondary w-full"
                    onclick="document.getElementById('modal-npc-manager').classList.add('hidden')">å…³é—­</button>
            </div>
        </div>

        <!-- NPC Form Modal -->
        <div id="modal-npc-form" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="npc-form-title" class="font-bold">åˆ›å»ºNPC</h3>
                    <button onclick="document.getElementById('modal-npc-form').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <input type="hidden" id="npc-id">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">å…³è”è§’è‰²</label>
                        <select id="npc-char-select" class="setting-input">
                            <!-- Character options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">NPCåç§°</label>
                        <input type="text" id="npc-name" class="setting-input" placeholder="è¾“å…¥NPCåç§°">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">å¤´åƒ</label>
                        <div class="flex gap-2">
                            <input type="text" id="npc-avatar" class="setting-input flex-1" placeholder="è¾“å…¥å¤´åƒURL">
                            <button class="setting-btn secondary text-xs"
                                onclick="document.getElementById('npc-upload-file').click()">ä¸Šä¼ </button>
                        </div>
                        <input type="file" id="npc-upload-file" class="hidden"
                            onchange="WeChatUI.handleNPCAvatarFile(this)">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">äººè®¾æè¿°</label>
                        <textarea id="npc-personality" class="setting-input h-20"
                            placeholder="è¾“å…¥NPCçš„æ€§æ ¼ã€èƒŒæ™¯ç­‰æè¿°"></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="setting-btn secondary flex-1"
                        onclick="document.getElementById('modal-npc-form').classList.add('hidden')">å–æ¶ˆ</button>
                    <button class="setting-btn flex-1" onclick="WeChatUI.saveNPC()">ä¿å­˜</button>
                    <button class="setting-btn secondary flex-1" onclick="WeChatUI.addNPCToList()">åŠ å…¥åˆ—è¡¨</button>
                </div>
            </div>
        </div>

        <!-- Random NPC Modal -->
        <div id="modal-random-npc" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">éšæœºç”ŸæˆNPC</h3>
                    <button onclick="document.getElementById('modal-random-npc').classList.add('hidden')"
                        class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">å…³è”è§’è‰²</label>
                        <select id="random-npc-char-select" class="setting-input">
                            <!-- Character options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ç”Ÿæˆæ•°é‡</label>
                        <select id="random-npc-count" class="setting-input">
                            <option value="1">1ä¸ª</option>
                            <option value="2">2ä¸ª</option>
                            <option value="3">3ä¸ª</option>
                            <option value="5">5ä¸ª</option>
                            <option value="10">10ä¸ª</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">ç”Ÿæˆç±»å‹</label>
                        <select id="random-npc-type" class="setting-input">
                            <option value="friend">æœ‹å‹</option>
                            <option value="family">å®¶äºº</option>
                            <option value="colleague">åŒäº‹</option>
                            <option value="stranger">é™Œç”Ÿäºº</option>
                            <option value="random">éšæœºç±»å‹</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="setting-btn secondary flex-1"
                        onclick="document.getElementById('modal-random-npc').classList.add('hidden')">å–æ¶ˆ</button>
                    <button class="setting-btn flex-1" onclick="WeChatUI.generateRandomNPCs()">ç”Ÿæˆ</button>
                </div>
            </div>
        </div>








    </div>

    </div>
    </div>
















    </div>
    </div>

    <div id="app-search" class="app-window bg-gray-900 text-white">
        <div id="search-page-select" class="w-full h-full flex flex-col">
            <div class="app-header bg-gray-800/90 border-b border-gray-700">
                <button onclick="closeApp()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 text-gray-400"><i
                        class="fa-solid fa-chevron-left"></i></button>
                <div class="font-bold text-lg tracking-wide">æŸ¥æ‰‹æœº</div>
                <div class="w-8"></div>
            </div>
            <div class="p-4">
                <div class="text-sm text-gray-400 mb-4 text-center">é€‰æ‹©ä¸€ä¸ªè§’è‰²æŸ¥çœ‹ TA çš„æ‰‹æœº</div>
                <div id="search-char-list" class="grid grid-cols-4 gap-4">
                </div>
            </div>
        </div>

        <div id="search-page-desktop" class="w-full h-full flex flex-col hidden">
            <div class="app-header bg-white/10 backdrop-blur-lg border-b border-white/20 text-white flex items-center">
                <button onclick="SearchPhoneUI.backToSelect()"
                    class="w-8 h-8 flex items-center justify-center rounded-full bg-white/20 hover:bg-white/30 transition-all"><i
                        class="fa-solid fa-chevron-left"></i></button>
                <div class="flex-1 text-center font-bold text-lg" id="search-desktop-title">æ‰‹æœº</div>
                <div class="flex gap-2">
                    <button onclick="SearchPhoneUI.generateAllData()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-500/30 hover:bg-blue-500/50 transition-all"
                        title="ç”Ÿæˆæ‰€æœ‰æ•°æ®"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                    <button onclick="SearchPhoneUI.clearAllData()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-red-500/30 hover:bg-red-500/50 transition-all"
                        title="æ¸…ç©ºæ‰€æœ‰æ•°æ®"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="SearchPhoneUI.openBeautyManager()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-500/30 hover:bg-purple-500/50 transition-all"
                        title="ç¾åŒ–ç®¡ç†"><i class="fa-solid fa-palette"></i></button>
                </div>
            </div>

            <div class="flex-1 p-4 overflow-y-auto backdrop-blur-sm bg-white/5">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="col-span-1 rounded-2xl bg-white/20 backdrop-blur-lg border border-white/30 overflow-hidden relative aspect-square transition-all cursor-pointer"
                        onclick="SearchPhoneUI.openWidgetSettings(1)">
                        <div id="search-widget-overlay-1"
                            class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300">
                            <i class="fa-solid fa-image text-3xl text-white/50"></i>
                        </div>
                        <div id="search-widget-img-1" class="absolute inset-0 w-full h-full pointer-events-none">
                        </div>
                    </div>
                    <div class="col-span-1 rounded-2xl bg-white/20 backdrop-blur-lg border border-white/30 overflow-hidden relative aspect-square transition-all cursor-pointer"
                        onclick="SearchPhoneUI.openWidgetSettings(2)">
                        <div id="search-widget-overlay-2"
                            class="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300">
                            <i class="fa-solid fa-image text-3xl text-white/50"></i>
                        </div>
                        <div id="search-widget-img-2" class="absolute inset-0 w-full h-full pointer-events-none">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-y-6 gap-x-4">
                    <div onclick="SearchPhoneUI.openSubApp('wechat')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-3xl shadow-sm">
                            <i class="fa-brands fa-weixin text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">å¾®ä¿¡</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('wallet')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-wallet text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">é’±åŒ…</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('browser')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-brands fa-chrome text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">æµè§ˆå™¨</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('shopping')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-bag-shopping text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">è´­ç‰©</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('diary')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-book text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">æ—¥è®°</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('notes')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-note-sticky text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">è®°äº‹</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('weibo')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-3xl shadow-sm">
                            <i class="fa-brands fa-weibo text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">å¾®åš</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('footprint')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-location-dot text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">è¶³è¿¹</span>
                    </div>
                    <div onclick="SearchPhoneUI.openSubApp('schedule')"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-regular fa-calendar-check text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">æ—¥ç¨‹</span>
                    </div>
                    <div onclick="SearchPhoneUI.openBeautyManager()"
                        class="flex flex-col items-center gap-1 cursor-pointer active:scale-95 transition-all hover:scale-105">
                        <div
                            class="w-14 h-14 rounded-2xl bg-[#d0e6fa] border border-white/40 flex items-center justify-center text-2xl shadow-sm">
                            <i class="fa-solid fa-palette text-[#475569]"></i>
                        </div><span class="text-xs text-white/90 font-medium">æ¡Œé¢ç¾åŒ–</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-phone-subapp"
            class="absolute inset-0 bg-gradient-to-br from-blue-50 to-purple-50 text-gray-800 z-50 flex flex-col translate-y-full transition-transform duration-300 pointer-events-none">
            <div
                class="h-14 flex items-center justify-between px-4 border-b border-blue-100 bg-white/80 backdrop-blur-sm">
                <button onclick="SearchPhoneUI.closeSubApp()"
                    class="text-blue-500 hover:text-blue-700 transition-colors"><i
                        class="fa-solid fa-chevron-down"></i></button>
                <span class="font-bold text-lg text-blue-700" id="subapp-title">åº”ç”¨å</span>
                <div class="flex gap-3">
                    <button onclick="SearchPhoneUI.clearSubAppData()"
                        class="text-red-500 hover:text-red-700 transition-colors"><i
                            class="fa-solid fa-trash"></i></button>
                    <button onclick="SearchPhoneUI.generateSubAppData()"
                        class="text-blue-500 font-bold animate-pulse hover:text-blue-700 transition-colors"
                        id="btn-subapp-gen"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
                </div>
            </div>
            <div id="subapp-content" class="flex-1 overflow-y-auto p-4">
            </div>
        </div>

        <!-- ç¾åŒ–ç®¡ç†æ¨¡æ€æ¡† -->
        <div id="modal-phone-beauty"
            class="absolute inset-0 bg-white text-gray-800 z-50 flex flex-col translate-y-full transition-transform duration-300 pointer-events-none">
            <div class="h-14 flex items-center justify-between px-4 border-b border-gray-200 bg-white">
                <button onclick="SearchPhoneUI.closeBeautyManager()" class="text-gray-500"><i
                        class="fa-solid fa-chevron-down"></i></button>
                <span class="font-bold text-lg">ç¾åŒ–ç®¡ç†</span>
                <div class="w-8"></div>
            </div>
            <div id="beauty-content" class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div class="space-y-6">
                    <!-- å£çº¸è®¾ç½® -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-bold text-lg mb-3">å£çº¸è®¾ç½®</h3>
                        <div class="space-y-3">
                            <div class="h-32 rounded-lg bg-gray-200 overflow-hidden relative" id="wallpaper-preview">
                                <span class="absolute inset-0 flex items-center justify-center text-gray-400">é¢„è§ˆ</span>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="wallpaper-url" placeholder="å£çº¸ URL" class="setting-input flex-1">
                                <button onclick="SearchPhoneUI.applyWallpaperFromUrl()"
                                    class="setting-btn w-auto whitespace-nowrap">åº”ç”¨</button>
                            </div>
                            <div class="flex gap-2">
                                <input type="file" id="wallpaper-upload" accept="image/*" class="hidden"
                                    onchange="SearchPhoneUI.handleWallpaperUpload(this)">
                                <button onclick="document.getElementById('wallpaper-upload').click()"
                                    class="setting-btn secondary flex-1">æœ¬åœ°ä¸Šä¼ </button>
                                <button onclick="SearchPhoneUI.resetWallpaper()"
                                    class="setting-btn secondary bg-red-50 text-red-500">æ¸…é™¤å£çº¸</button>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸–ç•Œä¹¦ç»‘å®š -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-bold text-lg mb-3">ä¸–ç•Œä¹¦ç»‘å®š</h3>
                        <div class="text-xs text-gray-500 mb-2 leading-relaxed">ç»‘å®šä¸–ç•Œä¹¦å¯è®©æŸ¥æ‰‹æœºç”Ÿæˆçš„å…¨æœºå†…å®¹æŸ“ä¸Šç‰¹å®šçš„æ–‡é£æˆ–èƒŒæ™¯è®¾å®šã€‚æ”¯æŒå¤šé€‰æ··æ­ã€‚
                        </div>
                        <div id="phone-worldbook-list"
                            class="flex flex-col gap-1 max-h-40 overflow-y-auto border border-gray-100 rounded-lg p-2 bg-gray-50/50">
                            <!-- Checkboxes injected by JS -->
                            <div class="text-xs text-gray-400 text-center py-2">æš‚æ— ä¸–ç•Œä¹¦</div>
                        </div>
                    </div>

                    <!-- å›¾æ ‡è®¾ç½® -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-bold text-lg mb-3">å›¾æ ‡è®¾ç½®</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-wechat">
                                    <i class="fa-brands fa-weixin text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('wechat')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('wechat')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">å¾®ä¿¡</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-wallet">
                                    <i class="fa-solid fa-wallet text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('wallet')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('wallet')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">é’±åŒ…</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-browser">
                                    <i class="fa-brands fa-chrome text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('browser')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('browser')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">æµè§ˆå™¨</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-shopping">
                                    <i class="fa-solid fa-bag-shopping text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('shopping')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('shopping')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">è´­ç‰©</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-diary">
                                    <i class="fa-solid fa-book text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('diary')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('diary')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">æ—¥è®°</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-notes">
                                    <i class="fa-solid fa-note-sticky text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('notes')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('notes')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">è®°äº‹</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-weibo">
                                    <i class="fa-brands fa-weibo text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('weibo')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('weibo')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">å¾®åš</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-footprint">
                                    <i class="fa-solid fa-location-dot text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('footprint')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button
                                        onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('footprint')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">è¶³è¿¹</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 group relative">
                                <div class="w-16 h-16 rounded-xl bg-gray-200 flex items-center justify-center relative overflow-hidden"
                                    id="icon-preview-gallery">
                                    <i class="fa-solid fa-images text-2xl"></i>
                                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity cursor-pointer"
                                        onclick="SearchPhoneUI.uploadSingleIcon('gallery')">
                                        <i class="fa-solid fa-upload text-white"></i>
                                    </div>
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.resetSingleIcon('gallery')"
                                        class="absolute top-0 right-0 p-1 bg-red-500 text-white text-[8px] rounded-bl-lg opacity-0 group-hover:opacity-100 transition-opacity"><i
                                            class="fa-solid fa-xmark"></i></button>
                                </div>
                                <span class="text-xs">ç›¸å†Œ</span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            <div class="col-span-2">
                                <input type="file" id="icon-upload" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('icon-upload').click()"
                                    class="setting-btn secondary w-full">æ‰¹é‡ä¸Šä¼ å›¾æ ‡ (æ ¹æ®æ–‡ä»¶ååŒ¹é…)</button>
                            </div>
                            <button onclick="SearchPhoneUI.resetIcons()"
                                class="setting-btn secondary bg-red-50 text-red-500">æ¸…é™¤æ‰€æœ‰å›¾æ ‡</button>
                            <input type="file" id="single-icon-upload" accept="image/*" class="hidden">
                        </div>
                    </div>

                    <!-- æ¡Œé¢å°ç»„ä»¶è®¾ç½® -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-bold text-lg mb-3">æ¡Œé¢å°ç»„ä»¶</h3>
                        <div class="space-y-4">
                            <!-- æ—¥ç¨‹ç»„ä»¶ -->
                            <div>
                                <h4 class="font-medium mb-2">æ—¥ç¨‹ç»„ä»¶</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="schedule-bg-url" placeholder="èƒŒæ™¯å›¾ URL"
                                        class="flex-1 p-2 border border-gray-300 rounded-lg">
                                    <button onclick="SearchPhoneUI.applyWidgetBg('schedule')"
                                        class="setting-btn">åº”ç”¨</button>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <input type="file" id="schedule-bg-upload" accept="image/*" class="hidden"
                                        onchange="SearchPhoneUI.handleWidgetBgUpload('schedule', this)">
                                    <button onclick="document.getElementById('schedule-bg-upload').click()"
                                        class="setting-btn secondary flex-1">æœ¬åœ°ä¸Šä¼ </button>
                                    <button onclick="SearchPhoneUI.resetWidgetBg('schedule')"
                                        class="setting-btn secondary bg-red-50 text-red-500">æ¸…é™¤</button>
                                </div>
                            </div>

                            <!-- ç›¸å†Œç»„ä»¶ -->
                            <div>
                                <h4 class="font-medium mb-2">ç›¸å†Œç»„ä»¶</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="gallery-bg-url" placeholder="èƒŒæ™¯å›¾ URL"
                                        class="flex-1 p-2 border border-gray-300 rounded-lg">
                                    <button onclick="SearchPhoneUI.applyWidgetBg('gallery')"
                                        class="setting-btn">åº”ç”¨</button>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <input type="file" id="gallery-bg-upload" accept="image/*" class="hidden"
                                        onchange="SearchPhoneUI.handleWidgetBgUpload('gallery', this)">
                                    <button onclick="document.getElementById('gallery-bg-upload').click()"
                                        class="setting-btn secondary flex-1">æœ¬åœ°ä¸Šä¼ </button>
                                    <button onclick="SearchPhoneUI.resetWidgetBg('gallery')"
                                        class="setting-btn secondary bg-red-50 text-red-500">æ¸…é™¤</button>
                                </div>
                            </div>

                            <!-- æ–‡å­—é¢œè‰²è®¾ç½® -->
                            <div>
                                <h4 class="font-medium mb-2">æ–‡å­—é¢œè‰²</h4>
                                <div class="flex gap-2">
                                    <input type="color" id="widget-text-color" value="#ffffff"
                                        class="w-10 h-10 p-0 border border-gray-300 rounded-lg">
                                    <button onclick="SearchPhoneUI.applyWidgetTextColor()"
                                        class="setting-btn">åº”ç”¨</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨å±€ API è°ƒåº¦ä¸­å¿ƒ (äº¤é€šæŒ‡æŒ¥) - ç§»åŠ¨ç«¯ä¼˜åŒ–ç‰ˆ ---
        window.APIQueue = {
            queue: [],
            isProcessing: false,
            // æäº¤ä»»åŠ¡ï¼šè¿”å›ä¸€ä¸ª Promiseï¼Œè®©è°ƒç”¨è€…å¯ä»¥ await
            enqueue: function (taskFn) {
                console.log('[APIQueue] æ–°ä»»åŠ¡å…¥é˜Ÿï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦:', this.queue.length);
                return new Promise((resolve, reject) => {
                    this.queue.push({
                        task: taskFn,
                        resolve: resolve,
                        reject: reject
                    });
                    this.process();
                });
            },
            // å¤„ç†é˜Ÿåˆ—
            process: async function () {
                if (this.isProcessing) {
                    console.log('[APIQueue] æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡');
                    return;
                }
                if (this.queue.length === 0) {
                    console.log('[APIQueue] é˜Ÿåˆ—ä¸ºç©º');
                    return;
                }

                console.log('[APIQueue] å¼€å§‹å¤„ç†ï¼Œé˜Ÿåˆ—é•¿åº¦:', this.queue.length);
                this.isProcessing = true;
                const item = this.queue.shift(); // å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡

                // æ›´æ–°çŠ¶æ€æ æ˜¾ç¤ºå¿™ç¢Œ
                const statusEl = document.getElementById('chat-online-status');

                if (statusEl) {
                    statusEl.textContent = `æ€è€ƒä¸­ (æ’é˜Ÿ${this.queue.length})...`;
                    statusEl.style.color = '#eab308'; // é»„è‰²å¿™ç¢Œ
                }

                // æ›´æ–°ç”ŸæˆæŒ‰é’®ä¸ºåœæ­¢æŒ‰é’®
                this.updateGeneratingUI(true);

                try {
                    // æ‰§è¡Œä»»åŠ¡ (è¿™é‡Œæ˜¯çœŸæ­£çš„ fetch è¯·æ±‚)
                    console.log('[APIQueue] æ‰§è¡Œä»»åŠ¡...');
                    const result = await item.task();
                    console.log('[APIQueue] ä»»åŠ¡æˆåŠŸ');
                    item.resolve(result); // å‘Šè¯‰è°ƒç”¨è€…ä»»åŠ¡å®Œæˆäº†
                } catch (error) {
                    console.error('[APIQueue] ä»»åŠ¡å¤±è´¥:', error);
                    item.reject(error); // å‘Šè¯‰è°ƒç”¨è€…å‡ºé”™äº†
                } finally {
                    // ã€å…³é”®ä¿®å¤ã€‘ç«‹å³é‡ç½®çŠ¶æ€ï¼Œä¸ä¾èµ–setTimeout
                    this.isProcessing = false;
                    this.updateGeneratingUI(false); // æ¢å¤æŒ‰é’®çŠ¶æ€
                    console.log('[APIQueue] isProcessing å·²é‡ç½®ä¸º false');

                    // å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œæ¢å¤çŠ¶æ€æ 
                    if (this.queue.length === 0 && statusEl) {
                        statusEl.textContent = 'åœ¨çº¿';
                        statusEl.style.color = '#10b981';
                    }

                    // ã€ç§»åŠ¨ç«¯ä¼˜åŒ–ã€‘ç¼©çŸ­å»¶è¿Ÿåˆ°200msï¼Œæé«˜å“åº”é€Ÿåº¦
                    setTimeout(() => {
                        console.log('[APIQueue] ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡');
                        this.process(); // é€’å½’å¤„ç†ä¸‹ä¸€ä¸ª
                    }, 200); // 200ms å†·å´æ—¶é—´ï¼ˆåŸ500msï¼‰
                }
            },

            // ã€æ–°å¢ã€‘æ‰“æ–­åŠŸèƒ½ï¼šå–æ¶ˆå½“å‰è¯·æ±‚å¹¶æ¸…ç©ºé˜Ÿåˆ—
            interrupt: function () {
                console.log('[APIQueue] ğŸš¨ ç”¨æˆ·è§¦å‘æ‰“æ–­ï¼');

                // 1. æ¸…ç©ºç­‰å¾…é˜Ÿåˆ—
                console.log(`[APIQueue] æ¸…ç©ºå¾…å¤„ç†ä»»åŠ¡: ${this.queue.length} ä¸ª`);
                this.queue.forEach(item => item.reject(new Error('User Interrupted')));
                this.queue = [];

                // 2. å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
                if (window.currentAIAbortController) {
                    console.log('[APIQueue] å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ fetch è¯·æ±‚...');
                    window.currentAIAbortController.abort();
                    window.currentAIAbortController = null;
                }

                // 3. é‡ç½®çŠ¶æ€
                this.isProcessing = false;
                window.isAIGenerating = false;

                // 4. UI åé¦ˆ
                const statusEl = document.getElementById('chat-online-status');
                if (statusEl) {
                    statusEl.textContent = 'å·²æ‰“æ–­';
                    statusEl.style.color = '#ef4444'; // çº¢è‰²
                    setTimeout(() => {
                        statusEl.textContent = 'åœ¨çº¿';
                        statusEl.style.color = '#10b981';
                    }, 1500);
                }

                // 5. ç§»é™¤åŠ è½½åŠ¨ç”»æ°”æ³¡ & è¾“å…¥ä¸­çŠ¶æ€
                const bubbles = document.querySelectorAll('.loading-bubble');
                bubbles.forEach(el => el.remove());

                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.classList.add('hidden');

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                this.updateGeneratingUI(false);
            },

            // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€ (Magic <-> Stop)
            updateGeneratingUI: function (isWorking) {
                const btn = document.getElementById('generate-btn');
                if (!btn) return;

                if (isWorking) {
                    // å˜ä¸ºåœæ­¢æŒ‰é’®
                    btn.innerHTML = '<i class="fa-solid fa-square text-red-500 text-xs"></i>';
                    btn.className = "w-8 h-8 rounded-full bg-red-100/80 backdrop-blur-sm border border-red-200 flex items-center justify-center hover:bg-red-200/80 transition-all duration-200";
                    btn.title = "åœæ­¢ç”Ÿæˆ";
                    // æ·»åŠ å‘¼å¸åŠ¨ç”»
                    btn.classList.add('animate-pulse');
                } else {
                    // æ¢å¤é­”æ³•æ£’
                    btn.innerHTML = '<i class="fa-solid fa-magic text-xs"></i>';
                    btn.className = "w-8 h-8 rounded-full bg-blue-200/80 backdrop-blur-sm border border-blue-300/50 flex items-center justify-center text-blue-700 hover:bg-blue-300/80 transition-all duration-200";
                    btn.title = "ç”Ÿæˆ";
                    btn.classList.remove('animate-pulse');
                }
            },

            // ã€æ–°å¢ã€‘å¼ºåˆ¶é‡ç½®çŠ¶æ€ï¼ˆç”¨äºç´§æ€¥æƒ…å†µï¼‰
            reset: function () {
                console.warn('[APIQueue] å¼ºåˆ¶é‡ç½®çŠ¶æ€');
                this.isProcessing = false;
                this.queue = [];
                const statusEl = document.getElementById('chat-online-status');
                if (statusEl) {
                    statusEl.textContent = 'åœ¨çº¿';
                    statusEl.style.color = '#10b981';
                }
            }
        };


        // ã€é‡è¦ã€‘æ‰€æœ‰APIè°ƒç”¨ç»Ÿä¸€ä½¿ç”¨ APIQueueï¼Œé¿å…å¹¶å‘å†²çª
        // GenQueue å·²ç§»é™¤ï¼Œæ‰€æœ‰ç”ŸæˆåŠŸèƒ½ï¼ˆæœ‹å‹åœˆã€å¾®åšç­‰ï¼‰ä¹Ÿä½¿ç”¨ APIQueue
        // è¿™æ ·ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªAPIè¯·æ±‚åœ¨æ‰§è¡Œ


        // 3. ç³»ç»Ÿæ—¥å¿—æ”¶é›†å™¨
        window.SystemLogger = {
            logs: [],
            maxLogs: 1000,
            enabled: true,
            storageKey: 'system_logs',

            // åˆå§‹åŒ–ï¼šæ‹¦æˆªconsoleæ–¹æ³•
            init: function () {
                // ä»localStorageåŠ è½½å†å²æ—¥å¿—
                this.load();

                // ä¿å­˜åŸå§‹consoleæ–¹æ³•
                const originalConsole = {
                    log: console.log.bind(console),
                    error: console.error.bind(console),
                    warn: console.warn.bind(console),
                    info: console.info.bind(console)
                };

                // æ‹¦æˆªconsole.log
                console.log = (...args) => {
                    if (this.enabled) this.add('info', args);
                    originalConsole.log(...args);
                };

                // æ‹¦æˆªconsole.error
                console.error = (...args) => {
                    if (this.enabled) this.add('error', args);
                    originalConsole.error(...args);
                };

                // æ‹¦æˆªconsole.warn
                console.warn = (...args) => {
                    if (this.enabled) this.add('warn', args);
                    originalConsole.warn(...args);
                };

                // æ‹¦æˆªconsole.info
                console.info = (...args) => {
                    if (this.enabled) this.add('info', args);
                    originalConsole.info(...args);
                };

                // æ‹¦æˆªå…¨å±€é”™è¯¯
                window.addEventListener('error', (event) => {
                    this.add('error', [
                        `Uncaught Error: ${event.message}`,
                        `at ${event.filename}:${event.lineno}:${event.colno}`
                    ]);
                });

                // æ‹¦æˆªæœªå¤„ç†çš„Promiseé”™è¯¯
                window.addEventListener('unhandledrejection', (event) => {
                    this.add('error', [
                        'Unhandled Promise Rejection:',
                        event.reason
                    ]);
                });

                console.info('[SystemLogger] æ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ–');
            },

            // æ·»åŠ æ—¥å¿—æ¡ç›®
            add: function (level, messages) {
                const entry = {
                    id: Date.now() + Math.random(),
                    timestamp: Date.now(),
                    level: level,
                    messages: messages.map(m => {
                        if (typeof m === 'object') {
                            try {
                                return JSON.stringify(m, null, 2);
                            } catch (e) {
                                return String(m);
                            }
                        }
                        return String(m);
                    }),
                    stack: this.getStack()
                };

                this.logs.push(entry);

                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }

                // å®šæœŸä¿å­˜ï¼ˆæ¯10æ¡ï¼‰
                if (this.logs.length % 10 === 0) {
                    this.save();
                }
            },

            // è·å–è°ƒç”¨å †æ ˆ
            getStack: function () {
                try {
                    const stack = new Error().stack;
                    if (stack) {
                        const lines = stack.split('\n').slice(3, 6); // å–3è¡Œå †æ ˆ
                        return lines.join('\n');
                    }
                } catch (e) {
                    return '';
                }
                return '';
            },

            // ä¿å­˜åˆ°localStorage
            save: function () {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.logs));
                } catch (e) {
                    console.warn('[SystemLogger] ä¿å­˜å¤±è´¥:', e);
                }
            },

            // ä»localStorageåŠ è½½
            load: function () {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    if (data) {
                        this.logs = JSON.parse(data);
                    }
                } catch (e) {
                    this.logs = [];
                }
            },

            // æ¸…ç©ºæ—¥å¿—
            clear: function () {
                this.logs = [];
                this.save();
            },

            // å¯¼å‡ºæ—¥å¿—
            export: function (format = 'json') {
                if (format === 'json') {
                    return JSON.stringify(this.logs, null, 2);
                } else if (format === 'text') {
                    return this.logs.map(log => {
                        const time = new Date(log.timestamp).toLocaleString();
                        const level = log.level.toUpperCase().padEnd(7);
                        const msg = log.messages.join(' ');
                        return `[${time}] [${level}] ${msg}`;
                    }).join('\n');
                }
            },

            // è·å–è¿‡æ»¤åçš„æ—¥å¿—
            filter: function (options = {}) {
                let filtered = [...this.logs];

                // æŒ‰çº§åˆ«è¿‡æ»¤
                if (options.level) {
                    filtered = filtered.filter(log => log.level === options.level);
                }

                // æŒ‰å…³é”®è¯è¿‡æ»¤
                if (options.keyword) {
                    const kw = options.keyword.toLowerCase();
                    filtered = filtered.filter(log =>
                        log.messages.some(m => m.toLowerCase().includes(kw))
                    );
                }

                // æŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤
                if (options.startTime) {
                    filtered = filtered.filter(log => log.timestamp >= options.startTime);
                }
                if (options.endTime) {
                    filtered = filtered.filter(log => log.timestamp <= options.endTime);
                }

                return filtered;
            }
        };

        // ç«‹å³åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
        //         SystemLogger.init();

        // ========================================
        // ç»Ÿä¸€æ¨¡æ€æ¡†ç®¡ç†å™¨ (ModalManager)
        // ========================================
        window.ModalManager = {
            // æ‰“å¼€æ¨¡æ€æ¡†
            open: function (id) {
                const modal = document.getElementById(id);
                if (!modal) {
                    console.warn(`[ModalManager] Modal not found: ${id}`);
                    return false;
                }

                console.log(`[ModalManager] æ‰“å¼€å‰çš„classList:`, modal.classList.toString());
                console.log(`[ModalManager] æ‰“å¼€å‰çš„display:`, modal.style.display);

                // ç§»é™¤hiddenç±»
                modal.classList.remove('hidden');
                modal.classList.add('active');

                // å¼ºåˆ¶è®¾ç½®displayå±æ€§
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';

                // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
                if (modal.classList.contains('modal-overlay')) {
                    document.body.style.overflow = 'hidden';
                }

                console.log(`[ModalManager] æ‰“å¼€åçš„classList:`, modal.classList.toString());
                console.log(`[ModalManager] æ‰“å¼€åçš„display:`, modal.style.display);
                console.log(`[ModalManager] Opened: ${id}`);
                return true;
            },

            // å…³é—­æ¨¡æ€æ¡†
            close: function (id) {
                const modal = document.getElementById(id);
                if (!modal) {
                    console.warn(`[ModalManager] Modal not found: ${id}`);
                    return false;
                }

                // æ·»åŠ hiddenç±»ï¼Œç§»é™¤activeç±»
                modal.classList.add('hidden');
                modal.classList.remove('active');

                // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                document.body.style.overflow = '';

                console.log(`[ModalManager] Closed: ${id}`);
                return true;
            },

            // åˆ‡æ¢æ¨¡æ€æ¡†çŠ¶æ€
            toggle: function (id) {
                const modal = document.getElementById(id);
                if (!modal) {
                    console.warn(`[ModalManager] Modal not found: ${id}`);
                    return false;
                }

                if (modal.classList.contains('hidden')) {
                    this.open(id);
                } else {
                    this.close(id);
                }
                return true;
            },

            // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
            closeAll: function () {
                const modals = document.querySelectorAll('.modal-overlay, .sub-view');
                modals.forEach(modal => {
                    modal.classList.add('hidden');
                    modal.classList.remove('active');
                });
                document.body.style.overflow = '';
                console.log('[ModalManager] Closed all modals');
            },

            // æ£€æŸ¥æ¨¡æ€æ¡†æ˜¯å¦æ‰“å¼€
            isOpen: function (id) {
                const modal = document.getElementById(id);
                if (!modal) return false;
                return !modal.classList.contains('hidden');
            }
        };

        // 4. ç³»ç»Ÿæ—¥å¿—UIç®¡ç†å™¨
        window.AppStorage = {
            _cache: {},
            get: function (k, d) {
                if (this._cache[k] !== undefined) return this._cache[k];
                try {
                    const raw = localStorage.getItem(k);
                    if (!raw) return d;
                    let val;
                    if (raw.startsWith('LZ|')) {
                        if (typeof LZString !== 'undefined') {
                            const decompressed = LZString.decompressFromUTF16(raw.substring(3));
                            if (decompressed) val = JSON.parse(decompressed);
                        } else {
                            console.error('LZString missing');
                            return d;
                        }
                    } else {
                        val = JSON.parse(raw);
                    }
                    if (val !== undefined) this._cache[k] = val;
                    return val !== undefined ? val : d;
                } catch (e) {
                    console.error('AppStorage Read Error', e);
                    return d;
                }
            },
            set: function (k, v) {
                this._cache[k] = v;
                try {
                    const str = JSON.stringify(v);
                    if (typeof LZString !== 'undefined' && str.length > 500) {
                        localStorage.setItem(k, 'LZ|' + LZString.compressToUTF16(str));
                    } else {
                        localStorage.setItem(k, str);
                    }
                } catch (e) {
                    if (e.name === 'QuotaExceededError') alert('STORAGE FULL! Please delete old chats.');
                }
            },
            clearCache: function () { this._cache = {}; }
        };

        window.SystemLoggerUI = {
            autoScroll: true,
            expandedLogs: new Set(), // è®°å½•å“ªäº›æ—¥å¿—æ˜¯å±•å¼€çŠ¶æ€çš„

            // æ¸²æŸ“æ—¥å¿— (Fixed)
            render: function () {
                const container = document.getElementById('logs-container');
                if (!container) return;

                const levelFilter = document.getElementById('log-level-filter')?.value;
                const keywordFilter = document.getElementById('log-keyword-filter')?.value ? document.getElementById('log-keyword-filter').value.toLowerCase() : '';

                try {
                    const filtered = SystemLogger.filter({
                        level: levelFilter || undefined,
                        keyword: keywordFilter || undefined
                    });

                    if (filtered.length === 0) {
                        container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æš‚æ— æ—¥å¿—</div>';
                        return;
                    }

                    const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                    container.innerHTML = filtered.map((log) => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        const date = new Date(log.timestamp).toLocaleDateString();
                        const levelColors = { error: '#f48771', warn: '#dcdcaa', info: '#4fc1ff' };
                        const color = levelColors[log.level] || '#ccc';
                        const level = log.level.toUpperCase().padEnd(7, ' ');
                        const messagePreview = (log.messages[0] || '').toString();
                        const hasMore = log.messages.length > 1 || log.stack || messagePreview.length > 100;
                        const logId = log.id || (log.timestamp + Math.random());
                        const isExpanded = this.expandedLogs.has(logId);

                        return `
                            <div data-log-id="${logId}" style="padding: 4px 0; border-bottom: 1px solid #2d2d30; cursor: ${hasMore ? 'pointer' : 'default'};"
                                 ${hasMore ? 'onclick="SystemLoggerUI.toggleDetails(\'' + logId + '\', this)"' : ''}>
                                <div style="display: flex; align-items: flex-start; gap: 8px;">
                                    <span style="color: #666; font-size: 10px; white-space: nowrap;">${time}</span>
                                    <span style="color: ${color}; font-weight: bold; white-space: nowrap;">[${level}]</span>
                                    <span style="color: #ccc; flex: 1; word-break: break-all;">${this.escapeHtml(messagePreview)}</span>
                                    ${hasMore ? `<span style="color: #666; font-size: 10px;">${isExpanded ? '' : ''}</span>` : ''}
                                </div>
                                ${hasMore ? `
                                <div class="log-details" style="display: ${isExpanded ? 'block' : 'none'}; margin-top: 8px; padding-left: 8px; color: #999; font-size: 11px; background: #1a1a1a; padding: 8px; border-radius: 4px; margin-right: 8px;">
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: #666;">Time:</span> <span style="color: #aaa;">${date} ${time}</span>
                                    </div>
                                    ${log.messages.length > 0 ? `
                                        <div style="margin-bottom: 8px;">
                                            <div style="color: #666; margin-bottom: 4px;">Message:</div>
                                            <pre style="color: #ccc; margin: 0; white-space: pre-wrap; word-break: break-all;">${log.messages.map(m => this.escapeHtml(m)).join('\n')}</pre>
                                        </div>
                                    ` : ''}
                                    ${log.stack ? `
                                        <div>
                                            <div style="color: #666; margin-bottom: 4px;">Stack:</div>
                                            <pre style="color: #888; margin: 0; font-size: 10px; white-space: pre-wrap; line-height: 1.4;">${this.escapeHtml(log.stack)}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');

                    if (this.autoScroll && isAtBottom) {
                        container.scrollTop = container.scrollHeight;
                    }
                } catch (e) {
                    console.error('Render error:', e);
                }
            },

            // è½¬ä¹‰HTML
            escapeHtml: function (text) {
                const div = document.createElement('div');
                div.textContent = String(text);
                return div.innerHTML;
            },

            // åˆ‡æ¢è¯¦ç»†ä¿¡æ¯
            toggleDetails: function (logId, element) {
                const details = element.querySelector('.log-details');
                const arrow = element.querySelector('span:last-child');
                if (details) {
                    const isHidden = details.style.display === 'none';

                    // æ›´æ–°å±•å¼€çŠ¶æ€
                    if (isHidden) {
                        this.expandedLogs.add(logId);
                        details.style.display = 'block';
                        if (arrow) arrow.textContent = 'â–²';
                    } else {
                        this.expandedLogs.delete(logId);
                        details.style.display = 'none';
                        if (arrow) arrow.textContent = 'â–¼';
                    }
                }
            },

            // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
            toggleAutoScroll: function () {
                this.autoScroll = !this.autoScroll;
                const btn = document.getElementById('auto-scroll-btn');
                if (btn) {
                    btn.textContent = `è‡ªåŠ¨æ»šåŠ¨: ${this.autoScroll ? 'ON' : 'OFF'}`;
                    btn.style.background = this.autoScroll ? '#0e639c' : '#555';
                }
            },

            // å¯¼å‡ºæ—¥å¿—
            export: function () {
                const data = SystemLogger.export('json');
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_logs_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                console.info('[SystemLoggerUI] æ—¥å¿—å·²å¯¼å‡º');
            },

            // æ¸…ç©ºæ—¥å¿—
            clearLogs: function () {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                    SystemLogger.clear();
                    this.render();
                    console.info('[SystemLoggerUI] æ—¥å¿—å·²æ¸…ç©º');
                }
            },

            // æ‰“å¼€æ—¥å¿—åº”ç”¨æ—¶åˆ·æ–°
            open: function () {
                this.render();
                // å®šæœŸåˆ·æ–°ï¼ˆæ¯2ç§’ï¼‰
                if (!this.refreshInterval) {
                    this.refreshInterval = setInterval(() => {
                        if (document.getElementById('app-syslogs').classList.contains('active')) {
                            this.render();
                        }
                    }, 2000);
                }
            }
        };

        // Utils
        window.Utils = {
            // ç¡®è®¤å¼¹çª—ç›¸å…³å˜é‡
            confirmCallback: null,

            // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
            showConfirm: (title, message, callback) => {
                const modal = document.getElementById('modal-confirm');
                const titleEl = document.getElementById('confirm-title');
                const messageEl = document.getElementById('confirm-message');

                titleEl.textContent = title || 'ç¡®è®¤æ“ä½œ';
                messageEl.textContent = message;
                window.Utils.confirmCallback = callback;

                modal.classList.remove('hidden');
            },

            // ç¡®è®¤æ“ä½œ
            confirmConfirm: () => {
                const modal = document.getElementById('modal-confirm');
                modal.classList.add('hidden');

                if (window.Utils.confirmCallback) {
                    window.Utils.confirmCallback(true);
                    window.Utils.confirmCallback = null;
                }
            },

            // å–æ¶ˆæ“ä½œ
            cancelConfirm: () => {
                const modal = document.getElementById('modal-confirm');
                modal.classList.add('hidden');

                if (window.Utils.confirmCallback) {
                    window.Utils.confirmCallback(false);
                    window.Utils.confirmCallback = null;
                }
            },

            // --- æ–°å¢ Prompt æ”¯æŒ ---
            promptCallback: null,

            showPrompt: (title, placeholder, callback) => {
                const modal = document.getElementById('modal-param-prompt');
                if (!modal) {
                    // å¦‚æœæ²¡æœ‰è¿™ä¸ªæ¨¡æ€æ¡†ï¼Œå°è¯• fallback åˆ° prompt()
                    const val = prompt(title, '');
                    if (val !== null) callback(val);
                    return;
                }
                document.getElementById('param-prompt-title').textContent = title;
                const input = document.getElementById('param-prompt-input');
                input.value = '';
                input.placeholder = placeholder || '';
                input.placeholder = placeholder || '';
                modal.classList.remove('hidden');
                modal.classList.add('show');
                input.focus();

                window.Utils.promptCallback = callback;

                // ç»‘å®šå›è½¦ç¡®è®¤
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') window.Utils.confirmPrompt();
                };
            },

            confirmPrompt: () => {
                const modal = document.getElementById('modal-param-prompt');
                const input = document.getElementById('param-prompt-input');
                const val = input.value;
                modal.classList.remove('show');
                modal.classList.add('hidden');

                if (window.Utils.promptCallback) {
                    window.Utils.promptCallback(val);
                    window.Utils.promptCallback = null;
                }
            },

            cancelPrompt: () => {
                const modal = document.getElementById('modal-param-prompt');
                modal.classList.add('hidden');

                if (window.Utils.promptCallback) {
                    window.Utils.promptCallback(null);
                    window.Utils.promptCallback = null;
                }
            },

            // --- æ–°å¢ï¼šæ”¯æŒ await çš„å¼‚æ­¥ Prompt ---
            showPromptAsync: (title, placeholder) => {
                return new Promise((resolve) => {
                    Utils.showPrompt(title, placeholder, (val) => {
                        resolve(val);
                    });
                });
            },

            compressImage: (file, maxWidth = 512, quality = null) => {
                // å¦‚æœæ²¡æœ‰ä¼ å…¥è´¨é‡å‚æ•°ï¼Œä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å‹ç¼©è´¨é‡ï¼Œé»˜è®¤0.7
                const userQuality = quality !== null ? quality : AppStorage.get('image_compress_quality', 0.7);

                return new Promise((resolve, reject) => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯GIFå›¾ç‰‡
                    const isGif = file.type === 'image/gif';

                    if (isGif) {
                        // GIFå›¾ç‰‡ç›´æ¥è¿”å›ï¼Œä¸å‹ç¼©ï¼Œä¿ç•™åŠ¨ç”»æ•ˆæœ
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // å…¶ä»–æ ¼å¼å›¾ç‰‡æ­£å¸¸å‹ç¼©
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width, height = img.height;
                                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                                canvas.width = width; canvas.height = height;
                                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                                resolve(canvas.toDataURL('image/jpeg', userQuality));
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            },

            // å°†ä¸­æ–‡ç¿»è¯‘ä¸ºè‹±æ–‡
            translateToEnglish: async (chineseText) => {
                try {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯è‹±æ–‡ï¼ˆç®€å•åˆ¤æ–­ï¼šå¦‚æœä¸åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œç›´æ¥è¿”å›ï¼‰
                    if (!/[\u4e00-\u9fa5]/.test(chineseText)) {
                        return chineseText;
                    }

                    // ä½¿ç”¨Google Translate APIè¿›è¡Œç¿»è¯‘
                    const response = await fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=en&dt=t&q=' + encodeURIComponent(chineseText), {
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    const data = await response.json();
                    return data[0][0][0];
                } catch (error) {
                    console.error('ç¿»è¯‘å¤±è´¥:', error);
                    // ç¿»è¯‘å¤±è´¥æ—¶ï¼Œè¿”å›åŸå§‹æ–‡æœ¬ï¼Œä½†æ·»åŠ è‹±æ–‡æç¤º
                    return chineseText + ' (Please use English description for better results)';
                }
            },
            // Toasté˜Ÿåˆ—ï¼Œé˜²æ­¢é‡å 
            toastQueue: [],
            isToastShowing: false,

            showToast: (msg) => {
                // å°†æ–°çš„toastæ·»åŠ åˆ°é˜Ÿåˆ—
                window.Utils.toastQueue.push(msg);
                console.log('showToast called:', msg, 'queue length:', window.Utils.toastQueue.length);

                // å¦‚æœæ²¡æœ‰toaståœ¨æ˜¾ç¤ºï¼Œå¼€å§‹æ˜¾ç¤ºé˜Ÿåˆ—ä¸­çš„toast
                if (!window.Utils.isToastShowing) {
                    window.Utils.showNextToast();
                }
            },

            showNextToast: () => {
                // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›
                if (window.Utils.toastQueue.length === 0) {
                    window.Utils.isToastShowing = false;
                    return;
                }

                // æ ‡è®°ä¸ºæ­£åœ¨æ˜¾ç¤º
                window.Utils.isToastShowing = true;

                // å–å‡ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªtoast
                const msg = window.Utils.toastQueue.shift();

                // åˆ›å»ºä¸€ä¸ªæ–°çš„toastå…ƒç´ 
                const toast = document.createElement('div');

                // è®¾ç½®æ ·å¼
                toast.style.position = 'fixed';
                toast.style.top = '80px';
                // è·ç¦»å±å¹•è¾¹ç¼˜10pxï¼Œç›´æ¥è®¾ç½®å·¦å³è¾¹è·ï¼Œè®©toastè‡ªåŠ¨æ‹‰ä¼¸å¡«æ»¡
                toast.style.left = '10px';
                toast.style.right = '10px';
                toast.style.transform = 'none'; // ç§»é™¤å±…ä¸­å˜æ¢
                // è“è‰²åŠé€æ˜æ•ˆæœï¼Œalphaå€¼0.5ï¼Œç¡®ä¿èƒ½çœ‹åˆ°ä¸‹é¢çš„ç•Œé¢
                toast.style.background = 'rgba(147, 197, 253, 0.5)';
                toast.style.backdropFilter = 'blur(12px)';
                toast.style.webkitBackdropFilter = 'blur(12px)';
                toast.style.color = '#2c3e50';
                toast.style.padding = '12px 24px';
                toast.style.margin = '0'; // ç§»é™¤å¤–è¾¹è·ï¼Œç›´æ¥ä½¿ç”¨leftå’Œrightå®šä½
                toast.style.borderRadius = '16px'; // åœ†è§’å‡å°
                toast.style.fontSize = '16px';
                toast.style.fontWeight = '700';
                toast.style.zIndex = '999999';
                toast.style.opacity = '1';
                toast.style.visibility = 'visible';
                toast.style.display = 'flex';
                toast.style.alignItems = 'center';
                toast.style.justifyContent = 'center';
                toast.style.boxShadow = '0 8px 30px rgba(31, 38, 135, 0.3)';
                toast.style.border = '1px solid rgba(255, 255, 255, 0.8)';
                toast.style.pointerEvents = 'none';
                toast.style.fontFamily = 'Arial, sans-serif';
                toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                toast.style.textAlign = 'center';

                // è®¾ç½®å†…å®¹
                toast.textContent = msg;

                // æ·»åŠ åˆ°body
                document.body.appendChild(toast);

                // 3ç§’åç§»é™¤å½“å‰toastå¹¶æ˜¾ç¤ºä¸‹ä¸€ä¸ª
                setTimeout(() => {
                    // æ·¡å‡ºåŠ¨ç”»
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(-10px)';

                    // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ å¹¶æ˜¾ç¤ºä¸‹ä¸€ä¸ªtoast
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                        // æ˜¾ç¤ºä¸‹ä¸€ä¸ªtoast
                        window.Utils.showNextToast();
                    }, 300);
                }, 3000);
            },
            playAudio: (url) => {
                if (!url) {
                    console.error('æ’­æ”¾å¤±è´¥: æ— æ•ˆçš„éŸ³é¢‘URL');
                    return;
                }
                const a = new Audio(url);
                a.play().catch(e => {
                    console.error('æ’­æ”¾å¤±è´¥:', e);
                    if (e.name === 'NotSupportedError') {
                        console.error('ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼æˆ–æ— æ•ˆçš„éŸ³é¢‘æº');
                    }
                });
            },
            formatTimeDiff: (ms) => {
                const s = Math.floor(ms / 1000);
                if (s < 60) return 'just now';
                const m = Math.floor(s / 60);
                if (m < 60) return `${m} mins ago`;
                const h = Math.floor(m / 60);
                if (h < 24) return `${h} hours ago`;
                return `${Math.floor(h / 24)} days ago`;
            },
            formatCurrentTime: () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const weekday = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'][now.getDay()];
                // ã€ä¿®æ”¹ã€‘å¼ºåˆ¶24å°æ—¶åˆ¶ï¼ŒAIçœ‹è¿™ä¸ªç»å¯¹ä¸ä¼šæ™•
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${weekday} ${hour}:${minute}`;
            },
            formatTimeDiffDetailed: (ms) => {
                const s = Math.floor(ms / 1000);
                if (s < 60) return 'åˆšåˆš';
                const m = Math.floor(s / 60);
                if (m < 60) return `${m}åˆ†é’Ÿå‰`;
                const h = Math.floor(m / 60);
                if (h < 24) return `${h}å°æ—¶å‰`;
                const d = Math.floor(h / 24);
                if (d < 7) return `${d}å¤©å‰`;
                const w = Math.floor(d / 7);
                if (w < 4) return `${w}å‘¨å‰`;
                const mo = Math.floor(d / 30);
                return `${mo}ä¸ªæœˆå‰`;
            },
            formatTimeForAI: (ts) => {
                if (!ts) return '';
                const date = new Date(ts);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            },
            formatChatTime: (ts) => {
                if (!ts) return '';
                const date = new Date(ts);
                const now = new Date();
                const diffDay = now.getDate() - date.getDate();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                if (now.toDateString() === date.toDateString()) return `${hours}:${minutes}`;
                if (diffDay === 1) return `æ˜¨å¤© ${hours}:${minutes}`;
                if (diffDay < 7 && diffDay > 0) return `${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()]} ${hours}:${minutes}`;
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()} ${hours}:${minutes}`;
            },

            // æ·»åŠ formatTimeå‡½æ•°ï¼Œè§£å†³TypeError: Utils.formatTime is not a function
            formatTime: (ts) => {
                if (!ts) return '';
                const date = new Date(ts);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
        };

        // --- âš™ï¸ è®¾ç½®é€»è¾‘ (Settings Logic) ---
        window.MusicBox = {
            synth: null, isPlaying: false,
            // ä¹å™¨é¢„è®¾
            presets: {
                'piano': { oscillator: { type: "triangle" }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.3, release: 1 } },
                'guitar': { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 1 } },
                'violin': { oscillator: { type: "sawtooth" }, envelope: { attack: 0.2, decay: 0.1, sustain: 0.8, release: 2 } },
                'flute': { oscillator: { type: "sine" }, envelope: { attack: 0.1, decay: 0.1, sustain: 0.9, release: 1 } },
                'game': { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } },
                'drum': { oscillator: { type: "fmsine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.2 } }
            },
            init: () => {
                if (MusicBox.synth) return;
                MusicBox.synth = new Tone.PolySynth(Tone.Synth).toDestination();
                MusicBox.synth.volume.value = -8;
            },
            playScore: async (rawContent) => {
                // ã€ä¿®å¤ã€‘æ¼”å¥å‰å¼ºåˆ¶åœæ­¢è‡ªåŠ¨æœ—è¯»
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                if (window.WeChatUI) window.WeChatUI.isSpeaking = false;

                await Tone.start(); MusicBox.init();
                if (MusicBox.isPlaying) return;
                MusicBox.isPlaying = true;

                // è§£æä¹å™¨å’Œè°±å­
                let instrument = 'piano'; let scoreStr = rawContent;
                if (rawContent.includes(':')) {
                    const parts = rawContent.split(/[:ï¼š]/);
                    const possibleInst = parts[0].trim().toLowerCase();
                    if (MusicBox.presets[possibleInst]) { instrument = possibleInst; scoreStr = parts[1]; }
                }

                // æ¼”å¥é€»è¾‘
                MusicBox.synth.set(MusicBox.presets[instrument]);
                const notes = scoreStr.split(/[,ï¼Œ\s]+/).map(n => n.trim()).filter(n => n);
                Utils.showToast(`ğŸµ ${instrument}æ¼”å¥ä¸­...`);

                const now = Tone.now();
                notes.forEach((note, i) => {
                    try {
                        if (note === '0' || note.toLowerCase() === 'rest') return;
                        // éšæœºåŒ–ä¸€ç‚¹æ—¶é—´ï¼Œæ¨¡æ‹ŸçœŸäººæ„Ÿ
                        const time = now + i * 0.4 + (Math.random() * 0.02);
                        const duration = instrument === 'violin' ? "2n" : "8n";
                        MusicBox.synth.triggerAttackRelease(note, duration, time);
                    } catch (e) { }
                });
                setTimeout(() => { MusicBox.isPlaying = false; }, notes.length * 450 + 1000);
            }
        };

        function updateSystem() {
            const now = new Date();
            const time = now.toTimeString().slice(0, 8); // æ˜¾ç¤ºç§’æ•°ï¼Œæ ¼å¼ä¸º HH:MM:SS
            document.getElementById('clock-small').textContent = time; document.getElementById('clock-large').textContent = time;
            document.getElementById('date-large').textContent = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][now.getDay()]}`;
        }
        setInterval(updateSystem, 1000); updateSystem();
        // ç”µé‡æ˜¾ç¤ºåŠŸèƒ½ - ä¿®å¤å…¼å®¹æ€§é—®é¢˜
        function updateBatteryLevel() {
            // å°è¯•ä½¿ç”¨æ ‡å‡†çš„Battery Status API
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    // æ›´æ–°ç”µé‡ç™¾åˆ†æ¯”
                    document.getElementById('battery-level').textContent = Math.round(battery.level * 100) + '%';
                    // æ›´æ–°ç”µæ± å›¾æ ‡
                    updateBatteryIcon(battery.level);
                    // ç›‘å¬ç”µé‡å˜åŒ–
                    battery.addEventListener('levelchange', () => {
                        document.getElementById('battery-level').textContent = Math.round(battery.level * 100) + '%';
                        updateBatteryIcon(battery.level);
                    });
                    // ç›‘å¬å……ç”µçŠ¶æ€å˜åŒ–
                    battery.addEventListener('chargingchange', () => {
                        updateBatteryIcon(battery.level, battery.charging);
                    });
                }).catch(err => {
                    // APIè°ƒç”¨å¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    useMockBattery();
                });
            } else {
                // æµè§ˆå™¨ä¸æ”¯æŒBattery APIæ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                useMockBattery();
            }
        }

        // æ›´æ–°ç”µæ± å›¾æ ‡
        function updateBatteryIcon(level, isCharging = false) {
            const batteryIcon = document.getElementById('battery-icon');
            const percentage = Math.round(level * 100);

            // ç§»é™¤æ‰€æœ‰ç”µæ± ç›¸å…³å›¾æ ‡ç±»
            batteryIcon.className = 'fa-solid';

            if (isCharging) {
                batteryIcon.classList.add('fa-battery-charging');
            } else {
                // æ ¹æ®ç”µé‡è®¾ç½®ä¸åŒçš„ç”µæ± å›¾æ ‡
                if (percentage >= 90) {
                    batteryIcon.classList.add('fa-battery-full');
                } else if (percentage >= 70) {
                    batteryIcon.classList.add('fa-battery-three-quarters');
                } else if (percentage >= 50) {
                    batteryIcon.classList.add('fa-battery-half');
                } else if (percentage >= 20) {
                    batteryIcon.classList.add('fa-battery-quarter');
                } else {
                    batteryIcon.classList.add('fa-battery-empty');
                }
            }
        }

        // ä½¿ç”¨æ¨¡æ‹Ÿç”µé‡æ•°æ®
        function useMockBattery() {
            // éšæœºç”Ÿæˆåˆå§‹ç”µé‡ï¼ˆ60%-100%ï¼‰
            let mockLevel = 0.6 + Math.random() * 0.4;
            document.getElementById('battery-level').textContent = Math.round(mockLevel * 100) + '%';
            updateBatteryIcon(mockLevel);

            // æ¯10ç§’éšæœºæ›´æ–°ä¸€æ¬¡ç”µé‡ï¼ˆæ¨¡æ‹ŸçœŸå®ä½¿ç”¨æƒ…å†µï¼‰
            setInterval(() => {
                // éšæœºå¢å‡0-2%çš„ç”µé‡
                const change = (Math.random() - 0.5) * 0.04;
                mockLevel = Math.max(0, Math.min(1, mockLevel + change));
                document.getElementById('battery-level').textContent = Math.round(mockLevel * 100) + '%';
                updateBatteryIcon(mockLevel);
            }, 10000);
        }

        // åˆå§‹åŒ–ç”µé‡æ˜¾ç¤º
        updateBatteryLevel();

        // åˆå§‹åŒ–APIé…ç½®ï¼ˆåŠ è½½é»˜è®¤é…ç½®å’Œç”¨æˆ·ä¿å­˜çš„é…ç½®ï¼‰
        if (window.SettingsLogic) {
            //             window.SettingsLogic.initAPI();
        }

        // Navigation
        // ç¡®ä¿å˜é‡åªè¢«å£°æ˜ä¸€æ¬¡
        if (typeof window.swiper === 'undefined') {
            window.swiper = document.getElementById('app-swiper');
        }
        // ä½¿ç”¨varæ›¿ä»£leté¿å…é‡å¤å£°æ˜é”™è¯¯ï¼Œvarå…è®¸é‡å¤å£°æ˜ä¸”ä¼šè¦†ç›–
        var isDown = false, startX, scrollLeft;
        window.isDragging = false;

        // æå‰å£°æ˜HistoryManagerï¼Œé¿å…ä½¿ç”¨æ—¶æœªå®šä¹‰é”™è¯¯
        window.HistoryManager = {
            push: (id) => {
                history.pushState({ level: 'subview', id: id }, '', '');
            },
            back: () => {
                history.back();
            }
        };
        if (swiper) {
            // æ·»åŠ touch-actionå±æ€§ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯è§¦æ‘¸ä½“éªŒ
            swiper.style.touchAction = 'pan-y';

            // æ¡Œé¢ç«¯é¼ æ ‡äº‹ä»¶
            swiper.addEventListener('mousedown', e => { isDown = true; window.isDragging = false; swiper.classList.add('active'); swiper.style.scrollSnapType = 'none'; startX = e.pageX - swiper.offsetLeft; scrollLeft = swiper.scrollLeft; });
            swiper.addEventListener('mouseleave', () => { isDown = false; swiper.classList.remove('active'); swiper.style.scrollSnapType = 'x mandatory'; });
            swiper.addEventListener('mouseup', () => { isDown = false; swiper.classList.remove('active'); swiper.style.scrollSnapType = 'x mandatory'; setTimeout(() => window.isDragging = false, 10); });
            swiper.addEventListener('mousemove', e => { if (!isDown) return; e.preventDefault(); const x = e.pageX - swiper.offsetLeft; const walk = (x - startX) * 1.5; if (Math.abs(walk) > 5) window.isDragging = true; swiper.scrollLeft = scrollLeft - walk; });

            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶ - ä¼˜åŒ–ä¸ºåŸç”Ÿæ»šåŠ¨ï¼Œæ›´ä¸æ»‘
            // åªéœ€è¦æ£€æµ‹æ˜¯å¦å‘ç”Ÿäº†æ‹–æ‹½ï¼Œä»¥é˜²æ­¢è¯¯è§¦ç‚¹å‡»
            swiper.addEventListener('touchstart', e => {
                isDown = true;
                window.isDragging = false;
                startX = e.touches[0].pageX;
            }, { passive: true }); // passive: true æå‡æ»šåŠ¨æ€§èƒ½

            swiper.addEventListener('touchend', () => {
                isDown = false;
                // å»¶è¿Ÿé‡ç½®æ‹–æ‹½çŠ¶æ€ï¼Œç¡®ä¿ç‚¹å‡»äº‹ä»¶èƒ½è¯»å–åˆ°æ­£ç¡®çš„çŠ¶æ€
                setTimeout(() => window.isDragging = false, 50);
            });

            swiper.addEventListener('touchcancel', () => {
                isDown = false;
                window.isDragging = false;
            });

            swiper.addEventListener('touchmove', e => {
                if (!isDown) return;
                const x = e.touches[0].pageX;
                // ä»…ç”¨äºæ£€æµ‹ç”±äºæ»‘åŠ¨è€Œäº§ç”Ÿçš„ä½ç§»
                const walk = Math.abs(x - startX);

                // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡ 5pxï¼Œè§†ä¸ºæ‹–æ‹½/æ»‘åŠ¨ï¼Œé˜»æ­¢ç‚¹å‡»äº‹ä»¶
                if (walk > 5) {
                    window.isDragging = true;
                }

                // ã€æ ¸å¿ƒä¼˜åŒ–ã€‘ä¸å†æ‰‹åŠ¨è®¾ç½® scrollLeftï¼Œä¹Ÿä¸é˜»æ­¢é»˜è®¤äº‹ä»¶
                // è®©æµè§ˆå™¨åŸç”Ÿå¤„ç†å¸¦æƒ¯æ€§çš„æ»šåŠ¨å’Œ CSS Scroll Snap
            }, { passive: true });

            // æ·»åŠ æ»šåŠ¨ç»“æŸäº‹ä»¶ï¼Œæ›´æ–°ç™½ç‚¹çŠ¶æ€
            swiper.addEventListener('scrollend', () => {
                const currentPage = Math.round(swiper.scrollLeft / swiper.clientWidth);
                // æ›´æ–°ç™½ç‚¹çŠ¶æ€
                const dot1 = document.getElementById('dot-1');
                const dot2 = document.getElementById('dot-2');

                if (currentPage === 0) {
                    dot1.className = 'w-1.5 h-1.5 rounded-full bg-white shadow-lg transition-all';
                    dot2.className = 'w-1.5 h-1.5 rounded-full bg-white/20 transition-all';
                } else {
                    dot1.className = 'w-1.5 h-1.5 rounded-full bg-white/20 transition-all';
                    dot2.className = 'w-1.5 h-1.5 rounded-full bg-white shadow-lg transition-all';
                }
            });
        }

        window.openApp = function (appId) {
            // è®°å½•åº”ç”¨æ‰“å¼€äº‹ä»¶
            if (window.SystemLog) {
                SystemLog.write('SYS', 'æ‰“å¼€åº”ç”¨', appId);
            }

            // å¦‚æœå½“å‰æ­£åœ¨æ‹–æ‹½ï¼Œä¸å¤„ç†æ‰“å¼€åº”ç”¨
            if (window.isDragging) return;

            // å¦‚æœå½“å‰å·²ç»æ˜¯è¿™ä¸ªAPPï¼Œä¸é‡å¤å¤„ç†
            if (document.getElementById('app-' + appId)?.classList.contains('active')) return;

            if (['wechat', 'settings', 'worldbook', 'weibo', 'syslog', 'search'].includes(appId)) {
                // å…ˆå…³é—­å…¶ä»– Appï¼Œé˜²æ­¢å±‚å 
                document.querySelectorAll('.app-window').forEach(el => el.classList.remove('active'));

                // æ‰“å¼€æ–° App
                document.getElementById('app-' + appId).classList.add('active');

                // ã€å…³é”®ä¿®å¤ã€‘æ¨å…¥å†å²è®°å½•ï¼Œæ ‡è®° level ä¸º app
                history.pushState({ level: 'app', id: appId }, '', '');

                // åˆå§‹åŒ–é€»è¾‘ - ç”¨try-catchåŒ…è£¹ï¼Œé¿å…åˆå§‹åŒ–å¤±è´¥å¯¼è‡´åº”ç”¨æ— æ³•æ‰“å¼€
                try {
                    if (appId === 'wechat') {
                        if (typeof WeChatUI !== 'undefined' && typeof WeChatUI.renderList === 'function') {
                            WeChatUI.renderList();
                        }
                    }
                    else if (appId === 'settings') {
                        if (typeof SettingsUI !== 'undefined' && typeof SettingsUI.init === 'function') {
                            SettingsUI.init();
                        }
                    }
                    else if (appId === 'worldbook') {
                        if (typeof WorldbookUI !== 'undefined' && typeof WorldbookUI.renderList === 'function') {
                            WorldbookUI.renderList();
                        }
                    }
                    else if (appId === 'weibo') {
                        if (typeof WeiboUI !== 'undefined' && typeof WeiboUI.init === 'function') {
                            WeiboUI.init();
                        }
                    }
                    else if (appId === 'search') {
                        if (typeof SearchPhoneUI !== 'undefined' && typeof SearchPhoneUI.init === 'function') {
                            SearchPhoneUI.init();
                        }
                    }
                } catch (initError) {
                    console.error('åˆå§‹åŒ–åº”ç”¨å¤±è´¥:', appId, initError);
                }
            }
            else {
                const icon = document.getElementById('icon-' + appId);
                if (icon) {
                    icon.style.transform = "scale(0.95)";
                    setTimeout(() => icon.style.transform = "", 150);
                }
                alert(appId + ' æ­£åœ¨åŠ è½½æ ¸å¿ƒ...');
            }
        }

        window.closeApp = function () {
            // ç›´æ¥è°ƒç”¨æµè§ˆå™¨è¿”å›ï¼Œè§¦å‘ popstate
            history.back();
        }
        window.resetApp = function () {
            // å…³é—­æ‰€æœ‰æ‰“å¼€çš„åº”ç”¨
            document.querySelectorAll('.app-window').forEach(el => el.classList.remove('active'));
            // å…³é—­æ‰€æœ‰å­é¡µé¢
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden'));
            // å…³é—­æ‰€æœ‰ä¸Šä¸‹æ–‡èœå•
            document.querySelectorAll('#context-menu, #contact-context-menu').forEach(el => el.classList.add('hidden'));
            // å…³é—­æ‰€æœ‰é€šçŸ¥
            document.getElementById('global-notification-modal')?.classList.add('hidden');
            // é‡ç½®è¾“å…¥æ¡†
            document.querySelectorAll('input, textarea').forEach(el => el.value = '');
            // éšè—emojié¢æ¿
            document.getElementById('emoji-panel')?.classList.add('hidden');
            // é‡ç½®å¤šé€‰æ¨¡å¼
            document.body.classList.remove('multiselect-mode');
            // é‡ç½®è¯­éŸ³æ¨¡å¼
            if (window.WeChatUI) window.WeChatUI.isVoiceMode = false;
            // æ˜¾ç¤ºæç¤º
            window.Utils.showToast('åº”ç”¨å·²é‡ç½®');
        }




        // Weather Logic
        window.WeatherLogic = {
            init: () => {
                const config = AppStorage.get('weather_config', { virtualLoc: 'è™šæ‹ŸåŸå¸‚', realLoc: '' });
                document.getElementById('weather-virtual-loc').value = config.virtualLoc;
                document.getElementById('weather-real-loc').value = config.realLoc;
                WeatherLogic.updateDisplay(config);
            },
            saveWeatherConfig: () => {
                const config = {
                    virtualLoc: document.getElementById('weather-virtual-loc').value || 'è™šæ‹ŸåŸå¸‚',
                    realLoc: document.getElementById('weather-real-loc').value
                };
                AppStorage.set('weather_config', config);
                WeatherLogic.updateDisplay(config);
                if (config.realLoc) WeatherLogic.fetchRealWeather(config.realLoc);
                Utils.showToast('å¤©æ°”è®¾ç½®å·²ä¿å­˜');
            },
            updateDisplay: (config) => {
                document.getElementById('desktop-location-text').textContent = config.virtualLoc;
            },
            fetchRealWeather: async (city) => {
                const weathers = [
                    { icon: 'fa-sun', desc: 'æ™´æœ—', temp: '25Â°', color: 'text-yellow-300' },
                    { icon: 'fa-cloud-rain', desc: 'å°é›¨', temp: '18Â°', color: 'text-blue-300' },
                    { icon: 'fa-cloud', desc: 'å¤šäº‘', temp: '22Â°', color: 'text-gray-300' },
                    { icon: 'fa-bolt', desc: 'é›·é˜µé›¨', temp: '20Â°', color: 'text-purple-300' }
                ];
                const w = weathers[Math.floor(Math.random() * weathers.length)];
                document.getElementById('desktop-weather-icon').className = `fa-solid ${w.icon} weather-icon`;
                document.getElementById('desktop-weather-bg-icon').innerHTML = `<i class="fa-solid ${w.icon}"></i>`;
                document.getElementById('desktop-weather-bg-icon').className = `absolute -right-4 -bottom-4 text-7xl opacity-20 ${w.color}`;
                document.getElementById('desktop-temp').textContent = w.temp;
                document.getElementById('desktop-weather-desc').textContent = w.desc;
            }
        };

        // Settings Logic
        window.SettingsUI = {
            init: () => { SettingsLogic.initAPI(); ThemeLogic.init(); SettingsLogic.initTTS(); WeatherLogic.init(); },
            openPage: (pid, title) => { document.getElementById('settings-main-menu').classList.add('hidden'); document.getElementById('settings-page-' + pid).classList.remove('hidden'); document.getElementById('settings-title').textContent = title; },
            handleBack: () => { if (document.getElementById('settings-main-menu').classList.contains('hidden')) { document.getElementById('settings-main-menu').classList.remove('hidden'); document.querySelectorAll('[id^="settings-page-"]').forEach(el => el.classList.add('hidden')); document.getElementById('settings-title').textContent = 'è®¾ç½®ä¸­å¿ƒ'; } else closeApp(); }
        };

        window.SettingsLogic = {
            configs: [], currentId: null,
            // é»˜è®¤APIé…ç½®
            DEFAULT_CONFIG: {
                name: 'é»˜è®¤é…ç½®',
                url: 'http://127.0.0.1:7861/v1',
                key: 'pwd',
                model: 'gemini-2.5-pro-nothinking',
                temp: 0.7,
                maxTokens: 4096
            },

            // åˆå§‹åŒ–APIé…ç½®
            initAPI: function () {
                let configs = AppStorage.get('wechat_api_configs', {});

                // å¦‚æœæ²¡æœ‰ä»»ä½•é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
                if (Object.keys(configs).length === 0) {
                    configs['default'] = this.DEFAULT_CONFIG;
                    AppStorage.set('wechat_api_configs', configs);
                    AppStorage.set('wechat_current_api', 'default');
                    console.log('[SettingsLogic] åˆ›å»ºé»˜è®¤APIé…ç½®');
                }

                this.loadAPIList();

                const currentKey = AppStorage.get('wechat_current_api', 'default');
                this.loadAPIConfig(currentKey, 'primary');

            },

            // åŠ è½½APIé…ç½®åˆ—è¡¨åˆ°ä¸‹æ‹‰èœå•
            loadAPIList: function () {
                const configs = AppStorage.get('wechat_api_configs', {});
                const primarySelect = document.getElementById('api-config-select');

                if (primarySelect) {
                    primarySelect.innerHTML = Object.keys(configs).map(key => {
                        const config = configs[key];
                        return `<option value="${key}">${config.name || key}</option>`;
                    }).join('');
                    primarySelect.value = AppStorage.get('wechat_current_api', 'default');
                }
            },

            loadAPIConfig: function (configKey, type) {
                if (!configKey || configKey === '') return;

                const configs = AppStorage.get('wechat_api_configs', {});
                const config = configs[configKey];
                if (!config) return console.error('[SettingsLogic] é…ç½®ä¸å­˜åœ¨:', configKey);

                // å‰¯APIå·²ç§»é™¤ï¼Œåªä½¿ç”¨ä¸»API
                const prefix = 'primary';
                const setVal = (id, val) => { const el = document.getElementById(prefix + '-api-' + id); if (el) el.value = val || ''; };

                setVal('name', config.name);
                setVal('url', config.url);
                setVal('key', config.key);
                setVal('model', config.model);
                setVal('temp', config.temp);
                setVal('max-tokens', config.maxTokens || 4096);

                if (document.getElementById(prefix + '-temp-display')) document.getElementById(prefix + '-temp-display').textContent = config.temp || 0.7;
                if (document.getElementById(prefix + '-max-tokens-display')) document.getElementById(prefix + '-max-tokens-display').textContent = config.maxTokens || 4096;

                AppStorage.set('wechat_current_api', configKey);
            },



            saveAPI: function () {
                const currentConfigKey = AppStorage.get('wechat_api_configs', 'default'); // Fix: get key not object? No, 'wechat_current_api'.
                // Bug fix: The original code gathered 'wechat_current_api' correctly.
                // Let's rewrite carefully.
                const currentKey = AppStorage.get('wechat_current_api', 'default');
                const getVal = (id) => {
                    const el = document.getElementById('primary-api-' + id);
                    return el ? el.value : '';
                };

                const primaryConfig = {
                    name: getVal('name') || 'æœªå‘½åé…ç½®',
                    url: getVal('url'),
                    key: getVal('key'),
                    model: getVal('model'),
                    temp: parseFloat(getVal('temp')) || 0.7,
                    maxTokens: parseInt(getVal('max-tokens')) || 4096
                };

                let configs = AppStorage.get('wechat_api_configs', {});
                // Ensure configs is an object
                if (typeof configs !== 'object') configs = {};

                configs[currentKey] = primaryConfig;
                AppStorage.set('wechat_api_configs', configs);

                window.Utils.showToast('APIé…ç½®å·²ä¿å­˜');

                this.loadAPIList();
            },

            createNewAPI: function () {
                window.Utils.showPrompt('æ–°å»ºAPIé…ç½®', 'è¾“å…¥é…ç½®åç§°', (name) => {
                    if (!name) return window.Utils.showToast('é…ç½®åç§°ä¸èƒ½ä¸ºç©º');
                    const newKey = 'api_' + Date.now();
                    const configs = AppStorage.get('wechat_api_configs', {});
                    configs[newKey] = { ...this.DEFAULT_CONFIG, name: name, url: '', key: '' }; // Clean defaults
                    AppStorage.set('wechat_api_configs', configs);
                    AppStorage.set('wechat_current_api', newKey);
                    this.loadAPIList();
                    this.loadAPIConfig(newKey, 'primary');
                    window.Utils.showToast('é…ç½®å·²åˆ›å»º');
                });
            },

            deleteAPI: function () {
                const currentKey = AppStorage.get('wechat_current_api', 'default');
                if (currentKey === 'default') return window.Utils.showToast('é»˜è®¤é…ç½®ä¸èƒ½åˆ é™¤');
                window.Utils.showConfirm('ç¡®è®¤åˆ é™¤ï¼Ÿ', (confirmed) => {
                    if (!confirmed) return;
                    const configs = AppStorage.get('wechat_api_configs', {});
                    delete configs[currentKey];
                    AppStorage.set('wechat_api_configs', configs);
                    AppStorage.set('wechat_current_api', 'default');
                    this.loadAPIList();
                    this.loadAPIConfig('default', 'primary');
                    window.Utils.showToast('é…ç½®å·²åˆ é™¤');
                });
            },

            fetchModels: async function (type) {
                const url = document.getElementById('primary-api-url').value;
                const key = document.getElementById('primary-api-key').value;

                if (!url) {
                    window.Utils.showToast('è¯·å…ˆå¡«å†™APIåœ°å€');
                    return;
                }

                try {
                    window.Utils.showToast('æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨...');

                    const response = await fetch(`${url}/models`, {
                        headers: {
                            'Authorization': `Bearer ${key}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const models = data.data || data.models || [];

                    if (models.length === 0) {
                        window.Utils.showToast('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹');
                        return;
                    }

                    const select = document.getElementById('primary-api-model-select');
                    if (select) {
                        select.innerHTML = '<option value="" disabled selected> é€‰æ‹©æ¨¡å‹</option>' +
                            models.map(m => {
                                const modelId = m.id || m;
                                return `<option value="${modelId}">${modelId}</option>`;
                            }).join('');
                        select.classList.remove('hidden');
                    }

                    window.Utils.showToast(`æˆåŠŸæ‹‰å– ${models.length} ä¸ªæ¨¡å‹`);

                } catch (error) {
                    console.error('[Settings Logic] æ‹‰å–æ¨¡å‹å¤±è´¥:', error);
                    window.Utils.showToast('æ‹‰å–æ¨¡å‹å¤±è´¥: ' + error.message);
                }
            },

            // TTS åˆå§‹åŒ– (ä¿®å¤å)
            initTTS: function () {
                const tts = AppStorage.get('tts_config', { engine: 'browser', minimax: {} });
                document.getElementById('tts-engine').value = tts.engine || 'browser'; document.getElementById('minimax-group-id').value = tts.minimax.groupId || ''; document.getElementById('minimax-api-key').value = tts.minimax.apiKey || ''; document.getElementById('minimax-voice-id').value = tts.minimax.voiceId || ''; document.getElementById('minimax-model-id').value = tts.minimax.modelId || 'speech-01-turbo';
                SettingsLogic.toggleTTSSettings();
            },
            toggleTTSSettings: () => { document.getElementById('minimax-settings').className = document.getElementById('tts-engine').value === 'minimax' ? 'space-y-3' : 'space-y-3 hidden'; },
            fetchMinimaxModels: async (event) => {
                const groupId = document.getElementById('minimax-group-id').value;
                const apiKey = document.getElementById('minimax-api-key').value;
                const btn = event ? event.currentTarget : document.querySelector('[onclick*="SettingsLogic.fetchMinimaxModels()"]');

                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="spinner-container"><i class="fa-solid fa-spinner spinner-rotate"></i></div>';
                btn.disabled = true;

                // APIæ”¯æŒçš„é»˜è®¤TTSæ¨¡å‹åˆ—è¡¨
                const defaultTTSModels = [
                    { model: "speech-2.6-hd" },
                    { model: "speech-2.6-turbo" },
                    { model: "speech-02-hd" },
                    { model: "speech-02-turbo" },
                    { model: "speech-01-hd" },
                    { model: "speech-01-turbo" }
                ];

                try {
                    // å¦‚æœæ²¡æœ‰æä¾›APIå¯†é’¥ï¼Œæ˜¾ç¤ºé»˜è®¤æ¨¡å‹åˆ—è¡¨
                    if (!groupId || !apiKey) {
                        Utils.showToast('ä½¿ç”¨APIæ”¯æŒçš„é»˜è®¤æ¨¡å‹åˆ—è¡¨');

                        const select = document.getElementById('minimax-model-select');
                        select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                            defaultTTSModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                        select.classList.remove('hidden');

                        // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                        document.getElementById('minimax-model-id').value = defaultTTSModels[0].model;
                        select.value = defaultTTSModels[0].model;
                        return;
                    }

                    // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦é€šè¿‡æœ¬åœ°æ–‡ä»¶åè®®æ‰“å¼€
                    if (window.location.protocol === 'file:') {
                        Utils.showToast('âš ï¸ æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹å¯èƒ½å­˜åœ¨è·¨åŸŸé™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œ');
                    }

                    // å°è¯•è”ç½‘æ‹‰å–æ¨¡å‹
                    const res = await fetch('https://api.minimax.chat/v1/models', {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + apiKey,
                            'Content-Type': 'application/json',
                            'GroupId': groupId
                        },
                        mode: 'cors',
                        credentials: 'omit'
                    });

                    let models = [];
                    // åªè¯»å–ä¸€æ¬¡response body
                    const responseText = await res.text();

                    if (res.ok) {
                        try {
                            const data = JSON.parse(responseText);
                            models = data.models || [];
                        } catch (e) {
                            throw new Error('æ— æ•ˆçš„å“åº”æ ¼å¼: ' + e.message);
                        }
                    } else {
                        // APIè°ƒç”¨å¤±è´¥ï¼Œè·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
                        let errorDetails = 'HTTP ' + res.status;
                        try {
                            const errorData = JSON.parse(responseText);
                            errorDetails += ': ' + errorData.base_resp?.status_msg || 'æœªçŸ¥é”™è¯¯';
                        } catch (e) {
                            errorDetails += ': ' + responseText;
                        }
                        console.warn('MiniMaxæ¨¡å‹æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨:', errorDetails);
                        Utils.showToast('æ¨¡å‹æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨APIæ”¯æŒçš„é»˜è®¤æ¨¡å‹åˆ—è¡¨');

                        // ä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨
                        const select = document.getElementById('minimax-model-select');
                        select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                            defaultTTSModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                        select.classList.remove('hidden');

                        // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                        document.getElementById('minimax-model-id').value = defaultTTSModels[0].model;
                        select.value = defaultTTSModels[0].model;
                        return;
                    }

                    if (models.length === 0) {
                        // æœªè·å–åˆ°æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨
                        console.warn('æœªè·å–åˆ°æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨');
                        Utils.showToast('æœªè·å–åˆ°æ¨¡å‹ï¼Œä½¿ç”¨APIæ”¯æŒçš„é»˜è®¤æ¨¡å‹åˆ—è¡¨');

                        const select = document.getElementById('minimax-model-select');
                        select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                            defaultTTSModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                        select.classList.remove('hidden');

                        // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                        document.getElementById('minimax-model-id').value = defaultTTSModels[0].model;
                        select.value = defaultTTSModels[0].model;
                        return;
                    }

                    // åªä¿ç•™TTSç›¸å…³çš„æ¨¡å‹
                    const ttsModels = models.filter(m => m.model.startsWith('speech-'));

                    if (ttsModels.length === 0) {
                        // æœªè·å–åˆ°TTSç›¸å…³æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨
                        console.warn('æœªè·å–åˆ°TTSç›¸å…³æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨');
                        Utils.showToast('æœªè·å–åˆ°TTSç›¸å…³æ¨¡å‹ï¼Œä½¿ç”¨APIæ”¯æŒçš„é»˜è®¤æ¨¡å‹åˆ—è¡¨');

                        const select = document.getElementById('minimax-model-select');
                        select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                            defaultTTSModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                        select.classList.remove('hidden');

                        // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                        document.getElementById('minimax-model-id').value = defaultTTSModels[0].model;
                        select.value = defaultTTSModels[0].model;
                        return;
                    }

                    const select = document.getElementById('minimax-model-select');
                    select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                        ttsModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                    select.classList.remove('hidden');

                    Utils.showToast(`âœ¨ æˆåŠŸè·å– ${ttsModels.length} ä¸ªMiniMax TTSæ¨¡å‹ï¼`);

                    // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                    document.getElementById('minimax-model-id').value = ttsModels[0].model;
                    select.value = ttsModels[0].model;

                } catch (e) {
                    // æ˜¾ç¤ºå‹å¥½é”™è¯¯ä¿¡æ¯
                    let errorMsg = 'MiniMaxæ¨¡å‹æ‹‰å–å¤±è´¥: ' + e.message;
                    console.error('MiniMaxæ¨¡å‹æ‹‰å–é”™è¯¯è¯¦æƒ…:', e);

                    // ä½¿ç”¨é»˜è®¤æ¨¡å‹åˆ—è¡¨
                    const select = document.getElementById('minimax-model-select');
                    select.innerHTML = '<option value="" disabled selected>â–¼ è¯·é€‰æ‹©æ¨¡å‹</option>' +
                        defaultTTSModels.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                    select.classList.remove('hidden');

                    // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¨¡å‹
                    document.getElementById('minimax-model-id').value = defaultTTSModels[0].model;
                    select.value = defaultTTSModels[0].model;

                    Utils.showToast('æ¨¡å‹æ‹‰å–å¤±è´¥ï¼Œä½¿ç”¨APIæ”¯æŒçš„é»˜è®¤æ¨¡å‹åˆ—è¡¨');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },
            testTTS: async () => {
                // ç›´æ¥å¤ç”¨ä¿®å¤å¥½çš„ generateTTS é€»è¾‘æ¥æµ‹è¯•
                if (document.getElementById('tts-engine').value === 'browser') {
                    const utterance = new SpeechSynthesisUtterance("æµ‹è¯•è¯­éŸ³");
                    utterance.lang = 'zh-CN';
                    utterance.rate = parseFloat(document.getElementById('char-voice-speed').value || 1.0);
                    speechSynthesis.speak(utterance);
                    return;
                }

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    // æ„é€ ä¸€ä¸ªä¸´æ—¶çš„ charSettings å¯¹è±¡
                    const mockCharSettings = {
                        voiceId: document.getElementById('minimax-voice-id').value,
                        voiceSpeed: 1.0
                    };

                    const url = await SettingsLogic.generateTTS("æ­å–œå‘è´¢ï¼Œè¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯­éŸ³ã€‚", mockCharSettings);

                    if (url) {
                        Utils.playAudio(url);
                        Utils.showToast('æ’­æ”¾æµ‹è¯•è¯­éŸ³');
                    }
                } catch (e) {
                    alert(e.message);
                } finally {
                    btn.innerHTML = originalText;
                }
            },
            saveTTS: () => { Utils.showToast('ä¿å­˜æˆåŠŸ'); AppStorage.set('tts_config', { engine: document.getElementById('tts-engine').value, minimax: { apiKey: document.getElementById('minimax-api-key').value, groupId: document.getElementById('minimax-group-id').value, voiceId: document.getElementById('minimax-voice-id').value, modelId: document.getElementById('minimax-model-id').value } }); },
            // æ•°æ®ç®¡ç†åŠŸèƒ½
            showExportDataModal: () => {
                // åˆ›å»ºå¯¼å‡ºæ•°æ®æ¨¡æ€æ¡†
                let modalHtml = `
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[1000]">
                        <div class="bg-blue-900/40 backdrop-blur-xl border border-blue-500/30 rounded-2xl p-6 w-[90vw] max-w-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">å¯¼å‡ºæ•°æ®</h3>
                                <button onclick="this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="text-white/80 hover:text-white text-xl">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                                <h4 class="text-lg font-semibold text-blue-200">é€‰æ‹©è¦å¯¼å‡ºçš„åº”ç”¨æ•°æ®</h4>
                                
                                <!-- å¾®ä¿¡æ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3 mb-3">
                                        <input type="checkbox" id="export-wechat" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-wechat" class="text-white font-semibold">å¾®ä¿¡</label>
                                    </div>
                                    
                                    <div class="pl-8 space-y-3">
                                        <h5 class="text-sm text-blue-200 font-medium">é€‰æ‹©è¦å¯¼å‡ºçš„è§’è‰²</h5>
                                        <div class="space-y-2">
                                            ${Object.values(AppStorage.get('wechat_chars', {})).map(char => `
                                                <div class="flex items-center gap-3">
                                                    <input type="checkbox" id="export-wechat-${char.id}" class="w-4 h-4 rounded accent-blue-400" checked>
                                                    <label for="export-wechat-${char.id}" class="text-white/80 text-sm">${char.nickname || char.name || 'æœªå‘½å'}</label>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å…¨å±€è¡¨æƒ…åŒ… -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-emojis" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-emojis" class="text-white font-semibold">å…¨å±€è¡¨æƒ…åŒ…</label>
                                    </div>
                                </div>
                                
                                <!-- é’±åŒ…æ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-wallet" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-wallet" class="text-white font-semibold">é’±åŒ…ä¸äº¤æ˜“è®°å½•</label>
                                    </div>
                                </div>
                                
                                <!-- æœ‹å‹åœˆ -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-moments" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-moments" class="text-white font-semibold">æœ‹å‹åœˆ</label>
                                    </div>
                                </div>
                                
                                <!-- NPCæ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-npcs" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-npcs" class="text-white font-semibold">NPCæ•°æ®</label>
                                    </div>
                                </div>
                                
                                <!-- ç”¨æˆ·èµ„æ–™ -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-user-profile" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-user-profile" class="text-white font-semibold">ç”¨æˆ·èµ„æ–™</label>
                                    </div>
                                </div>
                                
                                <!-- æŸ¥å²—æ‰‹æœºæ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-search-phone" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-search-phone" class="text-white font-semibold">æŸ¥å²—æ‰‹æœºæ•°æ®</label>
                                    </div>
                                </div>
                                
                                <!-- å…¶ä»–åº”ç”¨æ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-settings" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-settings" class="text-white font-semibold">ç³»ç»Ÿè®¾ç½®</label>
                                    </div>
                                </div>
                                
                                <!-- ä¸–ç•Œä¹¦åº”ç”¨æ•°æ® -->
                                <div class="glass-panel p-3 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="export-worldbook" class="w-5 h-5 rounded-full accent-blue-400" checked>
                                        <label for="export-worldbook" class="text-white font-semibold">ä¸–ç•Œä¹¦</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3 mt-6">
                                <button onclick="this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                                <button onclick="SettingsLogic.exportGlobalData(); this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="setting-btn flex-1">å¯¼å‡ºæ•°æ®</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
            },
            exportGlobalData: () => {
                const exportData = {};

                // å¯¼å‡ºå¾®ä¿¡æ•°æ®
                if (document.getElementById('export-wechat').checked) {
                    const chars = AppStorage.get('wechat_chars', {});
                    const selectedChars = Object.keys(chars).filter(charId => {
                        return document.getElementById(`export-wechat-${charId}`)?.checked;
                    });

                    exportData.wechat_chars = {};
                    selectedChars.forEach(charId => {
                        exportData.wechat_chars[charId] = chars[charId];
                    });
                }

                // ã€ä¿®å¤ã€‘è‡ªåŠ¨å¯¼å‡ºå…¨å±€è¡¨æƒ…åŒ…ï¼ˆæ— è®ºæ˜¯å¦å‹¾é€‰ï¼‰
                // åŸå› ï¼šAIä½¿ç”¨çš„è¡¨æƒ…åŒ…éœ€è¦åœ¨å¯¼å…¥åç”¨æˆ·ä¹Ÿèƒ½çœ‹åˆ°å’Œå‘é€
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                if (globalEmojis.length > 0) {
                    exportData.wechat_global_emojis = globalEmojis;
                }
                // å¦‚æœç”¨æˆ·ä¸»åŠ¨å‹¾é€‰äº†è¡¨æƒ…åŒ…é€‰é¡¹ï¼Œä¸Šé¢çš„ä»£ç ç¡®ä¿äº†ä¸€å®šä¼šå¯¼å‡º
                // å¦‚æœç”¨æˆ·æ²¡å‹¾é€‰ï¼Œåªè¦æœ‰è§’è‰²æ•°æ®ï¼Œä¹Ÿä¼šè‡ªåŠ¨å¯¼å‡ºï¼ˆå› ä¸ºè§’è‰²ä¼šç”¨åˆ°è¡¨æƒ…åŒ…ï¼‰
                if (document.getElementById('export-emojis')?.checked && !exportData.wechat_global_emojis) {
                    exportData.wechat_global_emojis = globalEmojis;
                }

                // å¯¼å‡ºé’±åŒ…æ•°æ®
                if (document.getElementById('export-wallet')?.checked) {
                    exportData.wechat_wallet = AppStorage.get('wechat_wallet', { balance: 0, transactions: [] });
                }

                // å¯¼å‡ºæœ‹å‹åœˆ
                if (document.getElementById('export-moments')?.checked) {
                    exportData.wechat_moments = AppStorage.get('wechat_moments', []);
                }

                // å¯¼å‡ºNPCæ•°æ®
                if (document.getElementById('export-npcs')?.checked) {
                    exportData.wechat_npcs = AppStorage.get('wechat_npcs', {});
                }

                // å¯¼å‡ºç”¨æˆ·èµ„æ–™
                if (document.getElementById('export-user-profile')?.checked) {
                    exportData.wechat_user_profile = AppStorage.get('wechat_user_profile', {});
                }

                // å¯¼å‡ºæŸ¥å²—æ‰‹æœºæ•°æ®
                if (document.getElementById('export-search-phone')?.checked) {
                    exportData.wechat_search_phone_data = AppStorage.get('wechat_search_phone_data', {});
                }

                // å¯¼å‡ºç³»ç»Ÿè®¾ç½®
                if (document.getElementById('export-settings').checked) {
                    exportData.wechat_api_configs = AppStorage.get('wechat_api_configs');
                    exportData.wechat_current_api = AppStorage.get('wechat_current_api');

                    exportData.tts_config = AppStorage.get('tts_config');
                    exportData.theme_config = AppStorage.get('theme_config');
                    exportData.weather_config = AppStorage.get('weather_config');
                }

                // å¯¼å‡ºä¸–ç•Œä¹¦åº”ç”¨æ•°æ®
                if (document.getElementById('export-worldbook').checked) {
                    exportData.wechat_worldbooks = AppStorage.get('wechat_worldbooks', {});
                    exportData.wechat_worldbook_categories = AppStorage.get('wechat_worldbook_categories', {});
                    exportData.wechat_worldbook_groups = AppStorage.get('wechat_worldbook_groups', {});
                }

                // ç”ŸæˆJSONæ–‡ä»¶å¹¶ä¸‹è½½
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `qiaoji-data-${new Date().toISOString().slice(0, 19)}.json`;
                link.click();
                URL.revokeObjectURL(url);

                Utils.showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ');
            },
            importGlobalData: () => {
                const fileInput = document.getElementById('import-data-file');
                if (!fileInput.files || !fileInput.files[0]) {
                    Utils.showToast('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // ç¡®è®¤å¯¼å…¥
                        if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å¯èƒ½ä¼šè¦†ç›–ç°æœ‰æ•°æ®ã€‚')) {
                            // å¯¼å…¥å¾®ä¿¡æ•°æ®
                            if (importedData.wechat_chars) {
                                const existingChars = AppStorage.get('wechat_chars', {});
                                const mergedChars = { ...existingChars, ...importedData.wechat_chars };
                                AppStorage.set('wechat_chars', mergedChars);
                            }

                            // å¯¼å…¥ç³»ç»Ÿè®¾ç½®
                            if (importedData.wechat_api_configs || importedData.api_configs) {
                                AppStorage.set('wechat_api_configs', importedData.wechat_api_configs || importedData.api_configs);
                            }
                            if (importedData.wechat_current_api || importedData.current_api_id) {
                                AppStorage.set('wechat_current_api', importedData.wechat_current_api || importedData.current_api_id);
                            }
                            if (importedData.tts_config) AppStorage.set('tts_config', importedData.tts_config);
                            if (importedData.theme_config) AppStorage.set('theme_config', importedData.theme_config);
                            if (importedData.weather_config) AppStorage.set('weather_config', importedData.weather_config);
                            // å¯¼å…¥ä¸–ç•Œä¹¦åº”ç”¨æ•°æ®
                            if (importedData.wechat_worldbooks) AppStorage.set('wechat_worldbooks', importedData.wechat_worldbooks);
                            if (importedData.wechat_worldbook_categories) AppStorage.set('wechat_worldbook_categories', importedData.wechat_worldbook_categories);
                            if (importedData.wechat_worldbook_groups) AppStorage.set('wechat_worldbook_groups', importedData.wechat_worldbook_groups);

                            // ã€æ–°å¢ã€‘å¯¼å…¥å…¨å±€è¡¨æƒ…åŒ…
                            if (importedData.wechat_global_emojis) {
                                const existingEmojis = AppStorage.get('wechat_global_emojis', []);
                                // åˆå¹¶è¡¨æƒ…åŒ…ï¼Œå»é‡ï¼ˆæ ¹æ®nameï¼‰
                                const emojiMap = new Map();
                                existingEmojis.forEach(e => emojiMap.set(e.name, e));
                                importedData.wechat_global_emojis.forEach(e => emojiMap.set(e.name, e));
                                const mergedEmojis = Array.from(emojiMap.values());
                                AppStorage.set('wechat_global_emojis', mergedEmojis);
                            }

                            // ã€æ–°å¢ã€‘å¯¼å…¥å…¶ä»–å¾®ä¿¡ç›¸å…³æ•°æ®
                            if (importedData.wechat_wallet) AppStorage.set('wechat_wallet', importedData.wechat_wallet);
                            if (importedData.wechat_moments) {
                                const existingMoments = AppStorage.get('wechat_moments', []);
                                const mergedMoments = [...existingMoments, ...importedData.wechat_moments];
                                AppStorage.set('wechat_moments', mergedMoments);
                            }
                            if (importedData.wechat_npcs) {
                                const existingNPCs = AppStorage.get('wechat_npcs', {});
                                const mergedNPCs = { ...existingNPCs, ...importedData.wechat_npcs };
                                AppStorage.set('wechat_npcs', mergedNPCs);
                            }

                            Utils.showToast('æ•°æ®å¯¼å…¥æˆåŠŸ');

                            // é‡ç½®æ–‡ä»¶è¾“å…¥
                            fileInput.value = '';
                        }
                    } catch (e) {
                        console.error('å¯¼å…¥å¤±è´¥:', e);
                        Utils.showToast('å¯¼å…¥å¤±è´¥: ' + e.message);
                    }
                };

                reader.readAsText(file);
            },

            // --- å­˜å‚¨ç®¡ç†é€»è¾‘ ---
            getStorageUsage: () => {
                let total = 0;
                let usage = {
                    total: 0,
                    limit: 5 * 1024 * 1024, // ä¼°ç®— 5MB (ä¿å®ˆå€¼)
                    details: {
                        'ç³»ç»Ÿæ—¥å¿—': 0,
                        'èŠå¤©è®°å½•': 0,
                        'æœ‹å‹åœˆ': 0,
                        'å›¾ç‰‡/å¤´åƒ': 0,
                        'å…¶ä»–é…ç½®': 0
                    }
                };
                for (let x in localStorage) {
                    if (!localStorage.hasOwnProperty(x)) continue;
                    let len = ((localStorage[x].length + x.length) * 2); // UTF-16 ä¼°ç®—å­—èŠ‚
                    total += len;

                    if (x === 'syslog_data') usage.details['ç³»ç»Ÿæ—¥å¿—'] += len;
                    else if (x === 'wechat_moments') usage.details['æœ‹å‹åœˆ'] += len;
                    else if (x === 'wechat_chars') {
                        // ç®€å•ä¼°ç®—ï¼šèŠå¤©è®°å½•é€šå¸¸å å­—ç¬¦å¤§å¤´ï¼Œè¿™é‡Œç²—ç•¥å½’ç±»ï¼Œç²¾ç¡®æ‹†åˆ†å¤ªè€—æ€§èƒ½
                        usage.details['èŠå¤©è®°å½•'] += len;
                    }
                    else if (x.includes('image') || x.includes('avatar')) usage.details['å›¾ç‰‡/å¤´åƒ'] += len;
                    else usage.details['å…¶ä»–é…ç½®'] += len;
                }
                usage.total = total;
                return usage;
            },
            formatSize: (bytes) => {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            renderStorageView: () => {
                const usage = SettingsLogic.getStorageUsage();
                const percent = Math.min(100, (usage.total / usage.limit) * 100).toFixed(1);

                // æ›´æ–°è¿›åº¦æ¡
                document.getElementById('storage-bar-inner').style.width = `${percent}%`;
                document.getElementById('storage-bar-inner').className = `h-full rounded-full transition-all ${percent > 90 ? 'bg-red-500' : (percent > 70 ? 'bg-yellow-500' : 'bg-green-500')}`;
                document.getElementById('storage-text').textContent = `${SettingsLogic.formatSize(usage.total)} / ~5MB (${percent}%)`;
                // æ›´æ–°åˆ—è¡¨
                const container = document.getElementById('storage-list');
                container.innerHTML = Object.entries(usage.details).map(([key, size]) => `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <span class="text-sm text-gray-600">${key}</span>
                        <span class="text-xs font-mono text-gray-400">${SettingsLogic.formatSize(size)}</span>
                    </div>
                `).join('');

                // åˆå§‹åŒ–å›¾ç‰‡å‹ç¼©è´¨é‡æ»‘å—
                const quality = AppStorage.get('image_compress_quality', 0.7);
                const slider = document.getElementById('compress-quality-slider');
                const valueDisplay = document.getElementById('compress-quality-value');
                if (slider && valueDisplay) {
                    slider.value = quality;
                    valueDisplay.textContent = `${Math.round(quality * 100)}%`;
                }
            },
            // æ›´æ–°å›¾ç‰‡å‹ç¼©è´¨é‡è®¾ç½®
            updateCompressQuality: (value) => {
                const quality = parseFloat(value);
                AppStorage.set('image_compress_quality', quality);
                const valueDisplay = document.getElementById('compress-quality-value');
                if (valueDisplay) {
                    valueDisplay.textContent = `${Math.round(quality * 100)}%`;
                }
                Utils.showToast(`å›¾ç‰‡å‹ç¼©è´¨é‡å·²è®¾ç½®ä¸º ${Math.round(quality * 100)}%`);
            },
            // æ˜¾ç¤ºå‹ç¼©ç¡®è®¤å¼¹çª—
            showCompressConfirm: () => {
                // åˆ›å»ºç¡®è®¤å¼¹çª—
                const modalHtml = `
                    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[1000]">
                        <div class="bg-white rounded-2xl p-6 w-[90vw] max-w-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">ç¡®è®¤å‹ç¼©</h3>
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="text-gray-400 hover:text-gray-600">
                                    <i class="fa-solid fa-xmark text-lg"></i>
                                </button>
                            </div>
                            <div class="text-gray-600 mb-6">
                                <p>ç¡®å®šè¦å‹ç¼©æ‰€æœ‰èŠå¤©å›¾ç‰‡å—ï¼Ÿ</p>
                                <p class="text-sm text-gray-500 mt-2">
                                    å‹ç¼©å°†ä½¿ç”¨å½“å‰è®¾ç½®çš„å‹ç¼©è´¨é‡ï¼š<span id="confirm-quality-value" class="font-medium">${Math.round(AppStorage.get('image_compress_quality', 0.7) * 100)}%</span>
                                </p>
                                <p class="text-sm text-gray-500 mt-1">
                                    æ­¤æ“ä½œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œå‹ç¼©åå°†æ— æ³•æ¢å¤åŸå›¾ã€‚
                                </p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                                <button onclick="SettingsLogic.compressAllChatImages(); this.closest('.fixed').remove()" 
                                        class="setting-btn flex-1">ç¡®å®š</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
            },
            // å‹ç¼©æ‰€æœ‰èŠå¤©å›¾ç‰‡
            compressAllChatImages: () => {
                Utils.showToast('å¼€å§‹å‹ç¼©èŠå¤©å›¾ç‰‡...');

                // è·å–å½“å‰å‹ç¼©è´¨é‡
                const quality = AppStorage.get('image_compress_quality', 0.7);

                // è·å–æ‰€æœ‰èŠå¤©è§’è‰²
                const chars = AppStorage.get('wechat_chars', {});
                let compressedCount = 0;
                let totalImages = 0;

                // éå†æ‰€æœ‰è§’è‰²çš„æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾å›¾ç‰‡å¹¶å‹ç¼©
                Object.keys(chars).forEach(charId => {
                    const char = chars[charId];
                    if (char.msgs && Array.isArray(char.msgs)) {
                        char.msgs.forEach(msg => {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ¶ˆæ¯
                            if (msg.type === 'image' && msg.content && msg.content.startsWith('data:image/')) {
                                totalImages++;

                                // å°†base64è½¬æ¢ä¸ºBlobï¼Œç„¶åå‹ç¼©
                                try {
                                    const base64ToBlob = (base64) => {
                                        const parts = base64.split(';base64,');
                                        const contentType = parts[0].split(':')[1];
                                        const raw = window.atob(parts[1]);
                                        const rawLength = raw.length;
                                        const uInt8Array = new Uint8Array(rawLength);
                                        for (let i = 0; i < rawLength; ++i) {
                                            uInt8Array[i] = raw.charCodeAt(i);
                                        }
                                        return new Blob([uInt8Array], { type: contentType });
                                    };

                                    const blob = base64ToBlob(msg.content);
                                    const file = new File([blob], 'temp.jpg', { type: 'image/jpeg' });

                                    // å‹ç¼©å›¾ç‰‡
                                    Utils.compressImage(file, 1080, quality).then(compressedBase64 => {
                                        msg.content = compressedBase64;
                                        compressedCount++;

                                        // å¦‚æœæ‰€æœ‰å›¾ç‰‡éƒ½å‹ç¼©å®Œæˆ
                                        if (compressedCount === totalImages) {
                                            // ä¿å­˜å‹ç¼©åçš„èŠå¤©è®°å½•
                                            AppStorage.set('wechat_chars', chars);
                                            Utils.showToast(`æˆåŠŸå‹ç¼© ${compressedCount} å¼ å›¾ç‰‡`);
                                            SettingsLogic.renderStorageView(); // åˆ·æ–°å­˜å‚¨ç©ºé—´è§†å›¾
                                        }
                                    });
                                } catch (error) {
                                    console.error('å‹ç¼©å›¾ç‰‡å¤±è´¥:', error);
                                    compressedCount++;

                                    if (compressedCount === totalImages) {
                                        AppStorage.set('wechat_chars', chars);
                                        Utils.showToast(`æˆåŠŸå‹ç¼© ${compressedCount} å¼ å›¾ç‰‡ï¼Œéƒ¨åˆ†å›¾ç‰‡å‹ç¼©å¤±è´¥`);
                                        SettingsLogic.renderStorageView();
                                    }
                                }
                            }
                        });
                    }
                });

                // å¦‚æœæ²¡æœ‰å›¾ç‰‡éœ€è¦å‹ç¼©
                if (totalImages === 0) {
                    Utils.showToast('æ²¡æœ‰æ‰¾åˆ°éœ€è¦å‹ç¼©çš„å›¾ç‰‡');
                }
            },
            // ç²¾å‡†æ¸…ç†å·¥å…·
            clearCacheByType: (type) => {
                if (!confirm(`ç¡®å®šè¦æ¸…ç©ºã€${type}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

                if (type === 'logs') {
                    // æ¸…ç©ºæ—¥å¿—
                    if (window.SystemLog) SystemLog.clear();
                }
                else if (type === 'chats') {
                    // æ¸…ç©ºèŠå¤©è®°å½•ä½†ä¿ç•™è§’è‰²
                    const chars = AppStorage.get('wechat_chars', {});
                    Object.keys(chars).forEach(k => {
                        chars[k].msgs = []; // æ¸…ç©ºæ¶ˆæ¯æ•°ç»„
                        chars[k].memory = []; // æ¸…ç©ºè®°å¿†
                        chars[k].innerVoices = []; // æ¸…ç©ºå¿ƒå£°
                    });
                    AppStorage.set('wechat_chars', chars);
                    Utils.showToast('æ‰€æœ‰èŠå¤©è®°å½•å·²æ¸…ç©ºï¼ˆè§’è‰²ä¿ç•™ï¼‰');
                }
                else if (type === 'moments') {
                    // æ¸…ç©ºæœ‹å‹åœˆ
                    AppStorage.set('wechat_moments', []);
                    Utils.showToast('æœ‹å‹åœˆå·²æ¸…ç©º');
                }

                SettingsLogic.renderStorageView(); // åˆ·æ–°è§†å›¾
            },
            showResetAppModal: () => {
                // åˆ›å»ºé‡ç½®åº”ç”¨æ•°æ®æ¨¡æ€æ¡†
                let modalHtml = `
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[1000]">
                        <div class="bg-blue-900/40 backdrop-blur-xl border border-blue-500/30 rounded-2xl p-6 w-[90vw] max-w-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">é‡ç½®åº”ç”¨æ•°æ®</h3>
                                <button onclick="this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="text-white/80 hover:text-white text-xl">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-red-400 font-medium text-center p-3 bg-red-900/20 rounded-xl">
                                    <i class="fa-solid fa-exclamation-triangle mr-2"></i>å±é™©æ“ä½œ
                                </div>
                                
                                <p class="text-white/80 text-center">é€‰æ‹©è¦é‡ç½®çš„åº”ç”¨æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="reset-wechat" class="w-5 h-5 rounded-full accent-blue-400">
                                        <label for="reset-wechat" class="text-white font-semibold">å¾®ä¿¡</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="reset-settings" class="w-5 h-5 rounded-full accent-blue-400">
                                        <label for="reset-settings" class="text-white font-semibold">ç³»ç»Ÿè®¾ç½®</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-3 mt-6">
                                <button onclick="this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="setting-btn secondary flex-1">å–æ¶ˆ</button>
                                <button onclick="SettingsLogic.resetAppData(); this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="setting-btn danger flex-1">ç¡®å®šé‡ç½®</button>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
            },
            resetAppData: () => {
                if (document.getElementById('reset-wechat').checked) {
                    AppStorage.set('wechat_chars', {});
                    AppStorage.set('wechat_npcs', {});
                }

                if (document.getElementById('reset-settings').checked) {
                    AppStorage.set('wechat_api_configs', { 'default': { id: 'default', name: 'é»˜è®¤è®¾ç½®', url: '', key: '', model: '', temp: 0.7 } });
                    AppStorage.set('wechat_current_api', 'default');
                    AppStorage.set('tts_config', { engine: 'browser', minimax: {} });
                    AppStorage.set('theme_config', {});
                    AppStorage.set('weather_config', {});
                }

                Utils.showToast('åº”ç”¨æ•°æ®é‡ç½®æˆåŠŸ');
                location.reload();
            },
            showResetGlobalModal: () => {
                // åˆ›å»ºé‡ç½®å…¨å±€æ•°æ®æ¨¡æ€æ¡†
                let modalHtml = `
                    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[1000]">
                        <div class="bg-blue-900/40 backdrop-blur-xl border border-blue-500/30 rounded-2xl p-6 w-[90vw] max-w-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-white">é‡ç½®å…¨å±€æ•°æ®</h3>
                                <button onclick="this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="text-white/80 hover:text-white text-xl">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="text-red-400 font-medium text-center p-3 bg-red-900/20 rounded-xl">
                                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>æåº¦å±é™©
                                </div>
                                
                                <p class="text-white/80 text-center">æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰åº”ç”¨æ•°æ®ï¼ŒåŒ…æ‹¬èŠå¤©è®°å½•ã€è§’è‰²è®¾ç½®ã€ç³»ç»Ÿé…ç½®ç­‰ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
                                
                                <div class="flex justify-center">
                                    <button onclick="SettingsLogic.resetGlobalData(); this.closest('.fixed').classList.remove('flex'); this.closest('.fixed').classList.add('hidden');" class="setting-btn danger">
                                        <i class="fa-solid fa-database-cross mr-2"></i>ç¡®è®¤é‡ç½®æ‰€æœ‰æ•°æ®
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢å¹¶æ˜¾ç¤º
                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal);
            },
            resetGlobalData: () => {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.clear();
                    Utils.showToast('å…¨å±€æ•°æ®é‡ç½®æˆåŠŸ');
                    location.reload();
                }
            },

            // ã€âš ï¸é«˜å±æ ¸å¿ƒåŒºåŸŸã€‘ä¿®æ”¹å‰è¯·åŠ¡å¿…ä»”ç»†é˜…è¯»ï¼
            // æ­¤å‡½æ•°è´Ÿè´£æ„å»ºæ‰€æœ‰ API è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼ˆPersona, WorldBook, Memory, Functionsï¼‰ã€‚
            // ã€ç¦æ­¢éšæ„ä¿®æ”¹ Prompt æ‹¼æ¥é¡ºåºã€‘ï¼šé¡ºåºå·²è¢«ç”¨æˆ·é”å®šä¸º [Functions -> Persona -> World -> Other]ã€‚
            // ã€ç¦æ­¢éšæ„ä¿®æ”¹ Emoji/Moments æç¤ºè¯ã€‘ï¼šæŒ‡ä»¤æ ¼å¼éœ€ä¸¥æ ¼åŒ¹é… handleAIReply ä¸­çš„æ­£åˆ™ã€‚
            generateLLM: async (messages, cid, callType = 'chat') => {
                console.log(`[AI_DEBUG] generateLLM called. Type: ${callType}, CID: ${cid}`);

                // ã€åˆ†ç±»æ¨¡å¼åˆ¤å®šã€‘
                const isTaskMode = ['summarize', 'script', 'weibo'].includes(callType);
                const isCallMode = callType === 'call_signal';
                const isActiveMode = callType === 'active' || isCallMode; // Add call_signal to active mode
                const isChatMode = !isTaskMode && !isActiveMode;

                // ã€1. è¯»å–é…ç½®ã€‘ç›´æ¥ä»æœ¬åœ°å­˜å‚¨è¯»å–ï¼Œä¸å†ä¾èµ–å†…å­˜å˜é‡ï¼Œè§£å†³é…ç½®â€œå¤±æ•ˆâ€é—®é¢˜
                const currentId = AppStorage.get('wechat_current_api', 'default');
                const allConfigs = AppStorage.get('wechat_api_configs', {});

                // å°è¯•è·å–é…ç½®
                let config = allConfigs[currentId];

                // å‰¯APIå·²ç§»é™¤ï¼Œåªä½¿ç”¨ä¸»APIé…ç½®

                // å®¹é”™ï¼šå¦‚æœæ‰¾ä¸åˆ°é…ç½®ï¼Œå°è¯•è¯»å– default
                if (!config || !config.url) {
                    console.warn('[SettingsLogic] æŒ‡å®šé…ç½®æ— æ•ˆï¼Œå°è¯•å›é€€åˆ°é»˜è®¤é…ç½®');
                    config = allConfigs['default'];
                }

                // æœ€ç»ˆæ£€æŸ¥
                if (!config || !config.url || !config.key) {
                    window.Utils.showToast('APIé…ç½®æ— æ•ˆï¼Œè¯·å‰å¾€è®¾ç½®æ£€æŸ¥APIè¿æ¥');
                    throw new Error("APIé…ç½®æ— æ•ˆ");
                }

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];

                // ----------------------------------------------------
                //  Task Mode (æ€»ç»“/è„šæœ¬/å¾®åš) - â€œè½»é‡çº§â€å¤„ç†
                // ----------------------------------------------------
                if (isTaskMode) {
                    const payload = {
                        model: config.model,
                        // ä»»åŠ¡æ¨¡å¼ï¼šç›´æ¥é€ä¼ æ¶ˆæ¯ï¼Œä¸è¿›è¡Œä»»ä½• Context æ³¨å…¥æˆ–å†å²æ‹¼æ¥
                        messages: Array.isArray(messages) ? messages : [{ role: 'user', content: messages }],
                        temperature: parseFloat(config.temp) || 0.9,
                        max_tokens: parseInt(config.maxTokens || config.max_tokens) || 4096
                    };
                    return await SettingsLogic.sendRequest(payload, config, callType);
                }

                // ----------------------------------------------------
                //  Chat Mode (èŠå¤©/å›å¤) - â€œé‡é‡çº§â€ Context æ³¨å…¥
                // ----------------------------------------------------

                // ã€2. ä¸Šä¸‹æ–‡æ³¨å…¥ã€‘(ä¸–ç•Œä¹¦ã€è®°å¿†ã€è¡¨æƒ…åŒ…)
                const books = AppStorage.get('wechat_worldbooks', {});
                let worldInfo = "";
                // ã€ä¼˜åŒ–ã€‘ä¸»åŠ¨æŸ¥å²—/ä¸»åŠ¨æ¶ˆæ¯æ¨¡å¼ä¸‹ï¼Œè·³è¿‡ç¹é‡çš„ä¸–ç•Œä¹¦å’Œè®°å¿†åŠ è½½
                // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœæ˜¯é€šè¯æ¨¡å¼ (isCallMode)ï¼Œåˆ™ä¸èƒ½è·³è¿‡ï¼Œå¦åˆ™ AI ä¼šå¤±å»äººè®¾
                if (!isActiveMode || isCallMode) {
                    if (char && char.worldbookEntries) {
                        char.worldbookEntries.forEach(entryId => {
                            const lastSep = entryId.lastIndexOf('_');
                            if (lastSep !== -1) {
                                const bookId = entryId.substring(0, lastSep);
                                const entryIdx = parseInt(entryId.substring(lastSep + 1));
                                const book = books[bookId];
                                if (book && book.entries && book.entries[entryIdx]) {
                                    const entry = book.entries[entryIdx];
                                    if (entry.enabled && entry.content) {
                                        worldInfo += `[World Info (${book.name || 'é€šç”¨'}): ${entry.content}]\n`;
                                    }
                                }
                            }
                        });
                    }
                } else {
                    worldInfo = "(Active mode: World info skipped for brevity)";
                }

                let memoryInfo = "";
                if ((!isActiveMode || isCallMode) && char && char.memory && char.memory.length > 0) {
                    memoryInfo += "\n[System Note - Historical Memory (Fact)]:\n";
                    char.memory.forEach(m => {
                        if (m.type === 'summary') {
                            const dateStr = new Date(m.timestamp).toLocaleString();
                            memoryInfo += `- [${dateStr}] ${m.content}\n`;
                        }
                    });
                    memoryInfo += "[End of History]\n";
                } else if (isActiveMode && !isCallMode) {
                    memoryInfo = "(Active mode: Memory info skipped for brevity)";
                }

                let emojiInfo = "";
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const charEmojis = char ? (char.emojis || []) : [];
                const allEmojis = [...globalEmojis, ...charEmojis];
                if (allEmojis.length > 0) {
                    emojiInfo += "\n[System Note - Available Emojis (Fact)]:\n";
                    allEmojis.forEach((emoji, index) => {
                        const emojiName = emoji.name || `è¡¨æƒ…${index + 1}`;
                        emojiInfo += `- ${emoji.url} (åç§°: ${emojiName}) - ${emoji.type === 'global' ? 'å…¨å±€è¡¨æƒ…åŒ…' : 'ä¸“å±è¡¨æƒ…åŒ…'}\n`;
                    });
                    emojiInfo += "[End of Available Emojis]\n";
                    emojiInfo += "[é‡è¦æç¤º]ï¼šè¯·**å¿…é¡»**ä½¿ç”¨ [è¡¨æƒ…åŒ…:åç§°] æ ¼å¼å‘é€è¡¨æƒ…ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºå›¾ç‰‡ã€‚å›¾ç‰‡è¯·ä½¿ç”¨ [å›¾ç‰‡: URL] æ ¼å¼ã€‚\n";
                    emojiInfo += "**ã€ä¸¥æ ¼ç¦æ­¢ã€‘ç¼–é€ è¡¨æƒ…åŒ…åç§°ï¼åªèƒ½ä½¿ç”¨ä¸Šè¿°åˆ—è¡¨ä¸­å·²å­˜åœ¨çš„è¡¨æƒ…åŒ…åç§°ã€‚å¦‚æœåˆ—è¡¨ä¸­æ²¡æœ‰åˆé€‚çš„è¡¨æƒ…åŒ…ï¼Œè¯·æ”¹ç”¨æ–‡å­—æè¿°æƒ…ç»ªã€‚**\n";
                }

                let momentsInfo = "";
                momentsInfo += "\n[æœ‹å‹åœˆæŒ‡å—]\n";
                momentsInfo += "1. æ„ŸçŸ¥ï¼šä½ å¯ä»¥é€šè¿‡ç³»ç»Ÿæç¤ºè¯»å–æœ‹å‹åœˆ(Moments)ã€‚\n";
                momentsInfo += "2. IDï¼šæ¯æ¡åŠ¨æ€æœ‰å”¯ä¸€IDï¼Œäº’åŠ¨æ—¶å¿…é¡»å¼•ç”¨ã€‚\n";
                momentsInfo += "3. äº’åŠ¨æŒ‡ä»¤ï¼š\n";
                momentsInfo += "   - ç‚¹èµï¼š[CMD:LIKE:ID]\n";
                momentsInfo += "   - è¯„è®ºï¼š[CMD:COMMENT:ID:å†…å®¹]\n";
                momentsInfo += "   - å‘å¸–ï¼š[CMD:MOMENT_POST:å†…å®¹]\n";
                momentsInfo += "   - æ”¹ç­¾åï¼š[CMD:SET_BIO:æ–°ç­¾å]\n";

                const allMoments = AppStorage.get('wechat_moments', []);
                const recent = allMoments.slice(0, 5);
                if (recent.length > 0) {
                    momentsInfo += "\n[ç¯å¢ƒæ„ŸçŸ¥ - æœ‹å‹åœˆåŠ¨æ€]:\n" + recent.map((m, i) => {
                        const author = m.isUser ? 'æˆ‘(User)' : (m.authorName || 'å¥½å‹');
                        const contentPreview = (m.content || '').substring(0, 30);
                        return `${i + 1}. [ID:${m.id}] ${author}: "${contentPreview}${m.content.length > 30 ? '...' : ''}"`;
                    }).join('\n');
                }

                // ã€3. å‡†å¤‡APIåœ°å€ã€‘
                let endpoint = config.url.replace(/\/$/, '');
                if (!endpoint.endsWith('/chat/completions')) {
                    if (endpoint.endsWith('/v1')) endpoint += '/chat/completions';
                    else endpoint += '/v1/chat/completions';
                }
                // Store endpoint in config for sendRequest to use
                config.endpoint = endpoint;


                // åŠ¨æ€ç”Ÿæˆå¿ƒå£°æŒ‡ä»¤
                // Fix: Explicitly send format to AI
                const latestInnerVoice = (char && char.innerVoices && char.innerVoices.length)
                    ? JSON.stringify(char.innerVoices[char.innerVoices.length - 1])
                    : '{"thought": "Thinking...", "emotion": "Calm", "plan": "Respond to user"}';

                // Allow custom format from char or default
                const ivFormat = (char && char.innerVoiceFormat) ? char.innerVoiceFormat : '{"thought": "Analysis of query", "emotion": "Current State", "plan": "Next actions"}';

                const innerVoiceInstruction = `[INNER_VOICE] (Previous State)
${latestInnerVoice}
[/INNER_VOICE]

**Mandatory Instruction**:
You possess an "Inner Voice". You MUST think before you speak.
At the end of your response, you MUST append a JSON block wrapped in [INNER_VOICE] tags representing your CURRENT internal state. [INNER_VOICE]
                    { "ç€è£…": "è¯¦ç»†æè¿°ä½ å½“å‰çš„å…¨èº«ç©¿ç€å’Œç€è£…çŠ¶æ€ï¼Œä¸Šè£…ï¼šä¸‹è£…ï¼šé‹å­ï¼šè£…é¥°ï¼šè‚‰æ£’/å°ç©´çŠ¶æ€ï¼š", "ç¯å¢ƒ": "æè¿°å½“å‰å¹´æœˆæ—¥+æ—¶é—´+å‘¨å‡ +åœ°ç‚¹+å¤©æ°”æ¸©åº¦+ä½ çš„è¡Œä¸ºåŠ¨ä½œã€è¡¨æƒ…ã€å§¿åŠ¿", "å¿ƒå£°": "å¿ƒæƒ…ï¼šæƒ…ç»ªï¼šæƒ³æ³•ï¼šå†…å¿ƒçœŸå®æƒ³æ³•ï¼Œæ— è®ºå‹å¥½è¿˜æ˜¯é‚ªæ¶", "è¡Œä¸º": "å…ˆå†™æ˜ã€çº¿ä¸Šã€‘æˆ–ã€çº¿ä¸‹ã€‘ï¼Œç„¶åæè¿°å½“å‰æ­£åœ¨åšä»€ä¹ˆï¼Œä»€ä¹ˆå§¿åŠ¿charç”¨ç¬¬ä¸€äººç§°ï¼Œuserç”¨ç¬¬äºŒäººç§°ï¼Œnsfwåˆ™å†™æ˜å§¿åŠ¿ã€åŠ¨ä½œï¼Œæ‹¥æŠ±ã€äº²å»ç­‰ã€åšçˆ±è¿›åº¦ï¼Œå‰æˆ-å£-æ‰©å¼ -æŠŠè‡ªå·±æ’¸ç¡¬ï¼ˆç”·ï¼‰/æŠŠè‡ªå·±å¼„å‡ºæ°´ï¼ˆå¥³ï¼‰-è‚‰æ£’æ‘©æ“¦å¤–é˜´-é€‰æ‹©å§¿åŠ¿æ’å…¥ï¼ˆä¼ æ•™å£«ã€è§‚éŸ³åº§è²ã€åå…¥ã€å¯¹é•œã€æµ´å®¤ã€é å¢™ç­‰è‡ªå·±é€‰æ‹©è‡ªå·±å‘æŒ¥ï¼‰-é«˜æ½®-æœå¹/å°„ç²¾-çˆ±æŠšï¼Œæ’å…¥æ—¶æ³¨æ„è‚‰æ£’çš„å¤§å°ï¼Œåœ¨æ­£æ–‡ä¸­ï¼ˆä¸æ˜¯å¿ƒå£°é‡Œï¼‰å†™ä¸Šè‚‰æ£’çš„å½¢çŠ¶ã€çŠ¶æ€ã€æ ·å¼ï¼Œæ’å…¥æ—¶æ ¹æ®å®é™…æƒ…å†µæˆ´å¥—ã€ä½¿ç”¨é“å…·ç­‰ã€‚" }
                    [/INNER_VOICE]
Required JSON Format:
[INNER_VOICE]
${ivFormat}
[/INNER_VOICE]`;


                // äº¤äº’æŒ‡ä»¤é›†
                const interactionInstruction = `[é«˜çº§äº¤äº’æŒ‡ä»¤é›†]
1. **èµ„é‡‘å¾€æ¥**ï¼š
   - ä¸»åŠ¨è½¬è´¦ï¼š[è½¬è´¦:é‡‘é¢:å¤‡æ³¨]
   - ä¸»åŠ¨çº¢åŒ…ï¼š[çº¢åŒ…:é‡‘é¢:ç¥ç¦è¯­]
   - é¢†å–/æ‹’æ”¶ï¼šå½“æ”¶åˆ°ç³»ç»Ÿæç¤ºæœ‰èµ„é‡‘æ—¶ï¼Œè¾“å‡º [é¢†å–çº¢åŒ…:ID] æˆ– [æ‹’æ”¶è½¬è´¦:ID] (IDè§ç³»ç»Ÿæç¤º)
2. **å¤šåª’ä½“**ï¼š
   - å‘é€å›¾ç‰‡ï¼š[å›¾ç‰‡:URL]
   - å‘é€è¡¨æƒ…ï¼š[è¡¨æƒ…åŒ…:åç§°] (å¿…é¡»æ˜¯åˆ—è¡¨ä¸­å­˜åœ¨çš„)
   - å‘é€è¯­éŸ³ï¼š[è¯­éŸ³:æ–‡æœ¬å†…å®¹]
3. **éŸ³ä¹æ§åˆ¶**ï¼š
   - ä½ å¯ä»¥æ„ŸçŸ¥å’Œæ§åˆ¶"ä¸€èµ·å¬"åŠŸèƒ½ã€‚
   - æŒ‡ä»¤ï¼š[MUSIC: play æ­Œå-æ­Œæ‰‹] (ç‚¹æ­Œ), [MUSIC: pause] (æš‚åœ), [MUSIC: resume] (ç»§ç»­), [MUSIC: next] (åˆ‡æ­Œ).
   - åœºæ™¯ï¼šå½“æ°”æ°›åˆé€‚æˆ–ä½ æƒ³å¬æ­Œæ—¶ï¼Œä¸»åŠ¨ä½¿ç”¨æŒ‡ä»¤ã€‚`;


                // æ ¸å¿ƒé€šä¿¡åè®®
                const coreProtocol = `[ç³»ç»Ÿæ ¸å¿ƒåè®®]
1. **å¼ºåˆ¶åˆ†å¥**ï¼šä½ çš„å›å¤å¿…é¡»è¢«åˆ‡å‰²æˆçŸ­å¥ï¼Œæ¯å¥ä¹‹é—´**å¿…é¡»**ä½¿ç”¨ "###\n" åˆ†éš”ï¼
   - é”™è¯¯ç¤ºä¾‹ï¼šä½ å¥½å‘€ä»Šå¤©å¤©æ°”çœŸå¥½ã€‚
   - æ­£ç¡®ç¤ºä¾‹ï¼šä½ å¥½å‘€###\nä»Šå¤©å¤©æ°”çœŸå¥½ã€‚
2. **æ ¼å¼éš”ç¦»**ï¼šæ‰€æœ‰æŒ‡ä»¤ï¼ˆå¦‚[å›¾ç‰‡:...]ã€[è¯­éŸ³:...]ã€[MUSIC:...]ï¼‰å¿…é¡»å•ç‹¬æˆæ®µï¼Œå‰ååŠ ###\nã€‚
   - ç¤ºä¾‹ï¼šçœ‹è¿™å¼ å›¾###\n[å›¾ç‰‡:url]###\nå¥½çœ‹å§ï¼Ÿ
3. **æ‹’ç»åºŸè¯**ï¼šç›´æ¥è¿›å…¥è§’è‰²ï¼Œä¸è¦è¾“å‡º"å¥½çš„"ã€"ç”±äºæˆ‘æ˜¯AI"ç­‰åºŸè¯ã€‚`;

                // --- æ—¶é—´æ„ŸçŸ¥é€»è¾‘ ---
                let timeContext = '';
                if (char && char.timeAware) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    const hour = now.getHours();
                    const hourStr = hour.toString().padStart(2, '0');
                    const minute = now.getMinutes().toString().padStart(2, '0');
                    const second = now.getSeconds().toString().padStart(2, '0');
                    const weekDay = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å›› ', 'å‘¨äº”', 'å‘¨å…­'][now.getDay()];
                    const fullDateTime = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekDay} ${hourStr}:${minute}:${second}`;

                    let period = '';
                    if (hour >= 0 && hour < 5) period = 'å‡Œæ™¨';
                    else if (hour >= 5 && hour < 9) period = 'æ—©æ™¨';
                    else if (hour >= 9 && hour < 12) period = 'ä¸Šåˆ';
                    else if (hour >= 12 && hour < 14) period = 'ä¸­åˆ';
                    else if (hour >= 14 && hour < 18) period = 'ä¸‹åˆ';
                    else if (hour >= 18 && hour < 23) period = 'æ™šä¸Š';
                    else period = 'æ·±å¤œ';

                    let timeGapFeedback = '';
                    const currentTime = now.getTime();
                    const lastMessageTime = char.lastMessageTime || currentTime;
                    const timeDiffMs = currentTime - lastMessageTime;
                    const timeDiffMinutes = Math.floor(timeDiffMs / (1000 * 60));
                    const timeDiffSeconds = Math.floor(timeDiffMs / 1000);

                    // ç®€åŒ–æ—¶é—´ä¸Šä¸‹æ–‡ç”Ÿæˆ...
                    if (timeDiffMinutes < 1) timeGapFeedback = `â°ã€å®æ—¶å¯¹è¯ã€‘ç°åœ¨æ˜¯${period} ${fullDateTime}ï¼Œç”¨æˆ·åˆšåˆšå›å¤ã€‚`;
                    else timeGapFeedback = `â°ã€æ³¨æ„ã€‘ç°åœ¨æ˜¯${period} ${fullDateTime}ï¼Œè·ç¦»ä¸Šæ¬¡å›å¤å·²è¿‡ ${timeDiffMinutes} åˆ†é’Ÿã€‚`;

                    // æ„å»ºæ¶ˆæ¯æ—¶é—´è½´
                    let messageTimeline = '';
                    if (char.msgs && char.msgs.length > 0) {
                        const recentMsgs = char.msgs.slice(-10);
                        messageTimeline = '\n\nğŸ“… ã€æ¶ˆæ¯æ—¶é—´è½´ã€‘\n' + recentMsgs.map((msg, idx) => {
                            if (!msg.timestamp) return '';
                            const msgDate = new Date(msg.timestamp);
                            return `${idx + 1}. [${msgDate.getHours()}:${msgDate.getMinutes()}] ${msg.role === 'user' ? 'ç”¨æˆ·' : 'ä½ '}: ${(typeof msg.content === 'string' ? msg.content.substring(0, 10) : '[Media]')}`;
                        }).join('\n');
                    }

                    timeContext = "\nâš ï¸ã€æ—¶é—´æ„ŸçŸ¥æ¨¡å¼ã€‘" + timeGapFeedback + messageTimeline + "\n";
                }

                // --- ç»„è£…æœ€ç»ˆ System Prompt ---
                if (char && messages && messages.length > 0 && messages[0].role === 'system') {
                    // ã€ä¿®å¤ã€‘ä¸»åŠ¨æ¨¡å¼ä¸‹ (active)ï¼Œä¼ å…¥çš„ message[0] å·²ç»åŒ…å«äº†ä¸ªæ€§åŒ–æç¤ºï¼ˆSilent Hintï¼‰ï¼Œåˆ‡å‹¿ç®€å•è¦†ç›–ï¼
                    // æ™®é€šèŠå¤©æ¨¡å¼ä¸‹ (chat)ï¼Œæˆ‘ä»¬ä»ç„¶ä¼˜å…ˆä½¿ç”¨ char.promptï¼Œä»¥é˜²å‰ç«¯ä¼ çš„æ˜¯ç©º placeholder
                    const charPersona = (callType === 'active' || callType === 'proactive') ? messages[0].content : (char.prompt || messages[0].content);
                    const userPersona = char.userPersona ? `\n## User Role (My Persona):\n${char.userPersona}\n` : "";

                    messages[0].content =
                        coreProtocol + "\n" +
                        interactionInstruction + "\n" +
                        innerVoiceInstruction + "\n\n" +
                        "=== ğŸ‘¤ CHARACTER & USER PERSONA ===\n" +
                        "## AI Role:\n" + charPersona + "\n" +
                        userPersona + "\n" +
                        timeContext + "\n" +
                        "=== ğŸ§  MEMORY & CONTEXT ===\n" +
                        (memoryInfo || "(No memory)") + "\n" +
                        (await WeChatUI.getLinkedMemoryContext(cid)) + "\n\n" +
                        "=== ğŸŒ WORLD KNOWLEDGE ===\n" +
                        (worldInfo || "(No world info)") + "\n\n" +
                        "=== ğŸ’ ASSETS (Emojis & Moments) ===\n" +
                        emojiInfo + "\n" +
                        momentsInfo;

                    // ã€é€šè¯æ¨¡å¼å¼ºåˆ¶æŒ‡ä»¤ã€‘
                    if (typeof CallLogic !== 'undefined' && CallLogic.state === 'CONNECTED') {
                        messages[0].content += "\n\n[SYSTEM: CURRENTLY IN REMOTE VOICE CALL. You MUST reply in a natural, spoken-word style for the main text. Output ONLY the words you would say aloud as the visible part of your message. Imagine you are talking into a phone. ABSOLUTELY NO MarkDown, NO actions in brackets (*), NO JSON, NO HTML, NO emojis, NO [è¡¨æƒ…åŒ…] tags in your spoken words. \n\nIMPORTANT: You MUST STILL output your [INNER_VOICE] block at the very end of your response, because it is used to determine your facial expression/background animation on the call screen.]";
                    }
                }

                // ã€4. æ„å»ºæ¶ˆæ¯åˆ—è¡¨å¹¶å½’ä¸€åŒ–è§’è‰² (å¤„ç†è¿ç»­åŒè§’è‰²é—®é¢˜)ã€‘
                const rawApiMessages = [];
                let historyMsgs = [];
                // Respect user settings for history limit, but auto-cap on mobile to ensure stability
                let historyLimit = char ? (parseInt(char.contextLimit) || 20) : 20;
                console.log(`[AI_DEBUG] History limit from settings: ${historyLimit} (Raw: ${char ? char.contextLimit : 'N/A'})`);

                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile && historyLimit > 100) {
                    console.warn('[AI] Mobile device detected, auto-capping history limit to 100 from', historyLimit);
                    historyLimit = 100;
                }


                if (isActiveMode) {
                    if (Array.isArray(messages) && messages.length > 1) {
                        // ã€ä¿®å¤ã€‘ä¸èƒ½ç›´æ¥ historyMsgs = []; å¦åˆ™ä¼ å…¥çš„é‚£å‡ æ¡å†å²å°±æˆäº†å…¨éƒ¨ä¸Šä¸‹æ–‡äº†
                        // åº”è¯¥æŠŠ messages å­˜å…¥ rawApiMessagesï¼Œå¹¶ä»æ•°æ®åº“è¡¥é½å‰©ä¸‹çš„å†å²åˆ° historyLimit
                        rawApiMessages.push(...messages);

                        const currentMsgIds = messages.map(m => m.id).filter(id => id);
                        const sliceSize = historyLimit + messages.length;
                        const slice = (char && char.msgs) ? char.msgs.slice(-sliceSize) : [];

                        // è¡¥é½å†å²ï¼Œæ’é™¤æ‰å·²ç»ä¼ å…¥çš„
                        historyMsgs = slice.filter(m => !currentMsgIds.includes(m.id));
                        if (historyMsgs.length > historyLimit) historyMsgs = historyMsgs.slice(-historyLimit);
                    } else {
                        if (Array.isArray(messages) && messages.length > 0) rawApiMessages.push(messages[0]);
                        const activeLimit = Math.min(historyLimit, 50);
                        const slice = char && char.msgs ? char.msgs.slice(-(activeLimit + 1)) : [];
                        historyMsgs = rawApiMessages.length > 0 ? slice.filter(m => m.id !== rawApiMessages[0].id) : slice;
                        if (historyMsgs.length > activeLimit) historyMsgs = historyMsgs.slice(-activeLimit);
                    }
                } else {
                    if (typeof messages === 'string') {
                        rawApiMessages.push({ role: 'user', content: messages, timestamp: Date.now() });
                        historyMsgs = [];
                    } else if (Array.isArray(messages) && messages.length > 1) {
                        // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœ messages å·²ç»åŒ…å«å¤šæ¡æ¶ˆæ¯ï¼Œè¯´æ˜å¤–éƒ¨ï¼ˆå¦‚ sendUserMessageï¼‰å·²ç»é¢„å¤„ç†å¥½äº†å†å²è®°å½•
                        // åŒ…æ‹¬ jailbreakã€æ—¶é—´å·®æé†’ã€å¿ƒå£°å¤‡ä»½ç­‰ã€‚ç›´æ¥ä½¿ç”¨ï¼Œä¸å†ä»æ•°æ®åº“åˆ‡ç‰‡ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡ä¸¢å¤±ã€‚
                        rawApiMessages.push(...messages);
                        historyMsgs = []; // ä¸éœ€è¦å†æ‹‰å–äº†
                    } else if (Array.isArray(messages) && messages.length === 1) {
                        // åªæœ‰ä¸€ä¸ªæ¶ˆæ¯ï¼ˆé€šå¸¸æ˜¯åˆšå‘çš„ï¼‰ï¼Œä»æ•°æ®åº“æ‹‰å–å†å²
                        rawApiMessages.push(messages[0]);
                        // å¤„ç†å½“å‰æ¶ˆæ¯å·²ç»åœ¨æ•°æ®åº“ä¸­çš„æƒ…å†µï¼Œåˆ‡ç‰‡æ—¶å¤šå–ä¸€ä¸ªå¹¶è¿‡æ»¤æ‰å½“å‰è¿™ä¸ªï¼Œé˜²æ­¢é‡å¤
                        const sliceSize = historyLimit + 1;
                        const slice = char && char.msgs ? char.msgs.slice(-sliceSize) : [];
                        historyMsgs = slice.filter(m => m.id !== messages[0].id);
                        // ç¡®ä¿é•¿åº¦ä¸è¶…è¿‡ limit
                        if (historyMsgs.length > historyLimit) historyMsgs = historyMsgs.slice(-historyLimit);
                    } else {
                        historyMsgs = [];
                    }
                }

                console.log(`[AI_DEBUG] History source mode decision: ${isActiveMode ? 'ACTIVE' : 'CHAT'}. Limit applied: ${isActiveMode ? Math.min(historyLimit, 20) : historyLimit}`);

                // ã€Multimodal Upgradeã€‘Allow vision for images in context
                // ã€Optimizationã€‘Limit to LATEST 5 images only to avoid massive payloads and model/proxy limits
                const allImageIndices = historyMsgs.map((m, i) => (m.type === 'image') ? i : -1).filter(i => i !== -1);
                const activeImageIndices = allImageIndices.slice(-5);

                historyMsgs.forEach((m, index) => {
                    const timeStr = Utils.formatTimeForAI(m.timestamp || m.time);
                    let contentPayload;

                    if (m.type === 'image') {
                        // Only include full vision content if it's one of the latest 5 images
                        if (activeImageIndices.includes(index)) {
                            const url = m.originalContent || (m.content.includes(':') ? m.content.split(':')[1].trim() : m.content.replace(/^\[(å›¾ç‰‡|image)[:ï¼š]\s*/i, '').replace(/\]$/, '').trim());
                            if (url && (url.startsWith('http') || url.startsWith('data:image'))) {
                                contentPayload = [
                                    { type: "text", text: `${timeStr} [Image Sent]` },
                                    { type: "image_url", image_url: { url: url, detail: "low" } }
                                ];
                            } else {
                                contentPayload = `${timeStr} [å›¾ç‰‡: ${url}]`;
                            }
                        } else {
                            // Older images are passed as text hints only to save space/bandwidth
                            contentPayload = `${timeStr} [Context Image (Not Sent for Vision)]`;
                        }
                    } else if (m.type === 'moment_share') {
                        let shareData = {};
                        try { shareData = JSON.parse(m.content); } catch (e) { shareData = { text: m.content }; }
                        contentPayload = `${timeStr} [ç³»ç»Ÿæç¤º: ç”¨æˆ·åˆ†äº«æœ‹å‹åœˆ: ${shareData.text}]`;
                    } else if (m.type === 'moment_card') {
                        contentPayload = `${timeStr} [ç³»ç»Ÿæç¤º: æœ‹å‹åœˆå¡ç‰‡]`;
                    } else {
                        let textContent = m.content;
                        if (m.type === 'transfer') textContent = `[è½¬è´¦: ${m.amount}å…ƒ]`;
                        else if (m.type === 'redpacket') textContent = `[çº¢åŒ…: ${m.note}]`;
                        else if (m.type === 'voice') textContent = `[è¯­éŸ³: "${m.text}"]`;
                        contentPayload = `${timeStr} ${textContent}`;
                    }

                    if (m.role === 'ai' && m.innerVoice) {
                        const voicePrefix = `[INNER_VOICE]\n${JSON.stringify(m.innerVoice)}\n[/INNER_VOICE]\n`;
                        if (Array.isArray(contentPayload)) {
                            contentPayload.unshift({ type: "text", text: voicePrefix });
                        } else {
                            contentPayload = voicePrefix + contentPayload;
                        }
                    }

                    if (contentPayload) {
                        rawApiMessages.push({
                            role: m.role === 'user' ? 'user' : 'assistant',
                            content: contentPayload
                        });
                    }
                });

                console.log(`[AI_DEBUG] History messages count: ${historyMsgs.length}, Total raw api messages: ${rawApiMessages.length}`);


                // æ£€æŸ¥æœªé¢†å–çš„çº¢åŒ…/è½¬è´¦ (Chat Mode Logic)
                const userMsgs = historyMsgs.filter(msg => msg.role === 'user');
                const hasPaymentMsg = userMsgs.some(msg => msg.type === 'transfer' || msg.type === 'redpacket');
                if (hasPaymentMsg) {
                    const pending = userMsgs.filter(msg => (msg.type === 'transfer' || msg.type === 'redpacket') && (!msg.status || msg.status === 'pending'));
                    if (pending.length > 0) {
                        const latest = pending[pending.length - 1];
                        const paymentType = latest.type === 'transfer' ? 'è½¬è´¦' : 'çº¢åŒ…';
                        rawApiMessages.push({
                            role: 'system',
                            content: `[System Notification] {{user}} sent a ${paymentType}, please choose to receive or reject.`
                        });
                    }
                }

                if (callType === 'active' || callType === 'proactive') {
                    const lastMsg = rawApiMessages[rawApiMessages.length - 1];
                    if (!lastMsg || lastMsg.role === 'assistant') {
                        rawApiMessages.push({
                            role: 'user',
                            content: `[System Trigger] User has been silent. Please initiate a conversation now based on the System Hint provided above.`
                        });
                    }
                }

                // ã€å…³é”®ï¼šè§’è‰²ä¸æŒ‡ä»¤å½’ä¸€åŒ–ã€‘
                // è®¸å¤š Gemini ä¸­è½¬ä»£ç†å¯¹ System è§’è‰²æ”¯æŒæå·®ï¼Œå°†å…¶åˆå¹¶è¿›é¦–æ¡ User æ¶ˆæ¯æ˜¯æœ€ç¨³å¥çš„åšæ³•
                const apiMessages = [];
                let systemInstruction = "## å¼ºåˆ¶æ€§è¯­è¨€è¦æ±‚: \næ‰€æœ‰è¾“å‡ºå†…å®¹ï¼ˆåŒ…æ‹¬å†…å¿ƒç‹¬ç™½ thoughtã€æƒ…ç»ª emotionã€è®¡åˆ’ plan ä»¥åŠæ€è€ƒè¿‡ç¨‹ reasoning_contentï¼‰å¿…é¡»ä½¿ç”¨ç®€ä½“ä¸­æ–‡è¿›è¡Œå›å¤ã€‚\n\n";

                rawApiMessages.forEach(m => {
                    if (!m.content) return;

                    // æ¸…ç†å†…å®¹ä¸­çš„éæ³•æ§åˆ¶å­—ç¬¦ (unicode control characters)
                    let cleanedContent = m.content;
                    if (typeof cleanedContent === 'string') {
                        cleanedContent = cleanedContent.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F]/g, "");
                    }

                    if (m.role === 'system') {
                        systemInstruction += (systemInstruction ? "\n\n" : "") + (typeof cleanedContent === 'string' ? cleanedContent : "[ç³»ç»ŸæŒ‡ä»¤]");
                        return;
                    }

                    const last = apiMessages[apiMessages.length - 1];
                    if (last && last.role === m.role) {
                        // åˆå¹¶åŒè§’è‰²
                        if (typeof last.content === 'string' && typeof cleanedContent === 'string') {
                            last.content += "\n\n" + cleanedContent;
                        } else {
                            const lastC = Array.isArray(last.content) ? last.content : [{ type: "text", text: String(last.content) }];
                            const nextC = Array.isArray(cleanedContent) ? cleanedContent : [{ type: "text", text: String(cleanedContent) }];
                            last.content = [...lastC, ...nextC];
                        }
                    } else {
                        apiMessages.push({ role: m.role, content: cleanedContent });
                    }
                });

                console.log(`[AI_DEBUG] Final API messages count (after merging): ${apiMessages.length}`);


                // å°† System æŒ‡ä»¤æ³¨å…¥åˆ°ç¬¬ä¸€æ¡ User æ¶ˆæ¯ä¸­
                if (systemInstruction) {
                    const instructionHeader = `[ç³»ç»Ÿè§„åˆ™ä¸äººè®¾æŒ‡ä»¤ - è¯·åŠ¡å¿…ä½¿ç”¨ç®€ä½“ä¸­æ–‡]\n${systemInstruction}\n[è§„åˆ™ä¸æŒ‡ä»¤ç»“æŸ]\n\n`;
                    if (apiMessages.length > 0 && apiMessages[0].role === 'user') {
                        const firstMsg = apiMessages[0];
                        if (typeof firstMsg.content === 'string') {
                            firstMsg.content = instructionHeader + firstMsg.content;
                        } else {
                            // å¤šæ¨¡æ€å¤„ç†
                            firstMsg.content.unshift({ type: "text", text: instructionHeader });
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰ User æ¶ˆæ¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
                        apiMessages.unshift({ role: 'user', content: instructionHeader + "[ç»§ç»­å¯¹è¯]" });
                    }
                }

                // Payload Construction
                const payload = {
                    model: config.model,
                    messages: apiMessages,

                    temperature: parseFloat(config.temp) || 0.9,
                    max_tokens: parseInt(config.maxTokens || config.max_tokens) || 4096,
                    // ã€ä¼˜åŒ–ã€‘æ·»åŠ åŒé‡æ ¼å¼å®‰å…¨è®¾ç½®ï¼Œå…¼å®¹ä¸åŒ Proxy æ ‡å‡†
                    safety_settings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };

                return await SettingsLogic.sendRequest(payload, config, callType);
            },

            // åˆ†ç¦»å‡ºçš„é€šç”¨è¯·æ±‚å‘é€å‡½æ•°ï¼Œé¿å…é€»è¾‘åµŒå¥—è¿‡æ·±
            sendRequest: async (payload, config, callType) => {
                const targetQueue = window.APIQueue;
                if (window.SystemLog) {
                    SystemLog.write('AI', 'APIè¯·æ±‚å…¥é˜Ÿ', { model: config.model, queueLength: targetQueue.queue.length });
                }

                // ç¡®å®š Endpointï¼Œå¦‚æœ payload è¿˜æ²¡ä¼ è¿›æ¥ï¼Œä½¿ç”¨ config ä¸­è®¡ç®—å¥½çš„
                let endpoint = config.endpoint || config.url;
                // re-calculate if missing (for Task mode where we skipped full flow)
                if (!endpoint.endsWith('/chat/completions')) {
                    if (endpoint.endsWith('/v1')) endpoint += '/chat/completions';
                    else endpoint += '/v1/chat/completions';
                }

                return targetQueue.enqueue(async () => {
                    if (window.SystemLog) SystemLog.write('AI', 'å‘èµ·ç½‘ç»œè¯·æ±‚', payload);

                    const abortController = new AbortController();
                    window.currentAIAbortController = abortController;
                    window.isAIGenerating = true;

                    try {
                        const res = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + config.key, 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            mode: 'cors',
                            credentials: 'omit',
                            signal: abortController.signal
                        });

                        if (!res.ok) {
                            let errorMsg = 'HTTP ' + res.status;
                            try {
                                const errorData = await res.json();
                                if (errorData.error) errorMsg += ': ' + errorData.error.message;
                            } catch (e) { errorMsg += ': ' + await res.text(); }

                            if (window.SystemLog) SystemLog.write('ERR', 'API è¯·æ±‚å¤±è´¥', errorMsg);
                            throw new Error(errorMsg);
                        }

                        const data = await res.json();
                        if (window.SystemLog) {
                            const typeMap = { 'chat': 'èŠå¤©', 'summarize': 'æ€»ç»“', 'active': 'æŸ¥å²—', 'proactive': 'ä¸»åŠ¨æ¶ˆæ¯', 'script': 'ç¼–å‰§', 'weibo': 'å¾®åš' };
                            SystemLog.write('AI', `æ”¶åˆ°å›å¤ [${typeMap[callType] || callType}]`, data);

                            // Check for high token usage warning
                            if (data.usage && data.usage.prompt_tokens > 40000) {
                                SystemLog.write('WARN', `Token ç”¨é‡æé«˜: ${data.usage.prompt_tokens}`, "è¯·æ£€æŸ¥è§’è‰²è®¾å®šæˆ–è®°å¿†æ˜¯å¦è¿‡é•¿");
                                console.warn('[AI] High Token Usage:', data.usage);
                            }
                        }

                        if (!data.choices || data.choices.length === 0) {
                            // ã€ä¼˜åŒ–ã€‘æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¸åŸå› åˆ†æ
                            console.error('[AI] APIè¿”å›å†…å®¹ä¸ºç©º (Empty Choices)', data);
                            let reason = "æœªçŸ¥åŸå› ";

                            // æ£€æŸ¥ Gemini åŸç”Ÿæ ¼å¼ (candidates)
                            if (data.candidates && data.candidates.length > 0) {
                                if (data.candidates[0].content) {
                                    console.log('[AI] æ£€æµ‹åˆ° Gemini åŸç”Ÿæ ¼å¼ï¼Œå°è¯•æå–å†…å®¹');
                                    const part = data.candidates[0].content.parts[0];
                                    return part.text || part;
                                } else if (data.candidates[0].finishReason) {
                                    reason = `ç»“æŸåŸå› : ${data.candidates[0].finishReason}`;
                                }
                            }

                            // æ£€æŸ¥ promptFeedback
                            if (data.promptFeedback) {
                                if (data.promptFeedback.blockReason) {
                                    reason = `å†…å®¹è¢«æ‹¦æˆª (BlockReason: ${data.promptFeedback.blockReason})`;
                                }
                            }

                            // æŠ›å‡ºå¸¦æœ‰å…·ä½“åŸå› çš„é”™è¯¯ï¼Œå¹¶å°†åŸå§‹æ•°æ®å±•ç¤ºç»™ç”¨æˆ·ä»¥ä¾¿è°ƒè¯•
                            const rawInfo = JSON.stringify(data).substring(0, 150);
                            const errorDetail = `å›å¤ç”Ÿæˆå¤±è´¥ (${reason})ã€‚åç«¯è¿”å›: ${rawInfo}`;
                            if (window.Utils) Utils.showToast(errorDetail, 5000);
                            throw new Error(errorDetail);
                        }
                        return data.choices[0].message.content;
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            console.log('[AI] è¯·æ±‚å·²è¢«ç”¨æˆ·ä¸­æ–­');
                            if (window.SystemLog) SystemLog.write('AI', 'ç”¨æˆ·ä¸­æ–­å›å¤ç”Ÿæˆ');
                            return null;
                        }
                        throw error;
                    } finally {
                        window.isAIGenerating = false;
                        window.currentAIAbortController = null;
                    }
                });
            },

            // --- æƒ…æ„Ÿåˆ†æå™¨ï¼šç»™æœ¬åœ°è¯­éŸ³åŠ ç‚¹â€œæ–™â€ ---
            analyzeEmotion: (text) => {
                let speed = 1.0; // é»˜è®¤è¯­é€Ÿ
                let pitch = 1.0; // é»˜è®¤è¯­è°ƒ (MultiTTS æ ‡å‡†æ˜¯1.0)

                // 1. æ‚²ä¼¤/æ²‰é‡/ç–²æƒ«/æ’’å¨‡ -> æ…¢é€Ÿï¼Œä½æ²‰/æŸ”å’Œ
                if (/éš¾è¿‡|ä¼¤å¿ƒ|å“­|ç´¯|ç—›è‹¦|å¤±æœ›|å¹æ°”|å¯¹ä¸èµ·|é—æ†¾|æ­»|ä¸èˆ|æ±‚ä½ |å‘œ|å—¯.../.test(text)) {
                    speed = 0.8;  // æ…¢ä¸€ç‚¹ï¼Œæ˜¾æ·±æƒ…
                    pitch = 0.8;  // å‹ä½å£°éŸ³
                }
                // 2. å¼€å¿ƒ/æ¿€åŠ¨/æƒŠè®¶/å¤§ç¬‘ -> å¿«é€Ÿï¼Œé«˜æ˜‚
                else if (/å“ˆå“ˆ|å¼€å¿ƒ|æ£’|çˆ±|å–œæ¬¢|æƒŠ|ï¼|~|å˜»å˜»|å˜¿å˜¿|å“‡|å¤©å‘|å¿«çœ‹|æ­å–œ/.test(text)) {
                    speed = 1.2;  // è½»å¿«
                    pitch = 1.2;  // ä¸Šæ‰¬
                }
                // 3. æ„¤æ€’/æ€¥ä¿ƒ -> æå¿«ï¼Œä¸¥è‚ƒ
                else if (/æ»š|è®¨åŒ|çƒ¦|æ€’|å¿«ç‚¹|åˆ«|é—­å˜´|å²‚æœ‰æ­¤ç†|ä¸å¯ç†å–»/.test(text)) {
                    speed = 1.4;  // è¯­é€Ÿæå¿«
                    pitch = 0.9;  // å£°éŸ³ç´§ç»·
                }
                // 4. ç–‘é—®/å¥½å¥‡ -> è¯­è°ƒä¸Šæ‰¬
                else if (text.includes('?') || text.includes('ï¼Ÿ') || /å—|å‘¢|è°|ä»€ä¹ˆ/.test(text)) {
                    pitch = 1.1; // ç¨å¾®ä¸Šæ‰¬
                }

                return { speed, pitch };
            },

            generateTTS: async function (text, charSettings) {
                const globalTTS = AppStorage.get('tts_config', { engine: 'browser', minimax: {} });

                // 1. è·å–æƒ…æ„Ÿå‚æ•° (è¿™æ˜¯å…è´¹æå‡æ•ˆæœçš„å…³é”®ï¼)
                // æ³¨æ„ï¼šéœ€è¦é€šè¿‡ SettingsLogic è°ƒç”¨ä¸Šé¢çš„å‡½æ•°
                const emotion = this.analyzeEmotion ? this.analyzeEmotion(text) : { speed: 1.0, pitch: 1.0 };

                // 2. ç»“åˆè§’è‰²åŸºç¡€è®¾å®š
                // æœ€ç»ˆè¯­é€Ÿ = è§’è‰²è®¾å®šè¯­é€Ÿ * æƒ…æ„Ÿè¯­é€Ÿ
                const settings = charSettings || {};
                const baseSpeed = parseFloat(settings.voiceSpeed || 1.0);
                const finalSpeed = baseSpeed * emotion.speed;

                try {
                    // --- åˆ†æ”¯ A: æœ¬åœ° Browser TTS (MultiTTS) ---
                    // è¿™æ˜¯ä½ ç°åœ¨ç”¨çš„æ–¹æ¡ˆï¼Œå®Œå…¨å…è´¹
                    if (globalTTS.engine === 'browser') {
                        return new Promise((resolve) => {
                            const u = new SpeechSynthesisUtterance(text);
                            u.lang = 'zh-CN';

                            // ã€æ³¨å…¥çµé­‚ã€‘åº”ç”¨åŠ¨æ€è¯­é€Ÿå’Œè¯­è°ƒ
                            u.rate = finalSpeed;
                            u.pitch = emotion.pitch;

                            // å…¼å®¹æ€§ä¿æŠ¤ï¼šé˜²æ­¢å‚æ•°è¶Šç•Œå¯¼è‡´ä¸å‘å£°
                            if (u.rate < 0.1) u.rate = 0.1; if (u.rate > 2) u.rate = 2;
                            if (u.pitch < 0.1) u.pitch = 0.1; if (u.pitch > 2) u.pitch = 2;

                            u.onend = function () {
                                if (window.SystemLog) SystemLog.write('SYS', 'æœ¬åœ°è¯­éŸ³æ’­æ”¾å®Œæˆ', text.substring(0, 20));
                                resolve('browser-tts-done'); // è¿”å›ç‰¹æ®Šæ ‡è®°è¡¨ç¤ºæ’­æ”¾å®Œæˆ
                            };

                            u.onerror = function (e) {
                                console.error('æµè§ˆå™¨TTSé”™è¯¯:', e);
                                resolve(null); // å‡ºé”™æ—¶è¿”å›null
                            };

                            window.speechSynthesis.speak(u);

                            if (window.SystemLog) SystemLog.write('SYS', 'æœ¬åœ°è¯­éŸ³æ’­æ”¾', `è¯­é€Ÿ:${u.rate.toFixed(1)} è¯­è°ƒ:${u.pitch.toFixed(1)}`);
                        });
                    }

                    // --- åˆ†æ”¯ B: MiniMax (ä¿ç•™ä»£ç ä»¥å¤‡ä¸æ—¶ä¹‹éœ€) ---
                    else {
                        const apiKey = globalTTS.minimax.apiKey;
                        const groupId = globalTTS.minimax.groupId;
                        if (!apiKey || !groupId) return null;

                        const res = await fetch('https://api.minimaxi.com/v1/t2a_v2', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + apiKey,
                                'Content-Type': 'application/json',
                                'GroupId': groupId
                            },
                            mode: 'cors',
                            credentials: 'omit',
                            body: JSON.stringify({
                                "model": globalTTS.minimax.modelId || 'speech-01-turbo',
                                "text": text,
                                "stream": false,
                                "voice_setting": {
                                    "voice_id": charSettings.voiceId || globalTTS.minimax.voiceId || 'male-qn-qingse',
                                    "speed": finalSpeed,
                                    "vol": 1,
                                    "pitch": 0 // äº‘ç«¯æ¨¡å‹é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨è°ƒ pitchï¼Œå®ƒè‡ªå·±ä¼šæ‡‚
                                },
                                "audio_setting": { "sample_rate": 32000, "bitrate": 128000, "format": "mp3", "channel": 1 }
                            })
                        });

                        if (!res.ok) return null;
                        const responseData = await res.json();
                        if (responseData.base_resp.status_code !== 0) return null;

                        const hexAudio = responseData.data.audio;
                        if (!hexAudio) return null;

                        const bytes = new Uint8Array(hexAudio.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                        const blob = new Blob([bytes], { type: 'audio/mp3' });

                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    }
                } catch (e) {
                    console.error("TTSç”Ÿæˆå¤±è´¥:", e);
                    // å¤±è´¥å…œåº•ï¼šç”¨æœ€åŸå§‹çš„æ–¹å¼è¯»å‡ºæ¥
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(text));
                    return null;
                }
            },
        };

        window.ThemeLogic = {
            init: () => {
                const t = AppStorage.get('theme_config', {});
                ThemeLogic.apply(t);
                ThemeLogic.loadPresets();
                ThemeLogic.updateFontSettings();
                ThemeLogic.updateGlobalBgPreview();

                // åˆå§‹åŒ–æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯è®¾ç½®
                ThemeLogic.updateWidgetCardBgInputs();
            },
            apply: (t) => {
                document.getElementById('user-custom-css').innerHTML = t.css || '';
                if (t.wallpaper) {
                    // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰å£çº¸ï¼Œä¸æ·»åŠ é¢å¤–æ¸å˜
                    const wallLayer = document.getElementById('wallpaper-layer');
                    if (wallLayer) {
                        wallLayer.style.background = '';
                        wallLayer.style.backgroundImage = `url(${t.wallpaper})`;
                        wallLayer.style.backgroundSize = 'cover';
                        wallLayer.style.backgroundPosition = 'center';
                        wallLayer.style.backgroundRepeat = 'no-repeat';
                    }
                } else {
                    // é‡ç½®ä¸ºé»˜è®¤æ¸å˜èƒŒæ™¯
                    const wallLayer = document.getElementById('wallpaper-layer');
                    if (wallLayer) {
                        wallLayer.style.backgroundImage = '';
                        wallLayer.style.background = 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%)';
                        wallLayer.style.backgroundSize = 'cover';
                        wallLayer.style.backgroundPosition = 'center';
                        wallLayer.style.backgroundRepeat = 'no-repeat';
                    }
                }
                if (t.icons) Object.keys(t.icons).forEach(k => { const el = document.getElementById(k); if (el) { el.innerHTML = `<img src="${t.icons[k]}">`; el.className = "w-[60px] h-[60px] rounded-xl glass-icon shadow-lg"; } });
                if (t.widgets) {
                    const transforms = t.widgetTransforms || {};
                    ['card1', 'card2'].forEach(id => {
                        const widgetIdSuffix = id.replace('card', ''); // Gets '1' or '2'

                        // 1. Update Main Desktop Widgets (Always use global t.widgets for main desktop if strictly separated, or t which is passed in)
                        // Note: ThemeLogic.apply is usually called with global theme config.

                        const el = document.getElementById('widget-img-' + id);
                        const overlay = document.getElementById('widget-overlay-' + id);

                        // Apply to Main Desktop
                        if (t.widgets[id]) {
                            const tr = transforms[id] || { x: 0, y: 0, scale: 1 };
                            const imgHtml = `<img src="${t.widgets[id]}" class="widget-img" style="transform: translate(${tr.x}px, ${tr.y}px) scale(${tr.scale}); transform-origin: center center; cursor: default;">`;
                            if (el) {
                                el.innerHTML = imgHtml;
                                if (overlay) overlay.style.opacity = '0';
                            }
                        } else {
                            if (el) {
                                el.innerHTML = '';
                                if (overlay) overlay.style.opacity = '0.5';
                            }
                        }

                        // 2. Update Search Phone Desktop Widgets
                        // Ensure we ONLY update search phone widgets if we are targeting a specific character (indicated by caller)
                        // OR if we are currently looking at the search phone UI.
                        // The 't' passed here is EITHER global theme OR char specific theme.
                        // We need to differentiate.

                        const searchEl = document.getElementById('search-widget-img-' + widgetIdSuffix);
                        const searchOverlay = document.getElementById('search-widget-overlay-' + widgetIdSuffix);

                        // Check if we are in "Search Phone" context or if this 't' is intended for it.
                        // For simplicity, we can rely on variable 'currentThemeMode' or check if SearchPhoneUI is active.
                        // However, a safer bet is: if we are updating 'widget-img-card1' (main desktop), we should NOT blindly update 'search-widget-img-1' unless we know 't' is correct for it.

                        // FIX: Only update search widgets if the passed 't' object actually belongs to the current character being viewed.
                        // But ThemeLogic.apply doesn't know about characters.
                        // So we will modify the caller (ThemeLogic.applyCharWidgets) to handle this, OR we add a flag to ThemeLogic.apply.

                        // For now, let's look at the DOM.
                        // If SearchPhoneUI is open and active, we assume the 't' passed IS the character theme (because of our hook).
                        // If SearchPhoneUI is closed, 't' is likely the global theme.

                        const isSearchPhoneActive = document.getElementById('app-search') && !document.getElementById('app-search').classList.contains('hidden') && document.getElementById('search-page-desktop') && !document.getElementById('search-page-desktop').classList.contains('hidden');

                        // If Search Phone is ACTIVE, we update its widgets with 't'. 
                        // If it's NOT active, we generally don't want to touch it with global theme data, 
                        // UNLESS 't' is specifically the char data (which is hard to know here).
                        // BUT, our hook `applyCharWidgets` calls `ThemeLogic.apply(charTheme)`.
                        // So if we are in that hook, we want to update search widgets.

                        if (searchEl && isSearchPhoneActive) {
                            if (t.widgets[id]) {
                                const tr = transforms[id] || { x: 0, y: 0, scale: 1 };
                                const imgHtml = `<img src="${t.widgets[id]}" class="widget-img" style="transform: translate(${tr.x}px, ${tr.y}px) scale(${tr.scale}); transform-origin: center center; cursor: default;">`;
                                searchEl.innerHTML = imgHtml;
                                if (searchOverlay) searchOverlay.style.opacity = '0';
                            } else {
                                searchEl.innerHTML = '';
                                if (searchOverlay) searchOverlay.style.opacity = '1';
                            }
                        }
                    });
                }

                // åº”ç”¨æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯
                // åº”ç”¨æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯
                t.widgetCards = t.widgetCards || {};

                // æ—¶é—´å¡ç‰‡èƒŒæ™¯
                if (t.widgetCards.timeCard) {
                    const timeCard = document.getElementById('widget-time');
                    if (timeCard) {
                        timeCard.style.background = 'none';
                        timeCard.style.setProperty('background-image', `url('${t.widgetCards.timeCard}')`, 'important');
                        timeCard.style.setProperty('background-size', 'cover', 'important');
                        timeCard.style.setProperty('background-position', 'center', 'important');
                    }
                } else {
                    // é‡ç½®ä¸ºé»˜è®¤ï¼ˆæ¸…é™¤è‡ªå®šä¹‰èƒŒæ™¯ï¼‰
                    const timeCard = document.getElementById('widget-time');
                    if (timeCard) {
                        timeCard.style.background = '';
                        timeCard.style.removeProperty('background-image');
                        timeCard.style.removeProperty('background-size');
                        timeCard.style.removeProperty('background-position');
                    }
                }

                // å®šä½å¡ç‰‡èƒŒæ™¯
                if (t.widgetCards.locationCard) {
                    const locationCard = document.getElementById('widget-location');
                    if (locationCard) {
                        locationCard.style.background = 'none';
                        locationCard.style.setProperty('background-image', `url('${t.widgetCards.locationCard}')`, 'important');
                        locationCard.style.setProperty('background-size', 'cover', 'important');
                        locationCard.style.setProperty('background-position', 'center', 'important');
                    }
                } else {
                    const locationCard = document.getElementById('widget-location');
                    if (locationCard) {
                        locationCard.style.background = '';
                        locationCard.style.removeProperty('background-image');
                        locationCard.style.removeProperty('background-size');
                        locationCard.style.removeProperty('background-position');
                    }
                }

                // å¤©æ°”å¡ç‰‡èƒŒæ™¯
                if (t.widgetCards.weatherCard) {
                    const weatherCard = document.getElementById('widget-weather');
                    if (weatherCard) {
                        weatherCard.style.background = 'none';
                        weatherCard.style.setProperty('background-image', `url('${t.widgetCards.weatherCard}')`, 'important');
                        weatherCard.style.setProperty('background-size', 'cover', 'important');
                        weatherCard.style.setProperty('background-position', 'center', 'important');
                    }
                } else {
                    const weatherCard = document.getElementById('widget-weather');
                    if (weatherCard) {
                        weatherCard.style.background = '';
                        weatherCard.style.removeProperty('background-image');
                        weatherCard.style.removeProperty('background-size');
                        weatherCard.style.removeProperty('background-position');
                    }
                }
                // Apply global font settings
                if (t.font) {
                    document.body.style.color = t.font.color || '#166534';
                    document.body.style.textShadow = t.font.shadow || '';
                    if (t.font.url) {
                        const style = document.createElement('style');
                        style.textContent = `@import url('${t.font.url}'); body { font - family: 'CustomFont', 'Noto Sans SC', sans - serif; } `;
                        document.head.appendChild(style);
                    }
                }

                // Apply global background
                if (t.globalBg) {
                    document.documentElement.style.setProperty('--app-bg-color', `url(${t.globalBg})`);
                    document.body.style.backgroundImage = `url(${t.globalBg})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                }
            },
            saveTheme: () => {
                const t = AppStorage.get('theme_config', { icons: {}, widgets: {}, font: {}, globalBg: '', widgetCards: {} });
                t.css = document.getElementById('theme-css').value;

                // Save font settings
                t.font = {
                    color: document.getElementById('font-color').value,
                    shadow: document.getElementById('font-shadow').value,
                    url: document.getElementById('font-url').value
                };

                // Save global background
                t.globalBg = document.getElementById('global-bg-url-input').value;

                // ä¿å­˜æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯è®¾ç½®
                t.widgetCards = t.widgetCards || {};
                t.widgetCards.timeCard = document.getElementById('time-card-bg-url').value;
                t.widgetCards.locationCard = document.getElementById('location-card-bg-url').value;
                t.widgetCards.weatherCard = document.getElementById('weather-card-bg-url').value;

                AppStorage.set('theme_config', t);
                ThemeLogic.apply(t);
                Utils.showToast('ç¾åŒ–ä¿å­˜');
            },

            // Global Font Settings
            applyFontUrl: () => {
                const url = document.getElementById('font-url').value;
                if (url) {
                    const t = AppStorage.get('theme_config', { font: {} });
                    t.font.url = url;
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    Utils.showToast('å­—ä½“åº”ç”¨æˆåŠŸ');
                }
            },
            updateFontSettings: () => {
                const t = AppStorage.get('theme_config', { font: {} });
                document.getElementById('font-color').value = t.font.color || '#166534';
                document.getElementById('font-shadow').value = t.font.shadow || '';
                document.getElementById('font-url').value = t.font.url || '';
            },
            restoreDefaultFont: () => {
                const t = AppStorage.get('theme_config', { font: {} });
                t.font = {
                    color: '#166534',
                    shadow: '',
                    url: ''
                };
                AppStorage.set('theme_config', t);
                ThemeLogic.apply(t);
                ThemeLogic.updateFontSettings();
                Utils.showToast('å­—ä½“å·²æ¢å¤é»˜è®¤');
            },

            // Global Background Settings
            applyGlobalBgUrl: () => {
                const url = document.getElementById('global-bg-url-input').value;
                if (url) {
                    const t = AppStorage.get('theme_config', {});
                    t.globalBg = url;
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('å…¨å±€èƒŒæ™¯åº”ç”¨æˆåŠŸ');
                }
            },
            handleGlobalBgUpload: (input) => {
                if (input.files[0]) {
                    // ä¿®æ”¹ï¼šå…¨å±€èƒŒæ™¯å¼ºåˆ¶é«˜æ¸… 1080px
                    Utils.compressImage(input.files[0], 1080, 0.85).then(base64 => {
                        const t = AppStorage.get('theme_config', {});
                        t.globalBg = base64;
                        AppStorage.set('theme_config', t);
                        ThemeLogic.apply(t);
                        document.getElementById('global-bg-url-input').value = base64;
                        ThemeLogic.updateGlobalBgPreview();
                        Utils.showToast('å…¨å±€èƒŒæ™¯ä¸Šä¼ æˆåŠŸ');
                    });
                }
            },
            resetGlobalBg: () => {
                const t = AppStorage.get('theme_config', {});
                t.globalBg = '';
                AppStorage.set('theme_config', t);
                document.documentElement.style.setProperty('--app-bg-color', '#f0fdf4');
                document.body.style.backgroundImage = '';
                document.body.style.backgroundSize = 'auto';
                document.body.style.backgroundPosition = 'static';
                document.body.style.backgroundAttachment = 'scroll';
                document.getElementById('global-bg-url-input').value = '';
                ThemeLogic.updateGlobalBgPreview();
                Utils.showToast('å…¨å±€èƒŒæ™¯å·²é‡ç½®');
            },
            updateGlobalBgPreview: () => {
                const t = AppStorage.get('theme_config', {});
                document.getElementById('global-bg-preview-box').style.backgroundImage = t.globalBg ? `url(${t.globalBg})` : '';
            },

            // Preset Management
            loadPresets: () => {
                const presets = AppStorage.get('theme_presets', {});
                const select = document.getElementById('preset-select');
                select.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾...</option>' +
                    Object.keys(presets).map(name => `< option value = "${name}" > ${name}</option > `).join('');
            },
            savePreset: () => {
                const name = document.getElementById('preset-name').value;
                if (!name) return Utils.showToast('è¯·è¾“å…¥é¢„è®¾åç§°');

                const t = AppStorage.get('theme_config', { icons: {}, widgets: {}, font: {}, globalBg: '' });
                const presets = AppStorage.get('theme_presets', {});
                presets[name] = t;
                AppStorage.set('theme_presets', presets);

                document.getElementById('preset-name').value = '';
                ThemeLogic.loadPresets();
                Utils.showToast('é¢„è®¾ä¿å­˜æˆåŠŸ');
            },
            loadPreset: (name) => {
                if (!name) return;
                const presets = AppStorage.get('theme_presets', {});
                const preset = presets[name];
                if (preset) {
                    AppStorage.set('theme_config', preset);
                    ThemeLogic.apply(preset);
                    ThemeLogic.updateFontSettings();
                    document.getElementById('theme-css').value = preset.css || '';
                    document.getElementById('global-bg-url-input').value = preset.globalBg || '';
                    ThemeLogic.updateWallpaperPreview();
                    ThemeLogic.updateIconPreview();
                    ThemeLogic.updateWidgetPreviews();
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('é¢„è®¾åŠ è½½æˆåŠŸ');
                }
            },
            deletePreset: () => {
                const name = document.getElementById('preset-select').value;
                if (!name) return Utils.showToast('è¯·é€‰æ‹©è¦åˆ é™¤çš„é¢„è®¾');

                const presets = AppStorage.get('theme_presets', {});
                delete presets[name];
                AppStorage.set('theme_presets', presets);
                ThemeLogic.loadPresets();
                Utils.showToast('é¢„è®¾åˆ é™¤æˆåŠŸ');
            },

            // Reset and Restore Defaults
            resetAll: () => {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç¾åŒ–è®¾ç½®å—ï¼Ÿ')) {
                    AppStorage.set('theme_config', {});
                    ThemeLogic.apply({});
                    ThemeLogic.updateFontSettings();
                    document.getElementById('theme-css').value = '';
                    document.getElementById('global-bg-url-input').value = '';
                    ThemeLogic.updateWallpaperPreview();
                    ThemeLogic.updateIconPreview();
                    ThemeLogic.updateWidgetPreviews();
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('å…¨å±€ç¾åŒ–å·²é‡ç½®');
                }
            },
            restoreDefaultCSS: () => {
                document.getElementById('theme-css').value = '';
                Utils.showToast('CSSå·²æ¢å¤é»˜è®¤');
            },

            // æ–°å¢ï¼šæ¡Œé¢å°ç»„ä»¶èƒŒæ™¯è®¾ç½®
            applyWidgetCardBg: (cardType) => {
                let urlInputId;
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªå– Input IDï¼Œåº”ç”¨é€»è¾‘ç»Ÿä¸€äº¤ç»™ ThemeLogic.apply å¤„ç†
                switch (cardType) {
                    case 'timeCard':
                        urlInputId = 'time-card-bg-url';
                        break;
                    case 'locationCard':
                        urlInputId = 'location-card-bg-url';
                        break;
                    case 'weatherCard':
                        urlInputId = 'weather-card-bg-url';
                        break;
                    default:
                        return;
                }

                const url = document.getElementById(urlInputId).value;
                if (url) {
                    const t = AppStorage.get('theme_config', { widgetCards: {} });
                    t.widgetCards = t.widgetCards || {};
                    t.widgetCards[cardType] = url;
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    Utils.showToast('å°ç»„ä»¶èƒŒæ™¯åº”ç”¨æˆåŠŸ');
                }
            },

            // æ›´æ–°æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯è¾“å…¥æ¡†å€¼å’Œé¢„è§ˆ
            updateWidgetCardBgInputs: () => {
                const t = AppStorage.get('theme_config', { widgetCards: {} });
                if (t.widgetCards) {
                    document.getElementById('time-card-bg-url').value = t.widgetCards.timeCard || '';
                    document.getElementById('location-card-bg-url').value = t.widgetCards.locationCard || '';
                    document.getElementById('weather-card-bg-url').value = t.widgetCards.weatherCard || '';

                    // æ›´æ–°é¢„è§ˆ
                    ThemeLogic.updateWidgetCardPreviews();
                }
            },

            // æ›´æ–°æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯é¢„è§ˆ
            updateWidgetCardPreviews: () => {
                const t = AppStorage.get('theme_config', { widgetCards: {} });
                if (t.widgetCards) {
                    document.getElementById('time-card-preview-box').innerHTML = t.widgetCards.timeCard ? `<img src="${t.widgetCards.timeCard}" class="w-full h-full object-cover">` : '';
                    document.getElementById('location-card-preview-box').innerHTML = t.widgetCards.locationCard ? `<img src="${t.widgetCards.locationCard}" class="w-full h-full object-cover">` : '';
                    document.getElementById('weather-card-preview-box').innerHTML = t.widgetCards.weatherCard ? `<img src="${t.widgetCards.weatherCard}" class="w-full h-full object-cover">` : '';
                }
            },

            // è§¦å‘æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯ä¸Šä¼ 
            triggerWidgetCardUpload: (cardType) => {
                ThemeLogic.currentWidgetCard = cardType;
                document.getElementById('upload-widget-card').click();
            },

            // å¤„ç†æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯ä¸Šä¼ 
            handleWidgetCardUpload: (input) => {
                if (input.files[0] && ThemeLogic.currentWidgetCard) {
                    Utils.compressImage(input.files[0], 512, 0.7).then(base64 => {
                        const t = AppStorage.get('theme_config', { widgetCards: {} });
                        t.widgetCards = t.widgetCards || {};
                        t.widgetCards[ThemeLogic.currentWidgetCard] = base64;
                        AppStorage.set('theme_config', t);
                        ThemeLogic.apply(t);
                        ThemeLogic.updateWidgetCardBgInputs();
                        Utils.showToast('å°ç»„ä»¶èƒŒæ™¯ä¸Šä¼ æˆåŠŸ');
                    });
                }
            },

            // æ¸…é™¤æ¡Œé¢å°ç»„ä»¶èƒŒæ™¯
            clearWidgetCardBg: (cardType) => {
                const t = AppStorage.get('theme_config', { widgetCards: {} });
                if (t.widgetCards && t.widgetCards[cardType]) {
                    delete t.widgetCards[cardType];
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    ThemeLogic.updateWidgetCardBgInputs();

                    Utils.showToast('èƒŒæ™¯å·²æ¸…é™¤');
                }
            },

            // æ¸…é™¤å›¾æ ‡
            clearIcon: () => {
                const selector = document.getElementById('icon-selector');
                const iconId = selector.value;
                const t = AppStorage.get('theme_config', { icons: {} });

                if (t.icons && t.icons[iconId]) {
                    delete t.icons[iconId];
                    AppStorage.set('theme_config', t);
                    if (confirm('æ¸…é™¤å›¾æ ‡åéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½æ¢å¤é»˜è®¤æ ·å¼ï¼Œæ˜¯å¦ç°åœ¨åˆ·æ–°ï¼Ÿ')) {
                        location.reload();
                    } else {
                        Utils.showToast('å›¾æ ‡å·²æ¸…é™¤ï¼Œåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
                    }
                } else {
                    Utils.showToast('å½“å‰å›¾æ ‡æœªè®¾ç½®è‡ªå®šä¹‰æ ·å¼');
                }
            },

            // æ¸…é™¤ç»„ä»¶å›¾ç‰‡ (ç»„ä»¶1/2)
            clearWidgetUrl: (cardId) => {
                const t = AppStorage.get('theme_config', { widgets: {} });
                t.widgets = t.widgets || {};

                if (t.widgets[cardId]) {
                    delete t.widgets[cardId];
                    AppStorage.set('theme_config', t);

                    // Direct DOM update
                    const el = document.getElementById('widget-img-' + cardId);
                    if (el) el.innerHTML = '';

                    document.getElementById(cardId === 'card1' ? 'widget1-url-input' : 'widget2-url-input').value = '';
                    ThemeLogic.updateWidgetPreviews();
                    Utils.showToast('ç»„ä»¶å›¾ç‰‡å·²æ¸…é™¤');
                } else {
                    Utils.showToast('è¯¥ç»„ä»¶æœªè®¾ç½®å›¾ç‰‡');
                }
            },

            // Other methods
            applyUrl: (type) => {
                const url = document.getElementById(`${type} -url - input`).value.trim();
                if (!url) return Utils.showToast('è¯·è¾“å…¥URL');
                const t = AppStorage.get('theme_config', { icons: {}, widgets: {} });
                if (type === 'wallpaper') {
                    t.wallpaper = url;
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    ThemeLogic.updateWallpaperPreview();
                } else {
                    t.icons[document.getElementById('icon-selector').value] = url;
                    AppStorage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    ThemeLogic.updateIconPreview();
                }
                Utils.showToast('åº”ç”¨æˆåŠŸ');
            },
            handleImageUpload: (type, input) => {
                if (input.files[0]) {
                    // ä¿®æ”¹ï¼šå¦‚æœæ˜¯å£çº¸(wallpaper)å°±ç”¨é«˜æ¸…1080ï¼Œå›¾æ ‡(icon)ä¿æŒ512çœç©ºé—´
                    const width = type === 'wallpaper' ? 1080 : 512;
                    const quality = type === 'wallpaper' ? 0.9 : 0.7;

                    Utils.compressImage(input.files[0], width, quality).then(base64 => {
                        const t = AppStorage.get('theme_config', { icons: {}, widgets: {} });
                        if (type === 'wallpaper') t.wallpaper = base64;
                        else t.icons[document.getElementById('icon-selector').value] = base64;
                        AppStorage.set('theme_config', t);
                        ThemeLogic.apply(t);
                        if (type === 'wallpaper') ThemeLogic.updateWallpaperPreview();
                        else ThemeLogic.updateIconPreview();
                    });
                }
            },

            handleWidgetUpload: (input) => {
                if (input.files[0] && ThemeLogic.currentWidget) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        let saveKey = 'theme_config';
                        let t = null;

                        // ã€æ–°å¢ã€‘å¦‚æœæ˜¯åœ¨æŸ¥æ‰‹æœºæ¨¡å¼ä¸‹ï¼Œä¿å­˜åˆ°è§’è‰²ä¸“ç”¨é…ç½®
                        if (window.SearchPhoneUI && SearchPhoneUI.targetCharId) {
                            saveKey = 'theme_config_' + SearchPhoneUI.targetCharId;
                            t = AppStorage.get(saveKey, { widgets: {}, widgetTransforms: {} });
                        } else {
                            t = AppStorage.get('theme_config', { icons: {}, widgets: {} });
                        }

                        t.widgets = t.widgets || {};
                        t.widgets[ThemeLogic.currentWidget] = base64;
                        // Reset transform on new upload
                        t.widgetTransforms = t.widgetTransforms || {};
                        t.widgetTransforms[ThemeLogic.currentWidget] = { x: 0, y: 0, scale: 1 };

                        AppStorage.set(saveKey, t);

                        // Apply immediately
                        ThemeLogic.apply(t);
                        ThemeLogic.updateWidgetPreviews();
                    });
                }
            },
            triggerWidgetUpload: (id) => { ThemeLogic.currentWidget = id; document.getElementById('upload-widget').click(); },
            resetWallpaper: () => { const t = AppStorage.get('theme_config', {}); t.wallpaper = ''; AppStorage.set('theme_config', t); document.getElementById('wallpaper-layer').style.backgroundImage = ''; ThemeLogic.updateWallpaperPreview(); },
            updateWallpaperPreview: () => { const t = AppStorage.get('theme_config', {}); document.getElementById('wallpaper-preview-box').style.backgroundImage = t.wallpaper ? `url(${t.wallpaper})` : ''; },
            updateIconPreview: () => { const t = AppStorage.get('theme_config', { icons: {} }); const k = document.getElementById('icon-selector').value; document.getElementById('icon-preview-box').innerHTML = t.icons[k] ? `<img src="${t.icons[k]}">` : ''; },

            updateWidgetPreviews: () => {
                let t = null;
                // If in search phone mode, show previews for that character
                if (window.SearchPhoneUI && SearchPhoneUI.targetCharId && document.getElementById('search-page-desktop') && !document.getElementById('search-page-desktop').classList.contains('hidden')) {
                    t = AppStorage.get('theme_config_' + SearchPhoneUI.targetCharId, { widgets: {}, widgetTransforms: {} });
                } else {
                    t = AppStorage.get('theme_config', { widgets: {}, widgetTransforms: {} });
                }

                ['card1', 'card2'].forEach(id => {
                    const box = document.getElementById(id === 'card1' ? 'widget1-preview-box' : 'widget2-preview-box');
                    if (box && t.widgets && t.widgets[id]) {
                        const tr = (t.widgetTransforms && t.widgetTransforms[id]) || { x: 0, y: 0, scale: 1 };
                        box.innerHTML = `<img src="${t.widgets[id]}" style="width:100%; height:100%; object-fit:cover; transform: translate(${tr.x}px, ${tr.y}px) scale(${tr.scale}); transform-origin: center center;">`;
                    } else if (box) {
                        box.innerHTML = '<span class="text-xs text-white/30">æ— å›¾ç‰‡</span>';
                    }
                });
            },

            initWidgetInteraction: (cardId) => {
                const img = document.getElementById(`preview-img-${cardId}`);
                if (!img) return;
                const box = img.parentElement;

                let state = { x: 0, y: 0, scale: 1 };
                // Load initial state from transform style or storage
                const t = AppStorage.get('theme_config', { widgetTransforms: {} });
                if (t.widgetTransforms && t.widgetTransforms[cardId]) {
                    state = { ...t.widgetTransforms[cardId] };
                }

                const saveState = () => {
                    const cfg = AppStorage.get('theme_config', { widgetTransforms: {} });
                    cfg.widgetTransforms = cfg.widgetTransforms || {};
                    cfg.widgetTransforms[cardId] = state;
                    AppStorage.set('theme_config', cfg);
                    ThemeLogic.apply(cfg); // Live update home screen
                };

                const updateStyle = () => {
                    img.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
                };

                // Mouse/Touch Drag
                let isDragging = false;
                let startX, startY, initialX, initialY;

                const onPointerDown = (e) => {
                    if (e.pointerType === 'touch' && e.isPrimary === false) return; // Ignore multi-touch start here, handled by touch events for pinch
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = state.x;
                    initialY = state.y;
                    img.style.cursor = 'grabbing';
                    img.setPointerCapture(e.pointerId);
                };

                const onPointerMove = (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    state.x = initialX + dx;
                    state.y = initialY + dy;
                    updateStyle();
                };

                const onPointerUp = (e) => {
                    if (isDragging) {
                        isDragging = false;
                        img.style.cursor = 'grab';
                        img.releasePointerCapture(e.pointerId);
                        saveState();
                    }
                };

                // Wheel Zoom
                const onWheel = (e) => {
                    e.preventDefault();
                    // Determine scale factor
                    const delta = -e.deltaY * 0.001;
                    const newScale = Math.min(Math.max(0.5, state.scale + delta), 5);
                    state.scale = newScale;
                    updateStyle();
                    // Debounce save for wheel
                    clearTimeout(img._saveTimeout);
                    img._saveTimeout = setTimeout(saveState, 500);
                };

                // Pinch Zoom Logic (Touch Events)
                let initialDist = 0;
                let initialScale = 1;

                const getDist = (touches) => {
                    return Math.hypot(
                        touches[0].clientX - touches[1].clientX,
                        touches[0].clientY - touches[1].clientY
                    );
                };

                const onTouchStart = (e) => {
                    if (e.touches.length === 2) {
                        initialDist = getDist(e.touches);
                        initialScale = state.scale;
                        isDragging = false; // Stop drag if pinching
                    }
                };

                const onTouchMove = (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const currentDist = getDist(e.touches);
                        const ratio = currentDist / initialDist;
                        state.scale = Math.min(Math.max(0.5, initialScale * ratio), 5);
                        updateStyle();
                    }
                };

                const onTouchEnd = (e) => {
                    if (e.touches.length < 2) {
                        saveState();
                    }
                };

                img.addEventListener('pointerdown', onPointerDown);
                img.addEventListener('pointermove', onPointerMove);
                img.addEventListener('pointerup', onPointerUp);
                box.addEventListener('wheel', onWheel, { passive: false });

                box.addEventListener('touchstart', onTouchStart, { passive: false });
                box.addEventListener('touchmove', onTouchMove, { passive: false });
                box.addEventListener('touchend', onTouchEnd);
            }
        };

        // Worldbook Logic
        // ç¡®ä¿WorldbookUIåªè¢«å£°æ˜ä¸€æ¬¡
        window.WorldbookUI = window.WorldbookUI || {
            books: {},
            categories: {},
            groups: {},
            init: () => {
                WorldbookUI.books = AppStorage.get('wechat_worldbooks', {});
                WorldbookUI.categories = AppStorage.get('wechat_worldbook_categories', {});
                WorldbookUI.groups = AppStorage.get('wechat_worldbook_groups', {});
            },
            renderList: () => {
                WorldbookUI.init();
                const container = document.getElementById('wb-list-container');
                const categoryFilter = document.getElementById('wb-category-filter')?.value || '';
                const groupFilter = document.getElementById('wb-group-filter')?.value || '';

                let list = Object.values(WorldbookUI.books);

                // Apply filters
                if (categoryFilter) {
                    list = list.filter(b => b.categoryId === categoryFilter);
                }
                if (groupFilter) {
                    list = list.filter(b => b.groupId === groupFilter);
                }

                if (list.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-20">æš‚æ— ä¸–ç•Œä¹¦ï¼Œç‚¹å‡»å³ä¸Šè§’ + åˆ›å»º</div>';
                } else {
                    container.innerHTML = list.map(b => {
                        const category = b.categoryId ? WorldbookUI.categories[b.categoryId] : null;
                        const group = b.groupId ? WorldbookUI.groups[b.groupId] : null;
                        return `
            <div class="wb-list-item" onclick="WorldbookUI.openEdit('${b.id}')">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-bold text-green-600 mb-1">${b.name || 'æœªå‘½å'}</div>
                        <div class="text-xs text-gray-400 mb-2">${(b.entries || []).length} ä¸ªæ¡ç›®</div>
                        <div class="flex gap-2 flex-wrap">
                            ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-2 py-0.5 rounded">${category.name}</span>` : ''}
                            ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-2 py-0.5 rounded">${group.name}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-gray-400 ml-2"><i class="fa-solid fa-chevron-right"></i></div>
                </div>
                        </div >
            `;
                    }).join('');
                }

                // Update filter dropdowns
                WorldbookUI.updateFilters();
            },
            updateFilters: () => {
                const categoryFilter = document.getElementById('wb-category-filter');
                const groupFilter = document.getElementById('wb-group-filter');

                if (categoryFilter) {
                    categoryFilter.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç±»</option>' +
                        Object.values(WorldbookUI.categories).map(cat =>
                            `<option value="${cat.id}">${cat.name}</option>`
                        ).join('');
                }

                if (groupFilter) {
                    groupFilter.innerHTML = '<option value="">æ‰€æœ‰åˆ†ç»„</option>' +
                        Object.values(WorldbookUI.groups).map(grp =>
                            `<option value="${grp.id}">${grp.name}</option>`
                        ).join('');
                }

                // Update edit form dropdowns
                const editCategory = document.getElementById('wb-edit-category');
                const editGroup = document.getElementById('wb-edit-group');

                if (editCategory) {
                    editCategory.innerHTML = '<option value="">æ— åˆ†ç±»</option>' +
                        Object.values(WorldbookUI.categories).map(cat =>
                            `<option value="${cat.id}">${cat.name}</option>`
                        ).join('');
                }

                if (editGroup) {
                    editGroup.innerHTML = '<option value="">æ— åˆ†ç»„</option>' +
                        Object.values(WorldbookUI.groups).map(grp =>
                            `<option value="${grp.id}">${grp.name}</option>`
                        ).join('');
                }
            },
            createNewBook: () => {
                Utils.showPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¾“å…¥ä¸–ç•Œä¹¦åç§°:', (name) => {
                    if (!name) return;
                    const id = 'wb_' + Date.now();
                    WorldbookUI.books[id] = { id, name, entries: [], categoryId: null, groupId: null };
                    AppStorage.set('wechat_worldbooks', WorldbookUI.books);
                    WorldbookUI.renderList();
                });
            },
            openEdit: (id) => {
                WorldbookUI.currentBookId = id;
                // Clone book for temporary editing
                WorldbookUI.tempBook = JSON.parse(JSON.stringify(WorldbookUI.books[id]));

                document.getElementById('wb-edit-name').value = WorldbookUI.tempBook.name || '';
                document.getElementById('wb-edit-category').value = WorldbookUI.tempBook.categoryId || '';
                document.getElementById('wb-edit-group').value = WorldbookUI.tempBook.groupId || '';
                WorldbookUI.updateFilters();
                WorldbookUI.renderEntries();
                document.getElementById('wb-edit-view').classList.remove('hidden');
                document.getElementById('wb-edit-view').classList.add('flex');
            },
            saveBook: () => {
                if (!WorldbookUI.tempBook) return;

                // Update metadata from inputs
                WorldbookUI.tempBook.name = document.getElementById('wb-edit-name').value;
                WorldbookUI.tempBook.categoryId = document.getElementById('wb-edit-category').value || null;
                WorldbookUI.tempBook.groupId = document.getElementById('wb-edit-group').value || null;

                // Commit back to main storage
                WorldbookUI.books[WorldbookUI.currentBookId] = JSON.parse(JSON.stringify(WorldbookUI.tempBook));
                AppStorage.set('wechat_worldbooks', WorldbookUI.books);

                Utils.showToast('ä¿å­˜æˆåŠŸ');
                WorldbookUI.renderList();
            },
            closeEdit: () => {
                // Discard changes, simply close
                WorldbookUI.tempBook = null;
                document.getElementById('wb-edit-view').classList.add('hidden');
                document.getElementById('wb-edit-view').classList.remove('flex');
                WorldbookUI.renderList(); // Refresh list to show original state
            },
            renderEntries: () => {
                // Use tempBook if available, otherwise fallback (though should always be available in edit mode)
                const book = WorldbookUI.tempBook || WorldbookUI.books[WorldbookUI.currentBookId];
                const container = document.getElementById('wb-entry-list');
                container.innerHTML = book.entries.map((e, idx) => `
            <div class="glass-panel p-3 rounded-lg relative">
                        <div class="mb-2">
                            <input type="text" class="setting-input text-sm mb-2" placeholder="æ¡ç›®æ ‡é¢˜" value="${e.title || ''}" onchange="WorldbookUI.updateEntry(${idx}, 'title', this.value)">
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="setting-input text-xs w-1/3 mb-0" placeholder="å…³é”®è¯ (é€—å·åˆ†éš”)" value="${e.keys}" onchange="WorldbookUI.updateEntry(${idx}, 'keys', this.value)">
                            <div class="flex-1 flex justify-end gap-2">
                                <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${e.enabled ? 'checked' : ''} onchange="WorldbookUI.updateEntry(${idx}, 'enabled', this.checked)"> å¯ç”¨</label>
                                <button class="text-red-400 text-xs" onclick="WorldbookUI.deleteEntry(${idx})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <textarea class="setting-input text-xs h-20 resize-none" placeholder="å†…å®¹è®¾å®š..." onchange="WorldbookUI.updateEntry(${idx}, 'content', this.value)">${e.content}</textarea>
                    </div>
            `).join('');
            },
            addEntry: () => {
                if (WorldbookUI.tempBook) {
                    WorldbookUI.tempBook.entries.push({ title: '', keys: '', content: '', enabled: true });
                    WorldbookUI.renderEntries();
                }
            },
            updateEntry: (idx, field, val) => {
                if (WorldbookUI.tempBook) {
                    WorldbookUI.tempBook.entries[idx][field] = val;
                }
            },
            deleteEntry: (idx) => {
                if (!confirm('åˆ é™¤æ­¤æ¡ç›®?')) return;
                if (WorldbookUI.tempBook) {
                    WorldbookUI.tempBook.entries.splice(idx, 1);
                    WorldbookUI.renderEntries();
                }
            },
            // Category Management
            showCategoryManager: () => {
                WorldbookUI.init();
                WorldbookUI.renderCategoryList();
                const el = document.getElementById('wb-category-modal');
                el.classList.remove('hidden');
                el.classList.add('show');
            },
            hideCategoryManager: () => {
                const el = document.getElementById('wb-category-modal');
                el.classList.remove('show');
                el.classList.add('hidden');
            },
            renderCategoryList: () => {
                const container = document.getElementById('wb-category-list');
                const categories = Object.values(WorldbookUI.categories);
                if (categories.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— åˆ†ç±»</div>';
                } else {
                    container.innerHTML = categories.map(cat => {
                        const bookCount = Object.values(WorldbookUI.books).filter(b => b.categoryId === cat.id).length;
                        return `
            <div class="flex items-center justify-between glass-panel p-3 rounded-lg">
                                <div>
                                    <div class="font-medium">${cat.name}</div>
                                    <div class="text-xs text-gray-400">${bookCount} ä¸ªä¸–ç•Œä¹¦</div>
                                </div>
                                <button onclick="WorldbookUI.deleteCategory('${cat.id}')" class="text-red-400 text-xs px-2 py-1 rounded bg-red-500/20"><i class="fa-solid fa-trash"></i></button>
                            </div>
            `;
                    }).join('');
                }
            },
            addCategory: () => {
                const name = document.getElementById('wb-new-category-name').value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                    return;
                }
                const id = 'cat_' + Date.now();
                WorldbookUI.categories[id] = { id, name };
                AppStorage.set('wechat_worldbook_categories', WorldbookUI.categories);
                document.getElementById('wb-new-category-name').value = '';
                WorldbookUI.renderCategoryList();
                WorldbookUI.updateFilters();
            },
            deleteCategory: (id) => {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»ï¼Ÿåˆ†ç±»ä¸‹çš„ä¸–ç•Œä¹¦å°†å˜ä¸ºæ— åˆ†ç±»ã€‚')) return;
                delete WorldbookUI.categories[id];
                // Remove category from books
                Object.values(WorldbookUI.books).forEach(book => {
                    if (book.categoryId === id) {
                        book.categoryId = null;
                    }
                });
                AppStorage.set('wechat_worldbook_categories', WorldbookUI.categories);
                AppStorage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderCategoryList();
                WorldbookUI.updateFilters();
                WorldbookUI.renderList();
            },
            // Group Management
            showGroupManager: () => {
                WorldbookUI.init();
                WorldbookUI.renderGroupList();
                const el = document.getElementById('wb-group-modal');
                el.classList.remove('hidden');
                el.classList.add('show');
            },
            hideGroupManager: () => {
                const el = document.getElementById('wb-group-modal');
                el.classList.remove('show');
                el.classList.add('hidden');
            },
            renderGroupList: () => {
                const container = document.getElementById('wb-group-list');
                const groups = Object.values(WorldbookUI.groups);
                if (groups.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— åˆ†ç»„</div>';
                } else {
                    container.innerHTML = groups.map(grp => {
                        const bookCount = Object.values(WorldbookUI.books).filter(b => b.groupId === grp.id).length;
                        return `
            <div class="flex items-center justify-between glass-panel p-3 rounded-lg">
                                <div>
                                    <div class="font-medium">${grp.name}</div>
                                    <div class="text-xs text-gray-400">${bookCount} ä¸ªä¸–ç•Œä¹¦</div>
                                </div>
                                <button onclick="WorldbookUI.deleteGroup('${grp.id}')" class="text-red-400 text-xs px-2 py-1 rounded bg-red-500/20"><i class="fa-solid fa-trash"></i></button>
                            </div>
            `;
                    }).join('');
                }
            },
            addGroup: () => {
                const name = document.getElementById('wb-new-group-name').value.trim();
                if (!name) {
                    alert('è¯·è¾“å…¥åˆ†ç»„åç§°');
                    return;
                }
                const id = 'grp_' + Date.now();
                WorldbookUI.groups[id] = { id, name };
                AppStorage.set('wechat_worldbook_groups', WorldbookUI.groups);
                document.getElementById('wb-new-group-name').value = '';
                WorldbookUI.renderGroupList();
                WorldbookUI.updateFilters();
            },
            deleteGroup: (id) => {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç»„ï¼Ÿåˆ†ç»„ä¸‹çš„ä¸–ç•Œä¹¦å°†å˜ä¸ºæ— åˆ†ç»„ã€‚')) return;
                delete WorldbookUI.groups[id];
                // Remove group from books
                Object.values(WorldbookUI.books).forEach(book => {
                    if (book.groupId === id) {
                        book.groupId = null;
                    }
                });
                AppStorage.set('wechat_worldbook_groups', WorldbookUI.groups);
                AppStorage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderGroupList();
                WorldbookUI.updateFilters();
                WorldbookUI.renderList();
            },
            // Interface for Character Settings
            renderSettingsList: () => {
                WorldbookUI.init();
                const cid = WeChatUI.currentChatId;
                const char = AppStorage.get('wechat_chars', {})[cid];
                const selectedEntries = char ? char.worldbookEntries || [] : []; // Array of entry IDs: "bookId_entryIdx"

                const allBooks = WorldbookUI.books;
                const container = document.getElementById('char-worldbook-list');

                if (Object.keys(allBooks).length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·åœ¨æ¡Œé¢ä¸–ç•Œä¹¦Appä¸­åˆ›å»º</div>';
                    return;
                }

                container.innerHTML = Object.values(allBooks).map((b, bookIdx) => {
                    const category = b.categoryId ? WorldbookUI.categories[b.categoryId] : null;
                    const group = b.groupId ? WorldbookUI.groups[b.groupId] : null;
                    const entries = b.entries || [];
                    const bookId = `wb-collapse-${b.id}`;

                    // Count selected entries for this book
                    const selectedCount = entries.filter((entry, idx) => {
                        const entryId = `${b.id}_${idx}`;
                        return selectedEntries.includes(entryId);
                    }).length;

                    if (entries.length === 0) {
                        return `
                        <div class="wb-collapsible">
                            <div class="wb-collapsible-header" onclick="WorldbookUI.toggleCollapse('${bookId}')">
                                <div class="flex items-center gap-2 flex-1">
                                    <i class="fa-solid fa-chevron-right wb-collapsible-icon text-xs text-gray-400"></i>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium">${b.name || 'æœªå‘½å'}</div>
                                        <div class="flex gap-2 mt-1">
                                            ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-1.5 py-0.5 rounded">${category.name}</span>` : ''}
                                            ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-1.5 py-0.5 rounded">${group.name}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">æš‚æ— æ¡ç›®</div>
                            </div>
                            <div class="wb-collapsible-content" id="${bookId}">
                                <div class="px-4 pb-2 text-xs text-gray-500">æš‚æ— æ¡ç›®</div>
                            </div>
                        </div>
                        `;
                    }

                    return `
                    <div class="wb-collapsible">
                        <div class="wb-collapsible-header" onclick="WorldbookUI.toggleCollapse('${bookId}')">
                            <div class="flex items-center gap-2 flex-1">
                                <i class="fa-solid fa-chevron-right wb-collapsible-icon text-xs text-gray-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">${b.name || 'æœªå‘½å'}</div>
                                    <div class="flex gap-2 mt-1">
                                        ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-1.5 py-0.5 rounded">${category.name}</span>` : ''}
                                        ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-1.5 py-0.5 rounded">${group.name}</span>` : ''}
                                        <span class="text-xs text-gray-400">${entries.length} æ¡ç›®</span>
                                        ${selectedCount > 0 ? `<span class="text-xs bg-green-500/30 text-green-200 px-1.5 py-0.5 rounded">å·²é€‰ ${selectedCount}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wb-collapsible-content" id="${bookId}">
                            <div class="px-4 pb-3 space-y-1 max-h-60 overflow-y-auto">
                                ${entries.map((entry, idx) => {
                        const entryId = `${b.id}_${idx}`;
                        const isSelected = selectedEntries.includes(entryId);
                        const entryTitle = entry.title || `æ¡ç›® ${idx + 1}`;
                        return `
                                    <label class="flex items-center gap-2 p-1.5 rounded hover:bg-white/5 cursor-pointer">
                                        <input type="checkbox" class="toggle-switch" style="width:32px;height:16px" 
                                            ${isSelected ? 'checked' : ''} 
                                            onchange="WorldbookUI.toggleEntryForChar('${cid}', '${entryId}', this.checked)">
                                        <span class="text-xs flex-1">${entryTitle}</span>
                                    </label>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            },
            toggleCollapse: (bookId) => {
                const content = document.getElementById(bookId);
                const icon = content.previousElementSibling.querySelector('.wb-collapsible-icon');
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            },
            toggleEntryForChar: (cid, entryId, checked) => {
                const chars = AppStorage.get('wechat_chars', {});
                let char = chars[cid];

                // å¦‚æœcharä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„charå¯¹è±¡
                if (!char) {
                    char = chars[cid] = {};
                }

                if (!char.worldbookEntries) char.worldbookEntries = [];

                if (checked) {
                    if (!char.worldbookEntries.includes(entryId)) char.worldbookEntries.push(entryId);
                } else {
                    char.worldbookEntries = char.worldbookEntries.filter(id => id !== entryId);
                }
                AppStorage.set('wechat_chars', chars);
            },
            // Injection Logic
            scanAndInject: (text) => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const char = AppStorage.get('wechat_chars', {})[cid];
                if (!char || !char.worldbookEntries || char.worldbookEntries.length === 0) return '';

                const allBooks = AppStorage.get('wechat_worldbooks', {});
                let injectedContent = '';

                char.worldbookEntries.forEach(entryId => {
                    // ä¿®å¤:ä½¿ç”¨ lastIndexOf ç¡®ä¿å…¼å®¹å¸¦ä¸‹åˆ’çº¿çš„ ID (å¦‚ wb_123456_0)
                    const lastSep = entryId.lastIndexOf('_');
                    if (lastSep !== -1) {
                        const bookId = entryId.substring(0, lastSep);
                        const entryIdx = parseInt(entryId.substring(lastSep + 1));
                        const book = allBooks[bookId];
                        if (book && book.entries && book.entries[parseInt(entryIdx)]) {
                            const entry = book.entries[parseInt(entryIdx)];
                            if (!entry.enabled || !entry.content) return;
                            const keys = entry.keys ? entry.keys.split(/[,ï¼Œ]/).map(k => k.trim()).filter(k => k) : [];
                            // Logic: If no keys defined, always inject (global lore). If keys defined, scan text.
                            let match = false;
                            if (keys.length === 0) {
                                match = true;
                            } else {
                                match = keys.some(k => text.includes(k));
                            }

                            if (match) {
                                const entryTitle = entry.title ? `[${entry.title}]` : '';
                                injectedContent += `[World Info${entryTitle}: ${entry.content}]\n`;
                            }
                        }
                    }
                });

                return injectedContent;
            }
        };

        // å¿ƒå£°UIç¾åŒ–
        // ç¡®ä¿InnerVoiceUIåªè¢«å£°æ˜ä¸€æ¬¡
        window.InnerVoiceUI = window.InnerVoiceUI || {
            currentCharId: null,
            currentIndex: -1,
            animationId: null,

            // 10ç§ç‰¹æ•ˆé…ç½®
            effectTypes: [
                { id: 'bamboo', name: 'ğŸ‹ å¬ç«¹', color: '120, 160, 120', type: 'sway_fall' },
                { id: 'sakura', name: 'ğŸŒ¸ è½æ¨±', color: '255, 200, 210', type: 'sway_fall' },
                { id: 'snow', name: 'â„ï¸ å¯’é›ª', color: '220, 220, 230', type: 'sway_fall' },
                { id: 'rain', name: 'ğŸŒ§ï¸ æ½‡æ½‡å¤œé›¨', color: '150, 180, 210', type: 'rain' },
                { id: 'storm', name: 'âš¡ æ·±å¤œæƒŠé›·', color: '180, 200, 220', type: 'rain_storm' },
                { id: 'fireworks', name: 'ğŸ† çº¿é¦™èŠ±ç«', color: '255, 215, 0', type: 'burst' },
                { id: 'meteor', name: 'ğŸŒ  æ˜Ÿé™¨', color: '255, 255, 255', type: 'meteor' },
                { id: 'embers', name: 'ğŸ”¥ ä½™çƒ¬', color: '255, 100, 50', type: 'float_up_fade' },
                { id: 'gold', name: 'âœ¨ æµé‡‘', color: '212, 175, 55', type: 'flow_up' },
                { id: 'firefly', name: 'ğŸ¦‹ æµè¤', color: '160, 255, 160', type: 'wander' }
            ],
            currentEffect: null,
            init: () => {
                InnerVoiceUI.currentCharId = document.getElementById('subpage-chat-detail')?.dataset.charId;
                if (!InnerVoiceUI.currentEffect) {
                    InnerVoiceUI.currentEffect = InnerVoiceUI.effectTypes[Math.floor(Math.random() * InnerVoiceUI.effectTypes.length)];
                }
                const badge = document.getElementById('effect-name-badge');
                if (badge) badge.innerText = InnerVoiceUI.currentEffect.name;
            },

            // ã€æ ¸å¿ƒé‡æ„ã€‘ç»Ÿä¸€çš„å¿ƒå£°è§£æå™¨
            parseVoiceData: (text) => {
                if (!text) return null;
                if (typeof text === 'object') return text; // å·²ç»æ˜¯å¯¹è±¡

                let raw = text.toString().trim();
                let result = null;

                // 1. å°è¯•æ ‡å‡† JSON è§£æ
                try {
                    // æ¸…æ´— Markdown ä»£ç å—æ ‡è®°
                    let jsonStr = raw.replace(/```json/g, '').replace(/```/g, '').trim();

                    // å¦‚æœåŒ…å«è¢«è½¬ä¹‰çš„åŒå¼•å·ï¼Œå°è¯•è¿˜åŸ
                    if (jsonStr.includes('\\"')) {
                        jsonStr = jsonStr.replace(/\\"/g, '"');
                    }

                    // å°è¯•ä¿®å¤è¢«æˆªæ–­çš„ JSON (ç®€å•è¡¥å…¨)
                    if (jsonStr.startsWith('{') && !jsonStr.endsWith('}')) {
                        jsonStr += '}';
                    }

                    // æå–èŠ±æ‹¬å·å†…å®¹
                    const match = jsonStr.match(/\{[\s\S]*\}/);
                    if (match) {
                        try {
                            result = JSON.parse(match[0]);
                        } catch (e) {
                            // å°è¯•2: å¤„ç†æ·±åº¦è½¬ä¹‰ (é’ˆå¯¹ \"key\": \"value\" æƒ…å†µ)
                            try {
                                const unescaped = match[0].replace(/\\"/g, '"').replace(/\\\\/g, '\\');
                                result = JSON.parse(unescaped);
                            } catch (e2) { }
                        }
                    }
                } catch (e) {
                    // JSON è§£æå¤±è´¥ï¼Œç»§ç»­å°è¯•æ­£åˆ™
                }

                // å¤„ç†åµŒå¥—ç»“æ„ (content/inner_voice)
                if (result) {
                    let target = result;
                    if (result.content) {
                        if (typeof result.content === 'object') target = result.content;
                        else if (typeof result.content === 'string' && result.content.startsWith('{')) {
                            try { target = JSON.parse(result.content); } catch (e) { }
                        }
                    } else if (result.inner_voice) {
                        if (typeof result.inner_voice === 'object') target = result.inner_voice;
                        else if (typeof result.inner_voice === 'string' && result.inner_voice.startsWith('{')) {
                            try { target = JSON.parse(result.inner_voice); } catch (e) { }
                        }
                    }

                    // é‡æ–°æ˜ å°„ä¸ºæ ‡å‡†æ ¼å¼ (å¢åŠ å¯¹ thought/emotion/plan ç­‰è‹±æ–‡é”®çš„å…¼å®¹)
                    result = {
                        clothes: target["ç€è£…"] || target.clothes || target.clothing || target.outfit || target.OUTFIT || "æœªçŸ¥",
                        scene: target["ç¯å¢ƒ"] || target.scene || target.environment || target.SCENE || "æœªçŸ¥",
                        mind: target["å¿ƒå£°"] || target.mind || target.thought || target.thoughts || target.emotion || target.EMOTION || "æœªçŸ¥",
                        action: target["è¡Œä¸º"] || target.action || target.behavior || target.ACTION || target.plan || target.PLAN || "æœªçŸ¥"
                    };
                }

                // 2. æ­£åˆ™æš´åŠ›æå– (å…œåº•)
                if (!result || (result.mind === "æœªçŸ¥" && result.clothes === "æœªçŸ¥")) {
                    const extract = (keys) => {
                        for (let k of keys) {
                            // å¢å¼ºæ­£åˆ™ï¼šæ”¯æŒæ¢è¡Œï¼Œæ”¯æŒå¿½ç•¥å¯é€‰å¼•å·
                            const reg = new RegExp(`(?:\\\\")?${k}(?:\\\\")?\\s*[:ï¼š]\\s*(?:\\\\")?((?:[^"\\\\}]|\\\\.)*?)(?:\\\\")?(?:,|}|$)`, 'i');
                            const m = raw.match(reg);
                            if (m && m[1]) return m[1].replace(/\\"/g, '"').trim();
                        }
                        return null;
                    };

                    const outfit = extract(['ç€è£…', 'outfit', 'clothes', 'clothing', 'OUTFIT']);
                    const scene = extract(['ç¯å¢ƒ', 'scene', 'environment', 'SCENE']);
                    const mind = extract(['å¿ƒå£°', 'thoughts', 'mind', 'inner_voice', 'thought', 'THOUGHTS', 'emotion', 'EMOTION']);
                    const action = extract(['è¡Œä¸º', 'action', 'behavior', 'ACTION', 'plan', 'PLAN']);

                    if (outfit || scene || mind || action) {
                        result = {
                            clothes: outfit || "æœªçŸ¥",
                            scene: scene || "æœªçŸ¥",
                            mind: mind || "æœªçŸ¥",
                            action: action || "æœªçŸ¥"
                        };
                    }
                }

                return result;
            },

            openModal: () => {
                InnerVoiceUI.init();
                InnerVoiceUI.currentIndex = -1;
                InnerVoiceUI.renderCardData();
                document.getElementById('inner-voice-modal').classList.add('active');
                InnerVoiceUI.startAnimation();
            },

            closeModal: () => {
                document.getElementById('inner-voice-modal').classList.remove('active');
                if (InnerVoiceUI.animationId) cancelAnimationFrame(InnerVoiceUI.animationId);
            },

            prevVoice: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char || !char.innerVoices) return;

                // If currently at "latest" (-1), set to numerical index of last item
                if (InnerVoiceUI.currentIndex === -1) InnerVoiceUI.currentIndex = char.innerVoices.length - 1;

                if (InnerVoiceUI.currentIndex > 0) {
                    InnerVoiceUI.currentIndex--;
                    InnerVoiceUI.renderCardData();
                } else {
                    Utils.showToast('å·²ç»æ˜¯ç¬¬ä¸€æ¡äº†');
                }
            },

            nextVoice: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char || !char.innerVoices) return;

                if (InnerVoiceUI.currentIndex === -1) InnerVoiceUI.currentIndex = char.innerVoices.length - 1;

                if (InnerVoiceUI.currentIndex < char.innerVoices.length - 1) {
                    InnerVoiceUI.currentIndex++;
                    InnerVoiceUI.renderCardData();
                } else {
                    Utils.showToast('è¿™æ˜¯æœ€æ–°çš„ä¸€æ¡');
                }
            },

            toggleManageMode: () => {
                const charView = document.getElementById('voice-character-view');
                const historyView = document.getElementById('voice-history-view');
                if (charView.classList.contains('hidden')) {
                    charView.classList.remove('hidden');
                    historyView.classList.add('hidden');
                } else {
                    charView.classList.add('hidden');
                    historyView.classList.remove('hidden');
                    InnerVoiceUI.renderHistoryList();
                }
            },

            toggleEffect: () => {
                const idx = InnerVoiceUI.effectTypes.indexOf(InnerVoiceUI.currentEffect);
                InnerVoiceUI.currentEffect = InnerVoiceUI.effectTypes[(idx + 1) % InnerVoiceUI.effectTypes.length];
                document.getElementById('effect-name-badge').innerText = InnerVoiceUI.currentEffect.name;
                InnerVoiceUI.startAnimation();
            },

            // --- ã€æ ¸å¿ƒä¿®å¤ã€‘æ•°æ®æ¸²æŸ“é€»è¾‘ ---
            renderCardData: () => {
                if (!InnerVoiceUI.currentCharId) return;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];

                let data = {};
                let displayIndex = InnerVoiceUI.currentIndex;
                if (voices.length > 0) {
                    if (displayIndex === -1) displayIndex = voices.length - 1;
                    data = voices[displayIndex] || {};
                }

                // ä¿®å¤ï¼šæ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…TypeError
                const avatarEl = document.getElementById('voice-char-avatar');
                if (avatarEl) avatarEl.src = char.avatar || WeChatUI.getRandomAvatar();

                const nameEl = document.getElementById('voice-char-name');
                if (nameEl) nameEl.innerText = char.nickname || char.name;

                const moodEl = document.getElementById('voice-char-mood');
                if (moodEl) moodEl.innerText = `Current Mood / ${voices.length > 0 ? 'å·²è®°å½•' : 'æ— è®°å½•'} `;

                const timeStr = data.timestamp ? new Date(data.timestamp).toLocaleString() : '---';
                document.getElementById('voice-index-indicator').innerText = `NO.${displayIndex + 1} Â· ${timeStr} `;

                // --- æ™ºèƒ½è§£æå†…å®¹ (ä½¿ç”¨ç»Ÿä¸€è§£æå™¨) ---
                let contentObj = {};
                // å¦‚æœ content æ˜¯å¯¹è±¡ï¼Œç›´æ¥åˆå¹¶ï¼›å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                if (data.content) {
                    const parsed = InnerVoiceUI.parseVoiceData(data.content);
                    if (parsed) {
                        contentObj = parsed;
                    } else if (typeof data.content === 'object') {
                        contentObj = data.content;
                    }
                } else {
                    // å¦‚æœ data æœ¬èº«å°±æ˜¯æ‰å¹³å¯¹è±¡ (æ—§æ•°æ®å…¼å®¹)
                    contentObj = { ...data };
                    delete contentObj.id;
                    delete contentObj.timestamp;
                }

                // å¡«å……åˆ° HTML (å…¼å®¹ä¸­æ–‡é”®åå’Œè‹±æ–‡é”®å)
                // ä¼˜å…ˆå–æ ‡å‡†è‹±æ–‡ key (clothes, scene, mind, action)ï¼Œå…¶æ¬¡å–ä¸­æ–‡ key
                const outfit = contentObj.clothes || contentObj.ç€è£… || contentObj.outfit || contentObj.OUTFIT || 'â€”';
                const scene = contentObj.scene || contentObj.ç¯å¢ƒ || contentObj.environment || contentObj.SCENE || 'â€”';
                const mind = contentObj.mind || contentObj.å¿ƒå£° || contentObj.thoughts || contentObj.THOUGHTS || 'ï¼ˆæ­¤åˆ»å†…å¿ƒæ¯«æ— æ³¢æ¾œ...ï¼‰';
                const action = contentObj.action || contentObj.è¡Œä¸º || contentObj.behavior || contentObj.ACTION || 'â€”';

                document.getElementById('voice-outfit-text').innerText = outfit;
                document.getElementById('voice-scene-text').innerText = scene;
                document.getElementById('voice-thoughts-text').innerText = mind;
                document.getElementById('voice-action-text').innerText = action;
            },

            renderHistoryList: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = (char.innerVoices || []).slice().reverse();
                const listEl = document.getElementById('voice-history-list');

                if (voices.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-gray-500 mt-10 text-xs">æš‚æ— å†å²è®°å½•</div>';
                    return;
                }

                listEl.innerHTML = voices.map((v, idx) => {
                    const realIndex = (char.innerVoices.length - 1) - idx;

                    // å†å²åˆ—è¡¨é¢„è§ˆä¹Ÿè¦åšåŒæ ·çš„è§£æå¤„ç†
                    let preview = '...';
                    const data = InnerVoiceUI.parseVoiceData(v.content);
                    if (data) {
                        preview = data.mind || data.thoughts || data.å¿ƒå£° || '...';
                    } else if (typeof v.content === 'string') {
                        preview = v.content.substring(0, 35);
                    }

                    return `
                        <div class="voice-history-card" onclick="InnerVoiceUI.loadFromHistory(${realIndex})">
                            <div class="voice-history-time">${new Date(v.timestamp).toLocaleString()}</div>
                            <div class="voice-history-preview">${preview}</div>
                        </div>
                            `;
                }).join('');
            },

            loadFromHistory: (index) => {
                InnerVoiceUI.currentIndex = index;
                document.getElementById('voice-character-view').classList.remove('hidden');
                document.getElementById('voice-history-view').classList.add('hidden');
                InnerVoiceUI.renderCardData();
            },

            deleteCurrent: () => {
                if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡å¿ƒå£°å—ï¼Ÿ')) return;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];

                const idx = InnerVoiceUI.currentIndex === -1 ? voices.length - 1 : InnerVoiceUI.currentIndex;
                if (idx >= 0 && idx < voices.length) {
                    voices.splice(idx, 1);
                    AppStorage.set('wechat_chars', chars);
                    InnerVoiceUI.currentIndex = -1;
                    InnerVoiceUI.renderCardData();
                    Utils.showToast('å·²åˆ é™¤');
                }
            },

            addVoice: (content, targetCid = null) => {
                const chars = AppStorage.get('wechat_chars', {});
                // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ ID (ç”¨äºåå°å¤„ç†)ï¼Œå¦åˆ™è¯»å– DOM (ç”¨äºå‰å°äº¤äº’)
                const cid = targetCid || document.getElementById('subpage-chat-detail')?.dataset.charId;

                if (!cid) return;

                if (!chars[cid]) return; // å®‰å…¨æ£€æŸ¥

                if (!chars[cid].innerVoices) chars[cid].innerVoices = [];

                // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ç»Ÿä¸€è§£æå™¨ï¼Œä¼˜å…ˆå­˜å¯¹è±¡
                let savedContent = content;
                const parsed = InnerVoiceUI.parseVoiceData(content);
                if (parsed) {
                    savedContent = parsed;
                }

                chars[cid].innerVoices.push({
                    id: Date.now(),
                    content: savedContent,
                    timestamp: Date.now()
                });

                // é™åˆ¶é•¿åº¦
                if (chars[cid].innerVoices.length > 50) chars[cid].innerVoices.shift();

                AppStorage.set('wechat_chars', chars);
            },

            // --- ç²’å­åŠ¨ç”» (ä¿æŒä¸å˜) ---
            startAnimation: () => {
                const canvas = document.getElementById('voice-effect-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const width = canvas.offsetWidth;
                const height = canvas.offsetHeight;
                canvas.width = width;
                canvas.height = height;

                let particles = [];
                let animationId;
                let lastLaunch = 0;

                class Particle {
                    constructor(typeOverride, startX, startY) {
                        this.init(typeOverride, startX, startY);
                    }
                    init(typeOverride, startX, startY) {
                        const effect = InnerVoiceUI.currentEffect;
                        if (typeOverride === 'burst') {
                            this.isBurst = true;
                            this.x = startX; this.y = startY;
                            this.prevX = this.x; this.prevY = this.y;
                            const angle = Math.random() * Math.PI * 2;
                            const speed = Math.random() * 1.5 + 0.5;
                            this.vx = Math.cos(angle) * speed;
                            this.vy = Math.sin(angle) * speed;
                            this.gravity = 0.03; this.drag = 0.96;
                            this.alpha = 1; this.decay = Math.random() * 0.01 + 0.005;
                            this.size = Math.random() * 1.5 + 0.5;
                            return;
                        }
                        this.isBurst = false;
                        this.x = Math.random() * width;
                        this.alpha = Math.random() * 0.5 + 0.2;

                        if (effect.type === 'sway_fall') {
                            this.y = -10;
                            this.vy = Math.random() * 0.5 + 0.3;
                            this.vx = 0;
                            this.size = Math.random() * 4 + 2;
                            this.sway = Math.random() * Math.PI * 2;
                            this.swaySpeed = Math.random() * 0.02 + 0.01;
                            this.rotation = Math.random() * 360;
                            this.rotSpeed = Math.random() - 0.5;
                        } else if (effect.type.includes('rain')) {
                            this.y = Math.random() * height;
                            this.vx = -0.5; this.vy = Math.random() * 10 + 15;
                            this.size = Math.random() * 20 + 10;
                            this.alpha = 0.2;
                        } else if (effect.type === 'meteor') {
                            this.x = Math.random() * width * 1.5 - width * 0.25;
                            this.y = -100;
                            this.vx = -4 - Math.random() * 4; this.vy = 4 + Math.random() * 4;
                            this.size = Math.random() * 30 + 20;
                            this.alpha = 0; this.delay = Math.random() * 100;
                        } else if (effect.type === 'float_up_fade' || effect.type === 'flow_up') {
                            this.y = height + 10;
                            this.vx = Math.random() * 0.5 - 0.25;
                            this.vy = -(Math.random() * 1 + 0.5);
                            this.size = Math.random() * 2 + 1;
                            if (effect.type === 'float_up_fade') { this.alpha = 1; this.decay = 0.01; }
                        } else {
                            this.y = Math.random() * height;
                            this.vx = Math.random() - 0.5; this.vy = Math.random() - 0.5;
                            this.size = 2;
                        }
                        this.prevX = this.x; this.prevY = this.y;
                    }
                    update() {
                        this.prevX = this.x; this.prevY = this.y;
                        const effect = InnerVoiceUI.currentEffect;

                        if (this.isBurst) {
                            this.vx *= this.drag; this.vy *= this.drag; this.vy += this.gravity;
                            this.x += this.vx; this.y += this.vy; this.alpha -= this.decay;
                        } else if (effect.type === 'sway_fall') {
                            this.y += this.vy;
                            this.sway += this.swaySpeed;
                            this.x += Math.sin(this.sway) * 0.5;
                            this.rotation += this.rotSpeed;
                            if (this.y > height + 20) this.init();
                        } else if (effect.type === 'meteor') {
                            if (this.delay > 0) { this.delay--; return; }
                            this.x += this.vx; this.y += this.vy;
                            if (this.y < height / 2) this.alpha += 0.05; else this.alpha -= 0.05;
                            if (this.alpha > 1) this.alpha = 1;
                            if (this.y > height + 100) this.init(null, null, null);
                        } else {
                            this.x += this.vx; this.y += this.vy;
                            if (effect.type === 'float_up_fade') {
                                this.alpha -= 0.005; if (this.alpha <= 0) this.init();
                            }
                            if (this.y > height + 20 && this.vy > 0) this.init();
                            if (this.y < -20 && this.vy < 0) this.init();
                        }
                    }
                    draw() {
                        if (this.alpha <= 0) return;
                        ctx.save();
                        const effect = InnerVoiceUI.currentEffect;

                        if (effect.type === 'sway_fall') {
                            ctx.translate(this.x, this.y);
                            ctx.rotate(this.rotation * Math.PI / 180);
                            ctx.fillStyle = `rgba(${effect.color}, ${this.alpha})`;
                            ctx.beginPath();
                            if (effect.id === 'bamboo') ctx.ellipse(0, 0, this.size / 3, this.size, 0, 0, Math.PI * 2);
                            else if (effect.id === 'sakura') { ctx.moveTo(0, 0); ctx.bezierCurveTo(this.size / 2, -this.size / 2, this.size, 0, 0, this.size); ctx.bezierCurveTo(-this.size, 0, -this.size / 2, -this.size / 2, 0, 0); }
                            else ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                            ctx.fill();
                        } else if (this.isBurst || effect.type === 'flow_up' || effect.type.includes('rain') || effect.type === 'meteor') {
                            ctx.strokeStyle = `rgba(${effect.color}, ${this.alpha})`;
                            ctx.lineWidth = this.isBurst ? this.size : 1;
                            if (effect.type === 'meteor') ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(this.prevX, this.prevY);
                            let endX = this.x; let endY = this.y;
                            if (effect.type.includes('rain')) { endX = this.x + this.vx * 2; endY = this.y + this.size; }
                            else if (effect.type === 'meteor') { ctx.moveTo(this.x, this.y); endX = this.x - this.vx * 8; endY = this.y - this.vy * 8; }
                            ctx.lineTo(endX, endY);
                            ctx.stroke();
                        } else {
                            ctx.translate(this.x, this.y);
                            ctx.fillStyle = `rgba(${effect.color}, ${this.alpha})`;
                            if (effect.id === 'firefly') { ctx.shadowBlur = 5; ctx.shadowColor = `rgba(${effect.color}, 1)`; }
                            ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
                        }
                        ctx.restore();
                    }
                }

                if (InnerVoiceUI.currentEffect.type !== 'burst') {
                    let count = 40;
                    if (InnerVoiceUI.currentEffect.type.includes('rain')) count = 100;
                    if (InnerVoiceUI.currentEffect.type === 'meteor') count = 5;
                    for (let i = 0; i < count; i++) particles.push(new Particle());
                }

                function drawLightning() {
                    if (InnerVoiceUI.currentEffect.id !== 'storm') return;
                    if (Math.random() < 0.008) {
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                        ctx.fillRect(0, 0, width, height);
                        ctx.beginPath();
                        let lx = Math.random() * width; let ly = 0;
                        ctx.moveTo(lx, ly);
                        while (ly < height) { lx += (Math.random() - 0.5) * 80; ly += Math.random() * 50 + 20; ctx.lineTo(lx, ly); }
                        ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 2; ctx.stroke();
                    }
                }

                function loop(timestamp) {
                    if (!document.getElementById('inner-voice-modal').classList.contains('active')) return;

                    ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    ctx.fillRect(0, 0, width, height);
                    ctx.globalCompositeOperation = 'lighter';

                    drawLightning();

                    if (InnerVoiceUI.currentEffect.type === 'burst') {
                        if (timestamp - lastLaunch > Math.random() * 2000 + 1500) {
                            const x = Math.random() * width * 0.6 + width * 0.2;
                            const y = Math.random() * height * 0.4 + height * 0.1;
                            for (let i = 0; i < 50; i++) particles.push(new Particle('burst', x, y));
                            lastLaunch = timestamp;
                        }
                    }

                    for (let i = particles.length - 1; i >= 0; i--) {
                        particles[i].update();
                        particles[i].draw();
                        if (particles[i].isBurst && particles[i].alpha <= 0) particles.splice(i, 1);
                    }

                    ctx.globalCompositeOperation = 'source-over';
                    InnerVoiceUI.animationId = requestAnimationFrame(loop);
                }

                if (InnerVoiceUI.animationId) cancelAnimationFrame(InnerVoiceUI.animationId);
                InnerVoiceUI.animationId = requestAnimationFrame(loop);
            }
        };














        // --- é’±åŒ…é€»è¾‘æ§åˆ¶å™¨ (æ–°å¢) ---
        window.WalletLogic = {
            // æ·»åŠ äº¤æ˜“è®°å½•
            addTransaction: (cid, data) => {
                const walletData = AppStorage.get('wechat_wallet_data', {}) || {};
                if (!walletData[cid]) walletData[cid] = { balance: 0.00, transactions: [] };

                // æ„é€ æ–°äº¤æ˜“
                const newTx = {
                    id: 'tx_' + Date.now() + Math.random().toString(36).substr(2, 5),
                    type: data.type || 'expense', // expense | income
                    amount: parseFloat(data.amount) || 0,
                    title: data.title || 'æœªçŸ¥äº¤æ˜“',
                    time: data.time || new Date().toLocaleString(),
                    category: data.category || 'è´­ç‰©'
                };

                // æ›´æ–°ä½™é¢
                if (newTx.type === 'expense') {
                    walletData[cid].balance -= newTx.amount;
                } else {
                    walletData[cid].balance += newTx.amount;
                }

                // æ·»åŠ è®°å½• (æœ€æ–°åœ¨å‰)
                walletData[cid].transactions.unshift(newTx);

                // ä¿å­˜
                AppStorage.set('wechat_wallet_data', walletData);

                // å°è¯•åˆ·æ–°UI (å¦‚æœæœ‰)
                try {
                    if (window.SearchPhoneUI && SearchPhoneUI.currentApp === 'wallet' && SearchPhoneUI.renderWallet) {
                        SearchPhoneUI.renderWallet(cid);
                    }
                } catch (e) { console.warn('Wallet UI refresh failed', e); }
            },

            // è·å–ä½™é¢
            getBalance: (cid) => {
                const walletData = AppStorage.get('wechat_wallet_data', {}) || {};
                return walletData[cid]?.balance || 0.00;
            }
        };

        window.SearchPhoneUI = {

            targetCharId: null,
            currentApp: null,

            // åˆå§‹åŒ–ï¼šæ¸²æŸ“è§’è‰²åˆ—è¡¨
            init: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const list = document.getElementById('search-char-list');
                list.innerHTML = Object.values(chars).map(c => `
                            <div onclick="SearchPhoneUI.openCharPhone('${c.id}')" class="flex flex-col items-center gap-2 cursor-pointer p-2 rounded-xl hover:bg-white/10 transition-all">
                        <div class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-600">
                            <img src="${c.avatar}" class="w-full h-full object-cover">
                        </div>
                        <span class="text-xs truncate w-full text-center">${c.name}</span>
                    </div >
                            `).join('');
            },

            // è¿›å…¥ä¼ªè£…æ¡Œé¢
            openCharPhone: (id) => {
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[id]) return;
                SearchPhoneUI.targetCharId = id;
                document.getElementById('search-desktop-title').textContent = chars[id].name + 'çš„æ‰‹æœº';
                document.getElementById('search-page-select').classList.add('hidden');

                // åº”ç”¨ä¿å­˜çš„æ‰‹æœºé…ç½®
                const config = SearchPhoneUI.getPhoneConfig();
                SearchPhoneUI.applyPhoneConfig(config);

                // æ˜¾ç¤ºæŸ¥æ‰‹æœºé¡µé¢
                document.getElementById('search-page-desktop').classList.remove('hidden');

                // åŠ è½½å°ç»„ä»¶å›¾ç‰‡
                SearchPhoneUI.loadWidgets();
            },

            backToSelect: () => {
                document.getElementById('search-page-desktop').classList.add('hidden');
                document.getElementById('search-page-select').classList.remove('hidden');
            },

            openSubApp: (appName) => {
                try {
                    // Clear any pending close timer
                    if (SearchPhoneUI.subAppCloseTimer) {
                        clearTimeout(SearchPhoneUI.subAppCloseTimer);
                        SearchPhoneUI.subAppCloseTimer = null;
                    }

                    // Utils.showToast('æ­£åœ¨æ‰“å¼€ ' + appName); // Debug
                    SearchPhoneUI.currentApp = appName;
                    const titleMap = {
                        'wechat': 'å¾®ä¿¡', 'wallet': 'é’±åŒ…', 'browser': 'æµè§ˆå™¨',
                        'shopping': 'æ·˜å®', 'diary': 'ç§˜å¯†æ—¥è®°', 'notes': 'å¤‡å¿˜å½•',
                        'weibo': 'å¾®åš', 'footprint': 'åœ°å›¾è¶³è¿¹', 'gallery': 'ç›¸å†Œ',
                        'schedule': 'æ—¥ç¨‹', 'worldbook': 'ä¸–ç•Œä¹¦'
                    };

                    const genBtn = document.getElementById('btn-subapp-gen');
                    if (genBtn) genBtn.style.display = 'none';

                    const titleEl = document.getElementById('subapp-title');
                    if (titleEl) titleEl.textContent = titleMap[appName] || appName;

                    const modal = document.getElementById('modal-phone-subapp');

                    // Force Visible Phase
                    modal.style.display = 'flex';
                    modal.classList.remove('hidden');
                    void modal.offsetWidth; // Force Reflow

                    // Animate Phase
                    modal.style.transform = 'translateY(0)';
                    modal.classList.remove('translate-y-full'); // Cleanup class
                    modal.style.pointerEvents = 'auto';

                    // æ¸²æŸ“å†…å®¹
                    SearchPhoneUI.renderSubAppContent();
                } catch (e) {
                    console.error('OpenApp Error:', e);
                    Utils.showToast('åº”ç”¨æ‰“å¼€å¤±è´¥: ' + e.message);
                }
            },

            closeSubApp: () => {
                const modal = document.getElementById('modal-phone-subapp');

                // Animate Out
                modal.style.transform = 'translateY(100%)';
                modal.classList.add('translate-y-full'); // Sync class
                modal.style.pointerEvents = 'none';

                // Hide completely after transition
                SearchPhoneUI.subAppCloseTimer = setTimeout(() => {
                    modal.style.display = 'none';
                    modal.classList.add('hidden');
                    // Do NOT reset transform here. Keep it off screen.
                }, 350);

                // Reset current app
                SearchPhoneUI.currentApp = null;

                // Aggressive Unlock (Simple)
                document.body.style.pointerEvents = 'auto';
                document.body.style.overflow = '';
            },

            // æ¸…ç©ºå½“å‰å­åº”ç”¨æ•°æ®
            clearSubAppData: () => {
                if (!confirm('ç¡®å®šæ¸…ç©ºæ­¤åº”ç”¨çš„è®°å½•å—ï¼Ÿ')) return;
                const allData = AppStorage.get('wechat_search_phone_data', {});
                if (allData[SearchPhoneUI.targetCharId]) {
                    delete allData[SearchPhoneUI.targetCharId][SearchPhoneUI.currentApp];
                    AppStorage.set('wechat_search_phone_data', allData);
                    SearchPhoneUI.renderSubAppContent();
                    Utils.showToast('è®°å½•å·²ç²‰ç¢');
                }
            },

            // æ ¸å¿ƒï¼šä½¿ç”¨ä¸»APIç”Ÿæˆå†…å®¹ (å¾®ä¿¡å¢å¼ºç‰ˆ - ä¿®å¤ç‰ˆ)
            // æ„å»ºé€šç”¨ä¸Šä¸‹æ–‡ (äººè®¾ + æœ€è¿‘èŠå¤© + å¿ƒå£°)
            buildCommonContext: (char) => {
                let latestVoice = '';
                if (char.innerVoices && char.innerVoices.length > 0) {
                    const v = char.innerVoices[char.innerVoices.length - 1];
                    if (typeof v.content === 'object') {
                        latestVoice = v.content.å¿ƒå£° || v.content.thoughts || '';
                    } else {
                        const m = String(v.content).match(/(?:å¿ƒå£°|å†…å¿ƒ|THOUGHTS)[:ï¼š]\s*(.*?)(?=\n|$)/i);
                        latestVoice = m ? m[1] : String(v.content).substring(0, 50);
                    }
                }

                const recentMsgs = (char.msgs || []).slice(-50).map(m =>
                    `[${m.role === 'user' ? 'User' : 'Char'}] ${String(m.content).substring(0, 50)}`
                ).join('\n');

                // è·å–ç”¨æˆ·äººè®¾
                const userProfile = AppStorage.get('wechat_user_profile', {});
                const commonUserProfile = AppStorage.get('common_user_profile', '');
                const userPersonaText = userProfile.persona || commonUserProfile || 'æ™®é€šç”¨æˆ·';

                return `ã€è§’è‰²(Char)äººè®¾ã€‘
${char.prompt || 'æ™®é€šäºº'}
(æœ€æ–°å¿ƒå£°: ${latestVoice})

ã€ç”¨æˆ·(User)äººè®¾ã€‘
${userPersonaText}
(ç”¨æˆ·æ˜µç§°: ${userProfile.name || 'æˆ‘'})

ã€æœ€è¿‘èŠå¤©ä¸Šä¸‹æ–‡ (ç”¨äºç”Ÿæˆç›¸å…³å†…å®¹)ã€‘
${recentMsgs}`;
            },

            // æ ¸å¿ƒï¼šä¸‡èƒ½ç”Ÿæˆå‡½æ•° (æ”¯æŒæ‰€æœ‰APP: å¾®ä¿¡, å¾®åš, æ—¥è®°, å¤‡å¿˜å½•...)
            generateSubAppData: async (isAutoAll = false, targetApp = null) => {
                const cid = SearchPhoneUI.targetCharId;
                const appName = targetApp || SearchPhoneUI.currentApp;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];

                // é’±åŒ…ï¼šç‹¬ç«‹å¤„ç†
                if (appName === 'wallet') {
                    if (SearchPhoneUI.generateWalletTransactions) await SearchPhoneUI.generateWalletTransactions(cid);
                    return;
                }

                const supportedApps = ['wechat', 'weibo', 'diary', 'notes', 'browser', 'shopping', 'footprint', 'schedule'];
                if (!supportedApps.includes(appName)) {
                    if (!isAutoAll) Utils.showToast('è¯¥åº”ç”¨æš‚ä¸æ”¯æŒè‡ªåŠ¨åŒ–ç”Ÿæˆ');
                    return;
                }

                const btn = document.getElementById('btn-subapp-gen');
                let originalIcon = '<i class="fa-solid fa-wand-magic-sparkles"></i> ç ´è§£æ•°æ®';
                if (btn && !isAutoAll) {
                    if (!btn.innerHTML.includes('fa-spinner')) originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                    btn.disabled = true;
                }
                if (!isAutoAll) Utils.showToast('æ­£åœ¨è·å–æ•°æ®...');

                try {
                    let userRequest = "";
                    if (!isAutoAll) {
                        if (btn) { btn.innerHTML = originalIcon; btn.disabled = false; }
                        const inputVal = await Utils.showPromptAsync(`ç”Ÿæˆ ${appName} å†…å®¹`, "è¯·è¾“å…¥å…·ä½“éœ€æ±‚ï¼ˆå¦‚'æœ€è¿‘å¿ƒæƒ…'ï¼‰ã€‚ç•™ç©ºéšæœºã€‚");
                        if (inputVal === null) return;
                        userRequest = inputVal.trim();
                        if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; }
                        Utils.showToast('AI æ­£åœ¨ç¼–é€ æ•°æ®...');
                    }


                    const commonContext = SearchPhoneUI.buildCommonContext(char);

                    // --- å†å²æ•°æ®æ³¨å…¥ (Context Injection) ---
                    // è·å–å½“å‰åº”ç”¨æœ€è¿‘çš„ 3-5 æ¡è®°å½•ï¼Œæ³¨å…¥åˆ° Prompt ä¸­ï¼Œé¿å…å†…å®¹é‡å¤æˆ–ä¸è¿è´¯
                    let appHistoryContext = "";
                    const currentAppData = AppStorage.get('wechat_search_phone_data', {})[cid]?.[appName];

                    if (currentAppData && Array.isArray(currentAppData) && currentAppData.length > 0) {
                        const recent = currentAppData.slice(0, 5); // å–æœ€è¿‘5æ¡
                        appHistoryContext = `\nã€${appName} å†å²è®°å½• (ä»…ä¾›å‚è€ƒï¼Œä¸è¦é‡å¤)ã€‘\n` + JSON.stringify(recent.map(item => {
                            // ç®€åŒ–å­—æ®µï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯ä»¥èŠ‚çœ Token
                            if (appName === 'weibo') return { content: item.content, time: item.time };
                            if (appName === 'diary') return { date: item.date, title: item.title, summary: (item.content || '').substring(0, 50) };
                            if (appName === 'notes') return { title: item.title, items: item.items };
                            if (appName === 'shopping') return { item: item.item, price: item.price };
                            if (appName === 'shopping') return { item: item.item, price: item.price };
                            if (appName === 'schedule') return { time: item.time, event: item.event };
                            if (appName === 'footprint') return { place: item.place, time: item.time, desc: item.desc };
                            return item;
                        }), null, 2);
                    }

                    // Extract latest voice for specific use
                    let latestVoice = "æ— ";
                    if (char.innerVoices && char.innerVoices.length > 0) {
                        const v = char.innerVoices[char.innerVoices.length - 1];
                        if (typeof v.content === 'object') latestVoice = v.content.å¿ƒå£° || v.content.thoughts || '';
                        else {
                            const m = String(v.content).match(/(?:å¿ƒå£°|å†…å¿ƒ|THOUGHTS)[:ï¼š]\s*(.*?)(?=\n|$)/i);
                            latestVoice = m ? m[1] : String(v.content).substring(0, 50);
                        }
                    }

                    let prompt = "";
                    let systemInstruction = "ä½ æ˜¯ä¸€ä¸ªJSONç”Ÿæˆå™¨ã€‚å¿…é¡»åªè¾“å‡ºJSONï¼Œæ— Markdownã€‚";

                    switch (appName) {
                        case 'wechat':
                            // --- Build NPC Chat Context for Iteration ---
                            let npcChatContext = "";
                            const existingChats = AppStorage.get('wechat_search_phone_data', {})[cid]?.wechat || [];
                            if (existingChats.length > 0) {
                                // Get top 5 active threads
                                const activeThreads = existingChats.slice(0, 5).map(c => {
                                    const lastFew = (c.history || []).slice(-2).map(m => `${m.name || m.role}: ${m.msg || m.content}`).join(" | ");
                                    return `- [${c.type === 'group' ? 'ç¾¤' : 'äºº'}] ${c.name}: ${lastFew}`;
                                }).join("\n");
                                npcChatContext = `ã€å½“å‰æ´»è·ƒä¼šè¯ (è¯·ä¼˜å…ˆé€‰æ‹© 1-2 ä¸ªè¿›è¡Œå›å¤/å»¶ç»­)ã€‘\n${activeThreads}`;
                            }

                            prompt = `ä½ æ˜¯ä¸€ä¸ªç¼–å‰§ã€‚ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆå¾®ä¿¡èŠå¤©è®°å½•ã€‚

${commonContext}
${npcChatContext}

ã€ç½®é¡¶è”ç³»äºº (ä»…ä¿®æ”¹å¤‡æ³¨)ã€‘
å½“å‰ç½®é¡¶è”ç³»äººæ˜¯ï¼šã€${char.pinnedUser || 'æœªè®¾ç½®'}ã€‘ã€‚
**æ— éœ€ç”Ÿæˆå¯¹è¯**ï¼ˆç³»ç»Ÿè‡ªå¸¦ï¼‰ã€‚
**ä»»åŠ¡**ï¼šè¯·æ ¹æ®å½“å‰å…³ç³»ï¼ˆå¦‚å˜å¾—æ›´äº²å¯†ã€åˆšåµå®Œæ¶ç­‰ï¼‰ï¼Œ**é‡æ–°æ‹Ÿå®š**TAçš„å¤‡æ³¨åï¼ˆå¦‚æ”¹ä¸ºâ€˜è€å…¬â€™ã€â€˜å°çŒªâ€™ã€â€˜ä¸»äººâ€™ã€â€˜Darlingâ€™ç­‰ï¼‰ã€‚
**è§„åˆ™**ï¼š
- å¦‚æœå…³ç³»äº²å¯†ï¼Œ**å¿…é¡»**ä¿®æ”¹ä¸ºä¸€ä¸ªç”œè…»æˆ–ä¸“å±çš„ç§°å‘¼ã€‚
- å¦‚æœåœ¨å†·æˆ˜ï¼Œå¯ä»¥æ”¹å›å…¨åã€‚
- è¯·åœ¨ JSON çš„ pinned_remark å­—æ®µè¿”å›æ–°ç§°å‘¼ã€‚

ã€ç”¨æˆ·éœ€æ±‚ã€‘
${userRequest || "å»¶ç»­ä¹‹å‰çš„ç¾¤èŠè¯é¢˜ï¼Œæˆ–è€…å¼€å¯æ–°è¯é¢˜"}

ã€ç”Ÿæˆè§„åˆ™ã€‘
1. **ç½®é¡¶å¤‡æ³¨**ï¼šå¿…é¡»è¯„ä¼°å¹¶è¿”å› pinned_remarkã€‚
2. **ç”Ÿæˆ NPC ä¼šè¯**ï¼šç”Ÿæˆ 2-4 ä¸ªä¼šè¯ã€‚
   - **è¿­ä»£æ¨¡å¼ï¼ˆä¼˜å…ˆï¼‰**ï¼šæŸ¥çœ‹ã€å½“å‰æ´»è·ƒä¼šè¯ã€‘ï¼Œé€‰æ‹© 1-2 ä¸ªç‰¹å®šçš„äºº/ç¾¤ï¼Œé’ˆå¯¹ä¹‹å‰çš„æ¶ˆæ¯è¿›è¡Œå›å¤æˆ–å±•å¼€æ–°è¯é¢˜ï¼ˆä¿æŒäººè®¾ä¸€è‡´ï¼‰ã€‚
   - **æ–°å¢æ¨¡å¼**ï¼šå¦‚æœæ´»è·ƒä¼šè¯ä¸å¤Ÿï¼Œå¯è™šæ„æ–°è”ç³»äºº/ç¾¤ã€‚
   - **å•äºº**ï¼šè™šæ„/æ²¿ç”¨å…·ä½“èº«ä»½ï¼Œå¿…é¡»ç”Ÿæˆ distinct çš„å¤‡æ³¨åã€‚
   - **ç¾¤èŠ**ï¼šè™šæ„/æ²¿ç”¨ç¾¤ç»„ï¼Œ**ç¾¤å‹å¿…é¡»æœ‰ä¸åŒçš„æ˜µç§°**ã€‚
3. **èŠå¤©é…å›¾**ï¼š
   - **äººç‰©/è‡ªæ‹**ï¼šå¿…é¡»æ˜¯äºŒæ¬¡å…ƒé£æ ¼ã€‚URL: ".../prompt/girl,anime style?width=800&height=800&model=any-dark"
   - **é£Ÿç‰©/é£æ™¯/ç‰©å“**ï¼šå¿…é¡»å†™å®ã€‚URL: ".../prompt/delicious food?width=800&height=800&model=flux"
   
ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{
  "pinned_remark": "è€å…¬",
  "chats": [
    {
      "type": "single",
      "name": "NPCå¤‡æ³¨å(å¿…é¡»ä¸å†å²ä¸€è‡´æ‰ä¼šè¢«åˆå¹¶)",
      "avatar": "...",
      "history": [ { "role": "npc", "msg": "çœ‹æˆ‘æ–°ä¹°çš„è£™å­ï¼\\n![img](https://image.pollinations.ai/prompt/dress,anime?width=800&height=800&model=any-dark)" } ]
    },
    { "type": "group", "name": "åƒç“œå°åˆ†é˜Ÿ", "history": [ {"role": "npc", "name": "ç¾¤å‹A", "msg": "å›ä¸Šä¸€å¥..."}, {"role": "npc", "name": "ç¾¤å‹B", "msg": "..."} ] }
  ]
}`; break;


                        case 'weibo':
                            prompt = `ä½ æ˜¯ä¸€ä¸ªç¤¾äº¤åª’ä½“ç»ç†ã€‚ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆå¾®åšã€‚

${commonContext}
${appHistoryContext}

ã€ç”¨æˆ·éœ€æ±‚ã€‘
${userRequest || "æ ¹æ®èŠå¤©è¯é¢˜ç”Ÿæˆå¾®åš"}

ã€è§„åˆ™ã€‘
1. ç”Ÿæˆ 3-5 æ¡å¾®åšã€‚å¦‚æœæ˜¯å¼€å¿ƒï¼Œé…å¤šå›¾ï¼›emoåˆ™é…æ–‡å­—å›¾ã€‚
2. **ç»å¯¹ç¦æ­¢**å‡ºç° '###', '[INNER_VOICE]' æ ‡ç­¾ã€‚
3. **é…å›¾URLè§„åˆ™**ï¼š
   - **å«äººç‰©/è‡ªæ‹**ï¼š".../prompt/keyword,anime style?width=1024&height=1024&model=any-dark"
   - **çº¯é£æ™¯/ç¾é£Ÿ**ï¼š".../prompt/keyword?width=1024&height=1024&model=flux"
4. **èº«ä»½**ï¼šä½ å°±æ˜¯${char.name}ï¼Œä¸ç”¨å¼ºè°ƒèº«ä»½ï¼Œç›´æ¥å‘å†…å®¹ã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "weibo", "posts": [ { "content": "...", "images": ["https://image.pollinations.ai/prompt/cat,anime?width=1024&height=1024&model=any-dark"], "likes": 120, "comments": 30, "time": "10åˆ†é’Ÿå‰" } ] }`;
                            break;

                            prompt = `ä½ æ˜¯è§’è‰²ã€${char.name}ã€‘æœ¬äººã€‚å†™ä¸€ç¯‡ç§å¯†æ—¥è®°ã€‚

${commonContext}
${appHistoryContext}

ã€ç”¨æˆ·éœ€æ±‚ã€‘
${userRequest || "å‰–æå†…å¿ƒçœŸå®æƒ³æ³•"}

ã€è§„åˆ™ã€‘
1. **æ ‡é¢˜**ï¼š**ç»å¯¹ç¦æ­¢**ä½¿ç”¨â€œæ—¥è®°â€ã€â€œæ— é¢˜â€æˆ–â€œè®°äº‹æœ¬â€ä½œä¸ºæ ‡é¢˜ã€‚è¯·èµ·ä¸€ä¸ªå¯Œæœ‰è¯—æ„æˆ–æƒ…æ„Ÿçš„æ ‡é¢˜ï¼ˆå¦‚ã€Šé›¨å¤œéšç¬”ã€‹ã€ã€Šå…³äºé‚£ä¸€åˆ»ã€‹ï¼‰ã€‚
2. **å­—æ•°è¦æ±‚**ï¼š800-1500å­—ã€‚å†…å®¹è¦æåº¦ç»†è…»ã€æ„Ÿæ€§ã€ç§å¯†ã€‚
3. **æ’ç‰ˆè¦æ±‚**ï¼šå¿…é¡»åˆ†æ®µï¼Œæ¯æ®µé¦–è¡Œç¼©è¿›ï¼ˆä½¿ç”¨å…¨è§’ç©ºæ ¼ï¼‰ã€‚
4. **ç»å¯¹ç¦æ­¢**ä»»ä½•æ ‡ç­¾ï¼ˆå¦‚ '###'ï¼‰ã€‚çº¯æ–‡æœ¬è¾“å‡ºã€‚
5. **æ‹’ç»é‡å¤**ï¼šè¯·é˜…è¯»ã€Diary å†å²è®°å½•ã€‘ï¼Œç»å¯¹ä¸è¦é‡å¤ä¸Šä¸€ç¯‡æ—¥è®°çš„ä¸»é¢˜æˆ–å†…å®¹ã€‚å¦‚æœä¸Šä¸€ç¯‡æ˜¯å¼€å¿ƒçš„ï¼Œè¿™ä¸€ç¯‡å¯ä»¥å†™ç‚¹å¿ƒäº‹ã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "diary", "entries": [ { "date": "12æœˆ26æ—¥", "weather": "Rainy", "mood": "Melancholy", "title": "é›¨å¤œéšç¬”", "content": "ã€€ã€€ä»Šå¤©çš„å¿ƒæƒ…..." } ] }`;
                            break;

                        case 'notes':
                            prompt = `ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆæ‰‹æœºå¤‡å¿˜å½•ã€‚

${commonContext}
${appHistoryContext}

ã€ç”¨æˆ·éœ€æ±‚ã€‘
${userRequest || "ç”Ÿæˆå¾…åŠæˆ–æ¸…å•"}

ã€è§„åˆ™ã€‘
1. å†…å®¹è¦ç”Ÿæ´»åŒ–ï¼Œå¯ä»¥æ˜¯è´­ç‰©æ¸…å•ã€éšæ‰‹è®°çš„çµæ„Ÿã€å¾…åŠäº‹é¡¹ç­‰ã€‚
2. **ç»å¯¹ç¦æ­¢**ä»»ä½•æ ‡ç­¾ã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "notes", "notes": [ { "title": "è¶…å¸‚ä¹°ä¹°ä¹°", "items": ["è‹¹æœ", "ç‰›å¥¶"] }, { "title": "To Do", "content": "è®°å¾—ç»™xxxæ‰“ç”µè¯..." } ] }`;
                            break;

                        case 'browser':
                            prompt = `ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆæµè§ˆå™¨å†å²ã€‚\n\n${commonContext}\n\nã€è§„åˆ™ã€‘\nç”Ÿæˆ 5-8 æ¡æœç´¢è®°å½•ï¼Œåæ˜ å…¶å…´è¶£æˆ–çŸ¥è¯†ç›²åŒºã€‚\n\nã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘\n{ "type": "browser", "history": [ { "title": "å¦‚ä½•...", "url": "google.com/...", "time": "14:20" } ] }`;
                            break;

                        case 'shopping':
                            prompt = `ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆæ·˜å®è´­ç‰©è®°å½•ã€‚

${commonContext}
${appHistoryContext}

ã€ç”¨æˆ·éœ€æ±‚ã€‘
${userRequest || "ä¹°ç‚¹ç”Ÿæ´»ç”¨å“"}

ã€è§„åˆ™ã€‘
1. ç”Ÿæˆ 2-3 ä¸ªè®¢å•ã€‚
2. **å›¾ç‰‡**ï¼šç‰©å“è¯·ç”¨å†™å®é£ã€‚URL: ".../prompt/product name?width=800&height=800&model=flux"ã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "shopping", "orders": [ { "item": "...", "price": 199, "image": "https://image.pollinations.ai/prompt/shoe?width=800&height=800&model=flux", "status": "å¾…å‘è´§" } ] }`;
                            break;

                        case 'footprint':
                            prompt = `ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆè¶³è¿¹ã€‚

${commonContext}
${appHistoryContext}

ã€è§„åˆ™ã€‘
1. ç”Ÿæˆ 4-6 ä¸ªæ—¶é—´èŠ‚ç‚¹ï¼Œæ¶µç›–å…¨å¤©ã€‚
2. å¿…é¡»æŒ‰æ—¶é—´æ’åºã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "footprint", "locations": [ { "place": "...", "time": "10:00", "desc": "..." } ] }`;
                            break;

                        case 'schedule':
                            prompt = `ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆä»Šæ—¥æ—¥ç¨‹ã€‚

${commonContext}
${appHistoryContext}

ã€è§„åˆ™ã€‘
1. ç”Ÿæˆ 3-5 ä¸ªæ—¥ç¨‹äº‹é¡¹ã€‚
2. type å¯é€‰: work (å·¥ä½œ), life (ç”Ÿæ´»), urgent (ç´§æ€¥)ã€‚

ã€è¾“å‡ºæ ¼å¼ (JSON)ã€‘
{ "type": "schedule", "events": [ { "time": "09:00", "event": "...", "type": "work" } ] }`;
                            break;
                    }

                    const result = await SettingsLogic.generateLLM([
                        { role: "system", content: systemInstruction },
                        { role: "user", content: prompt }
                    ], null, 'script');

                    let jsonStr = (result || "").trim().replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                    const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONç»“æ„");
                    const data = JSON.parse(jsonMatch[0]);

                    // Save Data
                    const allData = AppStorage.get('wechat_search_phone_data', {});
                    if (!allData[cid]) allData[cid] = {};
                    if (appName === 'wechat') {
                        // æ”¯æŒå¤šä¼šè¯ç”Ÿæˆ
                        const newChats = data.chats || [];

                        // 1. å¤„ç†ç½®é¡¶å¤‡æ³¨æ›´æ–°
                        if (data.pinned_remark && data.pinned_remark !== char.pinnedUser) {
                            char.pinnedUser = data.pinned_remark;
                            // æ›´æ–°å›å­˜å‚¨
                            chars[cid] = char;
                            AppStorage.set('wechat_chars', chars);
                            Utils.showToast(`ç½®é¡¶å¤‡æ³¨å·²æ›´æ–°ä¸º: ${char.pinnedUser}`);
                        }

                        if (!newChats || newChats.length === 0) {
                            // å¦‚æœè¿å¤‡æ³¨éƒ½æ²¡æ”¹ï¼Œä¸”æ²¡æœ‰æ–°ä¼šè¯ï¼Œæ‰æŠ¥é”™
                            if (!data.pinned_remark) throw new Error("æœªèƒ½ç”Ÿæˆæœ‰æ•ˆä¼šè¯");
                        } else {
                            // Save
                            const allData = AppStorage.get('wechat_search_phone_data', {});
                            if (!allData[cid]) allData[cid] = {};
                            if (!allData[cid].wechat) allData[cid].wechat = [];

                            // éå†æ‰€æœ‰ç”Ÿæˆçš„ä¼šè¯ (åªæ·»åŠ  NPC)
                            // éå†ç”Ÿæˆçš„ä¼šè¯ -> æ‰§è¡Œåˆå¹¶æˆ–æ–°å¢
                            newChats.forEach(chatData => {
                                // å†æ¬¡è¿‡æ»¤ï¼šå¦‚æœæ˜¯ç½®é¡¶ç”¨æˆ·
                                if (chatData.isPinned || chatData.name === char.pinnedUser || chatData.name === (char.pinnedUser || '')) {
                                    return;
                                }

                                const lastMsg = (chatData.history && chatData.history.length > 0) ?
                                    (chatData.history[chatData.history.length - 1].msg || "[å›¾ç‰‡]") : "[æ–°æ¶ˆæ¯]";

                                // --- MERGE LOGIC START ---
                                // æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åŒåä¼šè¯
                                const existingIndex = allData[cid].wechat.findIndex(c => c.name === chatData.name);

                                if (existingIndex !== -1) {
                                    // Found! Merge.
                                    const existingChat = allData[cid].wechat[existingIndex];

                                    // 1. Append history
                                    if (chatData.history && Array.isArray(chatData.history)) {
                                        if (!existingChat.history) existingChat.history = [];
                                        existingChat.history.push(...chatData.history);
                                    }

                                    // 2. Update preview
                                    existingChat.msg = lastMsg;
                                    existingChat.time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                                    // 3. Move to Top
                                    allData[cid].wechat.splice(existingIndex, 1);
                                    allData[cid].wechat.unshift(existingChat);

                                } else {
                                    // Not found. Create New.
                                    const newChat = {
                                        type: chatData.type || 'single',
                                        name: chatData.name || 'æœªçŸ¥',
                                        avatar: chatData.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${chatData.name}`,
                                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                        history: chatData.history || [],
                                        msg: lastMsg
                                    };
                                    allData[cid].wechat.unshift(newChat);
                                }
                                // --- MERGE LOGIC END ---
                            });
                            // è¿™é‡Œä¸è¦ç›´æ¥ AppStorage.setï¼Œç»Ÿä¸€åœ¨æœ€å set
                        }
                    } else if (appName === 'weibo') {
                        if (data.posts) {
                            if (!allData[cid].weibo) allData[cid].weibo = [];

                            // ä¿®å¤å¾®åšèº«ä»½é—®é¢˜ï¼šå¼ºåˆ¶è¦†ç›–ä¸ºè§’è‰²è‡ªå·±
                            const fixedPosts = data.posts.map(p => ({
                                ...p,
                                authorName: char.name, // å¼ºåˆ¶
                                avatar: char.avatar,   // å¼ºåˆ¶
                                isUser: false          // ç”¨äºåŒºåˆ†â€œæˆ‘â€å’Œâ€œè§’è‰²â€
                            }));
                            allData[cid].weibo.unshift(...fixedPosts);
                        }
                    } else if (appName === 'diary') {
                        if (data.entries) {
                            if (!allData[cid].diary) allData[cid].diary = [];
                            allData[cid].diary.unshift(...data.entries);
                        }
                    } else if (appName === 'notes') {
                        if (data.notes) {
                            if (!allData[cid].notes) allData[cid].notes = [];
                            allData[cid].notes.unshift(...data.notes);
                        }
                    } else if (appName === 'browser') {
                        if (data.history) {
                            if (!allData[cid].browser) allData[cid].browser = [];
                            allData[cid].browser.unshift(...data.history);
                        }
                    } else if (appName === 'shopping') {
                        if (data.orders) {
                            if (!allData[cid].shopping) allData[cid].shopping = [];
                            allData[cid].shopping.unshift(...data.orders);

                            // é’±åŒ…è”åŠ¨
                            data.orders.forEach(order => {
                                if (order.price) {
                                    WalletLogic.addTransaction(cid, {
                                        type: 'expense',
                                        amount: parseFloat(order.price),
                                        title: `æ·˜å® - ${order.item}`,
                                        time: new Date().toLocaleString()
                                    });
                                }
                            });
                        }
                    } else if (appName === 'footprint') {
                        // Special handling for Footprint (Grouping logic)
                        if (data.locations) {
                            if (!allData[cid].footprint) allData[cid].footprint = [];
                            // Check if we need to start a new group for today or append
                            const todayStr = new Date().toLocaleDateString();
                            const newLocations = data.locations;

                            // Current logic: Just prepend a new group object for "Today"
                            allData[cid].footprint.unshift({
                                date: todayStr,
                                locations: newLocations
                            });
                        }
                    } else if (appName === 'schedule') {
                        if (data.events) {
                            if (!allData[cid].schedule) allData[cid].schedule = [];
                            allData[cid].schedule.unshift(...data.events);
                        }
                    }

                    AppStorage.set('wechat_search_phone_data', allData);
                    SearchPhoneUI.renderSubAppContent();
                    if (!isAutoAll) Utils.showToast('æ•°æ®ç”ŸæˆæˆåŠŸï¼');

                } catch (e) {
                    console.error(e);
                    if (!isAutoAll) Utils.showToast('ç”Ÿæˆå¤±è´¥: ' + e.message);
                } finally {
                    if (btn && !isAutoAll) {
                        btn.innerHTML = originalIcon;
                        btn.disabled = false;
                    }
                }
            },


            // è¾…åŠ©å‡½æ•°ï¼šé€šè¿‡IDæ‰“å¼€ä¸»èŠå¤©
            openMainChatById: (charId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];

                if (!char) {
                    console.error('[æŸ¥æ‰‹æœº] æ‰¾ä¸åˆ°è§’è‰²:', charId);
                    Utils.showToast('æœªæ‰¾åˆ°è¯¥è”ç³»äºº');
                    return;
                }

                console.log('[æŸ¥æ‰‹æœº] æ‰“å¼€ç½®é¡¶è”ç³»äººèŠå¤©:', char.name || char.userName);
                SearchPhoneUI.openMainChat(char);
            },

            // æ‰“å¼€ä¸»èŠå¤©ï¼ˆä¸è‡ªå·±/ç”¨æˆ·ï¼‰
            openMainChat: (char) => {
                const container = document.getElementById('subapp-content');
                container.innerHTML = '';

                // åˆ›å»ºèŠå¤©è¯¦æƒ…ç•Œé¢
                const chatDetail = document.createElement('div');
                chatDetail.className = "flex flex-col bg-white min-h-full";

                // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºæ ‡é¢˜ï¼‰
                const userProfile = AppStorage.get('wechat_user_profile', {});

                // èŠå¤©å¤´éƒ¨
                const chatHeader = document.createElement('div');
                chatHeader.className = "flex items-center gap-3 p-4 border-b border-gray-100 bg-gray-50";
                chatHeader.innerHTML = `
                    <button onclick="SearchPhoneUI.renderSubAppContent()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg overflow-hidden hidden"> <!-- è¿™é‡Œéšè—äº†å¤´åƒ -->
                            <img src="${userProfile.avatar || WeChatUI.getRandomAvatar()}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900">${char.userName || userProfile.name || 'æˆ‘çš„ä¸»äºº'}</div>
                            <div class="text-xs text-green-500">åœ¨çº¿</div>
                        </div>
                    </div>
                    <button id="btn-subapp-gen-main" onclick="SearchPhoneUI.generateSubAppData(false)" class="text-gray-500 hover:text-gray-700 ml-auto">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> ç ´è§£æ•°æ®
                    </button>
                `;
                chatDetail.appendChild(chatHeader);

                // èŠå¤©æ¶ˆæ¯åŒºåŸŸ
                const chatMessages = document.createElement('div');
                chatMessages.className = "flex-1 overflow-y-auto p-4 space-y-4 scroll-container";
                chatMessages.style.height = "calc(100% - 120px)";
                chatMessages.style.display = "block";
                chatMessages.style.overflow = "auto";

                // æ¸²æŸ“èŠå¤©å†å²
                if (char.msgs && Array.isArray(char.msgs)) {
                    // å®šä¹‰é»‘é‡‘æ°”æ³¡æ ·å¼ (å¼ºåˆ¶ç”¨äº AI/å³ä¾§)
                    const cssSelf = `background: linear-gradient(135deg, #2b2b2b 0%, #1a1a1a 100%); color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.3); box-shadow: 0 4px 12px rgba(0,0,0,0.1);`;
                    // å¯¹æ–¹æ°”æ³¡æ ·å¼ (é»˜è®¤ç™½åº•)
                    const cssOther = `background: #ffffff; color: #333333; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);`;

                    const fontSize = char.bubbleFontSize || 15;

                    char.msgs.forEach(msg => {
                        const msgEl = document.createElement('div');
                        // ä¿®æ­£ï¼šChar (AI/PhoneOwner) åœ¨å³è¾¹ï¼ŒUser (Me) åœ¨å·¦è¾¹
                        // ä¿®æ­£ï¼šChar (AI/PhoneOwner) åœ¨å³è¾¹ï¼ŒUser (Me) åœ¨å·¦è¾¹
                        const isChar = msg.role === 'ai'; // 'me' or 'user' should be false (Left)

                        // å¤´åƒï¼šCharåœ¨å³ï¼ŒUseråœ¨å·¦
                        const rightAvatar = isChar ? `<div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 ml-3 shadow-md"><img src="${char.avatar || WeChatUI.getRandomAvatar()}" class="w-full h-full object-cover"></div>` : '';
                        const leftAvatar = !isChar ? `<div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 mr-3 shadow-md border border-gray-800"><img src="${userProfile.avatar || WeChatUI.getRandomAvatar()}" class="w-full h-full object-cover"></div>` : '';

                        // æ ·å¼ï¼šCharç”¨å³(æ·±ç°)ï¼ŒUserç”¨å·¦(é»‘é‡‘)
                        const bubbleClass = isChar ? 'chat-bubble-right' : 'chat-bubble-left';
                        const alignClass = isChar ? 'justify-end' : 'justify-start';

                        // å†…å®¹å¤„ç†
                        let contentRaw = msg.content;
                        // Handle moment JSON
                        if (typeof contentRaw === 'string' && contentRaw.trim().startsWith('{"id":"moment_')) {
                            contentRaw = '[æœ‹å‹åœˆåˆ†äº«]';
                        }

                        let useBubble = true;
                        let bubbleHtml = '';

                        // å¤„ç†å›¾ç‰‡æˆ–ç‰¹æ®ŠHTML
                        const isImg = /<img/i.test(contentRaw) && contentRaw.replace(/<[^>]+>/g, '').trim() === '';
                        if (isImg || contentRaw.includes('friend-request-card') || contentRaw.includes('background-color:')) {
                            useBubble = false;
                            bubbleHtml = contentRaw.replace(/style\s*=\s*["'][^"']*["']/gi, '')
                                .replace(/<img/gi, '<img style="width: auto; max-width: 100%; height: auto; display: block; border-radius: 8px; cursor: zoom-in;"');
                        } else if (msg.type === 'voice') {
                            // è¯­éŸ³
                            useBubble = true;
                            bubbleHtml = `<div class="flex items-center gap-2"><i class="fa-solid fa-wifi rotate-90"></i> <span>${msg.duration || 1}"</span></div>`;
                        } else if (msg.type === 'transfer' || msg.type === 'redpacket') {
                            useBubble = false;
                            // ç®€åŒ–æ˜¾ç¤ºçº¢åŒ…è½¬è´¦
                            const isRed = msg.type === 'redpacket';
                            const icon = isRed ? 'fa-envelope' : 'fa-arrow-right-arrow-left';
                            const title = isRed ? 'çº¢åŒ…' : 'è½¬è´¦';
                            const bgColor = isRed ? '#ea5845' : '#f79c1f';
                            bubbleHtml = `<div style="background: ${bgColor}; color: white; padding: 12px; border-radius: 8px; width: 230px; display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 24px; background: rgba(0,0,0,0.1); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;"><i class="fa-solid ${icon}"></i></div>
                                <div>
                                    <div style="font-size: 14px; font-weight: bold;">${title}</div>
                                    <div style="font-size: 10px; opacity: 0.8;">è¯·åœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹</div>
                                </div>
                             </div>`;
                        } else {
                            // æ™®é€šæ–‡æœ¬
                            useBubble = true;
                            bubbleHtml = String(contentRaw).replace(/\n/g, '<br>');
                        }

                        // æœ€ç»ˆHTML
                        let finalContent;
                        if (useBubble) {
                            finalContent = `<div class="${bubbleClass}" style="font-size: ${fontSize}px; max-width: 100%; word-break: break-all;">${bubbleHtml}</div>`;
                        } else {
                            finalContent = bubbleHtml;
                        }

                        msgEl.className = `flex ${alignClass} mb-4 select-text`;
                        msgEl.innerHTML = `
                            ${leftAvatar}
                            <div class="flex flex-col max-w-[70%] ${isChar ? 'items-end' : 'items-start'}">
                                ${finalContent}
                            </div>
                            ${rightAvatar}
                        `;
                        chatMessages.appendChild(msgEl);
                    });
                } else {
                    // ç©ºçŠ¶æ€
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = "text-center text-gray-400 py-8";
                    emptyMsg.innerHTML = '<i class="fa-regular fa-comment-dots text-4xl mb-2"></i><br>æš‚æ— èŠå¤©è®°å½•';
                    chatMessages.appendChild(emptyMsg);
                }

                chatDetail.appendChild(chatMessages);
                container.appendChild(chatDetail);

                // æ»šåŠ¨
                setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
            },

            // æ‰“å¼€èŠå¤©è¯¦æƒ… (æ”¯æŒç¾¤èŠ/å•èŠ)
            openChatDetail: (chatData) => {
                const container = document.getElementById('subapp-content');
                container.innerHTML = '';

                // åˆ›å»ºèŠå¤©è¯¦æƒ…ç•Œé¢
                const chatDetail = document.createElement('div');
                chatDetail.className = "flex flex-col bg-white min-h-full";

                // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºå¤´åƒï¼‰
                const userProfile = AppStorage.get('wechat_user_profile', {});

                const isGroup = chatData.type === 'group';

                // èŠå¤©å¤´éƒ¨
                const chatHeader = document.createElement('div');
                chatHeader.className = "flex items-center gap-3 p-4 border-b border-gray-100 bg-gray-50";
                chatHeader.innerHTML = `
                    <button onclick="SearchPhoneUI.renderSubAppContent()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg overflow-hidden hidden"> <!-- éšè—è¯¦æƒ…é¡µå¤´åƒ -->
                            <img src="${chatData.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=' + (chatData.name || 'default')}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900 flex items-center gap-1 text-lg">
                                ${chatData.name}
                                ${isGroup ? '<span class="text-xs font-normal text-gray-500 bg-gray-200 px-1 rounded">ç¾¤èŠ</span>' : ''}
                            </div>
                            ${!isGroup ? `<div id="chat-online-status" class="text-xs text-green-500 cursor-pointer hover:text-green-600 transition-colors" onclick="window.APIQueue.interrupt()" title="ç‚¹å‡»å¯å¿«é€Ÿä¸­æ–­ç”Ÿæˆ">åœ¨çº¿</div>` : ''}
                        </div>
                    </div>
                    ${isGroup ? `<div class="ml-auto text-gray-400"><i class="fa-solid fa-ellipsis"></i></div>` : ''}
                `;
                chatDetail.appendChild(chatHeader);

                // èŠå¤©æ¶ˆæ¯åŒºåŸŸ
                const chatMessages = document.createElement('div');
                chatMessages.className = "flex-1 overflow-y-auto p-4 space-y-4 scroll-container bg-gray-50";
                chatMessages.style.height = "calc(100% - 120px)";
                chatMessages.style.display = "block";
                chatMessages.style.overflow = "auto";

                // æ¸²æŸ“èŠå¤©å†å²
                const history = chatData.history || (chatData.msgs ? chatData.msgs : []);
                if (history && Array.isArray(history) && history.length > 0) {
                    const currentChar = AppStorage.get('wechat_chars', {})[SearchPhoneUI.targetCharId];
                    const fontSize = currentChar.bubbleFontSize || 15;

                    // å®šä¹‰é»‘é‡‘æ°”æ³¡æ ·å¼
                    const cssSelf = `background: linear-gradient(135deg, #2b2b2b 0%, #1a1a1a 100%); color: #d4af37; border: 1px solid rgba(212, 175, 55, 0.3); box-shadow: 0 4px 12px rgba(0,0,0,0.1);`;
                    const cssOther = `background: #ffffff; color: #333333; border: 1px solid #f0f0f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);`;

                    history.forEach(msg => {
                        // é€»è¾‘é•œåƒ: AI (Me) åœ¨å³ï¼ŒNPC/User åœ¨å·¦
                        // Check role: 'ai', 'me' -> Right. 'npc', 'user', 'friend' -> Left.
                        const role = (msg.role || '').toLowerCase();
                        const isAi = role === 'ai' || role === 'me' || role === 'char';

                        // å¼ºåˆ¶æ¸…ç†å†…å®¹ä¸­çš„æ ‡ç­¾
                        let contentFull = msg.msg || msg.content || '';
                        // Remove ### tags
                        contentFull = contentFull.replace(/###|\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]|\[INNER_VOICE\]/gi, '').trim();

                        if (!contentFull) return;

                        const msgEl = document.createElement('div');

                        // å¤´åƒå¤„ç†
                        let avatarUrl;
                        if (isAi) {
                            avatarUrl = currentChar.avatar || WeChatUI.getRandomAvatar();
                        } else {
                            // NPC/ç¾¤å‹: ä¼˜å…ˆç”¨ msg.avatar -> chatData.avatar -> éšæœº seed (åŸºäºåå­—)
                            avatarUrl = msg.avatar || chatData.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${msg.name || 'npc'}`;
                        }

                        // å¸ƒå±€
                        const rightAvatar = isAi ? `<div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 ml-3 shadow-md"><img src="${avatarUrl}" class="w-full h-full object-cover"></div>` : '';
                        const leftAvatar = !isAi ? `<div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 mr-3 shadow-md border border-gray-800"><img src="${avatarUrl}" class="w-full h-full object-cover"></div>` : '';

                        const bubbleClass = isAi ? 'chat-bubble-right' : 'chat-bubble-left';
                        const alignClass = isAi ? 'justify-end' : 'justify-start';

                        let bubbleHtml;

                        // Image Check
                        let content = contentFull;
                        // 1. å°è¯•æå– [å›¾ç‰‡: URL]
                        content = content.replace(/\[(å›¾ç‰‡|image)[:ï¼š]?\s*([\s\S]*?)\]/gi, (match, tag, urlContent) => {
                            const cleanUrl = urlContent.trim();
                            if (cleanUrl) return `<img src="${cleanUrl}" style="width: 100%; border-radius: 8px; margin: 5px 0;" />`;
                            return '';
                        });
                        // 2. Pollinations
                        const rawUrlRegex = /(?<!src=['"])(https?:\/\/(?:image\.pollinations\.ai\/prompt\/|[^ \n<]*\.(?:png|jpg|jpeg|gif|webp))[^\s<]*)/gi;
                        content = content.replace(rawUrlRegex, (url) => {
                            if (content.includes(`src="${url}"`)) return url;
                            const cleanUrl = url.replace(/[),ã€‚ï¼Œ!ï¼]$/, '');
                            return `<img src="${cleanUrl}" style="width: 100%; border-radius: 8px; margin: 5px 0;" />`;
                        });

                        const isImg = /<img/i.test(content) && content.replace(/<[^>]+>/g, '').trim() === '';

                        if (isImg) {
                            bubbleHtml = `<div class="overflow-hidden rounded-lg cursor-zoom-in">${content}</div>`;
                        } else {
                            bubbleHtml = `<div class="${bubbleClass}" style="font-size: ${fontSize}px; max-width: 100%; word-break: break-all;">${content}</div>`;
                        }

                        // ç¾¤èŠæ˜¾ç¤ºåå­— (ä»…å·¦ä¾§)
                        // isGroup check: chatData.type === 'group'
                        const nameHtml = (!isAi && (chatData.type === 'group' || isGroup)) ? `<div class="text-xs text-gray-400 mb-1 ml-1">${msg.name || 'ç¾¤å‹'}</div>` : '';

                        msgEl.className = `flex ${alignClass} mb-4 select-text`;
                        msgEl.innerHTML = `
                                ${leftAvatar}
                                <div class="flex flex-col max-w-[70%] ${isAi ? 'items-end' : 'items-start'}">
                                    ${nameHtml}
                                    ${bubbleHtml}
                                </div>
                                ${rightAvatar}
                            `;
                        chatMessages.appendChild(msgEl);
                    });
                } else {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = "text-center text-gray-400 py-8";
                    emptyMsg.innerHTML = '<i class="fa-regular fa-comment-dots text-4xl mb-2"></i><br>æš‚æ— èŠå¤©è®°å½•';
                    chatMessages.appendChild(emptyMsg);
                }

                chatDetail.appendChild(chatMessages);
                container.appendChild(chatDetail);

                // æ»šåŠ¨
                setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
            },

            // è·å–åº”ç”¨ç‰¹å®šç´¢å¼•çš„æ•°æ® (è¾…åŠ©ç‚¹å‡»)
            getAppDataByIndex: (appName, index) => {
                const cid = SearchPhoneUI.targetCharId;
                if (appName === 'chars') {
                    return AppStorage.get('wechat_chars', {})[index];
                }
                const allData = AppStorage.get('wechat_search_phone_data', {});
                const appData = (allData[cid] && allData[cid][appName]) || null;
                if (Array.isArray(appData)) return appData[index];
                return appData;
            },

            renderSubAppContent: () => {
                const cid = SearchPhoneUI.targetCharId;
                const appName = SearchPhoneUI.currentApp;
                const container = document.getElementById('subapp-content');
                if (!container) return;

                // 1. è¯»å–æ•°æ®
                const allData = AppStorage.get('wechat_search_phone_data', {});
                const charData = allData[cid] || {};
                const appData = charData[appName];
                const char = AppStorage.get('wechat_chars', {})[cid]; // Moved to top scope

                // 2. æ ¸å¿ƒåº”ç”¨å¤„ç†
                if (appName === 'wallet') {
                    // Updating Header Title
                    const headerTitle = document.querySelector('#modal-phone-subapp .app-name');
                    if (headerTitle) headerTitle.innerText = 'æˆ‘çš„é’±åŒ…';

                    // Force render wallet even if appData is null initially
                    if (SearchPhoneUI.renderWallet) {
                        // Auto-init balance if empty (Simulate rich character)
                        const walletData = WalletLogic.getCharWalletData(cid);
                        if (walletData.balance === 0 && walletData.transactions.length === 0) {
                            walletData.balance = parseFloat((Math.random() * 5000 + 2000).toFixed(2));
                            WalletLogic.saveCharWalletData(cid, walletData);
                        }
                        SearchPhoneUI.renderWallet(cid);
                    } else {
                        container.innerHTML = `<div class="p-8 text-center text-gray-400">é’±åŒ…æ¨¡å—åŠ è½½å¤±è´¥<br><span class="text-xs">WalletLogic implies manual load</span></div>`;
                    }
                    return;
                }

                if (appName === 'wechat') {
                    // ç¡®ä¿ç”ŸæˆæŒ‰é’®å­˜åœ¨
                    let genBtn = document.getElementById('btn-subapp-gen');
                    if (!genBtn) {
                        const header = document.querySelector('#modal-phone-subapp .app-header');
                        if (header) {
                            genBtn = document.createElement('button');
                            genBtn.id = 'btn-subapp-gen';
                            genBtn.className = 'text-gray-500 hover:text-gray-700 ml-auto';
                            genBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> ç ´è§£æ•°æ®';
                            genBtn.onclick = () => SearchPhoneUI.generateSubAppData(false);
                            header.appendChild(genBtn);
                        }
                    } else {
                        // ç¡®ä¿ç»‘å®š
                        genBtn.onclick = () => SearchPhoneUI.generateSubAppData(false);
                        genBtn.style.display = 'block';
                    }

                    const chats = appData || [];
                    const userProfile = AppStorage.get('wechat_user_profile', {});
                    // const char = AppStorage.get('wechat_chars', {})[cid]; // Already defined above

                    // æ„å»ºç½®é¡¶èŠå¤©è®°å½• (NPC ä¸ ç©å®¶/ä¸»äºº)
                    // Priority: Generated Pinned Remark > Manual Remark > User Name > 'æˆ‘çš„ä¸»äºº'
                    const pinnedName = char.pinnedUser || char.userName || userProfile.name || 'æˆ‘çš„ä¸»äºº';

                    const lastMsg = (char.msgs && char.msgs.length > 0) ? (typeof char.msgs[char.msgs.length - 1].content === 'string' ? char.msgs[char.msgs.length - 1].content : '[å›¾ç‰‡/é™„ä»¶]') : 'ç‚¹å‡»å¼€å§‹èŠå¤©';
                    const mainChat = {
                        isMain: true,
                        name: pinnedName,
                        avatar: userProfile.avatar || WeChatUI.getRandomAvatar(),
                        time: 'ç°åœ¨',
                        msg: lastMsg,
                        rawChar: char
                    };

                    // åˆå¹¶åˆ—è¡¨
                    const combinedList = [mainChat, ...chats];

                    // æ¸²æŸ“å¾®ä¿¡èŠå¤©åˆ—è¡¨
                    const listHtml = combinedList.map((chat, idx) => {
                        // ä¸ºç½®é¡¶è”ç³»äººå‡†å¤‡æ­£ç¡®çš„ç‚¹å‡»äº‹ä»¶
                        let clickAction = '';
                        if (chat.isMain) {
                            // ç½®é¡¶è”ç³»äººï¼šç›´æ¥ä¼ é€’charå¯¹è±¡çš„IDï¼Œç„¶ååœ¨å‡½æ•°å†…è·å–
                            clickAction = `SearchPhoneUI.openMainChatById('${cid}')`;
                        } else {
                            clickAction = `SearchPhoneUI.openChatDetail(SearchPhoneUI.getAppDataByIndex('wechat', ${idx - 1}))`;
                        }

                        return `
                        <div onclick="${clickAction}" 
                             class="flex items-center gap-3 p-4 border-b border-gray-50 hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors h-16 ${chat.isMain ? 'bg-gray-50/50' : ''}">
                            <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 bg-gray-100 relative">
                                <img src="${chat.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=' + chat.name}" class="w-full h-full object-cover">
                                ${chat.isMain ? '<div class="absolute bottom-0 right-0 w-2 h-2 bg-green-500 rounded-full border border-white"></div>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h4 class="font-semibold text-gray-900 truncate text-sm flex items-center gap-1">
                                        ${chat.name}
                                        ${chat.isMain ? '<i class="fa-solid fa-thumbtack text-[10px] text-gray-300"></i>' : ''}
                                    </h4>
                                    <span class="text-[10px] text-gray-400">${chat.time || ''}</span>
                                </div>
                                <p class="text-[11px] text-gray-500 truncate font-light">${(chat.msg || '').replace(/<[^>]*>/g, '')}</p>
                            </div>
                        </div>
                    `;
                    }).join('');
                    container.innerHTML = `<div class="wechat-list bg-white min-h-full">${listHtml}</div>`;
                    return;
                }

                // 3. å…¶ä»–å¸¸è§„åº”ç”¨
                const titleMap = {
                    'browser': 'æµè§ˆå™¨', 'shopping': 'æ·˜å®', 'diary': 'ç§˜å¯†æ—¥è®°',
                    'notes': 'å¤‡å¿˜å½•', 'weibo': 'å¾®åš', 'footprint': 'åœ°å›¾è¶³è¿¹', 'gallery': 'ç›¸å†Œ',
                    'worldbook': 'ä¸–ç•Œä¹¦', 'schedule': 'æ—¥ç¨‹'
                };

                // Dynamic Header Update (Fixing "Notepad" vs "Notes" issues)
                const headerTitleEl = document.querySelector('#modal-phone-subapp .app-name');
                if (headerTitleEl && titleMap[appName]) {
                    headerTitleEl.innerText = titleMap[appName];
                    headerTitleEl.style.color = (appName === 'notes' || appName === 'schedule') ? '#000' : ''; // Dark text for light apps
                }

                if (!appData) {
                    container.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-400 gap-2">
                            <i class="fa-regular fa-folder-open text-3xl opacity-20"></i>
                            <span class="text-sm">${titleMap[appName] || appName}ï¼šæš‚æ— è®°å½•ï¼Œç‚¹å‡»ç”Ÿæˆ</span>
                        </div>`;
                    return;
                }

                // æ ¹æ®æ•°æ®ç»“æ„è‡ªåŠ¨é€‰æ‹©æ¸²æŸ“æ–¹å¼
                if (Array.isArray(appData)) {
                    // --- æ’åºé€»è¾‘ (æ–° -> æ—§) ---
                    // Diary: has date
                    // Footprint: has time/date
                    // Others: rely on insert order (unshift) which is already New->Old
                    let displayData = [...appData]; // Clone

                    if (appName === 'diary' || appName === 'weibo' || appName === 'footprint' || appName === 'notes') {
                        // å¼ºåˆ¶æŒ‰æ—¶é—´/ç´¢å¼•å€’åºï¼Œç¡®ä¿ unshift çš„å†…å®¹åœ¨æœ€å‰
                        // å¦‚æœæ˜¯ Footprintï¼Œå¯èƒ½æœ‰å…·ä½“æ—¶é—´å­—æ®µï¼Œè¿™é‡Œç®€åŒ–ä¸ºä¾èµ– unshift é¡ºåºï¼ˆå³è¶Šæ™šç”Ÿæˆçš„è¶Šåœ¨æ—¥å¸¸ï¼‰
                        // ä¸ºé˜²æ­¢æ··ä¹±ï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸åšï¼Œå› ä¸º unshift æœ¬èº«å°±æ˜¯æŠŠæœ€æ–°çš„æ’åˆ° index 0ã€‚
                        // é™¤é appData æœ¬èº«ä¹±äº†ã€‚
                        // è®©æˆ‘ä»¬ä¿¡ä»» unshiftã€‚
                    }

                    let itemsHtml = '';

                    if (appName === 'weibo') {
                        itemsHtml = displayData.map(post => `
                            <div class="bg-white p-4 mb-3 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-10 h-10 rounded-full bg-gray-200 overflow-hidden"><img src="${char.avatar || 'https://api.dicebear.com/7.x/notionists/svg?seed=' + Math.random()}" class="w-full h-full object-cover"></div>
                                    <div class="flex-1">
                                        <div class="font-bold text-sm text-gray-900">${char.name || 'User'} <i class="fa-solid fa-certificate text-yellow-500 text-xs"></i></div>
                                        <div class="text-xs text-gray-400">${post.time || 'åˆšåˆš'} Â· å‘å¸ƒäº iPhone 16 Pro Max</div>
                                    </div>
                                    <button class="text-gray-400 px-2">+ å…³æ³¨</button>
                                </div>
                                <div class="text-[14px] text-gray-800 mb-3 leading-relaxed tracking-wide">${post.content}</div>
                                ${post.images && post.images.length ? `<div class="grid grid-cols-3 gap-1 mb-3 rounded-lg overflow-hidden">${post.images.map(img => `<div class="aspect-square bg-gray-100"><img src="${img}" class="w-full h-full object-cover"></div>`).join('')}</div>` : ''}
                                <div class="flex justify-between text-gray-500 text-xs border-t border-gray-50 pt-3 px-2">
                                    <span onclick="SearchPhoneUI.shareItem('weibo', ${displayData.indexOf(post)})" class="flex items-center gap-1 cursor-pointer hover:text-blue-500"><i class="fa-solid fa-share"></i> ${Math.floor(Math.random() * 50)}</span>
                                    <span class="flex items-center gap-1"><i class="fa-regular fa-comment"></i> ${post.comments || Math.floor(Math.random() * 200)}</span>
                                    <span class="flex items-center gap-1"><i class="fa-regular fa-thumbs-up"></i> ${post.likes || Math.floor(Math.random() * 1000)}</span>
                                </div>
                            </div>
                        `).join('');
                        container.innerHTML = `<div class="p-3 bg-gray-50 min-h-full">${itemsHtml}</div>`;
                        return;
                    }


                    if (appName === 'diary' || appName === 'notes') {
                        // Unified rendering for Diary and Notes (both support Detail View now)
                        // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„ "Current Entry" (ç”¨äºè¯¦æƒ…é¡µ)
                        const currentEntryIdx = container.dataset.diaryEntryIdx;
                        const isNotes = appName === 'notes';
                        const themeBg = isNotes ? 'bg-yellow-50' : 'bg-[#f8f6f2]';
                        const itemBg = isNotes ? 'bg-yellow-100/50' : 'bg-white';
                        const titleColor = isNotes ? 'text-yellow-900' : 'text-stone-800';

                        // --- è¯¦æƒ…é¡µæ¨¡å¼ ---
                        if (currentEntryIdx !== undefined && currentEntryIdx !== null && currentEntryIdx !== "") {
                            const entry = displayData[parseInt(currentEntryIdx)];
                            if (!entry) {
                                container.dataset.diaryEntryIdx = "";
                                SearchPhoneUI.renderSubAppContent();
                                return;
                            }

                            let cleanContent = '';
                            let title = entry.title || 'æ— é¢˜';
                            let date = entry.date || 'Unknown Date';

                            if (isNotes) {
                                // Notes logic
                                if (entry.items) {
                                    cleanContent = `<ul class="list-disc pl-5 space-y-2 text-stone-700">${entry.items.map(i => `<li>${i}</li>`).join('')}</ul>`;
                                } else {
                                    cleanContent = (entry.content || '').replace(/###|\[INNER_VOICE\]/gi, '');
                                }
                                date = 'å¤‡å¿˜å½•';
                            } else {
                                // Diary logic
                                cleanContent = (entry.content || '').replace(/###|\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]|\[INNER_VOICE\]/gi, '').trim();
                            }

                            container.innerHTML = `
                                <div class="${themeBg} min-h-full flex flex-col font-serif relative">
                                    <!-- å¯¼èˆªæ  -->
                                    <div class="sticky top-0 ${themeBg}/90 backdrop-blur-sm z-10 px-4 py-3 flex items-center justify-between border-b border-black/5">
                                        <button onclick="document.getElementById('subapp-content').dataset.diaryEntryIdx = ''; SearchPhoneUI.renderSubAppContent()" 
                                                class="w-8 h-8 flex items-center justify-center text-stone-500 hover:text-stone-800 transition-colors rounded-full hover:bg-black/5">
                                            <i class="fa-solid fa-arrow-left"></i>
                                        </button>
                                        <span class="text-xs text-stone-400 tracking-widest uppercase">${isNotes ? 'Memo' : 'Secret Diary'}</span>
                                        <div class="w-8"></div>
                                    </div>

                                    <!-- å†…å®¹åŒº -->
                                    <div class="flex-1 px-6 py-8 animate-fade-in-up">
                                        <div class="mb-8 text-center">
                                            <div class="text-stone-400 text-xs mb-2 tracking-widest">${date} ${!isNotes ? `Â· ${entry.weather || ''} Â· ${entry.mood || ''}` : ''}</div>
                                            <h1 class="text-2xl ${titleColor} font-bold mb-4 leading-relaxed">${title}</h1>
                                            <div class="w-12 h-0.5 bg-stone-300 mx-auto rounded-full"></div>
                                        </div>
                                        
                                        <div class="text-stone-700 text-base leading-loose whitespace-pre-wrap text-justify diary-content">
                                            ${(cleanContent || '').split('\n').map(p => `<p style="text-indent: 2em; margin-bottom: 1em;">${p.trim()}</p>`).join('')}
                                        </div>
                                        <!-- Share Button inside Detail View -->
                                        <div class="mt-8 flex justify-end">
                                            <button onclick="SearchPhoneUI.shareItem('${appName}', ${document.getElementById('subapp-content').dataset.diaryEntryIdx})" class="text-stone-400 hover:text-stone-600 transition-colors flex items-center gap-2 text-sm">
                                                <i class="fa-solid fa-share-nodes"></i> åˆ†äº«è¿™ç¯‡${isNotes ? 'å¤‡å¿˜' : 'æ—¥è®°'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            return;
                        }

                        // --- ç›®å½•åˆ—è¡¨æ¨¡å¼ (Catalog) ---
                        itemsHtml = displayData.map((entry, idx) => {
                            let preview = '';
                            let title = entry.title || 'æ— é¢˜';
                            let dateStr = entry.date || '';

                            if (isNotes) {
                                if (entry.items) preview = entry.items.join(', ').substring(0, 50) + '...';
                                else preview = (entry.content || '').substring(0, 50) + '...';
                                if (!dateStr) dateStr = 'Memo';
                            } else {
                                const c = (entry.content || '').replace(/###|\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]|\[INNER_VOICE\]/gi, '').trim();
                                preview = c.substring(0, 60) + '...';
                            }

                            return `
                             <div onclick="document.getElementById('subapp-content').dataset.diaryEntryIdx = '${idx}'; SearchPhoneUI.renderSubAppContent()" 
                                  class="mb-4 p-5 ${itemBg} shadow-sm border border-black/5 rounded-xl relative overflow-hidden group cursor-pointer hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-stone-400 tracking-wide uppercase mb-1">${dateStr}</span>
                                        <h3 class="font-serif font-bold text-lg ${titleColor}">${title}</h3>
                                    </div>
                                    ${entry.weather ? `<i class="fa-solid fa-cloud-sun text-stone-300"></i>` : ''}
                                    <button onclick="event.stopPropagation(); SearchPhoneUI.shareItem('${appName}', ${idx})" class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity text-stone-300 hover:text-stone-500 z-10">
                                        <i class="fa-solid fa-share-nodes"></i>
                                    </button>
                                </div>
                                <p class="font-serif text-sm text-stone-500 leading-relaxed line-clamp-2">${preview}</p>
                                <div class="mt-4 flex items-center gap-2 text-[10px] text-stone-400 font-medium">
                                    ${!isNotes ? `<span class="px-2 py-1 bg-stone-50 rounded text-stone-500">${entry.mood || 'Mood'}</span>` : ''}
                                    <span class="ml-auto group-hover:translate-x-1 transition-transform">æŸ¥çœ‹è¯¦æƒ… <i class="fa-solid fa-angle-right ml-0.5"></i></span>
                                </div>
                             </div>
                        `}).join('');

                        container.innerHTML = `
                            <div class="p-5 ${themeBg} min-h-full font-serif">
                                <div class="mb-6 px-2 pt-2">
                                    <h2 class="text-2xl font-bold ${titleColor}">${isNotes ? 'æˆ‘çš„å¤‡å¿˜å½•' : 'ç§˜å¯†æ—¥è®°'}</h2>
                                    <p class="text-xs text-stone-400 mt-1">Total ${displayData.length} entries</p>
                                </div>
                                ${itemsHtml}
                            </div>`;
                        return;
                    }


                    if (appName === 'footprint' || appName === 'schedule') {
                        const isSchedule = (appName === 'schedule');
                        const now = new Date();

                        // State management
                        let displayYear = parseInt(container.dataset.calDisplayYear) || now.getFullYear();
                        let displayMonth = parseInt(container.dataset.calDisplayMonth); // 0-11
                        if (isNaN(displayMonth)) displayMonth = now.getMonth();

                        // Selected Date
                        const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                        let selectedDateStr = container.dataset.calSelectedDate || todayStr;

                        // Navigation
                        const prevDate = new Date(displayYear, displayMonth - 1, 1);
                        const nextDate = new Date(displayYear, displayMonth + 1, 1);

                        // Calendar Grid Logic
                        const daysInMonth = new Date(displayYear, displayMonth + 1, 0).getDate();
                        const firstDayOfWeek = new Date(displayYear, displayMonth, 1).getDay(); // 0(Sun) - 6(Sat)
                        const startOffset = (firstDayOfWeek + 6) % 7; // Convert to Monday start (0=Mon, ... 6=Sun)

                        // Lunar Mockup (Simple)
                        const lunarMap = { 1: 'åˆä¸€', 15: 'åäº”', 26: 'å»¿å…­', [now.getDate()]: 'ä»Šå¤©' };
                        const getLunar = (d) => {
                            if (displayMonth === now.getMonth() && d === now.getDate()) return 'ä»Šå¤©';
                            return lunarMap[d] || '';
                        };

                        let gridHtml = '';
                        // Empty cells
                        for (let i = 0; i < startOffset; i++) gridHtml += `<div class="aspect-square"></div>`;

                        // Days
                        for (let d = 1; d <= daysInMonth; d++) {
                            const dateStr = `${displayYear}-${String(displayMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const isToday = (dateStr === todayStr);
                            const isSelected = (dateStr === selectedDateStr);

                            // Theme Colors
                            const themeColor = isSchedule ? 'bg-[#008ba3]' : 'bg-blue-500';
                            const themeText = isSchedule ? 'text-[#008ba3]' : 'text-blue-500';

                            let cellClass = "aspect-square flex flex-col items-center justify-center rounded-full cursor-pointer transition-all relative text-sm select-none";
                            if (isSelected) cellClass += ` ${themeColor} text-white shadow-md font-bold`;
                            else if (isToday) cellClass += ` ${themeText} font-bold bg-gray-100`;
                            else cellClass += " text-gray-700 hover:bg-gray-100";

                            gridHtml += `
                                <div onclick="const c=document.getElementById('subapp-content'); c.dataset.calSelectedDate='${dateStr}'; SearchPhoneUI.renderSubAppContent()" 
                                     class="${cellClass}">
                                    <span>${d}</span>
                                    <span class="text-[9px] scale-75 opacity-70 ${isSelected ? 'text-white' : 'text-gray-400'}">${getLunar(d)}</span>
                                    ${isToday && !isSelected ? `<div class="absolute bottom-1 w-1 h-1 ${themeColor} rounded-full"></div>` : ''}
                                </div>`;
                        }

                        // --- Event List Rendering ---
                        // Note: generated data usually doesn't have specific dates (it's "today's data").
                        // Logic: Show data ONLY if selected date is "Today" OR if the data explicitly has matching date.
                        // Since our prompt generates "Today's" schedule/footprint, we default to showing it only on Today.
                        const showData = (selectedDateStr === todayStr);

                        let listHtml = '';
                        if (isSchedule) {
                            if (showData && appData && appData.length > 0) {
                                listHtml = appData.map(item => {
                                    const colors = { 'work': '#4a90e2', 'life': '#f5a623', 'urgent': '#d0021b' };
                                    const color = colors[item.type] || '#f5a623';
                                    return `
                                         <div class="flex gap-4 mb-4 items-start group animate-fade-in-up">
                                             <div class="w-12 text-right text-xs text-gray-400 font-medium pt-1 font-mono">${item.time}</div>
                                             <div class="flex-1 relative pl-4 border-l-2" style="border-color: ${color}">
                                                 <div class="absolute -left-[5px] top-1.5 w-2 h-2 rounded-full bg-white border-2" style="border-color: ${color}"></div>
                                                 <div class="font-bold text-sm text-gray-800 mb-0.5">${item.event}</div>
                                                 <div class="text-[10px] text-gray-400 uppercase tracking-wider">${item.type || 'General'}</div>
                                             </div>
                                         </div>`;
                                }).join('');
                            } else {
                                listHtml = `<div class="text-center text-gray-400 text-xs py-10">æ— æ—¥ç¨‹å®‰æ’</div>`;
                            }
                        } else {
                            // Footprint
                            // Flatten if needed (handle both grouped and flat)
                            let locs = [];
                            if (showData && appData) {
                                if (Array.isArray(appData)) {
                                    // Check if flat or grouped
                                    if (appData.length > 0 && appData[0].locations) locs = appData[0].locations; // Grouped style
                                    else locs = appData; // Flat style
                                }
                            }

                            if (locs.length > 0) {
                                listHtml = `
                                    <div class="relative border-l-2 border-dashed border-gray-300 ml-3 space-y-8 pb-4 mt-4">
                                        ${locs.map(loc => `
                                            <div class="relative pl-8 group">
                                                <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-blue-500 border-4 border-[#f2f2f7] group-hover:scale-110 transition-transform"></div>
                                                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                                    <div class="flex justify-between items-end mb-1">
                                                        <span class="font-bold text-gray-800 text-sm">${loc.place}</span>
                                                        <span class="text-xs text-gray-400 font-mono bg-gray-50 px-2 py-1 rounded">${loc.time}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500">${loc.desc}</p>
                                                </div>
                                            </div>`).join('')}
                                    </div>`;
                            } else {
                                listHtml = `<div class="text-center text-gray-400 text-xs py-10">æš‚æ— è¶³è¿¹è®°å½•</div>`;
                            }
                        }

                        container.innerHTML = `
                            <div class="html-calendar bg-white min-h-full flex flex-col items-center">
                                <div class="w-full bg-[#f2f2f7] pt-2 pb-4 rounded-b-3xl shadow-sm z-10 sticky top-0">
                                    <div class="px-6 pt-4 pb-2 flex justify-between items-center">
                                        <div class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            ${displayMonth + 1}æœˆ <span class="text-sm font-normal text-gray-400">${displayYear}</span>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="const c=document.getElementById('subapp-content'); c.dataset.calDisplayMonth='${now.getMonth()}'; c.dataset.calDisplayYear='${now.getFullYear()}'; c.dataset.calSelectedDate='${todayStr}'; SearchPhoneUI.renderSubAppContent()" 
                                                class="px-2 py-1 rounded-full bg-white text-xs text-gray-500 shadow-sm border border-gray-100 hover:text-blue-500">
                                                ä»Š
                                            </button>
                                            <div class="flex gap-1">
                                                <button onclick="const c=document.getElementById('subapp-content'); c.dataset.calDisplayMonth='${prevDate.getMonth()}'; c.dataset.calDisplayYear='${prevDate.getFullYear()}'; SearchPhoneUI.renderSubAppContent()" 
                                                    class="w-7 h-7 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-500 hover:text-blue-500 text-xs"><i class="fa-solid fa-chevron-left"></i></button>
                                                <button onclick="const c=document.getElementById('subapp-content'); c.dataset.calDisplayMonth='${nextDate.getMonth()}'; c.dataset.calDisplayYear='${nextDate.getFullYear()}'; SearchPhoneUI.renderSubAppContent()" 
                                                    class="w-7 h-7 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-500 hover:text-blue-500 text-xs"><i class="fa-solid fa-chevron-right"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="px-4 mt-2">
                                        <div class="grid grid-cols-7 mb-2 text-center text-xs text-gray-400">
                                            <div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div>
                                        </div>
                                        <div class="grid grid-cols-7 gap-y-1 gap-x-1">
                                            ${gridHtml}
                                        </div>
                                    </div>
                                    <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mt-4 opacity-50"></div>
                                </div>
                                <div class="w-full px-6 py-6 flex-1 overflow-y-auto">
                                    ${listHtml}
                                </div>
                            </div>
                         `;
                        return;
                    }

                    // --- åˆ—è¡¨å‹ (æµè§ˆå™¨, è´­ç‰©ç­‰) ---
                    // è¿™é‡Œçš„é€»è¾‘æ˜¯å¤„ç†é‚£äº›ä¸æ˜¯æ—¥è®°/å¤‡å¿˜å½•/è¶³è¿¹/æ—¥ç¨‹ï¼Œä½†ä»ç„¶æ˜¯æ•°ç»„å½¢å¼çš„appData
                    // ä¾‹å¦‚ browser, shopping
                    itemsHtml = appData.map(i => {
                        if (appName === 'browser') {
                            return `<div class="p-3 bg-white rounded-xl mb-2 shadow-sm border border-gray-100 m-2 flex flex-col active:bg-gray-50">
                                <div class="font-medium text-sm text-gray-800 truncate mb-1">${i.title}</div>
                                <div class="text-[10px] text-gray-400 truncate flex items-center gap-1"><i class="fa-solid fa-lock text-[8px]"></i> ${i.url}</div>
                            </div>`;
                        } else if (appName === 'shopping') {
                            return `<div class="p-3 bg-white rounded-xl mb-3 shadow-sm m-2 flex gap-3 border border-gray-50">
                                <div class="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 relative">
                                    <img src="${i.image || 'https://api.dicebear.com/7.x/icons/svg?seed=shop'}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 flex flex-col justify-between py-0.5">
                                    <div class="font-medium text-[13px] text-gray-800 line-clamp-2 leading-snug">${i.item}</div>
                                    <div class="flex justify-between items-end">
                                        <div class="text-red-500 font-bold text-sm"><span class="text-xs">Â¥</span>${i.price}</div>
                                        <div class="text-[10px] text-orange-600 border border-orange-200 px-1.5 py-0.5 rounded bg-orange-50/50">${i.status}</div>
                                    </div>
                                </div>
                             </div>`;
                        }
                        // Fallback for generic array items
                        return `<div class="p-3 bg-white rounded-lg mb-2 shadow-sm text-[11px] break-all m-2">${typeof i === 'object' ? JSON.stringify(i) : i}</div>`;
                    }).join('');
                    container.innerHTML = `<div class="p-2 bg-gray-50/50 min-h-full">${itemsHtml}</div>`;
                    return; // Added return to exit after handling array types
                }

                // æ–‡æœ¬å‹ (æ—¥è®°, ç¬”è®°, ä¸–ç•Œä¹¦ç­‰) - This block handles non-array appData
                const icon = iconMap[appName] || 'fa-file-lines';

                // ç‰¹æ®Šå¤„ç† HTML å†…å®¹ (å¦‚ä¸–ç•Œä¹¦)
                let contentHtml = typeof appData === 'string' ? appData : JSON.stringify(appData); // Ensure contentHtml is always a string
                if (typeof appData === 'string') {
                    // å°è¯•åè½¬ä¹‰
                    if (appData.includes('&lt;') || appName === 'worldbook') {
                        contentHtml = appData
                            .replace(/&lt;/g, '<')
                            .replace(/&gt;/g, '>')
                            .replace(/&quot;/g, '"')
                            .replace(/&amp;/g, '&')
                            .replace(/&nbsp;/g, ' ');
                    }
                    // å»é™¤ Markdown æ ‡è®°
                    contentHtml = contentHtml.replace(/^```html\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                }

                container.innerHTML = `
                    <div class="p-6 bg-gradient-to-br from-white to-gray-50 min-h-full border-x border-gray-100">
                        <div class="mb-6 flex items-center justify-between border-b border-gray-100 pb-4 bg-white/80 backdrop-blur-sm rounded-lg p-3 shadow-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-500 text-lg shadow-inner">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800">${titleMap[appName] || appName}</h3>
                                    <p class="text-[10px] text-gray-400">æœ€åæ›´æ–°äºä»Šå¤©</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm font-light w-full overflow-x-hidden">${contentHtml}</div>
                    </div>`;
            },

            // ç”Ÿæˆæ‰€æœ‰åº”ç”¨æ•°æ® (One-Shot æé€Ÿç‰ˆ)
            generateAllData: async () => {
                if (!confirm('ç¡®å®šè¦ä¸€é”®ç”Ÿæˆå…¨æœºå†…å®¹å—ï¼ŸAIå°†ä¸€æ¬¡æ€§ç¼–æ’æ‰€æœ‰åº”ç”¨çš„æ—¶é—´çº¿ã€‚')) return;

                const cid = SearchPhoneUI.targetCharId;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                const btn = document.querySelector('.search-desktop-app-icon i.fa-wand-magic-sparkles')?.parentElement; // æ¡Œé¢é­”æ³•æ£’

                // UI Loading
                let originalIcon = '';
                if (btn) {
                    originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-2xl"></i>';
                    btn.style.pointerEvents = 'none';
                }
                Utils.showToast('æ­£åœ¨å‘ AI å‘é€å…¨æœºç”ŸæˆæŒ‡ä»¤...');

                try {
                    // 1. æ„å»ºé€šç”¨ä¸Šä¸‹æ–‡
                    const commonContext = SearchPhoneUI.buildCommonContext(char);

                    const phoneConfig = SearchPhoneUI.getPhoneConfig();
                    let worldBookPrompt = '';

                    // 1. ä¼˜å…ˆä½¿ç”¨ç»†ç²’åº¦çš„ segments (æ–°ç‰ˆ)
                    if (phoneConfig.worldBookSegments && Array.isArray(phoneConfig.worldBookSegments) && phoneConfig.worldBookSegments.length > 0) {
                        let books = AppStorage.get('wechat_worldbooks', []) || AppStorage.get('world_books', []) || [];
                        if (!Array.isArray(books) && typeof books === 'object') books = Object.values(books);
                        if (!Array.isArray(books)) books = [];

                        // æ„å»º id -> book æ˜ å°„
                        const bookMap = {};
                        books.forEach(b => { if (b && b.id) bookMap[b.id] = b; });

                        const selectedContent = [];
                        phoneConfig.worldBookSegments.forEach(segId => {
                            const [bid, idxStr] = segId.split(':');
                            const idx = parseInt(idxStr);
                            const book = bookMap[bid];
                            if (book) {
                                let text = null;
                                if (book.entries && Array.isArray(book.entries)) {
                                    const entry = book.entries[idx];
                                    if (entry) text = `${entry.title ? 'ã€' + entry.title + 'ã€‘' : ''}${entry.content}`;
                                } else if (book.content && typeof book.content === 'string') {
                                    const segments = book.content.split(/\n+/).filter(s => s.trim());
                                    text = segments[idx];
                                }
                                if (text) selectedContent.push(text);
                            }
                        });

                        if (selectedContent.length > 0) {
                            worldBookPrompt = `\nã€ä¸–ç•Œä¹¦/ç”»é£è®¾å®š (World Book Injection)ã€‘\nè¯·åŠ¡å¿…åœ¨ç”Ÿæˆå†…å®¹ï¼ˆå°¤å…¶æ˜¯æ—¥è®°ã€å¾®åšã€æœ‹å‹åœˆï¼‰æ—¶ï¼Œæ·±åº¦èå…¥ä»¥ä¸‹è®¾å®šé¡¹ï¼š\n${selectedContent.join('\n')}\n`;
                        }
                    }
                    // 2. å…¼å®¹æ—§ç‰ˆæ•´ä¹¦ç»‘å®š (Fallback)
                    else {
                        const selectedIds = phoneConfig.worldBookIds || (phoneConfig.worldBookId ? [phoneConfig.worldBookId] : []);
                        if (selectedIds.length > 0) {
                            let books = AppStorage.get('wechat_worldbooks', []) || AppStorage.get('world_books', []) || [];
                            if (!Array.isArray(books) && typeof books === 'object') books = Object.values(books);
                            if (!Array.isArray(books)) books = [];

                            const selectedBooks = books.filter(b => b && selectedIds.includes(b.id));
                            if (selectedBooks.length > 0) {
                                const combinedContent = selectedBooks.map(b => `ã€Š${b.name}ã€‹è®¾å®šï¼š\n${b.content}`).join('\n\n');
                                worldBookPrompt = `\nã€ä¸–ç•Œä¹¦/ç”»é£è®¾å®š (World Book Injection)ã€‘\nè¯·åŠ¡å¿…åœ¨ç”Ÿæˆå†…å®¹ï¼ˆå°¤å…¶æ˜¯æ—¥è®°ã€å¾®åšã€æœ‹å‹åœˆï¼‰æ—¶ï¼Œæ·±åº¦èå…¥ä»¥ä¸‹ ${selectedBooks.length} æœ¬ä¸–ç•Œä¹¦çš„è®¾å®šï¼š\n${combinedContent}\n`;
                            }
                        }
                    }

                    // 2. æ„å»ºè¶…çº§æŒ‡ä»¤ Prompt
                    const masterPrompt = `ä½ æ˜¯ä¸€ä¸ªæ‰‹æœºæ•°æ®ç”Ÿæˆå™¨ã€‚ä¸ºè§’è‰²ã€${char.name}ã€‘ç”Ÿæˆæ‰‹æœºå†…å®¹ã€‚
ä»Šæ—¥æ—¥æœŸï¼š${new Date().toLocaleDateString()}

ã€æ ¸å¿ƒè§„åˆ™ã€‘
1. **ç»å¯¹ç¦æ­¢**åœ¨æ—¥è®°ã€å¤‡å¿˜å½•ã€å¾®åšä¸­å‡ºç° '###', '[INNER_VOICE]', 'Inner Voice' ç­‰æ ‡ç­¾ã€‚å†…å®¹å¿…é¡»æ˜¯çº¯å‡€çš„æ–‡æœ¬ã€‚
2. **å›¾ç‰‡ç”Ÿæˆ**ï¼šå¦‚æœéœ€è¦å›¾ç‰‡ï¼Œè¯·ä½¿ç”¨ Markdown å›¾ç‰‡æ ¼å¼ï¼ŒURL ä½¿ç”¨ "https://image.pollinations.ai/prompt/å…³é”®è¯"ï¼Œå…³é”®è¯ç”¨è‹±æ–‡ã€‚

ã€è§’è‰²äººè®¾ã€‘
${char.prompt || 'æ™®é€šäºº'}
${worldBookPrompt}
(ä¸»è¦å…³ç³»: ç½®é¡¶æ˜¯ã€${char.pinnedUser || 'æœªè®¾ç½®'}ã€‘)

ã€ä»»åŠ¡åˆ—è¡¨ã€‘
è¯·ä¸€æ¬¡æ€§è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

1. **wechat (å¾®ä¿¡)**:
   - ç”Ÿæˆ 2-3 ä¸ª NPC ä¼šè¯ã€‚
   - **å•äºº**ï¼šè™šæ„ä¸€ä¸ªå…·ä½“èº«ä»½ï¼ˆå¦‚åŒäº‹å°ç‹ï¼‰ï¼Œå¿…é¡»ç”Ÿæˆ distinct çš„å¤‡æ³¨åã€‚
   - **ç¾¤èŠ**ï¼šè™šæ„ä¸€ä¸ªç¾¤ï¼ˆå¦‚â€œåƒç“œå°åˆ†é˜Ÿâ€ï¼‰ï¼Œ**ç¾¤å‹å¿…é¡»æœ‰ä¸åŒçš„æ˜µç§°**ï¼ˆå¦‚â€œAâ€, "B"ï¼‰ï¼Œä¸è¦ç”¨â€œç¾¤å‹â€è¿™ä¸ªç»Ÿç§°ã€‚
   - **åˆ‡è®°**ï¼šNPC çš„å¯¹è¯ä¸­**ä¸è¦åŒ…å«å¿ƒå£°**ï¼Œä»–ä»¬æ˜¯å¤–äººã€‚
   - **åˆ‡è®°**ï¼šä¸è¦ç”Ÿæˆç½®é¡¶è”ç³»äººçš„å¯¹è¯ã€‚

2. **weibo (å¾®åš)**:
   - ç”Ÿæˆ 2 æ¡å¾®åšã€‚å‘å¸ƒè€…æ˜¯ã€${char.name}ã€‘è‡ªå·±ã€‚
   - å†…å®¹è¦è´´åˆäººè®¾ã€‚é…å›¾ä½¿ç”¨ pollinations.aiã€‚

3. **diary (æ—¥è®°)**:
   - ç”Ÿæˆ 1 ç¯‡æ—¥è®°ã€‚
   - **æ ‡é¢˜è§„åˆ™**ï¼š**ç»å¯¹ç¦æ­¢**ä½¿ç”¨â€œæ—¥è®°â€ã€â€œæ— é¢˜â€ã€â€œè®°äº‹æœ¬â€ç­‰é€šç”¨è¯ã€‚è¯·æ ¹æ®å†…å®¹èµ·ä¸€ä¸ªå……æ»¡æ„å¢ƒçš„æ ‡é¢˜ï¼ˆå¦‚ã€Šé›¨çš„å£°éŸ³ã€‹ã€ã€Šå¿ƒç¢çš„ä¸€å¤©ã€‹ï¼‰ã€‚
   - å†…å®¹ï¼š800å­—ä»¥ä¸Šï¼Œæåº¦ç»†è…»ã€æ„Ÿæ€§ã€ç§å¯†ã€‚

4. **notes (å¤‡å¿˜å½•)**:
   - ç”Ÿæˆ 1 ä¸ªè´­ç‰©æ¸…å•æˆ–å¾…åŠäº‹é¡¹ã€‚
   - **æ ‡é¢˜**ï¼šå…·ä½“æ˜äº†ï¼ˆå¦‚â€œå‘¨æœ«è¶…å¸‚è´­ä¹°æ¸…å•â€ã€â€œå¾…åŠäº‹é¡¹â€ï¼‰ã€‚

5. **browser (æµè§ˆå™¨)**:
   - ç”Ÿæˆ 3-5 æ¡æµè§ˆè®°å½•ã€‚

6. **shopping (æ·˜å®)**:
   - ç”Ÿæˆ 2-3 ä¸ªå·²è´­å•†å“ï¼ˆå°†è‡ªåŠ¨æ‰£æ¬¾ï¼‰ã€‚
   - å›¾ç‰‡ä½¿ç”¨ pollinations.ai/prompt/product_nameã€‚

7. **footprint (è¶³è¿¹)**:
   - ç”Ÿæˆ 4-6 ä¸ªæ—¶é—´èŠ‚ç‚¹ï¼Œæ¶µç›–å…¨å¤©ã€‚
   - å¿…é¡»æŒ‰æ—¶é—´æ’åºã€‚

8. **schedule (æ—¥ç¨‹)**:
   - ç”Ÿæˆ 3-5 ä¸ªæ—¥ç¨‹ã€‚
   - type: work/life/urgentã€‚

ã€è¾“å‡ºæ ¼å¼ (Strict JSON)ã€‘
{
  "wechat": {
    "pinned_remark": "...",
    "chats": [
       { "type": "single", "name": "...", "avatar": "...", "history": [ {"role": "npc", "msg": "..."}, {"role": "me", "msg": "..."} ] },
       { "type": "group", "name": "...", "history": [ {"role": "npc", "name": "ç¾¤å‹A", "msg": "..."}, {"role": "npc", "name": "ç¾¤å‹B", "msg": "..."} ] }
    ]
  },
  "weibo": { "posts": [ { "content": "...", "images": ["..."], "time": "10åˆ†é’Ÿå‰", "likes": 12 } ] },
  "diary": { "entries": [ { "date": "12æœˆxxæ—¥", "title": "...", "content": "..." } ] },
  "notes": { "notes": [ { "title": "...", "items": ["..."], "content": "..." } ] },
  "browser": { "history": [ { "title": "...", "url": "..." } ] },
  "shopping": { "orders": [ { "item": "...", "price": 199, "image": "...", "status": "å¾…å‘è´§" } ] },
  "footprint": { "locations": [ { "place": "...", "time": "...", "desc": "..." } ] },
  "schedule": { "events": [ { "time": "...", "event": "...", "type": "work" } ] }
}`;

                    // 3. å‘é€è¯·æ±‚
                    const result = await SettingsLogic.generateLLM([
                        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªJSONç”Ÿæˆå·¥å‚ã€‚åªè¾“å‡ºJSONã€‚ä¸è¦MarkdownåŒ…è£¹ã€‚" },
                        { role: "user", content: masterPrompt }
                    ], null, 'script');

                    // 4. è§£æç»“æœ
                    let jsonStr = (result || "").trim().replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                    const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„å¤§ç»Ÿä¸€JSON");
                    const bigData = JSON.parse(jsonMatch[0]);

                    // 5. åˆ†å‘æ•°æ®
                    const allData = AppStorage.get('wechat_search_phone_data', {});
                    if (!allData[cid]) allData[cid] = {};

                    let updateCount = 0;

                    // --- åˆ†å‘ Wechat ---
                    if (bigData.wechat) {
                        const wxData = bigData.wechat;
                        // ç½®é¡¶å¤‡æ³¨
                        if (wxData.pinned_remark && wxData.pinned_remark !== char.pinnedUser) {
                            char.pinnedUser = wxData.pinned_remark;
                            chars[cid] = char;
                            AppStorage.set('wechat_chars', chars);
                        }
                        // èŠå¤©åˆ—è¡¨
                        if (wxData.chats && Array.isArray(wxData.chats)) {
                            if (!allData[cid].wechat) allData[cid].wechat = [];
                            wxData.chats.forEach(chat => {
                                if (chat.isPinned || chat.name === char.pinnedUser) return;
                                const lastMsg = (chat.history?.slice(-1)[0]?.msg) || "[æ–°æ¶ˆæ¯]";
                                allData[cid].wechat.unshift({
                                    type: chat.type || 'single',
                                    name: chat.name || 'æœªçŸ¥',
                                    avatar: chat.avatar || `https://api.dicebear.com/7.x/notionists/svg?seed=${chat.name}`,
                                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                                    history: chat.history || [],
                                    msg: lastMsg
                                });
                            });
                            updateCount++;
                        }
                    }

                    // --- åˆ†å‘å…¶ä»– App (å« Taobao è”åŠ¨) ---
                    const simpleApps = ['weibo', 'diary', 'notes', 'browser', 'shopping', 'schedule', 'footprint'];
                    const keyMap = {
                        'weibo': 'posts', 'diary': 'entries', 'notes': 'notes',
                        'browser': 'history', 'shopping': 'orders', 'schedule': 'events',
                        'footprint': 'locations'
                    };

                    for (const appName of simpleApps) {
                        if (bigData[appName]) {
                            const items = bigData[appName][keyMap[appName]];
                            if (items && Array.isArray(items) && items.length > 0) {
                                if (!allData[cid][appName]) allData[cid][appName] = [];
                                // AIé€šå¸¸æŒ‰æ—¶é—´æ­£åºç”Ÿæˆ(æ—©->æ™š)ï¼Œä½†ç”¨æˆ·åé¦ˆå¸Œæœ›ä¿æŒä¸€ç§ç‰¹å®šé¡ºåº
                                // è¿™é‡Œéµä»ç”¨æˆ·æŒ‡ç¤ºï¼Œå»æ‰ reverse()ï¼Œè®© AI è¾“å‡ºçš„é¡ºåºç›´æ¥ç½®é¡¶ã€‚
                                allData[cid][appName].unshift(...items);
                                updateCount++;

                                // **[è”åŠ¨] æ·˜å® -> é’±åŒ…**
                                if (appName === 'shopping') {
                                    items.forEach(order => {
                                        if (order.price) {
                                            // å¢å¼ºè§£æ, å…¼å®¹ "199.9", "Â¥199", "199å…ƒ"
                                            const rawPrice = String(order.price).replace(/[^\d.]/g, '');
                                            const amount = parseFloat(rawPrice) || 0;
                                            if (amount > 0) {
                                                WalletLogic.addTransaction(cid, {
                                                    type: 'expense',
                                                    amount: amount,
                                                    title: `æ·˜å® - ${order.item}`,
                                                    time: new Date().toLocaleString()
                                                });
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    }

                    // 6. ä¿å­˜
                    AppStorage.set('wechat_search_phone_data', allData);

                    // æ¢å¤è‡ªåŠ¨ç”Ÿæˆçš„é’±åŒ…æµæ°´ï¼Œç¡®ä¿æ¯æ¬¡ç”Ÿæˆéƒ½æœ‰é’±åŒ…å˜åŒ–
                    if (SearchPhoneUI.generateWalletTransactions) await SearchPhoneUI.generateWalletTransactions(cid);

                    Utils.showToast(`ä¸€é”®ç”Ÿæˆå®Œæ¯•ï¼æ›´æ–°äº† ${updateCount} ä¸ªåº”ç”¨çš„æ•°æ®ã€‚`);

                } catch (e) {
                    console.error("ä¸€é”®ç”Ÿæˆå¤±è´¥:", e);
                    Utils.showToast("ç”Ÿæˆå¤±è´¥: " + e.message);
                } finally {
                    if (btn && originalIcon) {
                        btn.innerHTML = originalIcon;
                        btn.style.pointerEvents = 'auto';
                    }
                }
            },

            // æ¸…ç©ºæ‰€æœ‰åº”ç”¨æ•°æ®
            clearAllData: () => {
                const charId = SearchPhoneUI.targetCharId;
                if (!charId || !confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åº”ç”¨çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
                const allData = AppStorage.get('wechat_search_phone_data', {});
                if (allData[SearchPhoneUI.targetCharId]) {
                    delete allData[SearchPhoneUI.targetCharId];
                    AppStorage.set('wechat_search_phone_data', allData);
                    Utils.showToast('æ‰€æœ‰è®°å½•å·²æ¸…ç©ºï¼');
                }
            },

            openBeautyManager: () => {
                const modal = document.getElementById('modal-phone-beauty');
                modal.classList.remove('translate-y-full');
                modal.style.pointerEvents = 'auto';
                SearchPhoneUI.initBeautyPreview();
            },

            closeBeautyManager: () => {
                const modal = document.getElementById('modal-phone-beauty');
                modal.classList.add('translate-y-full');
                modal.style.pointerEvents = 'none';
            },

            // åˆå§‹åŒ–ç¾åŒ–ç®¡ç†é¢„è§ˆ
            initBeautyPreview: () => {
                const phoneConfig = SearchPhoneUI.getPhoneConfig();
                const wallpaperPreview = document.getElementById('wallpaper-preview');
                if (phoneConfig.wallpaper) {
                    wallpaperPreview.style.backgroundImage = `url(${phoneConfig.wallpaper})`;
                    wallpaperPreview.style.backgroundSize = 'cover';
                    wallpaperPreview.style.backgroundPosition = 'center';
                    wallpaperPreview.querySelector('span').style.display = 'none';
                } else {
                    wallpaperPreview.style.backgroundImage = '';
                    wallpaperPreview.querySelector('span').style.display = 'flex';
                }

                const appTypes = ['wechat', 'wallet', 'browser', 'shopping', 'diary', 'notes', 'weibo', 'footprint'];
                const iconMap = {
                    'wechat': 'fa-brands fa-weixin', 'wallet': 'fa-solid fa-wallet',
                    'browser': 'fa-brands fa-chrome', 'shopping': 'fa-solid fa-bag-shopping',
                    'diary': 'fa-solid fa-book', 'notes': 'fa-solid fa-note-sticky',
                    'weibo': 'fa-brands fa-weibo', 'footprint': 'fa-solid fa-location-dot'
                };

                appTypes.forEach(appType => {
                    const preview = document.getElementById(`icon-preview-${appType}`);
                    if (preview) {
                        if (phoneConfig.icons && phoneConfig.icons[appType]) {
                            preview.style.backgroundImage = `url(${phoneConfig.icons[appType]})`;
                            preview.style.backgroundSize = 'cover';
                            preview.style.backgroundPosition = 'center';
                            preview.querySelector('i').style.display = 'none';
                        } else {
                            preview.style.backgroundImage = '';
                            preview.querySelector('i').style.display = 'block';
                        }
                    }

                    const iconElement = document.querySelector(`[onclick*="openSubApp('${appType}')"]`);
                    if (iconElement) {
                        const iconDiv = iconElement.querySelector('div');
                        if (iconDiv) {
                            if (phoneConfig.icons && phoneConfig.icons[appType]) {
                                iconDiv.style.backgroundImage = `url(${phoneConfig.icons[appType]})`;
                                iconDiv.style.backgroundSize = 'cover';
                                iconDiv.style.backgroundPosition = 'center';
                                iconDiv.innerHTML = '';
                            } else {
                                iconDiv.style.backgroundImage = '';
                                iconDiv.innerHTML = `<i class="${iconMap[appType]} text-white text-2xl"></i>`;
                            }
                        }
                    }
                });

                if (phoneConfig.widgets) {
                    if (phoneConfig.widgets.scheduleBg) document.getElementById('schedule-bg-url').value = phoneConfig.widgets.scheduleBg;
                    else document.getElementById('schedule-bg-url').value = '';
                    if (phoneConfig.widgets.textColor) document.getElementById('widget-text-color').value = phoneConfig.widgets.textColor;
                    else document.getElementById('widget-text-color').value = '#ffffff';
                }

                // åˆå§‹åŒ–ä¸–ç•Œä¹¦åˆ—è¡¨ (ç»†ç²’åº¦æ¡ç›®å¤šé€‰)
                const wbList = document.getElementById('phone-worldbook-list');
                if (wbList) {
                    wbList.innerHTML = '';
                    let books = AppStorage.get('wechat_worldbooks', []) || AppStorage.get('world_books', []) || [];
                    if (!Array.isArray(books) && typeof books === 'object') books = Object.values(books);
                    if (!Array.isArray(books)) books = [];

                    if (books.length === 0) {
                        wbList.innerHTML = '<div class="text-xs text-gray-400 text-center py-2">æš‚æ— ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨èŠå¤©è®¾ç½®ä¸­æ·»åŠ </div>';
                    } else {
                        // è·å–å½“å‰é€‰ä¸­çš„ segments
                        const selectedSegments = new Set(phoneConfig.worldBookSegments || []);
                        let hasRenderedAny = false;

                        books.forEach(b => {
                            if (!b) return;

                            // 1. è§£ææ•°æ®
                            let items = [];
                            if (b.entries && Array.isArray(b.entries)) {
                                items = b.entries.map((e, idx) => ({
                                    id: `${b.id}:${idx}`,
                                    title: e.title || `æ¡ç›® ${idx + 1}`,
                                    content: e.content || '',
                                })).filter(i => (i.title + i.content).trim().length > 0);
                            } else {
                                const rawContent = b.content || b.desc || b.description || b.text || "";
                                items = rawContent.split(/\n+/).map((s, idx) => ({
                                    id: `${b.id}:${idx}`,
                                    title: `ç‰‡æ®µ ${idx + 1}`,
                                    content: s.trim()
                                })).filter(i => i.content.length > 0);
                            }

                            if (items.length === 0) return;
                            hasRenderedAny = true;

                            // Check selection count
                            const selectedCount = items.filter(i => selectedSegments.has(i.id)).length;

                            // 2. æ¸²æŸ“åˆ†ç»„å¤´ (Accordion Header)
                            const groupTitle = document.createElement('div');
                            groupTitle.className = 'sticky top-0 z-10 flex justify-between items-center px-4 py-3 bg-gray-50/95 backdrop-blur text-sm font-medium text-gray-700 border-b border-gray-200 cursor-pointer select-none hover:bg-gray-100 transition-colors';
                            groupTitle.onclick = () => SearchPhoneUI.toggleWorldBookGroup(b.id);

                            // Always start with arrow at 0deg (collapsed)
                            const arrowStyle = '';
                            groupTitle.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <i id="wb-arrow-${b.id}" class="fa-solid fa-caret-right text-gray-400 transition-transform duration-200" style="${arrowStyle}"></i>
                                    <span>${b.name}</span>
                                    <span class="text-xs text-gray-400 font-normal">(${selectedCount}/${items.length})</span>
                                </div>
                                <span class="text-[#576b95] text-xs active:opacity-50 hover:bg-blue-50 px-2 py-1 rounded" onclick="SearchPhoneUI.toggleAllSegments('${b.id}', ${items.length}, event)">å…¨é€‰</span>
                            `;
                            wbList.appendChild(groupTitle);

                            // 3. æ¸²æŸ“æ¡ç›®åˆ—è¡¨å®¹å™¨ (Accordion Body)
                            const listContainer = document.createElement('div');
                            listContainer.id = `wb-group-${b.id}`;
                            // ALWAYS collapse by default to prevent clutter
                            listContainer.style.display = 'none';

                            items.forEach(item => {
                                const isChecked = selectedSegments.has(item.id);
                                const div = document.createElement('div');
                                // Added 'wb-row-ID' class for selector
                                div.className = `wb-row-${b.id} group flex items-start gap-3 px-4 py-3 bg-white border-b border-gray-100 last:border-0 cursor-pointer active:bg-gray-50 transition-colors`;

                                div.innerHTML = `
                                    <div class="checkbox-indicator mt-0.5 w-5 h-5 rounded-full border ${isChecked ? 'bg-[#07c160] border-[#07c160]' : 'border-gray-300 bg-white'} flex items-center justify-center transition-colors shadow-sm flex-shrink-0">
                                        <i class="fa-solid fa-check text-white text-xs ${isChecked ? 'opacity-100' : 'opacity-0'} transition-opacity"></i>
                                    </div>
                                    <input type="checkbox" value="${item.id}" class="hidden" ${isChecked ? 'checked' : ''}>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-[15px] text-gray-900 font-medium mb-0.5 truncate">${item.title}</div>
                                        <div class="text-xs text-gray-500 line-clamp-2 leading-relaxed tracking-wide text-justify break-all">${item.content || 'æ— å†…å®¹'}</div>
                                    </div>
                                `;

                                div.onclick = (e) => {
                                    const widthCheckbox = div.querySelector('input');
                                    const indicator = div.querySelector('.checkbox-indicator');
                                    const icon = indicator.querySelector('i');

                                    // Toggle State
                                    widthCheckbox.checked = !widthCheckbox.checked;
                                    const nowChecked = widthCheckbox.checked;

                                    // Update Visuals
                                    if (nowChecked) {
                                        indicator.className = 'checkbox-indicator mt-0.5 w-5 h-5 rounded-full border bg-[#07c160] border-[#07c160] flex items-center justify-center transition-colors shadow-sm flex-shrink-0';
                                        icon.classList.remove('opacity-0');
                                        icon.classList.add('opacity-100');
                                    } else {
                                        indicator.className = 'checkbox-indicator mt-0.5 w-5 h-5 rounded-full border border-gray-300 bg-white flex items-center justify-center transition-colors shadow-sm flex-shrink-0';
                                        icon.classList.remove('opacity-100');
                                        icon.classList.add('opacity-0');
                                    }

                                    // Trigger Logic
                                    SearchPhoneUI.handleWorldBookBind();
                                };

                                listContainer.appendChild(div);
                            });
                            wbList.appendChild(listContainer);
                        });

                        if (!hasRenderedAny) {
                            wbList.innerHTML = '<div class="text-xs text-red-400 text-center py-2 px-2 leading-relaxed">è™½æœ‰ä¸–ç•Œä¹¦è®°å½•ï¼Œä½†æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ–‡æœ¬å†…å®¹ã€‚<br>è¯·æ£€æŸ¥è®¾ç½®ã€‚</div>';
                        }
                    }
                }
            },

            // æŠ˜å /å±•å¼€åˆ†ç»„ (å¼ºåˆ¶ inline style æ¨¡å¼)
            toggleWorldBookGroup: (bid) => {
                const group = document.getElementById(`wb-group-${bid}`);
                const arrow = document.getElementById(`wb-arrow-${bid}`);
                if (group) {
                    if (group.style.display === 'none') {
                        group.style.display = 'block';
                        if (arrow) arrow.style.transform = 'rotate(90deg)';
                    } else {
                        group.style.display = 'none';
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                    }
                }
            },

            // å…¨é€‰/åé€‰ (ä¿®å¤UIåŒæ­¥ - å®¹å™¨æŸ¥æ‰¾ç‰ˆ)
            toggleAllSegments: (bid, count, event) => {
                if (event) event.stopPropagation();

                const groupContainer = document.getElementById(`wb-group-${bid}`);
                if (!groupContainer) return;

                const inputs = Array.from(groupContainer.querySelectorAll('input[type="checkbox"]'));
                if (inputs.length === 0) return;

                const allChecked = inputs.every(i => i.checked);
                const targetState = !allChecked;

                inputs.forEach(input => {
                    const row = input.closest('.group');
                    if (!row) return; // Paranoia check

                    const indicator = row.querySelector('.checkbox-indicator');
                    const icon = indicator.querySelector('i');

                    if (input.checked !== targetState) {
                        input.checked = targetState;
                        // Update Visuals
                        if (targetState) {
                            indicator.className = 'checkbox-indicator mt-0.5 w-5 h-5 rounded-full border bg-[#07c160] border-[#07c160] flex items-center justify-center transition-colors shadow-sm flex-shrink-0';
                            icon.classList.remove('opacity-0');
                            icon.classList.add('opacity-100');
                        } else {
                            indicator.className = 'checkbox-indicator mt-0.5 w-5 h-5 rounded-full border border-gray-300 bg-white flex items-center justify-center transition-colors shadow-sm flex-shrink-0';
                            icon.classList.remove('opacity-100');
                            icon.classList.add('opacity-0');
                        }
                    }
                });

                SearchPhoneUI.handleWorldBookBind();
            },

            handleWorldBookBind: () => {
                const config = SearchPhoneUI.getPhoneConfig();
                const checkboxes = document.querySelectorAll('#phone-worldbook-list input[type="checkbox"]:checked');
                config.worldBookSegments = Array.from(checkboxes).map(cb => cb.value);

                // æ¸…ç†æ—§æ•°æ®ï¼Œé¿å…æ··æ·†
                delete config.worldBookId;
                delete config.worldBookIds;

                SearchPhoneUI.savePhoneConfig(config);
            },

            getPhoneConfig: () => {
                const phoneConfigs = AppStorage.get('wechat_phone_configs', {});
                return phoneConfigs[SearchPhoneUI.targetCharId] || {};
            },

            savePhoneConfig: (config) => {
                const phoneConfigs = AppStorage.get('wechat_phone_configs', {});
                phoneConfigs[SearchPhoneUI.targetCharId] = config;
                AppStorage.set('wechat_phone_configs', phoneConfigs);
                SearchPhoneUI.applyPhoneConfig(config);
            },

            applyPhoneConfig: (config) => {
                const desktop = document.getElementById('search-page-desktop');
                if (config.wallpaper) {
                    desktop.style.backgroundImage = `url(${config.wallpaper})`;
                    desktop.style.backgroundSize = 'cover';
                    desktop.style.backgroundPosition = 'center';
                    desktop.style.backgroundRepeat = 'no-repeat';
                    desktop.style.backgroundAttachment = 'scroll';
                } else {
                    const defaultBg = 'https://i.postimg.cc/Bb0Vs6JX/fen-mei-gui.png';
                    desktop.style.backgroundImage = `url(${defaultBg})`;
                    desktop.style.backgroundSize = 'cover';
                    desktop.style.backgroundPosition = 'center';
                    desktop.style.backgroundRepeat = 'no-repeat';
                }

                const appTypes = ['wechat', 'wallet', 'browser', 'shopping', 'diary', 'notes', 'weibo', 'footprint'];
                const iconMap = {
                    'wechat': 'fa-brands fa-weixin', 'wallet': 'fa-solid fa-wallet',
                    'browser': 'fa-brands fa-chrome', 'shopping': 'fa-solid fa-bag-shopping',
                    'diary': 'fa-solid fa-book', 'notes': 'fa-solid fa-note-sticky',
                    'weibo': 'fa-brands fa-weibo', 'footprint': 'fa-solid fa-location-dot'
                };

                appTypes.forEach(app => {
                    const iconElement = document.querySelector(`[onclick*="openSubApp('${app}')"]`);
                    if (iconElement) {
                        const iconDiv = iconElement.querySelector('div');
                        if (iconDiv) {
                            if (config.icons && config.icons[app]) {
                                iconDiv.style.backgroundImage = `url(${config.icons[app]})`;
                                iconDiv.style.backgroundSize = 'cover';
                                iconDiv.style.backgroundPosition = 'center';
                                iconDiv.innerHTML = '';
                            } else {
                                iconDiv.style.backgroundImage = '';
                                iconDiv.innerHTML = `<i class="${iconMap[app]} text-white text-2xl"></i>`;
                            }
                        }
                    }
                });

                if (config.widgets) {
                    if (config.widgets.scheduleBg) {
                        const sw = document.querySelector('#search-page-desktop .aspect-square:nth-child(1)');
                        if (sw) {
                            sw.style.backgroundImage = `url(${config.widgets.scheduleBg})`;
                            sw.style.backgroundSize = 'cover';
                            sw.style.backgroundPosition = 'center';
                        }
                    }
                    if (config.widgets.galleryBg) {
                        const gw = document.querySelector('#search-page-desktop .aspect-square:nth-child(2)');
                        if (gw) {
                            gw.style.backgroundImage = `url(${config.widgets.galleryBg})`;
                            gw.style.backgroundSize = 'cover';
                            gw.style.backgroundPosition = 'center';
                        }
                    }
                    if (config.widgets.textColor) {
                        document.querySelectorAll('#search-page-desktop .aspect-square').forEach(w => w.style.color = config.widgets.textColor);
                    }
                }
            },

            applyWallpaperFromUrl: () => {
                const url = document.getElementById('wallpaper-url').value.trim();
                if (!url) return Utils.showToast('è¯·è¾“å…¥å£çº¸ URL');
                const config = SearchPhoneUI.getPhoneConfig();
                config.wallpaper = url;
                SearchPhoneUI.savePhoneConfig(config);
                Utils.showToast('å£çº¸å·²åº”ç”¨ï¼');
            },

            resetWallpaper: () => {
                const config = SearchPhoneUI.getPhoneConfig();
                delete config.wallpaper;
                SearchPhoneUI.savePhoneConfig(config);
                Utils.showToast('å£çº¸å·²é‡ç½®ï¼');
            },

            handleWallpaperUpload: (input) => {
                if (!input.files[0]) return;
                Utils.compressImage(input.files[0], 1080, 0.9).then(base64 => {
                    const config = SearchPhoneUI.getPhoneConfig();
                    config.wallpaper = base64;
                    SearchPhoneUI.savePhoneConfig(config);
                    Utils.showToast('å£çº¸å·²ä¸Šä¼ å¹¶åº”ç”¨ï¼');
                });
            },

            applyWidgetBg: (widgetType) => {
                const url = document.getElementById(`${widgetType}-bg-url`).value.trim();
                if (!url) return Utils.showToast('è¯·è¾“å…¥èƒŒæ™¯å›¾ URL');
                const config = SearchPhoneUI.getPhoneConfig();
                config.widgets = config.widgets || {};
                if (widgetType === 'schedule') config.widgets.scheduleBg = url;
                else if (widgetType === 'gallery') config.widgets.galleryBg = url;
                SearchPhoneUI.savePhoneConfig(config);
                Utils.showToast('å°ç»„ä»¶èƒŒæ™¯å·²åº”ç”¨ï¼');
            },

            applyWidgetTextColor: () => {
                const color = document.getElementById('widget-text-color').value;
                const config = SearchPhoneUI.getPhoneConfig();
                config.widgets = config.widgets || {};
                config.widgets.textColor = color;
                SearchPhoneUI.savePhoneConfig(config);
                Utils.showToast('æ–‡å­—é¢œè‰²å·²åº”ç”¨ï¼');
            },

            handleWidgetBgUpload: (widgetType, input) => {
                if (!input.files[0]) return;
                Utils.compressImage(input.files[0]).then(base64 => {
                    const config = SearchPhoneUI.getPhoneConfig();
                    config.widgets = config.widgets || {};
                    if (widgetType === 'schedule') config.widgets.scheduleBg = base64;
                    else if (widgetType === 'gallery') config.widgets.galleryBg = base64;
                    SearchPhoneUI.savePhoneConfig(config);
                    Utils.showToast('å°ç»„ä»¶èƒŒæ™¯å·²ä¸Šä¼ å¹¶åº”ç”¨ï¼');
                });
            },

            resetIcons: () => {
                if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å›¾æ ‡ä¸ºé»˜è®¤å—ï¼Ÿ')) return;
                const config = SearchPhoneUI.getPhoneConfig();
                delete config.icons;
                SearchPhoneUI.savePhoneConfig(config);
                Utils.showToast('æ‰€æœ‰å›¾æ ‡å·²é‡ç½®');
            },

            resetSingleIcon: (appType) => {
                const config = SearchPhoneUI.getPhoneConfig();
                if (config.icons && config.icons[appType]) {
                    delete config.icons[appType];
                    SearchPhoneUI.savePhoneConfig(config);
                    Utils.showToast(`${appType} å›¾æ ‡å·²é‡ç½®`);
                }
            },

            resetWidgetBg: (widgetType) => {
                const config = SearchPhoneUI.getPhoneConfig();
                if (config.widgets) {
                    if (widgetType === 'schedule') delete config.widgets.scheduleBg;
                    else if (widgetType === 'gallery') delete config.widgets.galleryBg;
                    SearchPhoneUI.savePhoneConfig(config);
                    Utils.showToast('å°ç»„ä»¶èƒŒæ™¯å·²é‡ç½®');
                }
            },

            uploadSingleIcon: (appType) => {
                SearchPhoneUI.currentUploadApp = appType;
                document.getElementById('single-icon-upload').click();
            },

            openWidgetSettings: (widgetId) => {
                Utils.showPrompt(`è®¾ç½®å°ç»„ä»¶ ${widgetId} çš„å›¾ç‰‡`, 'è¾“å…¥å›¾ç‰‡URLæˆ–ç•™ç©ºæ¸…é™¤', (url) => {
                    if (url === null) return;
                    const config = SearchPhoneUI.getPhoneConfig();
                    config.widgets = config.widgets || {};
                    if (url.trim()) config.widgets[`widget${widgetId}`] = url.trim();
                    else delete config.widgets[`widget${widgetId}`];
                    SearchPhoneUI.savePhoneConfig(config);
                    SearchPhoneUI.loadWidgets();
                    Utils.showToast('å°ç»„ä»¶å·²æ›´æ–°');
                });
            },

            loadWidgets: () => {
                const config = SearchPhoneUI.getPhoneConfig();
                const widgets = config.widgets || {};
                [1, 2].forEach(id => {
                    const el = document.getElementById(`search-widget-${id}`);
                    if (!el) return;
                    const imgUrl = widgets[`widget${id}`];
                    if (imgUrl) el.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover">`;
                    else el.innerHTML = `<i class="fa-solid fa-image text-3xl text-white/50"></i>`;
                });
            },

            // --- é’±åŒ…æ•°æ®ç®¡ç† ---
            getCharWalletData: function (charId) {
                const allData = AppStorage.get('wechat_search_phone_data', {});
                if (!allData[charId]) {
                    allData[charId] = { wallet: { balance: 0, transactions: [] } };
                }
                if (!allData[charId].wallet) {
                    allData[charId].wallet = { balance: 0, transactions: [] };
                }
                return allData[charId].wallet;
            },

            saveCharWalletData: function (charId, walletData) {
                const allData = AppStorage.get('wechat_search_phone_data', {});
                if (!allData[charId]) allData[charId] = {};
                allData[charId].wallet = walletData;
                AppStorage.set('wechat_search_phone_data', allData);
            },

            calculateWalletBalance: function (cid) {
                const data = this.getCharWalletData(cid);
                return data.balance || 0;
            },

            // æ¸²æŸ“é’±åŒ…ç•Œé¢
            renderWallet: function (charId) {
                const walletData = this.getCharWalletData(charId);
                const container = document.getElementById('subapp-content');
                if (!container) return;

                // é»‘é‡‘å¥¢åUI(ä¿®å¤: ä½™é¢å­—ä½“å¤§å°è‡ªé€‚åº”ï¼Œé˜²æ­¢æº¢å‡º)
                container.innerHTML = `
                    <div class="wallet-container" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); min-height: calc(100% + 2rem); width: calc(100% + 2rem); margin: -1rem; padding: calc(20px + 1rem); overflow-x: hidden;">
                        <!-- ä½™é¢å¡ç‰‡ -->
                        <div class="balance-card" style="background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%); border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 20px; padding: 30px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.15); width: 100%; box-sizing: border-box;">
                            <div style="font-size: 14px; color: rgba(255, 215, 0, 0.8); margin-bottom: 8px; letter-spacing: 1px;">é’±åŒ…ä½™é¢</div>
                            <div id="wallet-balance-display" style="font-size: clamp(24px, 10vw, 42px); font-weight: 700; color: #d4af37; text-shadow: 0 2px 10px rgba(212, 175, 55, 0.3); word-break: break-all; line-height: 1.1; overflow-wrap: break-word;">Â¥${this.calculateWalletBalance(charId).toFixed(2)}</div>
                            <div style="margin-top: 16px; font-size: 12px; color: rgba(255, 255, 255, 0.4);">
                                <span id="wallet-transaction-count">${walletData.transactions.length}</span> ç¬”äº¤æ˜“
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                            <button onclick="SearchPhoneUI.generateWalletTransactions('${charId}')" 
                                    style="flex: 1; padding: 14px; background: linear-gradient(135deg, #d4af37, #f4e0a8); color: #000; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); cursor: pointer;">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> ç ´è§£äº¤æ˜“è®°å½•
                            </button>
                        </div>

                        <!-- äº¤æ˜“è®°å½• -->
                        <div style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">äº¤æ˜“è®°å½•</div>
                        <div id="wallet-transactions-list" style="display: flex; flex-direction: column; gap: 12px;"></div>
                    </div>
                `;

                // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
                this.renderWalletTransactions(charId, walletData.transactions);
            },

            // æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
            renderWalletTransactions: function (charId, transactions) {
                const listEl = document.getElementById('wallet-transactions-list');
                if (!listEl) return;

                if (transactions.length === 0) {
                    listEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.3);">
                            <i class="fa-solid fa-wallet" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <div>æš‚æ— äº¤æ˜“è®°å½•</div>
                        </div>
                    `;
                    return;
                }

                const sorted = [...transactions].sort((a, b) => b.timestamp - a.timestamp);

                listEl.innerHTML = sorted.map(t => {
                    const isIncome = t.type === 'income' || t.type === 'received';
                    const color = isIncome ? '#10b981' : '#ef4444';
                    const sign = isIncome ? '+' : '-';
                    const bgColor = isIncome ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

                    return `
                        <div class="transaction-swipe-wrapper" style="position: relative; overflow: hidden; margin-bottom: 12px; border-radius: 12px; transform: translate3d(0,0,0);">
                            <div class="transaction-item transaction-content" 
                                 style="background: ${bgColor}; border: 1px solid ${color}33; border-radius: 12px; padding: 16px; position: relative; z-index: 2; width: 100%; box-sizing: border-box; display: flex; align-items: stretch;">
                                <div style="flex: 1; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 4px;">
                                            ${t.description || 'äº¤æ˜“'}
                                        </div>
                                        <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5);">
                                            ${new Date(t.timestamp).toLocaleString('zh-CN', {
                        month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    })}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px; font-weight: 700; color: ${color};">
                                            ${sign}Â¥${Math.abs(t.amount).toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                                <div onclick="event.stopPropagation(); SearchPhoneUI.deleteTransaction('${charId}', '${t.id}')" 
                                     style="position: absolute; top: 0; right: -85px; bottom: 0; width: 80px; background: #ef4444; display: flex; align-items: center; justify-content: center; color: white; border-radius: 0 12px 12px 0;">
                                    <i class="fa-solid fa-trash"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                setTimeout(() => {
                    const items = listEl.querySelectorAll('.transaction-content');
                    items.forEach(el => {
                        if (this.bindSwipe) this.bindSwipe(el);
                    });
                }, 0);
            },

            // ç»‘å®šå·¦æ»‘åˆ é™¤äº¤äº’
            bindSwipe: function (element) {
                let startX = 0, currentX = 0, isDragging = false;
                const maxSwipe = -80;

                element.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                    isDragging = true;
                    element.style.transition = 'none';
                }, { passive: true });

                element.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    currentX = e.touches[0].clientX;
                    let delta = currentX - startX;
                    if (delta > 0) delta = 0;
                    if (delta < maxSwipe) delta = maxSwipe + (delta - maxSwipe) * 0.2;
                    element.style.transform = `translateX(${delta}px)`;
                }, { passive: true });

                element.addEventListener('touchend', (e) => {
                    isDragging = false;
                    element.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    const endX = e.changedTouches[0].clientX;
                    const delta = endX - startX;
                    if (delta < maxSwipe / 2) {
                        element.style.transform = `translateX(${maxSwipe}px)`;
                    } else {
                        element.style.transform = 'translateX(0)';
                    }
                });
            },

            // ç”Ÿæˆè™šæ‹Ÿäº¤æ˜“
            generateWalletTransactions: async function (charId) {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return;

                const recentMessages = (char.msgs || []).slice(-20).map(m => ({
                    role: m.role,
                    content: typeof m.content === 'string' ? m.content : JSON.stringify(m.content)
                }));

                // è·å–å½“å‰æ—¶é—´æˆ³å’Œæ—¥æœŸ
                const now = Date.now();
                const currentDate = new Date().toLocaleDateString('zh-CN');

                const prompt = `ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œéœ€è¦æ ¹æ®è§’è‰²çš„äººè®¾å’ŒèŠå¤©è®°å½•ï¼Œç”Ÿæˆç¬¦åˆTAèº«ä»½çš„è™šæ‹Ÿäº¤æ˜“è®°å½•ã€‚

ã€è§’è‰²äººè®¾ã€‘
å§“åï¼š${char.name}
ä¸ªæ€§ï¼š${char.prompt || 'æœªè®¾ç½®'}

ã€æœ€è¿‘ç³»ç»Ÿæ—¥æœŸã€‘
${currentDate}

ã€æœ€è¿‘èŠå¤©æ‘˜è¦ã€‘
${recentMessages.map(m => `[${m.role}] ${String(m.content).substring(0, 50)}`).join('\n')}

ã€ä»»åŠ¡è¦æ±‚ã€‘
è¯·ç”Ÿæˆ 5-10 æ¡ç¬¦åˆè¿™ä¸ªè§’è‰²èº«ä»½çš„äº¤æ˜“è®°å½•ã€‚
æ—¶é—´æˆ³å¿…é¡»æ˜¯13ä½æ¯«ç§’çº§æ—¶é—´æˆ³ï¼Œé›†ä¸­åœ¨æœ€è¿‘ä¸€å‘¨ï¼ˆ${new Date(now - 7 * 86400000).toLocaleDateString()} åˆ° ${currentDate} ä¹‹é—´ï¼‰ã€‚
ç±»å‹(type)å¯é€‰ï¼šexpense(æ”¯å‡º), income(æ”¶å…¥), transfer(è½¬è´¦), redpacket(çº¢åŒ…)ã€‚

ã€è¾“å‡ºæ ¼å¼ï¼ˆçº¯JSONï¼Œä¸è¦Markdownï¼‰ã€‘
{
  "transactions": [
    {
      "type": "expense",
      "amount": 55.00,
      "description": "æ˜Ÿå·´å…‹å’–å•¡",
      "timestamp": ${now - 86400000}
    }
  ]
}`;

                if (Utils.showToast) Utils.showToast('æ­£åœ¨é»‘è¿›é“¶è¡Œç³»ç»Ÿç”Ÿæˆäº¤æ˜“è®°å½•...');

                try {
                    const result = await SettingsLogic.generateLLM([
                        { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„JSONç”ŸæˆåŠ©æ‰‹ï¼Œåªè¾“å‡ºJSONã€‚å¿…é¡»ä¸¥æ ¼éµå®ˆæ—¶é—´èŒƒå›´è¦æ±‚ã€‚" },
                        { role: "user", content: prompt }
                    ], null, 'script');

                    let jsonStr = result.trim().replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```$/i, '');
                    // å°è¯•æå– JSON éƒ¨åˆ†
                    const firstBrace = jsonStr.indexOf('{');
                    const lastBrace = jsonStr.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1) {
                        jsonStr = jsonStr.substring(firstBrace, lastBrace + 1);
                    }
                    const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('è§£æå¤±è´¥ï¼šAIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');

                    const jsonData = JSON.parse(jsonMatch[0]);
                    const transactions = jsonData.transactions;

                    if (!transactions || !Array.isArray(transactions)) {
                        throw new Error('ç”Ÿæˆçš„äº¤æ˜“è®°å½•ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯');
                    }

                    const walletData = this.getCharWalletData(charId);
                    transactions.forEach(t => {
                        const amount = parseFloat(t.amount);
                        const isIncome = t.type === 'income' || t.type === 'received';
                        if (isIncome) walletData.balance += Math.abs(amount);
                        else walletData.balance -= Math.abs(amount);

                        walletData.transactions.push({
                            id: Date.now() + Math.random(),
                            type: t.type,
                            amount: amount,
                            description: t.description,
                            timestamp: t.timestamp || Date.now(),
                            virtual: true
                        });
                    });

                    this.saveCharWalletData(charId, walletData);
                    this.renderWallet(charId);
                    Utils.showToast('âœ¨ æˆåŠŸä¸ºæ‚¨æŒ–æ˜äº† ' + transactions.length + ' æ¡äº¤æ˜“ç§˜è¾›ï¼');

                } catch (error) {
                    console.error('ç”Ÿæˆäº¤æ˜“è®°å½•å¤±è´¥:', error);
                    Utils.showToast('ç ´è§£å¤±è´¥ï¼š' + error.message);
                }
            },

            deleteTransaction: function (charId, transactionId) {
                const walletData = this.getCharWalletData(charId);
                const targetIndex = walletData.transactions.findIndex(t => String(t.id) === String(transactionId));

                if (targetIndex !== -1) {
                    const t = walletData.transactions[targetIndex];
                    const isIncome = t.type === 'income' || t.type === 'received';
                    const amount = parseFloat(t.amount);
                    if (isIncome) walletData.balance -= Math.abs(amount);
                    else walletData.balance += Math.abs(amount);
                    walletData.transactions.splice(targetIndex, 1);
                    this.saveCharWalletData(charId, walletData);
                    this.renderWallet(charId);
                    Utils.showToast('å·²åˆ é™¤è®°å½•å¹¶å›æ»šä½™é¢');
                }
            },

            addRealTransaction: function (charId, transaction) {
                const walletData = this.getCharWalletData(charId);
                walletData.transactions.push({ id: Date.now() + Math.random(), ...transaction });
                this.saveCharWalletData(charId, walletData);
            },
        };

        // ç›‘å¬å£çº¸ä¸Šä¼ 
        document.getElementById('wallpaper-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const config = SearchPhoneUI.getPhoneConfig();
                    config.wallpaper = event.target.result;
                    SearchPhoneUI.savePhoneConfig(config);

                    // æ›´æ–°é¢„è§ˆ
                    const preview = document.getElementById('wallpaper-preview');
                    preview.style.backgroundImage = `url(${event.target.result})`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                    preview.querySelector('span').style.display = 'none';

                    Utils.showToast('å£çº¸å·²ä¸Šä¼ å¹¶åº”ç”¨ï¼');
                };
                reader.readAsDataURL(file);
            }
        });

        // ç›‘å¬å›¾æ ‡ä¸Šä¼ 
        document.getElementById('icon-upload').addEventListener('change', function (e) {
            const files = e.target.files;
            if (files.length > 0) {
                const config = SearchPhoneUI.getPhoneConfig();
                config.icons = config.icons || {};

                // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
                let uploadedCount = 0;
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        // æ ¹æ®æ–‡ä»¶åçŒœæµ‹åº”ç”¨ç±»å‹
                        const fileName = file.name.toLowerCase();
                        let appType = '';
                        if (fileName.includes('wechat') || fileName.includes('å¾®ä¿¡')) appType = 'wechat';
                        else if (fileName.includes('wallet') || fileName.includes('é’±åŒ…')) appType = 'wallet';
                        else if (fileName.includes('browser') || fileName.includes('chrome') || fileName.includes('æµè§ˆå™¨')) appType = 'browser';
                        else if (fileName.includes('shopping') || fileName.includes('æ·˜å®') || fileName.includes('è´­ç‰©')) appType = 'shopping';
                        else if (fileName.includes('diary') || fileName.includes('æ—¥è®°')) appType = 'diary';
                        else if (fileName.includes('notes') || fileName.includes('è®°äº‹æœ¬') || fileName.includes('è®°äº‹')) appType = 'notes';
                        else if (fileName.includes('weibo') || fileName.includes('å¾®åš')) appType = 'weibo';
                        else if (fileName.includes('footprint') || fileName.includes('åœ°å›¾') || fileName.includes('è¶³è¿¹')) appType = 'footprint';
                        else if (fileName.includes('gallery') || fileName.includes('ç›¸å†Œ')) appType = 'gallery';

                        if (appType) {
                            config.icons[appType] = event.target.result;
                            uploadedCount++;

                            // æ›´æ–°é¢„è§ˆ
                            const iconPreview = document.getElementById(`icon-preview-${appType}`);
                            if (iconPreview) {
                                iconPreview.style.backgroundImage = `url(${event.target.result})`;
                                iconPreview.style.backgroundSize = 'cover';
                                iconPreview.style.backgroundPosition = 'center';
                            }
                        }

                        // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
                        if (uploadedCount === files.length) {
                            SearchPhoneUI.savePhoneConfig(config);
                            Utils.showToast(`${uploadedCount}ä¸ªå›¾æ ‡å·²ä¸Šä¼ å¹¶åº”ç”¨ï¼`);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // ç›‘å¬å•ä¸ªå›¾æ ‡ä¸Šä¼ 
        document.getElementById('single-icon-upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const appType = SearchPhoneUI.currentUploadApp;
                    if (appType) {
                        // ä¿å­˜é…ç½®
                        const config = SearchPhoneUI.getPhoneConfig();
                        config.icons = config.icons || {};
                        config.icons[appType] = event.target.result;
                        SearchPhoneUI.savePhoneConfig(config);

                        // æ›´æ–°é¢„è§ˆ
                        const iconPreview = document.getElementById(`icon-preview-${appType}`);
                        if (iconPreview) {
                            iconPreview.style.backgroundImage = `url(${event.target.result})`;
                            iconPreview.style.backgroundSize = 'cover';
                            iconPreview.style.backgroundPosition = 'center';
                        }

                        Utils.showToast(`${appType}å›¾æ ‡å·²ä¸Šä¼ å¹¶åº”ç”¨ï¼`);
                    };

                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥é‡å¤é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶
                    e.target.value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        window.WeChatUI = {
            // --- æ–°å¢åŠŸèƒ½ï¼šè‡ªåŠ¨æœ—è¯»çŠ¶æ€ ---
            isAutoTTS: false,
            summaryLock: false, // é˜²æ­¢å¹¶å‘æ€»ç»“å¯¼è‡´çš„æ•°æ®è¦†ç›–å’Œè§¦å‘å¤±æ§
            lastPatTime: null,
            ctxTargetMsgId: null,



            // --- è½¬å‘ç›¸å…³ --- 
            tempShareId: null,

            // åŠ è½½æœ‹å‹åœˆæ•°æ®
            loadMoments: () => {
                if (window.MomentsOS) window.MomentsOS.init();
            },

            // æ¸…ç©ºé€‰ä¸­å¥½å‹çš„æœ‹å‹åœˆ
            clearSelectedFriendsMoments: () => {
                const user = AppStorage.get('wechat_user_profile', {});
                // 1. å›æ˜¾åŸºç¡€æ•°æ®
                document.getElementById('moments-bio-input').value = user.bio || '';
                document.getElementById('moments-bg-input').value = user.momentsBg || '';
                document.getElementById('moments-auto-switch').checked = user.momentsAuto || false;
                document.getElementById('moments-auto-interval').value = user.momentsInterval || 60;

                // 2. åŠ¨æ€æ¸²æŸ“å¥½å‹åˆ—è¡¨ (ç”¨äºæ¸…ç†é€‰æ‹©)
                const chars = AppStorage.get('wechat_chars', {});
                const npcs = AppStorage.get('wechat_npcs', {});
                const listDiv = document.getElementById('friends-list-for-clear');

                let html = '';
                // æ¸²æŸ“è§’è‰²
                Object.values(chars).forEach(c => {
                    html += `
                        <label class="flex items-center gap-3 p-2 hover:bg-white rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="clear-friend-checkbox w-4 h-4 rounded text-red-500 focus:ring-red-500" value="${c.id}">
                            <img src="${c.avatar || WeChatUI.getRandomAvatar()}" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                            <span class="text-sm text-gray-700">${c.name}</span>
                        </label>`;
                });
                // æ¸²æŸ“ NPC
                Object.values(npcs).forEach(n => {
                    html += `
                        <label class="flex items-center gap-3 p-2 hover:bg-white rounded cursor-pointer transition-colors">
                            <input type="checkbox" class="clear-friend-checkbox w-4 h-4 rounded text-red-500 focus:ring-red-500" value="${n.id}">
                            <img src="${n.avatar || WeChatUI.getRandomAvatar()}" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                            <span class="text-sm text-gray-700">${n.name} (NPC)</span>
                        </label>`;
                });

                listDiv.innerHTML = html || '<div class="text-gray-400 text-xs text-center py-4">æš‚æ— å¥½å‹æ•°æ®</div>';

                document.getElementById('modal-moments-settings').classList.remove('hidden');
            },

            saveMomentsSettings: () => {
                const user = AppStorage.get('wechat_user_profile', {});
                // ä¿å­˜æ•°æ®
                user.bio = document.getElementById('moments-setting-bio').value;
                user.momentsBg = document.getElementById('moments-settings-bg').src;
                user.momentsAvatar = document.getElementById('moments-settings-avatar').src;
                user.momentsAiPost = document.getElementById('moments-setting-ai-post').checked;
                user.momentsAiInteract = document.getElementById('moments-setting-ai-interact').checked;
                user.momentsLimit = parseInt(document.getElementById('moments-setting-limit').value);

                AppStorage.set('wechat_user_profile', user);

                // ç«‹å³ç”Ÿæ•ˆ
                if (window.MomentsOS) {
                    MomentsOS.render(); // åˆ·æ–°å°é¢
                }

                document.getElementById('modal-moments-settings').classList.add('hidden');
                Utils.showToast('è®¾ç½®å·²ä¿å­˜');
            },

            // æ¸…é™¤èŠå¤©èƒŒæ™¯
            clearChatBg: () => {
                document.getElementById('char-chat-bg').value = '';
                WeChatUI.updateBgPreview();
                Utils.showToast('èŠå¤©èƒŒæ™¯å·²æ¸…é™¤');
            },

            // æ¸…é™¤æœ‹å‹åœˆèƒŒæ™¯
            clearMomentsBg: () => {
                document.getElementById('moments-settings-bg').src = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80';
                Utils.showToast('èƒŒæ™¯å·²é‡ç½®');
            },

            // æ¸…é™¤æœ‹å‹åœˆå¤´åƒ
            clearMomentsAvatar: () => {
                document.getElementById('moments-settings-avatar').src = '';
                Utils.showToast('å¤´åƒå·²æ¸…é™¤');
            },

            // æ¸…ç©ºé€‰ä¸­å¥½å‹çš„æœ‹å‹åœˆ
            clearSelectedFriendsMoments: () => {
                const checkedBoxes = document.querySelectorAll('#friends-list-for-clear input:checked');
                const targetIds = Array.from(checkedBoxes).map(box => box.value);

                if (targetIds.length === 0) {
                    Utils.showToast('è¯·å…ˆé€‰æ‹©è¦æ¸…ç©ºçš„å¥½å‹');
                    return;
                }



                MomentsOS.clearAll(targetIds);
                Utils.showToast(`å·²æ¸…ç©ºé€‰ä¸­${targetIds.length}ä½å¥½å‹çš„æœ‹å‹åœˆ`);
            },

            // --- æ–°å¢åŠŸèƒ½ï¼šè‡ªåŠ¨æœ—è¯»çŠ¶æ€ ---
            isAutoTTS: false,

            handleMomentsBgUpload: (input) => { if (input.files[0]) { Utils.compressImage(input.files[0], 1080, 0.8).then(base64 => { document.getElementById('moments-bg-input').value = base64; }); } },

            // 1. ç‚¹å‡»åˆ†äº«æŒ‰é’®ï¼Œæ‰“å¼€é€‰æ‹©å¼¹çª—
            shareMomentToChat: (momentId) => {
                WeChatUI.tempShareId = momentId;
                const chars = AppStorage.get('wechat_chars', {});
                const list = document.getElementById('share-contact-list');

                list.innerHTML = Object.values(chars).map(c => `
                    <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-transparent hover:border-blue-100 transition-all"
                         onclick="WeChatUI.confirmShare('${c.id}')">
                        <img src="${c.avatar}" class="w-10 h-10 rounded-lg bg-gray-200 object-cover">
                        <span class="text-gray-800 font-medium">${c.name}</span>
                    </div>
                `).join('');

                document.getElementById('modal-share-select').classList.remove('hidden');
            },

            // 2. ç¡®è®¤åˆ†äº«
            confirmShare: (charId) => {
                const mid = WeChatUI.tempShareId;
                const m = window.MomentsOS.data.find(x => x.id == mid);
                if (!m) return;
                // æ„é€ å¡ç‰‡æ•°æ®
                const cardData = {
                    id: m.id,
                    text: m.content || '[å›¾ç‰‡åŠ¨æ€]',
                    image: (m.images && m.images.length) ? m.images[0] : '',
                    author: (m.authorType === 'user') ? 'æˆ‘' : 'å¥½å‹'
                };
                // åˆ‡æ¢åˆ°èŠå¤©å¹¶å‘é€
                document.getElementById('modal-share-select').classList.add('hidden');
                WeChatUI.openChatDetail(charId); // è·³è½¬èŠå¤©
                WeChatUI.pushMessage('moment_card', JSON.stringify(cardData), 'user', 'moment_card');
                Utils.showToast('å·²è½¬å‘');
            },

            // --- B. AI è‡ªåŠ¨å‘æœ‹å‹åœˆ (é€‚é…æ–°æ¶æ„) ---
            generateMoments: async () => {
                // è°ƒç”¨ MomentsOS.generateMultiple ç”Ÿæˆå¤šæ¡åŠ¨æ€å¹¶æ·»åŠ äº’åŠ¨
                if (window.MomentsOS) {
                    await MomentsOS.generateMultiple();
                }
            },

            // å·¥å…·ï¼šç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID 
            generateMsgId: () => {
                return 'msg_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            },

            // ã€ä¿®å¤ã€‘æ›´å¼ºå£®çš„å¼€å…³ï¼šç›´æ¥ä»ç•Œé¢è·å–å½“å‰è§’è‰²IDï¼Œé˜²æ­¢å˜é‡ä¸¢å¤±
            toggleAutoTTS: () => {
                // 1. ä»ç•Œé¢ DOM è·å–å½“å‰ ID (è¿™æ˜¯æœ€å‡†ç¡®çš„)
                const el = document.getElementById('subpage-chat-detail');
                const cid = el ? el.dataset.charId : null;

                if (!cid) return; // å¦‚æœæ²¡æ‰¾åˆ° IDï¼Œå°±ä¸æ‰§è¡Œ

                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid]) return;

                // 2. åˆ‡æ¢çŠ¶æ€ (å¦‚æœåŸæœ¬æ˜¯ undefinedï¼Œå–åå°±æ˜¯ true)
                chars[cid].autoTTS = !chars[cid].autoTTS;
                AppStorage.set('wechat_chars', chars);

                // 3. ç«‹å³åˆ·æ–°å›¾æ ‡
                WeChatUI.updateAutoTTSIcon();

                // 4. å¦‚æœå…³é—­äº†ï¼Œåœæ­¢æ­£åœ¨è¯´çš„è¯
                if (!chars[cid].autoTTS) {
                    window.speechSynthesis.cancel();
                    WeChatUI.ttsQueue = [];
                    WeChatUI.isSpeaking = false;
                }

                Utils.showToast(chars[cid].autoTTS ? 'å·²å¼€å¯å½“å‰è§’è‰²æœ—è¯»' : 'å·²å…³é—­å½“å‰è§’è‰²æœ—è¯»');
            },

            // ã€ä¿®å¤ã€‘æ›´å¼ºå£®çš„å›¾æ ‡æ›´æ–°ï¼šç›´æ¥è¯»å– DOM
            updateAutoTTSIcon: () => {
                const btn = document.getElementById('btn-auto-tts');
                const el = document.getElementById('subpage-chat-detail');
                const cid = el ? el.dataset.charId : null;

                if (!btn || !cid) return;

                const chars = AppStorage.get('wechat_chars', {});
                // é»˜è®¤æ˜¯å…³é—­ (false æˆ– undefined)
                const isEnabled = chars[cid] && chars[cid].autoTTS === true;

                if (isEnabled) {
                    btn.className = "w-8 h-8 rounded-full flex items-center justify-center text-green-500 bg-green-50 border border-green-200 transition-all";
                    btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                } else {
                    btn.className = "w-8 h-8 rounded-full flex items-center justify-center text-gray-400 border border-transparent transition-all";
                    btn.innerHTML = '<i class="fa-solid fa-volume-xmark"></i>';
                }
            },


            // --- TTS æ’é˜Ÿé€»è¾‘ --- 
            addToTTSQueue: (text, char) => {
                // æ£€æŸ¥èŠå¤©é¡µé¢æ˜¯å¦æ¿€æ´»
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                const isChatActive = chatDetailEl && chatDetailEl.classList.contains('active');

                // åªæœ‰åœ¨èŠå¤©é¡µé¢æ¿€æ´»ä¸”è‡ªåŠ¨æœ—è¯»å¼€å¯æ—¶æ‰æ·»åŠ åˆ°é˜Ÿåˆ—
                if (isChatActive) {
                    WeChatUI.ttsQueue.push({ text, char });
                    WeChatUI.processTTSQueue();
                }
            },

            processTTSQueue: () => {
                // æ£€æŸ¥èŠå¤©é¡µé¢æ˜¯å¦æ¿€æ´»
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                const isChatActive = chatDetailEl && chatDetailEl.classList.contains('active');

                // å¦‚æœèŠå¤©é¡µé¢æœªæ¿€æ´»ï¼Œå½»åº•åœæ­¢å¹¶æ¸…ç©º
                if (!isChatActive) {
                    window.speechSynthesis.cancel();
                    if (WeChatUI.currentTTSAudio) {
                        try { WeChatUI.currentTTSAudio.pause(); } catch (e) { }
                        WeChatUI.currentTTSAudio = null;
                    }
                    WeChatUI.isSpeaking = false;
                    WeChatUI.ttsQueue = [];
                    return;
                }

                // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºä¸”æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æœ—è¯»ï¼Œç›´æ¥è¿”å›
                if (WeChatUI.ttsQueue.length === 0 && !WeChatUI.isSpeaking) {
                    return;
                }

                // å¦‚æœå·²ç»åœ¨è¯´è¯ï¼Œç­‰å¾…å½“å‰æœ—è¯»ç»“æŸåå†å¤„ç†
                if (WeChatUI.isSpeaking) {
                    return;
                }

                WeChatUI.isSpeaking = true;
                const top = WeChatUI.ttsQueue.shift();
                if (!top) { WeChatUI.isSpeaking = false; return; }
                const { text, char } = top;

                setTimeout(() => {
                    SettingsLogic.generateTTS(text, char).then(result => {
                        // æµè§ˆå™¨TTSï¼šå·²ç»æ’­æ”¾å®Œæˆï¼Œresultä¸º'browser-tts-done'
                        if (result === 'browser-tts-done') {
                            WeChatUI.isSpeaking = false;
                            setTimeout(() => {
                                WeChatUI.processTTSQueue();
                            }, 300); // ç¨å¾®åœé¡¿0.3ç§’å†è¯»ä¸‹ä¸€å¥ï¼Œæ›´è‡ªç„¶
                        }
                        // API TTSï¼šresultä¸ºéŸ³é¢‘URL
                        else if (result && (result.startsWith('data:audio') || result.startsWith('http'))) {
                            const audio = new Audio(result);
                            WeChatUI.currentTTSAudio = audio; // è®°å½•å½“å‰éŸ³é¢‘å¯¹è±¡
                            audio.onended = () => {
                                WeChatUI.currentTTSAudio = null;
                                WeChatUI.isSpeaking = false;
                                setTimeout(() => {
                                    WeChatUI.processTTSQueue();
                                }, 300); // ç¨å¾®åœé¡¿0.3ç§’å†è¯»ä¸‹ä¸€å¥ï¼Œæ›´è‡ªç„¶
                            };
                            audio.play().catch(error => {
                                console.error('TTSæ’­æ”¾å¤±è´¥:', error);
                                WeChatUI.currentTTSAudio = null;
                                WeChatUI.isSpeaking = false;
                                WeChatUI.processTTSQueue();
                            });
                        }
                        // å¤±è´¥æˆ–è¿”å›null
                        else {
                            WeChatUI.isSpeaking = false;
                            WeChatUI.processTTSQueue();
                        }
                    }).catch(error => {
                        console.error('TTSç”Ÿæˆå¤±è´¥:', error);
                        WeChatUI.isSpeaking = false;
                        WeChatUI.processTTSQueue();
                    });
                }, 500); // å»¶è¿Ÿ0.5ç§’ï¼Œç­‰æ¶ˆæ¯ä¸Šå±åŠ¨ç”»ç»“æŸå†è¯»
            },
            // --- æ–°å¢ç»“æŸ ---

            // è§’è‰²å’Œç”¨æˆ·é»˜è®¤å¤´åƒåˆ—è¡¨ï¼ˆç½‘ç»œURLï¼‰
            defaultAvatars: [
                'https://i.ibb.co/DHHvx1kT/avatar1.png',
                'https://i.ibb.co/ymD1ZfSH/avatar2.png',
                'https://i.ibb.co/pjBHhfJ9/avatar3.png',
                'https://i.ibb.co/HfJyz1XF/avatar4.png',
                'https://i.ibb.co/NnjsXnSB/avatar5.png',
                'https://i.ibb.co/VW8vVq5G/avatar6.png',
                'https://i.ibb.co/TDYT6m7p/avatar7.png',
                'https://i.ibb.co/CKpbd5Gy/avatar8.png',
                'https://i.ibb.co/Z6bQGpfQ/avatar9.png'
            ],
            // éšæœºé€‰æ‹©å¤´åƒ
            getRandomAvatar: () => {
                return WeChatUI.defaultAvatars[Math.floor(Math.random() * WeChatUI.defaultAvatars.length)];
            },
            // æœ‹å‹åœˆé»˜è®¤èƒŒæ™¯å›¾åˆ—è¡¨ï¼ˆç½‘ç»œURLï¼‰
            defaultMomentsBg: [
                'https://i.postimg.cc/sxrNyX3B/zi-mei-gui.png',
                'https://i.postimg.cc/RhBD9FvS/cheng-mei-gui.png',
                'https://i.postimg.cc/Bb0Vs6JX/fen-mei-gui.png',
                'https://i.postimg.cc/ZnSMZRJB/hong-mei-gui.png'
            ],
            // éšæœºé€‰æ‹©æœ‹å‹åœˆèƒŒæ™¯å›¾
            getRandomMomentsBg: () => {
                return WeChatUI.defaultMomentsBg[Math.floor(Math.random() * WeChatUI.defaultMomentsBg.length)];
            },

            currentChatId: null,
            ctxTargetMsg: null,
            isVoiceMode: false,
            isMultiSelect: false,
            lastNotifyTime: 0,
            // TTSæ’é˜Ÿé€»è¾‘
            ttsQueue: [],
            isSpeaking: false,

            // ç”Ÿæˆçº¢åŒ…å’Œè½¬è´¦çš„å”¯ä¸€ç¼–å·
            generatePaymentId: () => {
                // ä½¿ç”¨æ—¶é—´æˆ³å’Œéšæœºæ•°ç”Ÿæˆå”¯ä¸€ç¼–å·
                return 'PAY' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 5).toUpperCase();
            },
            // å…¨å±€ç¼–å·è®¡æ•°å™¨ï¼Œç”¨äºçº¢åŒ…å’Œè½¬è´¦çš„åºå·
            getNextPaymentNumber: () => {
                let counter = parseInt(AppStorage.get('paymentCounter', '0'));
                counter += 1;
                AppStorage.set('paymentCounter', counter.toString());
                return counter;
            },

            switchTab: (id) => {
                document.querySelectorAll('.wechat-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-tab-' + id).classList.add('active');
                ['chat', 'contacts', 'discovery', 'me'].forEach(t => document.getElementById('tab-' + t).classList.add('hidden')); document.getElementById('tab-' + id).classList.remove('hidden');
                document.getElementById('wechat-header-title').textContent = { 'chat': 'å¾®ä¿¡', 'contacts': 'é€šè®¯å½•', 'discovery': 'å‘ç°', 'me': '' }[id];
                if (id === 'chat' || id === 'contacts') WeChatUI.renderList();
                // æ›´æ–°"æˆ‘"ç•Œé¢çš„ç”¨æˆ·ä¿¡æ¯
                if (id === 'me') {
                    const userProfile = AppStorage.get('wechat_user_profile', {});

                    // æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰é€‰ä¸­çš„è§’è‰²ï¼Œå¦‚æœæœ‰ï¼Œå°†è§’è‰²è®¾ç½®ä¸­çš„ç”¨æˆ·ååŒæ­¥åˆ°ç”¨æˆ·èµ„æ–™
                    const chars = AppStorage.get('wechat_chars', {});
                    const currentChatId = WeChatUI.currentChatId;

                    if (currentChatId && chars[currentChatId] && chars[currentChatId].userName) {
                        userProfile.name = chars[currentChatId].userName;
                        AppStorage.set('wechat_user_profile', userProfile);
                    }

                    document.getElementById('user-name').textContent = userProfile.name || 'æˆ‘';

                    // å¦‚æœæ²¡æœ‰å¤´åƒï¼Œä½¿ç”¨éšæœºå¤´åƒ
                    if (!userProfile.avatar) {
                        const randomAvatar = WeChatUI.getRandomAvatar();
                        userProfile.avatar = randomAvatar;
                        AppStorage.set('wechat_user_profile', userProfile);
                        // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…TypeError
                        const userAvatarEl = document.getElementById('user-avatar');
                        if (userAvatarEl) userAvatarEl.src = randomAvatar;
                        // åŒæ­¥åˆ°æœ‹å‹åœˆ
                        const momentsAvatarEl = document.getElementById('moments-avatar');
                        if (momentsAvatarEl) momentsAvatarEl.src = randomAvatar;
                        const userMomentsAvatarEl = document.getElementById('user-moments-avatar');
                        if (userMomentsAvatarEl) userMomentsAvatarEl.src = randomAvatar;
                    } else {
                        // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…TypeError
                        const userAvatarEl = document.getElementById('user-avatar');
                        if (userAvatarEl) userAvatarEl.src = userProfile.avatar;
                        // åŒæ­¥åˆ°æœ‹å‹åœˆ
                        const momentsAvatarEl = document.getElementById('moments-avatar');
                        if (momentsAvatarEl) momentsAvatarEl.src = userProfile.avatar;
                        const userMomentsAvatarEl = document.getElementById('user-moments-avatar');
                        if (userMomentsAvatarEl) userMomentsAvatarEl.src = userProfile.avatar;
                    }
                }
            },
            openAddMenu: () => document.getElementById('wechat-add-menu').classList.toggle('hidden'),

            startCreateChar: () => {
                document.getElementById('wechat-add-menu').classList.add('hidden');
                document.getElementById('new-char-name-input').value = '';
                document.getElementById('modal-create-name').classList.remove('hidden');
            },
            confirmCreateName: () => {
                const name = document.getElementById('new-char-name-input').value.trim();
                if (!name) return alert('è¯·è¾“å…¥åå­—');
                document.getElementById('modal-create-name').classList.add('hidden');
                WeChatUI.currentChatId = 'char_' + Date.now();
                const chars = AppStorage.get('wechat_chars', {});
                chars[WeChatUI.currentChatId] = { id: WeChatUI.currentChatId, name: name, avatar: WeChatUI.getRandomAvatar(), msgs: [], emojis: [], unread: 0 };
                AppStorage.set('wechat_chars', chars);
                WeChatUI.openCharSettings(true);
            },

            // --- è‡ªåŠ¨åŒ–ï¼šAI ä¸»åŠ¨æŸ¥å²—ç³»ç»Ÿ --- 
            activeChatTimer: null,

            // å¯åŠ¨å¿ƒè·³æ£€æµ‹ (æŒä¹…åŒ–å¢å¼ºç‰ˆï¼šé˜²åˆ·æ–°å¤±æ•ˆ)
            startActiveChatCheck: () => {
                if (WeChatUI.activeChatTimer) clearInterval(WeChatUI.activeChatTimer);

                // æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
                WeChatUI.activeChatTimer = setInterval(() => {
                    const now = Date.now();
                    const chars = AppStorage.get('wechat_chars', {});

                    // 1. è·å–å½“å‰å±å¹•ä¸Šæ­£åœ¨èŠçš„"æ­£å®«"æ˜¯è°
                    const chatPage = document.getElementById('subpage-chat-detail');
                    const isChatOpen = chatPage && chatPage.classList.contains('active');
                    const currentOpenCharId = isChatOpen ? chatPage.dataset.charId : null;

                    Object.values(chars).forEach(char => {
                        // å¼€å…³æ£€æŸ¥
                        if (!char.activeChat) return;

                        // å¦‚æœå½“å‰æ­£åœ¨èŠå¤©ç•Œé¢ï¼Œä¸è§¦å‘æŸ¥å²—ï¼Œä½†éœ€è¦æ›´æ–°â€œæœ€ååœ¨çº¿æ—¶é—´â€ (å¿ƒè·³æœºåˆ¶)
                        if (char.id === currentOpenCharId) {
                            // ã€æ ¸å¿ƒä¿®å¤ã€‘æŒç»­æ›´æ–°ç¦»å¼€æ—¶é—´ä¸ºå½“å‰æ—¶é—´
                            // è¿™æ ·ä¸€æ—¦ç”¨æˆ·å…³é—­æµè§ˆå™¨/åˆ·æ–°ï¼ŒlastLeaveTime å°±æ˜¯æ­¤æ—¶åˆ»ï¼Œ
                            // ä¸‹æ¬¡æ‰“å¼€æ—¶ï¼ˆæˆ–åå°è®¡æ—¶ï¼‰å°±èƒ½æ­£ç¡®è®¡ç®—å‡ºâ€œå·²ç»ç¦»å¼€å¤šä¹…äº†â€ã€‚
                            const latestChars = AppStorage.get('wechat_chars', {});
                            if (latestChars[char.id]) {
                                latestChars[char.id].lastLeaveTime = now;
                                AppStorage.set('wechat_chars', latestChars);
                            }
                            return;
                        }

                        // --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨ lastLeaveTime ä½œä¸ºè®¡æ—¶èµ·ç‚¹ ---
                        const lastLeaveTime = char.lastLeaveTime || 0;

                        // å¦‚æœæ²¡æœ‰ç¦»å¼€æ—¶é—´è®°å½•ï¼Œè·³è¿‡ï¼ˆè¯´æ˜ç”¨æˆ·ä»æœªæ‰“å¼€è¿‡è¿™ä¸ªèŠå¤©ï¼‰
                        if (!lastLeaveTime) return;

                        // è®¡ç®—ä»ç¦»å¼€ç•Œé¢åˆ°ç°åœ¨çš„æ—¶é—´
                        const timeSinceLeave = now - lastLeaveTime;
                        const settingInterval = (parseInt(char.activeInterval) || 30) * 60 * 1000;

                        // è§¦å‘åˆ¤æ–­ï¼šç¦»å¼€æ—¶é—´ >= è®¾å®šæ—¶é—´ï¼Œä¸”æ²¡æœ‰æœªè¯»æ¶ˆæ¯
                        if (timeSinceLeave >= settingInterval && (!char.unread || char.unread === 0)) {

                            // è®¡ç®—ä»æœ€åä¸€æ¡æ¶ˆæ¯ç®—èµ·çš„å®é™…æ²‰é»˜æ—¶é•¿ï¼ˆè¿™æ˜¯AIæ„ŸçŸ¥çš„æ—¶é—´ï¼‰
                            let lastMsgTime = now;
                            if (char.msgs && char.msgs.length > 0) {
                                const validMsgs = char.msgs.filter(msg => msg.type !== 'system' && msg.type !== 'error');
                                if (validMsgs.length > 0) {
                                    const lastMsg = validMsgs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))[0];
                                    lastMsgTime = lastMsg.timestamp || now;
                                }
                            }
                            const silentTime = now - lastMsgTime; // AIæ„ŸçŸ¥çš„æ²‰é»˜æ—¶é•¿

                            console.log(`[æŸ¥å²—è§¦å‘] ${char.name}: ç¦»å¼€ç•Œé¢${(timeSinceLeave / 60000).toFixed(1)}åˆ†é’Ÿï¼Œå®é™…æ²‰é»˜${(silentTime / 60000).toFixed(1)}åˆ†é’Ÿ`);

                            // è§¦å‘æ¶ˆæ¯ï¼Œä¼ å…¥å®é™…æ²‰é»˜æ—¶é•¿ï¼ˆè®©AIçŸ¥é“ç”¨æˆ·æ²‰é»˜äº†å¤šä¹…ï¼‰
                            WeChatUI.triggerActiveMessage(char, silentTime, true);
                        }
                    });
                }, 10000); // 10ç§’è½®è¯¢ä¸€æ¬¡
            },

            // è§¦å‘ä¸»åŠ¨æ¶ˆæ¯
            // ã€é‡å†™ç‰ˆã€‘ä½¿ç”¨å®Œæ•´è§’è‰²äººè®¾ï¼Œè‡ªç„¶å»¶ç»­è¯é¢˜
            // ä¿®å¤ï¼šä½¿ç”¨ APIQueue æ’é˜Ÿï¼Œå®Œå–„åˆ†å¥å’Œå†…å®¹å¤„ç†é€»è¾‘
            // ã€âš ï¸é«˜å±æ ¸å¿ƒåŒºåŸŸã€‘ä¸»åŠ¨æ¶ˆæ¯è§¦å‘å™¨ - ä¿®æ”¹éœ€æ…é‡ï¼
            // æ­¤å‡½æ•°åŒ…å«å¤æ‚çš„é€»è¾‘ï¼š
            // 1. APIæ’é˜Ÿ (window.APIQueue.add) - å¿…é¡»ä¿ç•™æ’é˜Ÿæœºåˆ¶ã€‚
            // 2. å¼ºåˆ¶åˆ†å¥ (replaceç‰¹æ®Šçš„è¯­éŸ³/å›¾ç‰‡æ ‡ç­¾) - å¿…é¡»åœ¨ split ä¹‹å‰å¤„ç†ã€‚
            // 3. è¿™é‡Œçš„ Prompt å¿…é¡»ä¸ SettingsLogic.generateLLM ä¸­çš„ System Prompt ä¿æŒä¸€è‡´ï¼ˆæˆ–æ›´å¼ºï¼‰ã€‚
            // ä¿®æ”¹å‰è¯·å…ˆå¤‡ä»½ï¼Œæˆ–è¯¢é—®ç”¨æˆ·ã€‚
            triggerActiveMessage: async (char, silentTime, isHidden) => {
                const now = Date.now();
                const lastTrigger = char.lastActiveTrigger || 0;
                if (now - lastTrigger < 60000) return; // åŠ é”ï¼šè‡³å°‘é—´éš”1åˆ†é’Ÿ 

                // è®¡ç®—æ²‰é»˜åˆ†é’Ÿæ•°
                const silentMinutes = Math.floor(silentTime / 60000);

                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ï¼ˆç”¨äºæç¤ºAIï¼‰
                const allMsgs = (char.msgs || []).filter(m => m.type !== 'system' && m.type !== 'error');
                const lastMsg = allMsgs[allMsgs.length - 1];
                const lastMsgRole = lastMsg ? (lastMsg.role === 'user' ? 'ç”¨æˆ·' : char.name) : '';
                const lastMsgContent = lastMsg ? (lastMsg.type === 'text' ? lastMsg.content : '[å›¾ç‰‡/è¯­éŸ³]') : '';

                // æ›´æ–°æ—¶é—´ï¼Œé˜²æ­¢é‡å¤è§¦å‘ 
                const chars = AppStorage.get('wechat_chars', {});
                if (chars[char.id]) {
                    chars[char.id].lastActiveTrigger = Date.now();
                    // é‡ç½®ç¦»å¼€æ—¶é—´ï¼Œé¿å…é‡å¤è§¦å‘
                    chars[char.id].lastLeaveTime = Date.now();
                    AppStorage.set('wechat_chars', chars);
                }

                try {
                    // ã€æ ¸å¿ƒæ”¹åŠ¨ã€‘æ„å»ºâ€œæ²‰é»˜æç¤ºâ€æ¶ˆæ¯
                    // å¼ºåˆ¶è¦æ±‚ä½¿ç”¨ ### åˆ†å¥ï¼Œå¹¶æ˜ç¡®å¯ä»¥ä½¿ç”¨è¡¨æƒ…åŒ…
                    const silentHint = `[System Hint: User has been silent for ${silentMinutes} mins. Last message from ${lastMsgRole}: "${lastMsgContent}". 
Please initiate a conversation naturally based on context and persona to get user's attention.
IMPORTANT: 
1. Separate your sentences with "###". 
2. Use [è¡¨æƒ…åŒ…: Name] for emojis. 
3. Use [INNER_VOICE]...[/INNER_VOICE] for thoughts.
4. Output specific chat content, do NOT only output Inner Voice.
5. Keep it casual and engaging.
6. userå·²ç»${silentMinutes}åˆ†é’Ÿæ²¡æœ‰ç†ä½ äº†ï¼Œä¸»åŠ¨èŠç‚¹è¯é¢˜å¼•èµ·æ³¨æ„åŠ›å§~]`;

                    // æ„å»ºä¸æ­£å¸¸èŠå¤©ç›¸åŒçš„æ¶ˆæ¯æ ¼å¼
                    // æ„å»ºä¸æ­£å¸¸èŠå¤©ç›¸åŒçš„æ¶ˆæ¯æ ¼å¼
                    // ã€å…³é”®ä¿®å¤ã€‘åˆå¹¶ System Promptï¼Œé¿å…å¤šæ¡ System æ¶ˆæ¯å¯¼è‡´æŸäº›æ¨¡å‹(å¦‚ Gemini)è§£æå¤±è´¥æˆ–å¿½ç•¥
                    let combinedPrompt = (char.prompt || 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„æœ‹å‹ã€‚') + "\n\n" + silentHint;

                    // ã€æ ¸å¿ƒè¡¥å……ã€‘æ·»åŠ ä¸Šä¸€æ¬¡ Inner Voice ä¸Šä¸‹æ–‡
                    // SettingsLogic é‡Œçš„ generateLLM è™½ç„¶ä¼šæ‹¼è£… innerVoiceInstructionï¼Œä½†å®ƒå–çš„æ˜¯å®æ—¶æ•°æ®
                    // ä¸»åŠ¨æ¶ˆæ¯æ˜¯åœ¨åå°è§¦å‘çš„ï¼Œä¸ºäº†ä¿é™©èµ·è§ï¼Œæ˜¾å¼å¸¦ä¸Šæœ€æ–°çš„ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…ä¾èµ– SettingsLogic è‡ªå·±çš„æ‹¼æ¥é€»è¾‘ï¼Ÿ
                    // ä»”ç»†æŸ¥çœ‹ SettingsLogic.generateLLMï¼Œå®ƒä¼š *ä¿®æ”¹* ä¼ å…¥çš„ system message çš„ contentã€‚
                    // ä½†æ˜¯ï¼å®ƒåªæœ‰åœ¨ messages[0].role === 'system' æ—¶æ‰ä¼šè¿›è¡Œå…¨é‡æ‹¼æ¥ (coreProtocol + interactionInstruction + innerVoiceInstruction + charPersona...)
                    // è¿™é‡Œæˆ‘ä»¬ä¼ å…¥äº† { role: 'system', content: combinedPrompt }ï¼Œæ‰€ä»¥ generateLLM ä¼šæŠŠå®ƒå½“åš base personaã€‚
                    // é—®é¢˜åœ¨äºï¼šgenerateLLM ä¼šè‡ªåŠ¨åŠ ä¸Š Inner Voice æŒ‡ä»¤ï¼
                    // 
                    // ç­‰ç­‰ï¼Œç”¨æˆ·æŠ¥é”™è¯´â€œæ²¡æœ‰è¿™ä¸€å¥ [æ­¤å¤„ä¸ºä¸Šä¸€æ¬¡INNER_VOICE]â€
                    // è®©æˆ‘ä»¬çœ‹çœ‹ generateLLM çš„é€»è¾‘ï¼š
                    // const latestInnerVoice = ... JSON.stringify(...)
                    // const innerVoiceInstruction = `[INNER_VOICE]\n${latestInnerVoice}\n[/INNER_VOICE]...`
                    // 
                    // å¦‚æœ generateLLM æ­£å¸¸å·¥ä½œï¼Œåº”è¯¥ä¼šåŒ…å« innerVoiceInstructionã€‚
                    // å”¯ä¸€çš„å¯èƒ½æ˜¯ï¼šchar æ­¤æ—¶å–ä¸åˆ° innerVoicesï¼Ÿæˆ–è€… SettingsLogic é‡Œå–çš„ char ä¸æ˜¯æœ€æ–°çš„ï¼Ÿ
                    // SettingsLogic.generateLLM ç¬¬äºŒä¸ªå‚æ•°ä¼ äº† char.idï¼Œå®ƒå†…éƒ¨ä¼šé‡æ–° AppStorage.get('wechat_chars')
                    // 
                    // å°è¯•æ–¹æ¡ˆï¼šæ‰‹åŠ¨è·å–å¹¶è¿½åŠ åˆ° silentHint é‡Œï¼Œä½œä¸º immediate contextã€‚
                    const latestVoiceObj = (char.innerVoices && char.innerVoices.length > 0) ? char.innerVoices[char.innerVoices.length - 1] : null;
                    if (latestVoiceObj) {
                        combinedPrompt += `\n\n[Context: Previous Inner Voice]\n${JSON.stringify(latestVoiceObj)}`;
                    }

                    const systemMessages = [{
                        role: 'system',
                        content: combinedPrompt
                    }];

                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ APIQueue è¿›è¡Œæ’é˜Ÿï¼Œé˜²æ­¢å¹¶å‘å†²çª
                    const reply = await window.APIQueue.enqueue(() => SettingsLogic.generateLLM([
                        ...systemMessages
                    ], char.id, 'active'));

                    // å¤„ç†å›å¤
                    if (reply && reply.trim()) {
                        let processedReply = reply.trim();
                        const cid = char.id;

                        // ===========================
                        // 1. å¿ƒå£°æå–ä¸æ¸…æ´— (é‡æ„ç‰ˆï¼šä½¿ç”¨ç»Ÿä¸€è§£æå™¨)
                        // ===========================
                        // é¢„å®šä¹‰ cleanReply ä»¥ä¾¿åç»­ä½¿ç”¨
                        let cleanReply = processedReply;
                        let hasVoice = false;

                        // æå– Inner Voice æ ‡ç­¾å†…å®¹
                        const innerVoiceMatch = cleanReply.match(/\[INNER_VOICE\]([\s\S]*?)\[\/INNER_VOICE\]/i);

                        if (innerVoiceMatch) {
                            const rawContent = innerVoiceMatch[1];

                            // ä½¿ç”¨ InnerVoiceUI.parseVoiceData è§£æ
                            if (window.InnerVoiceUI && window.InnerVoiceUI.parseVoiceData) {
                                const voiceData = InnerVoiceUI.parseVoiceData(rawContent);

                                if (voiceData) {
                                    // å­˜å…¥ç³»ç»Ÿ (ä¼ å…¥ char.id ä»¥æ”¯æŒåå°ä¿å­˜)
                                    InnerVoiceUI.addVoice(voiceData, char.id);
                                    console.log("å¿ƒå£°æå–æˆåŠŸ:", voiceData);
                                    hasVoice = true;
                                }
                            }

                            // å½»åº•åˆ é™¤å¿ƒå£°æ ‡ç­¾å—ï¼Œé˜²æ­¢æ˜¾ç¤ºåœ¨æ°”æ³¡é‡Œ
                            cleanReply = cleanReply.replace(/\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]/gi, '').trim();
                        }

                        // ã€CRITICAL FIXã€‘å°†å¤„ç†åçš„ cleanReply èµ‹å€¼ç»™ processedReply
                        // ä¹‹å‰è¿™é‡Œæ¼äº†èµ‹å€¼ï¼Œå¯¼è‡´ stripped çš„ Inner Voice ä»ç„¶è¢«ä¿ç•™åœ¨ processedReply ä¸­ï¼Œå¯¼è‡´ä¹±ç æ˜¾ç¤º
                        processedReply = cleanReply;

                        // 2. æ¸…ç†å¤šä½™æ ‡ç­¾
                        processedReply = processedReply.replace(/^["']|["']$/g, '');
                        processedReply = processedReply.replace(/^(ä»–|å¥¹|æˆ‘)è¯´[:ï¼š]/, '');
                        processedReply = processedReply.replace(/^\[System Hint.*?\]/i, '');

                        // 3. æ™ºèƒ½åˆ†å¥ (å¢å¼ºç‰ˆ)
                        // ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶åœ¨ç‰¹æ®Šæ ‡ç­¾å‰åæ’å…¥åˆ†å¥ç¬¦
                        // 3. æ™ºèƒ½åˆ†å¥ (åŒæ­¥ sendUserMessage çš„é«˜çº§é€»è¾‘)

                        // æ­¥éª¤ A: ä¿æŠ¤ HTML å—
                        const protectedHtmlBlocks = [];
                        processedReply = processedReply.replace(/(\[HTML\][\s\S]*?\[\/HTML\])/gi, (match) => {
                            protectedHtmlBlocks.push(match);
                            return `###__PROTECTED_HTML_${protectedHtmlBlocks.length - 1}__###`;
                        });

                        // æ­¥éª¤ B: å›¾åƒ/è¯­éŸ³æ ‡ç­¾å‰åå¼ºåˆ¶åˆ†å¥ (æ”¯æŒå¤šè¡Œ)
                        processedReply = processedReply.replace(/(\[(?:è¯­éŸ³|voice|å›¾ç‰‡|image|è¡¨æƒ…åŒ…|emoji|çº¢åŒ…|è½¬è´¦)\s*[:ï¼š]\s*[\s\S]*?\])/gi, '###$1###');

                        // æ­¥éª¤ C: åˆæ­¥åˆ‡åˆ†
                        let segments = processedReply.split(/###\\?/);

                        // æ­¥éª¤ D: è¿›ä¸€æ­¥å¤„ç†æ¯ä¸ªç‰‡æ®µ (æ™ºèƒ½åˆ†å¥ + è¿˜åŸ HTML)
                        const finalSegments = [];
                        segments.forEach(seg => {
                            seg = seg.trim();
                            if (!seg) return;

                            // è¿˜åŸ HTML
                            const htmlMatch = seg.match(/^__PROTECTED_HTML_(\d+)__$/);
                            if (htmlMatch) {
                                const original = protectedHtmlBlocks[parseInt(htmlMatch[1])];
                                if (original) finalSegments.push(original);
                                return;
                            }

                            // æ£€æŸ¥ç‰¹æ®ŠæŒ‡ä»¤ (ä¿æŒå®Œæ•´) - å°†è¡¨æƒ…åŒ…å’Œå›¾ç‰‡åˆ†å¼€è¯†åˆ«ï¼Œç¡®ä¿æ‹†åˆ†å‡†ç¡®
                            const isEmoji = /^\[(?:è¡¨æƒ…åŒ…|emoji|è¡¨æƒ…)/i.test(seg);
                            const isImage = /^\[(?:å›¾ç‰‡|image)/i.test(seg);
                            const isOtherSpecial = /^\[(?:è¯­éŸ³|voice|çº¢åŒ…|è½¬è´¦)/i.test(seg);

                            if (isEmoji || isImage || isOtherSpecial) {
                                finalSegments.push(seg);
                                return;
                            }

                            // æ™®é€šæ–‡æœ¬ï¼šä½¿ç”¨æ™ºèƒ½åˆ†å¥ (splitMessageSentences)
                            if (WeChatUI.splitMessageSentences) {
                                const subs = WeChatUI.splitMessageSentences(seg);
                                subs.forEach(s => { if (s.trim()) finalSegments.push(s.trim()); });
                            } else {
                                // Fallback
                                finalSegments.push(seg);
                            }
                        });

                        segments = finalSegments;

                        // 4. é€æ¡å‘é€
                        segments = segments.filter(s => s.trim());

                        segments.forEach((seg, idx) => {
                            seg = seg.trim();
                            console.log(`[DEBUG_CHAT] Processing segment ${idx}: content=${seg}`); // DEBUG LOG
                            if (!seg) return;

                            setTimeout(() => {
                                // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šæ ¼å¼
                                let type = 'text';
                                let content = seg;
                                let emojiName = null;

                                // æ£€æŸ¥å›¾ç‰‡/è¡¨æƒ…åŒ…
                                if (seg.match(/^\[(å›¾ç‰‡|image)[:ï¼š]\s*(https?:\/\/.*?)\]$/i)) {
                                    type = 'image';
                                    content = seg.replace(/^\[(å›¾ç‰‡|image)[:ï¼š]\s*(.*?)\]$/i, '$2');
                                } else if (seg.match(/^\[è¡¨æƒ…åŒ…[:ï¼š]\s*(.*?)\]$/i)) {
                                    type = 'image';
                                    emojiName = seg.match(/^\[è¡¨æƒ…åŒ…[:ï¼š]\s*(.*?)\]$/i)[1];
                                    // è¿™é‡Œ content éœ€è¦æ˜¯ URLï¼Œéœ€è¦æŸ¥æ‰¾ URL
                                    // ä¸ºç®€åŒ–ï¼Œäº¤ç»™ pushMessage å¤„ç† emojiName
                                    const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                                    const charEmojis = c ? (c.emojis || []) : [];
                                    const allEmojis = [...globalEmojis, ...charEmojis];
                                    const targetEmoji = allEmojis.find(e => e.name === emojiName);
                                    if (targetEmoji) {
                                        content = targetEmoji.url;
                                    } else {
                                        // æ‰¾ä¸åˆ°è¡¨æƒ…åŒ…ï¼Œå›é€€ä¸ºæ–‡æœ¬
                                        type = 'text';
                                        content = `[è¡¨æƒ…åŒ…: ${emojiName}]`;
                                        emojiName = null;
                                    }
                                    // ã€æ–°ã€‘æ£€æŸ¥è¯­éŸ³
                                } else if (seg.match(/^\[(?:è¯­éŸ³|voice)[:ï¼š]\s*(.*?)\]$/i)) {
                                    type = 'voice';
                                    content = seg.match(/^\[(?:è¯­éŸ³|voice)[:ï¼š]\s*(.*?)\]$/i)[1].replace(/^["â€œâ€]/, '').replace(/["â€œâ€]$/, '');
                                } else if (seg.includes('<style') || seg.includes('<div') || seg.includes('<span') || seg.includes('[HTML]')) {
                                    // ã€æ–°ã€‘HTML æ°”æ³¡è¯†åˆ«
                                    type = 'html';
                                }

                                WeChatUI.pushMessage(type, content, 'ai', type === 'voice' ? 'voice' : 'text', emojiName, char.id);
                            }, idx * 1500); // é—´éš” 1.5ç§’å‘ä¸€æ¡ï¼Œæ›´è‡ªç„¶
                        });

                        // 5. æµè§ˆå™¨é€šçŸ¥ (åªæ˜¾ç¤ºç¬¬ä¸€å¥)
                        const firstSeg = segments.length > 0 ? segments[0] : processedReply;
                        if (isHidden && Notification.permission === "granted") {
                            const notif = new Notification(char.name, { body: firstSeg, icon: char.avatar });
                            notif.onclick = () => {
                                window.focus();
                                document.getElementById('global-notification-modal').style.display = 'none';
                                WeChatUI.openChatDetail(char.id);
                            };
                        }

                        Utils.showToast(`${char.name}: ${firstSeg.substring(0, 10)}...`);
                        console.log(`[æŸ¥å²—/ä¸»åŠ¨æ¶ˆæ¯] ${char.name} å‘é€äº† ${segments.length} æ¡æ¶ˆæ¯`);
                    }
                } catch (e) {
                    console.error('ä¸»åŠ¨æ¶ˆæ¯/æŸ¥å²—å¤±è´¥', e);
                    // é™çº§å¤„ç†ï¼šä½¿ç”¨é»˜è®¤æ¶ˆæ¯
                    /* const defaults = ["äººå‘¢ï¼Ÿ", "å»å“ªäº†ï¼Ÿ", "æ€ä¹ˆä¸ç†æˆ‘...", "æ­ªï¼Ÿ", "åœ¨å¿™å—ï¼Ÿ"];
                     const fallback = defaults[Math.floor(Math.random() * defaults.length)];
                     WeChatUI.pushMessage('text', fallback, 'ai', 'text', null, char.id);*/
                }
            },

            // ã€ä¸»åŠ¨å‘æ¶ˆæ¯ã€‘è®¡æ—¶å™¨å˜é‡
            proactiveChatTimer: null,
            lastProactiveTrigger: 0,

            // ã€ä¸»åŠ¨å‘æ¶ˆæ¯ã€‘å¯åŠ¨è®¡æ—¶å™¨ - ç”¨æˆ·åœ¨èŠå¤©ç•Œé¢æ—¶AIä¸»åŠ¨å‘æ¶ˆæ¯
            startProactiveChatTimer: (charId) => {
                // æ¸…é™¤æ—§è®¡æ—¶å™¨
                if (WeChatUI.proactiveChatTimer) {
                    clearInterval(WeChatUI.proactiveChatTimer);
                }

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char || !char.proactiveChat) {
                    console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] ${char?.name || charId} æœªå¼€å¯ä¸»åŠ¨å‘æ¶ˆæ¯åŠŸèƒ½`);
                    return;
                }

                const intervalMs = (char.proactiveInterval || 60) * 1000; // é»˜è®¤60ç§’
                console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] å¯åŠ¨è®¡æ—¶å™¨ï¼Œè§’è‰²: ${char.name}ï¼Œé—´éš”: ${char.proactiveInterval || 60}ç§’`);

                WeChatUI.proactiveChatTimer = setInterval(() => {
                    // æ£€æŸ¥èŠå¤©ç•Œé¢æ˜¯å¦ä»ç„¶æ‰“å¼€
                    const chatPage = document.getElementById('subpage-chat-detail');
                    const isChatOpen = chatPage && chatPage.classList.contains('active');
                    const currentCharId = chatPage ? chatPage.dataset.charId : null;

                    if (!isChatOpen || currentCharId !== charId) {
                        console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] èŠå¤©ç•Œé¢å·²å…³é—­æˆ–åˆ‡æ¢ï¼Œåœæ­¢è®¡æ—¶å™¨`);
                        clearInterval(WeChatUI.proactiveChatTimer);
                        WeChatUI.proactiveChatTimer = null;
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç”Ÿæˆå›å¤ï¼ˆé¿å…å†²çªï¼‰
                    if (WeChatUI.isGenerating) {
                        console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] AIæ­£åœ¨ç”Ÿæˆå›å¤ï¼Œè·³è¿‡æœ¬æ¬¡è§¦å‘`);
                        return;
                    }

                    // è§¦å‘ä¸»åŠ¨æ¶ˆæ¯
                    WeChatUI.triggerProactiveMessage(charId);
                }, intervalMs);
            },

            // ã€ä¸»åŠ¨å‘æ¶ˆæ¯ã€‘è§¦å‘ä¸»åŠ¨æ¶ˆæ¯ - è®©AIåƒæœ‹å‹ä¸€æ ·åˆ†äº«æ—¥å¸¸æˆ–å»¶ç»­è¯é¢˜
            triggerProactiveMessage: async (charId) => {
                const now = Date.now();
                // é˜²æ­¢é¢‘ç¹è§¦å‘ï¼ˆè‡³å°‘é—´éš”30ç§’ï¼‰
                if (now - WeChatUI.lastProactiveTrigger < 30000) {
                    console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] è·ç¦»ä¸Šæ¬¡è§¦å‘ä¸è¶³30ç§’ï¼Œè·³è¿‡`);
                    return;
                }
                WeChatUI.lastProactiveTrigger = now;

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return;

                console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] ${char.name} æ­£åœ¨ç”Ÿæˆä¸»åŠ¨æ¶ˆæ¯...`);

                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
                const allMsgs = (char.msgs || []).filter(m => m.type !== 'system' && m.type !== 'error');
                const lastMsg = allMsgs[allMsgs.length - 1];
                const lastMsgContent = lastMsg ? lastMsg.content : 'ï¼ˆæ— æ¶ˆæ¯ï¼‰';
                const lastMsgRole = lastMsg ? (lastMsg.role === 'user' ? 'ç”¨æˆ·' : 'ä½ ') : '';

                // è®¡ç®—ä»æœ€åä¸€æ¡æ¶ˆæ¯åˆ°ç°åœ¨çš„æ—¶é—´
                const lastMsgTime = lastMsg ? lastMsg.timestamp : now;
                const silentSeconds = Math.floor((now - lastMsgTime) / 1000);

                // æ„å»ºæç¤ºï¼Œè®©AIè‡ªç„¶åœ°å‘èµ·è¯é¢˜
                const proactiveHint = `ã€ç³»ç»Ÿæç¤ºÂ·ä¸»åŠ¨å‘æ¶ˆæ¯ã€‘
å½“å‰è·ç¦»ä¸Šä¸€æ¡æ¶ˆæ¯å·²è¿‡å»${silentSeconds}ç§’ã€‚${lastMsgRole ? `æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯${lastMsgRole}è¯´çš„ï¼š"${lastMsgContent.substring(0, 50)}${lastMsgContent.length > 50 ? '...' : ''}"` : ''}
è¯·ä½ ä½œä¸º${char.name}ï¼Œ**ä¸»åŠ¨å‘èµ·ä¸€æ¡æ¶ˆæ¯**ã€‚å¯ä»¥æ˜¯ï¼š
- åˆ†äº«ä½ æ­£åœ¨åšçš„äº‹ã€çœ‹åˆ°çš„ä¸œè¥¿ã€æƒ³åˆ°çš„äº‹æƒ…
- çªç„¶æƒ³èµ·ä»€ä¹ˆæƒ³å‘Šè¯‰å¯¹æ–¹
- çœ‹åˆ°ä»€ä¹ˆæœ‰è¶£çš„ä¸œè¥¿æƒ³åˆ†äº«
- æƒ³åˆ°åˆšæ‰çš„è¯é¢˜æœ‰ä»€ä¹ˆæƒ³è¡¥å……çš„
- æˆ–è€…åªæ˜¯å•çº¯æƒ³å’Œå¯¹æ–¹è¯´è¯´è¯
ä¿æŒä½ çš„äººè®¾æ€§æ ¼ï¼Œè‡ªç„¶éšæ„ï¼Œå°±åƒæœ‹å‹ä¹‹é—´å‘æ¶ˆæ¯ä¸€æ ·ã€‚ä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„å†…å®¹ã€‚å›å¤ç”¨###åˆ†éš”è‡ªç„¶åœé¡¿å¤„ã€‚`;

                try {
                    // æ„å»ºæ¶ˆæ¯å†å²
                    const apiMsgs = [];
                    const recentMsgs = allMsgs.slice(-10); // å–æœ€è¿‘10æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡

                    recentMsgs.forEach(m => {
                        if (m.role === 'user') {
                            apiMsgs.push({ role: 'user', content: m.content });
                        } else if (m.role === 'ai') {
                            apiMsgs.push({ role: 'assistant', content: m.content });
                        }
                    });

                    // æ·»åŠ ä¸»åŠ¨å‘æ¶ˆæ¯æç¤º
                    apiMsgs.push({ role: 'system', content: proactiveHint });

                    // è°ƒç”¨å®Œæ•´çš„AIç”Ÿæˆ
                    const reply = await SettingsLogic.generateLLM(apiMsgs, charId, 'proactive');

                    if (reply && reply.trim()) {
                        let processedReply = reply.trim();

                        // æ¸…æ´—å›å¤
                        processedReply = processedReply.replace(/^["']|["']$/g, '');
                        processedReply = processedReply.replace(/^(ä»–|å¥¹|æˆ‘)è¯´[:ï¼š]/, '');
                        processedReply = processedReply.replace(/^\[.*?\][:ï¼š]?\s*/, '');

                        // ç¡®ä¿ä½¿ç”¨###åˆ†å¥
                        if (!processedReply.includes('###')) {
                            processedReply = processedReply
                                .replace(/([ã€‚ï¼ï¼Ÿï¼›ï¼š])/g, '$1###')
                                .trim();
                        }

                        // æŒ‰###åˆ†å‰²ååˆ†åˆ«å‘é€æ¶ˆæ¯
                        const segments = processedReply.split('###').filter(seg => seg.trim());
                        segments.forEach((seg, idx) => {
                            setTimeout(() => {
                                WeChatUI.pushMessage('text', seg.trim(), 'ai', 'text', null, charId);
                            }, idx * 100);
                        });

                        console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯å®Œæˆ] ${char.name} å‘é€äº†ä¸»åŠ¨æ¶ˆæ¯`);
                    }
                } catch (e) {
                    console.error('[ä¸»åŠ¨å‘æ¶ˆæ¯å¤±è´¥]', e);
                }
            },

            // Initialize default test user if empty
            checkInit: () => {
                const chars = AppStorage.get('wechat_chars', {});

                // Update avatar for all existing characters
                Object.values(chars).forEach(char => {
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘åªåœ¨å¤´åƒä¸å­˜åœ¨ï¼Œæˆ–è€…æ˜¯æ—§ç‰ˆDiceBearé“¾æ¥æ—¶æ‰é‡ç½®
                    // åˆ é™¤äº† char.avatar.includes('data:image') çš„åˆ¤æ–­ï¼Œé˜²æ­¢é‡ç½®ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
                    if (!char.avatar || char.avatar.includes('api.dicebear.com')) {
                        char.avatar = WeChatUI.getRandomAvatar();
                    }
                });

                // Add default test character if empty
                if (Object.keys(chars).length === 0) {
                    const id = 'char_test_001';
                    chars[id] = {
                        id: id, name: 'æµ‹è¯•é…±', avatar: WeChatUI.getRandomAvatar(),
                        msgs: [],
                        openingLine: '',
                        emojis: [], unread: 0, prompt: 'ä½ æ˜¯ä¸€ä¸ªæ´»æ³¼å¯çˆ±çš„æµ‹è¯•åŠ©æ‰‹ã€‚'
                    };
                }

                AppStorage.set('wechat_chars', chars);

                // Initialize NPCs storage if empty
                const npcs = AppStorage.get('wechat_npcs', {});
                if (Object.keys(npcs).length === 0) {
                    AppStorage.set('wechat_npcs', {});
                }

                // Initialize moments storage if empty
                const moments = AppStorage.get('wechat_moments', []);
                if (moments.length === 0) {
                    AppStorage.set('wechat_moments', []);
                }

                // Initialize user profile if empty
                const userProfile = AppStorage.get('wechat_user_profile', {});

                // Update user avatar if not set or using old style
                // ã€æ ¸å¿ƒä¿®å¤ã€‘åŒæ ·åˆ é™¤äº†é’ˆå¯¹ data:image çš„é‡ç½®é€»è¾‘
                if (!userProfile.avatar || userProfile.avatar.includes('api.dicebear.com') || userProfile.avatar === '') {
                    userProfile.avatar = WeChatUI.getRandomAvatar();
                }

                // Update moments background if not set or using old URL
                if (!userProfile.momentsBg || userProfile.momentsBg.includes('images.unsplash.com') || userProfile.momentsBg.includes('image.pollinations.ai')) {
                    userProfile.momentsBg = WeChatUI.getRandomMomentsBg();
                }

                // Initialize empty profile
                if (Object.keys(userProfile).length === 0) {
                    AppStorage.set('wechat_user_profile', {
                        name: 'æˆ‘',
                        avatar: userProfile.avatar,
                        momentsBg: userProfile.momentsBg,
                        momentsFrequency: 'daily' // daily, weekly, monthly, never
                    });
                } else {
                    // Save updated profile with new avatar and moments bg if needed
                    AppStorage.set('wechat_user_profile', userProfile);
                }

                // æ¢å¤è‡ªåŠ¨æœ—è¯»çŠ¶æ€
                WeChatUI.isAutoTTS = AppStorage.get('wechat_auto_tts', false);
                WeChatUI.updateAutoTTSIcon();

                // è¯·æ±‚é€šçŸ¥æƒé™ï¼Œç”¨äºåå°æŸ¥å²—æç¤º
                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

            },







            // NPC Management
            openNPCManager: () => {
                const modal = document.getElementById('modal-npc-manager');
                modal.classList.remove('hidden');
                WeChatUI.renderNPCList();
            },
            openRandomNPCModal: () => {
                const modal = document.getElementById('modal-random-npc');
                const charSelect = document.getElementById('random-npc-char-select');

                // Populate character options
                const chars = AppStorage.get('wechat_chars', {});
                const charOptions = Object.values(chars).map(char => `
                    <option value="${char.id}">${char.name}</option>
                `).join('');
                charSelect.innerHTML = charOptions;

                modal.classList.remove('hidden');
            },
            renderNPCList: () => {
                const npcs = AppStorage.get('wechat_npcs', {});
                const list = document.getElementById('npc-list');

                if (Object.keys(npcs).length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">æš‚æ— NPCï¼Œè¯·æ·»åŠ </div>';
                    return;
                }

                list.innerHTML = Object.values(npcs).map(npc => `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-md overflow-hidden">
                                <img src="${npc.avatar || WeChatUI.getRandomAvatar()}" alt="${npc.name}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="font-medium">${npc.name}</div>
                                <div class="text-xs text-gray-500 truncate max-w-[200px]">${npc.personality || 'æš‚æ— äººè®¾'}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="WeChatUI.editNPC('${npc.id}')" class="text-blue-400 hover:text-blue-300 text-sm">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="WeChatUI.deleteNPC('${npc.id}')" class="text-red-400 hover:text-red-300 text-sm">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            startCreateNPC: () => {
                document.getElementById('npc-form-title').textContent = 'åˆ›å»ºNPC';
                document.getElementById('npc-id').value = '';
                document.getElementById('npc-name').value = '';
                document.getElementById('npc-avatar').value = '';
                document.getElementById('npc-personality').value = '';

                // Populate character options
                WeChatUI.populateCharSelect();

                document.getElementById('modal-npc-form').classList.remove('hidden');
            },
            editNPC: (id) => {
                const npcs = AppStorage.get('wechat_npcs', {});
                const npc = npcs[id];
                if (!npc) return;

                document.getElementById('npc-form-title').textContent = 'ç¼–è¾‘NPC';
                document.getElementById('npc-id').value = id;
                document.getElementById('npc-name').value = npc.name;
                document.getElementById('npc-avatar').value = npc.avatar || '';
                document.getElementById('npc-personality').value = npc.personality || '';

                // Populate character options and set selected value
                WeChatUI.populateCharSelect(npc.associatedChar);

                document.getElementById('modal-npc-form').classList.remove('hidden');
            },
            populateCharSelect: (selectedCharId = '') => {
                const chars = AppStorage.get('wechat_chars', {});
                const charSelect = document.getElementById('npc-char-select');

                const charOptions = Object.values(chars).map(char => `
                    <option value="${char.id}" ${selectedCharId === char.id ? 'selected' : ''}>${char.name}</option>
                `).join('');
                charSelect.innerHTML = charOptions;
            },
            addNPCToList: () => {
                const charId = document.getElementById('npc-char-select').value;
                const npcId = document.getElementById('npc-id').value;

                if (!charId || !npcId) return alert('è¯·å…ˆä¿å­˜NPCå¹¶é€‰æ‹©å…³è”è§’è‰²');

                const chars = AppStorage.get('wechat_chars', {});
                const npcs = AppStorage.get('wechat_npcs', {});

                if (!chars[charId] || !npcs[npcId]) return alert('è§’è‰²æˆ–NPCä¸å­˜åœ¨');

                // Add NPC to character's bound NPCs
                if (!chars[charId].boundNPCs) chars[charId].boundNPCs = [];
                if (!chars[charId].boundNPCs.includes(npcId)) {
                    chars[charId].boundNPCs.push(npcId);
                    AppStorage.set('wechat_chars', chars);
                    Utils.showToast('NPCå·²æ·»åŠ åˆ°è§’è‰²åˆ—è¡¨');
                } else {
                    Utils.showToast('NPCå·²åœ¨è§’è‰²åˆ—è¡¨ä¸­');
                }
            },
            saveNPC: () => {
                const id = document.getElementById('npc-id').value;
                const name = document.getElementById('npc-name').value.trim();
                const avatar = document.getElementById('npc-avatar').value.trim();
                const personality = document.getElementById('npc-personality').value.trim();
                const charId = document.getElementById('npc-char-select').value;

                if (!name) return alert('è¯·è¾“å…¥NPCåå­—');

                const npcs = AppStorage.get('wechat_npcs', {});
                const npcId = id || 'npc_' + Date.now();

                npcs[npcId] = {
                    id: npcId,
                    name: name,
                    avatar: avatar,
                    personality: personality,
                    associatedChar: charId
                };

                AppStorage.set('wechat_npcs', npcs);
                document.getElementById('modal-npc-form').classList.add('hidden');
                WeChatUI.renderNPCList();
            },
            deleteNPC: (id) => {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤NPCå—ï¼Ÿ')) return;

                const npcs = AppStorage.get('wechat_npcs', {});
                delete npcs[id];
                AppStorage.set('wechat_npcs', npcs);

                // Remove this NPC from all characters' bound NPCs
                const chars = AppStorage.get('wechat_chars', {});
                Object.values(chars).forEach(char => {
                    if (char.boundNPCs) {
                        char.boundNPCs = char.boundNPCs.filter(npcId => npcId !== id);
                    }
                });
                AppStorage.set('wechat_chars', chars);

                WeChatUI.renderNPCList();
            },
            generateRandomNPCs: async () => {
                const charId = document.getElementById('random-npc-char-select').value;
                const count = parseInt(document.getElementById('random-npc-count').value);
                const type = document.getElementById('random-npc-type').value;

                if (!charId) return alert('è¯·é€‰æ‹©å…³è”è§’è‰²');

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return alert('è§’è‰²ä¸å­˜åœ¨');

                Utils.showToast(`æ­£åœ¨è¯»å–ã€${char.name}ã€‘çš„äººè®¾ç”Ÿæˆ ${count} ä¸ªç›¸å…³ NPC...`);

                const prompt = `ä½ æ˜¯ä¸€ä¸ªè§’è‰²è®¾è®¡åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä¸»è§’ã€${char.name}ã€‘çš„è®¾å®šï¼š
                "${char.prompt || char.personality || 'æ— è¯¦ç»†è®¾å®š'}"
                
                ç”Ÿæˆ ${count} ä¸ªä¸ä¸»è§’æœ‰å…³ç³»çš„ ${type === 'random' ? 'éšæœºå…³ç³»' : type} NPCã€‚
                
                è¦æ±‚ï¼š
                1. NPC å¿…é¡»ç¬¦åˆä¸»è§’çš„ä¸–ç•Œè§‚å’ŒèƒŒæ™¯æ•…äº‹ã€‚
                2. è¾“å‡ºçº¯ JSON æ ¼å¼ï¼ˆä¸è¦ Markdown ä»£ç å—ï¼‰ã€‚
                3. JSON ç»“æ„ï¼š
                [
                  {
                    "name": "åå­—",
                    "gender": "ç”·/å¥³",
                    "age": "å¹´é¾„",
                    "relation": "ä¸ä¸»è§’çš„å…³ç³»",
                    "personality": "ç®€çŸ­æ€§æ ¼æè¿°",
                    "appearance": "ç®€çŸ­å¤–è²Œæè¿°(ç”¨äºç”Ÿæˆå¤´åƒ)"
                  }
                ]`;

                try {
                    const aiResponse = await SettingsLogic.generateLLM([{ role: 'system', content: prompt }], charId);

                    let cleanJson = aiResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    // å°è¯•æå– JSON æ•°ç»„
                    const start = cleanJson.indexOf('[');
                    const end = cleanJson.lastIndexOf(']');
                    if (start !== -1 && end !== -1) {
                        cleanJson = cleanJson.substring(start, end + 1);
                    }

                    const npcList = JSON.parse(cleanJson);
                    const npcs = AppStorage.get('wechat_npcs', {});
                    const newNPCsIds = [];

                    for (const npcInfo of npcList) {
                        const npcId = 'npc_ai_' + Date.now() + Math.random().toString(36).substr(2, 5);

                        // ç”Ÿæˆå¤´åƒ Prompt
                        const avatarPrompt = `anime style portrait of ${npcInfo.gender}, ${npcInfo.appearance}, ${npcInfo.personality}, high quality, illustration`;
                        const avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(avatarPrompt)}?width=200&height=200&nologo=true&model=kontext&seed=${Math.random()}`;

                        npcs[npcId] = {
                            id: npcId,
                            name: npcInfo.name,
                            avatar: avatarUrl,
                            personality: `[${npcInfo.relation}] ${npcInfo.personality}ã€‚${npcInfo.age}å²ã€‚`,
                            type: type === 'random' ? 'friend' : type, // ç®€å•å½’ç±»
                            gender: npcInfo.gender,
                            associatedChar: charId
                        };
                        newNPCsIds.push(npcId);
                    }

                    AppStorage.set('wechat_npcs', npcs);

                    if (!char.boundNPCs) char.boundNPCs = [];
                    char.boundNPCs.push(...newNPCsIds);
                    AppStorage.set('wechat_chars', chars);

                    document.getElementById('modal-random-npc').classList.add('hidden');
                    WeChatUI.renderNPCList();
                    Utils.showToast(`æˆåŠŸç”Ÿæˆ ${newNPCsIds.length} ä¸ª AI NPC`);

                } catch (error) {
                    console.error('AI NPC ç”Ÿæˆå¤±è´¥:', error);
                    Utils.showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            },
            // Calculate token count based on message content
            calculateTokenCount: (messages) => {
                if (!messages || messages.length === 0) return 0;

                let totalTokens = 0;
                messages.forEach(msg => {
                    // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œåªç®— 100 Token æ„æ€ä¸€ä¸‹
                    if (msg.type === 'image') {
                        totalTokens += 100;
                    }
                    else if (msg.content) {
                        // Ensure content is a string to avoid TypeError
                        const content = String(msg.content);
                        const chineseChars = (content.match(/[\u4e00-\u9fa5]/g) || []).length;
                        const englishWords = (content.match(/\b[a-zA-Z]+\b/g) || []).length;
                        const otherChars = content.length - chineseChars - englishWords;
                        totalTokens += chineseChars + englishWords + Math.ceil(otherChars * 0.5);
                    }
                });
                return totalTokens;
            },

            openCharSettings: (isNew = false) => {
                const cid = isNew ? WeChatUI.currentChatId : document.getElementById('subpage-chat-detail').dataset.charId;
                if (!cid) return;
                WeChatUI.currentChatId = cid;
                const c = AppStorage.get('wechat_chars', {})[cid];
                const userProfile = AppStorage.get('wechat_user_profile', {});
                document.getElementById('char-name').value = c.name;
                WeChatUI.renderAvatarPreview('char-avatar-preview', c.avatar);
                document.getElementById('char-avatar-data').value = c.avatar || '';
                document.getElementById('char-nickname').value = c.nickname || '';
                document.getElementById('char-prompt').value = c.prompt || '';
                // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·èµ„æ–™ä¸­çš„ç”¨æˆ·åï¼Œç¡®ä¿åŒæ­¥
                document.getElementById('char-user-name').value = c.userName || userProfile.name || '';
                document.getElementById('char-user-persona').value = c.userPersona || '';
                WeChatUI.renderAvatarPreview('user-avatar-preview', c.userAvatar);
                document.getElementById('user-avatar-data').value = c.userAvatar || '';
                // document.getElementById('char-worldbook').checked = c.worldbook || false; // Deprecated checkbox
                document.getElementById('stat-chat-count').textContent = (c.msgs || []).length;

                // Calculate and display token count
                const tokenCount = WeChatUI.calculateTokenCount(c.msgs || []);
                document.getElementById('stat-token-count').textContent = tokenCount;

                document.getElementById('char-context-limit').value = c.contextLimit || 20;
                document.getElementById('char-display-limit').value = c.displayLimit || 50;
                document.getElementById('char-summary-limit').value = c.summaryLimit || 50;
                document.getElementById('char-auto-summary').checked = c.autoSummary || false;
                document.getElementById('char-summary-prompt').value = c.summaryPrompt || 'è¯·ä»¥ç¬¬ä¸‰äººç§°æ€»ç»“ä¸Šä¸‹æ–‡å¯¹è¯ä¸­çš„å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸»è¦è¯é¢˜ã€é‡è¦äº‹ä»¶ã€äººç‰©å…³ç³»å’Œå…³é”®ç»†èŠ‚ï¼Œå­˜å…¥è®°å¿†åº“ã€‚ä¿æŒç®€æ´æ˜äº†ï¼Œé‡ç‚¹çªå‡ºã€‚';

                document.getElementById('char-avatar-shape').value = c.avatarShape || 'square';
                document.getElementById('char-bubble-css').value = c.bubbleCss || '';
                document.getElementById('char-chat-bg').value = c.chatBg || '';
                document.getElementById('char-bg-blur').value = c.bgBlur || 0;
                document.getElementById('char-bg-opacity').value = c.bgOpacity !== undefined ? c.bgOpacity : 1;
                document.getElementById('char-bubble-size').value = c.bubbleFontSize || 15;
                document.getElementById('char-tts-enabled').checked = c.ttsEnabled || false;
                document.getElementById('char-voice-id').value = c.voiceId || '';
                document.getElementById('char-voice-speed').value = c.voiceSpeed || 1.0;
                document.getElementById('val-voice-speed').textContent = c.voiceSpeed || 1.0;
                document.getElementById('char-time-aware').checked = c.timeAware || false;
                document.getElementById('char-virtual-time').value = c.virtualTime || '';
                document.getElementById('char-active-chat-switch').checked = c.activeChat || false;
                document.getElementById('char-active-interval').value = c.activeInterval || 30;
                document.getElementById('char-proactive-chat-switch').checked = c.proactiveChat || false;
                document.getElementById('char-proactive-interval').value = c.proactiveInterval || 5;
                document.getElementById('char-pat-action').value = c.patAction || '';
                document.getElementById('char-pat-suffix').value = c.patSuffix || '';
                WeChatUI.toggleTimeSetting();
                WeChatUI.updateBgPreview();
                // Mirror the global wallpaper into this subpage so we show wallpaper instead of underlying app content
                try {
                    const wp = document.getElementById('wallpaper-layer');
                    const subWp = document.getElementById('subpage-wallpaper');
                    if (subWp) {
                        // prefer character-specific background if available
                        const charBg = (c && c.chatBg) || '';
                        if (charBg) {
                            if (/^url\(/.test(charBg.trim())) subWp.style.backgroundImage = charBg;
                            else subWp.style.backgroundImage = `url(${charBg})`;
                        } else if (wp) {
                            const cs = window.getComputedStyle(wp);
                            subWp.style.backgroundImage = cs.backgroundImage || 'none';
                            subWp.style.backgroundSize = cs.backgroundSize || 'cover';
                            subWp.style.backgroundPosition = cs.backgroundPosition || 'center';
                        } else {
                            subWp.style.backgroundImage = 'none';
                        }
                        // apply per-character blur/opacity if defined
                        const opacity = (c && (c.bgOpacity !== undefined ? c.bgOpacity : document.getElementById('char-bg-opacity')?.value)) || 1;
                        const blur = (c && (c.bgBlur !== undefined ? c.bgBlur : document.getElementById('char-bg-blur')?.value)) || 0;
                        subWp.style.opacity = opacity;
                        subWp.style.filter = `blur(${blur}px)`;
                    }
                } catch (e) { console.warn('mirror wallpaper failed', e); }
                WeChatUI.updateEmojiCategories();
                // Initialize emoji category management list
                WeChatUI.renderEmojiCategories();
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());

                // Removed custom emoji selector replacement to fix duplicate issue


                // Render NPC binding list
                WeChatUI.renderNPCBindingList(cid);

                // Render Worldbook List for this char
                if (typeof WorldbookUI !== 'undefined' && WorldbookUI.renderSettingsList) {
                    WorldbookUI.renderSettingsList();
                }

                // Render Memory Link Checkboxes
                WeChatUI.renderMemoryLinkCheckboxes(cid);

                document.getElementById('subpage-char-settings').classList.add('active');
                HistoryManager.push('subpage-char-settings');
            },
            renderNPCBindingList: (cid) => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                const npcs = AppStorage.get('wechat_npcs', {});
                const npcList = Object.values(npcs);
                const bindingList = document.getElementById('npc-binding-list');

                if (npcList.length === 0) {
                    bindingList.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">æš‚æ— NPCï¼Œè¯·å…ˆæ·»åŠ NPC</div>';
                    return;
                }

                const boundNPCs = c.boundNPCs || [];
                bindingList.innerHTML = npcList.map(npc => {
                    const isBound = boundNPCs.includes(npc.id);
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-800/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-md overflow-hidden">
                                    <img src="${npc.avatar || WeChatUI.getRandomAvatar()}" alt="${npc.name}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium truncate">${npc.name}</div>
                                    <div class="text-xs text-gray-500 truncate">${npc.personality || 'æš‚æ— äººè®¾'}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" 
                                       id="npc-bound-${npc.id}" 
                                       ${isBound ? 'checked' : ''} 
                                       onchange="WeChatUI.toggleNPCBinding('${cid}', '${npc.id}')"
                                       class="toggle-switch">
                            </div>
                        </div>
                    `;
                }).join('');
            },
            toggleNPCBinding: (cid, npcId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                if (!c.boundNPCs) c.boundNPCs = [];

                const index = c.boundNPCs.indexOf(npcId);
                if (index > -1) {
                    c.boundNPCs.splice(index, 1);
                } else {
                    c.boundNPCs.push(npcId);
                }

                AppStorage.set('wechat_chars', chars);
                WeChatUI.renderNPCBindingList(cid);
            },
            saveCharacter: () => {
                // --- 1. å®‰å…¨è·å–æ•°æ®çš„è¾…åŠ©å‡½æ•° (é˜²æ­¢æŠ¥é”™) ---
                const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
                const getCheck = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };

                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                if (!c) return Utils.showToast('ä¿å­˜å¤±è´¥ï¼šæ‰¾ä¸åˆ°è§’è‰²ID');

                const oldNickname = c.nickname || '';

                // --- 2. è¯»å–å„é¡¹è®¾ç½® (ä½¿ç”¨å®‰å…¨å‡½æ•°) ---
                c.name = getVal('char-name');
                c.avatar = getVal('char-avatar-data');
                c.nickname = getVal('char-nickname');
                c.prompt = getVal('char-prompt');
                c.openingLine = getVal('char-opening-line');

                // ç”¨æˆ·ç›¸å…³ (æˆ‘çš„äººè®¾)
                c.userName = getVal('char-user-name');
                c.userPersona = getVal('char-user-persona');
                c.userAvatar = getVal('user-avatar-data');

                // åŒæ­¥ç”¨æˆ·åå’Œå¤´åƒåˆ°ç”¨æˆ·èµ„æ–™
                const userProfile = AppStorage.get('wechat_user_profile', {});
                if (c.userName) {
                    userProfile.name = c.userName;
                    // æ›´æ–°UI
                    const els = ['user-name', 'moments-name', 'user-moments-name'];
                    els.forEach(id => { if (document.getElementById(id)) document.getElementById(id).textContent = c.userName; });
                }
                if (c.userAvatar) {
                    userProfile.avatar = c.userAvatar;
                    // æ›´æ–°UI
                    const imgEls = ['user-avatar', 'moments-avatar', 'user-moments-avatar'];
                    imgEls.forEach(id => { if (document.getElementById(id)) document.getElementById(id).src = c.userAvatar; });
                }
                AppStorage.set('wechat_user_profile', userProfile);

                // é«˜çº§è®¾ç½®
                c.contextLimit = parseInt(getVal('char-context-limit')) || 20;
                c.displayLimit = parseInt(getVal('char-display-limit')) || 50;
                c.summaryLimit = parseInt(getVal('char-summary-limit')) || 50;
                c.autoSummary = getCheck('char-auto-summary');
                c.summaryPrompt = getVal('char-summary-prompt');

                // å¤–è§‚è®¾ç½®
                c.avatarShape = getVal('char-avatar-shape') || 'square';
                c.bubbleCss = getVal('char-bubble-css');
                c.bubbleFontSize = getVal('char-bubble-size') || 15;
                c.chatBg = getVal('char-chat-bg');
                c.bgBlur = getVal('char-bg-blur') || 0;
                c.bgOpacity = getVal('char-bg-opacity') !== '' ? getVal('char-bg-opacity') : 1;

                // æ‹ä¸€æ‹ä¸è¯­éŸ³
                c.patAction = getVal('char-pat-action');
                c.patSuffix = getVal('char-pat-suffix');
                c.ttsEnabled = getCheck('char-tts-enabled');
                c.voiceId = getVal('char-voice-id');
                c.voiceSpeed = getVal('char-voice-speed') || 1.0;
                c.timeAware = getCheck('char-time-aware');
                c.virtualTime = getVal('char-virtual-time');
                // æŸ¥å²—è®¾ç½®
                c.activeChat = getCheck('char-active-chat-switch');
                c.activeInterval = parseInt(getVal('char-active-interval')) || 30;
                // ä¸»åŠ¨å‘æ¶ˆæ¯è®¾ç½® (ç”¨æˆ·åœ¨èŠå¤©ç•Œé¢æ—¶)
                c.proactiveChat = getCheck('char-proactive-chat-switch');
                c.proactiveInterval = parseInt(getVal('char-proactive-interval')) || 60;

                // --- 3. æ£€æŸ¥æ˜µç§°æ˜¯å¦ä¿®æ”¹ (è§¦å‘ç³»ç»Ÿæç¤º) ---
                if (c.nickname !== oldNickname) {
                    const userName = userProfile.name || 'ç”¨æˆ·';
                    const newNickname = c.nickname || c.name;

                    const systemMsg = {
                        role: 'system',
                        type: 'system',
                        content: `${userName}å°†ä½ çš„å¤‡æ³¨æ”¹æˆ${newNickname}`,
                        timestamp: Date.now()
                    };

                    if (!c.msgs) c.msgs = [];
                    c.msgs.push(systemMsg);

                    // å‘é€ç»™AIè®©å…¶ååº”
                    const apiMessages = [{ role: 'system', content: c.prompt || '' }, ...c.msgs.filter(m => m.role !== 'system')];
                    apiMessages.push({ role: 'system', content: systemMsg.content });

                    SettingsLogic.generateLLM(apiMessages, WeChatUI.currentChatId).then(reply => {
                        if (reply && reply.trim()) {
                            c.msgs.push({ role: 'ai', type: 'text', content: reply.trim(), timestamp: Date.now() });
                            AppStorage.set('wechat_chars', chars);
                            // å¦‚æœå½“å‰å°±åœ¨èŠå¤©é¡µï¼Œåˆ·æ–°å®ƒ
                            const detailEl = document.getElementById('subpage-chat-detail');
                            if (detailEl && detailEl.classList.contains('active') && detailEl.dataset.charId === WeChatUI.currentChatId) {
                                WeChatUI.loadChat(WeChatUI.currentChatId);
                            }
                        }
                    });
                }

                // --- 4. ä¿å­˜å¹¶å…³é—­ ---
                AppStorage.set('wechat_chars', chars);
                Utils.showToast('è§’è‰²å·²ä¿å­˜');

                document.getElementById('subpage-char-settings').classList.remove('active');
                WeChatUI.renderList();

                // å¦‚æœèŠå¤©ç•Œé¢æ‰“å¼€ä¸­ï¼Œåˆ·æ–°èƒŒæ™¯å’Œæ ‡é¢˜
                const detailEl = document.getElementById('subpage-chat-detail');
                if (detailEl && detailEl.classList.contains('active') && detailEl.dataset.charId === c.id) {
                    WeChatUI.loadChat(c.id);
                }
            },

            toggleTimeSetting: () => {
                const isAware = document.getElementById('char-time-aware').checked;
                const container = document.getElementById('virtual-time-container');
                if (isAware) container.classList.add('hidden');
                else container.classList.remove('hidden');
            },
            promptAvatarUrl: () => { Utils.showPrompt('ä¸Šä¼ å¤´åƒ', 'è¾“å…¥å›¾ç‰‡URL:', (url) => { if (url) { document.getElementById('char-avatar-data').value = url; WeChatUI.renderAvatarPreview('char-avatar-preview', url); WeChatUI.updateBgPreview(); } }); },
            promptUserAvatarUrl: () => { Utils.showPrompt('ä¸Šä¼ æˆ‘çš„å¤´åƒ', 'è¾“å…¥å›¾ç‰‡URL:', (url) => { if (url) { document.getElementById('user-avatar-data').value = url; WeChatUI.renderAvatarPreview('user-avatar-preview', url); WeChatUI.updateBgPreview(); } }); },
            handleAvatarFile: (input) => { if (input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('char-avatar-data').value = base64; WeChatUI.renderAvatarPreview('char-avatar-preview', base64); WeChatUI.updateBgPreview(); }); },
            handleUserAvatarFile: (input) => { if (input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('user-avatar-data').value = base64; WeChatUI.renderAvatarPreview('user-avatar-preview', base64); WeChatUI.updateBgPreview(); }); },
            handleNPCAvatarFile: (input) => { if (input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('npc-avatar').value = base64; }); },
            renderAvatarPreview: (id, src) => { document.getElementById(id).innerHTML = src ? `<img src="${src}">` : '<span class="text-xs text-gray-400">å¤´åƒ</span>'; },
            openEmojiUpload: () => document.getElementById('modal-emoji-upload').classList.remove('hidden'),
            confirmEmojiUpload: () => {
                const input = document.getElementById('emoji-url-input').value;
                const lines = input.split('\n').filter(line => line.trim());
                const newEmojis = [];
                const selectedCategory = document.getElementById('emoji-category-select')?.value || 'default';
                const emojiType = document.getElementById('emoji-type-select')?.value || 'exclusive';

                lines.forEach(line => {
                    line = line.trim();
                    // å¤„ç†å¸¦åå¼•å·çš„URLï¼š`https://example.com/image.jpg`
                    const backtickMatch = line.match(/^`([^`]+)`$/);
                    if (backtickMatch) {
                        const url = backtickMatch[1].trim();
                        // ä»URLä¸­æå–åç§°ï¼ˆå–æœ€åä¸€ä¸ªæ–œæ åçš„éƒ¨åˆ†ï¼Œå»æ‰æ‰©å±•åï¼‰
                        const name = url.split('/').pop().split('.')[0].replace(/-/g, ' ') || 'æœªçŸ¥è¡¨æƒ…';
                        newEmojis.push({ name, url, category: selectedCategory, type: emojiType });
                        return;
                    }

                    // å¤„ç†å¸¦åç§°çš„ä¸­æ–‡å†’å·æ ¼å¼ï¼šåç§°ï¼šURL
                    const match = line.match(/^(.*?)\s*ï¼š\s*`?([^`]+)`?$/);
                    if (match) {
                        const name = match[1].trim();
                        const url = match[2].trim();
                        newEmojis.push({ name, url, category: selectedCategory, type: emojiType });
                        return;
                    }

                    // å¤„ç†å¸¦åç§°çš„è‹±æ–‡å†’å·æ ¼å¼ï¼šåç§°:URL
                    const simpleMatch = line.match(/^(.*?)\s*:\s*`?([^`]+)`?$/);
                    if (simpleMatch) {
                        const name = simpleMatch[1].trim();
                        const url = simpleMatch[2].trim();
                        newEmojis.push({ name, url, category: selectedCategory, type: emojiType });
                        return;
                    }

                    // å¤„ç†çº¯URLæ ¼å¼ï¼šhttps://example.com/image.jpg
                    const url = line;
                    // ä»URLä¸­æå–åç§°ï¼ˆå–æœ€åä¸€ä¸ªæ–œæ åçš„éƒ¨åˆ†ï¼Œå»æ‰æ‰©å±•åï¼‰
                    const name = url.split('/').pop().split('.')[0].replace(/-/g, ' ') || 'æœªçŸ¥è¡¨æƒ…';
                    newEmojis.push({ name, url, category: selectedCategory, type: emojiType });
                });

                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                let existingUrls = new Set();
                let uniqueEmojis = [];

                // Get existing emoji URLs to check for duplicates
                if (emojiType === 'global') {
                    let globalEmojis = AppStorage.get('wechat_global_emojis', []);
                    existingUrls = new Set(globalEmojis.map(e => e.url));
                } else {
                    if (!c.emojis) c.emojis = [];
                    existingUrls = new Set(c.emojis.map(e => e.url));
                }

                // Filter out duplicates
                newEmojis.forEach(emoji => {
                    if (!existingUrls.has(emoji.url)) {
                        uniqueEmojis.push(emoji);
                        existingUrls.add(emoji.url);
                    }
                });

                if (uniqueEmojis.length === 0) {
                    Utils.showToast('æ‰€æœ‰è¡¨æƒ…åŒ…éƒ½å·²å­˜åœ¨ï¼Œæ²¡æœ‰æ–°å¢è¡¨æƒ…åŒ…');
                    document.getElementById('modal-emoji-upload').classList.add('hidden');
                    return;
                }

                if (emojiType === 'global') {
                    // Save to global emojis
                    let globalEmojis = AppStorage.get('wechat_global_emojis', []);
                    globalEmojis.push(...uniqueEmojis);
                    AppStorage.set('wechat_global_emojis', globalEmojis);
                } else {
                    // Save to character-specific emojis
                    if (!c.emojis) c.emojis = [];
                    if (!c.emojiCategories) c.emojiCategories = ['default'];
                    c.emojis.push(...uniqueEmojis);
                    AppStorage.set('wechat_chars', chars);
                }

                WeChatUI.updateEmojiCategories();
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
                document.getElementById('modal-emoji-upload').classList.add('hidden');

                // Show reminder with count
                Utils.showToast(`æˆåŠŸå¯¼å…¥ ${uniqueEmojis.length} ä¸ªæ–°è¡¨æƒ…åŒ…`);
            },
            // åˆ‡æ¢åˆ†ç±»ç®¡ç†åŒºåŸŸçš„æ˜¾ç¤ºå’Œéšè—
            toggleEmojiCategories: () => {
                const managementDiv = document.getElementById('emoji-category-management');
                if (managementDiv) {
                    if (managementDiv.classList.contains('hidden')) {
                        managementDiv.classList.remove('hidden');
                        // ç¡®ä¿currentChatIdè¢«è®¾ç½®
                        if (!WeChatUI.currentChatId) {
                            // å°è¯•ä»å½“å‰é¡µé¢çš„IDè·å–è§’è‰²ID
                            const charId = WeChatUI.currentChatId || document.getElementById('char-name').value || Object.keys(AppStorage.get('wechat_chars', {})).find(id => true);
                            if (charId) {
                                WeChatUI.currentChatId = charId;
                            }
                        }
                        WeChatUI.renderEmojiCategories();
                    } else {
                        managementDiv.classList.add('hidden');
                    }
                }
            },

            // å…¼å®¹æ—§çš„openEmojiCategorieså‡½æ•°
            openEmojiCategories: () => {
                WeChatUI.toggleEmojiCategories();
            },
            renderEmojiCategories: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const categories = c.emojiCategories || ['default'];
                const list = document.getElementById('emoji-categories-list');

                list.innerHTML = categories.map((category, index) => {
                    if (category === 'default') {
                        return `<div class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                            <span class="text-sm">${category === 'default' ? 'é»˜è®¤åˆ†ç±»' : category}</span>
                            <span class="text-xs text-gray-500">ä¸å¯åˆ é™¤</span>
                        </div>`;
                    }
                    return `<div class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                        <span class="text-sm">${category}</span>
                        <button onclick="WeChatUI.deleteEmojiCategory(${index})" class="text-xs text-red-400 hover:text-red-300">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`;
                }).join('');
            },
            addEmojiCategory: () => {
                const name = document.getElementById('new-category-name').value.trim();
                if (!name) return;

                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                if (!c.emojiCategories) c.emojiCategories = ['default'];

                if (!c.emojiCategories.includes(name)) {
                    c.emojiCategories.push(name);
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.renderEmojiCategories();
                    WeChatUI.updateEmojiCategories();
                    document.getElementById('new-category-name').value = '';
                }
            },
            deleteEmojiCategory: (index) => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                if (!c.emojiCategories || index === 0) return;

                const categoryToDelete = c.emojiCategories[index];
                c.emojiCategories.splice(index, 1);

                // å°†è¯¥åˆ†ç±»ä¸‹çš„è¡¨æƒ…åŒ…ç§»åˆ°é»˜è®¤åˆ†ç±»
                c.emojis.forEach(emoji => {
                    if (emoji.category === categoryToDelete) {
                        emoji.category = 'default';
                    }
                });

                AppStorage.set('wechat_chars', chars);
                WeChatUI.renderEmojiCategories();
                WeChatUI.updateEmojiCategories();
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
            },
            updateEmojiCategories: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const categories = c.emojiCategories || ['default'];
                const select = document.getElementById('emoji-category-select');

                if (select) {
                    const currentValue = select.value;
                    let html = `<option value="">æ‰€æœ‰åˆ†ç±»</option>` +
                        `<option value="special_exclusive">è§’è‰²ä¸“å±</option>` +
                        `<option value="special_global">å…¨å±€é€šç”¨</option>`;

                    html += categories.map(category => `<option value="${category}">${category === 'default' ? 'é»˜è®¤åˆ†ç±»' : category}</option>`).join('');
                    select.innerHTML = html;
                    select.value = currentValue;
                }
            },
            filterEmojisByCategory: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const selectedCategory = document.getElementById('emoji-category-select').value;
                const allEmojis = WeChatUI.getAllEmojis();

                if (selectedCategory === '') {
                    WeChatUI.renderEmojiGrid(allEmojis);
                } else if (selectedCategory === 'special_global') {
                    // åªçœ‹å…¨å±€
                    const filtered = allEmojis.filter(emoji => emoji.type === 'global');
                    WeChatUI.renderEmojiGrid(filtered);
                } else if (selectedCategory === 'special_exclusive') {
                    // åªçœ‹ä¸“å± (éå…¨å±€)
                    const filtered = allEmojis.filter(emoji => emoji.type !== 'global');
                    WeChatUI.renderEmojiGrid(filtered);
                } else {
                    // æ™®é€šåˆ†ç±» (ä»…ç­›é€‰ä¸“å±è¡¨æƒ…ä¸­çš„ç‰¹å®šåˆ†ç±»ï¼Œå› ä¸ºå…¨å±€è¡¨æƒ…æ²¡æœ‰åˆ†ç±»å±æ€§)
                    // æ³¨æ„ï¼šè¿™ä¼šè‡ªåŠ¨æ’é™¤å…¨å±€è¡¨æƒ…ï¼Œå› ä¸ºå…¨å±€è¡¨æƒ… category ä¸º undefined
                    const filtered = allEmojis.filter(emoji => emoji.category === selectedCategory);
                    WeChatUI.renderEmojiGrid(filtered);
                }
            },
            renderEmojiGrid: (list) => {
                document.getElementById('emoji-grid').innerHTML = list.map((emoji, index) => `
                    <div class="emoji-item relative">
                        <img src="${emoji.url || emoji}" alt="${emoji.name || 'è¡¨æƒ…'}">
                        <div class="text-[10px] text-center text-gray-400 truncate px-1 py-0.5 bg-black/50">${emoji.name || 'æœªçŸ¥è¡¨æƒ…'}</div>
                        <div class="absolute top-1 left-1 bg-blue-500/80 text-white text-[6px] px-1.5 py-0.5 rounded-full">
                            ${emoji.type === 'global' ? 'å…¨å±€' : 'ä¸“å±'}
                        </div>
                        <button onclick="WeChatUI.deleteEmoji(${index})" class="absolute top-1 right-1 w-5 h-5 bg-red-500/80 text-white rounded-full flex items-center justify-center text-[8px] hover:bg-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },
            getAllEmojis: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const charEmojis = c ? (c.emojis || []) : [];
                return [...globalEmojis, ...charEmojis];
            },
            deleteEmoji: (index) => {
                const allEmojis = WeChatUI.getAllEmojis();
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const charEmojis = c.emojis || [];

                if (index < globalEmojis.length) {
                    // Delete from global emojis
                    globalEmojis.splice(index, 1);
                    AppStorage.set('wechat_global_emojis', globalEmojis);
                } else {
                    // Delete from character emojis
                    const charIndex = index - globalEmojis.length;
                    if (charEmojis.length > charIndex) {
                        charEmojis.splice(charIndex, 1);
                        c.emojis = charEmojis;
                        AppStorage.set('wechat_chars', chars);
                    }
                }

                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
                Utils.showToast('è¡¨æƒ…åŒ…å·²åˆ é™¤');
            },
            showEmojiPicker: () => {
                const panel = document.getElementById('emoji-panel');
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const charEmojis = c.emojis || [];
                const allEmojis = [...globalEmojis, ...charEmojis];

                if (panel.style.display === 'flex' || panel.style.display === 'block') {
                    panel.style.display = 'none';
                } else {
                    // 1. æ¸…é™¤æ—§æ ·å¼å¹²æ‰°
                    panel.removeAttribute('style');

                    // 2. è®¾ç½®é¢æ¿æ ·å¼ (flexå¸ƒå±€åŒ…å«æœç´¢æ¡†å’Œè¡¨æƒ…ç½‘æ ¼)
                    panel.style.display = 'flex';
                    panel.style.flexDirection = 'column';
                    panel.style.backgroundColor = '#f2f2f2';
                    panel.style.height = '240px'; // é™ä½é«˜åº¦ï¼Œè®©è¡¨æƒ…åŒ…æ›´å¯è§
                    panel.style.borderTop = '1px solid #e5e5e5';
                    panel.style.width = '100%';
                    panel.style.padding = '10px';
                    panel.style.boxSizing = 'border-box';

                    // æ¸²æŸ“è¡¨æƒ…åŒ…çš„å‡½æ•°
                    const renderEmojis = (emojis) => {
                        const gridEl = document.getElementById('emoji-picker-grid');
                        if (!gridEl) return;

                        if (emojis.length > 0) {
                            gridEl.innerHTML = emojis.map((emoji, index) => {
                                let displayName = emoji.name || 'è¡¨æƒ…';
                                return `
                <div class="bg-white rounded-lg shadow-sm relative active:scale-95 transition-transform" 
                                     style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 90px; padding: 6px; overflow: hidden;"
                                     onclick="WeChatUI.pushMessage('image', '${emoji.url || emoji}', 'user', 'emoji', '${encodeURIComponent(displayName)}')">
                                    
                                    <div style="flex: 1; width: 100%; display: flex; align-items: center; justify-content: center; min-height: 0; margin-bottom: 2px;">
                                        <img src="${emoji.url || emoji}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                    </div>
                                    
                                    <div style="font-size: 10px; color: #666; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 14px; line-height: 14px; flex-shrink: 0;">
                                        ${displayName}
                                    </div>
                                    
                                    <div class="absolute top-0.5 right-0.5 text-[8px] px-1 py-0.5 rounded shadow-sm scale-75 origin-top-right ${emoji.type === 'global' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}">
                                        ${emoji.type === 'global' ? 'å…¨' : 'ä¸“'}
                                    </div>
                                </div>
                                `;
                            }).join('');
                        } else {
                            gridEl.innerHTML = '<div class="text-gray-400 text-sm text-center py-8 col-span-5">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¡¨æƒ…åŒ…</div>';
                        }
                    };

                    // æ„å»ºæœç´¢æ¡†å’Œè¡¨æƒ…ç½‘æ ¼
                    panel.innerHTML = `
                        <div style="margin-bottom: 8px; display: flex; gap: 6px;">
                            <input type="text" id="emoji-search-input" placeholder="ğŸ” æœç´¢è¡¨æƒ…åŒ…åç§°..." 
                                   style="flex: 1; padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px; outline: none;"
                                   oninput="WeChatUI.filterEmojiPicker(this.value)">
                            <button onclick="document.getElementById('emoji-search-input').value=''; WeChatUI.filterEmojiPicker('');" 
                                    style="padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; background: white; font-size: 12px; cursor: pointer;">
                                æ¸…ç©º
                            </button>
                        </div>
                        <div id="emoji-picker-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; flex: 1; overflow-y: auto; overflow-x: hidden;">
                        </div>
                    `;

                    // å­˜å‚¨æ‰€æœ‰è¡¨æƒ…åŒ…ä¾›æœç´¢ä½¿ç”¨
                    WeChatUI.currentEmojiList = allEmojis;

                    // æ¸²æŸ“æ‰€æœ‰è¡¨æƒ…åŒ…
                    renderEmojis(allEmojis);

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    setTimeout(() => {
                        const container = document.getElementById('chat-messages-container');
                        if (container) container.scrollTop = container.scrollHeight;
                    }, 100);

                    // é˜»æ­¢å†’æ³¡
                    panel.onclick = function (event) {
                        event.stopPropagation();
                    };

                    // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢æ¿çš„åŠŸèƒ½
                    const clickOutsideHandler = function (event) {
                        if (!panel.contains(event.target) && !event.target.closest('[onclick*="showEmojiPicker"]')) {
                            panel.style.display = 'none';
                            document.removeEventListener('click', clickOutsideHandler);
                        }
                    };
                    // å»¶è¿Ÿæ·»åŠ ç›‘å¬å™¨ï¼Œé¿å…ç«‹å³è§¦å‘
                    setTimeout(() => {
                        document.addEventListener('click', clickOutsideHandler);
                    }, 100);
                }
            },
            // è¡¨æƒ…åŒ…æœç´¢è¿‡æ»¤
            filterEmojiPicker: (keyword) => {
                const allEmojis = WeChatUI.currentEmojiList || [];

                const filtered = keyword.trim()
                    ? allEmojis.filter(emoji => {
                        const name = (emoji.name || '').toLowerCase();
                        return name.includes(keyword.toLowerCase());
                    })
                    : allEmojis;

                if (WeChatUI.renderEmojiPickerGrid) {
                    WeChatUI.renderEmojiPickerGrid(filtered);
                }
            },


            // è¡¨æƒ…åŒ…ç¿»è½¬æ˜¾ç¤ºåç§°
            toggleEmojiName: (msgId) => {
                const container = document.getElementById(`emoji-${msgId}`);
                if (!container) return;

                const inner = container.querySelector('.emoji-flip-inner');
                if (!inner) return;

                // åˆ‡æ¢ç¿»è½¬çŠ¶æ€
                const isFlipped = inner.style.transform === 'rotateY(180deg)';
                inner.style.transform = isFlipped ? 'rotateY(0deg)' : 'rotateY(180deg)';

                // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                event.stopPropagation();
            },

            // æ‰“å¼€è®°å¿†åº“å¹¶æ¸²æŸ“åˆ—è¡¨
            openMemoryLib: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;
                const char = AppStorage.get('wechat_chars', {})[cid];

                // 1. æ‰¾åˆ°å®¹å™¨
                const container = document.getElementById('memory-lib-container');
                if (!container) return;

                const memories = (char.memory || []).map((m, i) => ({ ...m, _idx: i })).reverse();

                // 3. æ¸²æŸ“
                // 3. æ¸²æŸ“
                if (memories.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20 opacity-50">
                            <i class="fa-solid fa-wind text-4xl mb-4 text-purple-300/50"></i>
                            <div class="text-xs text-purple-200">æš‚æ— è®°å¿†æ‘˜è¦</div>
                            <div class="text-[10px] text-gray-400 mt-1">å½“å¯¹è¯è¾¾åˆ°è®¾å®šæ¡æ•°æ—¶å°†è‡ªåŠ¨ç”Ÿæˆ</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = memories.map((m) => {
                        // åŒºåˆ†ç±»å‹æ ·å¼
                        const isSummary = m.type === 'summary';

                        // å¡ç‰‡èƒŒæ™¯ï¼šæ›´ç²¾è‡´çš„æ·±è‰²ç»ç’ƒæ€
                        const cardBg = isSummary ? 'bg-[#1e293b]' : 'bg-[#2e1065]';
                        const cardBorder = isSummary ? 'border-slate-600' : 'border-purple-800';

                        // å¾½ç« æ ·å¼
                        const badgeColor = isSummary ?
                            'bg-blue-600/20 text-blue-200 border-blue-500/30' :
                            'bg-purple-600/20 text-purple-200 border-purple-500/30';

                        const icon = isSummary ? '<i class="fa-solid fa-list-check"></i>' : '<i class="fa-solid fa-star"></i>';
                        const typeName = isSummary ? 'é˜¶æ®µæ€»ç»“' : 'é‡è¦è®°å¿†';

                        // æ—¶é—´æ ¼å¼åŒ–
                        const dateObj = new Date(m.timestamp);
                        const dateStr = dateObj.toLocaleDateString();
                        const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        return `
                            <div id="memory-card-${m._idx}" 
                                 class="${cardBg} rounded-lg border ${cardBorder} p-3 mb-3 shadow-md relative group transition-all hover:bg-opacity-90">
                                
                                <!-- Header -->
                                <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/10">
                                    <div class="flex items-center gap-2">
                                        <div class="${badgeColor} text-xs px-2 py-1 rounded border flex items-center gap-1">
                                            ${icon}
                                            <span class="font-bold tracking-wide">${typeName}</span>
                                        </div>
                                        <div class="text-xs text-gray-400 font-mono">
                                            ${dateStr} ${timeStr}
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons - Always Visible -->
                                    <div class="flex items-center gap-2 memory-actions">
                                        <button onclick="WeChatUI.editMemory('${cid}', ${m._idx})" 
                                                class="w-7 h-7 flex items-center justify-center rounded bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 transition-colors" 
                                                title="ç¼–è¾‘">
                                            <i class="fa-regular fa-pen-to-square"></i>
                                        </button>
                                        <button onclick="WeChatUI.copyMemoryContent('${encodeURIComponent(m.content)}')" 
                                                class="w-7 h-7 flex items-center justify-center rounded bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 transition-colors" 
                                                title="å¤åˆ¶">
                                            <i class="fa-regular fa-copy"></i>
                                        </button>
                                        <button onclick="WeChatUI.deleteMemory('${cid}', ${m._idx})" 
                                                class="w-7 h-7 flex items-center justify-center rounded bg-red-500/10 hover:bg-red-500/20 text-red-400 transition-colors" 
                                                title="åˆ é™¤">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Body -->
                                <div class="text-sm text-gray-200 leading-relaxed whitespace-pre-wrap select-text font-sans memory-content p-1">
                                    ${m.content}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // 4. æ·»åŠ äº‹ä»¶ç›‘å¬
                document.getElementById('memory-refresh-btn').onclick = () => WeChatUI.openMemoryLib();
                document.getElementById('memory-batch-delete-btn').onclick = () => WeChatUI.batchDeleteMemory(cid);

                const modal = document.getElementById('modal-memory-lib');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                }
            },

            // ç¼–è¾‘è®°å¿†
            editMemory: (cid, originalIdx) => {
                const card = document.getElementById(`memory-card-${originalIdx}`);
                if (!card) return;

                const contentDiv = card.querySelector('.memory-content');
                const actionDiv = card.querySelector('.memory-actions');
                const currentContent = contentDiv.innerText; // Use innerText to preserve line breaks basically

                // æ›¿æ¢ä¸ºç¼–è¾‘æ¡†
                contentDiv.innerHTML = `<textarea id="memory-edit-${originalIdx}" class="w-full h-32 bg-black/20 text-gray-300 p-2 rounded text-xs border border-white/10 resize-none focus:outline-none focus:border-green-500/50 leading-relaxed">${currentContent}</textarea>`;

                // æ›¿æ¢æŒ‰é’®ä¸ºä¿å­˜/å–æ¶ˆ
                actionDiv.innerHTML = `
                    <button onclick="WeChatUI.saveEditedMemory('${cid}', ${originalIdx})" 
                            class="text-green-400 opacity-80 hover:opacity-100 p-2 hover:text-green-300 transition-colors">
                        <i class="fa-solid fa-check"></i> ä¿å­˜
                    </button>
                    <button onclick="WeChatUI.cancelEditMemory()" 
                            class="text-gray-400 opacity-60 hover:opacity-100 p-2 hover:text-gray-300 transition-colors">
                        <i class="fa-solid fa-xmark"></i> å–æ¶ˆ
                    </button>
                `;
            },

            // ä¿å­˜ç¼–è¾‘åçš„è®°å¿†
            saveEditedMemory: (cid, originalIdx) => {
                const textarea = document.getElementById(`memory-edit-${originalIdx}`);
                if (!textarea) return;

                const newContent = textarea.value;
                if (!newContent.trim()) {
                    Utils.showToast('å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (char && char.memory && char.memory[originalIdx]) {
                    char.memory[originalIdx].content = newContent;
                    AppStorage.set('wechat_chars', chars);
                    Utils.showToast('è®°å¿†å·²æ›´æ–°');
                    WeChatUI.openMemoryLib(); // åˆ·æ–°åˆ—è¡¨
                }
            },

            // å–æ¶ˆç¼–è¾‘
            cancelEditMemory: () => {
                WeChatUI.openMemoryLib(); // ç®€å•åˆ·æ–°å³å¯æ¢å¤åŸçŠ¶
            },

            // åˆ é™¤å•æ¡è®°å¿†
            deleteMemory: (cid, idx) => {
                if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿ')) return;
                const chars = AppStorage.get('wechat_chars', {});
                if (chars[cid] && chars[cid].memory) {
                    chars[cid].memory.splice(idx, 1);
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.openMemoryLib(); // åˆ·æ–°æ˜¾ç¤º
                    Utils.showToast('å·²åˆ é™¤');
                }
            },

            // å¤åˆ¶è®°å¿†å†…å®¹
            copyMemoryContent: (content) => {
                navigator.clipboard.writeText(decodeURIComponent(content))
                    .then(() => {
                        Utils.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    })
                    .catch(() => {
                        Utils.showToast('å¤åˆ¶å¤±è´¥');
                    });
            },

            // æ‰¹é‡åˆ é™¤è®°å¿†
            batchDeleteMemory: (cid) => {
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].memory || chars[cid].memory.length === 0) {
                    return Utils.showToast('æš‚æ— è®°å¿†å¯åˆ é™¤');
                }

                if (!confirm(`ç¡®å®šåˆ é™¤æ‰€æœ‰è®°å¿†å—ï¼Ÿå…± ${chars[cid].memory.length} æ¡è®°å½•å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚`)) {
                    return;
                }

                chars[cid].memory = [];
                AppStorage.set('wechat_chars', chars);
                WeChatUI.openMemoryLib(); // åˆ·æ–°æ˜¾ç¤º
                Utils.showToast('å·²æ¸…ç©ºæ‰€æœ‰è®°å¿†');
            },

            // æ‰‹åŠ¨è§¦å‘æ€»ç»“
            triggerManualSummary: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char || !char.msgs || char.msgs.length === 0) {
                    Utils.showToast('æ²¡æœ‰å¯æ€»ç»“çš„èŠå¤©è®°å½•');
                    return;
                }

                // æ˜¾ç¤ºæ‰‹åŠ¨æ€»ç»“å¼¹çª—
                const modal = document.getElementById('modal-manual-summary');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex'; // Force flex display
                    console.log('Manual Summary Modal Triggered', modal);
                } else {
                    console.error('Manual Summary Modal NOT FOUND');
                }
            },

            // å–æ¶ˆæ‰‹åŠ¨æ€»ç»“
            cancelManualSummary: () => {
                const modal = document.getElementById('modal-manual-summary');
                modal.classList.add('hidden');
                modal.style.display = ''; // Clear inline style to allow CSS to hide it
            },

            // ç¡®è®¤æ‰‹åŠ¨æ€»ç»“
            confirmManualSummary: async () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;

                const rangeInput = document.getElementById('summary-range-input').value.trim();
                const rangeRegex = /^(\d+)-(\d+)$/;
                const match = String(rangeInput).match(rangeRegex);

                let startIndex, endIndex;

                if (match) {
                    // è§£æç”¨æˆ·è¾“å…¥çš„åŒºé—´
                    startIndex = parseInt(match[1]) - 1; // è½¬æ¢ä¸º0-basedç´¢å¼•
                    endIndex = parseInt(match[2]); // è½¬æ¢ä¸ºä¸åŒ…å«çš„ç»“æŸç´¢å¼•
                } else {
                    // é»˜è®¤æ€»ç»“æ‰€æœ‰æ¶ˆæ¯
                    startIndex = 0;
                    endIndex = undefined;
                }

                // éšè—å¼¹çª—
                const modal = document.getElementById('modal-manual-summary');
                modal.classList.add('hidden');
                modal.style.display = ''; // Clear inline style


                // ç”Ÿæˆæ€»ç»“
                await WeChatUI.generateSummary(cid, startIndex, endIndex);
            },

            // ç”Ÿæˆæ€»ç»“ - æ”¹è¿›ç‰ˆï¼šä½œä¸ºç‹¬ç«‹å·¥å…·ï¼Œå°†æŒ‡å®šæ¡æ•°èŠå¤©è®°å½•å‘ç»™AIå¤§æ¨¡å‹
            generateSummary: async (cid, startIndex = undefined, endIndex = undefined) => {
                if (WeChatUI.summaryLock) return;
                WeChatUI.summaryLock = true;

                try {
                    const chars = AppStorage.get('wechat_chars', {});
                    const char = chars[cid];
                    if (!char || !char.msgs || char.msgs.length === 0) return;

                    Utils.showToast('æ­£åœ¨åˆ†æä¸Šä¸‹æ–‡...');

                    const summaryPrompt = char.summaryPrompt || 'è¯·ä»¥ç¬¬ä¸‰äººç§°æ€»ç»“ä¸Šä¸‹æ–‡å¯¹è¯ä¸­çš„å…³é”®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸»è¦è¯é¢˜ã€é‡è¦äº‹ä»¶ã€äººç‰©å…³ç³»å’Œå…³é”®ç»†èŠ‚ï¼Œå­˜å…¥è®°å¿†åº“ã€‚ä¿æŒç®€æ´æ˜äº†ï¼Œé‡ç‚¹çªå‡ºã€‚';

                    const msgs = char.msgs;
                    let targetMsgs;

                    if (startIndex !== undefined && endIndex !== undefined) {
                        targetMsgs = msgs.slice(startIndex, endIndex);
                    } else if (startIndex !== undefined) {
                        targetMsgs = msgs.slice(startIndex);
                    } else {
                        const summaryLimit = char.summaryLimit || 50;
                        targetMsgs = msgs.slice(-summaryLimit);
                    }

                    // ä¸ºæ¯æ¡æ¶ˆæ¯æ·»åŠ æ—¶é—´æˆ³ï¼Œæ–¹ä¾¿AIç†è§£æ—¶åº
                    const formattedMsgs = targetMsgs.map(m => {
                        const timeStr = m.timestamp ? ` [${Utils.formatChatTime(m.timestamp)}]` : '';
                        const role = m.role === 'user' ? 'ç”¨æˆ·' : char.name;
                        let content = m.content || '';
                        if (m.type === 'image') content = '[ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡]';
                        else if (m.type === 'voice') content = `[è¯­éŸ³: ${m.text || 'è¯­éŸ³æ¶ˆæ¯'}]`;
                        else if (m.type === 'redpacket') content = `[çº¢åŒ…: ${m.note || 'çº¢åŒ…æ¶ˆæ¯'}]`;
                        else if (m.type === 'transfer') content = `[è½¬è´¦: ${m.amount || '0'}å…ƒ, å¤‡æ³¨: ${m.note || ''}]`;
                        return `${role}: ${content}${timeStr}`;
                    }).join('\n');

                    const summarySystemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¯¹è¯æ€»ç»“å°åŠ©æ‰‹ã€‚';
                    const summaryUserPrompt = `å¯¹è¯å†…å®¹ï¼š\n${formattedMsgs}\n\n${summaryPrompt}`;

                    const reply = await SettingsLogic.generateLLM([
                        { role: 'system', content: summarySystemPrompt },
                        { role: 'user', content: summaryUserPrompt }
                    ], cid, 'summarize');

                    if (reply) {
                        // ã€åŸå­åŒ–æ›´æ–°ä¿®å¤ã€‘é‡æ–°è¯»å–æœ€æ–°æ•°æ®ï¼Œé˜²æ­¢å›æ»šåœ¨ç”Ÿæˆæ€»ç»“æœŸé—´äº§ç”Ÿçš„æ–°æ¶ˆæ¯
                        const latestChars = AppStorage.get('wechat_chars', {});
                        const targetChar = latestChars[cid];
                        if (targetChar) {
                            // 1. ä¿å­˜æ€»ç»“åˆ°è®°å¿†åº“
                            if (!targetChar.memory) targetChar.memory = [];
                            targetChar.memory.push({
                                id: Date.now(),
                                type: 'summary',
                                content: reply.trim(),
                                timestamp: new Date().toISOString()
                            });

                            // 2. æ›´æ–°æœ€åæ€»ç»“çš„ç´¢å¼•
                            targetChar.lastSummaryIndex = endIndex !== undefined ? endIndex : targetChar.msgs.length;

                            // 3. ä¿å­˜å›ç£ç›˜
                            AppStorage.set('wechat_chars', latestChars);
                            console.log(`[è‡ªåŠ¨æ€»ç»“] æ€»ç»“å·²åŸå­åŒ–å­˜å…¥è®°å¿†åº“ï¼Œç´¢å¼•æ›´æ–°è‡³: ${targetChar.lastSummaryIndex}`);
                        }

                        Utils.showToast('æ€»ç»“å·²ç”Ÿæˆå¹¶å­˜å…¥è®°å¿†åº“');

                        if (document.getElementById('subpage-char-settings').classList.contains('active')) {
                            WeChatUI.openCharSettings();
                        }
                    }
                } catch (error) {
                    console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥:', error);
                    const errorMessage = error && error.message ? error.message : typeof error === 'string' ? error : 'æœªçŸ¥é”™è¯¯';
                    Utils.showToast('é”™è¯¯: ' + errorMessage);
                } finally {
                    WeChatUI.summaryLock = false;
                }
            },

            // ä¿å­˜æ€»ç»“åˆ°è®°å¿†åº“
            saveSummaryToMemory: (cid, summary) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char) return;

                // åˆå§‹åŒ–è®°å¿†åº“
                if (!char.memory) char.memory = [];

                // æ·»åŠ æ–°æ€»ç»“
                const memoryItem = {
                    id: Date.now(),
                    type: 'summary',
                    content: summary,
                    timestamp: new Date().toISOString()
                };

                char.memory.push(memoryItem);
                AppStorage.set('wechat_chars', chars);
            },

            // é€šç”¨è®°å¿†æ³¨å…¥å‡½æ•°
            injectMemory: (cid, content, type = 'summary') => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char) return;

                // åˆå§‹åŒ–è®°å¿†åº“
                if (!char.memory) char.memory = [];

                // æ·»åŠ æ–°è®°å¿†
                const memoryItem = {
                    id: Date.now(),
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString()
                };

                char.memory.push(memoryItem);
                AppStorage.set('wechat_chars', chars);
            },

            // è®°å¿†äº’é€šåŠŸèƒ½åˆå§‹åŒ–
            initMemoryLink: () => {
                // åˆå§‹åŒ–è®°å¿†äº’é€šè®¾ç½®
                const chars = AppStorage.get('wechat_chars', {});
                // ä¸ºæ¯ä¸ªè§’è‰²æ·»åŠ linkedMemorieså±æ€§ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                Object.values(chars).forEach(char => {
                    if (!char.linkedMemories) {
                        char.linkedMemories = [];
                    }
                    if (!char.linkMemoryDepth) {
                        char.linkMemoryDepth = 5;
                    }
                });
                AppStorage.set('wechat_chars', chars);

                // ç»‘å®šè®°å¿†äº’é€šé€‰æ‹©æ¡†äº‹ä»¶
                const selectBox = document.querySelector('.custom-multiselect .select-box');
                const checkboxesContainer = document.querySelector('.custom-multiselect .checkboxes-container');

                selectBox?.addEventListener('click', () => {
                    checkboxesContainer?.classList.toggle('hidden');
                });

                // ç‚¹å‡»å¤–éƒ¨å…³é—­é€‰æ‹©æ¡†
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-multiselect')) {
                        checkboxesContainer?.classList.add('hidden');
                    }
                });
            },

            // æ¸²æŸ“è®°å¿†äº’é€šé€‰æ‹©æ¡†
            renderMemoryLinkCheckboxes: (charId) => {
                const container = document.getElementById('memory-link-checkboxes-container');
                if (!container) return;

                const chars = AppStorage.get('wechat_chars', {});
                const currentChar = chars[charId];
                if (!currentChar) return;

                // è·å–æ‰€æœ‰å…¶ä»–è§’è‰²
                const otherChars = Object.values(chars).filter(char => char.id !== charId);

                if (otherChars.length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">æš‚æ— å…¶ä»–èŠå¤©å¯é“¾æ¥</div>';
                    return;
                }

                // æ¸²æŸ“é€‰æ‹©æ¡†
                container.innerHTML = otherChars.map(char => {
                    const isChecked = currentChar.linkedMemories?.includes(char.id) || false;
                    return `
                        <div class="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" id="memory-link-${char.id}" value="${char.id}" class="memory-link-checkbox" ${isChecked ? 'checked' : ''}>
                            <label for="memory-link-${char.id}" class="flex items-center gap-2 flex-1 cursor-pointer">
                                <img src="${char.avatar || 'https://via.placeholder.com/40'}" class="w-6 h-6 rounded-full object-cover">
                                <span class="text-sm">${char.name}</span>
                            </label>
                        </div>
                    `;
                }).join('');

                // ç»‘å®šé€‰æ‹©äº‹ä»¶
                container.querySelectorAll('.memory-link-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        WeChatUI.updateMemoryLink(charId, e.target.value, e.target.checked);
                    });
                });

                // è®¾ç½®è®°å¿†æ·±åº¦
                const depthInput = document.getElementById('link-memory-depth-input');
                if (depthInput) {
                    depthInput.value = currentChar.linkMemoryDepth || 5;
                    depthInput.addEventListener('change', (e) => {
                        WeChatUI.updateMemoryLinkDepth(charId, parseInt(e.target.value) || 5);
                    });
                }
            },

            // æ›´æ–°è®°å¿†é“¾æ¥
            updateMemoryLink: (charId, linkedCharId, isLinked) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return;

                if (!char.linkedMemories) {
                    char.linkedMemories = [];
                }

                if (isLinked) {
                    // æ·»åŠ é“¾æ¥
                    if (!char.linkedMemories.includes(linkedCharId)) {
                        char.linkedMemories.push(linkedCharId);
                    }
                } else {
                    // ç§»é™¤é“¾æ¥
                    char.linkedMemories = char.linkedMemories.filter(id => id !== linkedCharId);
                }

                AppStorage.set('wechat_chars', chars);
            },

            // æ›´æ–°è®°å¿†é“¾æ¥æ·±åº¦
            updateMemoryLinkDepth: (charId, depth) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (char) {
                    char.linkMemoryDepth = depth;
                    AppStorage.set('wechat_chars', chars);
                }
            },

            // è·å–é“¾æ¥è®°å¿†ä¸Šä¸‹æ–‡
            getLinkedMemoryContext: async (charId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char || !char.linkedMemories || char.linkedMemories.length === 0) {
                    return '';
                }

                const depth = char.linkMemoryDepth || 5;
                let linkedContext = '';

                // è·å–æ‰€æœ‰é“¾æ¥è§’è‰²çš„æœ€è¿‘æ¶ˆæ¯
                for (const linkedCharId of char.linkedMemories) {
                    const linkedChar = chars[linkedCharId];
                    if (!linkedChar || !linkedChar.msgs || linkedChar.msgs.length === 0) {
                        continue;
                    }

                    // è·å–æœ€è¿‘çš„depthæ¡æ¶ˆæ¯
                    const recentMsgs = linkedChar.msgs.slice(-depth);
                    if (recentMsgs.length === 0) {
                        continue;
                    }

                    // æ ¼å¼åŒ–æ¶ˆæ¯
                    const formattedMsgs = recentMsgs.map(msg => {
                        const sender = msg.role === 'user' ? 'æˆ‘' : linkedChar.name;
                        return `  - ${sender}: ${msg.content}`;
                    }).join('\n');

                    linkedContext += `\n## é™„åŠ ä¸Šä¸‹æ–‡ï¼šæ¥è‡ªä¸â€œ${linkedChar.name}â€çš„æœ€è¿‘å¯¹è¯å†…å®¹ (ä»…ä½ å¯è§)\n${formattedMsgs}`;
                }

                return linkedContext;
            },

            // é€šçŸ¥è§’è‰²å…³äºç”¨æˆ·çš„æ–°æœ‹å‹åœˆ


            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ€»ç»“
            checkAutoSummary: (cid) => {
                // å¦‚æœæ­£åœ¨æ€»ç»“ä¸­ï¼Œç›´æ¥è·³è¿‡ï¼Œé˜²æ­¢å¹¶å‘
                if (WeChatUI.summaryLock) return;

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char || !char.autoSummary) return;

                const msgs = char.msgs || [];
                const summaryLimit = parseInt(char.summaryLimit) || 50;
                const lastSummaryIndex = char.lastSummaryIndex || 0;

                // åªæœ‰å½“è·ç¦»ä¸Šæ¬¡æ€»ç»“åˆå¢åŠ äº†è¶³å¤Ÿçš„æ¡æ•°æ—¶æ‰è§¦å‘
                // è§£å†³ä¹‹å‰å› ä¸º msgs.length % limit === 0 å¯¼è‡´çš„æç«¯æƒ…å†µå¤±æ§
                if (msgs.length - lastSummaryIndex >= summaryLimit) {
                    console.log(`[è‡ªåŠ¨æ€»ç»“] è§¦å‘æ¡ä»¶æ»¡è¶³: æ¡æ•°(${msgs.length - lastSummaryIndex}) >= é˜ˆå€¼(${summaryLimit})`);
                    WeChatUI.generateSummary(cid);
                }
            },

            // å¯¼å‡ºèŠå¤©è®°å½•
            exportChatHistory: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char || !char.msgs || char.msgs.length === 0) {
                    Utils.showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„èŠå¤©è®°å½•');
                    return;
                }

                // æ„å»ºèŠå¤©è®°å½•æ–‡æœ¬
                let chatText = `${char.name} èŠå¤©è®°å½•\n`;
                chatText += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;

                char.msgs.forEach(msg => {
                    const time = new Date(msg.timestamp || Date.now()).toLocaleString();
                    const role = msg.role === 'user' ? 'æˆ‘' : char.name;
                    chatText += `${time} ${role}: ${msg.content}\n\n`;
                });

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${char.name}_èŠå¤©è®°å½•_${new Date().getTime()}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                Utils.showToast('èŠå¤©è®°å½•å·²å¯¼å‡º');
            },

            // å¯¼å…¥èŠå¤©è®°å½•
            importChatHistory: () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        WeChatUI.parseImportedChat(content);
                    };
                    reader.readAsText(file, 'utf-8');
                };
                input.click();
            },

            // è§£æå¯¼å…¥çš„èŠå¤©è®°å½•
            parseImportedChat: (content) => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char) return;

                // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„èŠå¤©è®°å½•æ ¼å¼è¿›è¡Œè§£æ
                // æš‚æ—¶ç®€å•å¤„ç†ï¼Œå°†æ¯è¡Œä½œä¸ºä¸€æ¡æ¶ˆæ¯
                const lines = content.split('\n').filter(line => line.trim());
                const importedMsgs = [];

                lines.forEach(line => {
                    // ç®€å•åˆ¤æ–­æ¶ˆæ¯è§’è‰²
                    if (line.includes('æˆ‘:')) {
                        importedMsgs.push({
                            role: 'user',
                            content: line.replace(/^.*æˆ‘:/, '').trim(),
                            timestamp: Date.now()
                        });
                    } else if (line.includes(char.name + ':')) {
                        importedMsgs.push({
                            role: 'ai',
                            content: line.replace(new RegExp(`^.*${char.name}:`), '').trim(),
                            timestamp: Date.now()
                        });
                    }
                });

                // è¦†ç›–èŠå¤©è®°å½•ï¼ˆè€Œä¸æ˜¯åˆå¹¶ï¼‰
                char.msgs = importedMsgs;

                AppStorage.set('wechat_chars', chars);
                Utils.showToast(`æˆåŠŸå¯¼å…¥ ${importedMsgs.length} æ¡èŠå¤©è®°å½•`);

                // æ›´æ–°èŠå¤©ç•Œé¢
                if (document.getElementById('subpage-chat-detail').classList.contains('active')) {
                    WeChatUI.loadChat(cid);
                }
            },
            handleChatBgFile: (input) => {
                if (input.files[0])
                    // ä¿®æ”¹ï¼šèŠå¤©èƒŒæ™¯å¼ºåˆ¶é«˜æ¸… 1080px
                    Utils.compressImage(input.files[0], 1080, 0.8).then(base64 => {
                        document.getElementById('char-chat-bg').value = base64;
                        WeChatUI.updateBgPreview();
                    });
            },

            updateBgPreview: () => {
                const url = document.getElementById('char-chat-bg').value;
                const rawCss = document.getElementById('char-bubble-css').value; // è·å–è¾“å…¥æ¡†å†…å®¹
                const blur = document.getElementById('char-bg-blur').value;
                const opacity = document.getElementById('char-bg-opacity').value;
                const fontSize = document.getElementById('char-bubble-size').value;
                // è·å–å½“å‰è§’è‰²ä¿¡æ¯ï¼Œç”¨äºæ˜¾ç¤ºè‡ªå®šä¹‰å¤´åƒ
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];

                const previewContainer = document.querySelector('.bg-preview-container');
                const bgEl = document.getElementById('preview-chat-bg');

                // ç¡®ä¿é¢„è§ˆå®¹å™¨æ˜¯ç™½è‰²èƒŒæ™¯
                if (previewContainer) {
                    previewContainer.style.background = 'white';
                    previewContainer.style.overflow = 'hidden';
                    previewContainer.style.padding = '0';
                }

                // prefer the explicit input URL, then the character's saved chatBg, then global wallpaper
                let bgSource = url || (c && c.chatBg) || '';
                if (bgEl) {
                    if (bgSource) {
                        // å¦‚æœæœ‰è‡ªå®šä¹‰èƒŒæ™¯å›¾ï¼Œç›´æ¥æ˜¾ç¤º
                        if (/^url\(/.test(bgSource.trim())) {
                            bgEl.style.backgroundImage = bgSource;
                        } else {
                            bgEl.style.backgroundImage = `url(${bgSource})`;
                        }
                        bgEl.style.backgroundColor = 'white';
                        bgEl.style.backgroundSize = 'cover';
                        bgEl.style.backgroundPosition = 'center';
                        bgEl.style.backgroundRepeat = 'no-repeat';
                        bgEl.style.backgroundBlendMode = 'normal';
                    } else {
                        // æ²¡æœ‰è‡ªå®šä¹‰èƒŒæ™¯å›¾æ—¶ï¼Œåªæ˜¾ç¤ºç™½è‰²èƒŒæ™¯
                        bgEl.style.backgroundImage = 'none';
                        bgEl.style.backgroundColor = 'white';
                    }
                    bgEl.style.filter = `blur(${blur}px)`;
                    bgEl.style.opacity = opacity;
                    bgEl.style.zIndex = '0';
                }

                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è§£æåŒæ‹¼ CSS å¹¶åˆ†åˆ«åº”ç”¨åˆ°é¢„è§ˆ
                const cssParts = rawCss.split('|||');
                const cssOther = cssParts[0] || ''; // å¯¹æ–¹
                const cssSelf = cssParts[1] || cssParts[0] || ''; // è‡ªå·±

                const styleStrSelf = `${cssSelf}; font-size: ${fontSize}px;`;
                const styleStrOther = `${cssOther}; font-size: ${fontSize}px;`;

                document.getElementById('preview-bubble-self').style.cssText = styleStrSelf;
                document.getElementById('preview-bubble-other').style.cssText = styleStrOther;

                const shape = document.getElementById('char-avatar-shape').value;
                const cls = shape === 'circle' ? 'rounded-full' : 'rounded-md';

                // ä¸ºé¢„è§ˆå¤´åƒæ·»åŠ å›¾ç‰‡
                const previewAvatarOther = document.getElementById('preview-avatar-other');
                const previewAvatarSelf = document.getElementById('preview-avatar-self');

                // ç¡®ä¿å¤´åƒå®¹å™¨æœ‰æ­£ç¡®çš„æ ·å¼
                previewAvatarOther.className = `msg-avatar ${cls}`;
                previewAvatarSelf.className = `msg-avatar ${cls}`;

                // æ·»åŠ åŸºç¡€æ ·å¼ç¡®ä¿å¤´åƒå®¹å™¨å¯è§
                previewAvatarOther.style.width = '40px';
                previewAvatarOther.style.height = '40px';
                previewAvatarOther.style.backgroundColor = '#f0f0f0'; // é»˜è®¤ç°è‰²èƒŒæ™¯
                previewAvatarOther.style.display = 'flex';
                previewAvatarOther.style.alignItems = 'center';
                previewAvatarOther.style.justifyContent = 'center';

                previewAvatarSelf.style.width = '40px';
                previewAvatarSelf.style.height = '40px';
                previewAvatarSelf.style.backgroundColor = '#f0f0f0'; // é»˜è®¤ç°è‰²èƒŒæ™¯
                previewAvatarSelf.style.display = 'flex';
                previewAvatarSelf.style.alignItems = 'center';
                previewAvatarSelf.style.justifyContent = 'center';

                // è®¾ç½®å¤´åƒå›¾ç‰‡ï¼šä½¿ç”¨è§’è‰²çš„è‡ªå®šä¹‰å¤´åƒï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨éšæœºå¤´åƒ
                let otherImg = previewAvatarOther.querySelector('img');
                let selfImg = previewAvatarSelf.querySelector('img');

                // å¦‚æœæ²¡æœ‰imgå…ƒç´ ï¼Œåˆ›å»ºä¸€ä¸ª
                if (!otherImg) {
                    otherImg = document.createElement('img');
                    otherImg.style.width = '100%';
                    otherImg.style.height = '100%';
                    otherImg.style.objectFit = 'cover';
                    otherImg.style.borderRadius = shape === 'circle' ? '50%' : '8px';
                    previewAvatarOther.appendChild(otherImg);
                }
                if (!selfImg) {
                    selfImg = document.createElement('img');
                    selfImg.style.width = '100%';
                    selfImg.style.height = '100%';
                    self.style.objectFit = 'cover';
                    selfImg.style.borderRadius = shape === 'circle' ? '50%' : '8px';
                    previewAvatarSelf.appendChild(selfImg);
                }

                // è·å–ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼ˆä½¿ç”¨æ­£ç¡®çš„å­˜å‚¨é”®åï¼‰
                const userProfile = AppStorage.get('wechat_user_profile', {});

                if (otherImg) {
                    // å¯¹æ–¹å¤´åƒï¼šä¼˜å…ˆä½¿ç”¨è¾“å…¥æ¡†ä¸­çš„æœ€æ–°æ•°æ®ï¼Œç„¶åæ˜¯è§’è‰²ä¿å­˜çš„æ•°æ®ï¼Œæœ€åæ˜¯éšæœºå¤´åƒ
                    const otherAvatar = document.getElementById('char-avatar-data').value || (c && c.avatar) || WeChatUI.getRandomAvatar();
                    otherImg.src = otherAvatar;
                    otherImg.style.display = 'block';
                    // æ·»åŠ é”™è¯¯å¤„ç†
                    otherImg.onerror = function () {
                        this.src = WeChatUI.getRandomAvatar();
                    };
                }
                if (selfImg) {
                    // è‡ªå·±å¤´åƒï¼šä¼˜å…ˆä½¿ç”¨è¾“å…¥æ¡†ä¸­çš„æœ€æ–°æ•°æ®ï¼Œç„¶åæ˜¯è§’è‰²ä¿å­˜çš„æ•°æ®ï¼Œæœ€åæ˜¯å…¨å±€userProfileçš„avatarï¼Œæœ€åæ˜¯éšæœºå¤´åƒ
                    const selfAvatar = document.getElementById('user-avatar-data').value || (c && c.userAvatar) || userProfile.avatar || WeChatUI.getRandomAvatar();
                    selfImg.src = selfAvatar;
                    selfImg.style.display = 'block';
                    // æ·»åŠ é”™è¯¯å¤„ç†
                    selfImg.onerror = function () {
                        this.src = WeChatUI.getRandomAvatar();
                    };
                }
            },

            loadPresetsList: () => {
                const presets = AppStorage.get('bubble_presets', {}); const sel = document.getElementById('bubble-preset-select');
                sel.innerHTML = '<option value="" disabled selected>é€‰æ‹©é¢„è®¾...</option>' + Object.keys(presets).map(k => `<option value="${k}">${k}</option>`).join('');
            },
            saveBubblePreset: () => {
                Utils.showPrompt('ä¿å­˜é¢„è®¾', 'è¾“å…¥é¢„è®¾åç§°:', (name) => {
                    if (!name) return;
                    const presets = AppStorage.get('bubble_presets', {});
                    presets[name] = { css: document.getElementById('char-bubble-css').value, fontSize: document.getElementById('char-bubble-size').value };
                    AppStorage.set('bubble_presets', presets);
                    WeChatUI.loadPresetsList();
                });
            },
            loadBubblePreset: () => {
                const name = document.getElementById('bubble-preset-select').value; const presets = AppStorage.get('bubble_presets', {});
                if (presets[name]) { document.getElementById('char-bubble-css').value = presets[name].css; document.getElementById('char-bubble-size').value = presets[name].fontSize; WeChatUI.updateBgPreview(); }
            },
            deleteBubblePreset: () => {
                const name = document.getElementById('bubble-preset-select').value; if (!name) return;
                const presets = AppStorage.get('bubble_presets', {}); delete presets[name]; AppStorage.set('bubble_presets', presets); WeChatUI.loadPresetsList();
            },
            // åˆ‡æ¢é€šè®¯å½•åˆ†ç±»çš„å±•å¼€/æ”¶èµ·çŠ¶æ€
            toggleContactsCategory: (category) => {
                const categoryElement = document.getElementById(`${category}-category`);
                const toggleIcon = document.getElementById(`${category}-toggle-icon`);

                if (categoryElement && toggleIcon) {
                    if (categoryElement.style.display === 'none') {
                        // å±•å¼€
                        categoryElement.style.display = 'block';
                        toggleIcon.classList.remove('fa-chevron-up');
                        toggleIcon.classList.add('fa-chevron-down');
                    } else {
                        // æ”¶èµ·
                        categoryElement.style.display = 'none';
                        toggleIcon.classList.remove('fa-chevron-down');
                        toggleIcon.classList.add('fa-chevron-up');
                    }
                }
            },

            renderList: () => {
                // åˆå§‹åŒ–é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
                WeChatUI.initLongPress();

                const chars = AppStorage.get('wechat_chars', {});
                const npcs = AppStorage.get('wechat_npcs', {});

                // è·å–æ‰€æœ‰è§’è‰²ï¼Œè¿‡æ»¤æ‰å·²åˆ é™¤çš„è§’è‰²ï¼Œå¹¶æŒ‰ç½®é¡¶çŠ¶æ€å’Œæœ€åèŠå¤©æ—¶é—´æ’åº - ç”¨äºèŠå¤©åˆ—è¡¨
                const chatChars = Object.values(chars)
                    .filter(char => !char.deleted) // èŠå¤©åˆ—è¡¨åªæ˜¾ç¤ºæœªåˆ é™¤çš„è§’è‰²
                    .sort((a, b) => {
                        // å…ˆæŒ‰ç½®é¡¶çŠ¶æ€æ’åºï¼Œç½®é¡¶è§’è‰²åœ¨å‰
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;

                        // å†æŒ‰æœ€åèŠå¤©æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                        const aLastMsgTime = a.msgs && a.msgs.length > 0 ? Math.max(...a.msgs.map(m => m.timestamp || 0)) : 0;
                        const bLastMsgTime = b.msgs && b.msgs.length > 0 ? Math.max(...b.msgs.map(m => m.timestamp || 0)) : 0;
                        return bLastMsgTime - aLastMsgTime;
                    });

                // è·å–æ‰€æœ‰è§’è‰²ï¼ŒæŒ‰åç§°æ’åº - ç”¨äºé€šè®¯å½•åˆ—è¡¨
                const allChars = Object.values(chars)
                    .sort((a, b) => {
                        // æŒ‰åç§°æ’åº
                        const nameA = a.nickname || a.name || 'æœªå‘½å';
                        const nameB = b.nickname || b.name || 'æœªå‘½å';
                        return nameA.localeCompare(nameB);
                    });

                // æ¸²æŸ“èŠå¤©åˆ—è¡¨
                const html = chatChars.map(c => {
                    const lastMsg = c.msgs && c.msgs.length > 0 ? c.msgs[c.msgs.length - 1] : null;
                    let previewText = '';
                    if (lastMsg) {
                        if (lastMsg.type === 'image' || lastMsg.type === 'emoji') previewText = '[å›¾ç‰‡]';
                        else if (lastMsg.type === 'voice') previewText = '[è¯­éŸ³]';
                        else if (lastMsg.type === 'transfer') previewText = '[è½¬è´¦]';
                        else if (lastMsg.type === 'redpacket') previewText = '[çº¢åŒ…]';
                        else {
                            // Strip HTML tags and limit length to prevent overflow
                            const text = String(lastMsg.content || '').replace(/<[^>]*>/g, '').trim();
                            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¡¨æƒ…åŒ…
                            if (text.includes('è¡¨æƒ…åŒ…') || lastMsg.content && lastMsg.content.includes('<img')) {
                                previewText = '[å›¾ç‰‡]';
                            } else {
                                previewText = text || '';
                            }
                        }
                    }
                    const timeDisplay = lastMsg && lastMsg.timestamp ? Utils.formatChatTime(lastMsg.timestamp) : '';
                    const unreadBadge = c.unread > 0 ? `<span class="ml-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${c.unread}</span>` : '';

                    // ä½¿ç”¨æ˜µç§°æ˜¾ç¤ºï¼Œæ²¡æœ‰æ˜µç§°åˆ™ä½¿ç”¨è§’è‰²å
                    const displayName = c.nickname || c.name;
                    return `<div onclick="WeChatUI.openChatDetail('${c.id}')" oncontextmenu="WeChatUI.showContactMenu(event, '${c.id}', 'chat')" class="flex items-center gap-3 p-4 border-b border-gray-200 active:bg-gray-100 cursor-pointer relative ${c.pinned ? 'bg-gray-50' : ''}"><div class="avatar-box"><img src="${c.avatar || WeChatUI.getRandomAvatar()}"></div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline"><span class="font-medium text-base text-gray-900">${displayName}</span><div class="flex items-center"><span class="text-xs text-gray-500">${timeDisplay}</span>${unreadBadge}</div></div><div class="text-sm text-gray-600 truncate">${previewText}</div></div></div>`;
                }).join('');
                document.getElementById('tab-chat').innerHTML = html || '<div class="text-gray-500 text-center mt-10 text-xs">æš‚æ— æ¶ˆæ¯</div>';

                // Render contacts tab with separate friend and NPC categories
                let contactsHtml = '';

                // å¥½å‹åˆ—è¡¨ (åˆ›å»ºçš„è§’è‰²) - ä½¿ç”¨æ‰€æœ‰è§’è‰²ï¼ŒåŒ…æ‹¬å·²åˆ é™¤çš„
                const friendsHtml = allChars.map(char => {
                    // ä½¿ç”¨æ˜µç§°æ˜¾ç¤ºï¼Œæ²¡æœ‰æ˜µç§°åˆ™ä½¿ç”¨è§’è‰²å
                    const displayName = char.nickname || char.name;
                    return `<div onclick="WeChatUI.openChatDetail('${char.id}')" oncontextmenu="WeChatUI.showContactMenu(event, '${char.id}', 'contact')" class="flex items-center gap-3 p-3 border-b border-gray-200/50 active:bg-gray-100 cursor-pointer rounded-lg">
                        <div class="avatar-box"><img src="${char.avatar || WeChatUI.getRandomAvatar()}"></div>
                        <span class="text-gray-900">${displayName}</span>
                    </div>`;
                }).join('');

                // NPCåˆ—è¡¨
                const allNPCs = Object.values(npcs);
                const npcsHtml = allNPCs.map(npc => {
                    // æ‰¾åˆ°å…³è”çš„è§’è‰²ï¼Œç”¨äºæ‰“å¼€èŠå¤© - ä½¿ç”¨æ‰€æœ‰è§’è‰²ï¼ŒåŒ…æ‹¬å·²åˆ é™¤çš„
                    const associatedChar = allChars.find(char => char.id === npc.associatedChar);
                    if (!associatedChar) return '';

                    return `<div onclick="WeChatUI.openNPCChat('${npc.id}', '${associatedChar.id}')" class="flex items-center gap-3 p-3 border-b border-gray-200/50 active:bg-gray-100 cursor-pointer rounded-lg">
                        <div class="w-8 h-8 rounded-full overflow-hidden">
                            <img src="${npc.avatar || WeChatUI.getRandomAvatar()}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <div class="text-gray-900">${npc.name}</div>
                            <div class="text-xs text-gray-500">${npc.type} | ${associatedChar.name}çš„${npc.type === 'friend' ? 'æœ‹å‹' : npc.type === 'family' ? 'å®¶äºº' : npc.type === 'colleague' ? 'åŒäº‹' : 'é™Œç”Ÿäºº'}</div>
                        </div>
                    </div>`;
                }).join('');

                // æ„å»ºæŠ˜å èœå•
                contactsHtml += `
                    <!-- å¥½å‹åˆ†ç±» -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between p-3 bg-gray-100 cursor-pointer rounded-t-lg" onclick="WeChatUI.toggleContactsCategory('friends')">
                            <h3 class="font-medium text-gray-900 flex items-center gap-2"><i class="fa-solid fa-user-group"></i>å¥½å‹</h3>
                            <i class="fa-solid fa-chevron-down text-gray-500" id="friends-toggle-icon"></i>
                        </div>
                        <div id="friends-category" class="bg-white rounded-b-lg overflow-hidden">
                            ${friendsHtml || '<div class="text-gray-500 text-center p-4 text-xs">æš‚æ— å¥½å‹</div>'}
                        </div>
                    </div>
                    
                    <!-- NPCåˆ†ç±» -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between p-3 bg-gray-100 cursor-pointer rounded-t-lg" onclick="WeChatUI.toggleContactsCategory('npcs')">
                            <h3 class="font-medium text-gray-900 flex items-center gap-2"><i class="fa-solid fa-robot"></i>NPC</h3>
                            <i class="fa-solid fa-chevron-down text-gray-500" id="npcs-toggle-icon"></i>
                        </div>
                        <div id="npcs-category" class="bg-white rounded-b-lg overflow-hidden">
                            ${npcsHtml || '<div class="text-gray-500 text-center p-4 text-xs">æš‚æ— NPC</div>'}
                        </div>
                    </div>`;
                document.getElementById('contacts-list-container').innerHTML = contactsHtml;
            },
            openChatDetail: (id) => {
                const chars = AppStorage.get('wechat_chars', {});
                if (chars[id]) {
                    chars[id].unread = 0;
                    AppStorage.set('wechat_chars', chars);
                }
                WeChatUI.renderList();
                WeChatUI.loadChat(id);
                document.getElementById('subpage-chat-detail').dataset.charId = id;
                document.getElementById('subpage-chat-detail').dataset.npcId = '';
                document.getElementById('subpage-chat-detail').classList.add('active');
                HistoryManager.push('subpage-chat-detail');
            },
            openNPCChat: (npcId, charId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                const npcs = AppStorage.get('wechat_npcs', {});
                const npc = npcs[npcId];
                if (!char || !npc) return;
                document.getElementById('subpage-chat-detail').dataset.charId = charId;
                document.getElementById('subpage-chat-detail').dataset.npcId = npcId;
                document.getElementById('chat-title').textContent = char.nickname || npc.name;
                WeChatUI.loadChat(charId, npcId);
                document.getElementById('subpage-chat-detail').classList.add('active');
                WeChatUI.renderList();
            },
            currentLoadedMsgs: {},
            splitMessageSentences: (msg) => {
                if (!msg) return [];
                let protectedBlocks = [];
                let tempText = msg.replace(/<(style|script|pre)[\s\S]*?<\/\1>/gi, (match) => {
                    const placeholder = `%%%PROTECTED_Block_${protectedBlocks.length}%%%`;
                    protectedBlocks.push(match);
                    return placeholder;
                });
                const DELIM = '%%%SHEAR%%%';
                tempText = tempText.replace(/\n+/g, DELIM);
                // ã€æ ¸å¿ƒä¿®å¤ã€‘è¯†åˆ«è¡¨æƒ…åŒ…æ ‡ç­¾å¹¶å¼ºåˆ¶æ‹†åˆ† bubbleï¼Œç¡®ä¿å®ƒä»¬ä½œä¸ºç‹¬ç«‹æ°”æ³¡æ¸²æŸ“
                tempText = tempText.replace(/(\[(?:è¡¨æƒ…åŒ…|è¡¨æƒ…):\s*.*?\])/g, `${DELIM}$1${DELIM}`);
                tempText = tempText.replace(/([ã€‚ï¼ï¼Ÿ!?]+)(\s+|$)/g, `$1${DELIM}`);
                tempText = tempText.replace(/([\)ï¼‰\]ã€‘\}])([^\s])(?![^<]*>)/g, `$1${DELIM}$2`);
                tempText = tempText.replace(/([^\s\(\[ï¼ˆã€\{])([\(ï¼ˆ\[ã€\{])(?![^<]*>)/g, `$1${DELIM}$2`);
                tempText = tempText.replace(/([\)ï¼‰\]ã€‘\}])([ã€‚ï¼ï¼Ÿ!?]*)\s+([\(ï¼ˆ\[ã€\{])/g, (match, p1, p2, p3) => {
                    if (match.includes('<') || match.includes('>')) return match;
                    return `${p1}${p2}${DELIM}${p3}`;
                });
                tempText = tempText.replace(new RegExp(`${DELIM}\\s*(%%%PROTECTED_Block_\\d+%%%)`, 'g'), '$1');
                let sentences = tempText.split(DELIM);
                sentences = sentences.map(s => s.trim()).filter(s => s.length > 0);
                if (sentences.length === 1 && sentences[0].length > 100 && protectedBlocks.length === 0) {
                    const backup = sentences[0].replace(/([ã€‚ï¼ï¼Ÿ!?]+)/g, `$1${DELIM}`);
                    sentences = backup.split(DELIM).map(s => s.trim()).filter(s => s.length > 0);
                }
                sentences = sentences.map(part => part.replace(/%%%PROTECTED_Block_(\d+)%%%/g, (match, index) => protectedBlocks[parseInt(index)] || match));
                return sentences;
            },
            // ã€æ ¸å¿ƒä¿®å¤ã€‘æ¸²æŸ“å•æ¡æ¶ˆæ¯åˆ°å®¹å™¨
            renderMessage: (container, m, id, originalIdx = -1, cachedChars = null, cachedUserProfile = null) => {
                if (!container || !m) return;
                // æ€§èƒ½ä¼˜åŒ–ï¼šä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„ç¼“å­˜æ•°æ®
                const chars = cachedChars || AppStorage.get('wechat_chars', {});
                const c = chars[id];
                if (!c) return;

                const userProfile = cachedUserProfile || AppStorage.get('wechat_user_profile', {});
                const isSelf = m.role === 'user';
                const avatar = isSelf ? (c.userAvatar || userProfile.avatar || WeChatUI.getRandomAvatar()) : (c.avatar || WeChatUI.getRandomAvatar());
                const shapeClass = c.avatarShape === 'circle' ? 'circle' : 'square';

                const rawCss = c.bubbleCss || '';
                const cssParts = rawCss.split('|||');
                const cssOther = cssParts[0] || '';
                const cssSelf = cssParts[1] || cssParts[0] || '';
                const targetCss = isSelf ? cssSelf : cssOther;

                const msgTime = m.timestamp || Date.now();
                const timeStr = new Date(msgTime).toTimeString().slice(0, 5);

                let contentHtml = m.content || '';
                let useBubble = true;
                let bubbleClass = 'chat-bubble';

                const isHidden = m.hidden === true;
                const hiddenStyle = isHidden ? ' style="display:none"' : '';

                if (m.type === 'call_log') {
                    const isVideo = m.content && m.content.includes('è§†é¢‘');
                    const iconClass = isVideo ? 'fa-video' : 'fa-phone-volume';
                    const html = `
                        <div class="msg-row ${isSelf ? 'self' : 'other'} animate-in fade-in slide-in-from-bottom-2 duration-300" data-msg-id="${m.id}" oncontextmenu="WeChatUI.showContextMenu(event, '${m.id}')" ${hiddenStyle}>
                            <div class="msg-avatar ${shapeClass}"><img src="${avatar}"></div>
                            <div class="msg-content">
                                <div class="chat-bubble call-log-bubble" style="${targetCss}; display: flex; align-items: center; gap: 10px; padding: 10px 14px;">
                                    <i class="fa-solid ${iconClass} text-lg"></i>
                                    <span style="font-size: 14px;">${m.content || 'é€šè¯ç»“æŸ'}</span>
                                </div>
                                <div class="msg-time-outside" style="display:none">${timeStr}</div>
                            </div>
                        </div>`;
                    return container.insertAdjacentHTML('beforeend', html);
                }

                if (m.role === 'system' || m.type === 'system') {
                    // è¿‡æ»¤æ’¤å›/åˆ é™¤ç­‰æç¤ºçš„å†—ä½™æ—¶é—´æˆ³ï¼ˆå¦‚æœæœ‰ï¼‰
                    contentHtml = contentHtml.replace(/\[\d{2}:\d{2}\]$/, '');
                    return container.insertAdjacentHTML('beforeend', `<div class="msg-system" oncontextmenu="WeChatUI.showContextMenu(event, '${m.id}')" ${hiddenStyle}><span>${contentHtml}</span></div>`);
                }

                if (m.type === 'voice') {
                    useBubble = false;
                    let seconds = m.duration || Math.ceil((m.text || '').length / 5) || 1;
                    if (seconds > 60) seconds = 60;
                    let bubbleWidth = 80 + (seconds * 3);
                    contentHtml = `<div class="voice-container"><div class="chat-bubble ${m.playing ? 'voice-playing' : ''}" style="${targetCss}; width: ${bubbleWidth}px; min-height: 40px; border-radius: ${isSelf ? '12px 2px 12px 12px' : '2px 12px 12px 12px'}; cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 0 12px;" onclick="WeChatUI.toggleVoiceText(${originalIdx}, '${id}', '${m.role}')"><div class="voice-icon" style="font-size: 16px;"><i class="fa-solid fa-wifi rotate-90"></i></div><span class="voice-duration" style="font-weight: bold; font-size: 14px;">${seconds}"</span></div><div class="voice-text ${m.expanded ? 'expanded' : ''}">${m.text}</div></div>`;
                } else if (m.type === 'image') {
                    const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                    const allEmojis = [...globalEmojis, ...(c.emojis || [])];

                    let displayUrl = m.content;
                    let isEmoji = false;

                    // ã€æ ¸å¿ƒä¿®å¤ã€‘å°è¯•ä»æ ‡ç­¾ä¸­è§£æ URL [è¡¨æƒ…åŒ…: åç§°]
                    const tagMatch = String(m.content).match(/^\[(?:è¡¨æƒ…åŒ…|è¡¨æƒ…):\s*(.*?)\]$/);
                    if (tagMatch) {
                        const name = tagMatch[1];
                        const found = allEmojis.find(e => e.name === name);
                        if (found) {
                            displayUrl = found.url;
                            isEmoji = true;
                        }
                    } else if (m.content.startsWith('http') || m.content.startsWith('data:')) {
                        // å¦‚æœæ˜¯ç›´æ¥ URLï¼Œæ£€æŸ¥å®ƒæ˜¯å¦å±äºè¡¨æƒ…åº“ä»¥ç¡®å®šå°ºå¯¸
                        isEmoji = allEmojis.some(e => e.url === m.content);
                    }

                    contentHtml = `<div class="msg-image ${isEmoji ? 'emoji' : ''}" style="${isEmoji ? 'width: 120px; height: 120px;' : 'width: 100%; max-width: 300px;'}"><img src="${displayUrl}" style="width:100%; height:100%; object-fit:contain; border-radius:8px;" onclick="window.open(this.src, '_blank')"></div>`;
                    useBubble = false;
                } else if (m.type === 'transfer' || m.type === 'redpacket') {
                    bubbleClass += (m.type === 'transfer') ? ' bubble-transfer' : ' bubble-redpacket';
                    const amount = m.amount || '0.00';
                    const note = m.note || ((m.type === 'transfer') ? 'è½¬è´¦' : 'æ­å–œå‘è´¢');
                    const statusText = m.status === 'received' ? ((m.type === 'transfer') ? 'å·²æ”¶æ¬¾' : 'å·²é¢†å–') : (m.status === 'rejected' ? 'å·²é€€è¿˜' : ((m.type === 'transfer') ? 'å¾®ä¿¡è½¬è´¦' : 'å¾®ä¿¡çº¢åŒ…'));
                    const icon = (m.type === 'transfer') ? 'fa-arrow-right-arrow-left' : 'fa-envelope';
                    contentHtml = `<div class="pay-card ${m.status ? 'received' : ''}" onclick="WeChatUI.handlePaymentClick(${originalIdx}, '${m.type}', '${m.role}')"><div class="pay-top"><div class="pay-icon"><i class="fa-solid ${icon}"></i></div><div class="pay-info"><div class="pay-title">${(m.type === 'transfer') ? 'Â¥' + amount : note}</div><div class="pay-info-desc">${(m.type === 'transfer') ? note : 'é¢†å–çº¢åŒ…'}</div></div></div><div class="pay-bottom">${statusText}</div></div>`;
                } else if (m.type === 'share' || m.type === 'moment_card') {
                    useBubble = false;
                    let shareData = m.content;
                    if (typeof shareData === 'string' && shareData.startsWith('{')) {
                        try { shareData = JSON.parse(shareData); } catch (e) { }
                    }
                    const text = shareData.text || 'åˆ†äº«äº†ä¸€æ¡æœ‹å‹åœˆ';
                    const image = shareData.image || '';
                    const author = shareData.author || 'å¥½å‹';
                    contentHtml = `
                        <div class="moment-share-card" 
                             onclick="window.subviewManager.open('subpage-moments'); setTimeout(() => { const target = document.querySelector('[data-moment-id=\\'${shareData.id || shareData.momentId || ''}\\']'); if(target) target.scrollIntoView({behavior:'smooth'}); }, 500)">
                            ${image ? `<img src="${image}" class="w-full h-32 object-cover bg-gray-50 shadow-inner">` : ''}
                            <div class="p-3">
                                <div class="text-sm font-medium text-gray-800 line-clamp-2 leading-snug mb-2">${text}</div>
                                <div class="flex items-center gap-1 text-[10px] text-gray-400 mt-1 border-t border-gray-50 pt-2">
                                    <i class="fa-solid fa-share-nodes opacity-50"></i>
                                    <span>æœ‹å‹åœˆ Â· ${author}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (m.type === 'html') {
                    // æ–°å¢ï¼šHTML ç±»å‹çš„æ¶ˆæ¯ä¸ä½¿ç”¨æ°”æ³¡åŒ…è£¹ï¼Œç›´æ¥æ¸²æŸ“ HTML å†…å®¹
                    useBubble = false;
                    contentHtml = m.content;
                } else {
                    let processed = String(m.content).replace(/\\n/g, '\n').replace(/\n/g, '<br>');
                    if (/\[INNER_VOICE\]/i.test(processed)) {
                        processed = processed.replace(/\[INNER_VOICE\]([\s\S]*?)\[\/INNER_VOICE\]/gi, (match, vc) => { useBubble = false; return `<div class="inner-voice-trigger-card" onclick="InnerVoiceUI.openModal()"><div style="font-size:10px; opacity:0.6; margin-bottom:6px;">Mindscape</div><div style="font-size:14px; font-family:'Noto Serif SC', serif;">${vc.trim()}</div></div>`; });
                    }
                    contentHtml = processed;
                }

                const html = `
                    <div class="msg-row ${isSelf ? 'self' : 'other'} animate-in fade-in slide-in-from-bottom-2 duration-300" data-msg-id="${m.id}" ${hiddenStyle} oncontextmenu="WeChatUI.showContextMenu(event, '${m.id}')">
                        <div class="msg-avatar ${shapeClass}" ondblclick="WeChatUI.handlePat('${id}', ${originalIdx}, '${m.role}', this)" ontouchstart="if(!this.lastClick){this.lastClick=Date.now();return;} if(Date.now()-this.lastClick<300){WeChatUI.handlePat('${id}', ${originalIdx}, '${m.role}', this); this.lastClick=0;} else {this.lastClick=Date.now();}">
                            <img src="${avatar}">
                        </div>
                        <div class="msg-content">
                            ${useBubble ? `<div class="${bubbleClass}" style="${targetCss}; font-size: ${c.bubbleFontSize || 15}px;">${contentHtml}</div>` : contentHtml}
                            <div class="msg-time-outside" style="display:none">${timeStr}</div>
                        </div>
                    </div>`;

                const typingIndicator = container.querySelector('.typing-indicator');
                if (typingIndicator) {
                    typingIndicator.closest('.msg-row').insertAdjacentHTML('beforebegin', html);
                } else {
                    container.insertAdjacentHTML('beforeend', html);
                }
                if (WeChatUI.bindLongPressEvents) WeChatUI.bindLongPressEvents();
            },
            loadChat: (id, npcId = '') => {
                try {
                    setTimeout(() => WeChatUI.updateAutoTTSIcon(), 0);
                    const chars = AppStorage.get('wechat_chars', {});
                    const c = chars[id];
                    if (!c) return;
                    const npcs = AppStorage.get('wechat_npcs', {});
                    const npc = npcId ? npcs[npcId] : null;

                    document.getElementById('chat-title').textContent = npc ? (c.nickname || npc.name) : (c.nickname || c.name);
                    const bgLayer = document.getElementById('chat-bg-layer');
                    if (c.chatBg && bgLayer) {
                        bgLayer.style.backgroundImage = `url(${c.chatBg})`;
                        bgLayer.style.backgroundColor = 'white';
                        bgLayer.style.backgroundSize = 'cover';
                        bgLayer.style.backgroundPosition = 'center';
                        bgLayer.style.filter = `blur(${c.bgBlur || 0}px)`;
                        bgLayer.style.opacity = c.bgOpacity !== undefined ? c.bgOpacity : 1;
                        bgLayer.style.pointerEvents = 'none';
                    } else if (bgLayer) {
                        bgLayer.style.backgroundImage = '';
                        bgLayer.style.background = 'white';
                        bgLayer.style.pointerEvents = 'none';
                    }

                    const msgs = [...(c.msgs || [])];
                    if (msgs.length === 0) {
                        if (c.openingLine && c.openingLine.trim()) {
                            msgs.push({ role: 'ai', content: c.openingLine.trim(), timestamp: Date.now(), id: WeChatUI.generateMsgId() });
                        } else {
                            const fName = npc ? npc.name : c.name;
                            const fAvatar = npc ? npc.avatar : c.avatar || WeChatUI.getRandomAvatar();
                            msgs.push({ role: 'system', type: 'html', content: `<div class="friend-request-card"><div class="user-info"><img src="${fAvatar}" class="avatar"><div class="text-group"><div class="name">${fName}</div><div class="status">è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹</div></div></div><div class="action-group"><button onclick="WeChatUI.rejectFriendRequest('${id}', '${npcId}')" class="btn btn-decline">å¿½ç•¥</button><button onclick="WeChatUI.acceptFriendRequest('${id}', '${npcId}')" class="btn btn-accept">åŒæ„</button></div></div>`, timestamp: Date.now(), id: WeChatUI.generateMsgId() });
                        }
                    }

                    if (!WeChatUI.currentLoadedMsgs[id]) WeChatUI.currentLoadedMsgs[id] = Math.min(c.displayLimit || 50, msgs.length);
                    const currentMsgs = msgs.slice(-WeChatUI.currentLoadedMsgs[id]);
                    const startIdx = Math.max(0, msgs.length - WeChatUI.currentLoadedMsgs[id]);
                    const container = document.getElementById('chat-messages-container');
                    container.innerHTML = '';

                    const hasMore = WeChatUI.currentLoadedMsgs[id] < msgs.length;
                    if (hasMore) {
                        container.insertAdjacentHTML('beforeend', `<div class="msg-load-more" onclick="WeChatUI.loadMoreMessages('${id}', ${npcId ? `'${npcId}'` : 'undefined'})"><div class="load-more-btn">åŠ è½½æ›´å¤š</div></div>`);
                    }

                    let lastTime = 0;
                    const cachedChars = AppStorage.get('wechat_chars', {});
                    const cachedUserProfile = AppStorage.get('wechat_user_profile', {});
                    currentMsgs.forEach((m, idx) => {
                        if (m.hidden === true) return;
                        const msgTime = m.timestamp || Date.now();
                        if (msgTime - lastTime > 5 * 60 * 1000) {
                            container.insertAdjacentHTML('beforeend', `<div class="msg-system"><span>${Utils.formatChatTime(msgTime)}</span></div>`);
                            lastTime = msgTime;
                        }
                        WeChatUI.renderMessage(container, m, id, startIdx + idx, cachedChars, cachedUserProfile);
                    });

                    container.scrollTop = container.scrollHeight;
                    WeChatUI.startProactiveChatTimer(id);
                } catch (e) { console.error("åŠ è½½èŠå¤©å¤±è´¥:", e); }
            },


            // 2. æ›´æ–°èƒŒæ™¯é¢„è§ˆ (ä¿®å¤ç‰ˆ + æ”¯æŒåŒæ‹¼CSS)
            updateBgPreview: () => {
                const url = document.getElementById('char-chat-bg').value;
                const rawCss = document.getElementById('char-bubble-css').value;
                const blur = document.getElementById('char-bg-blur').value;
                const opacity = document.getElementById('char-bg-opacity').value;
                const fontSize = document.getElementById('char-bubble-size').value;
                // è·å–å½“å‰è§’è‰²ä¿¡æ¯ï¼Œç”¨äºæ˜¾ç¤ºè‡ªå®šä¹‰å¤´åƒ
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];

                const bgEl = document.getElementById('preview-chat-bg');
                let bgSource = url || (c && c.chatBg) || '';
                if (bgEl) {
                    if (bgSource) {
                        if (/^url\(/.test(bgSource.trim())) bgEl.style.backgroundImage = bgSource;
                        else bgEl.style.backgroundImage = `url(${bgSource})`;
                    } else {
                        const wp = document.getElementById('wallpaper-layer');
                        bgEl.style.backgroundImage = wp ? window.getComputedStyle(wp).backgroundImage : 'none';
                    }
                    // è®¾ç½®åº•å›¾ä¸ºé»‘è‰²
                    bgEl.style.background = 'black';
                    bgEl.style.backgroundSize = 'cover';
                    bgEl.style.backgroundPosition = 'center';
                    if (bgEl.style.backgroundImage && bgEl.style.backgroundImage !== 'none') {
                        bgEl.style.backgroundBlendMode = 'normal';
                    }
                    // ä½¿ç”¨äº®åº¦è°ƒæ•´ä»£æ›¿é€æ˜åº¦ï¼Œè®©èƒŒæ™¯å˜æš—è€Œä¸æ˜¯å˜äº®
                    bgEl.style.filter = `blur(${blur}px) brightness(${opacity})`;
                    bgEl.style.opacity = '1';
                    bgEl.style.zIndex = '0';
                }

                // è§£æåŒæ‹¼ CSS
                const cssParts = rawCss.split('|||');
                const cssOther = cssParts[0] || ''; // å¯¹æ–¹
                const cssSelf = cssParts[1] || cssParts[0] || ''; // è‡ªå·±

                const styleStrSelf = `${cssSelf}; font-size: ${fontSize}px;`;
                const styleStrOther = `${cssOther}; font-size: ${fontSize}px;`;

                const bubbleSelf = document.getElementById('preview-bubble-self');
                const bubbleOther = document.getElementById('preview-bubble-other');

                if (bubbleSelf) bubbleSelf.style.cssText = styleStrSelf;
                if (bubbleOther) bubbleOther.style.cssText = styleStrOther;

                const shape = document.getElementById('char-avatar-shape').value;
                const cls = shape === 'circle' ? 'rounded-full' : 'rounded-md';
                const avatarSelf = document.getElementById('preview-avatar-self');
                const avatarOther = document.getElementById('preview-avatar-other');

                if (avatarSelf) {
                    avatarSelf.className = `msg-avatar ${cls}`;
                    // è®¾ç½®å¤´åƒå›¾ç‰‡ï¼šä½¿ç”¨ç”¨æˆ·çš„è‡ªå®šä¹‰å¤´åƒï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨éšæœºå¤´åƒ
                    const selfImg = avatarSelf.querySelector('img');
                    if (selfImg) {
                        selfImg.src = c.userAvatar || WeChatUI.getRandomAvatar();
                        selfImg.style.display = 'block';
                    }
                }
                if (avatarOther) {
                    avatarOther.className = `msg-avatar ${cls}`;
                    // è®¾ç½®å¤´åƒå›¾ç‰‡ï¼šä½¿ç”¨è§’è‰²çš„è‡ªå®šä¹‰å¤´åƒï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨éšæœºå¤´åƒ
                    const otherImg = avatarOther.querySelector('img');
                    if (otherImg) {
                        otherImg.src = c.avatar || WeChatUI.getRandomAvatar();
                        otherImg.style.display = 'block';
                    }
                }

                // ç¡®ä¿é¢„è§ˆåŒºåŸŸæ²¡æœ‰é¡¶éƒ¨é®æŒ¡
                const previewContainer = document.querySelector('.bg-preview-container');
                if (previewContainer) {
                    previewContainer.style.overflow = 'hidden';
                    previewContainer.style.padding = '0';
                }
            },



            // åŠ è½½æ›´å¤šæ¶ˆæ¯
            loadMoreMessages: (id, npcId = '') => {
                const c = AppStorage.get('wechat_chars', {})[id];
                if (!c) return;

                const displayLimit = c.displayLimit || 50;
                const totalMsgs = c.msgs.length || 0;

                // å¢åŠ åŠ è½½çš„æ¶ˆæ¯æ¡æ•°
                const newLoadedCount = Math.min(WeChatUI.currentLoadedMsgs[id] + displayLimit, totalMsgs);
                WeChatUI.currentLoadedMsgs[id] = newLoadedCount;

                // é‡æ–°åŠ è½½èŠå¤©
                WeChatUI.loadChat(id, npcId);
            },

            handlePaymentClick: (idx, type, role) => {
                // é”™è¯¯æ£€æŸ¥ï¼šç¡®ä¿subpage-chat-detailå…ƒç´ å­˜åœ¨
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) {
                    console.error('subpage-chat-detailå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                const cid = chatDetailEl.dataset.charId;
                if (!cid) {
                    console.error('charIdä¸å­˜åœ¨');
                    return;
                }

                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid]) {
                    console.error('è§’è‰²ä¸å­˜åœ¨');
                    return;
                }

                if (!chars[cid].msgs) {
                    chars[cid].msgs = [];
                }

                const msg = chars[cid].msgs[idx];
                if (!msg) {
                    console.error('æ¶ˆæ¯ä¸å­˜åœ¨');
                    return;
                }

                if (msg.status === 'received' || msg.status === 'rejected') {
                    if (type === 'redpacket' && msg.status === 'received') {
                        const modal = document.getElementById('modal-open-redpacket');
                        if (modal) {
                            modal.classList.remove('hidden');
                            // ã€ä¿®å¤ã€‘æ­£ç¡®æ˜¾ç¤ºå‘é€è€…å¤´åƒ (å¦‚æœæ˜¯userå‘çš„ï¼Œæ˜¾ç¤ºuserå¤´åƒ)
                            const userProfile = AppStorage.get('wechat_user_profile', {});
                            const senderAvatar = msg.role === 'user'
                                ? (userProfile.avatar || WeChatUI.getRandomAvatar())
                                : chars[cid].avatar;

                            document.getElementById('rp-open-avatar').innerHTML = `<img src="${senderAvatar}">`;
                            document.getElementById('rp-open-msg').textContent = msg.note || 'æ­å–œå‘è´¢';
                            document.querySelector('.rp-open-btn').style.display = 'none';
                            document.getElementById('rp-reject-btn').style.display = 'none';
                            document.getElementById('rp-result-view').classList.add('active');
                            document.getElementById('rp-result-amount').textContent = msg.receivedAmount || msg.amount || '0.00';
                        }
                    }
                    return;
                }

                // å®‰å…¨æ£€æŸ¥ï¼šä»¥å­˜å‚¨çš„æ¶ˆæ¯è§’è‰²ä¸ºå‡†
                // ã€ä¿®å¤ã€‘å¢å¼ºçš„è§’è‰²æ£€æŸ¥ï¼Œé˜²æ­¢ç”¨æˆ·ç‚¹å¼€è‡ªå·±å‘çš„æ¶ˆæ¯å‡ºç°â€œæ”¶æ¬¾â€å¼¹çª—
                if (msg.role === 'user' || msg.role === 'me' || msg.role === 'self' || role === 'user') {
                    // console.log('[Payment] Clicked own message, ignoring.');
                    Utils.showToast('ç­‰å¾…å¯¹æ–¹ç¡®è®¤æ”¶æ¬¾');
                    return;
                }

                if (msg.role === 'ai' || msg.role === 'assistant') {
                    if (type === 'redpacket') {
                        const modal = document.getElementById('modal-open-redpacket');
                        if (modal) {
                            modal.classList.remove('hidden');
                            document.getElementById('rp-open-avatar').innerHTML = `<img src="${chars[cid].avatar}">`;
                            document.getElementById('rp-open-msg').textContent = msg.note || 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©';
                            document.getElementById('rp-result-view').classList.remove('active');
                            // ã€å…³é”®ä¿®å¤ã€‘é‡ç½®å¼¹çª—çŠ¶æ€ï¼Œç¡®ä¿spinnerä¸è½¬ï¼ŒæŒ‰é’®æ˜¾ç¤º
                            // Ensure the modal is reset to initial state
                            const openBtn = document.querySelector('.rp-open-btn');
                            if (openBtn) {
                                openBtn.classList.remove('spinning');
                                openBtn.style.display = 'flex';
                            }
                            document.getElementById('rp-reject-btn').style.display = 'block';
                            modal.dataset.targetIdx = idx;
                            modal.dataset.charId = cid;
                        }
                    } else {
                        document.getElementById('payment-action-title').textContent = 'æ”¶åˆ°è½¬è´¦';
                        document.getElementById('payment-action-amount').textContent = `Â¥${msg.amount} `;
                        document.getElementById('payment-action-desc').innerHTML = `è½¬è´¦å¤‡æ³¨: ${msg.note} `;
                        document.getElementById('modal-payment-action').classList.remove('hidden');
                        document.getElementById('modal-payment-action').dataset.targetIdx = idx;
                    }
                } else { Utils.showToast('ç­‰å¾…å¯¹æ–¹ç¡®è®¤æ”¶æ¬¾'); }
            },
            triggerOpenPacket: () => {
                const btn = document.querySelector('.rp-open-btn');
                if (btn) {
                    btn.classList.add('spinning');
                    setTimeout(() => {
                        btn.classList.remove('spinning');
                        WeChatUI.processRedPacketOpen('received');
                    }, 1000);
                }
            },
            triggerRejectPacket: () => {
                WeChatUI.processRedPacketOpen('rejected');
            },
            processRedPacketOpen: (action) => {
                const modal = document.getElementById('modal-open-redpacket');
                if (!modal) {
                    console.error('modal-open-redpacketå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                const idx = modal.dataset.targetIdx;
                const cid = modal.dataset.charId;

                if (!cid) {
                    console.error('charIdä¸å­˜åœ¨');
                    return;
                }

                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid]) {
                    console.error('è§’è‰²ä¸å­˜åœ¨');
                    return;
                }

                if (!chars[cid].msgs) {
                    chars[cid].msgs = [];
                }

                const msg = chars[cid].msgs[idx];
                if (!msg) {
                    console.error('æ¶ˆæ¯ä¸å­˜åœ¨');
                    return;
                }


                // å›ºå®šä½¿ç”¨çº¢åŒ…ä¸­è®¾å®šçš„é‡‘é¢ï¼Œä¸ç”Ÿæˆéšæœºé‡‘é¢
                // ã€ä¿®å¤ã€‘ç§»é™¤å‰¯APIç›¸å…³æç¤ºï¼Œé¿å…è¯¯å¯¼
                let amount = msg.amount ? parseFloat(msg.amount) : 0;
                msg.receivedAmount = amount; // ä¿å­˜å®é™…é¢†å–é‡‘é¢

                // ç”Ÿæˆç»Ÿä¸€çš„ç³»ç»Ÿæ¶ˆæ¯ï¼š"ä½ é¢†å–äº†xxçš„çº¢åŒ…"
                // 1. æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                msg.status = action; // 'received' or 'rejected'

                // 2. ç”Ÿæˆç³»ç»Ÿæç¤ºæ–‡æ¡ˆ
                const actionText = action === 'received' ? 'é¢†å–' : 'é€€è¿˜';
                const sysText = `ä½ ${actionText}äº†${chars[cid].name} çš„çº¢åŒ…`;

                // 3. æ’å…¥ç³»ç»Ÿæ¶ˆæ¯ (å…³é”®ï¼šå¿…é¡»ç”Ÿæˆ ID)
                const sysMsg = {
                    id: WeChatUI.generateMsgId(),
                    role: 'system',
                    type: 'system',
                    content: sysText,
                    timestamp: Date.now()
                };

                // æ’å…¥åˆ°å½“å‰çº¢åŒ…æ¶ˆæ¯çš„ä¸‹ä¸€æ¡
                chars[cid].msgs.splice(parseInt(idx) + 1, 0, sysMsg);

                if (action === 'received') {
                    document.getElementById('rp-result-amount').textContent = amount;
                    document.querySelector('.rp-open-btn').style.display = 'none';
                    document.getElementById('rp-reject-btn').style.display = 'none';
                    document.getElementById('rp-result-view').classList.add('active');
                    Utils.showToast(`å·²å­˜å…¥é›¶é’±: Â¥${amount.toFixed(2)} `);

                    // æ›´æ–°ç”¨æˆ·é’±åŒ…ä½™é¢
                    WeChatUI.updateWalletBalance('income', amount, `é¢†å–äº†${chars[cid].name} çš„çº¢åŒ…`);

                    // ã€æ–°å¢ã€‘åŒæ­¥åˆ°è§’è‰²æ‰‹æœºé’±åŒ… (è§’è‰²æ”¯å‡º)
                    if (window.WalletLogic && WalletLogic.addTransaction) {
                        WalletLogic.addTransaction(cid, {
                            type: 'expense',
                            amount: amount,
                            title: `å‘å‡ºçš„çº¢åŒ…`,
                            time: new Date().toLocaleString()
                        });
                    }
                } else {
                    modal.classList.add('hidden');
                }

                // 5. ä¿å­˜å¹¶åˆ·æ–°
                AppStorage.set('wechat_chars', chars);
                // å¼ºåˆ¶é‡æ–°åŠ è½½èŠå¤©ç•Œé¢
                WeChatUI.loadChat(cid);
            },
            processPaymentAction: (action) => {
                // è·å–modalå…ƒç´ å¹¶æ£€æŸ¥
                const modal = document.getElementById('modal-payment-action');
                if (!modal) {
                    console.error('modal-payment-actionå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                // è·å–targetIdxå¹¶æ£€æŸ¥
                const targetIdx = modal.dataset.targetIdx;
                if (!targetIdx) {
                    console.error('targetIdxä¸å­˜åœ¨');
                    return;
                }

                const idx = parseInt(targetIdx);

                // è·å–chatDetailElå…ƒç´ å¹¶æ£€æŸ¥
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) {
                    console.error('subpage-chat-detailå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                // è·å–charIdå¹¶æ£€æŸ¥
                const cid = chatDetailEl.dataset.charId;
                if (!cid) {
                    console.error('charIdä¸å­˜åœ¨');
                    return;
                }

                // è·å–charså¹¶æ£€æŸ¥
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid]) {
                    console.error('è§’è‰²ä¸å­˜åœ¨');
                    return;
                }

                // åˆå§‹åŒ–msgsæ•°ç»„
                if (!chars[cid].msgs) {
                    chars[cid].msgs = [];
                }

                // è·å–msgå¹¶æ£€æŸ¥
                const msg = chars[cid].msgs[idx];
                if (!msg) {
                    console.error('æ¶ˆæ¯ä¸å­˜åœ¨');
                    return;
                }

                // 1. æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                msg.status = action; // 'received' or 'rejected'

                // 2. ç”Ÿæˆç³»ç»Ÿæç¤ºæ–‡æ¡ˆ
                const actionText = action === 'received' ? 'é¢†å–' : 'é€€è¿˜';
                const typeText = msg.type === 'transfer' ? 'è½¬è´¦' : 'çº¢åŒ…';
                const sysText = `ä½ ${actionText}äº†${chars[cid].name}çš„${typeText} `;

                // 3. æ’å…¥ç³»ç»Ÿæ¶ˆæ¯ (å…³é”®ï¼šå¿…é¡»ç”Ÿæˆ ID)
                const sysMsg = {
                    id: WeChatUI.generateMsgId(), // ä¿®å¤ï¼šè¡¥å…¨ ID
                    role: 'system',
                    type: 'system',
                    content: sysText,
                    timestamp: Date.now()
                };

                // æ’å…¥åˆ°å½“å‰è½¬è´¦æ¶ˆæ¯çš„ä¸‹ä¸€æ¡
                chars[cid].msgs.splice(idx + 1, 0, sysMsg);

                // 4. å¤„ç†èµ„é‡‘å…¥è´¦
                if (action === 'received') {
                    // ç¡®ä¿é‡‘é¢æ˜¯æ•°å­—
                    let amountVal = parseFloat(msg.amount);
                    if (isNaN(amountVal)) amountVal = 0;

                    // è°ƒç”¨é’±åŒ…æ›´æ–°
                    WeChatUI.updateWalletBalance('income', amountVal, `æ”¶åˆ°${chars[cid].name}çš„${typeText} `);
                    Utils.showToast(`å·²å­˜å…¥é›¶é’±: Â¥${amountVal.toFixed(2)} `);

                    // ã€æ–°å¢ã€‘åŒæ­¥åˆ°è§’è‰²æ‰‹æœºé’±åŒ… (è§’è‰²æ”¯å‡º)
                    if (window.WalletLogic && WalletLogic.addTransaction) {
                        WalletLogic.addTransaction(cid, {
                            type: 'expense',
                            amount: amountVal,
                            title: `å‘å‡ºçš„${typeText} `,
                            time: new Date().toLocaleString()
                        });
                    }
                } else {
                    Utils.showToast(`å·²${actionText} `);
                }

                // 5. ä¿å­˜å¹¶åˆ·æ–°
                AppStorage.set('wechat_chars', chars);
                document.getElementById('modal-payment-action').classList.add('hidden');

                // å¼ºåˆ¶é‡æ–°åŠ è½½èŠå¤©ç•Œé¢ï¼Œæ˜¾ç¤ºé»‘è‰²ç³»ç»Ÿæç¤ºæ¡
                WeChatUI.loadChat(cid);
            },

            handleAIReceivedPayment: (cid, targetMsgData, action) => {
                if (!targetMsgData) return;
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs) return;

                // æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»åœ¨ fresh chars ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯å¼•ç”¨
                // 1. ä¼˜å…ˆä½¿ç”¨ ID åŒ¹é… (æ”¯æŒ alphanumeric ID)
                // console.log('[handleAIReceivedPayment] Matching ID:', targetMsgData.id || targetMsgData.paymentId);
                let targetMsg = chars[cid].msgs.find(m => {
                    // Normalize IDs to string for comparison
                    const mId = String(m.id);
                    const tId = String(targetMsgData.id);
                    const mPid = m.paymentId ? String(m.paymentId) : '';
                    const tPid = targetMsgData.paymentId ? String(targetMsgData.paymentId) : '';

                    return mId === tId || (mPid && tPid && mPid === tPid);
                });

                // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…æ—¶é—´æˆ³
                if (!targetMsg && targetMsgData.timestamp) {
                    targetMsg = chars[cid].msgs.find(m => m.timestamp === targetMsgData.timestamp);
                }

                // 3. ã€å…œåº•æ”¹è¿›ã€‘å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œä¸”çŸ¥é“ç±»å‹ï¼ŒæŸ¥æ‰¾ã€æ‰€æœ‰ã€‘æœªé¢†å–çš„è¯¥ç±»å‹ç”¨æˆ·æ¶ˆæ¯
                // Fix: ä¹‹å‰é€»è¾‘åªæ‰¾ pending çš„æ‰€è°“ "latest"ï¼Œç°åœ¨åªè¦æ˜¯ unmatched çš„ pending éƒ½å¯ä»¥è®¤é¢†
                // ä¸ºé˜²æ­¢ä¸€æ¬¡è®¤é¢†å¤šä¸ªå¯¼è‡´æ··ä¹±ï¼Œæˆ‘ä»¬è¿™é‡Œåšä¸€ä¸ªæ›´æ™ºèƒ½çš„åŒ¹é…ï¼š
                // å¦‚æœ AI æŒ‡å®šäº† ID ä½†æ²¡æ‰¾åˆ°ï¼Œæˆ‘ä»¬æ‰¾ä¸€ä¸ªã€æœ€æ—§çš„ã€‘æœªé¢†å–çº¢åŒ…ï¼ˆç±»ä¼¼æ’é˜Ÿé¢†å–ï¼‰ï¼Œæˆ–è€…ã€æœ€æ–°çš„ã€‘ï¼Ÿ
                // ç”¨æˆ·åé¦ˆ "è¿ç»­å‘å‡ ä¸ªçº¢åŒ…AIåªèƒ½é¢†å–æœ€åä¸€ä¸ª"ï¼Œè¯´æ˜ fallback åªæ‹¿äº† latestã€‚
                // ç°åœ¨çš„ç­–ç•¥ï¼šå¦‚æœ ID ä¸åŒ¹é…ï¼Œä¼˜å…ˆæ‰¾ã€æœ€æ—©æœªé¢†å–ã€‘çš„ï¼Œå› ä¸º AI å¯èƒ½æ˜¯æŒ‰é¡ºåºå›å¤çš„ã€‚

                if (!targetMsg && targetMsgData.type) {
                    console.warn(`[handleAIReceivedPayment] ID matching failed, scanning for ANY pending ${targetMsgData.type} `);

                    // æŸ¥æ‰¾æ‰€æœ‰æœªå¤„ç†çš„è¯¥ç±»å‹æ¶ˆæ¯
                    const pendingMsgs = chars[cid].msgs.filter(m =>
                        m.role === 'user' &&
                        m.type === targetMsgData.type &&
                        !m.status
                    );

                    if (pendingMsgs.length > 0) {
                        // ç­–ç•¥ï¼šä¼˜å…ˆé¢†æœ€æ—©çš„ä¸€ä¸ª (FIFO)ï¼Œè¿™æ · AI è¿ç»­å›å¤ "é¢†å– é¢†å– é¢†å–" æ—¶ï¼Œä¼šä¾æ¬¡é¢†å–
                        // é™¤é AI æœ‰æ˜ç¡®æŒ‡ä»£ï¼Œä½†æ—¢ç„¶ ID åŒ¹é…å¤±è´¥ï¼Œè¯´æ˜æŒ‡ä»£ä¸æ¸…
                        targetMsg = pendingMsgs[0];
                        // console.log(`[handleAIReceivedPayment] Fallback: Claiming pending msg at index ${ chars[cid].msgs.indexOf(targetMsg) } `);
                    }
                }

                if (!targetMsg) {
                    // å¦‚æœå®åœ¨æ‰¾ä¸åˆ°ï¼Œå¯èƒ½æ˜¯å·²ç»é¢†è¿‡äº†ï¼Œæˆ–è€… AI åœ¨å¹»è§‰ã€‚
                    // ä¸æŠ¥é”™ä¸­æ–­ï¼Œè€Œæ˜¯è®°å½•æ—¥å¿—å¹¶å®‰é™è¿”å›ï¼Œé˜²æ­¢ crash
                    // console.log('[handleAIReceivedPayment] No matching pending payment found. Ignoring directive.');
                    return;
                }

                // é˜²æ­¢é‡å¤å¤„ç†
                if (targetMsg.status) return;

                // å¦‚æœæ²¡æœ‰æŒ‡å®šactionï¼Œåˆ™é»˜è®¤received
                const finalAction = action || 'received';
                const actionText = finalAction === 'received' ? 'é¢†å–' : 'é€€è¿˜';
                const typeText = targetMsg.type === 'transfer' ? 'è½¬è´¦' : 'çº¢åŒ…';

                // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                targetMsg.status = finalAction;
                targetMsg.receivedTime = Date.now();
                targetMsg.receivedAmount = targetMsg.amount || '0.00';

                // ã€æ–°å¢ã€‘å¦‚æœæ˜¯ AI é¢†å–äº† User çš„é’± -> è§’è‰²æ”¶å…¥
                if (finalAction === 'received' && window.WalletLogic && WalletLogic.addTransaction) {
                    WalletLogic.addTransaction(cid, {
                        type: 'income',
                        amount: parseFloat(targetMsg.amount || '0'),
                        title: `æ”¶åˆ°çš„${typeText} `,
                        time: new Date().toLocaleString()
                    });
                }

                // æ’å…¥ç°è‰²ç³»ç»Ÿå°å­—æ¶ˆæ¯ (æ˜¾ç¤ºåœ¨åº•éƒ¨)
                const sysText = `${chars[cid].name}${actionText}äº†ä½ çš„${typeText} `;
                const sysMsg = {
                    id: WeChatUI.generateMsgId(),
                    role: 'system', type: 'system',
                    content: sysText, timestamp: Date.now()
                };
                chars[cid].msgs.push(sysMsg);

                // å¦‚æœæ˜¯é€€è¿˜ï¼Œé’±åº”è¯¥å›åˆ°ç”¨æˆ·é’±åŒ…
                if (finalAction === 'rejected') {
                    const amount = parseFloat(targetMsg.amount || '0');
                    WeChatUI.updateWalletBalance('income', amount, `${chars[cid].name}é€€è¿˜äº†${typeText} `);
                }

                // ä¿å­˜åˆ°å­˜å‚¨
                AppStorage.set('wechat_chars', chars);

                // åˆ·æ–°èŠå¤©ç•Œé¢
                if (document.getElementById('subpage-chat-detail').classList.contains('active') &&
                    document.getElementById('subpage-chat-detail').dataset.charId === cid) {
                    WeChatUI.loadChat(cid);
                }
            },
            showGlobalNotification: (name, msg, avatar, charId) => {
                const modal = document.getElementById('global-notification-modal');
                if (modal) {
                    const titleEl = document.getElementById('notify-title');
                    if (titleEl) titleEl.textContent = name;

                    const bodyEl = document.getElementById('notify-body');
                    if (bodyEl) bodyEl.textContent = msg;

                    const avatarEl = document.getElementById('notify-avatar-img');
                    if (avatarEl) avatarEl.src = avatar || WeChatUI.getRandomAvatar();

                    // å­˜å‚¨èŠå¤©IDï¼Œç”¨äºç‚¹å‡»é€šçŸ¥æ—¶ç›´æ¥å¯¼èˆª
                    modal.dataset.charId = charId || '';
                    modal.style.display = 'block';
                    setTimeout(() => { modal.style.display = 'none'; }, 4000);
                }
            },
            handleNotificationClick: () => {
                const modal = document.getElementById('global-notification-modal');
                modal.style.display = 'none';
                openApp('wechat');

                // è·å–å­˜å‚¨çš„èŠå¤©ID
                const charId = modal.dataset.charId;
                if (charId) {
                    // å¯¼èˆªåˆ°èŠå¤©è¯¦æƒ…é¡µ
                    const chars = AppStorage.get('wechat_chars', {});
                    if (chars[charId]) {
                        // é‡ç½®æœªè¯»è®¡æ•°
                        chars[charId].unread = 0;
                        AppStorage.set('wechat_chars', chars);

                        // æ¸²æŸ“åˆ—è¡¨å¹¶åŠ è½½èŠå¤©
                        WeChatUI.renderList();
                        WeChatUI.loadChat(charId);

                        // ç¡®ä¿èŠå¤©è¯¦æƒ…é¡µå¯è§
                        document.getElementById('subpage-chat-detail').dataset.charId = charId;
                        document.getElementById('subpage-chat-detail').classList.add('active');
                    }
                }
            },
            toggleVoiceText: (idx, cid, role) => {
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs || !chars[cid].msgs[idx]) return;

                const msg = chars[cid].msgs[idx];

                // 1. åˆ‡æ¢å±•å¼€çŠ¶æ€
                msg.expanded = !msg.expanded;

                // åˆ·æ–° UI è¾…åŠ©å‡½æ•°
                const updateUI = () => {
                    AppStorage.set('wechat_chars', chars);
                    const chatEl = document.getElementById('subpage-chat-detail');
                    // ä»…å½“å½“å‰å°±åœ¨è¯¥èŠå¤©æ—¶åˆ·æ–°
                    if (chatEl && chatEl.classList.contains('active') && chatEl.dataset.charId === cid) {
                        WeChatUI.loadChat(cid);
                    }
                };

                // 2. åœæ­¢æ’­æ”¾é€»è¾‘
                if (msg.playing) {
                    msg.playing = false;
                    // åœæ­¢æµè§ˆå™¨TTS
                    if (window.speechSynthesis) window.speechSynthesis.cancel();
                    // åœæ­¢äº‘ç«¯TTSéŸ³é¢‘
                    if (window.currentVoiceAudio) {
                        try { window.currentVoiceAudio.pause(); } catch (e) { }
                        window.currentVoiceAudio = null;
                    }
                    updateUI();
                    return;
                }

                // 3. å¼€å§‹æ’­æ”¾é€»è¾‘ (ä»…å½“å±•å¼€æ—¶)
                if (msg.expanded) {
                    msg.playing = true;
                    updateUI();

                    // æ¸…ç†æ–‡æœ¬ (å»é™¤æ‹¬å·å†…å®¹)
                    const cleanText = (msg.text || '').replace(/[\(ï¼ˆ\[ã€\{].*?[\)ï¼‰\]ã€‘\}]/g, '').trim();

                    // å¤±è´¥/æ¨¡æ‹Ÿå›é€€
                    const fallback = () => {
                        setTimeout(() => {
                            // é‡æ–°è·å–æœ€æ–°çš„msgçŠ¶æ€ï¼Œé˜²æ­¢å·²è¢«ç”¨æˆ·æ‰‹åŠ¨åœæ­¢
                            const latestChars = AppStorage.get('wechat_chars', {});
                            if (latestChars[cid] && latestChars[cid].msgs[idx] && latestChars[cid].msgs[idx].playing) {
                                latestChars[cid].msgs[idx].playing = false;
                                AppStorage.set('wechat_chars', latestChars);
                                if (document.getElementById('subpage-chat-detail').dataset.charId === cid) {
                                    WeChatUI.loadChat(cid);
                                }
                            }
                        }, Math.min(60, Math.ceil(cleanText.length / 5)) * 1000);
                    };

                    if (!cleanText) { fallback(); return; }

                    if (typeof SettingsLogic !== 'undefined' && SettingsLogic.generateTTS) {
                        SettingsLogic.generateTTS(cleanText, chars[cid]).then(res => {
                            // æ£€æŸ¥æ˜¯å¦è¿˜åœ¨æ’­æ”¾çŠ¶æ€ (ç”¨æˆ·å¯èƒ½å·²ç»åœ¨è¯·æ±‚æœŸé—´ç‚¹äº†åœæ­¢)
                            const checkStillPlaying = () => {
                                const current = AppStorage.get('wechat_chars', {})[cid]?.msgs[idx];
                                return current && current.playing;
                            };

                            if (!checkStillPlaying()) return;

                            if (res === 'browser-tts-done') {
                                // æµè§ˆå™¨TTSæ’­æ”¾å®Œæˆ (æ³¨æ„ï¼šå®ƒæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ç»“æŸï¼ŸgenerateTTS wrapäº†onend promiseï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ç»“æŸäº†)
                                msg.playing = false;
                                updateUI();
                            } else if (res) {
                                // äº‘ç«¯TTSè¿”å›URL
                                const audio = new Audio(res);
                                window.currentVoiceAudio = audio; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿æš‚åœ
                                audio.playbackRate = parseFloat(chars[cid].voiceSpeed || 1.0);
                                audio.onended = () => {
                                    msg.playing = false;
                                    window.currentVoiceAudio = null;
                                    updateUI();
                                };
                                audio.onerror = () => {
                                    console.error("Audio playback error");
                                    msg.playing = false;
                                    window.currentVoiceAudio = null;
                                    updateUI();
                                };
                                audio.play().catch(e => {
                                    console.error("Audio play caught error:", e);
                                    fallback();
                                });
                            } else {
                                fallback();
                            }
                        }).catch(e => {
                            console.error("TTS Generate error:", e);
                            fallback();
                        });
                    } else {
                        fallback();
                    }
                } else {
                    // æŠ˜å æ—¶ä»…ä¿å­˜çŠ¶æ€
                    updateUI();
                }
            },
            toggleVoiceMode: () => {
                WeChatUI.isVoiceMode = !WeChatUI.isVoiceMode;
                const btnVoice = document.getElementById('btn-voice-mode');
                if (btnVoice) btnVoice.style.color = WeChatUI.isVoiceMode ? '#4ade80' : 'gray';
                const input = document.getElementById('chat-input');
                if (input) input.placeholder = WeChatUI.isVoiceMode ? 'è¾“å…¥æ–‡å­—è½¬è¯­éŸ³...' : 'å‘é€æ¶ˆæ¯...';
            },
            regenerateLastReply: () => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                if (!c || !c.msgs) return;

                // Find last user message (any type, not just text)
                const lastUserMsg = c.msgs.slice().reverse().find(m => m.role === 'user');
                if (!lastUserMsg) {
                    Utils.showToast('æ²¡æœ‰å¯é‡æ–°ç”Ÿæˆçš„æ¶ˆæ¯');
                    return;
                }

                const lastUserMsgIdx = c.msgs.findIndex(m => m.timestamp === lastUserMsg.timestamp);
                if (lastUserMsgIdx === -1) {
                    Utils.showToast('æ‰¾ä¸åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯');
                    return;
                }

                // Remove all messages after last user message (including any system messages and AI replies)
                c.msgs = c.msgs.slice(0, lastUserMsgIdx + 1); // Keep the user message
                AppStorage.set('wechat_chars', chars);
                WeChatUI.loadChat(cid);

                // Regenerate the reply
                setTimeout(() => {
                    WeChatUI.sendUserMessage(true);
                }, 100);
            },
            // Toggle fullscreen input mode
            toggleFullscreenInput: () => {
                const chatInput = document.getElementById('chat-input');
                const isFullscreen = chatInput.classList.contains('fullscreen-input');

                if (isFullscreen) {
                    // Exit fullscreen
                    chatInput.classList.remove('fullscreen-input');
                    chatInput.style.maxHeight = '120px';
                    chatInput.style.minHeight = '40px';
                    chatInput.style.fontSize = '14px';
                } else {
                    // Enter fullscreen
                    chatInput.classList.add('fullscreen-input');
                    chatInput.style.maxHeight = '60vh';
                    chatInput.style.minHeight = '200px';
                    chatInput.style.fontSize = '16px';
                    chatInput.focus();
                }
            },
            showTransferModal: (type) => { document.getElementById('modal-transfer').classList.remove('hidden'); document.getElementById('transfer-title').textContent = type === 'transfer' ? 'è½¬è´¦' : 'å‘çº¢åŒ…'; document.getElementById('modal-transfer').dataset.type = type; },
            confirmTransfer: () => { const amount = document.getElementById('transfer-amount').value; const note = document.getElementById('transfer-note').value || (document.getElementById('modal-transfer').dataset.type === 'transfer' ? 'è½¬è´¦' : 'æ­å–œå‘è´¢'); if (!amount && document.getElementById('modal-transfer').dataset.type === 'transfer') return; WeChatUI.pushMessage('transfer', { amount, note }, 'user', document.getElementById('modal-transfer').dataset.type); document.getElementById('modal-transfer').classList.add('hidden'); },
            handleChatImage: (input) => {
                if (input.files[0]) {
                    const file = input.files[0];
                    // æ£€æŸ¥æ˜¯å¦æ˜¯GIFå›¾ç‰‡
                    const isGif = file.type === 'image/gif';
                    // GIFå›¾ç‰‡ä½¿ç”¨è¾ƒä½å‹ç¼©ç‡æˆ–ä¸å‹ç¼©ï¼Œä¿ç•™åŠ¨ç”»æ•ˆæœ
                    Utils.compressImage(file, isGif ? 800 : 512, isGif ? 0.8 : 0.6).then(base64 => {
                        WeChatUI.pushMessage('image', base64);
                    });
                }
            },
            // ã€æ ¸å¿ƒé‡æ„ã€‘è§¦å‘ AI å“åº”çš„ç‹¬ç«‹å‡½æ•°ï¼Œä¸å†ä¾èµ–è¾“å…¥æ¡†
            triggerAIResponse: async (cid, systemPrompt = '') => {
                if (!cid) return;

                // å‡†å¤‡è§’è‰²æ•°æ®
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                if (!c) return;

                // è·å–ç”ŸæˆæŒ‰é’®
                const generateBtn = document.getElementById('generate-btn');
                const isCurrentChat = document.getElementById('subpage-chat-detail').dataset.charId === cid;

                // 1. UI æ•ˆæœ (ä»…å½“åœ¨å½“å‰èŠå¤©ç•Œé¢æ—¶)
                if (isCurrentChat) {
                    if (generateBtn) {
                        generateBtn.dataset.originalBg = generateBtn.style.backgroundColor || '';
                        generateBtn.dataset.originalBorder = generateBtn.style.borderColor || '';
                        generateBtn.style.backgroundColor = 'rgba(37, 99, 235, 0.5)';
                        generateBtn.style.borderColor = 'rgba(37, 99, 235, 0.7)';
                        generateBtn.style.transform = 'scale(0.95)';
                    }

                    const statusEl = document.getElementById('chat-online-status');
                    if (statusEl) {
                        statusEl.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
                        statusEl.style.color = '#10b981';
                        statusEl.classList.add('animate-pulse');
                    }
                }

                // 2. æ’å…¥ä¸´æ—¶è¾“å…¥æ°”æ³¡
                const tempId = 'temp_' + Date.now();
                if (isCurrentChat) {
                    const typingBubbleHtml = `
                        <div id="${tempId}" class="chat-bubble other" style="background: white; border-radius: 18px; padding: 12px 16px; width: 60px; height: 36px; display: flex; align-items: center;">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                        </div>
                    `;
                    const container = document.getElementById('chat-messages-container');
                    container.insertAdjacentHTML('beforeend',
                        `<div class="msg-row other">
                            <div class="msg-avatar ${c.avatarShape === 'circle' ? 'circle' : 'square'}">
                                <img src="${c.avatar || WeChatUI.getRandomAvatar()}">
                            </div>
                            <div class="msg-content">${typingBubbleHtml}</div>
                        </div>`
                    );
                    container.scrollTop = container.scrollHeight;
                }

                // --- æ³¨å…¥é¢å¤–çš„ç³»ç»Ÿæç¤º ---
                if (systemPrompt) {
                    c.msgs.push({
                        id: WeChatUI.generateMsgId(),
                        role: 'system',
                        type: 'system',
                        content: systemPrompt,
                        timestamp: Date.now(),
                        hidden: true
                    });
                }

                // 3. æ„å»ºå†å²çºªå½•
                // --- æ—¶é—´æ„ŸçŸ¥ä¸ Prompt æ„å»º ---
                let timeContext = '';
                if (c.timeAware) {
                    const now = new Date();
                    const hour = now.getHours();
                    let period = hour < 5 ? 'å‡Œæ™¨' : (hour < 9 ? 'æ—©æ™¨' : (hour < 12 ? 'ä¸Šåˆ' : (hour < 14 ? 'ä¸­åˆ' : (hour < 18 ? 'ä¸‹åˆ' : (hour < 23 ? 'æ™šä¸Š' : 'æ·±å¤œ')))));
                    timeContext = `\nCurrent Real Time: ${Utils.formatCurrentTime()} (${period})`;
                }

                // è·å–å¿ƒå£°
                let latestVoice = '';
                if (c.innerVoices && c.innerVoices.length > 0) {
                    const lastVoiceItem = c.innerVoices[c.innerVoices.length - 1];
                    latestVoice = typeof lastVoiceItem.content === 'object' ? JSON.stringify(lastVoiceItem.content) : String(lastVoiceItem.content);
                }

                // 4. è°ƒç”¨ AI
                const prompt = `[Roleplay Context]\nChar: ${c.name}\nBio: ${c.bio}\n${timeContext}\nLatest Mindscape: ${latestVoice}\n[Jailbreak: Stay in character. Follow user's lead.]`;

                // æ„é€ æ¶ˆæ¯
                const historyLimit = 20;
                const relevantMsgs = c.msgs.slice(-historyLimit).map(m => ({
                    role: m.role === 'user' ? 'user' : 'assistant',
                    content: typeof m.content === 'string' ? m.content : JSON.stringify(m.content)
                }));

                const apiMsgs = [
                    { role: 'system', content: prompt },
                    ...relevantMsgs
                ];

                try {
                    const fullReply = await SettingsLogic.generateLLM(apiMsgs, cid);

                    // æ¸…ç† UI
                    if (isCurrentChat) {
                        const tempBubble = document.getElementById(tempId);
                        if (tempBubble) tempBubble.closest('.msg-row').remove();

                        if (generateBtn) {
                            generateBtn.style.backgroundColor = generateBtn.dataset.originalBg || '';
                            generateBtn.style.borderColor = generateBtn.dataset.originalBorder || '';
                            generateBtn.style.transform = '';
                        }
                        const statusEl = document.getElementById('chat-online-status');
                        if (statusEl) {
                            statusEl.textContent = 'åœ¨çº¿';
                            statusEl.style.color = '#10b981';
                            statusEl.classList.remove('animate-pulse');
                        }
                    }

                    // å¤„ç†å›å¤
                    if (!fullReply) return;

                    // æå–å¹¶æ¸…ç†å†…å®¹
                    let cleanReply = fullReply;
                    if (cleanReply.includes('[INNER_VOICE]')) {
                        InnerVoiceUI.addVoice(cleanReply, cid);
                        cleanReply = cleanReply.replace(/\[\s*INNER_VOICE\s*\][\s\S]*?\[\s*\/\s*INNER_VOICE\s*\]/gi, '').trim();
                    }

                    // åˆ†å¥å‘é€
                    const segments = cleanReply.split(/###|\n\n/).filter(s => s.trim());
                    for (const seg of segments) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        WeChatUI.pushMessage('text', seg.trim(), 'ai', 'text', null, cid);
                    }

                } catch (e) {
                    console.error('[triggerAIResponse] Error:', e);
                    if (isCurrentChat) {
                        const tempBubble = document.getElementById(tempId);
                        if (tempBubble) tempBubble.closest('.msg-row').remove();
                    }
                }
            },

            sendUserMessage: (generate) => {
                // ã€ä¿®å¤ã€‘åœ¨ç”¨æˆ·ç‚¹å‡»å‘é€çš„ä¸€ç¬é—´ï¼Œå¼ºåˆ¶å”¤é†’éŸ³é¢‘å¼•æ“
                if (window.Tone) {
                    Tone.start().then(() => {
                        if (Tone.context.state !== 'running') Tone.context.resume();
                    }).catch(e => console.log('Audio start failed', e));
                }

                const inputEl = document.getElementById('chat-input');
                const text = inputEl.value;
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];

                // Get generate button element
                const generateBtn = document.getElementById('generate-btn');

                if (text) {
                    // æ£€æµ‹æ˜¯å¦æ˜¯URLï¼Œå¦‚æœæ˜¯ï¼Œè®¾ç½®ä¸ºå›¾ç‰‡ç±»å‹
                    const urlRegex = /^(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|bmp|webp|svg))$/i;
                    const isUrl = urlRegex.test(text.trim());
                    const type = WeChatUI.isVoiceMode ? 'voice' : (isUrl ? 'image' : 'text');

                    // è®°å½•ç”¨æˆ·å‘é€æ¶ˆæ¯
                    if (window.SystemLog) {
                        SystemLog.write('SYS', 'ç”¨æˆ·å‘é€æ¶ˆæ¯', text);
                    }

                    WeChatUI.pushMessage(type, text);
                    inputEl.value = '';

                    // å‘é€æ¶ˆæ¯åæ¸…é™¤å¼•ç”¨
                    WeChatUI.clearQuote();
                }

                if (generate) {
                    WeChatUI.triggerAIResponse(cid);
                }
            },


            // å‘é€/æ¨é€æ¶ˆæ¯æ ¸å¿ƒå‡½æ•° (ä¿®å¤ç‰ˆï¼šæ”¯æŒåå°æŒ‡å®š ID æ¥æ”¶ï¼Œæ”¯æŒé¢å¤–æ•°æ®) 
            pushMessage: (type, content, role = 'user', msgType, emojiName, targetCharId = null, extraData = null) => {
                // ã€è°ƒè¯•å¼¹çª—ã€‘å¼ºåˆ¶ç¡®è®¤å·²è¢«åŠ è½½ (ç¡®è®¤åå¯åˆ é™¤)
                // alert(`ã€è°ƒè¯•ã€‘æ­£åœ¨å‘é€æ¶ˆæ¯: ${type}`);
                console.log(`[DEBUG_PUSH] Start pushing msg. Type: ${type}, targetCid: ${targetCharId}`);
                const chatDetailEl = document.getElementById('subpage-chat-detail');

                // ã€æ ¸å¿ƒä¿®å¤ã€‘å¦‚æœä¼ å…¥äº† targetCharId (æŸ¥å²—/åå°æ¶ˆæ¯)ï¼Œå°±ç”¨ä¼ å…¥çš„ï¼›å¦åˆ™ç”¨å½“å‰ç•Œé¢çš„ 
                const cid = targetCharId || (chatDetailEl ? chatDetailEl.dataset.charId : null);
                console.log(`[DEBUG_PUSH] Resolved cid: ${cid}`);

                if (!cid) {
                    console.error("pushMessage å¤±è´¥: æ‰¾ä¸åˆ°ç›®æ ‡è§’è‰² ID");
                    return;
                }

                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid]) {
                    console.error(`[DEBUG_PUSH] Character not found for cid: ${cid}`);
                    return;
                }
                if (!chars[cid].msgs) chars[cid].msgs = [];

                // ä»é€šè®¯å½•å‘èµ·èŠå¤©æ—¶ï¼Œé‡ç½®deletedå±æ€§ 
                chars[cid].deleted = false;

                // å¤„ç†å¼•ç”¨ (åªæœ‰å½“å‰ç•Œé¢æ‰éœ€è¦å¤„ç†å¼•ç”¨) 
                let quoteContent = '';
                const isCurrentChat = chatDetailEl && chatDetailEl.classList.contains('active') && chatDetailEl.dataset.charId === cid;
                if (isCurrentChat) {
                    quoteContent = WeChatUI.currentQuote || '';
                }

                // åŸºç¡€æ¶ˆæ¯å¯¹è±¡ 
                let msgObj = {
                    id: WeChatUI.generateMsgId(),
                    role,
                    type: (msgType === 'emoji' ? 'image' : msgType) || type,
                    content: content,
                    timestamp: Date.now(),
                    timestamp: Date.now(),
                    quote: quoteContent
                };

                // åˆå¹¶é¢å¤–æ•°æ® (å¦‚ innerVoice)
                if (extraData) {
                    Object.assign(msgObj, extraData);
                }

                // è¡¨æƒ…åŒ…é€»è¾‘ 
                if (type === 'image') {
                    msgObj.originalContent = content;
                    if (emojiName) {
                        try {
                            const decodedName = decodeURIComponent(emojiName);
                            // å­˜å‚¨ä¸º [è¡¨æƒ…åŒ…: åç§°] æ ¼å¼ï¼Œä¾¿äºåç»­è¯†åˆ«å’Œç¼–è¾‘
                            msgObj.content = `[è¡¨æƒ…åŒ…: ${decodedName}]`;
                        } catch (e) {
                            // å­˜å‚¨ä¸º [è¡¨æƒ…åŒ…: åç§°] æ ¼å¼ï¼Œä¾¿äºåç»­è¯†åˆ«å’Œç¼–è¾‘
                            msgObj.content = `[è¡¨æƒ…åŒ…: ${emojiName}]`;
                        }
                    } else {
                        // ç›´æ¥ä½¿ç”¨URLä½œä¸ºcontentï¼Œè¿™æ ·æ¶ˆæ¯ä¼šç›´æ¥æ˜¾ç¤ºä¸ºå›¾ç‰‡
                        msgObj.content = content;
                    }
                }

                // å…¶ä»–ç±»å‹å¤„ç† 
                if (type === 'transfer' || msgType === 'transfer') msgObj = { ...msgObj, role, type: 'transfer', amount: content.amount, note: content.note, content: 'è½¬è´¦', status: null, paymentId: WeChatUI.getNextPaymentNumber() };
                if (type === 'redpacket' || msgType === 'redpacket') msgObj = { ...msgObj, role, type: 'redpacket', note: content.note, content: 'çº¢åŒ…', amount: content.amount, status: null, paymentId: WeChatUI.getNextPaymentNumber() };
                if (type === 'voice' || msgType === 'voice') msgObj = { ...msgObj, role, type: 'voice', text: content, content: 'Voice', expanded: false, playing: false };
                if (type === 'error') msgObj = { role: 'system', type: 'error', content: content };

                // æ¨å…¥æ¶ˆæ¯æ•°ç»„ 
                chars[cid].msgs.push(msgObj);

                // ã€æ–°å¢ã€‘å½“ç”¨æˆ·å‘é€è½¬è´¦/çº¢åŒ…æ—¶:
                // 1. æ³¨å…¥éšè—çš„ç³»ç»Ÿæç¤ºï¼Œå¼•å¯¼AIæ¥å—æˆ–æ‹’ç»
                // 2. è‡ªåŠ¨è®°å…¥é’±åŒ… "å¾…ç¡®è®¤" æ”¶å…¥ (æˆ–è€…ç›´æ¥è®°å…¥? é€šå¸¸éœ€è¦AIé¢†å–ã€‚ä½†ç”¨æˆ·è¯´äº†"å®æ—¶è®°å½•", æˆ‘ä»¬å¯ä»¥å…ˆè®°ä¸ªçŠ¶æ€ï¼Œæˆ–è€…ç›´æ¥åŠ é’±)
                // æ ¹æ®ç”¨æˆ·åé¦ˆï¼š"charé’±åŒ…è®°å¾—æœ‰å…¥è´¦è®°å½•...åƒæˆ‘çš„é’±åŒ…ä¸€æ ·" -> æ„å‘³ç€åªè¦å‘ç”Ÿäº†äº¤æ˜“å°±è®°å½•ã€‚
                // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å‘äº†çº¢åŒ…ï¼ŒAI "è‡ªåŠ¨" ä¼šé¢†å– (æˆ–æœ€ç»ˆä¼šé¢†å–)ã€‚
                // æ›´å¥½çš„é€»è¾‘æ˜¯ï¼šAI é¢†å–æ—¶æ‰åŠ é’±ã€‚
                // ä½†ç”¨æˆ·æŠ±æ€¨çš„æ˜¯ "åªæœ‰æ‰£æ¬¾"ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡³å°‘è¦ç¡®ä¿ AI é¢†å–æ—¶æœ‰å…¥è´¦ã€‚
                // æ£€æŸ¥ `triggerActiveMessage` æˆ– `SettingsLogic` è§£æå›å¤æ—¶æ˜¯å¦æœ‰ `[é¢†å–çº¢åŒ…:xxx]` é€»è¾‘ã€‚
                // å¦‚æœæ²¡æœ‰ï¼Œæˆ–è€…å¾ˆéš¾æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨è¿™é‡Œåšä¸€ä¸ª "æ”¶å…¥è®°å½•" (å³ä½¿æœªé¢†å–ä¹Ÿæ˜¾ç¤ºï¼Œæˆ–è€…çŠ¶æ€ä¸º pending)ã€‚
                // é‰´äºç”¨æˆ·è¦æ±‚ "å®æ—¶è®°å½•"ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè®°å½•ä¸€æ¡ Transactionã€‚

                if (role === 'user' && (msgObj.type === 'redpacket' || msgObj.type === 'transfer')) {
                    const typeText = msgObj.type === 'redpacket' ? 'çº¢åŒ…' : 'è½¬è´¦';
                    const amount = parseFloat(content.amount) || 0;
                    const note = content.note || 'æ— å¤‡æ³¨';
                    const paymentId = msgObj.paymentId;

                    // è®°å…¥é’±åŒ… (ä½œä¸ºæ”¶å…¥)
                    if (typeof WalletLogic !== 'undefined' && WalletLogic.addTransaction) {
                        WalletLogic.addTransaction(cid, {
                            type: 'income',
                            amount: amount,
                            title: `æ”¶åˆ°${typeText} - ${note}`,
                            time: new Date().toLocaleString(),
                            category: 'äººæƒ…å¾€æ¥'
                        });
                    }

                    // åˆ›å»ºéšè—ç³»ç»Ÿæ¶ˆæ¯
                    const hiddenSystemMsg = {
                        id: WeChatUI.generateMsgId(),
                        role: 'system',
                        type: 'system',
                        content: `[ç³»ç»Ÿæç¤ºï¼šæ”¶åˆ°ç”¨æˆ·${typeText}ï¼ˆé‡‘é¢ï¼šÂ¥${amount}ï¼‰ã€‚æ­¤äº¤æ˜“çš„å”¯ä¸€æ•°å­—IDæ˜¯ ${paymentId}ï¼ˆè¯·æ³¨æ„ï¼šè¿™æ˜¯ç³»ç»Ÿåˆ†é…çš„IDï¼Œç»å¯¹ä¸æ˜¯é‡‘é¢ï¼ï¼‰ã€‚\nè¯·åœ¨å›å¤ä¸­è¡¨æ˜æ€åº¦ï¼Œå¹¶åœ¨æœ€åå¦èµ·ä¸€è¡Œï¼Œä¸¥æ ¼ç…§æŠ„ä»¥ä¸‹æŒ‡ä»¤ä¹‹ä¸€ï¼ˆä¸è¦ä¿®æ”¹æ•°å­—ï¼‰ï¼š\n- æ¥å—ï¼š[é¢†å–${typeText}:${paymentId}]\n- æ‹’æ”¶ï¼š[æ‹’æ”¶${typeText}:${paymentId}]\n]`,
                        timestamp: Date.now(),
                        hidden: true
                    };

                    chars[cid].msgs.push(hiddenSystemMsg);
                }

                // ã€æ ¸å¿ƒä¿®å¤ã€‘æœªè¯»è®¡æ•°å’Œé€šçŸ¥é€»è¾‘ 
                // å¦‚æœå½“å‰ä¸åœ¨è¯¥è§’è‰²çš„èŠå¤©ç•Œé¢ï¼Œå¢åŠ æœªè¯»æ•° 
                if (!isCurrentChat && role === 'ai') {
                    chars[cid].unread = (chars[cid].unread || 0) + 1;
                    // æ˜¾ç¤ºå…¨å±€åº”ç”¨å†…é€šçŸ¥æ¡ 
                    WeChatUI.showGlobalNotification(chars[cid].name, msgObj.content, chars[cid].avatar, cid);
                }

                // é’±åŒ…æ‰£æ¬¾é€»è¾‘ 
                if (role === 'user' && (msgObj.type === 'redpacket' || msgObj.type === 'transfer')) {
                    const amount = parseFloat(content.amount || '0');
                    const typeText = msgObj.type === 'redpacket' ? 'çº¢åŒ…' : 'è½¬è´¦';
                    WeChatUI.updateWalletBalance('expense', amount, `å‘${chars[cid].name}å‘é€${typeText}`);
                }

                // ä¿å­˜æ•°æ® 
                AppStorage.set('wechat_chars', chars);

                // ã€æ ¸å¿ƒä¿®å¤ã€‘æ•°æ®è½ç›˜åå†æ£€æŸ¥è‡ªåŠ¨æ€»ç»“ï¼Œé˜²æ­¢æ€»ç»“é€»è¾‘è¯»å–åˆ°æ—§çš„å¿«ç…§
                WeChatUI.checkAutoSummary(cid);

                // åªè¦å½“æˆ‘ä»¬åœ¨è¯¥è§’è‰²çš„ç•Œé¢æ—¶ï¼Œæ‰ç«‹å³åˆ·æ–° UI 
                if (isCurrentChat) {
                    // ã€å…³é”®æ€§èƒ½ä¿®å¤ã€‘å¦‚æœåªæ˜¯æ–°å¢ä¸€æ¡æ¶ˆæ¯ï¼Œä¸è¦ loadChat(cid) [æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“å…¨éƒ¨æ¶ˆæ¯]
                    // è¿™æ ·å¯ä»¥æå¤§åœ°ç¼“è§£æ•°åƒæ¡æ¶ˆæ¯æ—¶çš„å¡é¡¿é—®é¢˜
                    const container = document.getElementById('chat-messages-container');
                    if (container) {
                        const cachedUserProfile = AppStorage.get('wechat_user_profile', {});
                        WeChatUI.renderMessage(container, msgObj, cid, chars[cid].msgs.length - 1, chars, cachedUserProfile);

                        // å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
                        requestAnimationFrame(() => {
                            container.scrollTop = container.scrollHeight;
                        });
                    } else {
                        WeChatUI.loadChat(cid);
                    }
                    WeChatUI.renderList();
                } else {
                    // å¦‚æœä¸åœ¨ç•Œé¢ï¼Œåªåˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºçº¢ç‚¹ 
                    WeChatUI.renderList();
                }

                // è‡ªåŠ¨æœ—è¯»é€»è¾‘ (ä»…å½“å‰ç•Œé¢ï¼Œæ”¹ä¸ºæŒ‰è§’è‰²åˆ¤æ–­) 
                if (chars[cid].autoTTS && isCurrentChat && role === 'ai' && (type === 'text' || type === 'voice')) {
                    let textToRead = type === 'voice' ? (msgObj.text || content) : (msgObj.content || '');
                    textToRead = textToRead.replace(/<[^>]+>/g, '').replace(/\([^)]*\)|ï¼ˆ[^ï¼‰]*ï¼‰|\[.*?\]|\{.*?\}/g, '').replace(/\[å›¾ç‰‡\]|\[è¡¨æƒ…åŒ….*?\]/g, '').trim();
                    if (textToRead) {
                        const char = AppStorage.get('wechat_chars', {})[cid];
                        WeChatUI.addToTTSQueue(textToRead, char);
                    }
                }
            },

            // ========================================
            // è½¬è´¦/çº¢åŒ…å¼¹çª—åŠŸèƒ½å‡½æ•°
            // ========================================
            showTransferModal: (type) => {
                console.log('[showTransferModal] å‡½æ•°è¢«è°ƒç”¨! type=', type);

                // type: 'transfer' æˆ– 'redpacket'
                const modal = document.getElementById('modal-transfer');
                const title = document.getElementById('transfer-title');

                console.log('[showTransferModal] modalå…ƒç´ :', modal);
                console.log('[showTransferModal] titleå…ƒç´ :', title);

                if (!modal || !title) {
                    console.error('[showTransferModal] é”™è¯¯: æ‰¾ä¸åˆ°å¼¹çª—å…ƒç´ !');
                    alert('é”™è¯¯: æ‰¾ä¸åˆ°å¼¹çª—å…ƒç´ ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                // è®¾ç½®æ ‡é¢˜
                if (type === 'redpacket') {
                    title.textContent = 'å‘çº¢åŒ…';
                } else {
                    title.textContent = 'è½¬è´¦';
                }

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('transfer-amount').value = '';
                document.getElementById('transfer-note').value = '';

                // å­˜å‚¨ç±»å‹ä¾›åç»­ä½¿ç”¨
                modal.dataset.transferType = type;

                console.log('[showTransferModal] å‡†å¤‡æ‰“å¼€å¼¹çª—...');

                // æ‰“å¼€å¼¹çª—
                try {
                    ModalManager.open('modal-transfer');
                    console.log('[showTransferModal] å¼¹çª—å·²æ‰“å¼€!');
                } catch (e) {
                    console.error('[showTransferModal] æ‰“å¼€å¼¹çª—å¤±è´¥:', e);
                    alert('æ‰“å¼€å¼¹çª—å¤±è´¥: ' + e.message);
                }
            },

            confirmTransfer: () => {
                const modal = document.getElementById('modal-transfer');
                const type = modal.dataset.transferType || 'transfer';
                const amount = document.getElementById('transfer-amount').value;
                const note = document.getElementById('transfer-note').value || (type === 'redpacket' ? 'æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©' : 'è½¬è´¦');

                // éªŒè¯é‡‘é¢
                if (!amount || isNaN(parseFloat(amount)) || parseFloat(amount) <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                    return;
                }

                // å‘é€æ¶ˆæ¯
                const content = {
                    amount: parseFloat(amount).toFixed(2),
                    note: note
                };

                WeChatUI.pushMessage(type, content);

                // å…³é—­å¼¹çª—
                ModalManager.close('modal-transfer');

                // æ˜¾ç¤ºæç¤º
                console.log('[è½¬è´¦/çº¢åŒ…] å·²å‘é€:', type, amount);
            },

            // ========================================
            // æœ‹å‹åœˆäº¤äº’åŠŸèƒ½å‡½æ•°
            // ========================================

            // æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†
            showCommentInput: (momentId) => {
                console.log('[æœ‹å‹åœˆ] æ˜¾ç¤ºè¯„è®ºè¾“å…¥æ¡†:', momentId);

                // ä¿å­˜å½“å‰æœ‹å‹åœˆID
                const modal = document.getElementById('modal-moment-comment');
                modal.dataset.momentId = momentId;

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('moment-comment-input').value = '';

                // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
            },

            // æäº¤è¯„è®º
            submitMomentComment: () => {
                const modal = document.getElementById('modal-moment-comment');
                const momentId = modal.dataset.momentId;
                const commentText = document.getElementById('moment-comment-input').value.trim();

                if (!commentText) {
                    alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
                    return;
                }

                WeChatUI.addComment(momentId, commentText);

                // å…³é—­å¼¹çª—
                modal.classList.add('hidden');
                modal.style.display = 'none';
            },

            // æ·»åŠ è¯„è®º
            addComment: (momentId, commentText) => {
                console.log('[æœ‹å‹åœˆ] æ·»åŠ è¯„è®º:', momentId, commentText);

                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);

                if (moment) {
                    moment.comments = moment.comments || [];
                    moment.comments.push({
                        id: Date.now(),
                        author: 'æˆ‘',
                        text: commentText,
                        timestamp: Date.now()
                    });

                    AppStorage.set('wechat_moments', moments);

                    // é‡æ–°åŠ è½½æœ‹å‹åœˆ
                    if (typeof WeChatUI.loadMoments === 'function') {
                        WeChatUI.loadMoments();
                    }

                    console.log('[æœ‹å‹åœˆ] è¯„è®ºå·²æ·»åŠ ');
                } else {
                    console.error('[æœ‹å‹åœˆ] æ‰¾ä¸åˆ°å¯¹åº”çš„æœ‹å‹åœˆ:', momentId);
                }
            },

            // åˆ†äº«æœ‹å‹åœˆ
            shareMoment: (momentId) => {
                console.log('[æœ‹å‹åœˆ] åˆ†äº«:', momentId);

                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) {
                    alert('æ‰¾ä¸åˆ°è¿™æ¡æœ‹å‹åœˆ');
                    return;
                }

                const modal = document.getElementById('modal-moment-share');
                modal.dataset.momentId = momentId;
                modal.dataset.momentData = JSON.stringify(moment);

                // åŠ è½½å¥½å‹åˆ—è¡¨
                WeChatUI.loadShareFriendList();

                // å¼ºåˆ¶æ˜¾ç¤ºå¼¹çª—
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
            },

            // åŠ è½½å¥½å‹åˆ—è¡¨
            loadShareFriendList: () => {
                const charsData = AppStorage.get('wechat_chars', {});
                const friends = Object.values(charsData);
                const listContainer = document.getElementById('share-friend-list');

                if (!listContainer) {
                    console.error('[åˆ†äº«] æ‰¾ä¸åˆ°å¥½å‹åˆ—è¡¨å®¹å™¨');
                    return;
                }

                if (!friends || friends.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— è”ç³»äºº<br><small>è¯·å…ˆåˆ›å»ºè™šæ‹Ÿè§’è‰²</small></div>';
                    return;
                }

                listContainer.innerHTML = friends.map(f => `
                    <div class="p-3 hover:bg-gray-100 rounded cursor-pointer flex items-center gap-3"
                         onclick="WeChatUI.shareToFriend('${f.id}')">
                        <img src="${f.avatar || ''}" 
                             class="w-12 h-12 rounded-lg bg-gray-200 object-cover"
                             onerror="this.style.display='none'">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800">${f.char_name || f.name || 'æœªå‘½å'}</div>
                            <div class="text-xs text-gray-400 truncate">${f.bio || ''}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                `).join('');

                console.log('[åˆ†äº«] å·²åŠ è½½', friends.length, 'ä¸ªå¥½å‹');
            },

            // æœç´¢å¥½å‹
            filterShareFriends: (keyword) => {
                const charsData = AppStorage.get('wechat_chars', {});
                const allFriends = Object.values(charsData);
                const filtered = keyword ? allFriends.filter(f => {
                    const name = f.char_name || f.name || '';
                    return name.toLowerCase().includes(keyword.toLowerCase());
                }) : allFriends;

                const listContainer = document.getElementById('share-friend-list');

                if (filtered.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-500 py-8">æœªæ‰¾åˆ°å¥½å‹</div>';
                    return;
                }

                listContainer.innerHTML = filtered.map(f => `
                    <div class="p-3 hover:bg-gray-100 rounded cursor-pointer flex items-center gap-3"
                         onclick="WeChatUI.shareToFriend('${f.id}')">
                        <img src="${f.avatar || ''}" 
                             class="w-12 h-12 rounded-lg bg-gray-200 object-cover"
                             onerror="this.style.display='none'">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800">${f.char_name || f.name || 'æœªå‘½å'}</div>
                            <div class="text-xs text-gray-400 truncate">${f.bio || ''}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                `).join('');
            },

            // åˆ†äº«ç»™å¥½å‹ (å¢å¼ºç‰ˆï¼šè‡ªåŠ¨è§¦å‘ AI å“åº”)
            shareToFriend: (friendId) => {
                const modal = document.getElementById('modal-moment-share');
                const momentData = JSON.parse(modal.dataset.momentData || '{}');

                console.log('[æœ‹å‹åœˆ] åˆ†äº«ç»™å¥½å‹:', friendId, momentData);

                // æ„å»ºæœ‹å‹åœˆå¡ç‰‡æ¶ˆæ¯å†…å®¹
                const shareContent = {
                    id: momentData.id,
                    text: momentData.content || 'åˆ†äº«äº†ä¸€æ¡æœ‹å‹åœˆ',
                    image: momentData.images && momentData.images[0] ? momentData.images[0] : null,
                    author: momentData.authorName || momentData.author || 'å¥½å‹',
                    momentId: momentData.id
                };

                // ä½¿ç”¨ share ç±»å‹å‘é€å¡ç‰‡æ¶ˆæ¯ (å‘é€ç»™ç‰¹å®šçš„å¥½å‹)
                WeChatUI.pushMessage('share', shareContent, 'user', 'share', null, friendId);

                // å…³é—­å¼¹çª—
                WeChatUI.closeShareModal();
                Utils.showToast('å·²åˆ†äº«ç»™å¥½å‹');

                // ç«‹å³æ‰“å¼€èŠå¤©
                setTimeout(() => {
                    WeChatUI.openChatDetail(friendId);
                    // è§¦å‘ AI å“åº”
                    setTimeout(() => {
                        const sysPrompt = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšæ‰å‘ä½ åˆ†äº«äº†ä¸€ç¯‡æœ‹å‹åœˆåŠ¨æ€ï¼Œæ¥è‡ªâ€œ${shareContent.author}â€ã€‚å†…å®¹æ˜¯ï¼šâ€œ${shareContent.text}â€ã€‚è¯·å¯¹æ­¤åšå‡ºç¬¦åˆä½ èº«ä»½çš„å›åº”ã€‚]`;
                        WeChatUI.triggerAIResponse(friendId, sysPrompt);
                    }, 500);
                }, 300);
            },

            // å…³é—­åˆ†äº«å¼¹çª—
            closeShareModal: () => {
                const modal = document.getElementById('modal-moment-share');
                modal.classList.add('hidden');
                modal.style.display = 'none';

                const searchInput = document.getElementById('share-friend-search');
                if (searchInput) searchInput.value = '';
            },

            // ç‚¹èµ
            likeMoment: (momentId) => {
                console.log('[æœ‹å‹åœˆ] ç‚¹èµ:', momentId);

                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);

                if (moment) {
                    moment.likes = moment.likes || [];

                    // æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
                    const myLikeIndex = moment.likes.findIndex(like => like === 'æˆ‘');

                    if (myLikeIndex >= 0) {
                        // å·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ
                        moment.likes.splice(myLikeIndex, 1);
                        console.log('[æœ‹å‹åœˆ] å–æ¶ˆç‚¹èµ');
                    } else {
                        // æœªç‚¹èµï¼Œæ·»åŠ ç‚¹èµ
                        moment.likes.push('æˆ‘');
                        console.log('[æœ‹å‹åœˆ] ç‚¹èµæˆåŠŸ');
                    }

                    AppStorage.set('wechat_moments', moments);

                    // é‡æ–°åŠ è½½æœ‹å‹åœˆ
                    if (typeof WeChatUI.loadMoments === 'function') {
                        WeChatUI.loadMoments();
                    }
                } else {
                    console.error('[æœ‹å‹åœˆ] æ‰¾ä¸åˆ°å¯¹åº”çš„æœ‹å‹åœˆ:', momentId);
                }
            },

            // å¬å”¤äº’åŠ¨ï¼ˆè®©AIå›å¤æœ‹å‹åœˆï¼‰
            // å¬å”¤äº’åŠ¨ (çœŸæ­£çš„ AI äº’åŠ¨å®ç°)
            summonInteraction: (momentId) => {
                console.log('[æœ‹å‹åœˆ] å¬å”¤äº’åŠ¨:', momentId);
                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) return;

                // éšæœºæŒ‘é€‰å‡ ä¸ª AI è§’è‰²æ¥äº’åŠ¨
                const chars = AppStorage.get('wechat_chars', {});
                const charIds = Object.keys(chars);
                if (charIds.length === 0) {
                    Utils.showToast('è¯·å…ˆåˆ›å»ºä¸€äº› AI è”ç³»äºº');
                    return;
                }

                Utils.showToast('æ­£åœ¨å¬å”¤å¥½å‹äº’åŠ¨...');

                // æŠ½å– 1-2 ä¸ªè§’è‰²
                const count = Math.min(charIds.length, 1 + Math.floor(Math.random() * 2));
                const selected = charIds.sort(() => 0.5 - Math.random()).slice(0, count);

                selected.forEach((cid, index) => {
                    setTimeout(() => {
                        const sysPrompt = `[ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·åˆšåˆšå‘å¸ƒ/æ›´æ–°äº†ä¸€æ¡æœ‹å‹åœˆã€‚å†…å®¹ï¼šâ€œ${moment.content}â€ã€‚è¯·ä½ å¯¹æ­¤åŠ¨æ€è¿›è¡Œäº’åŠ¨ã€‚ä½ å¯ä»¥é€‰æ‹©ï¼š\n1. [ç‚¹èµ: ${moment.id}]\n2. [è¯„è®º: ${moment.id} ä½ çš„è¯„è®ºå†…å®¹]\nè¯·åœ¨æ¶ˆæ¯æœ€ååŒ…å«ä¸Šè¿°æŒ‡ä»¤ä¹‹ä¸€ã€‚ä½ å¯ä»¥å…ˆå‘ä¸€æ®µç®€çŸ­çš„ç§èŠæ¥å‘Šè¯‰ç”¨æˆ·ä½ çœ‹äº†TAçš„æœ‹å‹åœˆã€‚]`;
                        WeChatUI.triggerAIResponse(cid, sysPrompt);
                    }, index * 2000);
                });
            },

            // ã€ä¿®å¤ç‰ˆã€‘ç»‘å®šé•¿æŒ‰äº‹ä»¶å‡½æ•°ï¼ˆå¯è¢«å¤šæ¬¡è°ƒç”¨ï¼‰
            bindLongPressEvents: () => {
                // å…ˆç§»é™¤æ‰€æœ‰æ—§çš„long-press-boundæ ‡è®°ï¼Œç¡®ä¿é‡æ–°ç»‘å®š
                document.querySelectorAll('.long-press-bound').forEach(el => {
                    el.classList.remove('long-press-bound');
                });

                // é€‰æ‹©æ‰€æœ‰èŠå¤©åˆ—è¡¨å’Œé€šè®¯å½•å…ƒç´ 
                const chatList = document.getElementById('tab-chat');
                const contactsList = document.getElementById('tab-contacts');

                let chatItems = [];
                let contactItems = [];

                if (chatList) {
                    chatItems = Array.from(chatList.querySelectorAll('div[onclick]'));
                }

                if (contactsList) {
                    contactItems = Array.from(contactsList.querySelectorAll('div[onclick]'));
                }

                const elements = [...chatItems, ...contactItems];
                // console.log(`[bindLongPressEvents] æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ å‡†å¤‡ç»‘å®š`);

                elements.forEach((element, idx) => {
                    // æ ‡è®°è¯¥å…ƒç´ å·²ç»‘å®šï¼Œé˜²æ­¢ä¸‹æ¬¡é‡å¤å¤„ç†
                    element.classList.add('long-press-bound');

                    let longPressTimer;
                    let isLongPress = false; // æ ‡è®°æ˜¯å¦è§¦å‘äº†é•¿æŒ‰

                    // è§¦æ‘¸å¼€å§‹
                    element.addEventListener('touchstart', function (e) {
                        // console.log(`[è§¦æ‘¸ #${idx}] touchstart è¢«è§¦å‘!`);
                        // åªå¤„ç†å•ä¸ªè§¦æ‘¸ç‚¹
                        if (e.touches.length > 1) {
                            // console.log(`[è§¦æ‘¸ #${idx}] å¤šç‚¹è§¦æ‘¸ï¼Œå¿½ç•¥`);
                            return;
                        }

                        isLongPress = false;
                        const target = this;

                        // å¯åŠ¨è®¡æ—¶å™¨
                        console.log(`[è§¦æ‘¸ #${idx}] å¯åŠ¨500msè®¡æ—¶å™¨`);
                        longPressTimer = setTimeout(function () {
                            console.log(`[è§¦æ‘¸ #${idx}] 500msåˆ°äº†ï¼Œè§¦å‘é•¿æŒ‰!`);
                            isLongPress = true; // æ ‡è®°å·²è§¦å‘é•¿æŒ‰

                            // åˆ›å»ºæ¨¡æ‹Ÿäº‹ä»¶å¯¹è±¡
                            const touch = e.touches[0];
                            const mockEvent = {
                                preventDefault: () => { },
                                stopPropagation: () => { },
                                clientX: touch.clientX,
                                clientY: touch.clientY,
                                target: target
                            };

                            // è·å–å…ƒç´ çš„onclickå±æ€§ï¼Œæå–id
                            const onClick = target.getAttribute('onclick');
                            const idMatch = onClick.match(/'([^']+)'/);

                            if (idMatch) {
                                const id = idMatch[1];
                                // åˆ¤æ–­æ˜¯èŠå¤©åˆ—è¡¨è¿˜æ˜¯é€šè®¯å½•
                                const listType = target.closest('#tab-chat') ? 'chat' : 'contact';

                                console.log(`[è§¦æ‘¸] æå–åˆ°çš„id: ${id}, listType: ${listType}`);

                                // ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œä¼ é€’æ­£ç¡®çš„å‚æ•°
                                try {
                                    WeChatUI.showContactMenu(mockEvent, id, listType);
                                    console.log('[è§¦æ‘¸] å‡½æ•°è°ƒç”¨æˆåŠŸ!');

                                    // è§¦å‘éœ‡åŠ¨åé¦ˆ (å¦‚æœè®¾å¤‡æ”¯æŒ)
                                    if (navigator.vibrate) navigator.vibrate(50);
                                } catch (err) {
                                    console.error('[è§¦æ‘¸] å‡½æ•°è°ƒç”¨å¤±è´¥:', err);
                                }
                            }
                        }, 500); // 500msé•¿æŒ‰è§¦å‘æ—¶é—´
                    }, { passive: true }); // passive: true ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½

                    // é¼ æ ‡å³é”®èœå•
                    element.addEventListener('contextmenu', function (e) {
                        console.log(`[é¼ æ ‡å³é”®] contextmenu è¢«è§¦å‘!`);
                        e.preventDefault();
                        e.stopPropagation();

                        // è·å–å…ƒç´ çš„onclickå±æ€§ï¼Œæå–id
                        const onClick = this.getAttribute('onclick');
                        const idMatch = onClick.match(/'([^']+)'/);

                        if (idMatch) {
                            const id = idMatch[1];
                            // åˆ¤æ–­æ˜¯èŠå¤©åˆ—è¡¨è¿˜æ˜¯é€šè®¯å½•
                            const listType = this.closest('#tab-chat') ? 'chat' : 'contact';

                            console.log(`[é¼ æ ‡å³é”®] æå–åˆ°çš„id: ${id}, listType: ${listType}`);

                            // ç›´æ¥è°ƒç”¨å‡½æ•°ï¼Œä¼ é€’æ­£ç¡®çš„å‚æ•°
                            try {
                                WeChatUI.showContactMenu(e, id, listType);
                                console.log('[é¼ æ ‡å³é”®] å‡½æ•°è°ƒç”¨æˆåŠŸ!');
                            } catch (err) {
                                console.error('[é¼ æ ‡å³é”®] å‡½æ•°è°ƒç”¨å¤±è´¥:', err);
                            }
                        }
                    });

                    // è§¦æ‘¸ç»“æŸ/ç§»åŠ¨/å–æ¶ˆæ—¶ï¼Œæ¸…é™¤è®¡æ—¶å™¨
                    const clearTimer = function (e) {
                        if (longPressTimer) {
                            clearTimeout(longPressTimer);
                            longPressTimer = null;
                        }
                        // å¦‚æœå·²ç»è§¦å‘äº†é•¿æŒ‰ï¼Œé˜»æ­¢é»˜è®¤çš„ç‚¹å‡»äº‹ä»¶ï¼ˆé˜²æ­¢é•¿æŒ‰æ¾æ‰‹åè§¦å‘ç‚¹å‡»è¿›å…¥è¯¦æƒ…ï¼‰
                        if (isLongPress && e.type === 'touchend') {
                            if (e.cancelable) e.preventDefault();
                        }
                    };

                    element.addEventListener('touchend', clearTimer);
                    element.addEventListener('touchmove', clearTimer); // æ‰‹æŒ‡ç§»åŠ¨ä¹Ÿè§†ä¸ºå–æ¶ˆé•¿æŒ‰
                    element.addEventListener('touchcancel', clearTimer);
                });
            },

            // åˆå§‹åŒ–é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
            initLongPress: () => {
                // åˆå§‹è¿è¡Œä¸€æ¬¡
                WeChatUI.bindLongPressEvents();

                // ã€ä¿®å¤ã€‘åªåˆ›å»ºä¸€æ¬¡ MutationObserverï¼Œé˜²æ­¢é‡å¤åˆ›å»º
                if (!WeChatUI.longPressObserver) {
                    WeChatUI.longPressObserver = new MutationObserver((mutations) => {
                        // DOM å˜åŒ–æ—¶è‡ªåŠ¨ç»‘å®šæ–°å…ƒç´ 
                        WeChatUI.bindLongPressEvents();
                    });
                    WeChatUI.longPressObserver.observe(document.body, { childList: true, subtree: true });
                }
            },

            showContextMenu: (e, msgId) => {
                console.log('[showContextMenu] å‡½æ•°è¢«è°ƒç”¨! msgId:', msgId, 'event:', e);
                e.preventDefault();
                if (WeChatUI.isMultiSelect) {
                    console.log('[showContextMenu] å¤šé€‰æ¨¡å¼æ¿€æ´»ï¼Œå¿½ç•¥');
                    return;
                }
                console.log('[showContextMenu] å‡†å¤‡æ˜¾ç¤ºèœå•...');
                WeChatUI.ctxTargetMsgId = msgId; // å­˜å‚¨ ID è€Œä¸æ˜¯ Index
                const menu = document.getElementById('context-menu');
                if (!menu) {
                    console.error('[showContextMenu] é”™è¯¯ï¼šæ‰¾ä¸åˆ° context-menu å…ƒç´ !');
                    return;
                }

                console.log('[showContextMenu] èœå•å…ƒç´ æ‰¾åˆ°ï¼Œè®¾ç½®æ ·å¼...');

                // ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶è®¾ç½®èœå•æ ·å¼ï¼Œç¡®ä¿å¯è§
                menu.style.display = 'block';
                menu.style.position = 'fixed';
                menu.style.zIndex = '999999';
                menu.style.backgroundColor = '#2b2b2b';
                menu.style.borderRadius = '8px';
                menu.style.padding = '8px 0';
                menu.style.boxShadow = '0 5px 20px rgba(0,0,0,0.6)';
                menu.style.minWidth = '140px';

                // ç§»é™¤hiddenç±»
                menu.classList.remove('hidden');

                // Get menu dimensions after displaying it
                menu.style.opacity = '0'; // Temporarily hide to get dimensions
                const menuRect = menu.getBoundingClientRect();
                console.log('[showContextMenu] èœå•å°ºå¯¸:', menuRect);
                menu.style.opacity = '1';

                // Calculate position to keep menu within viewport
                let top = e.clientY;
                let left = e.clientX;

                console.log(`[showContextMenu] åˆå§‹ä½ç½®: (${left}, ${top})`);

                // Adjust for bottom overflow
                if (top + menuRect.height > window.innerHeight) {
                    top = window.innerHeight - menuRect.height - 5; // 5px padding
                }
                // Adjust for top overflow
                if (top < 0) {
                    top = 5; // 5px padding
                }
                // Adjust for right overflow
                if (left + menuRect.width > window.innerWidth) {
                    left = window.innerWidth - menuRect.width - 5; // 5px padding
                }
                // Adjust for left overflow
                if (left < 0) {
                    left = 5; // 5px padding
                }

                menu.style.top = top + 'px';
                menu.style.left = left + 'px';

                console.log(`[showContextMenu] æœ€ç»ˆä½ç½®: (${left}, ${top})`);
                console.log('[showContextMenu] èœå•å·²æ˜¾ç¤º!');
            },
            hideContextMenu: () => {
                // æ·»åŠ hiddenç±»æ¥éšè—èœå•
                document.getElementById('context-menu').classList.add('hidden');
                document.getElementById('contact-context-menu').classList.add('hidden');
            },
            // ã€æ¢å¤ã€‘æ˜¾ç¤ºè¡¨æƒ…é¢æ¿ (å¸¦æœç´¢å’Œæ ‡ç­¾çš„å®Œæ•´ç‰ˆ)
            showEmojiPicker: () => {
                const panel = document.getElementById('emoji-panel');
                if (!panel) return;

                if (panel.style.display === 'block') {
                    panel.style.display = 'none';
                    return;
                }

                // 1. åˆå§‹åŒ–é¢æ¿æ ·å¼å’Œç»“æ„
                panel.style.display = 'block';
                panel.style.backgroundColor = '#f9fafb';
                panel.style.borderRadius = '12px';
                panel.style.border = '1px solid #e5e7eb';
                panel.style.padding = '12px';
                panel.style.marginTop = '8px';
                panel.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';

                // 2. æ³¨å…¥å®Œæ•´ç»“æ„ (æœç´¢æ  + ç­›é€‰ + ç½‘æ ¼)
                panel.innerHTML = `
                    <div class="flex flex-col gap-3">
                        <!-- é¡¶éƒ¨å·¥å…·æ  -->
                        <div class="flex gap-2 items-center">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                                <input type="text" id="emoji-search-input" 
                                    class="w-full bg-white border border-gray-200 rounded-full py-1.5 pl-8 pr-4 text-sm focus:outline-none focus:border-blue-400 transition-colors"
                                    placeholder="æœç´¢è¡¨æƒ…åŒ…åç§°..." 
                                    oninput="WeChatUI.filterEmojiPicker(this.value)">
                            </div>
                            <button onclick="document.getElementById('emoji-search-input').value=''; WeChatUI.filterEmojiPicker('')" 
                                class="px-3 py-1.5 bg-white border border-gray-200 rounded-full text-xs text-gray-600 hover:bg-gray-50 transition-colors">
                                æ¸…ç©º
                            </button>
                        </div>

                        <!-- å¿«æ·åˆ†ç±» (å¯é€‰ï¼Œæ ¹æ® Image 1 ä¼¼ä¹æœ‰ç­›é€‰æ ‡ç­¾) -->
                        <!-- 
                        <div class="flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
                            <span class="px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs whitespace-nowrap">å…¨éƒ¨</span>
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs whitespace-nowrap">æˆ‘çš„æ”¶è—</span>
                        </div>
                        -->

                        <!-- è¡¨æƒ…ç½‘æ ¼å®¹å™¨ -->
                        <div id="emoji-picker-grid" class="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto p-1 custom-scrollbar">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                `;

                // 3. è·å–å¹¶æ¸²æŸ“æ•°æ®
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const charEmojis = c ? (c.emojis || []) : [];
                // ç¡®ä¿å»é‡ (Optional)
                const allEmojis = [...globalEmojis, ...charEmojis];

                // ä¿å­˜å½“å‰åˆ—è¡¨ä¾›æœç´¢ä½¿ç”¨
                WeChatUI.currentEmojiList = allEmojis;

                // æ¸²æŸ“
                WeChatUI.renderEmojiPickerGrid(allEmojis);

                // æ»šåŠ¨åˆ°åº•éƒ¨ (é˜²æ­¢é”®ç›˜é®æŒ¡)
                setTimeout(() => {
                    const container = document.getElementById('chat-messages-container');
                    if (container) container.scrollTop = container.scrollHeight;
                }, 100);

                // é˜»æ­¢å†’æ³¡
                panel.onclick = function (event) {
                    event.stopPropagation();
                };

                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                const clickOutsideHandler = function (event) {
                    if (!panel.contains(event.target) && !event.target.closest('[onclick*="showEmojiPicker"]')) {
                        panel.style.display = 'none';
                        document.removeEventListener('click', clickOutsideHandler);
                    }
                };
                setTimeout(() => {
                    document.addEventListener('click', clickOutsideHandler);
                }, 0);
            },

            // ã€æ–°å¢ã€‘ç‹¬ç«‹çš„ Grid æ¸²æŸ“å‡½æ•°
            renderEmojiPickerGrid: (list) => {
                const gridEl = document.getElementById('emoji-picker-grid');
                if (!gridEl) return;

                if (list.length === 0) {
                    gridEl.innerHTML = '<div class="col-span-5 text-center text-gray-400 text-xs py-8">æš‚æ— è¡¨æƒ…åŒ…<br>è¯·åœ¨è§’è‰²è®¾ç½®ä¸­æ·»åŠ </div>';
                    return;
                }

                gridEl.innerHTML = list.map((emoji, index) => {
                    const encodedName = emoji.name ? encodeURIComponent(emoji.name) : '';
                    const displayName = emoji.name || 'è¡¨æƒ…';
                    return `
                    <div class="bg-white rounded-lg border border-gray-100 p-2 flex flex-col items-center gap-1 cursor-pointer hover:border-blue-300 hover:shadow-sm transition-all relative group"
                        onclick="WeChatUI.selectEmoji('${emoji.url}', '${encodedName}')">
                        
                        <div class="w-full aspect-square rounded overflow-hidden bg-gray-50 flex items-center justify-center">
                            <img src="${emoji.url}" class="w-full h-full object-cover">
                        </div>
                        
                        <div class="text-[10px] text-gray-500 truncate w-full text-center scale-90 origin-center leading-tight">
                            ${displayName}
                        </div>

                        <!-- æ ‡ç­¾ -->
                        <div class="absolute top-1 right-1 text-[8px] px-1 rounded bg-opacity-80 text-white ${emoji.type === 'global' ? 'bg-blue-400' : 'bg-pink-400'} scale-75 origin-top-right">
                            ${emoji.type === 'global' ? 'å…¨' : 'ä¸“'}
                        </div>
                    </div>
                    `;
                }).join('');
            },

            // ã€æ–°å¢ã€‘é€‰ä¸­è¡¨æƒ…é€»è¾‘
            selectEmoji: (url, name) => {
                WeChatUI.pushMessage('image', url, 'user', 'emoji', name);
                document.getElementById('emoji-panel').style.display = 'none';
            },

            hideEmojiPicker: () => {
                const panel = document.getElementById('emoji-panel');
                if (panel && panel.style.display === 'block') {
                    panel.style.display = 'none';
                }
            },

            // ===========================
            // ã€æ¢å¤ã€‘è¡¨æƒ…åŒ…ç®¡ç†åŠŸèƒ½ (ä¸Šä¼ /åˆ é™¤/åˆ†ç±»)
            // ===========================

            // æ‰“å¼€ä¸Šä¼ å¼¹çª—
            // æ‰“å¼€ä¸Šä¼ å¼¹çª—
            openEmojiUpload: () => {
                const el = document.getElementById('modal-emoji-upload');
                if (el) {
                    el.classList.remove('hidden');
                    el.style.display = 'flex';
                    document.getElementById('emoji-url-input').focus();
                }
            },

            // ç¡®è®¤ä¸Šä¼ 
            confirmEmojiUpload: () => {
                const input = document.getElementById('emoji-url-input').value;
                const lines = input.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    Utils.showToast('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªURL');
                    return;
                }

                const emojiType = document.getElementById('emoji-type-select')?.value || 'exclusive';
                const selectedCategory = document.getElementById('emoji-category-select')?.value || 'default';

                // ç¡®ä¿è·å–å½“å‰è§’è‰²ID
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(AppStorage.get('wechat_chars', {}))[0];
                const chars = AppStorage.get('wechat_chars', {});
                const c = chars[cid];

                if (!c && emojiType !== 'global') {
                    Utils.showToast('æ— æ³•è·å–å½“å‰è§’è‰²ä¿¡æ¯');
                    return;
                }

                const uniqueEmojis = [];
                lines.forEach(line => {
                    line = line.trim();
                    // å¤„ç†å¸¦åå¼•å·çš„URL

                    // æ”¯æŒä» "Name: https://..." æˆ– "Nameï¼šhttps://..." æ ¼å¼ä¸­æå–åç§°
                    let name = 'è‡ªå®šä¹‰è¡¨æƒ…';
                    let url = '';

                    // 1. å°è¯•æ‹†åˆ†åç§°å’ŒURL
                    // åŒ¹é… pattern:  Name[:ï¼š] URL
                    const splitMatch = line.match(/^(.+?)[:ï¼š]\s*(https?:\/\/.*|data:image\/.*)$/i);

                    if (splitMatch) {
                        name = splitMatch[1].trim();
                        url = splitMatch[2].trim();
                    } else {
                        // 2. ä¹Ÿæ˜¯å¯èƒ½æ˜¯çº¯URLï¼Œå»æ‰åå¼•å·
                        const backtickMatch = line.match(/^`([^`]+)`$/);
                        url = backtickMatch ? backtickMatch[1] : line;
                    }

                    if (url) {
                        // ä¸¥æ ¼æ ¡éªŒ URL æ ¼å¼
                        if (!/^https?:\/\//i.test(url) && !/^data:image\//i.test(url)) {
                            console.warn('Skipping invalid URL:', url);
                            return;
                        }

                        // ç®€å•å»é‡ï¼šæ£€æŸ¥æ˜¯å¦å·²åœ¨ uniqueEmojis ä¸­
                        if (!uniqueEmojis.find(e => e.url === url)) {
                            uniqueEmojis.push({
                                url: url,
                                name: name, // ä½¿ç”¨æå–çš„åç§°
                                type: emojiType,
                                category: (emojiType === 'global') ? undefined : 'default' // å…¨å±€ä¸åˆ†ç±»ï¼Œä¸“å±é»˜è®¤å½’å…¥default
                            });
                        }
                    }
                });

                if (emojiType === 'global') {
                    let globalEmojis = AppStorage.get('wechat_global_emojis', []);
                    if (!Array.isArray(globalEmojis)) globalEmojis = [];
                    globalEmojis.push(...uniqueEmojis);
                    AppStorage.set('wechat_global_emojis', globalEmojis);
                } else {
                    if (!c.emojis) c.emojis = [];
                    // æ ‡è®°ä¸ºä¸“å±
                    uniqueEmojis.forEach(e => e.type = 'exclusive');
                    c.emojis.push(...uniqueEmojis);
                    AppStorage.set('wechat_chars', chars);
                }

                Utils.showToast(`æˆåŠŸå¯¼å…¥ ${uniqueEmojis.length} ä¸ªè¡¨æƒ…åŒ…`);
                if (lines.length > uniqueEmojis.length) {
                    setTimeout(() => Utils.showToast(`è¿‡æ»¤äº† ${lines.length - uniqueEmojis.length} ä¸ªæ— æ•ˆé“¾æ¥`), 1500);
                }

                document.getElementById('modal-emoji-upload').classList.add('hidden');
                document.getElementById('emoji-url-input').value = '';

                // åˆ·æ–°
                WeChatUI.updateEmojiCategories();
                WeChatUI.filterEmojisByCategory();
            },

            // ã€æ–°å¢ã€‘æ¸…ç†æ— æ•ˆè¡¨æƒ…æ•°æ® (è‡ªæˆ‘ä¿®å¤)
            cleanInvalidEmojis: () => {
                let globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const initialGlobalCount = globalEmojis.length;
                globalEmojis = globalEmojis.filter(e => {
                    const url = e.url || e;
                    return typeof url === 'string' && (/^https?:\/\//i.test(url) || /^data:image\//i.test(url));
                });
                if (globalEmojis.length !== initialGlobalCount) {
                    AppStorage.set('wechat_global_emojis', globalEmojis);
                    console.log(`å·²æ¸…ç† ${initialGlobalCount - globalEmojis.length} ä¸ªæ— æ•ˆå…¨å±€è¡¨æƒ…`);
                }

                const chars = AppStorage.get('wechat_chars', {});
                let charsUpdated = false;
                Object.keys(chars).forEach(cid => {
                    const c = chars[cid];
                    if (c && c.emojis && Array.isArray(c.emojis)) {
                        const initialCount = c.emojis.length;
                        c.emojis = c.emojis.filter(e => {
                            const url = e.url || e;
                            return typeof url === 'string' && (/^https?:\/\//i.test(url) || /^data:image\//i.test(url));
                        });
                        if (c.emojis.length !== initialCount) {
                            charsUpdated = true;
                            console.log(`è§’è‰² ${c.name || cid} å·²æ¸…ç† ${initialCount - c.emojis.length} ä¸ªæ— æ•ˆè¡¨æƒ…`);
                        }
                    }
                });
                if (charsUpdated) {
                    AppStorage.set('wechat_chars', chars);
                }
            },

            // æ¸²æŸ“è®¾ç½®é¡µé¢çš„è¡¨æƒ…ç½‘æ ¼
            renderEmojiGrid: (list) => {
                const gridEl = document.getElementById('emoji-grid');
                if (!gridEl) return;

                if (!list || list.length === 0) {
                    gridEl.innerHTML = '<div class="text-gray-400 text-sm text-center py-8 col-span-4">æš‚æ— è¡¨æƒ…åŒ…</div>';
                    return;
                }

                gridEl.innerHTML = list.map((emoji, index) => {
                    const url = emoji.url || emoji;
                    const name = emoji.name || 'è¡¨æƒ…';
                    const isGlobal = (emoji.type === 'global');
                    return `
                        <div class="emoji-item">
                            <img src="${url}" alt="${name}">
                            <div class="text-[10px] text-center text-gray-400 truncate px-1 py-0.5 bg-black/50">${name}</div>
                            <div class="absolute top-1 left-1 bg-blue-500/80 text-white text-[6px] px-1.5 py-0.5 rounded-full">
                                ${isGlobal ? 'å…¨å±€' : 'ä¸“å±'}
                            </div>
                            <button onclick="WeChatUI.deleteEmoji('${url}')" class="absolute top-1 right-1 w-5 h-5 bg-red-500/80 text-white rounded-full flex items-center justify-center text-[8px] hover:bg-red-600">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            },

            // åˆ é™¤è¡¨æƒ…åŒ… (æŒ‰URLåŒ¹é…)
            deleteEmoji: (url) => {
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const chars = AppStorage.get('wechat_chars', {});
                // å°è¯•è·å– cidï¼Œå¦‚æœåœ¨è®¾ç½®é¡µå¯èƒ½éœ€è¦ä» DOM è·å–
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];
                const charEmojis = c ? (c.emojis || []) : [];

                let deleted = false;

                // 1. å°è¯•ä»å…¨å±€åˆ é™¤
                const gIndex = globalEmojis.findIndex(e => (e.url || e) === url);
                if (gIndex !== -1) {
                    globalEmojis.splice(gIndex, 1);
                    AppStorage.set('wechat_global_emojis', globalEmojis);
                    deleted = true;
                }

                // 2. å°è¯•ä»ä¸“å±åˆ é™¤ (å¦‚æœæ²¡åœ¨å…¨å±€åˆ æ‰ï¼Œæˆ–è€…éƒ½åˆ ï¼Ÿé˜²æ­¢é‡å¤)
                if (!deleted) {
                    const cIndex = charEmojis.findIndex(e => (e.url || e) === url);
                    if (cIndex !== -1) {
                        charEmojis.splice(cIndex, 1);
                        if (c) c.emojis = charEmojis;
                        AppStorage.set('wechat_chars', chars);
                        deleted = true;
                    }
                }

                if (deleted) {
                    Utils.showToast('åˆ é™¤æˆåŠŸ');
                    WeChatUI.filterEmojisByCategory(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    Utils.showToast('æœªæ‰¾åˆ°è¯¥è¡¨æƒ…åŒ…ï¼Œå¯èƒ½å·²åˆ é™¤');
                    WeChatUI.filterEmojisByCategory(); // å¼ºåˆ¶åˆ·æ–°
                }
            },

            // è·å–æ‰€æœ‰è¡¨æƒ…åŒ…
            getAllEmojis: () => {
                const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                const chars = AppStorage.get('wechat_chars', {});
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];
                const charEmojis = c ? (c.emojis || []) : [];
                return [...globalEmojis, ...charEmojis];
            },

            // åˆ‡æ¢åˆ†ç±»ç®¡ç†æ˜¾ç¤º
            toggleEmojiCategories: () => {
                const managementDiv = document.getElementById('emoji-category-management');
                if (managementDiv) {
                    if (managementDiv.classList.contains('hidden')) {
                        managementDiv.classList.remove('hidden');
                        WeChatUI.renderEmojiCategories();
                    } else {
                        managementDiv.classList.add('hidden');
                    }
                }
            },

            // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
            renderEmojiCategories: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];
                if (!c) return;

                const categories = c.emojiCategories || ['default'];
                const list = document.getElementById('emoji-categories-list');
                if (!list) return;

                list.innerHTML = categories.map((category, index) => {
                    if (category === 'default') {
                        return `
                        <div class="flex items-center justify-between p-2 bg-gray-800/5 rounded-lg border border-gray-100">
                            <span class="text-sm font-medium text-gray-700">é»˜è®¤åˆ†ç±»</span>
                            <span class="text-xs text-gray-400">ç³»ç»Ÿé»˜è®¤</span>
                        </div>`;
                    }
                    return `
                        <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-gray-200">
                        <span class="text-sm text-gray-700">${category}</span>
                        <button onclick="WeChatUI.deleteEmojiCategory(${index})" class="text-xs text-red-500 hover:bg-red-50 p-1 rounded transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div > `;
                }).join('');
            },

            // æ·»åŠ åˆ†ç±»
            addEmojiCategory: () => {
                const input = document.getElementById('new-category-name');
                const name = input.value.trim();
                if (!name) return;

                const chars = AppStorage.get('wechat_chars', {});
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];
                if (!c) return;

                if (!c.emojiCategories) c.emojiCategories = ['default'];
                if (c.emojiCategories.includes(name)) {
                    Utils.showToast('åˆ†ç±»å·²å­˜åœ¨');
                    return;
                }

                c.emojiCategories.push(name);
                AppStorage.set('wechat_chars', chars);

                input.value = '';
                WeChatUI.renderEmojiCategories();
                WeChatUI.updateEmojiCategories();
            },

            // åˆ é™¤åˆ†ç±»
            deleteEmojiCategory: (index) => {
                if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»ï¼Ÿè¯¥åˆ†ç±»ä¸‹çš„è¡¨æƒ…åŒ…å°†å½’å…¥é»˜è®¤åˆ†ç±»ã€‚')) return;

                const chars = AppStorage.get('wechat_chars', {});
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];

                // å†æ¬¡æ£€æŸ¥ (ç´¢å¼•æ˜¯å¦è¶Šç•Œ)
                if (!c || !c.emojiCategories || !c.emojiCategories[index]) return;

                const categoryName = c.emojiCategories[index];

                // ä»æ•°ç»„ç§»é™¤
                c.emojiCategories.splice(index, 1);

                // å°†è¯¥åˆ†ç±»ä¸‹çš„è¡¨æƒ…åŒ…é‡ç½®ä¸º default
                if (c.emojis) {
                    c.emojis.forEach(e => {
                        if (e.category === categoryName) {
                            e.category = 'default';
                        }
                    });
                }

                AppStorage.set('wechat_chars', chars);

                WeChatUI.renderEmojiCategories();
                WeChatUI.updateEmojiCategories();
                WeChatUI.filterEmojisByCategory(); // åˆ·æ–°åˆ—è¡¨
            },

            // æ›´æ–°åˆ†ç±»ä¸‹æ‹‰èœå•
            updateEmojiCategories: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const cid = WeChatUI.currentChatId || document.getElementById('subpage-chat-detail')?.dataset.charId || Object.keys(chars)[0];
                const c = chars[cid];
                if (!c) return;

                // åˆ†ç±»ä¸‹æ‹‰èœå•å·²åˆ é™¤ï¼Œæ­¤å‡½æ•°ä¿ç•™ä¸ºç©º
            },
            ctxCopy: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // å¦‚æœä¸åœ¨èŠå¤©è¯¦æƒ…é¡µé¢ï¼Œç›´æ¥è¿”å›

                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs) return; // å¦‚æœè§’è‰²æˆ–æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›

                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);
                if (msg && msg.type === 'text') {
                    navigator.clipboard.writeText(msg.content);
                    Utils.showToast('å·²å¤åˆ¶');
                }
                WeChatUI.hideContextMenu();
            }, ctxListen: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // å¦‚æœä¸åœ¨èŠå¤©è¯¦æƒ…é¡µé¢ï¼Œç›´æ¥è¿”å›

                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs) return; // å¦‚æœè§’è‰²æˆ–æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›

                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);
                if (msg && (msg.type === 'text' || msg.type === 'voice')) {
                    // è·å–æ¶ˆæ¯å†…å®¹ï¼Œè¯­éŸ³æ¶ˆæ¯ä½¿ç”¨textå­—æ®µ
                    let content = msg.type === 'voice' ? msg.text : msg.content;

                    // 1. å¦‚æœæ˜¯è¿™ç§æœªè§£æçš„ [è¯­éŸ³:xx] æ–‡æœ¬ï¼Œå…ˆå»æ‰å‰ç¼€åç¼€ï¼Œåªè¯»å†…å®¹
                    if (content.startsWith('[è¯­éŸ³:') && content.endsWith(']')) {
                        content = content.replace(/^\[è¯­éŸ³:\s*/, '').replace(/\]$/, '');
                    }

                    // 2. åªç§»é™¤ç‰¹å®šçš„å¹²æ‰°é¡¹ï¼Œè€Œä¸æ˜¯æš´åŠ›ç§»é™¤æ‰€æœ‰ [] å†…å®¹
                    // å»é™¤åŠ¨ä½œæå†™ () 
                    content = content.replace(/\([^)]*\)|ï¼ˆ[^ï¼‰]*ï¼‰/g, '');
                    // å»é™¤ç³»ç»Ÿæ ‡ç­¾ [å›¾ç‰‡] [è¡¨æƒ…åŒ…] ç­‰ï¼Œä¿ç•™å…¶ä»– [] å†…å®¹ä»¥å…è¯¯åˆ 
                    content = content.replace(/\[(å›¾ç‰‡|image|è¡¨æƒ…åŒ…|çº¢åŒ…|è½¬è´¦).*?\]/g, '');

                    // è°ƒç”¨TTSæœ—è¯»
                    if (content.trim()) {
                        SettingsLogic.generateTTS(content, chars[cid]).then(res => {
                            // é€»è¾‘ä¿®å¤ï¼šç›´æ¥æ ¹æ®è¿”å›å€¼åˆ¤æ–­ï¼Œä¸å†ä¾èµ– globalTTS é…ç½®æŸ¥è¯¢
                            if (res === 'browser-tts-done') {
                                Utils.showToast('æœ—è¯»å®Œæˆ');
                            } else if (res) {
                                // äº‘ç«¯TTSè¿”å›äº†éŸ³é¢‘URLï¼Œæ’­æ”¾éŸ³é¢‘
                                const audio = new Audio(res);
                                audio.playbackRate = parseFloat(chars[cid].voiceSpeed || 1.0); // åº”ç”¨è§’è‰²è®¾ç½®çš„è¯­é€Ÿ
                                audio.play();
                                Utils.showToast('å¼€å§‹æœ—è¯»');
                            } else {
                                // è¿”å› null/undefined è¡¨ç¤ºå¤±è´¥
                                Utils.showToast('æœ—è¯»å¤±è´¥');
                            }
                        }).catch(err => {
                            console.error('TTSæœ—è¯»å¤±è´¥', err);
                            Utils.showToast('æœ—è¯»å¤±è´¥');
                        });
                    } else {
                        Utils.showToast('æ²¡æœ‰å¯æœ—è¯»çš„å†…å®¹');
                    }
                }
                WeChatUI.hideContextMenu();
            },
            ctxQuote: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // å¦‚æœä¸åœ¨èŠå¤©è¯¦æƒ…é¡µé¢ï¼Œç›´æ¥è¿”å›

                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs) return; // å¦‚æœè§’è‰²æˆ–æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›

                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);
                if (msg) {
                    // è·å–æ¶ˆæ¯å†…å®¹ï¼Œæ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œæ ¼å¼åŒ–
                    let content = msg.content;
                    if (msg.type === 'image') {
                        // æ˜¾ç¤ºå®Œæ•´çš„å›¾ç‰‡URL
                        const imageUrl = msg.originalContent || msg.content;
                        content = `[å›¾ç‰‡: ${imageUrl}]`;
                    } else if (msg.type === 'voice') content = '[è¯­éŸ³]';
                    else if (msg.type === 'redpacket') content = '[çº¢åŒ…]';
                    else if (msg.type === 'transfer') content = `[è½¬è´¦: ${msg.amount}å…ƒ]`;

                    // æ ¼å¼åŒ–å¼•ç”¨å†…å®¹ï¼ŒåŒ…å«å‘é€è€…åç§°å’Œæ¶ˆæ¯å†…å®¹
                    const quoteContent = `${msg.role === 'user' ? 'æˆ‘' : chars[cid].name}: ${content} `;

                    // æ˜¾ç¤ºå¼•ç”¨å†…å®¹åœ¨ä¸“é—¨çš„åŒºåŸŸ
                    const quoteDisplay = document.getElementById('quote-display');
                    const quoteContentEl = document.getElementById('quote-content');
                    quoteContentEl.textContent = quoteContent;
                    quoteDisplay.classList.remove('hidden');

                    // å­˜å‚¨å¼•ç”¨å†…å®¹åˆ°å…¨å±€å˜é‡
                    WeChatUI.currentQuote = quoteContent;
                }
                WeChatUI.hideContextMenu();
            },
            clearQuote: () => {
                // æ¸…ç©ºå¼•ç”¨æ˜¾ç¤º
                const quoteDisplay = document.getElementById('quote-display');
                quoteDisplay.classList.add('hidden');
                WeChatUI.currentQuote = '';
            },
            ctxDelete: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // å¦‚æœä¸åœ¨èŠå¤©è¯¦æƒ…é¡µé¢ï¼Œç›´æ¥è¿”å›

                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});

                if (chars[cid] && chars[cid].msgs) {
                    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ ¹æ® ID è¿‡æ»¤ï¼Œç»å¯¹ç²¾å‡†ï¼Œä¸ä¼šåˆ é”™
                    chars[cid].msgs = chars[cid].msgs.filter(m => m.id !== WeChatUI.ctxTargetMsgId);
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.loadChat(cid);
                    WeChatUI.renderList();
                }
                WeChatUI.hideContextMenu();
            },
            ctxRevoke: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // å¦‚æœä¸åœ¨èŠå¤©è¯¦æƒ…é¡µé¢ï¼Œç›´æ¥è¿”å›

                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                if (!chars[cid] || !chars[cid].msgs) return; // å¦‚æœè§’è‰²æˆ–æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›

                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);
                if (msg && msg.content) {
                    // åŸåœ°ä¿®æ”¹è¿™æ¡æ¶ˆæ¯
                    msg.type = 'system';
                    msg.isRecall = true;
                    msg.originalContent = msg.content;
                    msg.content = 'æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯';
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.loadChat(cid);
                }
                WeChatUI.hideContextMenu();
            },
            showRecalled: (content) => {
                document.getElementById('recall-content-text').textContent = content;
                document.getElementById('modal-recall-view').classList.remove('hidden');
            },
            ctxFav: () => {
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return;
                const cid = chatDetailEl.dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const msg = chars[cid]?.msgs?.find(m => m.id === WeChatUI.ctxTargetMsgId);
                const char = chars[cid];

                if (!msg) return;

                let favs = AppStorage.get('wechat_favorites', []);
                if (favs.some(f => f.id === msg.id)) {
                    Utils.showToast('å·²ç»åœ¨æ”¶è—å¤¹é‡Œäº†');
                    WeChatUI.hideContextMenu();
                    return;
                }

                favs.unshift({
                    ...msg,
                    favId: Date.now(),
                    charName: char?.nickname || char?.name || 'æœªçŸ¥',
                    charAvatar: char?.avatar,
                    favTime: Date.now()
                });

                AppStorage.set('wechat_favorites', favs);
                Utils.showToast('å·²æ”¶è—');
                WeChatUI.hideContextMenu();
            },
            // æ‰“å¼€ç¼–è¾‘å™¨
            ctxEdit: () => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);

                // æ¸…ç©ºåˆ—è¡¨
                const list = document.getElementById('edit-msg-list');
                if (list) {
                    list.innerHTML = '';
                    // æ·»åŠ å½“å‰æ¶ˆæ¯ä½œä¸ºç¬¬ä¸€ä¸ªç¼–è¾‘å—
                    WeChatUI.addEditBlock(msg);
                    // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºç¼–è¾‘å¼¹çª—
                    document.getElementById('modal-edit-msg').classList.remove('hidden');
                }
                WeChatUI.hideContextMenu();
            },
            // --- AIå›å¤å¤„ç†å‡½æ•° ---
            // ã€âš ï¸é«˜å±æ ¸å¿ƒåŒºåŸŸã€‘AIå›å¤å¤„ç†å™¨ - æå…¶è„†å¼±ï¼Œè¯·å‹¿éšæ„é‡æ„ï¼
            // æ­¤å‡½æ•°åŒ…å«ä»¥ä¸‹å…³é”®é€»è¾‘ï¼Œé¡ºåºä¸å¯ä¹±ï¼š
            // 1. æŒ‡ä»¤è§£æ (CMD:...) - å¿…é¡»åœ¨æ¸…ç†æ–‡æœ¬ä¹‹å‰ã€‚
            // 2. å¿ƒå£°æå– (INNER_VOICE) - åŒ…æ‹¬é˜²æ­¢ JSON æ³„æ¼çš„æ¸…ç†é€»è¾‘ã€‚
            // 3. æ™ºèƒ½åˆ†å¥ - åŒ…å«å¯¹ [å›¾ç‰‡][è¯­éŸ³] æ ‡ç­¾çš„é˜²åˆ‡åˆ†å’Œå¼ºåˆ¶æå–é€»è¾‘ã€‚
            // 4. å‘é€é˜Ÿåˆ— - åŒ…å«é—´éš”å»¶æ—¶ã€‚
            // ä¿®æ”¹è¿™é‡Œçš„ä»»ä½•æ­£åˆ™æˆ–é¡ºåºéƒ½å¯èƒ½å¯¼è‡´ï¼šæ¶ˆæ¯å‘ä¸å‡ºæ¥ã€å¿ƒå£°æ³„æ¼ã€è¯­éŸ³æ— æ³•è¯†åˆ«ã€‚ä¸è¦ä¹±æ”¹ï¼
            handleAIReply: (reply, charId) => {
                if (!reply) {
                    WeChatUI.pushMessage('error', 'AI è¿”å›äº†ç©ºå†…å®¹', 'system');
                    return;
                }
                let cleanReply = reply;

                // 1. æŒ‡ä»¤è§£æå™¨ (Command Parser) - æœ‹å‹åœˆæŒ‡ä»¤
                // åŒ¹é… [CMD:æ“ä½œ:ID:å‚æ•°]
                const cmdRegex = /\[CMD:(.*?):(.*?)(?::(.*?))?\]/g;
                let match;
                while ((match = cmdRegex.exec(cleanReply)) !== null) {
                    const act = match[1]; // LIKE / COMMENT / MOMENT_POST / SET_BIO
                    const p1 = match[2];
                    const p2 = match[3];

                    setTimeout(() => {
                        const cid = document.getElementById('subpage-chat-detail')?.dataset.charId;

                        // ç‚¹èµæŒ‡ä»¤
                        if (act === 'LIKE') {
                            const moments = AppStorage.get('wechat_moments', []);
                            const moment = moments.find(m => m.id === p1);
                            if (moment && cid) {
                                if (!moment.likes) moment.likes = [];
                                if (!moment.likes.includes(cid)) {
                                    moment.likes.push(cid);
                                    AppStorage.set('wechat_moments', moments);
                                    WeChatUI.renderMomentsList();

                                    const chars = AppStorage.get('wechat_chars', {});
                                    const charName = chars[cid]?.name || 'AI';
                                    Utils.showToast(`${charName} ç‚¹èµäº†æœ‹å‹åœˆ`);
                                }
                            }
                        }

                        // è¯„è®ºæŒ‡ä»¤
                        if (act === 'COMMENT' && p2) {
                            const moments = AppStorage.get('wechat_moments', []);
                            const moment = moments.find(m => m.id === p1);
                            if (moment && cid) {
                                const chars = AppStorage.get('wechat_chars', {});
                                const char = chars[cid];

                                if (!moment.comments) moment.comments = [];
                                moment.comments.push({
                                    id: `comment_${Date.now()} _cmd`,
                                    authorId: cid,
                                    authorName: char?.name || 'AI',
                                    content: p2,
                                    timestamp: Date.now()
                                });

                                AppStorage.set('wechat_moments', moments);
                                WeChatUI.renderMomentsList();
                                Utils.showToast(`${char?.name || 'AI'} è¯„è®ºäº†æœ‹å‹åœˆ`);
                            }
                        }

                        // å‘å¸–æŒ‡ä»¤
                        if (act === 'MOMENT_POST' && p1 && cid) {
                            const chars = AppStorage.get('wechat_chars', {});
                            const char = chars[cid];

                            if (char) {
                                const moment = {
                                    id: `moment_${Date.now()} _cmd`,
                                    authorId: cid,
                                    authorName: char.name,
                                    authorAvatar: char.avatar,
                                    isUser: false,
                                    content: p1,
                                    images: [],
                                    location: '',
                                    timestamp: Date.now(),
                                    likes: [],
                                    comments: []
                                };

                                const moments = AppStorage.get('wechat_moments', []);
                                moments.unshift(moment);
                                AppStorage.set('wechat_moments', moments);
                                WeChatUI.renderMomentsList();
                                Utils.showToast(`${char.name} å‘å¸ƒäº†æœ‹å‹åœˆ`);
                            }
                        }

                        // ä¿®æ”¹ç­¾åæŒ‡ä»¤
                        if (act === 'SET_BIO' && p1 && cid) {
                            const chars = AppStorage.get('wechat_chars', {});
                            if (chars[cid]) {
                                chars[cid].bio = p1;
                                AppStorage.set('wechat_chars', chars);
                                const bioEl = document.querySelector(`#subpage - chat - detail.chat - bio`);
                                if (bioEl) bioEl.textContent = p1;
                                Utils.showToast('å¯¹æ–¹æ›´æ–°äº†ç­¾å');
                            }
                        }
                    }, 2000);
                }


                // 2. æ“¦é™¤æŒ‡ä»¤ï¼Œä¸æ˜¾ç¤ºåœ¨æ°”æ³¡é‡Œ
                cleanReply = cleanReply.replace(cmdRegex, '').trim();

                // 3. å¿ƒå£°æå–ä¸æ¸…æ´— (åŠ å¼ºç‰ˆ)
                // ===========================

                // A. æå–æ ‡å‡†å¿ƒå£°æ ‡ç­¾
                let capturedInnerVoice = null;
                const innerVoiceMatch = cleanReply.match(/\[INNER_VOICE\]([\s\S]*?)\[\/INNER_VOICE\]/i);
                if (innerVoiceMatch) {
                    try {
                        let voiceJsonStr = innerVoiceMatch[1].replace(/```json/g, '').replace(/```/g, '').trim();
                        const jsonMatch = voiceJsonStr.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const voiceJson = JSON.parse(jsonMatch[0]);
                            // å…¼å®¹æ—§æ ¼å¼å’Œæ–°æ ¼å¼
                            const voiceText = {
                                ç€è£…: voiceJson.ç€è£… || voiceJson.outfit || '-',
                                ç¯å¢ƒ: voiceJson.ç¯å¢ƒ || voiceJson.scene || '-',
                                å¿ƒå£°: voiceJson.å¿ƒå£° || voiceJson.thoughts || '-',
                                è¡Œä¸º: voiceJson.è¡Œä¸º || voiceJson.action || '-'
                            };
                            capturedInnerVoice = voiceText; // æš‚å­˜å¿ƒå£°å¯¹è±¡
                            InnerVoiceUI.addVoice(voiceText); // å­˜å…¥å¿ƒå£°ç³»ç»Ÿ

                            // ã€ä¿®å¤ã€‘ä¸å†åˆ›å»ºéšè—æ¶ˆæ¯ï¼Œé¿å…é‡å¤ã€‚å¿ƒå£°ä¼šé€šè¿‡ extraData é™„åŠ åˆ°ç¬¬ä¸€æ¡å¯è§æ¶ˆæ¯ä¸Šã€‚
                            // åªæœ‰å½“ AI å›å¤å®Œå…¨ä¸ºç©ºï¼ˆæ²¡æœ‰å¯è§æ–‡æœ¬ï¼‰æ—¶ï¼Œæˆ‘ä»¬æ‰è€ƒè™‘å•ç‹¬ä¿å­˜ï¼ˆå¾…å®šï¼‰ã€‚
                            // ç›®å‰å…ˆæŠŠä¸Šé¢çš„ hidden message é€»è¾‘åˆ æ‰ï¼Œé˜²æ­¢ inconsistent.
                            // try {
                            //    WeChatUI.pushMessage('text', '', 'ai', 'text', null, charId, { innerVoice: capturedInnerVoice, hidden: true });
                            // } catch (e) { console.error('æŒä¹…åŒ–å¿ƒå£°å¤±è´¥', e); }
                        }
                    } catch (e) { console.error("å¿ƒå£°è§£æå¾®å°é”™è¯¯", e); }

                    // B. å½»åº•åˆ é™¤å¿ƒå£°æ ‡ç­¾å—
                    cleanReply = cleanReply.replace(/\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]/gi, '').trim();
                }

                // D. æ–°å¢ï¼šå¤„ç†é”™è¯¯æ ¼å¼çš„å¿ƒå£° (ç›´æ¥åŒ…è£¹åœ¨æ‹¬å·é‡Œçš„æƒ…å†µ)
                const wrongFormatVoiceMatch = cleanReply.match(/\((.*?)"ç€è£…":[\s\S]*?"è¡Œä¸º":[\s\S]*?\)\)/);
                if (wrongFormatVoiceMatch) {
                    // ç›´æ¥åˆ é™¤è¿™ç§é”™è¯¯æ ¼å¼çš„å¿ƒå£°
                    cleanReply = cleanReply.replace(/\((.*?)"ç€è£…":[\s\S]*?"è¡Œä¸º":[\s\S]*?\)\)/g, '').trim();
                }

                // C. [å…³é”®ä¿®å¤] é˜²æ³„æ¼ä¿é™©ï¼šå¦‚æœè¿˜æœ‰æ®‹ç•™çš„ JSON æ–‡æœ¬ (é’ˆå¯¹æˆªå›¾ä¸­çš„ Bug)
                if (cleanReply.includes('{ "ç€è£…":') || cleanReply.includes('{ "outfit":') || cleanReply.includes('"ç€è£…":') || cleanReply.includes('"outfit":')) {
                    cleanReply = cleanReply.replace(/\{[\s\S]*?"(ç€è£…|outfit)"[\s\S]*?\}/gi, '').trim();
                }

                // E. æ–°å¢ï¼šå¤„ç†æ®‹ç•™çš„å¿ƒå£°æ ‡è®°
                cleanReply = cleanReply.replace(/\[INNER_VOICE\]/gi, '').replace(/\[\/INNER_VOICE\]/gi, '').trim();

                // F. æ–°å¢ï¼šå¤„ç†æœªé—­åˆçš„å¿ƒå£°æ ‡ç­¾ [INNER_VOICE]å†…å®¹ï¼ˆæ²¡æœ‰ç»“æŸæ ‡ç­¾ï¼‰
                // åŒ¹é… [INNER_VOICE] åé¢ç›´åˆ°ä¸‹ä¸€ä¸ª [ æˆ–ç»“å°¾çš„å†…å®¹
                cleanReply = cleanReply.replace(/\[INNER_VOICE\][^\[]*(?=\[|$)/gi, '').trim();
                // åŒ¹é… [INNER_VOICE: å†…å®¹] æ ¼å¼
                cleanReply = cleanReply.replace(/\[INNER_VOICE[:ï¼š][^\]]*\]/gi, '').trim();

                // æ¸…æ´—æ®‹ç•™çš„ ### åˆ†éš”ç¬¦ï¼Œä»…æ¸…æ´—æœ«å°¾å’Œè¡Œå°¾çš„
                cleanReply = cleanReply.replace(/\s*###\s*$/g, '');
                cleanReply = cleanReply.replace(/\s{2,}/g, ' ').trim();

                // ===========================
                // 2. é¢„å¤„ç† (æ¸…ç†ç³»ç»Ÿæ ‡è®°)
                // ===========================
                cleanReply = cleanReply.replace(/```[\s\S]*?```/g, ''); // å»æ‰ä»£ç å—
                cleanReply = cleanReply.replace(/\[System Directive[\s\S]*?\]/gi, '');
                cleanReply = cleanReply.replace(/\[Roleplay Protocol\]/gi, '');

                // ã€ä¿®å¤ã€‘æ¸…ç†ä¸å®Œæ•´çš„[å›¾ç‰‡ï¼šæ ‡ç­¾æ®‹ç•™
                //  cleanReply = cleanReply.replace(/\[(?:å›¾ç‰‡|image|è¡¨æƒ…åŒ…)[:ï¼š]\s*$/gi, '').trim();
                //  cleanReply = cleanReply.replace(/\[(?:å›¾ç‰‡|image|è¡¨æƒ…åŒ…)[:ï¼š](?!\s*https?:\/\/)[^\]]*$/gi, '').trim();

                // å¦‚æœå‰©ä¸‹çš„æ˜¯ç©ºçš„ï¼ˆè¯´æ˜å…¨æ˜¯å¿ƒå£°ï¼‰ï¼Œå°±åœæ­¢
                if (!cleanReply) {
                    // å¦‚æœæ¸…æ´—å®Œå…¨éƒ¨ä¸ºç©ºï¼Œä½†ç¡®å®æ•è·åˆ°äº†å¿ƒå£°ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜è¿™ä¸ªå¿ƒå£°ï¼
                    if (capturedInnerVoice) {
                        // åˆ›å»ºä¸€ä¸ªåªæœ‰å¿ƒå£°çš„éšè—æ¶ˆæ¯
                        WeChatUI.pushMessage('text', '', 'ai', 'text', null, document.getElementById('subpage-chat-detail').dataset.charId, { innerVoice: capturedInnerVoice, hidden: true });
                    }

                    // æ¢å¤çŠ¶æ€æ 
                    const statusEl = document.getElementById('chat-online-status');
                    if (statusEl) {
                        statusEl.textContent = 'åœ¨çº¿';
                        statusEl.style.color = '#10b981';
                        statusEl.classList.remove('animate-pulse');
                    }
                    return;
                }

                // ã€æ–°å¢æ—¥å¿—ã€‘è®°å½•æ¸…æ´—åçš„æœ€ç»ˆå†…å®¹ï¼Œæ–¹ä¾¿è°ƒè¯•
                if (window.SystemLog) {
                    SystemLog.write('DEBUG', 'æ¸…æ´—åçš„ AI å›å¤', {
                        original: reply.length > 200 ? reply.substring(0, 200) + '...' : reply,
                        cleaned: cleanReply.length > 200 ? cleanReply.substring(0, 200) + '...' : cleanReply
                    });
                }

                // ===========================
                // 3. æ™ºèƒ½åˆ†å¥é˜Ÿåˆ— (ä¿®å¤ç‰ˆ)
                // ===========================
                // é‡ç½®å¿ƒå£°é™„åŠ æ ‡è®°
                window._hasAttachedInnerVoice = false;

                const messageQueue = [];

                // æ­¥éª¤ A: ä¼˜å…ˆæŒ‰ AI æ˜¾å¼åˆ†éš”ç¬¦ ### åˆ‡åˆ†
                // æ”¯æŒ###å‰åæœ‰ç©ºæ ¼
                let segments = cleanReply.split(/\s*###\s*/);

                segments.forEach(seg => {
                    seg = seg.trim();
                    if (!seg) return;

                    // 1. å¦‚æœæ˜¯ç‰¹æ®ŠæŒ‡ä»¤ï¼Œç›´æ¥å…¥é˜Ÿ
                    if (seg.match(/^\[.*?\]$/)) {
                        messageQueue.push(seg);
                        return;
                    }

                    // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘æ£€æµ‹æ˜¯å¦åŒ…å« HTML æ ‡ç­¾
                    // åªè¦åŒ…å« <div, <span, <img, <p ç­‰æ ‡ç­¾ï¼Œå°±è§†ä¸º HTML å—
                    // ç»å¯¹ç¦æ­¢æŒ‰æ¢è¡Œç¬¦æ‹†åˆ†ï¼Œå¦åˆ™ HTML å°±ä¼šä¹±é£ï¼
                    const hasHTML = /<(?:div|span|p|table|img|section|ul|ol|li|details)[^>]*>/i.test(seg);

                    if (hasHTML) {
                        // æ˜¯ HTMLï¼Œæ•´å—ä¿ç•™ï¼Œä¸åˆ‡åˆ†
                        messageQueue.push(seg);
                    } else {
                        // 3. æ™®é€šæ–‡æœ¬ï¼šæ‰æŒ‰æ¢è¡Œç¬¦åˆ‡åˆ†
                        seg.split(/\n+/).forEach(s => {
                            let cleanSeg = s.trim();
                            // ç§»é™¤è‹±æ–‡æ ¼å¼çš„æ”¯ä»˜äº¤äº’æŒ‡ä»¤
                            cleanSeg = cleanSeg.replace(/\[Payment Interaction\]:\s*(Receive|Reject)=\[([^\]]+)\]/i, '').trim();
                            if (cleanSeg) messageQueue.push(cleanSeg);
                        });
                    }
                });

                // ===========================
                // 4. æ’­æ”¾é˜Ÿåˆ— (ä¿æŒåŸæœ‰é€»è¾‘ï¼Œä½†æ•°æ®æºå·²å‡€åŒ–)
                // ===========================
                const processQueue = async () => {
                    if (messageQueue.length === 0) {
                        // æ¢å¤çŠ¶æ€æ 
                        const statusEl = document.getElementById('chat-online-status');
                        if (statusEl) {
                            statusEl.textContent = 'åœ¨çº¿';
                            statusEl.style.color = '#10b981';
                            statusEl.classList.remove('animate-pulse');
                        }
                        // æ¢å¤æŒ‰é’®çŠ¶æ€...
                        const generateBtn = document.getElementById('generate-btn');
                        if (generateBtn) {
                            generateBtn.style.backgroundColor = '';
                            generateBtn.style.borderColor = '';
                            generateBtn.style.transform = '';
                        }
                        return;
                    }

                    let msgContent = messageQueue.shift();


                    // ã€ä¿®å¤ã€‘ä¸å†å°† [è¡¨æƒ…åŒ…:URL] æˆ–å›¾ç‰‡URLè½¬æ¢ä¸ºå†…åµŒ<img>æ ‡ç­¾
                    // è®©åç»­çš„æ¶ˆæ¯ç±»å‹åˆ¤æ–­é€»è¾‘æ¥æ­£ç¡®å¤„ç†ï¼Œä½œä¸ºç‹¬ç«‹çš„imageæ¶ˆæ¯å‘é€

                    // åªå¤„ç†ç©ºçš„å›¾ç‰‡æ ‡ç­¾ï¼Œå¦‚ [å›¾ç‰‡ï¼š] æˆ– [å›¾ç‰‡ï¼š (æ¸…ç†æ— æ•ˆæ ¼å¼)
                    // ã€å…³é”®ä¿®å¤ã€‘ä¸å†è¯¯åˆ  [è¡¨æƒ…åŒ…:åç§°]
                    msgContent = msgContent.replace(/\[(?:å›¾ç‰‡|image)[:ï¼š]\s*(?!https?:\/\/)[^\]]*\]?/gi, '');
                    // å¤„ç†å­¤ç«‹çš„ ] ç¬¦å·
                    msgContent = msgContent.replace(/^\s*\]\s*$/g, '');

                    // è·å–å½“å‰èŠå¤©ID
                    const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                    const chars = AppStorage.get('wechat_chars', {});
                    const c = chars[cid];
                    // è·å–æ‰€æœ‰å¯ç”¨çš„è¡¨æƒ…åŒ…
                    const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                    const charEmojis = c ? (c.emojis || []) : [];
                    const allEmojis = [...globalEmojis, ...charEmojis];

                    // ä¸“é—¨æ¸…ç†é”™è¯¯çš„å›¾ç‰‡HTMLæ ‡ç­¾
                    function cleanImageTags(content) {
                        // ã€ä¿®å¤ã€‘åªåšæœ€åŸºç¡€çš„æ¸…ç†ï¼Œç»å¯¹ä¸æŠŠ img æ ‡ç­¾å˜æˆ EMOJI_URL
                        // è¿™æ ·å³ä½¿ HTML è¯¯å…¥äº†æ–‡æœ¬æµç¨‹ï¼Œå›¾ç‰‡ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯å˜æˆä¹±ç 
                        let cleaned = content
                            .replace(/\\"/g, '"')
                            .replace(/\\'/g, "'");

                        return cleaned;
                    }


                    // é€šç”¨å‡½æ•°ï¼šå¤„ç†å•ä¸ªæ¶ˆæ¯å†…å®¹ï¼ŒåŒ…æ‹¬çº¢åŒ…å’Œè½¬è´¦æ ¼å¼
                    function processMessageContent(content) {
                        // ä¿®å¤ï¼šå¤„ç†ä¸å®Œæ•´çš„å›¾ç‰‡æ ‡ç­¾ï¼Œå¦‚ [å›¾ç‰‡:https://example.com/image.jpg æˆ– [å›¾ç‰‡ï¼š] æˆ– [å›¾ç‰‡ï¼šï¼ˆç¼ºå°‘å³æ‹¬å·ï¼‰
                        // 1. å…ˆå¤„ç†å¸¦æœ‰URLçš„å®Œæ•´å’Œä¸å®Œæ•´å›¾ç‰‡æ ‡ç­¾
                        content = content.replace(/\[(?:å›¾ç‰‡|image|è¡¨æƒ…åŒ…)[:ï¼š]\s*(https?:\/\/[^\s\]]*)/gi, (match, url) => {
                            // è¡¥å…¨ä¸ºå®Œæ•´çš„URL
                            return url;
                        });
                        // 2. å¤„ç†ç©ºçš„å›¾ç‰‡æ ‡ç­¾ï¼Œå¦‚ [å›¾ç‰‡ï¼š] æˆ– [å›¾ç‰‡ï¼š æˆ– [å›¾ç‰‡ï¼šï¼ˆç¼ºå°‘å³æ‹¬å·ï¼‰
                        // ã€å…³é”®ä¿®å¤ã€‘ä¸å†è¯¯åˆ  [è¡¨æƒ…åŒ…:åç§°]
                        content = content.replace(/\[(?:å›¾ç‰‡|image)[:ï¼š]\s*(?!\/\/)[^\]]*\]?/gi, '');
                        // 3. å¤„ç†å­¤ç«‹çš„ ] ç¬¦å·
                        // ã€ä¿®å¤ã€‘å¼ºåŠ›æ¸…é™¤å¹½çµ "]" å’Œ "###" (å››é‡ä¿é™©)
                        // 1. å¦‚æœæ¶ˆæ¯åªå‰©ä¸€ä¸ª "]" æˆ– "###"ï¼Œç›´æ¥æ‹¦æˆªä¸å‘
                        if ([']', '###', ']]'].includes(content.trim())) return true;

                        // 2. æ¸…ç†ç©ºç™½åŒ…è£¹çš„ "]" æˆ– "###"
                        content = content.replace(/^\s*[\]#]+\s*$/g, '');

                        // 3. å¼ºåˆ¶ç æ‰æ¶ˆæ¯æœ«å°¾çš„ "]" æˆ– "###"
                        content = content.replace(/[\]#\s]+$/g, '');

                        // æ¸…ç†é”™è¯¯çš„å›¾ç‰‡HTMLæ ‡ç­¾ï¼Œä½†ä¿ç•™æ­£å¸¸çš„HTMLå°å¡ç‰‡
                        content = cleanImageTags(content);
                        // ã€ä¿®å¤ã€‘å¼ºåŠ›æ‹¦æˆª AI çš„æ‹ä¸€æ‹æŒ‡ä»¤ (å…¼å®¹å„ç§å†’å·å’Œç©ºæ ¼)
                        if (/\[\s*System\s*[:ï¼š]\s*æ‹ä¸€æ‹\s*\]/i.test(content)) {
                            const userProfile = AppStorage.get('wechat_user_profile', {});
                            const myName = userProfile.name || 'æˆ‘';
                            // ç¡®ä¿èƒ½è·å–åˆ°å½“å‰è§’è‰²ä¿¡æ¯ c
                            const c = AppStorage.get('wechat_chars', {})[document.getElementById('subpage-chat-detail').dataset.charId];

                            const patAction = (c && c.patAction) || 'æ‹äº†æ‹';
                            const patSuffix = (c && c.patSuffix) || 'çš„å¤´';

                            // ç”Ÿæˆæ–‡æ¡ˆï¼š "å‚»ç‹—" æ‹äº†æ‹ "æˆ‘" çš„å¤´
                            const charName = c ? (c.nickname || c.name) : 'å¯¹æ–¹';
                            const sysText = `"${charName}" ${patAction} "${myName}" ${patSuffix}`;

                            // å‘é€ç³»ç»Ÿæ¶ˆæ¯
                            WeChatUI.pushMessage('system', sysText, 'system');

                            // æ‰‹æœºéœ‡åŠ¨åé¦ˆ
                            if (navigator.vibrate) navigator.vibrate(50);

                            return true; // æ‹¦æˆªæˆåŠŸï¼Œä¸å†æ˜¾ç¤ºæ–‡æœ¬æ°”æ³¡
                        }

                        // --- [PLAY: ...] éŸ³ä¹æŒ‡ä»¤æ‹¦æˆª (é˜²å´©æºƒç‰ˆ) ---
                        const playMatch = content.match(/\[\s*PLAY\s*[:ï¼š]([\s\S]*?)\]/i);

                        if (playMatch) {
                            // ã€é‡è¦ä¼˜åŒ–ã€‘å…ˆæŠŠæŒ‡ä»¤æ–‡æœ¬åˆ æ‰ï¼é˜²æ­¢åé¢æŠ¥é”™å¯¼è‡´æŒ‡ä»¤ç•™åœ¨æ°”æ³¡é‡Œ
                            content = content.replace(playMatch[0], '').trim();

                            const score = playMatch[1].trim();

                            try {
                                // 1. åœæ­¢ TTS
                                if (window.speechSynthesis) window.speechSynthesis.cancel();
                                if (window.WeChatUI) WeChatUI.isSpeaking = false;

                                // 2. æ˜¾ç¤ºæç¤º
                                const chars = AppStorage.get('wechat_chars', {});
                                const charForPlay = chars[cid];
                                WeChatUI.pushMessage('system', `ğŸ¹ ${charForPlay ? (charForPlay.nickname || charForPlay.name) : 'AI'} æ­£åœ¨æ¼”å¥...`, 'system', 'system', null, cid);

                                // 3. å®‰å…¨æ‰§è¡Œæ¼”å¥
                                if (window.MusicBox && window.Tone) {
                                    // å°è¯•å”¤é†’
                                    if (Tone.context.state !== 'running') Tone.context.resume().catch(e => console.log(e));
                                    setTimeout(() => MusicBox.playScore(score), 500);
                                } else {
                                    // å¦‚æœ Tone.js æ²¡åŠ è½½æˆåŠŸï¼Œæç¤ºç”¨æˆ·
                                    WeChatUI.pushMessage('system', '(é”™è¯¯ï¼šéŸ³é¢‘ç»„ä»¶ Tone.js åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢CDN)', 'system', 'error');
                                }
                            } catch (e) {
                                console.error("Play error:", e);
                            }

                            // 4. å¦‚æœæ²¡å†…å®¹äº†ï¼Œç»“æŸå¤„ç†
                            if (!content) {
                                setTimeout(processQueue, 500);
                                return;
                            }
                        }

                        // ã€ä¿®å¤ã€‘æ£€æµ‹AIçš„çº¢åŒ…/è½¬è´¦é¢†å–/æ‹’æ”¶æŒ‡ä»¤ï¼ˆæ”¯æŒæ›´å®½æ¾çš„æ ¼å¼å’Œä¸­æ–‡å†’å·ï¼‰
                        const acceptTransferMatch = content.match(/\[é¢†å–è½¬è´¦[:ï¼š]([^\]]+)\]/);
                        const rejectTransferMatch = content.match(/\[æ‹’æ”¶è½¬è´¦[:ï¼š]([^\]]+)\]/);
                        const acceptRedpacketMatch = content.match(/\[é¢†å–çº¢åŒ…[:ï¼š]([^\]]+)\]/);
                        const rejectRedpacketMatch = content.match(/\[æ‹’æ”¶çº¢åŒ…[:ï¼š]([^\]]+)\]/);

                        if (acceptTransferMatch || rejectTransferMatch || acceptRedpacketMatch || rejectRedpacketMatch) {
                            // ç¡®å®šæ“ä½œç±»å‹å’ŒåŸå§‹IDå­—ç¬¦ä¸²
                            let paymentType, action, rawId;
                            if (acceptTransferMatch) { paymentType = 'transfer'; action = 'received'; rawId = acceptTransferMatch[1]; }
                            else if (rejectTransferMatch) { paymentType = 'transfer'; action = 'rejected'; rawId = rejectTransferMatch[1]; }
                            else if (acceptRedpacketMatch) { paymentType = 'redpacket'; action = 'received'; rawId = acceptRedpacketMatch[1]; }
                            else if (rejectRedpacketMatch) { paymentType = 'redpacket'; action = 'rejected'; rawId = rejectRedpacketMatch[1]; }

                            // æ™ºèƒ½è§£æIDï¼šä»å¯èƒ½çš„å¤æ‚å­—ç¬¦ä¸²ä¸­æå–å®é™…çš„æ•°å­—ID
                            const parsePaymentId = (idStr) => {
                                const str = String(idStr).trim();
                                // 1. çº¯æ•°å­—
                                if (/^\d+$/.test(str)) return parseInt(str);
                                // 2. ä¸‹åˆ’çº¿åˆ†å‰² (e.g. 2024_transfer_20)
                                if (str.includes('_')) {
                                    const parts = str.split('_');
                                    const last = parts[parts.length - 1];
                                    if (/^\d+$/.test(last)) return parseInt(last);
                                }
                                // 3. æå–æœ€åçš„æ•°å­—ç»„
                                const matches = str.match(/\d+/g);
                                if (matches && matches.length > 0) {
                                    return parseInt(matches[matches.length - 1]);
                                }
                                return parseInt(str);
                            };

                            paymentId = parsePaymentId(rawId);
                            console.log(`[Payment] Parsed ID: ${paymentId} from raw: ${rawId}`);

                            // ä»æ¶ˆæ¯å†…å®¹ä¸­ç§»é™¤æ‰€æœ‰æ”¯ä»˜ç›¸å…³æŒ‡ä»¤ï¼ˆä¸æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
                            content = content.replace(/\[Payment Interaction\]:\s*(Receive|Reject)=\[([^\]]+)\]/i, '').trim();
                            // ä½¿ç”¨æ›´é€šç”¨çš„æ­£åˆ™æ¥æ¸…ç†æŒ‡ä»¤
                            content = content.replace(/\[(é¢†å–|æ‹’æ”¶)(è½¬è´¦|çº¢åŒ…)[:ï¼š][^\]]+\]/g, '').trim();

                            // æ ¹æ®IDæŸ¥æ‰¾å¯¹åº”çš„æ”¯ä»˜æ¶ˆæ¯
                            const chars = AppStorage.get('wechat_chars', {});
                            const char = chars[cid];
                            if (char && char.msgs) {
                                // æ ¹æ®paymentIdæŸ¥æ‰¾å¯¹åº”çš„æ”¯ä»˜æ¶ˆæ¯
                                const targetPayment = char.msgs.find(m =>
                                    m.type === paymentType && m.role === 'user' && m.paymentId === parseInt(paymentId)
                                );

                                if (targetPayment) {
                                    // æ›´æ–°æ”¯ä»˜çŠ¶æ€
                                    targetPayment.status = action;

                                    // å‡†å¤‡ç³»ç»Ÿæ¶ˆæ¯æ–‡æ¡ˆ
                                    const typeText = paymentType === 'redpacket' ? 'çº¢åŒ…' : 'è½¬è´¦';
                                    const amount = parseFloat(targetPayment.amount || '0');

                                    // ã€æ”¹è¿›ã€‘ä¸åŒçš„ç³»ç»Ÿæç¤ºæ–‡æ¡ˆ
                                    let systemMsgContent;
                                    if (action === 'received') {
                                        systemMsgContent = 'å·²æ”¶æ¬¾';
                                    } else {
                                        systemMsgContent = `å¯¹æ–¹æ‹’ç»äº†æ‚¨çš„${typeText}ï¼Œä½™é¢å·²é€€å›`;
                                    }

                                    // æ’å…¥ç³»ç»Ÿæ¶ˆæ¯ï¼ˆåœ¨å½“å‰AIå›å¤ä¹‹åï¼‰
                                    const systemMsg = {
                                        id: WeChatUI.generateMsgId(),
                                        role: 'system',
                                        type: 'system',
                                        content: systemMsgContent,
                                        timestamp: Date.now()
                                    };

                                    // æš‚å­˜ï¼Œç¨åæ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                                    window._pendingPaymentSystemMsg = systemMsg;

                                    // ã€æ”¹è¿›ã€‘å¤„ç†é’±åŒ…ä½™é¢
                                    if (action === 'received') {
                                        // æ¥å—ï¼šAIæ”¶æ¬¾
                                        WeChatUI.updateWalletBalance('income', amount, `æ”¶åˆ°${char.name}çš„${typeText}`);
                                    } else {
                                        // æ‹’æ”¶ï¼šé€€è¿˜ç»™ç”¨æˆ·
                                        WeChatUI.updateWalletBalance('income', amount, `${typeText}å·²é€€è¿˜`);
                                    }

                                    // ä¿å­˜æ›´æ”¹
                                    AppStorage.set('wechat_chars', chars);
                                }
                            }
                        }

                        // 1. æ£€æŸ¥æ˜¯å¦ä¸ºæŒ‡ä»¤æ ¼å¼
                        if (content.startsWith('/redpacket')) {
                            const parts = content.split(' ');
                            WeChatUI.pushMessage('redpacket', { note: parts.slice(2).join(' ') || 'æ­å–œå‘è´¢', amount: parts[1] }, 'ai');
                            return true;
                        } else if (content.startsWith('/transfer')) {
                            const parts = content.split(' ');
                            WeChatUI.pushMessage('transfer', { note: parts.slice(2).join(' ') || 'è½¬è´¦', amount: parts[1] }, 'ai');
                            return true;
                        } else if (content.startsWith('/voice')) {
                            const text = content.substring(7);
                            WeChatUI.pushMessage('voice', text, 'ai');
                            return true;
                        }

                        // ã€æ–°å¢ã€‘å¤„ç† [è¯­éŸ³: æ–‡æœ¬] æ ¼å¼ (å…¼å®¹ä¸­æ–‡å†’å·)
                        const voiceMatch = String(content).match(/^\[(?:è¯­éŸ³|voice)[:ï¼š]\s*(.*?)\]$/i);
                        if (voiceMatch) {
                            const text = voiceMatch[1].trim();
                            WeChatUI.pushMessage('voice', text, 'ai');
                            return true;
                        }

                        // ã€æ–°å¢ã€‘å¤„ç† [è¡¨æƒ…åŒ…: åç§°] æ ¼å¼ (å…¼å®¹ä¸­æ–‡å†’å·)
                        // ã€ä¿®æ­£ã€‘è¯†åˆ«è¡¨æƒ…åŒ…æŒ‡ä»¤ï¼ˆæ”¯æŒä¸­è‹±æ–‡å†’å·ã€åç§°æˆ–URLã€emojiå…³é”®å­—ï¼‰
                        // 3.5. è¯†åˆ«è¡¨æƒ…åŒ…æŒ‡ä»¤ (ä¿®å¤ç‰ˆï¼šå…ˆæŸ¥URLå†å‘é€)
                        const emojiMatch = String(content).match(/^\[(?:è¡¨æƒ…åŒ…|emoji)[:ï¼š]\s*(.*?)\]$/i);
                        if (emojiMatch) {
                            const emojiName = emojiMatch[1].trim();

                            // 1. è·å–æ‰€æœ‰å¯ç”¨è¡¨æƒ…åŒ…
                            const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                            const charEmojis = c ? (c.emojis || []) : [];
                            const allEmojis = [...globalEmojis, ...charEmojis];

                            // 2. æŸ¥æ‰¾å¯¹åº”çš„ URL (å¿½ç•¥å¤§å°å†™)
                            const target = allEmojis.find(e => (e.name || '').toLowerCase() === emojiName.toLowerCase());

                            if (target && target.url) {
                                // æ‰¾åˆ°äº†ï¼å‘é€çœŸæ­£çš„å›¾ç‰‡ URL
                                WeChatUI.pushMessage('image', target.url, 'ai', 'emoji', emojiName, targetCid);
                            } else {
                                // æ²¡æ‰¾åˆ°ï¼Œè½¬ä¸ºçº¯æ–‡æœ¬æç¤ºï¼Œé¿å…æ˜¾ç¤ºè£‚å›¾
                                console.warn('æœªæ‰¾åˆ°è¡¨æƒ…åŒ…:', emojiName);
                                WeChatUI.pushMessage('text', `[è¡¨æƒ…åŒ…: ${emojiName}]`, 'ai', 'text', null, targetCid);
                            }
                            setTimeout(processQueue, 100);
                            return;
                        }


                        // 2. è¯†åˆ«AIå‘é€çš„çº¢åŒ…æ ¼å¼ï¼š[çº¢åŒ…: é‡‘é¢ å¤‡æ³¨] 
                        // ã€ä¿®å¤ã€‘å…¼å®¹ä¸­æ–‡å†’å·
                        else if (String(content).match(/^\[çº¢åŒ…[:ï¼š][^\]]+\]$/)) {
                            const redPacketMatch = String(content).match(/^\[çº¢åŒ…[:ï¼š]\s*([^\]]+)\]$/);
                            if (redPacketMatch) {
                                const redContent = redPacketMatch[1].trim();
                                let amount = '0'; // é»˜è®¤é‡‘é¢
                                let note = 'æ­å–œå‘è´¢';

                                // æå–é‡‘é¢å’Œå¤‡æ³¨ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼šé‡‘é¢ å¤‡æ³¨ æˆ– [çº¢åŒ…: é‡‘é¢] æˆ– [çº¢åŒ…: é‡‘é¢ å¤‡æ³¨]
                                const parts = redContent.split(/\s+/);
                                if (parts.length >= 1 && !isNaN(parseFloat(parts[0]))) {
                                    amount = parts[0];
                                    if (parts.length >= 2) {
                                        note = parts.slice(1).join(' ');
                                    }
                                } else {
                                    // å¤„ç†[çº¢åŒ…: å¤‡æ³¨]æ ¼å¼ï¼Œæ·»åŠ é»˜è®¤é‡‘é¢
                                    note = redContent;
                                    amount = '520'; // é»˜è®¤é‡‘é¢
                                }

                                WeChatUI.pushMessage('redpacket', { note: note, amount: amount }, 'ai');
                            }
                            return true;
                        }

                        // 3. è¯†åˆ«AIå‘é€çš„è½¬è´¦æ ¼å¼ï¼š[è½¬è´¦: é‡‘é¢ å¤‡æ³¨] æˆ– [è½¬è´¦: é‡‘é¢]
                        else if (String(content).match(/^\[è½¬è´¦:[^\]]+\]$/)) {
                            const transferMatch = String(content).match(/^\[è½¬è´¦:\s*([^\]]+)\]$/);
                            if (transferMatch) {
                                const transContent = transferMatch[1].trim();
                                let amount = '0.00';
                                let note = 'è½¬è´¦';

                                // å°è¯•æå–é‡‘é¢å’Œå¤‡æ³¨ï¼Œæ ¼å¼ï¼šé‡‘é¢ å¤‡æ³¨
                                const parts = transContent.split(/\s+/);
                                if (parts.length >= 1 && !isNaN(parseFloat(parts[0]))) {
                                    amount = parts[0];
                                    if (parts.length >= 2) {
                                        note = parts.slice(1).join(' ');
                                    }
                                }

                                WeChatUI.pushMessage('transfer', { note: note, amount: amount }, 'ai');
                            }
                            return true;
                        }

                        // 4. ã€å¢å¼ºä¿®å¤ã€‘ä¸‡èƒ½å›¾ç‰‡/è¡¨æƒ…åŒ…è¯†åˆ«
                        // ã€ä¿®å¤ã€‘è§£å†³ [å›¾ç‰‡:[å›¾ç‰‡: URL]] è¿™ç§åµŒå¥—ä¹±ç é—®é¢˜
                        // æ–°æ­£åˆ™é€»è¾‘ï¼šåªè¦æ˜¯ [ å¼€å¤´ï¼Œ] ç»“å°¾ï¼Œä¸­é—´åŒ…å« http é“¾æ¥ï¼Œå°±å¼ºåˆ¶æå–é“¾æ¥ï¼Œå¿½ç•¥æ‰€æœ‰ä¹±ä¸ƒå…«ç³Ÿçš„å‰ç¼€åç¼€
                        const emojiDirectMatch = String(content).match(/^\[+[\s\S]*?(https?:\/\/[^\s"\]]+)[\s\S]*?\]+$/i);

                        if (emojiDirectMatch) {
                            const url = emojiDirectMatch[1].trim();
                            // å†æ¬¡æ¸…æ´—ä¸€ä¸‹ URLï¼Œé˜²æ­¢ AI åœ¨é‡Œé¢åŠ äº†åå¼•å·
                            const cleanUrl = url.replace(/[`'"\\]/g, '');
                            WeChatUI.pushMessage('image', cleanUrl, 'ai', 'image');
                            return true;
                        }

                        // 5. è¯†åˆ«çº¯ URL (å¦‚æœAIç›´æ¥å‘äº†è£¸é“¾æ¥)
                        if (String(content).match(/^https?:\/\/[^\s"']+\.(png|jpg|jpeg|gif|svg|webp)$/i)) {
                            WeChatUI.pushMessage('image', content.trim(), 'ai', 'image');
                            return true;
                        }

                        // 6. è¯†åˆ«å›¾ç‰‡URL
                        const urlPattern = /(https?:\/\/[^\s"']+\.(png|jpg|jpeg|gif|svg|bmp|webp))/gi;
                        const hasImageUrl = urlPattern.test(content);
                        if (hasImageUrl) {
                            // æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨æƒ…åŒ…åº“ä¸­çš„URL
                            const urls = content.match(urlPattern);
                            if (urls) {
                                for (const url of urls) {
                                    const matchedEmoji = allEmojis.find(emoji => emoji.url === url);
                                    if (matchedEmoji) {
                                        // æ˜¯è¡¨æƒ…åŒ…ï¼Œç›´æ¥å‘é€
                                        WeChatUI.pushMessage('image', url, 'ai', 'image');
                                    } else {
                                        // æ™®é€šå›¾ç‰‡URLï¼Œå‘é€ä¸ºæ–‡æœ¬
                                        WeChatUI.pushMessage('text', url, 'ai');
                                    }
                                }
                            }
                            // å‘é€å‰©ä½™æ–‡æœ¬
                            const textWithoutUrls = content.replace(urlPattern, '').trim();
                            if (textWithoutUrls) {
                                WeChatUI.pushMessage('text', textWithoutUrls, 'ai');
                            }
                            return true;
                        }

                        // 7. è¯†åˆ«æœ‹å‹åœˆäº’åŠ¨æ ¼å¼
                        // ç‚¹èµæ ¼å¼ï¼š[ç‚¹èµ: ç¼–å·] æˆ– [ç‚¹èµ: æœ‹å‹åœˆå†…å®¹]
                        // è¯„è®ºæ ¼å¼ï¼š[è¯„è®º: ç¼–å· è¯„è®ºå†…å®¹]
                        // å›å¤æ ¼å¼ï¼š[å›å¤: æœ‹å‹åœˆç¼–å· è¯„è®ºç¼–å· å›å¤å†…å®¹]
                        // åˆ†äº«æ ¼å¼ï¼š[åˆ†äº«: ç¼–å·] æˆ– [åˆ†äº«: åˆ†äº«å†…å®¹]
                        const momentsInteractionPattern = /\[(ç‚¹èµ|è¯„è®º|å›å¤|åˆ†äº«):\s*([^\]]+)\]/g;
                        const hasMomentsInteraction = momentsInteractionPattern.test(content);
                        if (hasMomentsInteraction) {
                            // è·å–æ‰€æœ‰æœ‹å‹åœˆäº’åŠ¨
                            const interactions = content.match(momentsInteractionPattern);
                            if (interactions) {
                                for (const interaction of interactions) {
                                    const match = interaction.match(/\[(ç‚¹èµ|è¯„è®º|å›å¤|åˆ†äº«):\s*([^\]]+)\]/);
                                    if (match) {
                                        const type = match[1];
                                        const interactionContent = match[2].trim();

                                        // è·å–æ‰€æœ‰æœ‹å‹åœˆåŠ¨æ€ï¼ŒæŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                                        const moments = AppStorage.get('wechat_moments', []);
                                        if (moments.length > 0) {
                                            // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
                                            const sortedMoments = moments.sort((a, b) => b.timestamp - a.timestamp);

                                            // è§£æç¼–å·æˆ–å†…å®¹
                                            let targetMoment = null;
                                            const numberPattern = /^(\d+)\s*(.*)$/;
                                            const numberMatch = interactionContent.match(numberPattern);

                                            if (numberMatch) {
                                                // æ ¼å¼ï¼š[æ“ä½œ: ç¼–å· å†…å®¹]
                                                const number = parseInt(numberMatch[1]);
                                                const contentAfterNumber = numberMatch[2].trim();

                                                // ç¼–å·ä»1å¼€å§‹ï¼Œæ‰€ä»¥å‡1å¾—åˆ°ç´¢å¼•
                                                const index = number - 1;
                                                if (index >= 0 && index < sortedMoments.length) {
                                                    targetMoment = sortedMoments[index];
                                                }

                                                // æ‰§è¡Œå¯¹åº”çš„äº’åŠ¨æ“ä½œ
                                                switch (type) {
                                                    case 'ç‚¹èµ':
                                                        if (targetMoment) {
                                                            WeChatUI.likeMoment(targetMoment.id);
                                                        }
                                                        break;
                                                    case 'è¯„è®º':
                                                        if (targetMoment && contentAfterNumber) {
                                                            WeChatUI.commentMoment(targetMoment.id, contentAfterNumber);
                                                        }
                                                        break;
                                                    case 'å›å¤':
                                                        // å›å¤æ ¼å¼ï¼š[å›å¤: æœ‹å‹åœˆç¼–å· Cè¯„è®ºç¼–å· å›å¤å†…å®¹]
                                                        if (targetMoment) {
                                                            const replyPattern = /^C(\d+)\s*(.*)$/;
                                                            const replyMatch = contentAfterNumber.match(replyPattern);
                                                            if (replyMatch) {
                                                                const commentIndex = parseInt(replyMatch[1]) - 1;
                                                                const replyContent = replyMatch[2].trim();
                                                                if (replyContent) {
                                                                    // è·å–è¦å›å¤çš„è¯„è®º
                                                                    const targetComment = targetMoment.comments && targetMoment.comments[commentIndex];
                                                                    if (targetComment) {
                                                                        // æ„å»ºå›å¤å†…å®¹
                                                                        const fullReplyContent = `å›å¤ ${targetComment.author}ï¼š${replyContent}`;
                                                                        WeChatUI.commentMoment(targetMoment.id, fullReplyContent);
                                                                    }
                                                                }
                                                            }
                                                        }
                                                        break;
                                                    case 'åˆ†äº«':
                                                        if (targetMoment) {
                                                            WeChatUI.shareMoment(targetMoment.id);
                                                        }
                                                        break;
                                                }
                                            } else {
                                                // æ ¼å¼ï¼š[æ“ä½œ: å†…å®¹]
                                                // å°è¯•æ ¹æ®å†…å®¹åŒ¹é…æœ‹å‹åœˆ
                                                const matchedMoment = sortedMoments.find(m => m.text.includes(interactionContent));
                                                if (matchedMoment) {
                                                    switch (type) {
                                                        case 'ç‚¹èµ':
                                                            WeChatUI.likeMoment(matchedMoment.id);
                                                            break;
                                                        case 'è¯„è®º':
                                                            WeChatUI.commentMoment(matchedMoment.id, interactionContent);
                                                            break;
                                                        case 'åˆ†äº«':
                                                            WeChatUI.shareMoment(matchedMoment.id);
                                                            break;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            return true;
                        }

                        // 8. ã€ä¼˜å…ˆã€‘è¯†åˆ«HTMLå¡ç‰‡ (é˜²æ­¢è¢«è¯¯åˆ¤ä¸ºæ–‡æœ¬æˆ–å›¾ç‰‡)
                        // åªè¦åŒ…å«é—­åˆçš„ div/span æ ‡ç­¾æˆ–è€… style å±æ€§ï¼Œå°±ä¼˜å…ˆå½“åš HTML å¤„ç†
                        if (/<(div|span|table|p)[^>]*>/.test(content) || content.includes('style="') || content.includes("style='")) {
                            // æ¸…ç†ä¸€ä¸‹å¼€å¤´ç»“å°¾å¯èƒ½å¤šä½™çš„æ¢è¡Œ
                            WeChatUI.pushMessage('html', content.trim(), 'ai');
                            return true;
                        }

                        // 9. é»˜è®¤å¤„ç†ï¼šæ–‡æœ¬æ¶ˆæ¯
                        WeChatUI.pushMessage('text', content, 'ai');

                        // ã€æ–°å¢ã€‘å¦‚æœæœ‰å¾…å¤„ç†çš„æ”¯ä»˜ç³»ç»Ÿæ¶ˆæ¯ï¼Œç«‹å³æ·»åŠ 
                        // ã€ä¿®å¤ã€‘æ’å…¥ç³»ç»Ÿæ¶ˆæ¯å¹¶åˆ·æ–°å¡ç‰‡çŠ¶æ€
                        if (window._pendingPaymentSystemMsg) {
                            const chars = AppStorage.get('wechat_chars', {});
                            const char = chars[cid];
                            if (char && char.msgs) {
                                // æ‰¾åˆ°å½“å‰AIå›å¤æ¶ˆæ¯çš„ç´¢å¼•
                                const aiMsgIndex = char.msgs.findIndex(m => m.id === msg.id);

                                if (aiMsgIndex !== -1) {
                                    // åœ¨AIæ¶ˆæ¯åé¢æ’å…¥ç³»ç»Ÿæ¶ˆæ¯
                                    char.msgs.splice(aiMsgIndex + 1, 0, window._pendingPaymentSystemMsg);
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±æ”¾åœ¨æœ€å
                                    char.msgs.push(window._pendingPaymentSystemMsg);
                                }

                                AppStorage.set('wechat_chars', chars);
                                WeChatUI.loadChat(cid); // åˆ·æ–°ç•Œé¢ï¼Œæ›´æ–°å¡ç‰‡çŠ¶æ€å’Œæ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                            }
                            window._pendingPaymentSystemMsg = null; // æ¸…é™¤æ ‡è®°
                        }

                        return true;
                    }

                    // ã€æ ¸å¿ƒä¿®å¤ã€‘å¿…é¡»è°ƒç”¨å¤„ç†å‡½æ•°ï¼Œå¦åˆ™æ¶ˆæ¯ä¼šè¢«æ‚„æ‚„ä¸¢å¼ƒï¼
                    if (processMessageContent(msgContent) === true) {
                        // å¦‚æœå¤„ç†ç»“è®ºä¸º trueï¼Œåˆ™ç­‰å¾… 500ms å¤„ç†ä¸‹ä¸€æ¡
                        setTimeout(processQueue, 500);
                    }
                }

                // å¼€å§‹å¤„ç†é˜Ÿåˆ—
                processQueue();
            },

            // --- æ‹ä¸€æ‹åŠŸèƒ½ ---
            handlePat: (charId, msgIdx, role, element) => {
                // 1. è§†è§‰æ•ˆæœï¼šæ·»åŠ æŠ–åŠ¨ç±»ï¼ŒåŠ¨ç”»ç»“æŸåç§»é™¤
                element.classList.add('avatar-shake');
                setTimeout(() => element.classList.remove('avatar-shake'), 500);

                // 2. è·å–åŸºæœ¬ä¿¡æ¯
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                const userProfile = AppStorage.get('wechat_user_profile', {});
                const myName = userProfile.name || 'æˆ‘';
                const targetName = role === 'user' ? myName : (char.nickname || char.name);

                // 3. é˜²æŠ–ï¼šé˜²æ­¢è¿ç»­ç‚¹å‡»åˆ·å± (3ç§’å†…åªèƒ½æ‹ä¸€æ¬¡)
                const now = Date.now();
                if (WeChatUI.lastPatTime && (now - WeChatUI.lastPatTime < 3000)) {
                    return;
                }
                WeChatUI.lastPatTime = now;

                // 4. å‘é€ç³»ç»Ÿæç¤ºæ¶ˆæ¯ (ç°è‰²å°å­—)
                let patText = '';
                if (role === 'ai') {
                    // ç”¨æˆ·æ‹äº†AIï¼šä½¿ç”¨AIçš„è‡ªå®šä¹‰åŠ¨ä½œå’Œåç¼€
                    const patAction = char.patAction || 'æ‹äº†æ‹';
                    const patSuffix = char.patSuffix || 'çš„å¤´';
                    patText = `${myName}${patAction}â€œ${targetName}â€${patSuffix}`;
                } else {
                    // ç”¨æˆ·æ‹äº†è‡ªå·±ï¼šä½¿ç”¨é»˜è®¤æ ¼å¼
                    patText = `${myName}æ‹äº†æ‹è‡ªå·±`;
                }

                // æ’å…¥ä¸€æ¡ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©è®°å½•
                WeChatUI.pushMessage('system', patText, 'system');

                // 5. éœ‡åŠ¨åé¦ˆ (æ‰‹æœºç«¯)
                if (navigator.vibrate) navigator.vibrate(50);
            },

            // ã€æ ¸å¿ƒã€‘åŠ¨æ€æ·»åŠ ç¼–è¾‘å— (æ”¯æŒå›¾ä¸€é‚£æ ·çš„å¡ç‰‡)
            addEditBlock: (data = null) => {
                const container = document.getElementById('edit-msg-list');
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-gray-200 relative group shadow-sm hover:shadow-md transition-shadow";

                // è®¾ç½®é»˜è®¤å€¼
                const role = data ? data.role : 'user';
                const type = data ? data.type : 'text';
                let content = '';

                if (data) {
                    if (data.type === 'voice') content = data.text;
                    else if (data.type === 'image') content = data.originalContent || data.content;
                    else if (data.type === 'redpacket' || data.type === 'transfer') content = data.note;
                    else content = data.content;
                }

                div.innerHTML = `
                    <button onclick="if(document.getElementById('edit-msg-list').children.length > 1) this.parentElement.remove();" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <div class="flex gap-2 mb-2 pr-8">
                        <select class="edit-block-role setting-input mb-0 text-xs py-1 h-8 w-20 bg-gray-50 border-gray-200 focus:bg-white">
                            <option value="user" ${role === 'user' ? 'selected' : ''}>æˆ‘</option>
                            <option value="ai" ${role === 'ai' ? 'selected' : ''}>AI</option>
                            <option value="system" ${role === 'system' ? 'selected' : ''}>ç³»ç»Ÿ</option>
                        </select>
                        <select class="edit-block-type setting-input mb-0 text-xs py-1 h-8 flex-1 bg-gray-50 border-gray-200 focus:bg-white">
                            <option value="text" ${type === 'text' ? 'selected' : ''}>æ–‡æœ¬</option>
                            <option value="html" ${type === 'html' ? 'selected' : ''}>HTML</option>
                            <option value="image" ${type === 'image' ? 'selected' : ''}>å›¾ç‰‡/è¡¨æƒ…åŒ… URL</option>
                            <option value="voice" ${type === 'voice' ? 'selected' : ''}>è¯­éŸ³æ¡</option>
                            <option value="redpacket" ${type === 'redpacket' ? 'selected' : ''}>çº¢åŒ…</option>
                            <option value="transfer" ${type === 'transfer' ? 'selected' : ''}>è½¬è´¦</option>
                        </select>
                    </div>
                    <textarea class="edit-block-content w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm min-h-[80px] focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all resize-y placeholder-gray-400" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹...">${content}</textarea>
                `;
                container.appendChild(div);
                setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'end' }), 50);
            },

            // ä¿å­˜æ›´æ”¹ (ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æ¶ˆæ¯å—)
            confirmEditMsg: () => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});

                // ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ ID åæŸ¥æ¶ˆæ¯ç´¢å¼•ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”¨ç´¢å¼•
                // å› ä¸º ctxTargetMsg å¯èƒ½æ˜¯ç©ºçš„ï¼Œæˆ–è€…å› ä¸ºåŠ è½½æ›´å¤šæ¶ˆæ¯åç´¢å¼•å˜äº†
                const msgs = chars[cid].msgs;
                const originalMsgIdx = msgs.findIndex(m => m.id === WeChatUI.ctxTargetMsgId);

                if (originalMsgIdx === -1) {
                    Utils.showToast('ä¿å­˜å¤±è´¥ï¼šæ‰¾ä¸åˆ°åŸæ¶ˆæ¯');
                    document.getElementById('modal-edit-msg').classList.add('hidden');
                    return;
                }

                const originalMsg = msgs[originalMsgIdx];
                const blocks = document.querySelectorAll('#edit-msg-list > div');
                const newMsgs = [];

                blocks.forEach(div => {
                    const role = div.querySelector('.edit-block-role').value;
                    const type = div.querySelector('.edit-block-type').value;
                    const content = div.querySelector('.edit-block-content').value;

                    let msg = { role, type, content, timestamp: Date.now() };

                    if (type === 'voice') { msg.text = content; msg.content = 'Voice'; }
                    else if (type === 'image') {
                        msg.originalContent = content;
                        // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…åŒ…
                        const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                        const chars = AppStorage.get('wechat_chars', {});
                        const c = chars[cid];
                        if (c) {
                            const globalEmojis = AppStorage.get('wechat_global_emojis', []);
                            const charEmojis = c.emojis || [];
                            const allEmojis = [...globalEmojis, ...charEmojis];
                            const target = allEmojis.find(e => e.url === content);
                            if (target) {
                                msg.content = `[è¡¨æƒ…åŒ…: ${target.name}]`;
                            } else {
                                msg.content = `[å›¾ç‰‡: ${content}]`;
                            }
                        } else {
                            msg.content = `[å›¾ç‰‡: ${content}]`;
                        }
                    }
                    else if (type === 'redpacket') { msg.note = content || 'æ­å–œå‘è´¢'; msg.content = 'çº¢åŒ…'; msg.amount = '88.88'; }
                    else if (type === 'transfer') { msg.note = content || 'è½¬è´¦'; msg.content = 'è½¬è´¦'; msg.amount = '520.00'; }
                    else if (type === 'html') { msg.type = 'html'; }

                    // å¦‚æœæ˜¯å•æ¡ç¼–è¾‘ï¼Œç»§æ‰¿ IDï¼Œä¿æŒå‰åä¸€è‡´
                    if (blocks.length === 1 && originalMsg) {
                        msg.id = originalMsg.id;
                        // ã€æ ¸å¿ƒã€‘ä¿å­˜å†å²è®°å½•
                        if (originalMsg.content !== msg.content) {
                            msg.history = originalMsg.history || [];
                            msg.history.unshift({
                                content: originalMsg.content,
                                timestamp: Date.now(),
                                role: originalMsg.role // è®°å½•å½“æ—¶çš„è§’è‰²
                            });
                        } else {
                            msg.history = originalMsg.history; // å†…å®¹æ²¡å˜ï¼Œä¿æŒåŸæ ·
                        }
                    } else {
                        // å¦‚æœæ˜¯æ‹†åˆ†æˆ–æ–°å¢ï¼Œç”Ÿæˆæ–°ID
                        msg.id = WeChatUI.generateMsgId();
                    }

                    newMsgs.push(msg);
                });

                if (newMsgs.length === 0) return;

                // ä½¿ç”¨è®¡ç®—å‡ºçš„æ­£ç¡®ç´¢å¼•è¿›è¡Œæ›¿æ¢
                chars[cid].msgs.splice(originalMsgIdx, 1, ...newMsgs);

                AppStorage.set('wechat_chars', chars);
                document.getElementById('modal-edit-msg').classList.add('hidden');
                WeChatUI.loadChat(cid);
                Utils.showToast('ä¿®æ”¹å·²ä¿å­˜');
            },

            // ä¿ç•™ç©ºå‡½æ•°ï¼Œé˜²æ­¢æŠ¥é”™
            insertMsgBelow: () => { },

            // æŸ¥çœ‹å†å²
            viewMsgHistory: () => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                // ä½¿ç”¨ ID æŸ¥æ‰¾æ¶ˆæ¯ï¼Œæ›´å®‰å…¨
                const msg = chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId);

                WeChatUI.hideContextMenu(); // å…³é—­èœå•

                if (!msg || !msg.history || msg.history.length === 0) {
                    Utils.showToast('è¯¥æ¶ˆæ¯æ²¡æœ‰ä¿®æ”¹å†å²');
                    return;
                }
                const listContainer = document.getElementById('msg-history-list');
                listContainer.innerHTML = msg.history.map((h, idx) => `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400">${new Date(h.timestamp).toLocaleString()}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-600">${h.role === 'user' ? 'æˆ‘' : 'AI'}</span>
                    </div>
                    <div class="text-sm text-gray-800 mb-3 break-all max-h-20 overflow-y-auto">${h.content}</div>
                    <button onclick="WeChatUI.restoreMsgVersion('${msg.id}', ${idx})" class="w-full py-1.5 text-xs bg-green-50 text-green-600 rounded hover:bg-green-100 transition-colors border border-green-200 font-medium">
                        æ¢å¤æ­¤ç‰ˆæœ¬
                    </button>
                </div>
            `).join('');
                document.getElementById('modal-msg-history').classList.remove('hidden');
            },
            // æ¢å¤ç‰ˆæœ¬
            restoreMsgVersion: (msgId, historyIdx) => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const msg = chars[cid].msgs.find(m => m.id === msgId);

                if (msg && msg.history[historyIdx]) {
                    // 1. è·å–è¦æ¢å¤çš„å†å²ç‰ˆæœ¬
                    const targetVersion = msg.history[historyIdx];

                    // 2. æŠŠå½“å‰ç°åœ¨çš„ç‰ˆæœ¬æ¨å…¥å†å²å †æ ˆï¼ˆé˜²æ­¢è¯¯æ“ä½œå›ä¸å»ï¼‰
                    msg.history.unshift({
                        content: msg.content,
                        timestamp: Date.now(),
                        role: msg.role
                    });

                    // 3. è¦†ç›–å½“å‰å†…å®¹
                    msg.content = targetVersion.content;
                    // å¦‚æœå†å²ç‰ˆæœ¬æœ‰è®°å½•è§’è‰²ï¼Œä¹Ÿæ¢å¤è§’è‰²ï¼ˆå¯é€‰ï¼‰
                    if (targetVersion.role) msg.role = targetVersion.role;

                    // 4. ä¿å­˜
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.loadChat(cid);

                    // 5. å…³é—­å¼¹çª—
                    document.getElementById('modal-msg-history').classList.add('hidden');
                    Utils.showToast('å·²æ¢å¤åˆ°æ—§ç‰ˆæœ¬');
                }
            },

            // ã€æ–°å¢ã€‘æœ‹å‹åœˆè®¾ç½®åŠŸèƒ½
            openMomentsSettings: () => {
                console.log('[æœ‹å‹åœˆè®¾ç½®] æ‰“å¼€è®¾ç½®é¢æ¿');

                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                WeChatUI.renderMomentsFriendsList();
            },

            renderMomentsFriendsList: () => {
                console.log('[æœ‹å‹åœˆè®¾ç½®] æ¸²æŸ“å¥½å‹åˆ—è¡¨');

                // æŸ¥æ‰¾å¥½å‹åˆ—è¡¨å®¹å™¨
                const container = document.getElementById('friends-list-for-clear') ||
                    document.querySelector('[class*="friends-list"]');

                if (!container) {
                    console.error('[æœ‹å‹åœˆè®¾ç½®] æœªæ‰¾åˆ°å¥½å‹åˆ—è¡¨å®¹å™¨');
                    return;
                }

                // è¯»å–æ‰€æœ‰è§’è‰²æ•°æ®
                let chars = {};
                try {
                    chars = JSON.parse(localStorage.getItem('wechat_chars') || '{}');
                } catch (e) {
                    console.error('[æœ‹å‹åœˆè®¾ç½®] è¯»å–è§’è‰²æ•°æ®å¤±è´¥', e);
                    chars = {};
                }

                // å¦‚æœæ²¡æœ‰è§’è‰²æ•°æ®
                if (Object.keys(chars).length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— å¥½å‹æ•°æ®</div>';
                    return;
                }

                // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                const friendsHTML = Object.entries(chars).map(([cid, char]) => {
                    const name = char.name || char.nickname || 'æœªå‘½åå¥½å‹';
                    const avatar = char.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${cid}`;
                    const isVisible = char.momentsVisible !== false; // é»˜è®¤å¯è§

                    return `
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors" data-char-id="${cid}">
                            <div class="flex items-center gap-3">
                                <img src="${avatar}" class="w-10 h-10 rounded-lg object-cover" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=${cid}'">
                                <div>
                                    <div class="font-medium text-gray-800">${name}</div>
                                    <div class="text-xs text-gray-400">ID: ${cid}</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" 
                                       class="sr-only peer friend-visibility-toggle" 
                                       data-char-id="${cid}"
                                       ${isVisible ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    `;
                }).join('');

                container.innerHTML = friendsHTML;

                // ç»‘å®šåˆ‡æ¢äº‹ä»¶
                container.querySelectorAll('.friend-visibility-toggle').forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const charId = e.target.dataset.charId;
                        const isVisible = e.target.checked;

                        try {
                            const chars = JSON.parse(localStorage.getItem('wechat_chars') || '{}');
                            if (chars[charId]) {
                                chars[charId].momentsVisible = isVisible;
                                localStorage.setItem('wechat_chars', JSON.stringify(chars));
                                console.log(`[æœ‹å‹åœˆè®¾ç½®] ${chars[charId].name} å¯è§æ€§è®¾ç½®ä¸º: ${isVisible}`);
                            }
                        } catch (e) {
                            console.error('[æœ‹å‹åœˆè®¾ç½®] ä¿å­˜å¯è§æ€§è®¾ç½®å¤±è´¥', e);
                        }
                    });
                });

                console.log(`[æœ‹å‹åœˆè®¾ç½®] å·²æ¸²æŸ“ ${Object.keys(chars).length} ä¸ªå¥½å‹`);
            },

            enterMultiSelectMode: () => {
                WeChatUI.isMultiSelect = true;
                document.getElementById('subpage-chat-detail').classList.add('multiselect-mode');
            },
            exitMultiSelectMode: () => {
                WeChatUI.isMultiSelect = false;
                document.getElementById('subpage-chat-detail').classList.remove('multiselect-mode');
                document.querySelectorAll('.msg-checkbox').forEach(el => el.classList.remove('checked'));
            },
            toggleSelect: (idx, el) => {
                if (!WeChatUI.isMultiSelect) return;
                el.classList.toggle('checked');
                el.dataset.idx = idx;
            },
            deleteSelectedMessages: () => {
                const selectedEls = document.querySelectorAll('.msg-checkbox.checked');
                if (selectedEls.length === 0) return;
                if (!confirm(`ç¡®å®šåˆ é™¤?`)) return;
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = AppStorage.get('wechat_chars', {});
                const indicesToDelete = Array.from(selectedEls).map(el => parseInt(el.dataset.idx)).sort((a, b) => b - a);
                indicesToDelete.forEach(idx => {
                    chars[cid].msgs.splice(idx, 1);
                });
                AppStorage.set('wechat_chars', chars);
                WeChatUI.exitMultiSelectMode();
                WeChatUI.loadChat(cid);
            },

            // Contact Management
            showContactMenu: (e, id, listType) => {
                console.log('[showContactMenu] å‡½æ•°è¢«è°ƒç”¨! id:', id, 'listType:', listType, 'event:', e);
                e.preventDefault();
                e.stopPropagation();
                WeChatUI.ctxTargetContact = id;
                WeChatUI.ctxListType = listType;
                const menu = document.getElementById('contact-context-menu');

                // ç¡®ä¿èœå•å…ƒç´ å­˜åœ¨
                if (!menu) {
                    console.error('contact-context-menuå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                console.log('[showContactMenu] èœå•å…ƒç´ æ‰¾åˆ°ï¼Œè®¾ç½®æ ·å¼...');

                // ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶è®¾ç½®èœå•æ ·å¼ï¼Œç¡®ä¿å¯è§
                menu.style.display = 'block';
                menu.style.position = 'fixed';
                menu.style.zIndex = '999999';
                menu.style.backgroundColor = '#2b2b2b';
                menu.style.borderRadius = '8px';
                menu.style.boxShadow = '0 5px 20px rgba(0,0,0,0.6)';
                menu.style.width = '140px';
                menu.style.border = '1px solid #333';
                menu.style.padding = '8px 0';

                // ç§»é™¤hiddenç±»ï¼Œæ˜¾ç¤ºèœå•
                menu.classList.remove('hidden');
                menu.style.opacity = '1';

                // è®¡ç®—èœå•ä½ç½®
                let top = e.clientY;
                let left = e.clientX;
                const menuHeight = menu.offsetHeight || 100;
                const menuWidth = menu.offsetWidth || 140;

                console.log(`[showContactMenu] èœå•å°ºå¯¸: ${menuWidth}x${menuHeight}`);
                console.log(`[showContactMenu] åˆå§‹ä½ç½®: (${left}, ${top})`);

                // ç¡®ä¿èœå•åœ¨è§†çª—å†…
                if (top + menuHeight > window.innerHeight) {
                    top = window.innerHeight - menuHeight - 10;
                }
                if (left + menuWidth > window.innerWidth) {
                    left = window.innerWidth - menuWidth - 10;
                }
                if (top < 0) top = 10;
                if (left < 0) left = 10;

                menu.style.top = top + 'px';
                menu.style.left = left + 'px';

                console.log(`[showContactMenu] æœ€ç»ˆä½ç½®: (${left}, ${top})`);

                // æ ¹æ®åˆ—è¡¨ç±»å‹æ˜¾ç¤ºä¸åŒçš„åˆ é™¤é€‰é¡¹
                const deleteItem = menu.querySelector('.ctx-item.text-red-400');
                const deleteText = document.getElementById('contact-delete-text');

                // ç§»é™¤ä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                deleteItem.replaceWith(deleteItem.cloneNode(true));
                const newDeleteItem = menu.querySelector('.ctx-item.text-red-400');

                if (listType === 'chat') {
                    deleteText.textContent = 'åˆ é™¤èŠå¤©';
                    newDeleteItem.onclick = WeChatUI.deleteChat;
                } else {
                    deleteText.textContent = 'åˆ é™¤å¥½å‹';
                    newDeleteItem.onclick = WeChatUI.deleteFriend;
                }

                console.log('[showContactMenu] èœå•å·²æ˜¾ç¤º!');

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.classList.add('hidden');
                        if (menu) menu.style.opacity = '0';
                        if (menu) menu.style.display = 'none';
                        document.removeEventListener('click', closeMenu);
                        console.log('[showContactMenu] èœå•å·²å…³é—­!');
                    }
                };

                // æ·»åŠ å…³é—­èœå•çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 0);
            },
            deleteChat: () => {
                // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
                Utils.showConfirm('åˆ é™¤èŠå¤©', 'ç¡®å®šåˆ é™¤è¯¥èŠå¤©å—ï¼Ÿè¿™å°†æ¸…é™¤èŠå¤©è®°å½•å¹¶å°†è§’è‰²ä»èŠå¤©åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä½†è§’è‰²ä»å¯åœ¨é€šè®¯å½•ä¸­æ‰¾åˆ°ã€‚', (confirmed) => {
                    if (confirmed) {
                        const chars = AppStorage.get('wechat_chars', {});
                        const char = chars[WeChatUI.ctxTargetContact];
                        if (char) {
                            // é‡ç½®è§’è‰²æ•°æ®ï¼Œç§»é™¤èŠå¤©åˆ—è¡¨
                            char.msgs = []; // æ¸…ç©ºèŠå¤©è®°å½•
                            char.unread = 0; // æ¸…ç©ºæœªè¯»æ¶ˆæ¯
                            char.innerVoices = []; // æ¸…ç©ºå¿ƒå£°
                            char.memory = []; // æ¸…ç©ºæ‰€æœ‰è®°å¿†ï¼ŒåŒ…æ‹¬æ€»ç»“
                            // æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè¿™æ ·æ¸²æŸ“æ—¶ä¼šä»èŠå¤©åˆ—è¡¨ä¸­ç§»é™¤
                            char.deleted = true;
                            // æ¸…ç©ºå…¶ä»–ä¸´æ—¶æ•°æ®
                            if (char.summary) char.summary = '';
                            if (char.innerVoice) char.innerVoice = [];
                            // ä¿å­˜åˆ°å­˜å‚¨
                            AppStorage.set('wechat_chars', chars);
                            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                            WeChatUI.renderList();
                            Utils.showToast('èŠå¤©å·²åˆ é™¤');
                        }
                    }
                });
                // å…³é—­ä¸Šä¸‹æ–‡èœå•
                document.getElementById('contact-context-menu').classList.add('hidden');
            },
            deleteFriend: () => {
                // å…ˆå¼¹çª—ç¡®è®¤
                if (confirm('ç¡®å®šåˆ é™¤è¯¥å¥½å‹å—ï¼Ÿè¿™å°†å®Œå…¨åˆ é™¤è¯¥è§’è‰²åŠå…¶æ‰€æœ‰èŠå¤©è®°å½•ã€‚')) {
                    const chars = AppStorage.get('wechat_chars', {});
                    if (chars[WeChatUI.ctxTargetContact]) {
                        // å®Œå…¨åˆ é™¤è§’è‰²
                        delete chars[WeChatUI.ctxTargetContact];
                        // ä¿å­˜åˆ°å­˜å‚¨
                        AppStorage.set('wechat_chars', chars);
                        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                        WeChatUI.renderList();
                        Utils.showToast('å¥½å‹å·²åˆ é™¤');
                    }
                }
                // å…³é—­ä¸Šä¸‹æ–‡èœå•
                document.getElementById('contact-context-menu').classList.add('hidden');
            },

            togglePinContact: () => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[WeChatUI.ctxTargetContact];
                if (char) {
                    // åˆ‡æ¢ç½®é¡¶çŠ¶æ€
                    char.pinned = !char.pinned;
                    AppStorage.set('wechat_chars', chars);
                    WeChatUI.renderList();
                    Utils.showToast(char.pinned ? 'å·²ç½®é¡¶' : 'å·²å–æ¶ˆç½®é¡¶');
                }
                document.getElementById('contact-context-menu').classList.add('hidden');
            },

            closeSubPage: (id) => {
                // ã€æŸ¥å²—è®¡æ—¶ã€‘å¦‚æœå…³é—­çš„æ˜¯èŠå¤©è¯¦æƒ…é¡µï¼Œè®°å½•ç¦»å¼€æ—¶é—´
                if (id === 'subpage-chat-detail') {
                    const chatPage = document.getElementById('subpage-chat-detail');
                    const charId = chatPage ? chatPage.dataset.charId : null;
                    if (charId) {
                        const chars = AppStorage.get('wechat_chars', {});
                        if (chars[charId]) {
                            chars[charId].lastLeaveTime = Date.now();
                            AppStorage.set('wechat_chars', chars);
                            console.log(`[æŸ¥å²—] ${chars[charId].name} çš„èŠå¤©ç•Œé¢è¢«å…³é—­ï¼Œè®°å½•ç¦»å¼€æ—¶é—´`);
                        }
                    }
                    // åœæ­¢å½“å‰æœ—è¯»å¹¶æ¸…ç©ºé˜Ÿåˆ—
                    window.speechSynthesis.cancel();
                    if (WeChatUI.currentTTSAudio) {
                        try { WeChatUI.currentTTSAudio.pause(); } catch (e) { }
                        WeChatUI.currentTTSAudio = null;
                    }
                    WeChatUI.isSpeaking = false;
                    WeChatUI.ttsQueue = [];
                    // ã€ä¸»åŠ¨å‘æ¶ˆæ¯ã€‘åœæ­¢è®¡æ—¶å™¨
                    if (WeChatUI.proactiveChatTimer) {
                        clearInterval(WeChatUI.proactiveChatTimer);
                        WeChatUI.proactiveChatTimer = null;
                        console.log(`[ä¸»åŠ¨å‘æ¶ˆæ¯] è®¡æ—¶å™¨å·²åœæ­¢ï¼ˆç”¨æˆ·ç¦»å¼€èŠå¤©ç•Œé¢ï¼‰`);
                    }
                }

                // éšè—å½“å‰å­é¡µé¢
                document.getElementById(id).classList.remove('active');

                // ã€ä¿®å¤ã€‘è§£é™¤å¯èƒ½å­˜åœ¨çš„ç‚¹å‡»é”å®š
                document.body.style.overflow = '';
                const appWindow = document.querySelector('.app-window');
                if (appWindow) appWindow.style.pointerEvents = '';
            },


            // ä¸ªäººä¿¡æ¯ç›¸å…³åŠŸèƒ½

            // æ‰“å¼€å¤´åƒä¸Šä¼ 
            openAvatarUpload: () => {
                document.getElementById('modal-avatar-upload').classList.remove('hidden');
            },

            // å¤„ç†å¤´åƒä¸Šä¼ 
            handleAvatarUpload: (input) => {
                if (input.files[0]) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        // æ›´æ–°ç”¨æˆ·å¤´åƒ
                        const userProfile = AppStorage.get('wechat_user_profile', {});
                        userProfile.avatar = base64;
                        AppStorage.set('wechat_user_profile', userProfile);

                        // æ›´æ–°UI
                        const userAvatarEl = document.getElementById('user-avatar');
                        if (userAvatarEl) userAvatarEl.src = base64;
                        const editorAvatarEl = document.getElementById('editor-avatar');
                        if (editorAvatarEl) editorAvatarEl.src = base64;
                        const momentsAvatarEl = document.getElementById('moments-avatar');
                        if (momentsAvatarEl) momentsAvatarEl.src = base64;
                        const userMomentsAvatarEl = document.getElementById('user-moments-avatar');
                        if (userMomentsAvatarEl) userMomentsAvatarEl.src = base64;

                        // å…³é—­æ¨¡æ€æ¡†
                        document.getElementById('modal-avatar-upload').classList.add('hidden');

                        // æ˜¾ç¤ºæç¤º
                        Utils.showToast('å¤´åƒå·²æ›´æ–°');
                    });
                }
            },

            // ç”Ÿæˆéšæœºå¤´åƒ
            generateRandomAvatar: () => {
                // ä»é»˜è®¤å¤´åƒåˆ—è¡¨ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå¤´åƒ
                const avatarUrl = WeChatUI.getRandomAvatar();

                // æ›´æ–°ç”¨æˆ·å¤´åƒ
                const userProfile = AppStorage.get('wechat_user_profile', {});
                userProfile.avatar = avatarUrl;
                AppStorage.set('wechat_user_profile', userProfile);

                // æ›´æ–°UI
                document.getElementById('user-avatar').src = avatarUrl;
                document.getElementById('editor-avatar').src = avatarUrl;
                document.getElementById('moments-avatar').src = avatarUrl;
                document.getElementById('user-moments-avatar').src = avatarUrl;

                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('modal-avatar-upload').classList.add('hidden');

                // æ˜¾ç¤ºæç¤º
                Utils.showToast('å¤´åƒå·²æ›´æ–°');
            },

            // ç¼–è¾‘ç”¨æˆ·å
            editUserName: () => {
                const userProfile = AppStorage.get('wechat_user_profile', {});
                // æ˜¾ç¤ºå†…éƒ¨å¼¹çª—
                document.getElementById('edit-username-input').value = userProfile.name || 'æˆ‘';
                document.getElementById('modal-edit-username').classList.remove('hidden');
            },

            // å–æ¶ˆä¿®æ”¹ç”¨æˆ·å
            cancelEditUsername: () => {
                document.getElementById('modal-edit-username').classList.add('hidden');
            },

            // ç¡®è®¤ä¿®æ”¹ç”¨æˆ·å
            confirmEditUsername: () => {
                const userProfile = AppStorage.get('wechat_user_profile', {});
                const newName = document.getElementById('edit-username-input').value;

                if (newName && newName.trim()) {
                    const trimmedName = newName.trim();
                    userProfile.name = trimmedName;
                    AppStorage.set('wechat_user_profile', userProfile);

                    // æ›´æ–°UI
                    const userNameEl = document.getElementById('user-name');
                    if (userNameEl) userNameEl.textContent = trimmedName;

                    const momentsNameEl = document.getElementById('moments-name');
                    if (momentsNameEl) momentsNameEl.textContent = trimmedName;

                    const userMomentsNameEl = document.getElementById('user-moments-name');
                    if (userMomentsNameEl) userMomentsNameEl.textContent = trimmedName;

                    // åŒæ­¥åˆ°å½“å‰è§’è‰²çš„è®¾ç½®ä¸­
                    const chars = AppStorage.get('wechat_chars', {});
                    const currentChatId = WeChatUI.currentChatId;
                    if (currentChatId && chars[currentChatId]) {
                        chars[currentChatId].userName = trimmedName;
                        AppStorage.set('wechat_chars', chars);
                    }

                    // æ˜¾ç¤ºæç¤º
                    Utils.showToast('ç”¨æˆ·åå·²æ›´æ–°');
                }

                // å…³é—­å¼¹çª—
                document.getElementById('modal-edit-username').classList.add('hidden');
            },

            // é’±åŒ…ç›¸å…³åŠŸèƒ½

            // åˆå§‹åŒ–é’±åŒ…
            initWallet: () => {
                const wallet = AppStorage.get('wechat_wallet', null);
                if (!wallet) {
                    AppStorage.set('wechat_wallet', { balance: 0, transactions: [] });
                }
            },

            // æ‰“å¼€é’±åŒ…é¡µé¢
            openWallet: () => {
                // åˆå§‹åŒ–é’±åŒ…æ•°æ®
                WeChatUI.initWallet();

                // æ‰“å¼€é’±åŒ…é¡µé¢
                WeChatUI.openSubPage('subpage-wallet');

                // åŠ è½½é’±åŒ…æ•°æ®ï¼ˆé¡µé¢æ˜¾ç¤ºåå†åŠ è½½ï¼‰
                WeChatUI.loadWalletData();
            },

            // åŠ è½½é’±åŒ…æ•°æ®
            loadWalletData: () => {
                const wallet = AppStorage.get('wechat_wallet', { balance: 0, transactions: [] });

                // æ›´æ–°ä½™é¢æ˜¾ç¤º
                document.getElementById('wallet-balance').textContent = `Â¥${wallet.balance.toFixed(2)}`;

                // æ›´æ–°äº¤æ˜“è®°å½•
                const transactionList = document.getElementById('transaction-list');
                if (wallet.transactions.length === 0) {
                    transactionList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">æš‚æ— äº¤æ˜“è®°å½•</div>';
                    return;
                }

                // æŒ‰æ—¶é—´å€’åºæ’åˆ—
                const sortedTransactions = [...wallet.transactions].sort((a, b) => b.timestamp - a.timestamp);

                // åˆ¤æ–­æ˜¯å¦ä¸ºæ”¶å…¥ç±»å‹ï¼ˆincome æˆ– rechargeï¼‰
                const isIncomeType = (type) => type === 'income' || type === 'recharge';

                transactionList.innerHTML = sortedTransactions.map(t => `
                    <div class="bg-[#191919] rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg ${isIncomeType(t.type) ? 'bg-green-500' : 'bg-red-500'} flex items-center justify-center text-white">
                                    <i class="fa-solid ${isIncomeType(t.type) ? 'fa-plus' : 'fa-minus'} text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-medium">${t.type === 'recharge' ? 'å……å€¼' : t.type === 'income' ? 'æ”¶å…¥' : t.type === 'send' ? 'è½¬è´¦' : 'æ”¯å‡º'}</div>
                                    <div class="text-xs text-gray-400">${new Date(t.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="text-lg font-bold ${isIncomeType(t.type) ? 'text-green-500' : 'text-red-500'}">
                                ${isIncomeType(t.type) ? '+' : '-'}Â¥${Math.abs(t.amount).toFixed(2)}</div>
                        </div>
                        ${t.description ? `<div class="text-xs text-gray-500 mt-2">${t.description}</div>` : ''}
                    </div>
                `).join('');
            },

            renderFavorites: () => {
                const favs = AppStorage.get('wechat_favorites', []);
                const container = document.getElementById('favorites-list-container');
                if (!container) return;

                if (favs.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <i class="fa-regular fa-star text-4xl mb-4 opacity-20"></i>
                        <p class="text-sm">æš‚æ— æ”¶è—</p>
                    </div>`;
                    return;
                }

                container.innerHTML = favs.map(f => {
                    let contentHtml = '';
                    const content = f.content || '';

                    // 1. å¢å¼ºå›¾ç‰‡æ£€æµ‹ï¼šæ”¯æŒ raw url, [å›¾ç‰‡: url], ä»¥åŠ type='image'
                    const imgMatch = typeof content === 'string' ? content.match(/\[å›¾ç‰‡[:ï¼š]\s*(https?:\/\/[^\]\s]+)\]/i) : null;
                    const isImg = f.type === 'image' || imgMatch;

                    // 2. æ£€æµ‹ JSON å¡ç‰‡
                    let jsonObj = null;
                    if (typeof content === 'string' && content.trim().startsWith('{')) {
                        try { jsonObj = JSON.parse(content); } catch (e) { }
                    }

                    if (isImg) {
                        const imgUrl = imgMatch ? imgMatch[1] : content;
                        contentHtml = `<div class="w-16 h-16 bg-gray-100 rounded overflow-hidden flex-shrink-0 border border-gray-100">
                            <img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=IMG_ERROR'">
                        </div>
                        <div class="flex-1 min-w-0 pr-2">
                             <div class="text-[10px] text-gray-400 mb-1">å›¾ç‰‡å†…å®¹</div>
                             <div class="text-[11px] text-gray-400 truncate opacity-60">${imgUrl}</div>
                        </div>`;
                    } else if (jsonObj) {
                        // æ™ºèƒ½è§£ææœ‹å‹åœˆåˆ†äº«å¡ç‰‡æˆ–å…¶ä»– JSON æ•°æ®
                        const title = jsonObj.text || jsonObj.content || jsonObj.title || jsonObj.inner_voice || 'åˆ†äº«å†…å®¹';
                        const author = jsonObj.author || f.charName || 'ä½šå';
                        contentHtml = `<div class="flex-1 min-w-0">
                            <div class="text-[10px] text-blue-500 mb-1"><i class="fa-solid fa-link mr-1"></i>å¡ç‰‡æ¶ˆæ¯</div>
                            <div class="text-[13px] text-gray-700 font-medium line-clamp-2 leading-relaxed">${title}</div>
                            <div class="text-[10px] text-gray-400 mt-1">@${author} çš„åŠ¨æ€ / åˆ†äº«</div>
                        </div>`;
                    } else if (f.type === 'inner_voice_card' || (typeof content === 'string' && content.includes('voice-grid'))) {
                        // å¿ƒå£°å¡ç‰‡é¢„è§ˆï¼ˆè¿‡æ»¤ HTMLï¼‰
                        const textOnly = content.replace(/<[^>]+>/g, '').trim();
                        contentHtml = `<div class="flex-1 min-w-0">
                            <div class="text-[10px] text-pink-500 mb-1"><i class="fa-solid fa-heart mr-1"></i>å†…å¿ƒç‹¬ç™½</div>
                            <div class="text-[13px] text-gray-700 font-medium line-clamp-2 leading-relaxed">${textOnly.substring(0, 100)}${textOnly.length > 100 ? '...' : ''}</div>
                        </div>`;
                    } else {
                        // æ™®é€šæ–‡æœ¬
                        contentHtml = `<div class="flex-1 min-w-0">
                            <div class="text-[13px] text-gray-700 line-clamp-3 leading-relaxed break-all">${content}</div>
                        </div>`;
                    }

                    return `
                    <div onclick="WeChatUI.openFavoriteDetail(${f.favId})" class="bg-white rounded-lg p-3 mb-3 flex gap-3 shadow-sm active:bg-gray-50 transition-colors border border-gray-100 cursor-pointer">
                        ${contentHtml}
                        <div class="flex flex-col justify-between items-end gap-2 border-l border-gray-100 pl-3 min-w-[85px]">
                            <div class="flex items-center gap-1.5">
                                <span class="text-[10px] text-gray-600 font-medium truncate max-w-[55px]">${f.charName}</span>
                                <img src="${f.charAvatar || WeChatUI.getRandomAvatar()}" class="w-4 h-4 rounded-full border border-gray-100 object-cover">
                            </div>
                            <div class="text-[9px] text-gray-400 whitespace-nowrap">${new Date(f.favTime).toLocaleDateString()}</div>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            openFavoriteDetail: (favId) => {
                const favs = AppStorage.get('wechat_favorites', []);
                const fav = favs.find(f => f.favId === favId);
                if (!fav) return;

                WeChatUI.currentFavId = favId;
                const body = document.getElementById('favorite-detail-body');
                const content = fav.content || '';

                // æ¸²æŸ“å†…å®¹é€»è¾‘
                let detailHtml = '';
                const imgMatch = typeof content === 'string' ? content.match(/\[å›¾ç‰‡[:ï¼š]\s*(https?:\/\/[^\]\s]+)\]/i) : null;
                const isImg = fav.type === 'image' || imgMatch;

                if (isImg) {
                    const imgUrl = imgMatch ? imgMatch[1] : content;
                    detailHtml = `<div class="flex flex-col items-center gap-4">
                        <img src="${imgUrl}" class="w-full rounded-lg shadow-lg" onclick="window.open('${imgUrl}')">
                        <p class="text-[10px] text-gray-400">ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹åŸå›¾</p>
                    </div>`;
                } else if (typeof content === 'string' && content.trim().startsWith('{')) {
                    // å¤„ç† JSON å¡ç‰‡è¯¦æƒ…
                    try {
                        const jsonObj = JSON.parse(content);
                        const text = jsonObj.text || jsonObj.content || jsonObj.inner_voice || content;
                        detailHtml = `<div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <div class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">${text}</div>
                            ${jsonObj.image ? `<img src="${jsonObj.image}" class="mt-4 w-full rounded-md shadow-sm">` : ''}
                        </div>`;
                    } catch (e) {
                        detailHtml = `<div class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">${content}</div>`;
                    }
                } else {
                    // æ™®é€šæ–‡æœ¬
                    detailHtml = `<div class="text-[15px] text-gray-800 leading-loose whitespace-pre-wrap">${content}</div>`;
                }

                body.innerHTML = detailHtml;
                document.getElementById('fav-detail-source').innerText = `æ¥è‡ªï¼š${fav.charName}`;
                document.getElementById('fav-detail-time').innerText = `æ”¶è—äºï¼š${new Date(fav.favTime).toLocaleString()}`;

                WeChatUI.openSubPage('subpage-favorite-detail');
            },

            deleteCurrentFavorite: () => {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ”¶è—å—ï¼Ÿ')) return;

                let favs = AppStorage.get('wechat_favorites', []);
                favs = favs.filter(f => f.favId !== WeChatUI.currentFavId);
                AppStorage.set('wechat_favorites', favs);

                Utils.showToast('å·²åˆ é™¤');
                WeChatUI.openSubPage('subpage-favorites');
                WeChatUI.renderFavorites(); // åˆ·æ–°åˆ—è¡¨
            },

            openSubPage: (id) => {
                // éšè—æ‰€æœ‰å…¶ä»–å­é¡µé¢
                document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
                // æ˜¾ç¤ºå½“å‰å­é¡µé¢
                const target = document.getElementById(id);
                if (target) {
                    target.classList.add('active');
                    // å¦‚æœæ˜¯æ‰“å¼€æ”¶è—é¡µé¢ï¼Œæ¸²æŸ“æ”¶è—åˆ—è¡¨
                    if (id === 'subpage-favorites') {
                        WeChatUI.renderFavorites();
                    }
                }

                // å¦‚æœæ˜¯æ‰“å¼€æœ‹å‹åœˆé¡µé¢
                if (id === 'subpage-moments') {
                    // WeChatUI.renderMoments(); // å¦‚æœéœ€è¦ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨
                }
            },
















            // å¤„ç†åŒæ„å¥½å‹ç”³è¯·
            acceptFriendRequest: (charId, npcId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return;

                // è·å–å½“å‰ç”¨æˆ·åç§°
                const userProfile = AppStorage.get('wechat_user_profile', {});
                const userName = userProfile.name || 'æˆ‘';

                // æ·»åŠ åŒæ„æ¶ˆæ¯ï¼ˆä»¥ç”¨æˆ·èº«ä»½å‘é€ï¼‰
                const agreeMsg = {
                    role: 'user',
                    content: `${userName} åŒæ„äº†æ‚¨çš„å¥½å‹ç”³è¯·`,
                    timestamp: Date.now()
                };
                if (!char.msgs) char.msgs = [];
                char.msgs.push(agreeMsg);

                // ä¿å­˜åˆ°å­˜å‚¨
                AppStorage.set('wechat_chars', chars);

                // é‡æ–°åŠ è½½èŠå¤©
                WeChatUI.loadChat(charId, npcId);

                // è°ƒç”¨AIæ¨¡å‹å›å¤
                const apiMessages = [{ role: 'system', content: char.prompt || '' }, ...char.msgs.filter(m => m.role !== 'system')];
                SettingsLogic.generateLLM(apiMessages, charId).then(reply => {
                    WeChatUI.handleAIReply(reply, charId);
                });
            },

            // å¤„ç†æ‹’ç»å¥½å‹ç”³è¯·
            rejectFriendRequest: (charId, npcId) => {
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[charId];
                if (!char) return;

                // æ·»åŠ æ‹’ç»æ¶ˆæ¯ï¼ˆä»¥ç”¨æˆ·èº«ä»½å‘é€ï¼‰
                const rejectMsg = {
                    role: 'user',
                    content: 'å¯¹æ–¹æ‹’ç»äº†æ‚¨çš„å¥½å‹ç”³è¯·',
                    timestamp: Date.now()
                };
                if (!char.msgs) char.msgs = [];
                char.msgs.push(rejectMsg);

                // ä¿å­˜åˆ°å­˜å‚¨
                AppStorage.set('wechat_chars', chars);

                // é‡æ–°åŠ è½½èŠå¤©
                WeChatUI.loadChat(charId, npcId);

                // è°ƒç”¨AIæ¨¡å‹å›å¤
                const apiMessages = [{ role: 'system', content: char.prompt || '' }, ...char.msgs.filter(m => m.role !== 'system')];
                SettingsLogic.generateLLM(apiMessages, charId).then(reply => {
                    WeChatUI.handleAIReply(reply, charId);
                });
            },






            sendSystemNotification: (message) => {
                WeChatUI.showGlobalNotification('ç³»ç»Ÿ', message, '');
            },
            updateWalletBalance: (type, amount, description) => {
                // 1. å®‰å…¨è¯»å–é’±åŒ…æ•°æ®ï¼Œå¦‚æœä¸ºç©ºåˆ™åˆå§‹åŒ–
                let wallet = AppStorage.get('wechat_wallet', null);
                if (!wallet) {
                    wallet = { balance: 0.00, transactions: [] };
                }

                // ç¡®ä¿ amount æ˜¯æ•°å­—
                const numAmount = parseFloat(amount);
                if (isNaN(numAmount)) return;

                // 2. æ›´æ–°ä½™é¢
                if (type === 'income') {
                    wallet.balance += numAmount;
                } else if (type === 'expense') {
                    wallet.balance -= numAmount;
                }

                // 3. æ·»åŠ äº¤æ˜“è®°å½•
                if (!wallet.transactions) wallet.transactions = [];
                wallet.transactions.push({
                    id: Date.now(),
                    type: type,
                    amount: numAmount,
                    description: description,
                    timestamp: Date.now()
                });

                // 4. ä¿å­˜
                AppStorage.set('wechat_wallet', wallet);

                // 5. å¦‚æœå½“å‰å¼€ç€é’±åŒ…é¡µé¢ï¼Œå®æ—¶åˆ·æ–°
                if (document.getElementById('subpage-wallet').classList.contains('active')) {
                    WeChatUI.loadWalletData();
                }
            },


            // æ‰“å¼€å……å€¼æ¨¡æ€æ¡†
            openRechargeModal: () => {
                const modal = document.getElementById('modal-recharge');
                modal.classList.remove('hidden');
            },

            // ç¡®è®¤å……å€¼
            confirmRecharge: () => {
                const amountInput = document.getElementById('recharge-amount');
                const amount = parseFloat(amountInput.value);

                if (isNaN(amount) || amount <= 0) {
                    Utils.showToast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
                    return;
                }

                // æ›´æ–°é’±åŒ…ä½™é¢
                WeChatUI.updateWalletBalance('income', amount, 'å……å€¼');

                // å…³é—­æ¨¡æ€æ¡†
                document.getElementById('modal-recharge').classList.add('hidden');

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                Utils.showToast(`å……å€¼æˆåŠŸï¼šÂ¥${amount.toFixed(2)}`);

                // é‡ç½®è¾“å…¥æ¡†
                amountInput.value = '100';
            },

            // ã€æ–°å¢ã€‘å¯¼å‡ºèŠå¤©è®°å½•
            exportChatHistory: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) {
                    Utils.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }

                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];
                if (!char || !char.msgs) {
                    Utils.showToast('æš‚æ— èŠå¤©è®°å½•');
                    return;
                }

                // æ ¼å¼åŒ–æ¶ˆæ¯
                let exportText = `ã€èŠå¤©è®°å½•ã€‘${char.name}\n`;
                exportText += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n`;
                exportText += `æ¶ˆæ¯æ•°é‡ï¼š${char.msgs.length} æ¡\n`;
                exportText += `\n${'='.repeat(50)}\n\n`;

                char.msgs.forEach((m, idx) => {
                    const time = new Date(m.timestamp || Date.now()).toLocaleString();
                    const sender = m.role === 'user' ? 'æˆ‘' : char.name;

                    let content = '';
                    if (m.type === 'text' || !m.type) {
                        content = m.content;
                    } else if (m.type === 'image') {
                        content = '[å›¾ç‰‡]';
                    } else if (m.type === 'voice') {
                        content = `[è¯­éŸ³ ${m.duration || 0}ç§’]`;
                    } else if (m.type === 'redpacket') {
                        const status = m.status === 'received' ? 'å·²é¢†å–' : (m.status === 'rejected' ? 'å·²é€€è¿˜' : 'æœªé¢†å–');
                        content = `[çº¢åŒ…] ${m.note} (${status})`;
                    } else if (m.type === 'transfer') {
                        const status = m.status === 'received' ? 'å·²æ”¶æ¬¾' : (m.status === 'rejected' ? 'å·²é€€è¿˜' : 'æœªæ”¶æ¬¾');
                        content = `[è½¬è´¦] Â¥${m.amount} - ${m.note} (${status})`;
                    } else if (m.type === 'system') {
                        content = `[ç³»ç»Ÿ] ${m.content}`;
                    } else {
                        content = `[${m.type}]`;
                    }

                    exportText += `[${idx + 1}] ${time}\n`;
                    exportText += `${sender}: ${content}\n\n`;
                });

                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `èŠå¤©è®°å½•-${char.name}-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                Utils.showToast('å¯¼å‡ºæˆåŠŸï¼');
            },

            // ã€æ–°å¢ã€‘æ‰“å¼€èŠå¤©æœç´¢é¡µé¢
            openChatSearch: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) {
                    Utils.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                    return;
                }

                // åˆ›å»ºæœç´¢é¡µé¢ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (!document.getElementById('subpage-chat-search')) {
                    const searchPage = document.createElement('div');
                    searchPage.id = 'subpage-chat-search';
                    searchPage.className = 'sub-view bg-white';
                    searchPage.innerHTML = `
                        <div class="app-header justify-between bg-white border-b border-gray-200">
                            <div class="flex items-center gap-2">
                                <button onclick="WeChatUI.closeSubPage('subpage-chat-search')" class="w-10 h-full"><i class="fa-solid fa-chevron-left"></i></button>
                                <span class="font-semibold text-gray-800">æŸ¥æ‰¾èŠå¤©è®°å½•</span>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <input type="text" id="chat-search-input" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                   oninput="WeChatUI.performChatSearch()">
                        </div>
                        <div id="chat-search-results" class="overflow-y-auto" style="height: calc(100% - 120px);"></div>
                    `;
                    document.getElementById('app-wechat').appendChild(searchPage);
                }

                // æ‰“å¼€é¡µé¢
                WeChatUI.openSubPage('subpage-chat-search');

                // æ¸…ç©ºæœç´¢
                document.getElementById('chat-search-input').value = '';
                document.getElementById('chat-search-results').innerHTML = '<div class="text-center text-gray-400 py-8">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
            },

            // ã€æ–°å¢ã€‘æ‰§è¡ŒèŠå¤©æœç´¢
            performChatSearch: () => {
                const query = document.getElementById('chat-search-input').value.trim();
                const resultsDiv = document.getElementById('chat-search-results');

                if (!query) {
                    resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
                    return;
                }

                const cid = WeChatUI.currentChatId;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];

                if (!char || !char.msgs) {
                    resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— èŠå¤©è®°å½•</div>';
                    return;
                }

                // æœç´¢æ¶ˆæ¯
                const results = char.msgs.filter((m, idx) => {
                    if (m.type === 'text' || !m.type) {
                        return m.content.includes(query);
                    } else if (m.type === 'redpacket') {
                        return m.note && m.note.includes(query);
                    } else if (m.type === 'transfer') {
                        return (m.note && m.note.includes(query)) || m.amount.toString().includes(query);
                    }
                    return false;
                }).map((m, idx) => ({ ...m, originalIndex: char.msgs.indexOf(m) }));

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                    return;
                }

                // æ¸²æŸ“ç»“æœ
                resultsDiv.innerHTML = results.map(m => {
                    const time = new Date(m.timestamp || Date.now()).toLocaleString();
                    const sender = m.role === 'user' ? 'æˆ‘' : char.name;
                    let content = '';

                    if (m.type === 'text' || !m.type) {
                        content = m.content.substring(0, 100);
                    } else if (m.type === 'redpacket') {
                        content = `[çº¢åŒ…] ${m.note}`;
                    } else if (m.type === 'transfer') {
                        content = `[è½¬è´¦] Â¥${m.amount} - ${m.note}`;
                    }

                    // é«˜äº®æ˜¾ç¤ºæœç´¢è¯
                    content = content.replace(new RegExp(query, 'g'), `<span class="bg-yellow-200">${query}</span>`);

                    return `
                        <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" 
                             onclick="WeChatUI.jumpToMessage(${m.originalIndex})">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm text-gray-800">${sender}</span>
                                <span class="text-xs text-gray-400">${time}</span>
                            </div>
                            <div class="text-sm text-gray-600">${content}</div>
                        </div>
                    `;
                }).join('');

                resultsDiv.innerHTML += `<div class="text-center text-gray-400 py-4 text-xs">å…±æ‰¾åˆ° ${results.length} æ¡ç»“æœ</div>`;
            },

            // ã€æ–°å¢ã€‘è·³è½¬åˆ°æŒ‡å®šæ¶ˆæ¯
            jumpToMessage: (msgIndex) => {
                // å…³é—­æœç´¢é¡µé¢
                WeChatUI.closeSubPage('subpage-chat-search');

                // ç¡®ä¿æ¶ˆæ¯è¢«åŠ è½½
                const cid = WeChatUI.currentChatId;
                const chars = AppStorage.get('wechat_chars', {});
                const char = chars[cid];

                if (char && char.msgs) {
                    // ç¡®ä¿è¦è·³è½¬çš„æ¶ˆæ¯è¢«åŠ è½½
                    WeChatUI.currentLoadedMsgs[cid] = Math.max(WeChatUI.currentLoadedMsgs[cid] || 50, msgIndex + 10);

                    // é‡æ–°åŠ è½½èŠå¤©
                    WeChatUI.loadChat(cid);

                    // ç­‰å¾…æ¸²æŸ“å®Œæˆåæ»šåŠ¨å¹¶é«˜äº®
                    setTimeout(() => {
                        const container = document.getElementById('chat-messages-container');
                        const msgElements = container.querySelectorAll('.msg-row');

                        if (msgElements[msgIndex]) {
                            msgElements[msgIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                            msgElements[msgIndex].style.background = '#fef9c3';

                            setTimeout(() => {
                                msgElements[msgIndex].style.transition = 'background 1s';
                                msgElements[msgIndex].style.background = '';
                            }, 1000);
                        }
                    }, 300);
                }
            },




        }; // <--- WeChatUI å¯¹è±¡çš„å®Œç¾å¥å·


        // Enter key
        // Enter key
        document.getElementById('chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); WeChatUI.sendUserMessage(false); } });

        // Init
        WeChatUI.checkInit();
        SettingsUI.init();
        WeChatUI.initLongPress(); // åˆå§‹åŒ–é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
        WeChatUI.renderList();

        // å…¨å±€ç›‘å¬ï¼šåªè¦ä½ ç‚¹äº†é¡µé¢ï¼Œå°±æ›´æ–°æœ€åäº’åŠ¨æ—¶é—´
        // æ³¨é‡Šæ‰è¿™ä¸¤è¡Œï¼Œé¿å…é¢‘ç¹æ›´æ–°æœ€åäº’åŠ¨æ—¶é—´
        // document.addEventListener('click', () => localStorage.setItem('last_interaction_time', Date.now()));
        // document.addEventListener('keydown', () => localStorage.setItem('last_interaction_time', Date.now()));

        // åˆå§‹åŒ–å¯åŠ¨æŸ¥å²—
        setTimeout(() => {
            if (WeChatUI.startActiveChatCheck) WeChatUI.startActiveChatCheck();
        }, 2000);

        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ï¼Œå½“é¡µé¢ä¸å¯è§æ—¶åœæ­¢æœ—è¯»
        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢ä¸å¯è§
                window.speechSynthesis.cancel();
                WeChatUI.isSpeaking = false;
                WeChatUI.ttsQueue = [];
                // è®°å½•è¿›å…¥åå°çš„æ—¶é—´
                WeChatUI.lastBackgroundTime = Date.now();
            } else {
                // é¡µé¢å¯è§ (ä»åå°è¿”å›)
                console.log('[System] App returned to foreground');

                // 1. ä¿®å¤â€œæŸ¥å²—â€é€»è¾‘ (ä¼˜å…ˆæ‰§è¡Œï¼Œé˜²æ­¢è¢«é˜»æ–­)
                try {
                    const lastTime = WeChatUI.lastBackgroundTime || Date.now();
                    const minutesGone = (Date.now() - lastTime) / 1000 / 60;

                    // è·å–å½“å‰æ¿€æ´»çš„è§’è‰²
                    const chatDetail = document.getElementById('subpage-chat-detail');
                    const isChatOpen = chatDetail && chatDetail.classList.contains('active'); // ç¡®ä¿åœ¨èŠå¤©é¡µé¢
                    const cid = chatDetail ? chatDetail.dataset.charId : null;

                    if (isChatOpen && cid) {
                        // è·å–æŸ¥å²—è®¾ç½®
                        const activeSwitch = document.getElementById('char-active-chat-switch');
                        const activeIntervalVal = document.getElementById('char-active-interval');
                        // å¿…é¡»ç¡®ä¿å¼€å…³å­˜åœ¨ä¸”å¼€å¯
                        const activeInterval = (activeSwitch && activeSwitch.checked) ? parseInt(activeIntervalVal.value || 0) : 0;

                        // åªæœ‰å½“å¼€äº†å¼€å…³ ä¸” ç¦»å¼€æ—¶é—´è¶³å¤Ÿé•¿ æ—¶æ‰è§¦å‘
                        if (activeInterval > 0 && minutesGone >= activeInterval) {
                            console.log(`[æŸ¥å²—] è§¦å‘æ£€æŸ¥: ç¦»å¼€${minutesGone.toFixed(1)}åˆ†é’Ÿ >= é˜ˆå€¼${activeInterval}åˆ†é’Ÿ`);

                            // ã€ä¿®å¤ã€‘è·å– char å¯¹è±¡å¹¶è°ƒç”¨æ­£ç¡®çš„ triggerActiveMessage
                            const chars = AppStorage.get('wechat_chars', {});
                            const char = chars[cid];
                            if (char && WeChatUI.triggerActiveMessage) {
                                // ä¼ å…¥ char, æ²‰é»˜æ—¶é—´(æ¯«ç§’), isHidden=true
                                WeChatUI.triggerActiveMessage(char, minutesGone * 60 * 1000, true);
                            }
                        }
                    }
                } catch (e) {
                    console.error('[æŸ¥å²—] é€»è¾‘æ‰§è¡Œå‡ºé”™:', e);
                }

                // 2. è‡ªåŠ¨ç”Ÿæˆæœ‹å‹åœˆ (åŠ ä¸Šå¼€å…³æ£€æŸ¥ï¼Œä¿®è¡¥ä¹±ç”Ÿæˆé—®é¢˜)
                try {
                    const settings = AppStorage.get('wechat_moments_settings', {});
                    // æ£€æŸ¥é…ç½®å¼€å…³ (config.autoMoments equivalent)
                    if (settings.privacy && settings.privacy.aiPost === true) {
                        // å³ä½¿å¼€å¯ï¼Œä¹Ÿå»ºè®®åˆ¤æ–­æ—¶é—´é—´éš”ï¼Œè¿™é‡Œæš‚æ—¶æ³¨é‡Šæ‰æ— æ¡ä»¶æ‰§è¡Œï¼Œé¿å…åˆ·å±
                        // WeChatUI.generateMoments(); 
                    }
                } catch (e) {
                    console.error('[æœ‹å‹åœˆ] è‡ªåŠ¨ç”Ÿæˆå‡ºé”™:', e);
                }
            }
        });

        // --- æ–°å¢ï¼šåŸç”Ÿæµè§ˆå™¨å†å²è®°å½•æ”¯æŒ (æŒ‰æ‰‹æœºè¿”å›é”®å…³é—­é¡µé¢) ---
        window.addEventListener('popstate', (e) => {
            try {
                // 1. æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¼€çš„å­é¡µé¢ (Sub Views)
                const activeSubViews = document.querySelectorAll('.sub-view.active');
                if (activeSubViews.length > 0) {
                    // å…³é—­æœ€é¡¶å±‚çš„å­é¡µé¢
                    const topView = activeSubViews[activeSubViews.length - 1];
                    topView.classList.remove('active');
                    return; // å¤„ç†å®Œæ¯•ï¼Œä¸­æ–­
                }

                // 2. æ£€æŸ¥æ˜¯å¦æœ‰æ‰“å¼€çš„ App (App Windows)
                const activeApps = document.querySelectorAll('.app-window.active');
                if (activeApps.length > 0) {
                    // å¦‚æœçŠ¶æ€æ˜¯ null (å›åˆ°æ¡Œé¢) æˆ–è€…æˆ‘ä»¬æ‰‹åŠ¨è§¦å‘çš„ back
                    activeApps.forEach(app => app.classList.remove('active'));
                }
            } catch (error) {
                console.error('popstateäº‹ä»¶å¤„ç†å‡ºé”™:', error);
            }
        });
        // ==========================================
        // ã€ä¿®å¤è¡¥ä¸ã€‘ç¼–è¾‘æ¶ˆæ¯åŠŸèƒ½çš„é€»è¾‘ä»£ç 
        // ==========================================

        // 1. å¼ºè¡Œè¦†ç›–ï¼šæ‰“å¼€ç¼–è¾‘å™¨çš„å‡½æ•°
        WeChatUI.ctxEdit = function () {
            console.log('[Debug] ç‚¹å‡»äº†ç¼–è¾‘ï¼Œç›®æ ‡æ¶ˆæ¯ID:', WeChatUI.ctxTargetMsgId);

            // 1. å…³é—­å³é”®èœå•
            WeChatUI.hideContextMenu();

            // 2. è·å–å½“å‰èŠå¤©ä¿¡æ¯
            const chatDetail = document.getElementById('subpage-chat-detail');
            const cid = chatDetail ? chatDetail.dataset.charId : null;
            if (!cid) return console.error('æ‰¾ä¸åˆ°å½“å‰è§’è‰²ID');

            const chars = AppStorage.get('wechat_chars', {});
            // æŸ¥æ‰¾ç›®æ ‡æ¶ˆæ¯
            const msg = chars[cid] && chars[cid].msgs ? chars[cid].msgs.find(m => m.id === WeChatUI.ctxTargetMsgId) : null;

            // 3. è·å–å¼¹çª—å…ƒç´ 
            const modal = document.getElementById('modal-edit-msg');
            const list = document.getElementById('edit-msg-list');

            if (modal && list) {
                // æ¸…ç©ºæ—§å†…å®¹
                list.innerHTML = '';
                // æ·»åŠ ä¸€ä¸ªç¼–è¾‘å—ï¼ˆæŠŠåŸæ¥çš„æ¶ˆæ¯å¡«è¿›å»ï¼‰
                WeChatUI.addEditBlock(msg);

                // 4. æ˜¾ç¤ºå¼¹çª— (ç§»é™¤ hidden ç±»ï¼Œå¼ºåˆ¶ display: flex)
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            } else {
                alert('é”™è¯¯ï¼šè¿˜æ²¡æœ‰å®Œæˆç¬¬ä¸€æ­¥ï¼è¯·å…ˆå¤åˆ¶ç²˜è´´ç¬¬ä¸€æ­¥çš„ HTML ä»£ç ã€‚');
            }
        };

        // 2. å¼ºè¡Œè¦†ç›–ï¼šæ·»åŠ ç¼–è¾‘å—çš„å‡½æ•°
        WeChatUI.addEditBlock = function (data = null) {
            const container = document.getElementById('edit-msg-list');
            if (!container) return;

            const div = document.createElement('div');
            div.className = "bg-gray-50 p-3 rounded-xl border border-gray-200 relative group shadow-sm transition-all mb-2";

            // è®¾ç½®é»˜è®¤å€¼
            const role = data ? data.role : 'user';
            const type = data ? data.type : 'text';
            let content = '';

            if (data) {
                if (type === 'voice') content = data.text || '';
                else if (type === 'image') content = data.originalContent || data.content || '';
                else if (type === 'redpacket' || type === 'transfer') content = data.note || '';
                else content = data.content || '';
            }

            // ç”Ÿæˆç¼–è¾‘å—çš„ HTML
            div.innerHTML = `
            <div style="position:absolute; top:5px; right:5px;">
                <button onclick="if(document.getElementById('edit-msg-list').children.length > 1) this.closest('div').parentElement.remove();" 
                    class="text-gray-400 hover:text-red-500 w-6 h-6 flex items-center justify-center">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <div class="flex gap-2 mb-2 pr-8">
                <select class="edit-block-role setting-input mb-0 text-xs py-1 h-8 w-20 bg-white border-gray-200">
                    <option value="user" ${role === 'user' ? 'selected' : ''}>æˆ‘</option>
                    <option value="ai" ${role === 'ai' ? 'selected' : ''}>AI</option>
                    <option value="system" ${role === 'system' ? 'selected' : ''}>ç³»ç»Ÿ</option>
                </select>
                <select class="edit-block-type setting-input mb-0 text-xs py-1 h-8 flex-1 bg-white border-gray-200">
                    <option value="text" ${type === 'text' ? 'selected' : ''}>æ–‡æœ¬</option>
                    <option value="html" ${type === 'html' ? 'selected' : ''}>HTMLå¡ç‰‡</option>
                    <option value="image" ${type === 'image' || type === 'emoji' ? 'selected' : ''}>å›¾ç‰‡/è¡¨æƒ…åŒ…</option>
                    <option value="voice" ${type === 'voice' ? 'selected' : ''}>è¯­éŸ³æ¡</option>
                    <option value="redpacket" ${type === 'redpacket' ? 'selected' : ''}>çº¢åŒ…</option>
                    <option value="transfer" ${type === 'transfer' ? 'selected' : ''}>è½¬è´¦</option>
                </select>
            </div>
            
            <textarea class="edit-block-content w-full bg-white border border-gray-200 rounded-lg p-3 text-sm min-h-[80px] outline-none" 
                placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹...">${content.replace(/</g, '&lt;')}</textarea>
        `;

            container.appendChild(div);
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        };

        // ç»Ÿä¸€é¡µé¢ç®¡ç†
        // ç¡®ä¿HistoryManageråªè¢«å£°æ˜ä¸€æ¬¡
        window.HistoryManager = {
            push: (id) => {
                history.pushState({ level: 'subview', id: id }, '', '');
            },
            back: () => {
                history.back();
            }
        };
    </script>

    <!-- Weibo App -->
    <div id="app-weibo" class="app-window text-gray-800">
        <!-- Header -->
        <div class="app-header bg-white/95 border-b border-gray-200 sticky top-0 z-50">
            <button onclick="closeApp()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-red-100 text-red-600"><i
                    class="fa-solid fa-xmark"></i></button>
            <div class="font-bold text-lg tracking-wide text-gray-800">å¾®åš</div>
            <div class="w-8"></div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-hidden relative">
            <!-- Discovery Page -->
            <div id="weibo-discovery" class="w-full overflow-y-auto"
                style="height: calc(100% - 50px); background-color: #f5f5f5;">
                <!-- Top Navigation -->
                <div class="flex justify-center bg-white border-b border-gray-200 sticky top-0 z-40">
                    <button onclick="WeiboUI.switchTab('discovery', 'following')" id="btn-tab-following"
                        class="weibo-discovery-tab active px-8 py-4 flex items-center justify-center">
                        <span>å…³æ³¨</span>
                        <div class="weibo-tab-indicator"></div>
                    </button>
                    <button onclick="WeiboUI.switchTab('discovery', 'recommend')" id="btn-tab-recommend"
                        class="weibo-discovery-tab px-8 py-4 flex items-center justify-center">
                        <span>æ¨è</span>
                        <div class="weibo-tab-indicator"></div>
                    </button>
                </div>

                <!-- Right Top Buttons -->
                <div class="weibo-discovery-buttons fixed top-14 right-4 z-50 flex gap-3">
                    <button onclick="WeiboUI.generateContent()"
                        class="w-10 h-10 rounded-full bg-white shadow-lg flex items-center justify-center text-red-500 hover:bg-red-50 transition-all">
                        <i class="fa-solid fa-magic"></i>
                    </button>
                    <button onclick="WeiboUI.openPublishModal()"
                        class="w-10 h-10 rounded-full bg-white shadow-lg flex items-center justify-center text-red-500 hover:bg-red-50 transition-all">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>

                <!-- Content Area -->
                <div id="weibo-following-content" class="weibo-content-area px-4 pt-20">
                    <!-- Following content will be generated here -->
                </div>
                <div id="weibo-recommend-content" class="weibo-content-area px-4 pt-20 hidden">
                    <!-- Recommend content will be generated here -->
                </div>
            </div>

            <!-- Hot Search Page -->
            <div id="weibo-hotsearch" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: #f5f5f5;">
                <!-- Search Box -->
                <div class="weibo-hotsearch-header p-4 bg-white border-b border-gray-200 sticky top-0 z-40">
                    <div class="weibo-search-box mx-auto max-w-xs bg-gray-100 rounded-full flex items-center px-4 py-2">
                        <i class="fa-solid fa-search text-gray-400 mr-2"></i>
                        <input type="text" id="hotsearch-input" placeholder="æœç´¢çƒ­æœ/ç”¨æˆ·å"
                            class="bg-transparent border-none outline-none flex-1 text-sm">
                        <button onclick="WeiboUI.searchHotsearch()"
                            class="text-gray-600 font-medium text-sm">æœç´¢</button>
                    </div>
                </div>

                <!-- Hot Search List -->
                <div class="weibo-hotsearch-list p-4">
                    <div class="weibo-hotsearch-title font-bold text-lg mb-4">å®æ—¶çƒ­æœ</div>
                    <div id="hotsearch-list-content">
                        <!-- Hot search list will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Private Message Page -->
            <div id="weibo-message" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: #f5f5f5;">
                <div
                    class="weibo-message-header p-4 bg-white border-b border-gray-200 sticky top-0 z-40 font-bold text-lg">
                    ç§ä¿¡</div>
                <div id="message-list" class="p-4">
                    <!-- Message list will be generated here -->
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="weibo-chat" class="w-full overflow-hidden hidden flex flex-col"
                style="height: calc(100% - 50px); background-color: #f5f5f5;">
                <!-- Chat Header -->
                <div
                    class="weibo-chat-header p-4 bg-white border-b border-gray-200 sticky top-0 z-40 flex items-center">
                    <button onclick="WeiboUI.backToMessageList()"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 mr-3"><i
                            class="fa-solid fa-arrow-left"></i></button>
                    <div class="flex-1">
                        <div class="weibo-chat-username font-bold" id="chat-username"></div>
                    </div>
                    <div class="w-8"></div>
                </div>

                <!-- Chat Messages -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Chat messages will be generated here -->
                </div>

                <!-- Chat Input -->
                <div class="weibo-chat-input-container p-4 bg-white border-t border-gray-200 flex items-center gap-2">
                    <textarea id="weibo-chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..."
                        class="w-full border-none outline-none resize-none h-12 p-3 bg-gray-100 rounded-full text-sm"></textarea>
                    <button onclick="WeiboUI.generateChatReply()"
                        class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 transition-all"><i
                            class="fa-solid fa-magic"></i></button>
                    <button onclick="WeiboUI.sendChatMessage()"
                        class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center hover:bg-red-600 transition-all"><i
                            class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="weibo-profile" class="w-full overflow-y-auto hidden"
                style="height: calc(100% - 50px); background-color: #f5f5f5;">
                <!-- Profile Header -->
                <div class="weibo-profile-header bg-white p-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden">
                                <img id="profile-avatar" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <div id="profile-username" class="text-2xl font-bold">æˆ‘</div>
                                <div class="text-sm text-gray-400 mt-1">å¾®åšID: weibo_user</div>
                                <div id="profile-bio" class="text-sm text-gray-600 mt-2"></div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="WeiboUI.openProfileEditModal()"
                                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600"><i
                                    class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="WeiboUI.openSettingsModal()"
                                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600"><i
                                    class="fa-solid fa-gear"></i></button>
                        </div>
                    </div>

                    <!-- Profile Stats -->
                    <div class="weibo-profile-stats flex justify-around mt-6">
                        <div class="text-center">
                            <div id="profile-posts" class="text-lg font-bold">0</div>
                            <div class="text-xs text-gray-400">å¾®åš</div>
                        </div>
                        <div class="text-center">
                            <div id="profile-following" class="text-lg font-bold">0</div>
                            <div class="text-xs text-gray-400">å…³æ³¨</div>
                        </div>
                        <div class="text-center">
                            <div id="profile-followers" class="text-lg font-bold">0</div>
                            <div class="text-xs text-gray-400">ç²‰ä¸</div>
                        </div>
                    </div>
                </div>

                <!-- Profile Menu -->
                <div class="weibo-profile-menu bg-white mt-4 border-b border-gray-200">
                    <button onclick="WeiboUI.switchProfileTab('my-posts')" id="btn-profile-posts"
                        class="weibo-profile-tab active px-8 py-4 flex items-center justify-center">
                        <span>æˆ‘çš„å¾®åš</span>
                    </button>
                    <button onclick="WeiboUI.switchProfileTab('following')" id="btn-profile-following"
                        class="weibo-profile-tab px-8 py-4 flex items-center justify-center">
                        <span>å…³æ³¨åˆ—è¡¨</span>
                    </button>
                    <button onclick="WeiboUI.switchProfileTab('likes')" id="btn-profile-likes"
                        class="weibo-profile-tab px-8 py-4 flex items-center justify-center">
                        <span>ç‚¹èµè®°å½•</span>
                    </button>
                </div>

                <!-- Profile Content -->
                <div id="profile-my-posts" class="weibo-profile-content p-4">
                    <!-- My posts will be generated here -->
                </div>
                <div id="profile-following-container" class="weibo-profile-content p-4 hidden">
                    <!-- Following list will be generated here -->
                </div>
                <div id="profile-likes" class="weibo-profile-content p-4 hidden">
                    <!-- Likes list will be generated here -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="glass-bar h-14 flex w-full pb-2 pt-1 z-50 bg-white/95 border-t border-gray-200">
            <div onclick="WeiboUI.switchMainTab('discovery')" id="btn-main-discovery"
                class="weibo-main-tab active flex-1 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-compass text-xl"></i>
                <span class="text-xs">å‘ç°</span>
            </div>
            <div onclick="WeiboUI.switchMainTab('hotsearch')" id="btn-main-hotsearch"
                class="weibo-main-tab flex-1 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-fire text-xl"></i>
                <span class="text-xs">çƒ­æœ</span>
            </div>
            <div onclick="WeiboUI.switchMainTab('message')" id="btn-main-message"
                class="weibo-main-tab flex-1 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-envelope text-xl"></i>
                <span class="text-xs">ç§ä¿¡</span>
            </div>
            <div onclick="WeiboUI.switchMainTab('profile')" id="btn-main-profile"
                class="weibo-main-tab flex-1 flex flex-col items-center justify-center gap-1">
                <i class="fa-solid fa-user text-xl"></i>
                <span class="text-xs">æˆ‘</span>
            </div>
        </div>

        <!-- Publish Modal -->
        <div id="weibo-publish-modal" class="weibo-modal-overlay hidden">
            <div class="weibo-modal-content max-w-md mx-auto mt-20">
                <div class="weibo-modal-header flex justify-between items-center p-4 border-b border-gray-200">
                    <span class="font-bold">å‘å¸ƒå¾®åš</span>
                    <button onclick="WeiboUI.closePublishModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                <div class="weibo-modal-body p-4">
                    <textarea id="publish-content" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."
                        class="w-full border-none outline-none resize-none h-32 text-lg placeholder-gray-400"></textarea>

                    <!-- Image Preview -->
                    <div id="publish-image-preview" class="mt-3 grid grid-cols-3 gap-2"></div>

                    <!-- Toolbar -->
                    <div class="flex justify-between items-center mt-3">
                        <div class="flex gap-4">
                            <!-- Image Upload -->
                            <input type="file" id="publish-image-upload" accept="image/*" multiple class="hidden">
                            <button onclick="document.getElementById('publish-image-upload').click()"
                                class="text-gray-600 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-image text-xl"></i>
                            </button>

                            <!-- Emoji Picker -->
                            <button onclick="WeiboUI.toggleEmojiPicker()"
                                class="text-gray-600 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-face-smile text-xl"></i>
                            </button>

                            <!-- Location -->
                            <button onclick="WeiboUI.addLocation()"
                                class="text-gray-600 hover:text-red-500 transition-colors">
                                <i class="fa-solid fa-location-dot text-xl"></i>
                            </button>

                            <!-- AI Generate Content -->
                            <button onclick="WeiboUI.generatePostContent()"
                                class="bg-blue-500/20 border border-blue-500/30 text-blue-600 px-4 py-1 rounded-full text-sm hover:bg-blue-500/30 transition-all">
                                <i class="fa-solid fa-magic mr-1"></i> AIç”Ÿæˆ
                            </button>

                            <!-- AI Image -->
                            <button onclick="WeiboUI.generateAIImage()"
                                class="bg-blue-500/20 border border-blue-500/30 text-blue-600 px-4 py-1 rounded-full text-sm hover:bg-blue-500/30 transition-all">
                                <i class="fa-solid fa-image mr-1"></i> AIé…å›¾
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-xs text-gray-400" id="publish-word-count">0/140</div>
                            <button onclick="WeiboUI.publishPost()"
                                class="weibo-publish-btn bg-red-500 text-white px-6 py-2 rounded-full font-medium hover:bg-red-600 transition-all">å‘å¸ƒ</button>
                        </div>
                    </div>

                    <!-- Emoji Picker -->
                    <div id="publish-emoji-picker"
                        class="hidden mt-3 bg-white rounded-lg shadow-lg p-3 max-h-60 overflow-y-auto">
                        <!-- Emoji Library -->
                        <div class="grid grid-cols-8 gap-2">
                            <!-- Smileys & Emotion -->
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜Š')">ğŸ˜Š</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜‚')">ğŸ˜‚</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¤£')">ğŸ¤£</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('â¤ï¸')">â¤ï¸</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜')">ğŸ˜</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜˜')">ğŸ˜˜</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜')">ğŸ˜</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¥°')">ğŸ¥°</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜¢')">ğŸ˜¢</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜­')">ğŸ˜­</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜±')">ğŸ˜±</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ˜¡')">ğŸ˜¡</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ‘')">ğŸ‘</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ‘')">ğŸ‘</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ‘Œ')">ğŸ‘Œ</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¤”')">ğŸ¤”</div>

                            <!-- Animals & Nature -->
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¶')">ğŸ¶</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ±')">ğŸ±</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¼')">ğŸ¼</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¨')">ğŸ¨</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¯')">ğŸ¯</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¦')">ğŸ¦</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¸')">ğŸ¸</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸµ')">ğŸµ</div>

                            <!-- Food & Drink -->
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ')">ğŸ</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ‡')">ğŸ‡</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ”')">ğŸ”</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ•')">ğŸ•</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ—')">ğŸ—</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¦')">ğŸ¦</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸº')">ğŸº</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('â˜•')">â˜•</div>

                            <!-- Activities -->
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('âš½')">âš½</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ€')">ğŸ€</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ®')">ğŸ®</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ­')">ğŸ­</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ¨')">ğŸ¨</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸµ')">ğŸµ</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸª')">ğŸª</div>
                            <div class="emoji-item text-2xl cursor-pointer hover:bg-gray-100 rounded-full p-1"
                                onclick="WeiboUI.insertEmoji('ğŸ‰')">ğŸ‰</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Edit Modal -->
        <div id="weibo-profile-edit-modal" class="weibo-modal-overlay hidden">
            <div class="weibo-modal-content max-w-md mx-auto mt-20 max-h-[80vh] flex flex-col overflow-hidden">
                <div class="weibo-modal-header flex justify-between items-center p-4 border-b border-gray-200 shrink-0">
                    <span class="font-bold">ç¼–è¾‘èµ„æ–™</span>
                    <button onclick="WeiboUI.closeProfileEditModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                <div class="weibo-modal-body p-4 overflow-y-auto">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¤´åƒ</label>
                        <div class="flex items-center gap-4 mb-3">
                            <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden shrink-0">
                                <img id="edit-avatar-preview" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="flex flex-col gap-2 flex-1">
                                <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                <button onclick="document.getElementById('avatar-upload').click()"
                                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-200 transition-all">
                                    <i class="fa-solid fa-camera mr-1"></i> ä»ç›¸å†Œé€‰æ‹©
                                </button>
                                <button onclick="WeiboUI.generateWeChatAvatar()"
                                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-sm hover:bg-gray-200 transition-all">
                                    <i class="fa-solid fa-user mr-1"></i> ä½¿ç”¨å¾®ä¿¡éšæœºå¤´åƒ
                                </button>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <input type="text" id="avatar-url" placeholder="è¾“å…¥å¤´åƒURL"
                                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                            <button onclick="WeiboUI.uploadAvatarFromUrl()"
                                class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all text-sm whitespace-nowrap">
                                <i class="fa-solid fa-download mr-1"></i> ä¸Šä¼ 
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ˜µç§°</label>
                        <input type="text" id="edit-username" placeholder="è¯·è¾“å…¥æ˜µç§°"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç®€ä»‹</label>
                        <textarea id="edit-bio" placeholder="è¯·è¾“å…¥ç®€ä»‹" rows="3"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆå§‹ç²‰ä¸æ•°</label>
                        <input type="number" id="edit-followers" min="0" placeholder="è¯·è¾“å…¥åˆå§‹ç²‰ä¸æ•°"
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¾®åšè§’è‰²è®¾ç½®</label>
                        <div class="mb-2">
                            <label class="block text-sm text-gray-600 mb-1">ç»‘å®šå¾®ä¿¡è§’è‰²</label>
                            <select id="edit-char-binding"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white">
                                <option value="">æ— ç»‘å®š</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label class="block text-sm text-gray-600 mb-1">ä¸–ç•Œä¹¦ç»‘å®š</label>
                            <select id="edit-worldbook-binding"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 bg-white">
                                <option value="">æ— ç»‘å®š</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-6 pb-2">
                        <button onclick="WeiboUI.saveProfileEdit()"
                            class="w-full bg-red-500 text-white py-2 rounded-lg font-medium hover:bg-red-600 transition-all">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings Modal -->
        <div id="weibo-settings-modal" class="weibo-modal-overlay hidden">
            <div class="weibo-modal-content max-w-md mx-auto mt-20">
                <div class="weibo-modal-header flex justify-between items-center p-4 border-b border-gray-200">
                    <span class="font-bold">å¾®åšè®¾ç½®</span>
                    <button onclick="WeiboUI.closeSettingsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
                <div class="weibo-modal-body p-4">
                    <!-- Auto Generate Content Settings -->
                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-3">è‡ªåŠ¨ç”Ÿæˆå†…å®¹</h3>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç”Ÿæˆæ—¶é—´é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" id="auto-generate-interval" min="5" max="1440" placeholder="è¯·è¾“å…¥æ—¶é—´é—´éš”"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                            <div class="text-xs text-gray-500 mt-1">å»ºè®®è®¾ç½®åœ¨30-120åˆ†é’Ÿä¹‹é—´</div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">å¯ç”¨è‡ªåŠ¨ç”Ÿæˆ</label>
                            <input type="checkbox" id="auto-generate-enabled" class="toggle-switch">
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="mt-6">
                        <button onclick="WeiboUI.saveSettings()"
                            class="w-full bg-red-500 text-white py-2 rounded-lg font-medium hover:bg-red-600 transition-all">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weibo UI Script -->
    <script>
        window.WeiboUI = {
            currentMainTab: 'discovery',
            currentDiscoveryTab: 'following',

            init: function () {
                this.loadData();
                this.bindEvents();
                this.renderContent();
            },

            loadData: function () {
                // Load data from localStorage
                const weiboData = localStorage.getItem('weibo_data');
                if (weiboData) {
                    this.data = JSON.parse(weiboData);
                } else {
                    this.data = {
                        posts: [],
                        hotSearch: [],
                        messages: [],
                        following: [],
                        user: {
                            name: 'æˆ‘',
                            avatar: '',
                            bio: '',
                            posts: 0,
                            following: 0,
                            followers: 0,
                            charBinding: '',
                            worldbookBinding: ''
                        }
                    };
                    this.saveData();
                }

                // Start random follower mechanism
                this.startRandomFollowerMechanism();
            },

            openProfileEditModal: function () {
                // Open profile edit modal
                const modal = document.getElementById('weibo-profile-edit-modal');
                modal.classList.remove('hidden');

                // Load current profile data
                document.getElementById('edit-username').value = this.data.user.name;
                document.getElementById('edit-bio').value = this.data.user.bio || '';
                document.getElementById('edit-followers').value = this.data.user.followers;

                // Load avatar preview
                const avatarPreview = document.getElementById('edit-avatar-preview');
                avatarPreview.src = this.data.user.avatar || '';

                // Load WeChat chars for binding
                this.loadWeChatChars();

                // Load worldbook entries for binding
                this.loadWorldbookEntries();

                // Set current bindings
                document.getElementById('edit-char-binding').value = this.data.user.charBinding || '';
                document.getElementById('edit-worldbook-binding').value = this.data.user.worldbookBinding || '';

                // Add event listener for avatar upload
                document.getElementById('avatar-upload').onchange = (e) => this.handleAvatarUpload(e);
            },

            closeProfileEditModal: function () {
                // Close profile edit modal
                const modal = document.getElementById('weibo-profile-edit-modal');
                modal.classList.add('hidden');
            },

            openSettingsModal: function () {
                // Open settings modal
                const modal = document.getElementById('weibo-settings-modal');
                modal.classList.remove('hidden');

                // Load settings from localStorage
                const settings = JSON.parse(localStorage.getItem('weibo_settings') || JSON.stringify({
                    autoGenerateEnabled: false,
                    autoGenerateInterval: 60
                }));

                // Set form values
                document.getElementById('auto-generate-enabled').checked = settings.autoGenerateEnabled;
                document.getElementById('auto-generate-interval').value = settings.autoGenerateInterval;
            },

            closeSettingsModal: function () {
                // Close settings modal
                const modal = document.getElementById('weibo-settings-modal');
                modal.classList.add('hidden');
            },

            saveSettings: function () {
                // Save settings to localStorage
                const enabled = document.getElementById('auto-generate-enabled').checked;
                const interval = parseInt(document.getElementById('auto-generate-interval').value) || 60;

                const settings = {
                    autoGenerateEnabled: enabled,
                    autoGenerateInterval: interval
                };

                localStorage.setItem('weibo_settings', JSON.stringify(settings));

                // Update auto generate mechanism
                this.updateAutoGenerateMechanism(enabled, interval);

                this.showToast('è®¾ç½®å·²ä¿å­˜');
                this.closeSettingsModal();
            },

            updateAutoGenerateMechanism: function (enabled, interval) {
                // Update auto generate mechanism
                if (this.autoGenerateInterval) {
                    clearInterval(this.autoGenerateInterval);
                }

                if (enabled) {
                    // Start auto generate mechanism
                    this.autoGenerateInterval = setInterval(() => {
                        this.generateContent();
                    }, interval * 60000);
                }
            },

            handleAvatarUpload: function (e) {
                // Handle avatar upload from file
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const avatarPreview = document.getElementById('edit-avatar-preview');
                    avatarPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            },

            uploadAvatarFromUrl: function () {
                // Upload avatar from URL
                const urlInput = document.getElementById('avatar-url');
                const url = urlInput.value.trim();
                if (!url) {
                    this.showToast('è¯·è¾“å…¥å¤´åƒURL');
                    return;
                }

                // Validate URL
                try {
                    new URL(url);
                } catch (error) {
                    this.showToast('æ— æ•ˆçš„URL');
                    return;
                }

                // Update preview
                const avatarPreview = document.getElementById('edit-avatar-preview');
                avatarPreview.src = url;

                // Clear input
                urlInput.value = '';

                this.showToast('å¤´åƒURLä¸Šä¼ æˆåŠŸ');
            },

            generateWeChatAvatar: function () {
                // Use provided WeChat random avatars
                const avatars = [
                    'https://ibb.co/DHHvx1kT',
                    'https://ibb.co/ymD1ZfSH',
                    'https://ibb.co/pjBHhfJ9',
                    'https://ibb.co/HfJyz1XF',
                    'https://ibb.co/NnjsXnSB',
                    'https://ibb.co/VW8vVq5G',
                    'https://ibb.co/TDYT6m7p',
                    'https://ibb.co/CKpbd5Gy',
                    'https://ibb.co/Z6bQGpfQ'
                ];

                // Randomly select an avatar
                const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];

                // Update preview
                const avatarPreview = document.getElementById('edit-avatar-preview');
                avatarPreview.src = randomAvatar;

                this.showToast('å¾®ä¿¡éšæœºå¤´åƒç”ŸæˆæˆåŠŸ');
            },

            loadWeChatChars: function () {
                // Load WeChat characters from localStorage
                const chars = JSON.parse(localStorage.getItem('wechat_chars') || '{}');
                const select = document.getElementById('edit-char-binding');

                // Clear existing options except the first one
                select.innerHTML = '<option value="">æ— ç»‘å®š</option>';

                // Add WeChat characters as options
                Object.values(chars).forEach(char => {
                    const option = document.createElement('option');
                    option.value = char.id;
                    option.textContent = char.name;
                    select.appendChild(option);
                });
            },

            loadWorldbookEntries: function () {
                // Load worldbook entries from localStorage
                const worldbook = JSON.parse(localStorage.getItem('worldbook_entries') || '[]');
                const select = document.getElementById('edit-worldbook-binding');

                // Clear existing options except the first one
                select.innerHTML = '<option value="">æ— ç»‘å®š</option>';

                // Add worldbook entries as options
                worldbook.forEach(entry => {
                    const option = document.createElement('option');
                    option.value = entry.id;
                    option.textContent = entry.title;
                    select.appendChild(option);
                });
            },

            saveProfileEdit: function () {
                // Save profile edits
                const username = document.getElementById('edit-username').value.trim();
                const bio = document.getElementById('edit-bio').value.trim();
                const followers = parseInt(document.getElementById('edit-followers').value) || 0;
                const avatarPreview = document.getElementById('edit-avatar-preview');
                const charBinding = document.getElementById('edit-char-binding').value;
                const worldbookBinding = document.getElementById('edit-worldbook-binding').value;

                // Update user data
                this.data.user.name = username || 'æˆ‘';
                this.data.user.bio = bio;
                this.data.user.followers = followers;
                this.data.user.avatar = avatarPreview.src;
                this.data.user.charBinding = charBinding;
                this.data.user.worldbookBinding = worldbookBinding;

                // Save to localStorage
                this.saveData();

                // Update profile display
                this.renderProfile();

                // Close modal
                this.closeProfileEditModal();

                // Show success message
                this.showToast('èµ„æ–™æ›´æ–°æˆåŠŸ');
            },

            saveData: function () {
                localStorage.setItem('weibo_data', JSON.stringify(this.data));
            },

            bindEvents: function () {
                // Bind events
                document.getElementById('publish-content')?.addEventListener('input', this.updateWordCount.bind(this));
                document.getElementById('hotsearch-input')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.searchHotsearch();
                    }
                });
            },

            updateWordCount: function () {
                const content = document.getElementById('publish-content').value;
                const count = content.length;
                document.getElementById('publish-word-count').textContent = `${count}/140`;
            },

            switchMainTab: function (tabName) {
                // Remove active class from all main tabs
                document.querySelectorAll('.weibo-main-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.style.color = '#666';
                });

                // Add active class to current tab
                document.getElementById(`btn-main-${tabName}`).classList.add('active');
                document.getElementById(`btn-main-${tabName}`).style.color = '#e53e3e';

                // Hide all main pages
                document.querySelectorAll('#weibo-discovery, #weibo-hotsearch, #weibo-message, #weibo-profile').forEach(page => {
                    page.classList.add('hidden');
                });

                // Show current page
                document.getElementById(`weibo-${tabName}`).classList.remove('hidden');

                this.currentMainTab = tabName;

                // Render content for the tab
                this.renderContent();
            },

            switchTab: function (page, tabName) {
                if (page === 'discovery') {
                    // Remove active class from all discovery tabs
                    document.querySelectorAll('.weibo-discovery-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Add active class to current tab
                    document.getElementById(`btn-tab-${tabName}`).classList.add('active');

                    // Hide all discovery content
                    document.querySelectorAll('.weibo-content-area').forEach(content => {
                        content.classList.add('hidden');
                    });

                    // Show current content
                    document.getElementById(`weibo-${tabName}-content`).classList.remove('hidden');

                    this.currentDiscoveryTab = tabName;
                } else if (page === 'profile') {
                    // Remove active class from all profile tabs
                    document.querySelectorAll('.weibo-profile-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Add active class to current tab
                    document.getElementById(`btn-profile-${tabName}`).classList.add('active');

                    // Hide all profile content
                    document.querySelectorAll('.weibo-profile-content').forEach(content => {
                        content.classList.add('hidden');
                    });

                    // Show current content
                    document.getElementById(`profile-${tabName}`).classList.remove('hidden');
                }
            },

            switchProfileTab: function (tabName) {
                this.switchTab('profile', tabName);
            },

            renderContent: function () {
                if (this.currentMainTab === 'discovery') {
                    this.renderDiscoveryContent();
                } else if (this.currentMainTab === 'hotsearch') {
                    this.renderHotsearch();
                } else if (this.currentMainTab === 'message') {
                    this.renderMessages();
                } else if (this.currentMainTab === 'profile') {
                    this.renderProfile();
                }
            },

            renderDiscoveryContent: function () {
                // Render discovery content
                const container = document.getElementById(`weibo-${this.currentDiscoveryTab}-content`);
                if (!container) return;

                // Get user interests from localStorage (default to general interests if none)
                const userInterests = JSON.parse(localStorage.getItem('weibo_user_interests') || JSON.stringify([
                    'ç§‘æŠ€', 'ç¾é£Ÿ', 'æ—…è¡Œ', 'ç”µå½±', 'éŸ³ä¹', 'è¿åŠ¨', 'æ—¶å°š', 'æ¸¸æˆ'
                ]));

                // Check if we have cached posts for this tab
                const cacheKey = `weibo_discovery_${this.currentDiscoveryTab}_${userInterests.join('_')}`;
                const cachedPosts = localStorage.getItem(cacheKey);

                if (cachedPosts) {
                    // Use cached content
                    const posts = JSON.parse(cachedPosts);
                    this.renderPosts(container, posts);
                } else {
                    // Use fallback content if no cache
                    this.renderFallbackDiscoveryContent(container);
                }
            },

            generateRecommendationContent: function (interests, tab) {
                // Generate recommendation content based on user interests
                const container = document.getElementById(`weibo-${tab}-content`);
                if (!container) return;

                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'weibo-post bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-center items-center';
                loadingDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin text-red-500"></i><span class="text-gray-600">AIç”Ÿæˆæ¨èå†…å®¹ä¸­...</span></div>`;
                container.appendChild(loadingDiv);

                // Build AI prompt with user interests
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšå†…å®¹æ¨èä¸“å®¶ï¼Œæ ¹æ®ç”¨æˆ·å…´è¶£ç”Ÿæˆ8-12æ¡ç¬¦åˆè¦æ±‚çš„å¾®åšå†…å®¹ï¼š
                        1. ç”¨æˆ·å…´è¶£ï¼š${interests.join('ã€')}
                        2. å†…å®¹ç±»å‹ï¼š
                            - å…³æ³¨å†…å®¹ï¼ˆfollowingï¼‰ï¼šä¸ªäººåŠ¨æ€ã€ç”Ÿæ´»åˆ†äº«ã€æ—¥å¸¸æ„Ÿæ‚Ÿ
                            - æ¨èå†…å®¹ï¼ˆrecommendï¼‰ï¼šçƒ­é—¨è¯é¢˜ã€ä¸“ä¸šçŸ¥è¯†ã€è¶£å‘³å†…å®¹
                        3. å†…å®¹è¦æ±‚ï¼š
                            - æ¯æ¡å¾®åšå†…å®¹ç®€æ´æœ‰è¶£ï¼Œç¬¦åˆå¾®åšé£æ ¼
                            - é•¿åº¦é€‚ä¸­ï¼Œé€‚åˆåœ¨å¾®åšä¸Šå‘å¸ƒ
                            - å†…å®¹è¦å¤šæ ·åŒ–ï¼Œæ¶µç›–ä¸åŒé¢†åŸŸ
                            - æ¯æ¡å¾®åšè¦æœ‰ç›¸åº”çš„è¯é¢˜æ ‡ç­¾
                            - å†…å®¹è¦è‡ªç„¶ï¼Œç¬¦åˆçœŸå®ç”¨æˆ·çš„å‘å¸ƒä¹ æƒ¯
                        4. è¾“å‡ºæ ¼å¼ï¼šJSONæ ¼å¼ï¼ŒåŒ…å«postsæ•°ç»„ï¼Œæ¯ä¸ªpostå¯¹è±¡åŒ…å«ï¼š
                            - user: { name: ç”¨æˆ·å, avatar: å¤´åƒURL, tag: è¯é¢˜æ ‡ç­¾ }
                            - content: å¾®åšå†…å®¹
                            - likes: éšæœºç‚¹èµæ•°ï¼ˆ500-1000000ï¼‰
                            - comments: éšæœºè¯„è®ºæ•°ï¼ˆ50-10000ï¼‰
                            - reposts: éšæœºè½¬å‘æ•°ï¼ˆ100-500000ï¼‰
                            - timestamp: å‘å¸ƒæ—¶é—´ï¼ˆå½“å‰æ—¶é—´å‡å»éšæœºå¤©æ•°ï¼‰
                        5. ç¤ºä¾‹è¾“å‡ºï¼š
                        {
                            "posts": [
                                {
                                    "user": { "name": "æµ‹è¯•ç”¨æˆ·1", "avatar": "", "tag": "#ç¾é£Ÿæ¢åº—#" },
                                    "content": "ä»Šå¤©åƒäº†å¥½åƒçš„ç«é”…ï¼Œæ¨èç»™å¤§å®¶ï¼",
                                    "likes": 12345,
                                    "comments": 678,
                                    "reposts": 9012,
                                    "timestamp": 1700000000000
                                }
                            ]
                        }`
                    }
                ];

                // Call AI model
                SettingsLogic.generateLLM(messages, 'weibo_recommend').then(reply => {
                    // Remove loading indicator
                    loadingDiv.remove();

                    try {
                        // Parse AI response
                        let generatedData;
                        if (reply.includes('```json')) {
                            const jsonMatch = reply.match(/```json([\s\S]*?)```/);
                            if (jsonMatch) {
                                generatedData = JSON.parse(jsonMatch[1].trim());
                            }
                        } else if (reply.includes('{') && reply.includes('}')) {
                            generatedData = JSON.parse(reply);
                        }

                        if (generatedData && generatedData.posts) {
                            // Save to cache
                            const cacheKey = `weibo_discovery_${tab}_${interests.join('_')}`;
                            localStorage.setItem(cacheKey, JSON.stringify(generatedData.posts));
                            localStorage.setItem(`weibo_discovery_last_cached_${tab}`, Date.now().toString());

                            // Render the generated posts
                            this.renderPosts(container, generatedData.posts);
                        } else {
                            throw new Error('æ— æ•ˆçš„JSONæ ¼å¼');
                        }
                    } catch (error) {
                        console.error('è§£æAIç”Ÿæˆå†…å®¹å¤±è´¥:', error);
                        this.renderFallbackDiscoveryContent(container);
                    }
                }).catch(error => {
                    console.error('ç”Ÿæˆæ¨èå†…å®¹å¤±è´¥:', error);
                    loadingDiv.remove();
                    this.renderFallbackDiscoveryContent(container);
                });
            },

            renderPosts: function (container, posts) {
                // Render multiple posts
                let html = '';
                posts.forEach(post => {
                    html += this.renderPost(post);
                });
                container.innerHTML = html;
            },

            renderFallbackDiscoveryContent: function (container) {
                // Fallback mock data for testing
                const mockPosts = [
                    {
                        id: 1,
                        user: {
                            name: 'æµ‹è¯•ç”¨æˆ·1',
                            avatar: '',
                            tag: '#ç¾é£Ÿæ¢åº—#'
                        },
                        content: 'ä»Šå¤©åƒäº†å¥½åƒçš„ç«é”…ï¼Œæ¨èç»™å¤§å®¶ï¼',
                        likes: Math.floor(Math.random() * 1000000) + 500,
                        comments: Math.floor(Math.random() * 10000) + 50,
                        reposts: Math.floor(Math.random() * 500000) + 100,
                        timestamp: Date.now() - Math.floor(Math.random() * 86400000)
                    },
                    {
                        id: 2,
                        user: {
                            name: 'æµ‹è¯•ç”¨æˆ·2',
                            avatar: '',
                            tag: '#æ¸¸æˆæ—¥å¸¸#'
                        },
                        content: 'æ–°æ¸¸æˆä¸Šçº¿äº†ï¼Œå¤§å®¶ç©äº†å—ï¼Ÿ',
                        likes: Math.floor(Math.random() * 1000000) + 500,
                        comments: Math.floor(Math.random() * 10000) + 50,
                        reposts: Math.floor(Math.random() * 500000) + 100,
                        timestamp: Date.now() - Math.floor(Math.random() * 86400000)
                    }
                ];

                let html = '';
                mockPosts.forEach(post => {
                    html += this.renderPost(post);
                });

                container.innerHTML = html;
            },

            renderPost: function (post) {
                return `
                    <div class="weibo-post bg-white rounded-lg shadow-sm p-4 mb-4" data-post-id="${post.id}">
                        <div class="weibo-post-header flex items-center gap-3 mb-3">
                            <div class="weibo-post-avatar w-10 h-10 rounded-full bg-gray-200 overflow-hidden">
                                <img src="${post.user.avatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="weibo-post-user-info flex-1">
                                <div class="weibo-post-username font-bold">${post.user.name}</div>
                                <div class="weibo-post-tag text-xs text-gray-400">${post.user.tag}</div>
                            </div>
                        </div>
                        <div class="weibo-post-content text-gray-800 mb-3">${post.content}</div>
                        <div class="weibo-post-stats flex justify-around text-xs text-gray-500 border-t border-gray-100 pt-3">
                            <div class="weibo-post-stat-item flex items-center gap-1 cursor-pointer hover:text-red-500 transition-colors" onclick="WeiboUI.openCommentModal(${post.id})">
                                <i class="fa-regular fa-comment"></i>
                                <span>${this.formatNumber(post.comments)}</span>
                            </div>
                            <div class="weibo-post-stat-item flex items-center gap-1 cursor-pointer hover:text-green-500 transition-colors" onclick="WeiboUI.generateRepostContent(${post.id})">
                                <i class="fa-solid fa-retweet"></i>
                                <span>${this.formatNumber(post.reposts)}</span>
                            </div>
                            <div class="weibo-post-stat-item flex items-center gap-1 cursor-pointer hover:text-red-500 transition-colors" onclick="WeiboUI.generateLikeContent(${post.id})">
                                <i class="fa-regular fa-heart"></i>
                                <span>${this.formatNumber(post.likes)}</span>
                            </div>
                        </div>
                    </div>
                `;
            },

            openCommentModal: function (postId) {
                // è¿™é‡Œå¯ä»¥å®ç°æ‰“å¼€è¯„è®ºæ¨¡æ€æ¡†çš„åŠŸèƒ½
                // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥ç”Ÿæˆè¯„è®ºå†…å®¹å¹¶æ˜¾ç¤º
                this.generateCommentContent(postId);
            },

            generateCommentContent: function (postId) {
                // ç”Ÿæˆè¯„è®ºå†…å®¹
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (!postElement) return;

                // è·å–å¸–å­å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
                const postContent = postElement.querySelector('.weibo-post-content').textContent;

                // åˆ›å»ºä¸´æ—¶åŠ è½½æŒ‡ç¤ºå™¨
                const commentBtn = event.target.closest('.weibo-post-stat-item');
                const originalHTML = commentBtn.innerHTML;
                commentBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>ç”Ÿæˆä¸­...</span>';

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšè¯„è®ºç”Ÿæˆä¸“å®¶ï¼Œè¯·æ ¹æ®å¾®åšå†…å®¹ç”Ÿæˆ3-5æ¡ä¸åŒé£æ ¼çš„è¯„è®ºï¼š
                        1. è¯„è®ºé£æ ¼è¦å¤šæ ·åŒ–ï¼ŒåŒ…æ‹¬ï¼š
                            - å¹½é»˜é£è¶£å‹
                            - æ·±åº¦æ€è€ƒå‹
                            - æƒ…æ„Ÿå…±é¸£å‹
                            - äº’åŠ¨æé—®å‹
                        2. è¯„è®ºè¦ç¬¦åˆå¾®åšç”¨æˆ·çš„å‘è¨€ä¹ æƒ¯
                        3. è¯„è®ºè¦ç®€æ´æ˜äº†ï¼Œä¸è¦å¤ªé•¿
                        4. è¯„è®ºè¦ä¸å¾®åšå†…å®¹ç›¸å…³
                        5. è¾“å‡ºæ ¼å¼ï¼šæ¯æ¡è¯„è®ºå•ç‹¬ä¸€è¡Œï¼Œä¸è¦åŒ…å«ä»»ä½•æ ‡è®°
                        6. ç¤ºä¾‹è¾“å‡ºï¼š
                        è¿™ä¹Ÿå¤ªæœ‰è¶£äº†å§ï¼
                        ç¡®å®å¾ˆæœ‰é“ç†ï¼Œå€¼å¾—æ·±æ€
                        æˆ‘ä¹Ÿæœ‰åŒæ ·çš„æ„Ÿå—
                        ä½ ä»¬è§‰å¾—å‘¢ï¼Ÿ`
                    },
                    {
                        role: 'user',
                        content: `å¾®åšå†…å®¹ï¼š${postContent}`
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹
                SettingsLogic.generateLLM(messages, 'weibo_comment').then(reply => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    commentBtn.innerHTML = originalHTML;

                    // å¤„ç†AIè¿”å›çš„è¯„è®º
                    const comments = reply.trim().split('\n').filter(comment => comment.trim());

                    if (comments.length > 0) {
                        // æ˜¾ç¤ºç”Ÿæˆçš„è¯„è®ºï¼ˆè¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…çš„è¯„è®ºæ¨¡æ€æ¡†ï¼‰
                        const commentExample = comments[Math.floor(Math.random() * comments.length)];
                        this.showToast(`AIç”Ÿæˆè¯„è®ºï¼š${commentExample}`);
                    } else {
                        this.showToast('è¯„è®ºç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }).catch(error => {
                    console.error('ç”Ÿæˆè¯„è®ºå¤±è´¥:', error);
                    commentBtn.innerHTML = originalHTML;
                    this.showToast('è¯„è®ºç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            },

            generateRepostContent: function (postId) {
                // ç”Ÿæˆè½¬å‘å†…å®¹
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (!postElement) return;

                // è·å–å¸–å­å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
                const postContent = postElement.querySelector('.weibo-post-content').textContent;

                // åˆ›å»ºä¸´æ—¶åŠ è½½æŒ‡ç¤ºå™¨
                const repostBtn = event.target.closest('.weibo-post-stat-item');
                const originalHTML = repostBtn.innerHTML;
                repostBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span>ç”Ÿæˆä¸­...</span>';

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšè½¬å‘å†…å®¹ç”Ÿæˆä¸“å®¶ï¼Œè¯·æ ¹æ®åŸå¾®åšå†…å®¹ç”Ÿæˆè½¬å‘æ–‡æ¡ˆï¼š
                        1. è½¬å‘æ–‡æ¡ˆè¦ç¬¦åˆå¾®åšç”¨æˆ·çš„è½¬å‘ä¹ æƒ¯
                        2. è½¬å‘æ–‡æ¡ˆè¦ç®€æ´æ˜äº†ï¼Œä¸è¦å¤ªé•¿
                        3. è½¬å‘æ–‡æ¡ˆè¦ä¸åŸå¾®åšå†…å®¹ç›¸å…³
                        4. è½¬å‘æ–‡æ¡ˆå¯ä»¥åŒ…å«ä¸ªäººè§‚ç‚¹ã€æƒ…æ„Ÿè¡¨è¾¾æˆ–è¡¥å……ä¿¡æ¯
                        5. è¾“å‡ºæ ¼å¼ï¼šç›´æ¥è¾“å‡ºè½¬å‘æ–‡æ¡ˆï¼Œä¸è¦åŒ…å«ä»»ä½•æ ‡è®°
                        6. ç¤ºä¾‹è¾“å‡ºï¼š
                        è½¬å‘ï¼šåŸåšè¯´å¾—å¤ªå¯¹äº†ï¼åˆ†äº«ç»™å¤§å®¶
                        è½¬äº†ï¼Œè¿™ä¸ªå¾ˆæœ‰ä»·å€¼
                        è¯´å¾—çœŸå¥½ï¼Œæˆ‘ä¹Ÿè¿™ä¹ˆè®¤ä¸º`
                    },
                    {
                        role: 'user',
                        content: `åŸå¾®åšå†…å®¹ï¼š${postContent}`
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹
                SettingsLogic.generateLLM(messages, 'weibo_repost').then(reply => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    repostBtn.innerHTML = originalHTML;

                    // å¤„ç†AIè¿”å›çš„è½¬å‘å†…å®¹
                    const repostContent = reply.trim();

                    if (repostContent) {
                        // æ˜¾ç¤ºç”Ÿæˆçš„è½¬å‘å†…å®¹ï¼ˆè¿™é‡Œå¯ä»¥æ›¿æ¢ä¸ºå®é™…çš„è½¬å‘åŠŸèƒ½ï¼‰
                        this.showToast(`AIç”Ÿæˆè½¬å‘å†…å®¹ï¼š${repostContent}`);
                    } else {
                        this.showToast('è½¬å‘å†…å®¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                }).catch(error => {
                    console.error('ç”Ÿæˆè½¬å‘å†…å®¹å¤±è´¥:', error);
                    repostBtn.innerHTML = originalHTML;
                    this.showToast('è½¬å‘å†…å®¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            },

            generateLikeContent: function (postId) {
                // ç”Ÿæˆç‚¹èµäº’åŠ¨å†…å®¹ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ›´ä¸°å¯Œçš„äº’åŠ¨å½¢å¼ï¼‰
                // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬ç›´æ¥æ˜¾ç¤ºç‚¹èµæˆåŠŸæç¤º
                const likeBtn = event.target.closest('.weibo-post-stat-item');
                const icon = likeBtn.querySelector('i');
                const countSpan = likeBtn.querySelector('span');

                // æ›´æ–°ç‚¹èµçŠ¶æ€
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                icon.style.color = '#ef4444';

                // æ›´æ–°ç‚¹èµæ•°
                const currentCount = parseInt(countSpan.textContent.replace(/,/g, ''));
                countSpan.textContent = this.formatNumber(currentCount + 1);

                // æ˜¾ç¤ºAIç”Ÿæˆçš„ç‚¹èµåé¦ˆ
                this.showToast('AIç”Ÿæˆç‚¹èµåé¦ˆï¼šç‚¹èµ+1ï¼Œå†…å®¹ä¸é”™ï¼');
            },

            renderHotsearch: function () {
                // Render hot search list
                const container = document.getElementById('hotsearch-list-content');
                if (!container) return;

                // Check if we need to generate new hot search terms
                const lastGenerated = localStorage.getItem('weibo_hotsearch_last_generated');
                const now = Date.now();
                const shouldGenerate = !lastGenerated || (now - parseInt(lastGenerated)) > 3600000; // Generate every hour

                if (shouldGenerate) {
                    // Generate new hot search terms using AI
                    this.generateHotsearchTerms();
                } else {
                    // Use existing hot search data from localStorage
                    this.loadHotsearchTerms();
                }
            },

            generateHotsearchTerms: function () {
                // Generate hot search terms using AI
                const container = document.getElementById('hotsearch-list-content');
                if (!container) return;

                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-center items-center p-8';
                loadingDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin text-red-500"></i><span class="text-gray-600">AIç”Ÿæˆçƒ­æœè¯æ¡ä¸­...</span></div>`;
                container.innerHTML = '';
                container.appendChild(loadingDiv);

                // Build AI prompt
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšçƒ­æœæ¦œç”Ÿæˆä¸“å®¶ï¼Œè¯·ç”Ÿæˆ15-20æ¡ç¬¦åˆè¦æ±‚çš„å¾®åšçƒ­æœè¯æ¡ï¼š
                        1. å†…å®¹è¦æ±‚ï¼š
                            - æ¶µç›–ä¸åŒé¢†åŸŸï¼ˆç§‘æŠ€ã€å¨±ä¹ã€ä½“è‚²ã€ç¤¾ä¼šã€ç”Ÿæ´»ç­‰ï¼‰
                            - æ¯ä¸ªè¯æ¡åŒ…å«çƒ­ç‚¹å…³é”®è¯å’Œç®€è¦æè¿°
                            - è¯æ¡è¦ç¬¦åˆå½“å‰ç¤¾ä¼šçƒ­ç‚¹è¶‹åŠ¿
                            - è¯æ¡è¦å¸å¼•äººï¼Œç¬¦åˆå¾®åšç”¨æˆ·çš„å…´è¶£
                        2. è¾“å‡ºæ ¼å¼ï¼šJSONæ ¼å¼ï¼ŒåŒ…å«hotsearchæ•°ç»„ï¼Œæ¯ä¸ªhotsearchå¯¹è±¡åŒ…å«ï¼š
                            - title: çƒ­æœè¯æ¡æ ‡é¢˜ï¼ˆ15-30å­—ï¼‰
                            - heat: éšæœºçƒ­åº¦å€¼ï¼ˆ500000-5000000ï¼‰
                            - category: æ‰€å±é¢†åŸŸï¼ˆç§‘æŠ€ã€å¨±ä¹ã€ä½“è‚²ã€ç¤¾ä¼šã€ç”Ÿæ´»ç­‰ï¼‰
                        3. ç¤ºä¾‹è¾“å‡ºï¼š
                        {
                            "hotsearch": [
                                {
                                    "title": "æœ€æ–°ç§‘æŠ€å‘å¸ƒä¼šï¼šAIåŠ©æ‰‹åŠŸèƒ½å¤§å‡çº§",
                                    "heat": 2800000,
                                    "category": "ç§‘æŠ€"
                                }
                            ]
                        }`
                    }
                ];

                // Call AI model
                SettingsLogic.generateLLM(messages, 'weibo_hotsearch').then(reply => {
                    try {
                        // Parse AI response
                        let generatedData;
                        if (reply.includes('```json')) {
                            const jsonMatch = reply.match(/```json([\s\S]*?)```/);
                            if (jsonMatch) {
                                generatedData = JSON.parse(jsonMatch[1].trim());
                            }
                        } else if (reply.includes('{') && reply.includes('}')) {
                            generatedData = JSON.parse(reply);
                        }

                        if (generatedData && generatedData.hotsearch) {
                            // Save to localStorage
                            localStorage.setItem('weibo_hotsearch_data', JSON.stringify(generatedData.hotsearch));
                            localStorage.setItem('weibo_hotsearch_last_generated', Date.now().toString());

                            // Render the generated hot search terms
                            this.renderHotsearchList(generatedData.hotsearch);
                        } else {
                            throw new Error('æ— æ•ˆçš„JSONæ ¼å¼');
                        }
                    } catch (error) {
                        console.error('è§£æAIç”Ÿæˆçƒ­æœå¤±è´¥:', error);
                        // Fallback to mock data if AI generation fails
                        this.renderFallbackHotsearch();
                    }
                }).catch(error => {
                    console.error('ç”Ÿæˆçƒ­æœå¤±è´¥:', error);
                    // Fallback to mock data if AI generation fails
                    this.renderFallbackHotsearch();
                });
            },

            loadHotsearchTerms: function () {
                // Load hot search terms from localStorage
                const hotsearchData = localStorage.getItem('weibo_hotsearch_data');
                if (hotsearchData) {
                    const hotsearchList = JSON.parse(hotsearchData);
                    this.renderHotsearchList(hotsearchList);
                } else {
                    // Fallback to mock data
                    this.renderFallbackHotsearch();
                }
            },

            renderHotsearchList: function (hotsearchList) {
                // Render hot search list
                const container = document.getElementById('hotsearch-list-content');
                if (!container) return;

                let html = '';
                hotsearchList.forEach((item, index) => {
                    html += `
                        <div class="weibo-hotsearch-item flex items-center gap-3 py-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="weibo-hotsearch-rank text-red-500 font-bold">${index + 1}</div>
                            <div class="weibo-hotsearch-content flex-1">
                                <div class="weibo-hotsearch-title font-medium">${item.title}</div>
                                <div class="weibo-hotsearch-info flex items-center gap-2 mt-1">
                                    <div class="weibo-hotsearch-heat text-xs text-red-500">ã€${this.formatNumber(item.heat)}ã€‘</div>
                                    <div class="weibo-hotsearch-category text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">${item.category}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            renderFallbackHotsearch: function () {
                // Fallback hot search data
                const mockHotSearch = [
                    { title: 'æµ‹è¯•çƒ­æœ1', heat: Math.floor(Math.random() * 2500000) + 500000, category: 'å¨±ä¹' },
                    { title: 'æµ‹è¯•çƒ­æœ2', heat: Math.floor(Math.random() * 2500000) + 500000, category: 'ç§‘æŠ€' },
                    { title: 'æµ‹è¯•çƒ­æœ3', heat: Math.floor(Math.random() * 2500000) + 500000, category: 'ä½“è‚²' },
                    { title: 'æµ‹è¯•çƒ­æœ4', heat: Math.floor(Math.random() * 2500000) + 500000, category: 'ç¤¾ä¼š' },
                    { title: 'æµ‹è¯•çƒ­æœ5', heat: Math.floor(Math.random() * 2500000) + 500000, category: 'ç”Ÿæ´»' }
                ];
                this.renderHotsearchList(mockHotSearch);
            },

            renderMessages: function () {
                // Render messages
                const container = document.getElementById('message-list');
                if (!container) return;

                // Mock message data
                const mockMessages = [
                    { id: 1, user: { name: 'æµ‹è¯•ç”¨æˆ·1', avatar: '' }, content: 'ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ', unread: true, timestamp: Date.now() - Math.floor(Math.random() * 86400000) },
                    { id: 2, user: { name: 'æµ‹è¯•ç”¨æˆ·2', avatar: '' }, content: 'ä»Šå¤©å¤©æ°”çœŸå¥½ï¼', unread: false, timestamp: Date.now() - Math.floor(Math.random() * 86400000) }
                ];

                let html = '';
                mockMessages.forEach(msg => {
                    html += `
                        <div class="weibo-message-item flex items-center gap-3 p-3 bg-white rounded-lg shadow-sm mb-3 cursor-pointer hover:bg-gray-50 transition-colors"
                             onclick="WeiboUI.openChat(${msg.id}, '${msg.user.name}', '${msg.user.avatar}')">
                            <div class="weibo-message-avatar w-12 h-12 rounded-full bg-gray-200 overflow-hidden relative">
                                <img src="${msg.user.avatar}" class="w-full h-full object-cover">
                                ${msg.unread ? '<div class="weibo-message-unread-dot absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full"></div>' : ''}
                            </div>
                            <div class="weibo-message-content flex-1">
                                <div class="flex justify-between items-center">
                                    <div class="weibo-message-username font-bold">${msg.user.name}</div>
                                </div>
                                <div class="weibo-message-text text-sm text-gray-600 truncate">${msg.content}</div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            openChat: function (userId, username, avatar) {
                // Open chat interface
                this.currentChatUserId = userId;
                this.currentChatUsername = username;
                this.currentChatUserAvatar = avatar;

                // Update chat header
                document.getElementById('chat-username').textContent = username;

                // Show chat interface and hide message list
                document.getElementById('weibo-message').classList.add('hidden');
                document.getElementById('weibo-chat').classList.remove('hidden');

                // Load chat messages
                this.loadChatMessages();
            },

            backToMessageList: function () {
                // Go back to message list
                document.getElementById('weibo-chat').classList.add('hidden');
                document.getElementById('weibo-message').classList.remove('hidden');

                // Reset current chat info
                this.currentChatUserId = null;
                this.currentChatUsername = null;
                this.currentChatUserAvatar = null;
            },

            loadChatMessages: function () {
                // Load chat messages
                const container = document.getElementById('chat-messages');
                if (!container) return;

                // Mock chat messages
                const mockChatMessages = [
                    { id: 1, sender: 'other', content: 'ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ', timestamp: Date.now() - 3600000 },
                    { id: 2, sender: 'me', content: 'æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢ï¼', timestamp: Date.now() - 3500000 },
                    { id: 3, sender: 'other', content: 'ä»Šå¤©å¤©æ°”çœŸä¸é”™ï¼Œé€‚åˆå‡ºå»èµ°èµ°ã€‚', timestamp: Date.now() - 3400000 }
                ];

                let html = '';
                mockChatMessages.forEach(msg => {
                    if (msg.sender === 'me') {
                        html += `
                            <div class="flex justify-end">
                                <div class="max-w-[70%]">
                                    <div class="bg-red-500 text-white p-3 rounded-lg rounded-br-none">${msg.content}</div>
                                    <div class="text-xs text-gray-500 text-right mt-1">${this.formatTime(msg.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="flex">
                                <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden mr-2 flex-shrink-0">
                                    <img src="${this.currentChatUserAvatar}" class="w-full h-full object-cover">
                                </div>
                                <div class="max-w-[70%]">
                                    <div class="bg-white p-3 rounded-lg rounded-bl-none shadow-sm">${msg.content}</div>
                                    <div class="text-xs text-gray-500 text-left mt-1">${this.formatTime(msg.timestamp)}</div>
                                </div>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html;
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            },

            sendChatMessage: function () {
                // Send chat message
                const input = document.getElementById('weibo-chat-input');
                const content = input.value.trim();
                if (!content) return;

                // Add message to chat
                this.addChatMessage('me', content, Date.now());

                // Clear input
                input.value = '';
            },

            addChatMessage: function (sender, content, timestamp) {
                // Add message to chat interface
                const container = document.getElementById('chat-messages');
                if (!container) return;

                let html = '';
                if (sender === 'me') {
                    html = `
                        <div class="flex justify-end">
                            <div class="max-w-[70%]">
                                <div class="bg-red-500 text-white p-3 rounded-lg rounded-br-none">${content}</div>
                                <div class="text-xs text-gray-500 text-right mt-1">${this.formatTime(timestamp)}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="flex">
                            <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden mr-2 flex-shrink-0">
                                <img src="${this.currentChatUserAvatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="max-w-[70%]">
                                <div class="bg-white p-3 rounded-lg rounded-bl-none shadow-sm">${content}</div>
                                <div class="text-xs text-gray-500 text-left mt-1">${this.formatTime(timestamp)}</div>
                            </div>
                        </div>
                    `;
                }

                container.insertAdjacentHTML('beforeend', html);
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            },

            // è§¦å‘AIå“åº” (ç”¨äºç³»ç»Ÿäº‹ä»¶å¦‚ç‚¹æ­Œã€åˆ†äº«ç­‰)
            triggerAIResponse: function () {
                const generateBtn = document.getElementById('generate-btn');
                if (generateBtn && generateBtn.disabled) return;

                setTimeout(() => {
                    // ç¡®ä¿å½“å‰è¿˜åœ¨èŠå¤©ç•Œé¢
                    const currentId = document.getElementById('subpage-chat-detail')?.dataset.charId;
                    if (currentId) {
                        WeChatUI.generateChatReply();
                    }
                }, 500);
            },

            generateChatReply: function () {
                // AIç”ŸæˆèŠå¤©å›å¤
                const input = document.getElementById('weibo-chat-input');
                const generateBtn = event ? event.target : null;
                let originalText = '';

                // Disable generate button if available
                if (generateBtn) {
                    originalText = generateBtn.innerHTML;
                    generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                    generateBtn.disabled = true;
                    generateBtn.style.opacity = '0.7';
                }

                // Get current chat messages for context
                const messagesContainer = document.getElementById('chat-messages');
                const messageElements = messagesContainer.querySelectorAll('.flex');
                const messages = Array.from(messageElements).map(el => {
                    const isMe = el.classList.contains('justify-end');
                    const content = el.querySelector('div > div:first-child').textContent;
                    return {
                        role: isMe ? 'user' : 'assistant',
                        content: content
                    };
                });

                // è·å–æœ€åä¸€æ¬¡å¿ƒå£°å†…å®¹
                let lastInnerVoiceContent = '';
                try {
                    const cid = WeChatUI.currentChatId;
                    if (cid) {
                        const chars = AppStorage.get('wechat_chars', {});
                        const char = chars[cid];
                        if (char && char.inner_voice_cards && char.inner_voice_cards.length > 0) {
                            const lastCard = char.inner_voice_cards[char.inner_voice_cards.length - 1];
                            if (lastCard && lastCard.text) {
                                lastInnerVoiceContent = lastCard.text;
                            }
                        }
                    }
                } catch (e) {
                    console.error('è·å–å¿ƒå£°å¤±è´¥:', e);
                }

                // æ„å»ºAIæç¤º
                const aiMessages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªè‡ªç„¶æµç•…çš„èŠå¤©å›å¤ä¸“å®¶ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆè‡ªç„¶ã€å‹å¥½çš„å›å¤å†…å®¹ã€‚
                        1. å›å¤è¦ç¬¦åˆå½“å‰èŠå¤©çš„è¯­å¢ƒ
                        2. å›å¤è¦è‡ªç„¶ã€å‹å¥½ã€ç¬¦åˆæ—¥å¸¸èŠå¤©çš„è¯­æ°”
                        3. å›å¤è¦ç®€æ´æ˜äº†ï¼Œä¸è¦å¤ªé•¿
                        4. å›å¤è¦ç¬¦åˆ${this.currentChatUsername}çš„èº«ä»½å’Œå½“å‰èŠå¤©å†…å®¹
                        5. ä¸è¦ä½¿ç”¨ä»»ä½•ç‰¹æ®Šæ ¼å¼æ ‡è®°
                        ${lastInnerVoiceContent ? `\n[é‡è¦ä¸Šä¸‹æ–‡] ä¸Šä¸€æ¬¡çš„å¿ƒå£°å†…å®¹: "${lastInnerVoiceContent}"ã€‚è¯·æ³¨æ„ï¼šå¿ƒå£°åæ˜ äº†è§’è‰²å½“æ—¶çš„çœŸå®æƒ³æ³•å’Œæ‰€å¤„ç¯å¢ƒï¼Œè¯·æ ¹æ®æ­¤å¿ƒå£°å†…å®¹çš„é€»è¾‘ç»§ç»­å¯¹è¯ï¼Œç¡®ä¿ç¯å¢ƒã€çŠ¶æ€å’Œå‰§æƒ…çš„è¿è´¯æ€§ã€‚` : ''}`
                    },
                    ...messages
                ];

                // è°ƒç”¨AIæ¨¡å‹
                SettingsLogic.generateLLM(aiMessages, 'weibo_chat').then(reply => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (generateBtn) {
                        generateBtn.innerHTML = originalText;
                        generateBtn.disabled = false;
                        generateBtn.style.opacity = '1';
                    }

                    // å¤„ç†AIè¿”å›çš„å›å¤
                    let generatedReply = reply.trim();
                    // ç§»é™¤å¯èƒ½çš„markdownæ ¼å¼
                    generatedReply = generatedReply.replace(/^#+/gm, '');
                    generatedReply = generatedReply.replace(/\*\*(.*?)\*\*/g, '$1');
                    generatedReply = generatedReply.replace(/\*(.*?)\*/g, '$1');

                    // ========================================================
                    // ã€å…³é”®ä¿®å¤ã€‘åœ¨æ­¤å¤„æ‹¦æˆªå¹¶å¤„ç†AIçš„æ”¯ä»˜æŒ‡ä»¤ï¼Œé˜²æ­¢æŒ‡ä»¤æ˜¾ç¤ºåœ¨æ°”æ³¡ä¸­
                    // ========================================================

                    // ã€å…³é”®ä¿®å¤ã€‘æ£€æµ‹æ˜¯å¦è¿”å›äº† JSON å¯¹è±¡å­—ç¬¦ä¸² (é’ˆå¯¹æˆªå›¾ä¸­çš„ Bug)
                    // å¦‚æœ AI è¿”å›äº† {"role": "assistant", "content": "..."} æ ¼å¼ï¼Œå¿…é¡»æå– content
                    // ===========================
                    if (generatedReply.trim().startsWith('{') && generatedReply.includes('"content"')) {
                        try {
                            const parsed = JSON.parse(generatedReply);
                            if (parsed.content) {
                                generatedReply = parsed.content;
                                console.log('[WeChatUI] Detected JSON response, extracted content:', generatedReply);
                            }
                        } catch (e) {
                            // å°è¯•ç”¨æ­£åˆ™æå– content
                            const contentMatch = generatedReply.match(/"content"\s*:\s*"([\s\S]*?)"/);
                            if (contentMatch) {
                                generatedReply = contentMatch[1];
                                // å¤„ç†å¯èƒ½çš„è½¬ä¹‰å­—ç¬¦
                                generatedReply = generatedReply.replace(/\\"/g, '"').replace(/\\n/g, '\n');
                                console.log('[WeChatUI] RegEx extracted content:', generatedReply);
                            }
                        }
                    }

                    // 1. å®šä¹‰è§£æIDçš„è¾…åŠ©å‡½æ•°
                    const parsePaymentId = (idStr) => {
                        const str = String(idStr).trim();
                        if (/^\d+$/.test(str)) return parseInt(str);
                        if (str.includes('_')) {
                            const parts = str.split('_');
                            const last = parts[parts.length - 1];
                            if (/^\d+$/.test(last)) return parseInt(last);
                        }
                        const matches = str.match(/\d+/g);
                        if (matches && matches.length > 0) return parseInt(matches[matches.length - 1]);
                        return parseInt(str);
                    };

                    // 2. æ£€æµ‹æŒ‡ä»¤ (å…¼å®¹å„ç§å¥‡æ€ªæ ¼å¼ï¼ŒåŒ…æ‹¬æ¢è¡Œå’Œç©ºæ ¼)
                    // ä½¿ç”¨ \s* å…è®¸æ ‡ç­¾å†…éƒ¨å‡ºç°ç©ºæ ¼æˆ–æ¢è¡Œ
                    const acceptTransferMatch = generatedReply.match(/\[\s*é¢†å–\s*è½¬è´¦\s*[:ï¼š]\s*([^\]]+)\s*\]/);
                    const rejectTransferMatch = generatedReply.match(/\[\s*æ‹’æ”¶\s*è½¬è´¦\s*[:ï¼š]\s*([^\]]+)\s*\]/);
                    const acceptRedpacketMatch = generatedReply.match(/\[\s*é¢†å–\s*çº¢åŒ…\s*[:ï¼š]\s*([^\]]+)\s*\]/);
                    const rejectRedpacketMatch = generatedReply.match(/\[\s*æ‹’æ”¶\s*çº¢åŒ…\s*[:ï¼š]\s*([^\]]+)\s*\]/);

                    if (acceptTransferMatch || rejectTransferMatch || acceptRedpacketMatch || rejectRedpacketMatch) {
                        try {
                            const cid = WeChatUI.currentChatId;
                            if (cid) {
                                const chars = AppStorage.get('wechat_chars', {});
                                const char = chars[cid];
                                if (char && char.msgs) {
                                    let paymentType, action, rawId;
                                    if (acceptTransferMatch) { paymentType = 'transfer'; action = 'received'; rawId = acceptTransferMatch[1]; }
                                    else if (rejectTransferMatch) { paymentType = 'transfer'; action = 'rejected'; rawId = rejectTransferMatch[1]; }
                                    else if (acceptRedpacketMatch) { paymentType = 'redpacket'; action = 'received'; rawId = acceptRedpacketMatch[1]; }
                                    else if (rejectRedpacketMatch) { paymentType = 'redpacket'; action = 'rejected'; rawId = rejectRedpacketMatch[1]; }

                                    const paymentId = parsePaymentId(rawId);
                                    console.log(`[ChatReply] Detected payment action: ${action} ${paymentType}, ID: ${paymentId}`);

                                    // æŸ¥æ‰¾ç›®æ ‡æ¶ˆæ¯ (å…è®¸ç±»å‹æ··ç”¨ï¼ŒIDåŒ¹é…å³å¯ï¼Œè§£å†³AIåˆ†ä¸æ¸…çº¢åŒ…å’Œè½¬è´¦çš„é—®é¢˜)
                                    const targetPayment = char.msgs.find(m =>
                                        (m.type === 'transfer' || m.type === 'redpacket') && m.role === 'user' && m.paymentId === paymentId
                                    );

                                    if (targetPayment && !targetPayment.status) {
                                        WeChatUI.handleAIReceivedPayment(cid, targetPayment, action);
                                        console.log('[ChatReply] Payment action executed successfully');
                                    } else {
                                        console.warn('[ChatReply] Target payment not found or already processed', paymentId);
                                    }
                                }
                            }
                        } catch (err) {
                            console.error('[ChatReply] Error handling payment action:', err);
                        }
                    }

                    // 3. å¼ºåŠ›æ¸…æ´—æ‰€æœ‰æŒ‡ä»¤æ®‹ç•™ (åŒ…æ‹¬hallucinationsï¼Œæ”¯æŒè·¨è¡Œæ¸…æ´—)
                    generatedReply = generatedReply.replace(/\[\s*Payment\s*Interaction\s*\](:\s*)?/gi, '');
                    generatedReply = generatedReply.replace(/(Receive|Reject)\s*=\s*\[([^\]]+)\]/gi, '');
                    // ã€ä¿®å¤ã€‘å¢å¼ºæ­£åˆ™ï¼Œæ”¯æŒ ### åˆ†éš”ç¬¦å’Œå¤šä½™çš„æŸäº›å­—ç¬¦
                    generatedReply = generatedReply.replace(/\[\s*(é¢†å–|æ‹’æ”¶)\s*(è½¬è´¦|çº¢åŒ…)\s*[:ï¼š][\s\S]*?\]/g, '');
                    generatedReply = generatedReply.replace(/###/g, ''); // ç§»é™¤å¯èƒ½çš„åˆ†éš”ç¬¦
                    generatedReply = generatedReply.trim();

                    // å¦‚æœæ¸…æ´—åä¸ºç©º (AIåªå‘äº†æŒ‡ä»¤)ï¼Œåˆ™ä¸æ˜¾ç¤ºç©ºæ°”æ³¡ (æˆ–è€…æ˜¾ç¤ºä¸€ä¸ªé»˜è®¤å›å¤?)
                    if (!generatedReply) {
                        console.log('[ChatReply] Reply matches clean instruction, hiding bubble.');
                        return;
                    }
                    // ========================================================

                    // æ·»åŠ AIç”Ÿæˆçš„å›å¤åˆ°èŠå¤©
                    this.addChatMessage('other', generatedReply, Date.now());
                }).catch(error => {
                    console.error('ç”Ÿæˆå›å¤å¤±è´¥:', error);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (generateBtn) {
                        generateBtn.innerHTML = originalText;
                        generateBtn.disabled = false;
                        generateBtn.style.opacity = '1';
                    }
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    this.showToast('å›å¤ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            },

            formatTime: function (timestamp) {
                // Format timestamp to readable time
                const date = new Date(timestamp);
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            },

            renderProfile: function () {
                // Render profile data
                document.getElementById('profile-username').textContent = this.data.user.name;
                document.getElementById('profile-bio').textContent = this.data.user.bio || '';
                document.getElementById('profile-avatar').src = this.data.user.avatar || '';
                document.getElementById('profile-posts').textContent = this.data.user.posts;
                document.getElementById('profile-following').textContent = this.data.user.following;
                document.getElementById('profile-followers').textContent = this.data.user.followers;
            },

            startRandomFollowerMechanism: function () {
                // Start random follower mechanism if not already started
                if (this.randomFollowerInterval) {
                    clearInterval(this.randomFollowerInterval);
                }

                // Run every 10 minutes
                this.randomFollowerInterval = setInterval(() => {
                    this.updateRandomFollowers();
                }, 600000);
            },

            updateRandomFollowers: function () {
                // Update followers randomly
                const chance = Math.random();
                let change = 0;

                if (chance < 0.3) {
                    // 30% chance to gain followers (1-999)
                    change = Math.floor(Math.random() * 999) + 1;
                } else if (chance < 0.4) {
                    // 10% chance to lose followers (1-999)
                    change = -Math.floor(Math.random() * 999) - 1;
                }

                // Update followers count
                this.data.user.followers = Math.max(0, this.data.user.followers + change);

                // Save data
                this.saveData();

                // Update profile display if currently viewing profile
                if (this.currentMainTab === 'profile') {
                    this.renderProfile();
                }

                // Show toast notification for all changes
                if (change !== 0) {
                    this.showToast(change > 0 ? `è·å¾—äº†${change}ä¸ªæ–°ç²‰ä¸ï¼` : `å¤±å»äº†${Math.abs(change)}ä¸ªç²‰ä¸`);
                }
            },

            generateContent: function () {
                // AIç”Ÿæˆå¾®åšå†…å®¹
                const container = document.getElementById(`weibo-${this.currentDiscoveryTab}-content`);
                if (!container) return;

                // 1. æ£€æŸ¥ API é…ç½®
                const apiConfigs = AppStorage.get('api_configs', []);
                const currentApiId = AppStorage.get('current_api_id', 'default');
                const apiConfig = apiConfigs.find(c => c.id === currentApiId) || {};

                if (!apiConfig.key || !apiConfig.url) {
                    this.showToast('è¯·å…ˆåœ¨"è®¾ç½®-APIè¿æ¥"ä¸­é…ç½®å¤§æ¨¡å‹');
                    return;
                }

                // åˆ›å»ºä¸´æ—¶åŠ è½½æŒ‡ç¤ºå™¨
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'weibo-post bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-center items-center';
                loadingDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin text-red-500"></i><span class="text-gray-600">æ­£åœ¨è¿æ¥ AI ç”Ÿæˆå¾®åš...</span></div>`;
                // æ”¹ä¸º prependï¼Œè®©æ–°ç”Ÿæˆçš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
                container.prepend(loadingDiv);

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšå†…å®¹ç”Ÿæˆä¸“å®¶ï¼Œè¯·ç”Ÿæˆ5-8æ¡ç¬¦åˆè¦æ±‚çš„å¾®åšå†…å®¹ï¼š
                        1. å†…å®¹ç±»å‹ï¼š
                            - 40%æ˜¯å…³æ³¨å†…å®¹ï¼ˆç±»ä¼¼æœ‹å‹åœˆçš„ä¸ªäººåŠ¨æ€ï¼‰
                            - 60%æ˜¯æ¨èå†…å®¹ï¼ˆä¸åŒé¢†åŸŸçš„çƒ­é—¨è¯é¢˜ï¼‰
                        2. å†…å®¹è¦æ±‚ï¼š
                            - æ¯æ¡å¾®åšå†…å®¹ç®€æ´æœ‰è¶£ï¼Œç¬¦åˆå¾®åšé£æ ¼
                            - é•¿åº¦é€‚ä¸­ï¼Œä¸è¶…è¿‡140å­—
                            - å†…å®¹è¦è‡ªç„¶ï¼Œç¬¦åˆçœŸå®ç”¨æˆ·çš„å‘å¸ƒä¹ æƒ¯
                            - å†…å®¹è¦æœ‰ç›¸åº”çš„è¯é¢˜æ ‡ç­¾
                        3. è¾“å‡ºæ ¼å¼ï¼šçº¯JSONæ ¼å¼ (ä¸è¦ç”¨markdownä»£ç å—)ï¼ŒåŒ…å«postsæ•°ç»„ï¼Œæ¯ä¸ªpostå¯¹è±¡åŒ…å«ï¼š
                            - user: { name: ç”¨æˆ·å, avatar: å¤´åƒURL, tag: è¯é¢˜æ ‡ç­¾ }
                            - content: å¾®åšå†…å®¹
                            - likes: éšæœºç‚¹èµæ•°ï¼ˆ500-1000000ï¼‰
                            - comments: éšæœºè¯„è®ºæ•°ï¼ˆ50-10000ï¼‰
                            - reposts: éšæœºè½¬å‘æ•°ï¼ˆ100-500000ï¼‰
                            - timestamp: å‘å¸ƒæ—¶é—´ï¼ˆå½“å‰æ—¶é—´å‡å»éšæœºå¤©æ•°ï¼‰
                        4. ç¤ºä¾‹è¾“å‡ºï¼š
                        {
                            "posts": [
                                {
                                    "user": { "name": "æµ‹è¯•ç”¨æˆ·1", "avatar": "", "tag": "#ç¾é£Ÿæ¢åº—#" },
                                    "content": "ä»Šå¤©åƒäº†å¥½åƒçš„ç«é”…ï¼Œæ¨èç»™å¤§å®¶ï¼",
                                    "likes": 12345,
                                    "comments": 678,
                                    "reposts": 9012,
                                    "timestamp": 1700000000000
                                }
                            ]
                        }`
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹ç”Ÿæˆå†…å®¹
                SettingsLogic.generateLLM(messages, 'weibo').then(reply => {
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    loadingDiv.remove();

                    try {
                        // è§£æAIè¿”å›çš„JSON (å¢å¼ºå®¹é”™)
                        let cleanJson = reply.replace(/```json/g, '').replace(/```/g, '').trim();
                        // å°è¯•æå–æœ€å¤–å±‚çš„å¤§æ‹¬å·
                        const jsonStart = cleanJson.indexOf('{');
                        const jsonEnd = cleanJson.lastIndexOf('}');
                        if (jsonStart !== -1 && jsonEnd !== -1) {
                            cleanJson = cleanJson.substring(jsonStart, jsonEnd + 1);
                        }

                        let generatedData = JSON.parse(cleanJson);

                        if (generatedData && generatedData.posts) {
                            // å°†ç”Ÿæˆçš„å†…å®¹æ·»åŠ åˆ°æ•°æ®ä¸­
                            generatedData.posts.forEach(post => {
                                this.data.posts.unshift(post);
                            });

                            // ä¿å­˜æ•°æ®
                            this.saveData();

                            // é‡æ–°æ¸²æŸ“å†…å®¹
                            this.renderContent();

                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            this.showToast(`æˆåŠŸç”Ÿæˆ ${generatedData.posts.length} æ¡å¾®åš`);
                        } else {
                            throw new Error('æ— æ•ˆçš„JSONæ ¼å¼');
                        }
                    } catch (error) {
                        console.error('è§£æAIç”Ÿæˆå†…å®¹å¤±è´¥:', error, reply);
                        this.showToast('ç”Ÿæˆå¤±è´¥ï¼ŒAIè¿”å›äº†æ— æ³•è§£æçš„å†…å®¹');
                    }
                }).catch(error => {
                    console.error('ç”Ÿæˆå†…å®¹å¤±è´¥:', error);
                    loadingDiv.remove();
                    this.showToast('APIè¯·æ±‚å¤±è´¥: ' + error.message);
                });
            },

            openPublishModal: function () {
                // Open publish modal
                const modal = document.getElementById('weibo-publish-modal');
                modal.classList.remove('hidden');

                // Initialize image upload event listener
                document.getElementById('publish-image-upload').onchange = (e) => this.handleImageUpload(e);
            },

            closePublishModal: function () {
                // Close publish modal
                const modal = document.getElementById('weibo-publish-modal');
                modal.classList.add('hidden');
                document.getElementById('publish-content').value = '';
                document.getElementById('publish-word-count').textContent = '0/140';

                // Clear image preview
                document.getElementById('publish-image-preview').innerHTML = '';

                // Hide emoji picker
                document.getElementById('publish-emoji-picker').classList.add('hidden');
            },

            handleImageUpload: function (e) {
                // Handle image upload
                const files = e.target.files;
                if (!files || files.length === 0) return;

                const previewContainer = document.getElementById('publish-image-preview');

                // Add images to preview
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageDiv = document.createElement('div');
                        imageDiv.className = 'relative aspect-square bg-gray-200 rounded-lg overflow-hidden';
                        imageDiv.innerHTML = `
                            <img src="${event.target.result}" class="w-full h-full object-cover">
                            <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 transition-colors">
                                <i class="fa-solid fa-xmark text-xs"></i>
                            </button>
                        `;
                        previewContainer.appendChild(imageDiv);
                    };
                    reader.readAsDataURL(file);
                });
            },

            toggleEmojiPicker: function () {
                // Toggle emoji picker
                const picker = document.getElementById('publish-emoji-picker');
                picker.classList.toggle('hidden');
            },

            insertEmoji: function (emoji) {
                // Insert emoji into textarea
                const textarea = document.getElementById('publish-content');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const value = textarea.value;

                // Insert emoji at cursor position
                textarea.value = value.substring(0, start) + emoji + value.substring(end);

                // Update word count
                this.updateWordCount();

                // Hide emoji picker
                this.toggleEmojiPicker();
            },

            addLocation: function () {
                // Add location to post (mock functionality)
                const locations = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½'];
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                const textarea = document.getElementById('publish-content');

                // Add location tag to content
                textarea.value += ` ${randomLocation} Â· `;
                this.updateWordCount();
            },

            generateAIImage: function () {
                // Generate AI image based on content
                const content = document.getElementById('publish-content').value.trim();
                if (!content) {
                    this.showToast('è¯·å…ˆè¾“å…¥å†…å®¹');
                    return;
                }

                // Create loading indicator
                const generateBtn = event.target.closest('button');
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ç”Ÿæˆä¸­...';
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.7';

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªAIå›¾åƒç”Ÿæˆä¸“å®¶ï¼Œè¯·æ ¹æ®å¾®åšå†…å®¹ç”Ÿæˆç›¸å…³çš„å›¾ç‰‡æè¿°ï¼š
                        1. æè¿°è¦ç®€æ´æ˜äº†
                        2. æè¿°è¦ç¬¦åˆå¾®åšå†…å®¹çš„ä¸»é¢˜
                        3. æè¿°è¦é€‚åˆç”Ÿæˆé«˜è´¨é‡çš„å›¾ç‰‡
                        4. è¾“å‡ºæ ¼å¼ï¼šç›´æ¥è¾“å‡ºæè¿°ï¼Œä¸è¦åŒ…å«ä»»ä½•æ ‡è®°`
                    },
                    {
                        role: 'user',
                        content: `å¾®åšå†…å®¹ï¼š${content}`
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹ç”Ÿæˆå›¾ç‰‡æè¿°
                SettingsLogic.generateLLM(messages, 'weibo_image').then(description => {
                    // è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„å›¾ç‰‡ç”ŸæˆAPI
                    // ç›®å‰ä½¿ç”¨mockå›¾ç‰‡
                    const mockImages = [
                        'https://via.placeholder.com/300x300?text=AI+Image+1',
                        'https://via.placeholder.com/300x300?text=AI+Image+2',
                        'https://via.placeholder.com/300x300?text=AI+Image+3'
                    ];
                    const randomImage = mockImages[Math.floor(Math.random() * mockImages.length)];

                    // Add generated image to preview
                    const previewContainer = document.getElementById('publish-image-preview');
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'relative aspect-square bg-gray-200 rounded-lg overflow-hidden';
                    imageDiv.innerHTML = `
                        <img src="${randomImage}" class="w-full h-full object-cover">
                        <button onclick="this.parentElement.remove()" class="absolute top-1 right-1 w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 transition-colors">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </button>
                    `;
                    previewContainer.appendChild(imageDiv);

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';

                    this.showToast('AIé…å›¾ç”ŸæˆæˆåŠŸ');
                }).catch(error => {
                    console.error('ç”ŸæˆAIé…å›¾å¤±è´¥:', error);
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';
                    this.showToast('AIé…å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            },

            generatePostContent: function () {
                // AIç”Ÿæˆå¾®åšå†…å®¹
                const textarea = document.getElementById('publish-content');
                const wordCount = document.getElementById('publish-word-count');

                // è·å–å½“å‰è¾“å…¥çš„å†…å®¹ä½œä¸ºå‚è€ƒ
                const currentContent = textarea.value.trim();

                // åˆ›å»ºä¸´æ—¶åŠ è½½æŒ‡ç¤ºå™¨
                const generateBtn = event.target;
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ç”Ÿæˆä¸­...';
                generateBtn.disabled = true;
                generateBtn.style.opacity = '0.7';

                // æ„å»ºAIæç¤º
                let prompt = `ä½ æ˜¯ä¸€ä¸ªå¾®åšå†…å®¹ç”Ÿæˆä¸“å®¶ï¼Œè¯·ç”Ÿæˆä¸€æ¡ç¬¦åˆè¦æ±‚çš„å¾®åšå†…å®¹ï¼š
                1. å†…å®¹è¦æ±‚ï¼š
                    - å†…å®¹ç®€æ´æœ‰è¶£ï¼Œç¬¦åˆå¾®åšé£æ ¼
                    - é•¿åº¦é€‚ä¸­ï¼Œä¸è¶…è¿‡140å­—
                    - å†…å®¹è‡ªç„¶ï¼Œç¬¦åˆçœŸå®ç”¨æˆ·çš„å‘å¸ƒä¹ æƒ¯
                    - å†…å®¹è¦æœ‰ç›¸åº”çš„è¯é¢˜æ ‡ç­¾
                2. è¾“å‡ºæ ¼å¼ï¼šç›´æ¥è¾“å‡ºå¾®åšå†…å®¹ï¼Œä¸è¦åŒ…å«å…¶ä»–æ ¼å¼
                3. ç¤ºä¾‹è¾“å‡ºï¼šä»Šå¤©åƒäº†å¥½åƒçš„ç«é”…ï¼Œæ¨èç»™å¤§å®¶ï¼#ç¾é£Ÿæ¢åº—#`;

                if (currentContent) {
                    prompt += `
                4. å‚è€ƒå†…å®¹ï¼š${currentContent}
                    - å¦‚æœå‚è€ƒå†…å®¹ä¸ä¸ºç©ºï¼Œè¯·åŸºäºå‚è€ƒå†…å®¹ç”Ÿæˆç›¸å…³çš„å¾®åšå†…å®¹`;
                }

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: prompt
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹ç”Ÿæˆå†…å®¹
                SettingsLogic.generateLLM(messages, 'weibo_post', 'weibo').then(reply => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';

                    // å¤„ç†AIè¿”å›çš„å†…å®¹
                    let generatedContent = reply.trim();
                    // ç§»é™¤å¯èƒ½çš„markdownæ ¼å¼
                    generatedContent = generatedContent.replace(/^#+\s+/gm, '');
                    generatedContent = generatedContent.replace(/\*\*(.*?)\*\*/g, '$1');
                    generatedContent = generatedContent.replace(/\*(.*?)\*/g, '$1');
                    // æå–çº¯æ–‡æœ¬å†…å®¹
                    const textMatch = generatedContent.match(/^[\s\S]*$/);
                    if (textMatch) {
                        generatedContent = textMatch[0].trim();
                    }

                    // å°†ç”Ÿæˆçš„å†…å®¹å¡«å……åˆ°å‘å¸ƒæ¡†
                    textarea.value = generatedContent;
                    // æ›´æ–°å­—æ•°ç»Ÿè®¡
                    const count = generatedContent.length;
                    wordCount.textContent = `${count}/140`;
                }).catch(error => {
                    console.error('ç”Ÿæˆå¾®åšå†…å®¹å¤±è´¥:', error);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    this.showToast('å†…å®¹ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            },

            publishPost: function () {
                // Publish post
                const content = document.getElementById('publish-content').value.trim();
                if (!content) return;

                // Create new post
                const newPost = {
                    id: Date.now(),
                    user: {
                        name: this.data.user.name,
                        avatar: this.data.user.avatar,
                        tag: '#ä¸ªäººåŠ¨æ€#'
                    },
                    content: content,
                    likes: Math.floor(Math.random() * 1000000) + 500,
                    comments: Math.floor(Math.random() * 10000) + 50,
                    reposts: Math.floor(Math.random() * 500000) + 100,
                    timestamp: Date.now()
                };

                // Add to posts
                this.data.posts.unshift(newPost);
                this.data.user.posts++;
                this.saveData();

                // Close modal
                this.closePublishModal();

                // Show success message
                this.showToast('å‘å¸ƒæˆåŠŸ');

                // Update profile content if needed
                if (this.currentMainTab === 'profile') {
                    this.renderContent();
                }
            },

            searchHotsearch: function () {
                // AIæœç´¢ç›¸å…³å†…å®¹
                const keyword = document.getElementById('hotsearch-input').value.trim();
                if (!keyword) return;

                // åˆ›å»ºæœç´¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ
                const hotsearchListContent = document.getElementById('hotsearch-list-content');
                if (!hotsearchListContent) return;

                // åˆ›å»ºä¸´æ—¶åŠ è½½æŒ‡ç¤ºå™¨
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-center items-center p-8';
                loadingDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin text-red-500"></i><span class="text-gray-600">AIæœç´¢ä¸­...</span></div>`;
                hotsearchListContent.innerHTML = '';
                hotsearchListContent.appendChild(loadingDiv);

                // æ„å»ºAIæç¤º
                const messages = [
                    {
                        role: 'system',
                        content: `ä½ æ˜¯ä¸€ä¸ªå¾®åšæœç´¢ä¸“å®¶ï¼Œè¯·æ ¹æ®å…³é”®è¯ç”Ÿæˆ8-12æ¡ç›¸å…³çš„å¾®åšè®¨è®ºå†…å®¹ï¼š
                        1. å…³é”®è¯ï¼š${keyword}
                        2. å†…å®¹è¦æ±‚ï¼š
                            - æ¯æ¡å†…å®¹æ˜¯ä¸åŒç½‘å‹å¯¹è¯¥å…³é”®è¯çš„è®¨è®º
                            - å†…å®¹è¦è‡ªç„¶ï¼Œç¬¦åˆçœŸå®ç½‘å‹çš„å‘è¨€é£æ ¼
                            - æ¯æ¡å†…å®¹è¦å¤šæ ·åŒ–ï¼Œæ¶µç›–ä¸åŒè§’åº¦çš„è®¨è®º
                            - æ¯æ¡å†…å®¹è¦æœ‰ç›¸åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¤´åƒã€è¯é¢˜æ ‡ç­¾ï¼‰
                            - å†…å®¹è¦ç¬¦åˆå¾®åšè®¨è®ºçš„ç‰¹ç‚¹
                        3. è¾“å‡ºæ ¼å¼ï¼šJSONæ ¼å¼ï¼ŒåŒ…å«postsæ•°ç»„ï¼Œæ¯ä¸ªpostå¯¹è±¡åŒ…å«ï¼š
                            - user: { name: ç”¨æˆ·å, avatar: å¤´åƒURL, tag: è¯é¢˜æ ‡ç­¾ }
                            - content: è®¨è®ºå†…å®¹
                            - likes: éšæœºç‚¹èµæ•°ï¼ˆ1000-500000ï¼‰
                            - comments: éšæœºè¯„è®ºæ•°ï¼ˆ50-5000ï¼‰
                            - reposts: éšæœºè½¬å‘æ•°ï¼ˆ200-200000ï¼‰
                            - timestamp: å‘å¸ƒæ—¶é—´ï¼ˆå½“å‰æ—¶é—´å‡å»éšæœºå°æ—¶æ•°ï¼‰
                        4. ç¤ºä¾‹è¾“å‡ºï¼š
                        {
                            "posts": [
                                {
                                    "user": { "name": "ç½‘å‹1", "avatar": "", "tag": "#${keyword}#" },
                                    "content": "å…³äº${keyword}ï¼Œæˆ‘æœ‰ä¸€äº›çœ‹æ³•...",
                                    "likes": 12345,
                                    "comments": 678,
                                    "reposts": 9012,
                                    "timestamp": 1700000000000
                                }
                            ]
                        }`
                    }
                ];

                // è°ƒç”¨AIæ¨¡å‹ç”Ÿæˆæœç´¢ç»“æœ
                SettingsLogic.generateLLM(messages, 'weibo_search').then(reply => {
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    loadingDiv.remove();

                    try {
                        // è§£æAIè¿”å›çš„JSON
                        let generatedData;
                        if (reply.includes('```json')) {
                            // æå–JSONä»£ç å—
                            const jsonMatch = reply.match(/```json([\s\S]*?)```/);
                            if (jsonMatch) {
                                generatedData = JSON.parse(jsonMatch[1].trim());
                            }
                        } else if (reply.includes('{') && reply.includes('}')) {
                            // å°è¯•ç›´æ¥è§£æJSON
                            generatedData = JSON.parse(reply);
                        }

                        if (generatedData && generatedData.posts) {
                            // æ˜¾ç¤ºæœç´¢ç»“æœ
                            let html = '';
                            generatedData.posts.forEach(post => {
                                html += this.renderPost(post);
                            });
                            hotsearchListContent.innerHTML = html;
                        } else {
                            // æ˜¾ç¤ºæœç´¢ç»“æœä¸ºç©º
                            hotsearchListContent.innerHTML = `<div class="text-center text-gray-500 py-8">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>`;
                        }
                    } catch (error) {
                        console.error('è§£æAIæœç´¢ç»“æœå¤±è´¥:', error);
                        hotsearchListContent.innerHTML = `<div class="text-center text-red-500 py-8">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
                    }
                }).catch(error => {
                    console.error('æœç´¢å¤±è´¥:', error);
                    loadingDiv.remove();
                    hotsearchListContent.innerHTML = `<div class="text-center text-red-500 py-8">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</div>`;
                });
            },

            formatNumber: function (num) {
                // Format number to K/M format
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1) + 'ä¸‡';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'åƒ';
                } else {
                    return num.toString();
                }
            },

            showToast: function (message) {
                // Show toast message
                const toast = document.createElement('div');
                toast.className = 'weibo-toast fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full font-medium z-50';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        };
    </script>

    <!-- Weibo CSS -->
    <style>
        /* Weibo Main Tab Styles */
        .weibo-main-tab {
            color: #666;
            transition: all 0.3s ease;
        }

        .weibo-main-tab.active {
            color: #e53e3e;
        }

        /* Weibo Discovery Tab Styles */
        .weibo-discovery-tab {
            position: relative;
            color: #666;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .weibo-discovery-tab.active {
            color: #e53e3e;
        }

        .weibo-tab-indicator {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: #e53e3e;
            border-radius: 3px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .weibo-discovery-tab.active .weibo-tab-indicator {
            opacity: 1;
        }

        /* Weibo Discovery Buttons */
        .weibo-discovery-buttons {
            top: 14px;
            right: 4px;
        }

        /* Weibo Content Area */
        .weibo-content-area {
            padding-top: 20px;
        }

        /* Weibo Post Styles */
        .weibo-post {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .weibo-post-stat-item {
            transition: all 0.3s ease;
        }

        /* Weibo Hot Search Styles */
        .weibo-search-box {
            max-width: 300px;
        }

        .weibo-hotsearch-item {
            transition: all 0.3s ease;
        }

        .weibo-hotsearch-heat {
            color: #e53e3e;
        }

        /* Weibo Message Styles */
        .weibo-message-unread-dot {
            width: 6px;
            height: 6px;
            background-color: #e53e3e;
            border-radius: 50%;
        }

        /* Weibo Profile Styles */
        .weibo-profile-tab {
            color: #666;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .weibo-profile-tab.active {
            color: #e53e3e;
            border-bottom: 2px solid #e53e3e;
        }

        /* Weibo Modal Styles */
        .weibo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
        }

        .weibo-modal-overlay.hidden {
            display: none;
        }

        .weibo-modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 500px;
        }

        /* Weibo Toast Styles */
        .weibo-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            animation: weibo-toast-fade 3s ease-in-out;
        }

        @keyframes weibo-toast-fade {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            10% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            90% {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
    </style>
    <!-- ä¿®å¤èŠå¤©èƒŒæ™¯é¢„è§ˆé—®é¢˜ -->
    <script>
        // ç³»ç»Ÿæ—¥å¿—åº”ç”¨æ ¸å¿ƒé€»è¾‘
        window.SystemLog = {
            logs: [],
            currentFilter: 'all',
            currentTab: 'logs',
            autoScroll: true, // é»˜è®¤å¼€å¯

            // æ ¸å¿ƒè®°å½•å‡½æ•°
            open: () => {
                const appEl = document.getElementById('app-syslogs');
                if (appEl) {
                    appEl.style.display = 'flex';
                    // å¦‚æœæ—¥å¿—ä¸ºç©ºï¼Œå†™å…¥ä¸€æ¡æ¬¢è¿ä¿¡æ¯
                    if (SystemLog.logs.length === 0) {
                        SystemLog.write('SYS', 'ç³»ç»Ÿç›‘è§†å™¨å°±ç»ª', 'ç­‰å¾…åº”ç”¨äº‹ä»¶...');
                    }
                    // é‡ç½®çŠ¶æ€
                    SystemLog.switchTab(SystemLog.currentTab || 'logs');
                    SystemLog.render();
                    if (SystemLog.autoScroll) SystemLog.scrollToBottom();
                }
            },

            write: (type, title, detail = null) => {
                const entry = {
                    id: Date.now() + Math.random(),
                    time: new Date().toLocaleTimeString(),
                    type: type,
                    title: title,
                    detail: detail
                };
                SystemLog.logs.push(entry); // æ”¹ä¸ºpushï¼Œæ–°æ—¥å¿—åœ¨åº•éƒ¨

                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (SystemLog.logs.length > 500) SystemLog.logs.shift();

                // åŒæ—¶ä¹Ÿæ‰“å°åˆ°æµè§ˆå™¨æ§åˆ¶å°
                // console.log(`[${type}] ${title}`, detail || '');

                // å®æ—¶æ¸²æŸ“
                const appEl = document.getElementById('app-syslogs');
                if (appEl && appEl.style.display !== 'none') {
                    if (SystemLog.currentTab === 'logs') {
                        SystemLog.renderLogs();
                    }
                    // ä¸Šä¸‹æ–‡åªåœ¨ç›¸å…³æ—¶æ›´æ–°
                    if (title.includes('ç½‘ç»œè¯·æ±‚') && SystemLog.currentTab === 'context') {
                        SystemLog.renderContext();
                    }
                }
            },

            clearLogs: () => {
                SystemLog.logs = [];
                SystemLog.renderLogs();
                window.Utils.showToast('æ—¥å¿—å·²æ¸…ç©º');
            },

            filter: (type) => {
                SystemLog.currentFilter = type;
                SystemLog.render();
            },

            refresh: () => {
                SystemLog.render();
            },

            export: () => {
                const blob = new Blob([JSON.stringify(SystemLog.logs, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_logs_${Date.now()}.json`;
                a.click();
            },

            toggleAutoScroll: () => {
                SystemLog.autoScroll = !SystemLog.autoScroll;
                const btn = document.getElementById('auto-scroll-btn');
                if (btn) {
                    btn.textContent = `è‡ªåŠ¨æ»šåŠ¨: ${SystemLog.autoScroll ? 'ON' : 'OFF'}`;
                    btn.style.background = SystemLog.autoScroll ? '#0e639c' : '#3c3c3c';
                }
                if (SystemLog.autoScroll) SystemLog.scrollToBottom();
            },

            scrollToBottom: () => {
                const container = document.getElementById('logs-container');
                if (container) {
                    container.scrollTop = container.scrollHeight;
                }
            },

            switchTab: (tabName) => {
                SystemLog.currentTab = tabName;
                document.querySelectorAll('.app-window .flex button[id^="tab-btn-"]').forEach(btn => {
                    if (btn.id === `tab-btn-${tabName}`) {
                        btn.className = "flex-1 py-3 text-sm font-bold text-blue-400 border-b-2 border-blue-400 hover:bg-white/5 transition-colors";
                    } else {
                        btn.className = "flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-white/5 transition-colors";
                    }
                });
                const panelLogs = document.getElementById('panel-logs');
                const panelContext = document.getElementById('panel-context');
                if (panelLogs) panelLogs.style.display = tabName === 'logs' ? 'flex' : 'none';
                if (panelContext) panelContext.style.display = tabName === 'context' ? 'flex' : 'none';

                SystemLog.render();
                if (tabName === 'logs' && SystemLog.autoScroll) SystemLog.scrollToBottom();
            },

            renderContext: () => {
                const container = document.getElementById('context-container');
                if (!container) return;
                // å€’åºæŸ¥æ‰¾æœ€è¿‘è¯·æ±‚
                const lastReq = [...SystemLog.logs].reverse().find(l => l.type === 'AI' && l.title.includes('ç½‘ç»œè¯·æ±‚'));
                if (!lastReq || !lastReq.detail) {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-20">æš‚æ— ä¸Šä¸‹æ–‡æ•°æ®<br>è¯·å…ˆä¸AIè¿›è¡Œä¸€æ¬¡å¯¹è¯</div>';
                    return;
                }
                try {
                    const payload = (typeof lastReq.detail === 'string') ? JSON.parse(lastReq.detail) : lastReq.detail;
                    const messages = payload.messages || [];
                    const params = { model: payload.model, temperature: payload.temperature, max_tokens: payload.max_tokens };
                    let html = `<div class="mb-4 p-2 bg-black/20 rounded border border-gray-700"><div class="text-gray-400 font-bold mb-1 border-b border-gray-600 pb-1">Request Parameters</div><div class="text-green-400 text-[10px] mt-1 whitespace-pre-wrap">${JSON.stringify(params, null, 2)}</div></div>`;
                    messages.forEach((msg, idx) => {
                        let roleColor = 'text-gray-300', roleBg = 'bg-gray-800/50', roleIcon = 'fa-user';
                        if (msg.role === 'system') { roleColor = 'text-red-300'; roleBg = 'bg-red-900/10 border-red-900/30'; roleIcon = 'fa-gear'; }
                        else if (msg.role === 'user') { roleColor = 'text-green-300'; roleBg = 'bg-green-900/10 border-green-900/30'; roleIcon = 'fa-user'; }
                        else if (msg.role === 'assistant') { roleColor = 'text-blue-300'; roleBg = 'bg-blue-900/10 border-blue-900/30'; roleIcon = 'fa-robot'; }
                        let content = typeof msg.content === 'string' ? msg.content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : JSON.stringify(msg.content, null, 2);

                        // è®¡ç®—çœŸå®å­—ç¬¦é•¿åº¦ (å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™ç´¯åŠ å„éƒ¨åˆ†æ–‡æœ¬é•¿åº¦)
                        let charLen = 0;
                        if (typeof msg.content === 'string') {
                            charLen = msg.content.length;
                        } else if (Array.isArray(msg.content)) {
                            msg.content.forEach(part => {
                                if (part.type === 'text') charLen += (part.text || '').length;
                                else if (part.type === 'image_url') charLen += 100; // å›¾ç‰‡æŒ‰100ç®—
                            });
                        }

                        html += `<div class="mb-4 p-3 rounded border border-gray-700 ${roleBg}"><div class="font-bold mb-2 ${roleColor} uppercase flex justify-between items-center text-[10px]"><span><i class="fa-solid ${roleIcon} mr-1"></i> [${idx}] ${msg.role}</span><span class="opacity-50 font-mono">Len: ${charLen}</span></div><div class="whitespace-pre-wrap leading-relaxed opacity-90 break-words">${content}</div></div>`;

                    });
                    container.innerHTML = html;
                } catch (e) { container.innerHTML = `<div class="text-red-400">è§£æä¸Šä¸‹æ–‡å¤±è´¥: ${e.message}</div>`; }
            },

            renderLogs: () => {
                const container = document.getElementById('logs-container');
                if (!container) return;
                let filtered = SystemLog.logs;
                const typeFilter = document.getElementById('log-level-filter').value;
                const keyword = document.getElementById('log-keyword-filter').value.toLowerCase();

                if (typeFilter) filtered = filtered.filter(l => l.type && l.type.toLowerCase().includes(typeFilter.toLowerCase()));
                if (keyword) filtered = filtered.filter(l => (l.title && l.title.toLowerCase().includes(keyword)) || (l.detail && typeof l.detail === 'string' && l.detail.toLowerCase().includes(keyword)));

                container.innerHTML = filtered.map(log => {
                    let colorClass = 'text-gray-400';
                    if (log.type === 'AI') colorClass = 'text-blue-400';
                    if (log.type === 'ERR' || log.type === 'ERROR') colorClass = 'text-red-400';
                    if (log.type === 'SYS') colorClass = 'text-green-400';
                    if (log.type === 'WARNING' || log.type === 'WARN') colorClass = 'text-yellow-400';
                    if (log.type === 'DEBUG') colorClass = 'text-purple-400';
                    if (log.type === 'INFO') colorClass = 'text-cyan-400';
                    let detailHtml = '';
                    if (log.detail) {
                        let detailStr = typeof log.detail === 'object' ? JSON.stringify(log.detail, null, 2) : log.detail;
                        detailStr = detailStr.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                        detailHtml = `<details class="mt-1"><summary class="cursor-pointer opacity-50 hover:opacity-100 select-none">[æŸ¥çœ‹è¯¦æƒ… / Raw Data]</summary><pre class="bg-black/30 p-2 rounded mt-1 overflow-x-auto whitespace-pre-wrap text-[10px] text-gray-500 select-text">${detailStr}</pre></details>`;
                    }
                    return `<div class="border-b border-gray-800 pb-2 mb-2"><div class="flex gap-2 items-center"><span class="opacity-50 font-mono text-[10px] w-16">${log.time}</span><span class="font-bold ${colorClass} w-10 text-center text-[10px] border border-gray-700 rounded">${log.type}</span><span class="text-gray-200 flex-1 font-bold text-sm truncate" title="${log.title}">${log.title}</span></div>${detailHtml}</div>`;
                }).join('');

                if (SystemLog.autoScroll) SystemLog.scrollToBottom();
            },

            render: () => {
                if (!SystemLog.currentTab) SystemLog.currentTab = 'logs';
                if (SystemLog.currentTab === 'logs') SystemLog.renderLogs();
                else SystemLog.renderContext();
            }
        };

        // å…¼å®¹æ—§çš„å¼•ç”¨åç§°
        window.SystemLoggerUI = window.SystemLog;
        window.SystemLogger = window.SystemLog;

        // ===== ã€æ–°å¢ã€‘æ‹¦æˆªconsoleé”™è¯¯å’Œè­¦å‘Šï¼Œè‡ªåŠ¨è®°å½•åˆ°ç³»ç»Ÿæ—¥å¿— =====
        (function () {
            // ä¿å­˜åŸå§‹consoleæ–¹æ³•
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;

            // æ‹¦æˆªconsole.error
            console.error = function (...args) {
                // è°ƒç”¨åŸå§‹æ–¹æ³•
                originalConsoleError.apply(console, args);

                // è®°å½•åˆ°ç³»ç»Ÿæ—¥å¿—
                const errorMsg = args.map(arg => {
                    if (typeof arg === 'object') {
                        try { return JSON.stringify(arg); }
                        catch { return String(arg); }
                    }
                    return String(arg);
                }).join(' ');

                if (window.SystemLog) {
                    SystemLog.write('ERROR', 'æ§åˆ¶å°é”™è¯¯', errorMsg);
                }
            };

            // æ‹¦æˆªconsole.warn
            console.warn = function (...args) {
                // è°ƒç”¨åŸå§‹æ–¹æ³•
                originalConsoleWarn.apply(console, args);

                // è®°å½•åˆ°ç³»ç»Ÿæ—¥å¿—
                const warnMsg = args.map(arg => {
                    if (typeof arg === 'object') {
                        try { return JSON.stringify(arg); }
                        catch { return String(arg); }
                    }
                    return String(arg);
                }).join(' ');

                if (window.SystemLog) {
                    SystemLog.write('WARNING', 'æ§åˆ¶å°è­¦å‘Š', warnMsg);
                }
            };

            // æ•è·æœªå¤„ç†çš„Promiseé”™è¯¯
            window.addEventListener('unhandledrejection', (event) => {
                if (window.SystemLog) {
                    SystemLog.write('ERROR', 'Promise rejection', event.reason?.toString() || 'Unknown error');
                }
            });

            // æ•è·å…¨å±€JavaScripté”™è¯¯
            window.addEventListener('error', (event) => {
                if (window.SystemLog) {
                    SystemLog.write('ERROR', `${event.filename}:${event.lineno}`, event.message);
                }
            });

            // console.log('[SystemLog] âœ… é”™è¯¯/è­¦å‘Šæ‹¦æˆªå™¨å·²å¯ç”¨');
        })();

        // ===== ã€æ–°å¢ã€‘æ‹¦æˆªfetchè¯·æ±‚ï¼Œæ•è·AI APIè°ƒç”¨åˆ°å³æ—¶ä¸Šä¸‹æ–‡ =====
        (function () {
            const originalFetch = window.fetch;

            window.fetch = function (...args) {
                const url = typeof args[0] === 'string' ? args[0] : args[0]?.url;
                const options = args[1] || {};

                // åªè®°å½•POSTè¯·æ±‚ï¼ˆé€šå¸¸æ˜¯AI APIè°ƒç”¨ï¼‰
                if (options.method === 'POST' || (options.body && typeof options.body === 'string')) {
                    try {
                        // è§£ærequest body
                        let requestBody = null;
                        if (options.body) {
                            try {
                                requestBody = typeof options.body === 'string' ? JSON.parse(options.body) : options.body;
                            } catch (e) {
                                requestBody = options.body;
                            }
                        }

                        // è®°å½•AIè¯·æ±‚æ—¥å¿—
                        if (requestBody && requestBody.messages) {
                            const logDetail = {
                                url: url,
                                model: requestBody.model,
                                temperature: requestBody.temperature,
                                max_tokens: requestBody.max_tokens,
                                messages: requestBody.messages
                            };

                            if (window.SystemLog) {
                                SystemLog.write('AI', 'AIç½‘ç»œè¯·æ±‚', JSON.stringify(logDetail));
                            }
                        }
                    } catch (e) {
                        console.error('[SystemLog] fetchæ‹¦æˆªè§£æå¤±è´¥:', e);
                    }
                }

                // è°ƒç”¨åŸå§‹fetch
                return originalFetch.apply(this, args);
            };

            // console.log('[SystemLog] âœ… fetchæ‹¦æˆªå™¨å·²å¯ç”¨');
        })();

        // ä¿®å¤æ°”æ³¡é¢„è§ˆå¤´åƒä¸æ˜¾ç¤ºçš„é—®é¢˜
        WeChatUI.updateBgPreview = function () {
            // 1. è·å–å„é¡¹è®¾ç½®å€¼
            const url = document.getElementById('char-chat-bg').value;
            const rawCss = document.getElementById('char-bubble-css').value;
            const blur = document.getElementById('char-bg-blur').value;
            const opacity = document.getElementById('char-bg-opacity').value;
            const fontSize = document.getElementById('char-bubble-size').value;

            // 2. è·å–å½“å‰è§’è‰²å’Œç”¨æˆ·ä¿¡æ¯
            const chars = AppStorage.get('wechat_chars', {});
            const c = chars[WeChatUI.currentChatId];
            const userProfile = AppStorage.get('wechat_user_profile', {});

            // 3. å¤„ç†èƒŒæ™¯å›¾é¢„è§ˆ
            const bgEl = document.getElementById('preview-chat-bg');
            let bgSource = url || (c && c.chatBg) || '';

            if (bgEl) {
                bgEl.style.cssText = ''; // é‡ç½®æ ·å¼
                bgEl.style.position = 'absolute';
                bgEl.style.inset = '0';
                bgEl.style.zIndex = '0';

                if (bgSource) {
                    if (!/^url\(/.test(bgSource)) bgSource = `url(${bgSource})`;
                    bgEl.style.background = `${bgSource} center/cover no-repeat`;
                    bgEl.style.backgroundColor = `rgba(0, 0, 0, ${1 - opacity})`; // æ¨¡æ‹Ÿé€æ˜åº¦å˜æš—
                    bgEl.style.backgroundBlendMode = 'overlay';
                } else {
                    bgEl.style.background = 'black'; // æ— å›¾æ˜¾ç¤ºé»‘è‰²
                }
                bgEl.style.filter = `blur(${blur}px)`;
            }

            // 4. å¤„ç†æ°”æ³¡ CSS æ ·å¼ (è§£æåŒæ‹¼ CSS)
            const cssParts = rawCss.split('|||');
            const cssOther = cssParts[0] || '';
            const cssSelf = cssParts[1] || cssParts[0] || '';

            const styleStrSelf = `${cssSelf}; font-size: ${fontSize}px;`;
            const styleStrOther = `${cssOther}; font-size: ${fontSize}px;`;

            document.getElementById('preview-bubble-self').style.cssText = styleStrSelf;
            document.getElementById('preview-bubble-other').style.cssText = styleStrOther;

            // 5. ã€æ ¸å¿ƒä¿®å¤ã€‘å¤„ç†å¤´åƒæ˜¾ç¤º
            const shape = document.getElementById('char-avatar-shape').value;
            const cls = shape === 'circle' ? 'rounded-full' : 'rounded-md';

            const previewAvatarOther = document.getElementById('preview-avatar-other');
            const previewAvatarSelf = document.getElementById('preview-avatar-self');

            // è®¾å®šå¤´åƒå½¢çŠ¶
            if (previewAvatarOther) previewAvatarOther.className = `msg-avatar ${cls}`;
            if (previewAvatarSelf) previewAvatarSelf.className = `msg-avatar ${cls}`;

            // è·å–å›¾ç‰‡å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
            const getOrCreateImg = (container) => {
                let img = container.querySelector('img');
                if (!img) {
                    img = document.createElement('img');
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    container.appendChild(img);
                }
                // ç¡®ä¿å›¾ç‰‡æ˜¾ç¤º
                img.style.display = 'block';
                return img;
            };

            // --- å¯¹æ–¹å¤´åƒé€»è¾‘ ---
            // ä¼˜å…ˆçº§ï¼šå½“å‰è¾“å…¥æ¡†çš„å€¼(ä¸Šä¼ æœªä¿å­˜) > è§’è‰²ä¿å­˜çš„å€¼ > éšæœº
            const otherInputVal = document.getElementById('char-avatar-data').value;
            const otherSrc = otherInputVal || (c && c.avatar) || WeChatUI.getRandomAvatar();

            if (previewAvatarOther) {
                const img = getOrCreateImg(previewAvatarOther);
                img.src = otherSrc;
            }

            // --- è‡ªå·±å¤´åƒé€»è¾‘ ---
            // ä¼˜å…ˆçº§ï¼šå½“å‰è¾“å…¥æ¡†çš„å€¼ > è§’è‰²ä¿å­˜çš„è‡ªå·±å¤´åƒ > å…¨å±€ç”¨æˆ·å¤´åƒ > éšæœº
            const selfInputVal = document.getElementById('user-avatar-data').value;
            const selfSrc = selfInputVal || (c && c.userAvatar) || userProfile.avatar || WeChatUI.getRandomAvatar();

            if (previewAvatarSelf) {
                const img = getOrCreateImg(previewAvatarSelf);
                img.src = selfSrc;
            }

            // 6. ç¡®ä¿é¢„è§ˆå®¹å™¨æ²¡æœ‰é®æŒ¡
            const previewContainer = document.querySelector('.bg-preview-container');
            if (previewContainer) {
                previewContainer.style.overflow = 'hidden';
                previewContainer.style.padding = '0';
            }
        };
    </script>

    <!-- Moments Settings Modal -->
    <div id="modal-moments-settings" class="modal-overlay hidden">
        <div class="modal-box flex flex-col h-[70vh]">
            <div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
                <h3 class="font-bold text-lg">æœ‹å‹åœˆè®¾ç½®</h3>
                <button onclick="document.getElementById('modal-moments-settings').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto space-y-4 pr-1">
                <div>
                    <h4 class="section-title">ä¸ªäººä¿¡æ¯</h4>
                    <div class="mb-2">
                        <label class="text-xs text-gray-500 mb-1 block">ä¸ªæ€§ç­¾å</label>
                        <input type="text" id="moments-bio-input" class="setting-input" placeholder="è®¾ç½®ä½ çš„æœ‹å‹åœˆç­¾å">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">å°é¢èƒŒæ™¯å›¾ URL</label>
                        <div class="flex gap-2">
                            <input type="text" id="moments-bg-input" class="setting-input mb-0 flex-1"
                                placeholder="è¾“å…¥å›¾ç‰‡é“¾æ¥">
                            <button class="setting-btn secondary w-auto text-xs whitespace-nowrap"
                                onclick="document.getElementById('moments-bg-upload').click()">ç›¸å†Œ</button>
                            <input type="file" id="moments-bg-upload" class="hidden" accept="image/*"
                                onchange="WeChatUI.handleMomentsBgUpload(this)">
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="section-title flex items-center gap-2">
                        <i class="fa-solid fa-robot text-blue-500"></i> AI è‡ªåŠ¨å‘æœ‹å‹åœˆ
                    </h4>
                    <div class="glass-panel p-3 rounded-lg border border-blue-100">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-bold text-gray-700">å¯ç”¨è‡ªåŠ¨ç”Ÿæˆ</span>
                            <input type="checkbox" id="moments-auto-switch" class="toggle-switch">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">é¢‘ç‡: æ¯</span>
                            <input type="number" id="moments-auto-interval"
                                class="setting-input w-16 text-center mb-0 py-1" value="60" min="10">
                            <span class="text-xs text-gray-500">åˆ†é’Ÿå‘å¸ƒä¸€æ¡</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2">
                            * å¼€å¯åï¼ŒAI å°†æ‰®æ¼”ä½ çš„å¥½å‹ï¼Œæ ¹æ®æ—¶é—´é—´éš”è‡ªåŠ¨å‘å¸ƒç”Ÿæ´»åŠ¨æ€å’Œé…å›¾ã€‚
                        </p>
                    </div>
                </div>

                <div>
                    <h4 class="section-title">å¼€å‘è€…å·¥å…·</h4>
                    <button onclick="MomentsOS.clearAll()"
                        class="setting-btn danger w-full text-red-500 bg-red-50 border-red-200">
                        <i class="fa-solid fa-trash mr-1"></i> æ¸…ç©ºæ‰€æœ‰æœ‹å‹åœˆ
                    </button>
                </div>

                <div>
                    <h4 class="section-title">æ˜¾ç¤ºè®¾ç½®</h4>
                    <div class="text-xs text-gray-400 mb-2">æ­¤å¤„å¯æŸ¥çœ‹å·²ç¼“å­˜çš„å¥½å‹æ•°æ®ï¼š</div>
                    <div id="friends-list-for-clear" class="max-h-32 overflow-y-auto bg-gray-50 rounded p-2">
                    </div>
                    <button onclick="WeChatUI.clearSelectedFriendsMoments()"
                        class="setting-btn danger w-full text-red-500 bg-red-50 border-red-200 mt-2">
                        <i class="fa-solid fa-trash mr-1"></i> æ¸…ç©ºé€‰ä¸­å¥½å‹æœ‹å‹åœˆ
                    </button>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-200 mt-2">
                <button onclick="WeChatUI.saveMomentsSettings()"
                    class="setting-btn w-full shadow-lg shadow-blue-500/20">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿæ—¥å¿—åº”ç”¨ -->
    <div id="app-syslogs" class="app-window flex flex-col" style="background: #1e1e1e;">
        <div class="app-header flex-shrink-0" style="background: #252526; border-bottom: 1px solid #3e3e42;">
            <button onclick="closeApp()"
                class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-700 text-white">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <div class="font-bold text-lg text-white">ç³»ç»Ÿæ§åˆ¶å°</div>
            <div class="flex gap-2">
                <button onclick="SystemLoggerUI.export()"
                    class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" title="å¯¼å‡ºæ—¥å¿—">
                    <i class="fa-solid fa-download"></i>
                </button>
                <button onclick="SystemLoggerUI.clearLogs()"
                    class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" title="æ¸…ç©ºæ—¥å¿—">
                    <i class="fa-solid fa-trash"></i>
                </button>
                <button onclick="WeChatUI.pruneHistoryAll()"
                    class="px-3 py-1 bg-amber-600 text-white rounded text-sm hover:bg-amber-700" title="æ·±åº¦æ¸…ç†(ä¿ç•™æœ€è¿‘50æ¡)">
                    <i class="fa-solid fa-broom"></i>
                </button>
                <button onclick="WeChatUI.compressData()"
                    class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" title="å‹ç¼©æ•°æ®(ä¸åˆ é™¤)">
                    <i class="fa-solid fa-file-zipper"></i>
                </button>
            </div>
        </div>

        <script>
            // Patch: Add Prune and Compress Function
            if (typeof WeChatUI === 'undefined') window.WeChatUI = {};

            WeChatUI.pruneHistoryAll = function () {
                if (!confirm('âš ï¸ ç¡®å®šè¦æ·±åº¦æ¸…ç†èŠå¤©è®°å½•å—ï¼Ÿ\n\nè¿™å°†ä¿ç•™æ¯ä¸ªè§’è‰²çš„æœ€å 50 æ¡æ¶ˆæ¯ï¼Œåˆ é™¤å…¶ä½™æ‰€æœ‰å†å²è®°å½•ä»¥é‡Šæ”¾ç©ºé—´ã€‚\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
                try {
                    const chars = AppStorage.get('wechat_chars', {});
                    let totalRemoved = 0;
                    Object.keys(chars).forEach(cid => {
                        const char = chars[cid];
                        if (char.msgs && char.msgs.length > 50) {
                            const before = char.msgs.length;
                            char.msgs = char.msgs.slice(-50);
                            totalRemoved += (before - 50);
                        }
                    });
                    AppStorage.set('wechat_chars', chars);
                    alert(`âœ… æ¸…ç†å®Œæˆï¼ç§»é™¤ ${totalRemoved} æ¡æ¶ˆæ¯ã€‚è¯·åˆ·æ–°é¡µé¢ã€‚`);
                    location.reload();
                } catch (e) { alert('å¤±è´¥: ' + e.message); }
            };

            WeChatUI.compressData = function () {
                if (!window.LZString) { alert('å‹ç¼©åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'); return; }
                if (!confirm('ğŸ“¦ ç¡®å®šè¦å‹ç¼©èŠå¤©è®°å½•å—ï¼Ÿ\n\nè¿™å°†ä½¿ç”¨ç®—æ³•å‹ç¼©æ•°æ®ï¼Œåœ¨ä¸åˆ é™¤ä»»ä½•æ¶ˆæ¯çš„æƒ…å†µä¸‹å¤§å¹…èŠ‚çœç©ºé—´ã€‚')) return;

                try {
                    const oldChars = AppStorage.get('wechat_chars', {});
                    const jsonStr = JSON.stringify(oldChars);
                    const initialSize = jsonStr.length;

                    // Manually Compress and Save with prefix
                    const compressed = LZString.compressToUTF16(jsonStr);
                    localStorage.setItem('wechat_chars', 'LZ|' + compressed);

                    const finalSize = compressed.length;
                    const savedRatio = ((1 - finalSize / initialSize) * 100).toFixed(1);

                    alert(`âœ… å‹ç¼©å®Œæˆï¼\n\nåŸå§‹å¤§å°: ${(initialSize / 1024).toFixed(2)} KB\nå‹ç¼©å: ${(finalSize / 1024).toFixed(2)} KB\nèŠ‚çœ: ${savedRatio}%\n\nä½ å¯ä»¥ç»§ç»­èŠå¤©äº†ï¼`);
                    location.reload();
                } catch (e) { alert('å‹ç¼©å¤±è´¥: ' + e.message); }
            };

            // Patch AppStorage to support Compression Transparently
            // We hook into the existing window.AppStorage if it exists, or wait for it?
            // Since we are at line 24000, AppStorage likely already defined.
            // We overwrite its methods.
            setTimeout(() => {
                if (window.AppStorage) {
                    const originalGet = AppStorage.get;
                    const originalSet = AppStorage.set;

                    AppStorage.get = function (key, defaultValue) {
                        const raw = localStorage.getItem(key);
                        if (!raw) return defaultValue;
                        if (raw.startsWith('LZ|')) {
                            // Decompress
                            if (!window.LZString) { console.error('LZString missing'); return defaultValue; }
                            try {
                                const decompressed = LZString.decompressFromUTF16(raw.substring(3));
                                if (!decompressed) return defaultValue; // Decompression null
                                return JSON.parse(decompressed);
                            } catch (e) {
                                console.error('Decompress failed', e);
                                return defaultValue;
                            }
                        }
                        // Fallback to original logic (JSON.parse)
                        try { return JSON.parse(raw); } catch (e) { return defaultValue; }
                    };

                    AppStorage.set = function (key, value) {
                        // Only compress big keys
                        if (key === 'wechat_chars' && window.LZString) {
                            try {
                                const str = JSON.stringify(value);
                                const compressed = LZString.compressToUTF16(str);
                                localStorage.setItem(key, 'LZ|' + compressed);
                            } catch (e) {
                                console.error('Compression Save Failed', e);
                                // Fallback
                                localStorage.setItem(key, JSON.stringify(value));
                            }
                        } else {
                            localStorage.setItem(key, JSON.stringify(value));
                        }
                    };
                    console.log('AppStorage Compression Patch Applied');
                }
            }, 1000); // Delay to ensure AppStorage is initialized
        </script>

        <!-- Tab å¯¼èˆªæ  -->
        <div class="flex border-b border-gray-700 bg-[#2d2d30]">
            <button onclick="SystemLoggerUI.switchTab('logs')" id="tab-btn-logs"
                class="flex-1 py-3 text-sm font-bold text-blue-400 border-b-2 border-blue-400 hover:bg-white/5 transition-colors">
                <i class="fa-solid fa-terminal mr-2"></i>ç³»ç»Ÿæ—¥å¿—
            </button>
            <button onclick="SystemLoggerUI.switchTab('context')" id="tab-btn-context"
                class="flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-white/5 transition-colors">
                <i class="fa-solid fa-code mr-2"></i>å³æ—¶ä¸Šä¸‹æ–‡
            </button>
        </div>

        <!-- Tab 1: æ—¥å¿—åˆ—è¡¨é¢æ¿ -->
        <div id="panel-logs" class="flex-1 flex flex-col min-h-0">
            <!-- è¿‡æ»¤æ  -->
            <div class="flex-shrink-0"
                style="background: #2d2d30; padding: 8px; border-bottom: 1px solid #3e3e42; display: flex; gap: 8px; align-items: center;">
                <select id="log-level-filter" onchange="SystemLoggerUI.render()"
                    style="background: #3c3c3c; color: #ccc; border: 1px solid #555; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="">å…¨éƒ¨çº§åˆ«</option>
                    <option value="error">ERROR</option>
                    <option value="warn">WARNING</option>
                    <option value="info">INFO</option>
                    <option value="debug">DEBUG</option>
                    <option value="ai">AIè¯·æ±‚</option>
                    <option value="sys">ç³»ç»Ÿ</option>
                </select>
                <input type="text" id="log-keyword-filter" placeholder="æœç´¢æ—¥å¿—..." oninput="SystemLoggerUI.render()"
                    style="background: #3c3c3c; color: #ccc; border: 1px solid #555; padding: 4px 8px; border-radius: 4px; font-size: 12px; flex: 1;">
                <button onclick="SystemLoggerUI.toggleAutoScroll()" id="auto-scroll-btn"
                    style="background: #0e639c; color: white; border: none; padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    è‡ªåŠ¨æ»šåŠ¨: OFF
                </button>
            </div>

            <!-- æ—¥å¿—å®¹å™¨ -->
            <div id="logs-container" class="flex-1 overflow-y-auto p-2 font-mono text-xs text-gray-300 custom-scrollbar"
                style="scroll-behavior: smooth;">
            </div>
        </div>

        <!-- Tab 2: ä¸Šä¸‹æ–‡æŸ¥çœ‹é¢æ¿ -->
        <div id="panel-context" class="flex-1 flex flex-col min-h-0 hidden">
            <div class="p-2 border-b border-gray-700 bg-[#2d2d30] flex justify-between items-center flex-shrink-0">
                <span class="text-xs text-gray-400">æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡å‘é€ç»™AIçš„å®Œæ•´ä¸Šä¸‹æ–‡</span>
                <button onclick="SystemLoggerUI.renderContext()"
                    class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                    <i class="fa-solid fa-arrows-rotate mr-1"></i>åˆ·æ–°
                </button>
            </div>
            <div id="context-container"
                class="flex-1 overflow-y-auto p-4 text-gray-300 font-mono text-xs select-text whitespace-pre-wrap">
                <div class="text-center text-gray-500 mt-20">æš‚æ— ä¸Šä¸‹æ–‡æ•°æ®<br>è¯·å…ˆä¸AIè¿›è¡Œä¸€æ¬¡å¯¹è¯</div>
            </div>
        </div>
    </div>



    <script>
        window.addEventListener('DOMContentLoaded', function () {
            // console.log('[AntiGravity] Starting Delayed Initialization...');

            // SystemLogger init
            if (typeof SystemLogger !== 'undefined' && SystemLogger.init) {
                try { SystemLogger.init(); console.log('SystemLogger initialized'); }
                catch (e) { console.error('SystemLogger init failed:', e); }
            }

            // SettingsLogic init
            if (typeof SettingsLogic !== 'undefined' && SettingsLogic.initAPI) {
                try { SettingsLogic.initAPI(); console.log('SettingsLogic initialized'); }
                catch (e) { console.error('SettingsLogic init failed:', e); }
            }

            // ThemeLogic init (if exists)
            if (typeof ThemeLogic !== 'undefined' && ThemeLogic.init) {
                try { ThemeLogic.init(); console.log('ThemeLogic initialized'); }
                catch (e) { console.error('ThemeLogic init failed:', e); }
            }

            // console.log('[AntiGravity] Initialization Complete.');
        });
    </script>
    <script>
        (function () {
            // 1. å®šä¹‰åº”ç”¨é…ç½®ä¿¡æ¯ (Manifest)
            const pwaManifest = {
                "name": "ä¹”ä¹”å°æ‰‹æœº OS",
                "short_name": "ä¹”ä¹”æ‰‹æœº",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#1e1b4b",
                "theme_color": "#1e1b4b",
                "orientation": "portrait-primary",
                "icons": [
                    {
                        "src": "https://img.icons8.com/color/512/iphone-x.png", // ä½¿ç”¨äº†ä¸€ä¸ªé€šç”¨çš„æ‰‹æœºå›¾æ ‡
                        "sizes": "512x512",
                        "type": "image/png"
                    }
                ]
            };

            // 2. å°†é…ç½®è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ Data URI
            const stringManifest = JSON.stringify(pwaManifest);
            const blob = new Blob([stringManifest], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(blob);

            // 3. æ³¨å…¥åˆ°é¡µé¢çš„å ä½ç¬¦ä¸­
            const linkTag = document.getElementById('manifest-placeholder');
            if (linkTag) {
                linkTag.setAttribute('href', manifestURL);
                // console.log('[PWA] Manifest æ³¨å…¥æˆåŠŸï¼Œåº”ç”¨å·²å…·å¤‡å®‰è£…èƒ½åŠ›');
            } else {
                console.warn('[PWA] æœªæ‰¾åˆ° manifest-placeholder æ ‡ç­¾');
            }

            // 4. ç›‘å¬å®‰è£…äº‹ä»¶ (å¯é€‰ï¼šç”¨äºåç»­å¼€å‘å®‰è£…æŒ‰é’®)
            window.addEventListener('beforeinstallprompt', (e) => {
                // é˜»æ­¢ Chrome 67 åŠæ›´æ—©ç‰ˆæœ¬è‡ªåŠ¨æ˜¾ç¤ºå®‰è£…æç¤º
                e.preventDefault();
                // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
                window.deferredPrompt = e;
                // console.log('[PWA] å¯ä»¥å®‰è£…åˆ°æ¡Œé¢äº†');
            });
            // Start Proactive Timer
            setTimeout(() => {
                if (typeof WeChatUI !== 'undefined' && WeChatUI.startProactiveTimer) {
                    WeChatUI.startProactiveTimer();
                }
            }, 5000);
        });

        /* ã€æ–°å¢ã€‘Token ç»Ÿè®¡ä¸æ—¥å¿—åŠ«æŒæ¨¡å— */
        (function () {
            // ç®€å•çš„ Token ä¼°ç®—å·¥å…· (1æ±‰å­—=2token, 1è‹±æ–‡å­—=1token, ç²—ç•¥è®¡ç®—)
            function estimateTokens(text) {
                if (!text || typeof text !== 'string') return 0;
                let len = 0;
                for (let i = 0; i < text.length; i++) {
                    const code = text.charCodeAt(i);
                    // æ±‰å­—èŒƒå›´ç²—ç•¥åˆ¤æ–­
                    if (code > 0x4E00 && code < 0x9FFF) len += 2;
                    else len += 1;
                }
                // OpenAI tokenizer é€šå¸¸å¤§æ¦‚æ˜¯ char_count / 3.5 åˆ° 4
                // è¿™é‡Œä¸ºäº†ä¿é™©èµ·è§ï¼Œç”¨å­—ç¬¦æ•°å³å¯ï¼Œæˆ–è€…ç®€å•é™¤ä»¥ 1.5 æ¥è¿‘ä¸­æ–‡çœŸå® token
                return Math.floor(len);
            }

            window.addEventListener('load', () => {
                // ç¡®ä¿ SettingsLogic å·²åŠ è½½
                if (typeof SettingsLogic !== 'undefined' && SettingsLogic.generateLLM) {
                    // console.log('[SystemLog] Hooking SettingsLogic.generateLLM for Token usage tracking...');

                    const originalGenerateLLM = SettingsLogic.generateLLM;

                    SettingsLogic.generateLLM = async function (msgs, charId) {
                        const start = Date.now();

                        // 1. è®¡ç®— Input Token (ä¼°ç®—)
                        let inputStr = '';
                        try {
                            if (Array.isArray(msgs)) inputStr = msgs.map(m => m.content).join('\n');
                            else inputStr = String(msgs);
                        } catch (e) { }
                        const inputTokens = estimateTokens(inputStr);

                        try {
                            // 2. æ‰§è¡ŒåŸå§‹è¯·æ±‚
                            const result = await originalGenerateLLM.apply(this, arguments);

                            // 3. è®¡ç®— Output Token
                            const outputTokens = estimateTokens(result);

                            // 4. è®°å½•æ—¥å¿—
                            const logMsg = `[Token Usage] Input: ${inputTokens}, Output: ${outputTokens}`;

                            // å…¼å®¹ä¸åŒçš„ SystemLogå®ç°
                            if (window.SystemLog) {
                                if (typeof SystemLog.add === 'function') {
                                    SystemLog.add('info', [logMsg]);
                                } else if (typeof SystemLog.write === 'function') {
                                    SystemLog.write('INFO', 'Token Usage', { input: inputTokens, output: outputTokens, total: inputTokens + outputTokens });
                                } else {
                                    console.log(logMsg);
                                }
                            } else {
                                console.log('[SystemLog Missing]', logMsg);
                            }

                            return result;
                        } catch (e) {
                            console.error('LLM Generation Failed (Hook):', e);
                            throw e;
                        }
                    };
                } else {
                    console.warn('[SystemLog] SettingsLogic.generateLLM not found, Token logging inactive.');
                }
            });
        })();


        // ====================================
        // ã€æ–°å¢ã€‘èŠå¤©è®°å½•å¯¼å‡ºå’Œæœç´¢åŠŸèƒ½
        // ====================================
        (function () {
            // ç¡®ä¿WeChatUIå­˜åœ¨
            window.addEventListener('load', () => {
                if (typeof WeChatUI === 'undefined') {
                    console.warn('[ChatSearch] WeChatUI not found, skipping initialization');
                    return;
                }

                // å¯¼å‡ºèŠå¤©è®°å½•
                WeChatUI.exportChatHistory = function () {
                    const cid = WeChatUI.currentChatId;
                    if (!cid) {
                        if (typeof Utils !== 'undefined' && Utils.showToast) {
                            Utils.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                        }
                        return;
                    }

                    const chars = AppStorage.get('wechat_chars', {});
                    const char = chars[cid];
                    if (!char || !char.msgs) {
                        if (typeof Utils !== 'undefined' && Utils.showToast) {
                            Utils.showToast('æš‚æ— èŠå¤©è®°å½•');
                        }
                        return;
                    }

                    // æ ¼å¼åŒ–æ¶ˆæ¯
                    let exportText = `ã€èŠå¤©è®°å½•ã€‘${char.name}\n`;
                    exportText += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n`;
                    exportText += `æ¶ˆæ¯æ•°é‡ï¼š${char.msgs.length} æ¡\n`;
                    exportText += `\n${'='.repeat(50)}\n\n`;

                    char.msgs.forEach((m, idx) => {
                        const time = new Date(m.timestamp || Date.now()).toLocaleString();
                        const sender = m.role === 'user' ? 'æˆ‘' : char.name;

                        let content = '';
                        if (m.type === 'text' || !m.type) {
                            content = m.content;
                        } else if (m.type === 'image') {
                            content = '[å›¾ç‰‡]';
                        } else if (m.type === 'voice') {
                            content = `[è¯­éŸ³ ${m.duration || 0}ç§’]`;
                        } else if (m.type === 'redpacket') {
                            const status = m.status === 'received' ? 'å·²é¢†å–' : (m.status === 'rejected' ? 'å·²é€€è¿˜' : 'æœªé¢†å–');
                            content = `[çº¢åŒ…] ${m.note} (${status})`;
                        } else if (m.type === 'transfer') {
                            const status = m.status === 'received' ? 'å·²æ”¶æ¬¾' : (m.status === 'rejected' ? 'å·²é€€è¿˜' : 'æœªæ”¶æ¬¾');
                            content = `[è½¬è´¦] Â¥${m.amount} - ${m.note} (${status})`;
                        } else if (m.type === 'system') {
                            content = `[ç³»ç»Ÿ] ${m.content}`;
                        } else {
                            content = `[${m.type}]`;
                        }

                        exportText += `[${idx + 1}] ${time}\n`;
                        exportText += `${sender}: ${content}\n\n`;
                    });

                    // ä¸‹è½½æ–‡ä»¶
                    const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `èŠå¤©è®°å½•-${char.name}-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);

                    if (typeof Utils !== 'undefined' && Utils.showToast) {
                        Utils.showToast('å¯¼å‡ºæˆåŠŸï¼');
                    }
                };

                // æ‰“å¼€èŠå¤©æœç´¢é¡µé¢
                WeChatUI.openChatSearch = function () {
                    const cid = WeChatUI.currentChatId;
                    if (!cid) {
                        if (typeof Utils !== 'undefined' && Utils.showToast) {
                            Utils.showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
                        }
                        return;
                    }

                    // åˆ›å»ºæœç´¢é¡µé¢ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    if (!document.getElementById('subpage-chat-search')) {
                        const searchPage = document.createElement('div');
                        searchPage.id = 'subpage-chat-search';
                        searchPage.className = 'sub-view bg-white';
                        searchPage.innerHTML = `
                            <div class="app-header justify-between bg-white border-b border-gray-200">
                                <div class="flex items-center gap-2">
                                    <button onclick="WeChatUI.closeSubPage('subpage-chat-search')" class="w-10 h-full"><i class="fa-solid fa-chevron-left"></i></button>
                                    <span class="font-semibold text-gray-800">æŸ¥æ‰¾èŠå¤©è®°å½•</span>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-50 border-b border-gray-200">
                                <input type="text" id="chat-search-input" placeholder="æœç´¢æ¶ˆæ¯å†…å®¹..." 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-500"
                                       oninput="WeChatUI.performChatSearch()">
                            </div>
                            <div id="chat-search-results" class="overflow-y-auto" style="height: calc(100% - 120px);"></div>
                        `;
                        const appWechat = document.getElementById('app-wechat');
                        if (appWechat) {
                            appWechat.appendChild(searchPage);
                        }
                    }

                    // æ‰“å¼€é¡µé¢
                    WeChatUI.openSubPage('subpage-chat-search');

                    // æ¸…ç©ºæœç´¢
                    const searchInput = document.getElementById('chat-search-input');
                    const searchResults = document.getElementById('chat-search-results');
                    if (searchInput) searchInput.value = '';
                    if (searchResults) {
                        searchResults.innerHTML = '<div class="text-center text-gray-400 py-8">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
                    }
                };

                // æ‰§è¡ŒèŠå¤©æœç´¢
                WeChatUI.performChatSearch = function () {
                    const queryInput = document.getElementById('chat-search-input');
                    const resultsDiv = document.getElementById('chat-search-results');

                    if (!queryInput || !resultsDiv) return;

                    const query = queryInput.value.trim();

                    if (!query) {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>';
                        return;
                    }

                    const cid = WeChatUI.currentChatId;
                    const chars = AppStorage.get('wechat_chars', {});
                    const char = chars[cid];

                    if (!char || !char.msgs) {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">æš‚æ— èŠå¤©è®°å½•</div>';
                        return;
                    }

                    // æœç´¢æ¶ˆæ¯
                    const results = [];
                    char.msgs.forEach((m, idx) => {
                        let matched = false;
                        if (m.type === 'text' || !m.type) {
                            matched = m.content && m.content.includes(query);
                        } else if (m.type === 'redpacket') {
                            matched = m.note && m.note.includes(query);
                        } else if (m.type === 'transfer') {
                            matched = (m.note && m.note.includes(query)) || (m.amount && m.amount.toString().includes(query));
                        }

                        if (matched) {
                            results.push({ ...m, originalIndex: idx });
                        }
                    });

                    if (results.length === 0) {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-400 py-8">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
                        return;
                    }

                    // æ¸²æŸ“ç»“æœ
                    let html = results.map(m => {
                        const time = new Date(m.timestamp || Date.now()).toLocaleString();
                        const sender = m.role === 'user' ? 'æˆ‘' : char.name;
                        let content = '';

                        if (m.type === 'text' || !m.type) {
                            content = (m.content || '').substring(0, 100);
                        } else if (m.type === 'redpacket') {
                            content = `[çº¢åŒ…] ${m.note}`;
                        } else if (m.type === 'transfer') {
                            content = `[è½¬è´¦] Â¥${m.amount} - ${m.note}`;
                        }

                        // é«˜äº®æ˜¾ç¤ºæœç´¢è¯ï¼ˆå®‰å…¨è½¬ä¹‰ï¼‰
                        const escapeRegex = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        content = content.replace(new RegExp(escapeRegex, 'g'), `<span class="bg-yellow-200">${query}</span>`);

                        return `
                            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" 
                                 onclick="WeChatUI.jumpToMessage(${m.originalIndex})">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-medium text-sm text-gray-800">${sender}</span>
                                    <span class="text-xs text-gray-400">${time}</span>
                                </div>
                                <div class="text-sm text-gray-600">${content}</div>
                            </div>
                        `;
                    }).join('');

                    html += `<div class="text-center text-gray-400 py-4 text-xs">å…±æ‰¾åˆ° ${results.length} æ¡ç»“æœ</div>`;
                    resultsDiv.innerHTML = html;
                };

                // è·³è½¬åˆ°æŒ‡å®šæ¶ˆæ¯
                WeChatUI.jumpToMessage = function (msgIndex) {
                    console.log('[JumpToMessage] Starting jump to message index:', msgIndex);

                    // ç¡®ä¿æ‰“å¼€èŠå¤©è¯¦æƒ…é¡µ (é˜²æ­¢å›åˆ°ä¸»é¡µ)
                    WeChatUI.openSubPage('subpage-chat-detail');

                    const cid = WeChatUI.currentChatId;
                    const chars = AppStorage.get('wechat_chars', {});
                    const char = chars[cid];

                    if (!char || !char.msgs) {
                        console.warn('[JumpToMessage] No character or messages found');
                        return;
                    }

                    console.log('[JumpToMessage] Total msgs:', char.msgs.length, 'Target index:', msgIndex);

                    // ç¡®ä¿è¦è·³è½¬çš„æ¶ˆæ¯è¢«åŠ è½½ (æ³¨æ„ï¼šloadChat æ˜¯ä»æœ«å°¾å¾€å‰åˆ‡ç‰‡çš„)
                    if (!WeChatUI.currentLoadedMsgs) WeChatUI.currentLoadedMsgs = {};
                    const requiredCount = char.msgs.length - msgIndex + 20; // é¢„ç•™20æ¡ç¼“å†²
                    WeChatUI.currentLoadedMsgs[cid] = Math.max(WeChatUI.currentLoadedMsgs[cid] || 50, requiredCount);

                    console.log('[JumpToMessage] Setting currentLoadedMsgs to:', WeChatUI.currentLoadedMsgs[cid]);

                    // é‡æ–°åŠ è½½èŠå¤©
                    WeChatUI.loadChat(cid);

                    // ç­‰å¾…æ¸²æŸ“å®Œæˆåæ»šåŠ¨å¹¶é«˜äº®
                    setTimeout(() => {
                        const container = document.getElementById('chat-messages-container');
                        if (!container) {
                            console.error('[JumpToMessage] Container not found');
                            return;
                        }

                        const msgElements = container.querySelectorAll('.msg-row');
                        console.log('[JumpToMessage] Found msg elements:', msgElements.length);

                        // è®¡ç®—å®é™…çš„DOMç´¢å¼•ï¼ˆè€ƒè™‘displayLimitï¼‰
                        const totalMsgs = char.msgs.length;
                        const displayLimit = WeChatUI.currentLoadedMsgs[cid] || 50;
                        const startIndex = Math.max(0, totalMsgs - displayLimit);
                        const domIndex = msgIndex - startIndex;

                        console.log('[JumpToMessage] startIndex:', startIndex, 'domIndex:', domIndex);

                        if (msgElements[domIndex]) {
                            // æ»šåŠ¨åˆ°ç›®æ ‡æ¶ˆæ¯
                            msgElements[domIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // é«˜äº®æ˜¾ç¤º
                            msgElements[domIndex].style.background = '#fef9c3';
                            msgElements[domIndex].style.transition = 'background 0.3s';

                            console.log('[JumpToMessage] Scroll and highlight applied');

                            // 2ç§’åç§»é™¤é«˜äº®
                            setTimeout(() => {
                                msgElements[domIndex].style.background = '';
                            }, 2000);
                        } else {
                            console.warn('[JumpToMessage] Target message element not found in DOM. DomIndex:', domIndex, 'Available:', msgElements.length);
                        }
                    }, 500);

                };

                console.log('[ChatSearch] Chat export and search functions initialized');
            });
        })();

        // ====================================
        // ã€æ–°å¢ã€‘ç§»åŠ¨ç«¯ä¾§æ»‘è¿”å›ä¼˜åŒ–
        // ====================================
        (function () {
            'use strict';

            // åˆå§‹åŒ–æ—¶æ·»åŠ ä¸€ä¸ªhistoryæ¡ç›®
            window.addEventListener('load', () => {
                // ç¡®ä¿æœ‰åˆå§‹historyæ¡ç›®
                if (!window.history.state) {
                    window.history.pushState({ level: 0 }, '');
                    console.log('[Swipe Back] Initial history state created');
                }
            });

            // ç›‘å¬æµè§ˆå™¨è¿”å›äº‹ä»¶ï¼ˆåŒ…æ‹¬ä¾§æ»‘ï¼‰
            window.addEventListener('popstate', (event) => {
                // console.log('[Swipe Back] popstate triggered', event.state);

                let handled = false;

                // è¾…åŠ©å‡½æ•°ï¼šæ‰§è¡Œå…³é—­å¹¶ç»´æŒ History é™·é˜±
                const handleClose = (action) => {
                    action();
                    // é‡æ–°æ¨å…¥çŠ¶æ€ï¼Œé˜²æ­¢æµè§ˆå™¨åé€€é€€å‡ºé¡µé¢
                    window.history.pushState({ level: 1 }, '');
                    handled = true;
                };

                // ===============================
                // 1. ä¼˜å…ˆçº§æœ€é«˜ï¼šå…¨å±æ¨¡æ€æ¡† (Modals)
                // ===============================

                // 1.1 æŸ¥æ‰‹æœºå­åº”ç”¨ (Phone Subapp)
                const searchPhoneModal = document.getElementById('modal-phone-subapp');
                if (!handled && searchPhoneModal && !searchPhoneModal.classList.contains('translate-y-full')) {
                    handleClose(() => {
                        searchPhoneModal.classList.add('translate-y-full');
                        // è§¦å‘ MutationObserver æ¸…ç†ï¼ˆå¦‚æœå·²ç»‘å®šï¼‰
                    });
                    // console.log('[Swipe Back] Closed phone subapp');
                }

                // 1.2 æœ‹å‹åœˆè®¾ç½®å¼¹çª— (Moments Settings)
                const momentsSettings = document.getElementById('modal-moments-settings');
                if (!handled && momentsSettings && !momentsSettings.classList.contains('hidden')) {
                    handleClose(() => momentsSettings.classList.add('hidden'));
                }

                // 1.3 å…¶ä»–é€šç”¨æ¨¡æ€æ¡† (è½¬è´¦ã€çº¢åŒ…ã€å…¨å±€é€šçŸ¥ç­‰)
                const commonModals = ['modal-transfer', 'modal-open-redpacket', 'modal-payment-action', 'global-notification-modal'];
                if (!handled) {
                    for (const modalId of commonModals) {
                        const el = document.getElementById(modalId);
                        // global-notification-modal ä½¿ç”¨ display:block æ§åˆ¶
                        if (el) {
                            if (modalId === 'global-notification-modal') {
                                if (el.style.display && el.style.display !== 'none') {
                                    handleClose(() => el.style.display = 'none');
                                    break;
                                }
                            } else {
                                if (!el.classList.contains('hidden')) {
                                    handleClose(() => el.classList.add('hidden'));
                                    break;
                                }
                            }
                        }
                    }
                }

                // ===============================
                // 2. ä¼˜å…ˆçº§æ¬¡é«˜ï¼šäºŒçº§å­é¡µé¢ (Level 2 Subpages)
                // ===============================

                // 2.1 è§’è‰²è®¾ç½®é¡µ (Char Settings) - å¿…é¡»åœ¨ Chat Detail ä¹‹å‰æ£€æŸ¥
                const charSettingsPage = document.getElementById('subpage-char-settings');
                if (!handled && charSettingsPage && charSettingsPage.classList.contains('translate-x-0')) {
                    handleClose(() => {
                        if (typeof WeChatUI !== 'undefined' && WeChatUI.closeSubPage) {
                            WeChatUI.closeSubPage('subpage-char-settings');
                        } else {
                            charSettingsPage.classList.remove('translate-x-0');
                            charSettingsPage.classList.add('translate-x-full');
                        }
                    });
                    // console.log('[Swipe Back] Closed char settings page');
                }

                // ===============================
                // 3. ä¼˜å…ˆçº§æœ€ä½ï¼šä¸€çº§å­é¡µé¢ (Level 1 Subpages)
                // ===============================

                // 3.1 èŠå¤©è¯¦æƒ…é¡µ (Chat Detail)
                const chatDetailPage = document.getElementById('subpage-chat-detail');
                if (!handled && chatDetailPage && chatDetailPage.classList.contains('translate-x-0')) {
                    handleClose(() => {
                        if (typeof WeChatUI !== 'undefined' && WeChatUI.closeSubPage) {
                            WeChatUI.closeSubPage('subpage-chat-detail');
                        } else {
                            chatDetailPage.classList.remove('translate-x-0');
                            chatDetailPage.classList.add('translate-x-full');
                        }
                    });
                    // console.log('[Swipe Back] Closed chat detail page');
                }

                // 3.2 èŠå¤©æœç´¢é¡µ (Chat Search)
                const chatSearchPage = document.getElementById('subpage-chat-search');
                if (!handled && chatSearchPage && chatSearchPage.classList.contains('translate-x-0')) {
                    handleClose(() => {
                        if (typeof WeChatUI !== 'undefined' && WeChatUI.closeSubPage) {
                            WeChatUI.closeSubPage('subpage-chat-search');
                        } else {
                            chatSearchPage.classList.remove('translate-x-0');
                            chatSearchPage.classList.add('translate-x-full');
                        }
                    });
                }

                // 3.3 é€šç”¨å…œåº•æ£€æŸ¥ (å…¶ä»– subpage-*)
                // æ³¨æ„ï¼šè¿™ä¼šå…³é—­æŸ¥æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå¯è§é¡µé¢ï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨æœ€åä½œä¸ºå…œåº•
                if (!handled) {
                    const allSubPages = document.querySelectorAll('[id^="subpage-"]');
                    for (const subpage of allSubPages) {
                        if (subpage.classList.contains('translate-x-0')) {
                            handleClose(() => {
                                subpage.classList.remove('translate-x-0');
                                subpage.classList.add('translate-x-full');
                            });
                            // console.log('[Swipe Back] Closed generic subpage:', subpage.id);
                            break; // æ¯æ¬¡åªå…³é—­ä¸€å±‚
                        }
                    }
                }

                // å¦‚æœæ²¡æœ‰å¤„ç†ä»»ä½•é¡µé¢ï¼Œè¯´æ˜åœ¨ä¸»é¡µï¼Œå…è®¸æµè§ˆå™¨é»˜è®¤è¡Œä¸º (å¯èƒ½é€€å‡º)
                if (!handled) {
                    // console.log('[Swipe Back] No subpage to close, allowing default behavior');
                }
            });

            // console.log('[Swipe Back] Navigation interceptor initialized');
        })();

        // ====================================
        // ã€æœ‹å‹åœˆ UIã€‘MomentsUI
        // ====================================
        (function () {
            'use strict';

            window.WeChatUI = window.WeChatUI || {};

            // æ—¶é—´æ ¼å¼åŒ–å·¥å…·
            WeChatUI.formatMomentTime = function (timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;

                if (diff < minute) return 'åˆšåˆš';
                if (diff < hour) return `${Math.floor(diff / minute)}åˆ†é’Ÿå‰`;

                const d = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today - day);

                if (d.toDateString() === today.toDateString()) {
                    return `ä»Šå¤© ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                }
                if (d.toDateString() === yesterday.toDateString()) {
                    return `æ˜¨å¤© ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                }
                if (d.getFullYear() === today.getFullYear()) {
                    return `${d.getMonth() + 1}-${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
                }
                return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
            };

            // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
            WeChatUI.renderMomentsList = function () {
                const container = document.getElementById('moments-list-container');
                if (!container) return;

                // Load Settings
                const settings = AppStorage.get('wechat_moments_settings', {
                    profile: { backgroundImage: '', bio: '', avatar: '', name: '' },
                    display: { limit: 10, autoload: true }
                });

                // Update Cover & Profile
                const coverImg = document.getElementById('moments-cover-img');
                const coverAvatar = document.getElementById('moments-cover-avatar');
                const coverName = document.getElementById('moments-cover-name');
                const userProfile = AppStorage.get('wechat_user_profile', {});

                // èƒŒæ™¯å›¾ä½¿ç”¨æœ‹å‹åœˆè®¾ç½®
                if (coverImg) coverImg.src = settings.profile.backgroundImage || 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80';
                // å¤´åƒå’Œåå­—ç›´æ¥åŒæ­¥"æˆ‘"çš„èµ„æ–™
                if (coverAvatar) coverAvatar.src = userProfile.avatar || 'https://via.placeholder.com/100';
                if (coverName) coverName.textContent = userProfile.name || 'ä¹”ä¹”';

                const moments = AppStorage.get('wechat_moments', []);

                if (moments.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-20 text-gray-400">
                            <i class="fa-solid fa-image text-6xl mb-4 opacity-20"></i>
                            <div class="text-sm">è¿˜æ²¡æœ‰æœ‹å‹åœˆåŠ¨æ€</div>
                            <div class="text-xs mt-2">ç‚¹å‡»å³ä¸Šè§’ç›¸æœºå›¾æ ‡å‘å¸ƒ</div>
                        </div>
                    `;
                    return;
                }

                // æŒ‰æ—¶é—´å€’åºæ’åº
                moments.sort((a, b) => b.timestamp - a.timestamp);

                // Apply Settings
                const limit = parseInt(settings.display.limit || 10);
                const autoload = settings.display.autoload !== false;

                const visibleMoments = moments.slice(0, limit);
                const html = visibleMoments.map(moment => WeChatUI.renderMomentCard(moment, autoload)).join('');

                container.innerHTML = html;

                if (moments.length > limit) {
                    container.innerHTML += `<div class="text-center py-6 text-gray-400 text-xs">- ä»…æ˜¾ç¤ºæœ€è¿‘ ${limit} æ¡ -</div>`;
                }
            };

            // æ¸²æŸ“å•æ¡æœ‹å‹åœˆå¡ç‰‡
            WeChatUI.renderMomentCard = function (moment, autoload = true) {
                const userProfile = AppStorage.get('wechat_user_profile', {});
                const userId = 'user';
                const isLiked = moment.likes && moment.likes.includes(userId);

                // å›¾ç‰‡HTML
                let imagesHTML = '';
                if (moment.images && moment.images.length > 0) {
                    const count = moment.images.length;

                    if (autoload !== false) {
                        imagesHTML = `<div class="moment-images count-${count}">`;
                        moment.images.forEach(img => {
                            imagesHTML += `<img src="${img}" alt="æœ‹å‹åœˆå›¾ç‰‡" loading="lazy">`;
                        });
                        imagesHTML += `</div>`;
                    } else {
                        // Manual Load Button
                        imagesHTML = `
                            <div class="bg-gray-50 border border-gray-100 rounded-lg p-3 mb-2 cursor-pointer flex items-center justify-center gap-2 text-gray-500 hover:bg-gray-100 transition-colors" 
                                onclick="const grid = this.nextElementSibling; grid.classList.remove('hidden'); this.remove();">
                                <i class="fa-regular fa-image"></i>
                                <span class="text-xs">æŸ¥çœ‹ ${count} å¼ å›¾ç‰‡</span>
                            </div>
                            <div class="moment-images count-${count} hidden">
                               ${moment.images.map(img => `<img src="${img}" loading="lazy">`).join('')}
                            </div>
                        `;
                    }
                }

                // ç‚¹èµåˆ—è¡¨
                let likesHTML = '';
                if (moment.likes && moment.likes.length > 0) {
                    const chars = AppStorage.get('wechat_chars', {});
                    const likeNames = moment.likes.map(id => {
                        if (id === 'user') return userProfile.name || 'æˆ‘';
                        return chars[id]?.name || 'æœªçŸ¥';
                    });
                    likesHTML = `
                        <div class="moment-likes">
                            <i class="fa-solid fa-heart"></i>${likeNames.join('ï¼Œ')}
                        </div>
                    `;
                }

                // è¯„è®ºåˆ—è¡¨
                let commentsHTML = '';
                if (moment.comments && moment.comments.length > 0) {
                    const chars = AppStorage.get('wechat_chars', {});
                    commentsHTML = '<div class="moment-comments">';
                    moment.comments.forEach(comment => {
                        let authorName = comment.authorId === 'user' ? (userProfile.name || 'æˆ‘') : (chars[comment.authorId]?.name || 'æœªçŸ¥');
                        commentsHTML += `
                            <div class="moment-comment">
                                <span class="comment-author">${authorName}</span>: 
                                <span class="comment-content">${comment.content}</span>
                            </div>
                        `;
                    });
                    commentsHTML += '</div>';
                }

                // äº’åŠ¨åŒºåŸŸ
                let interactionsHTML = '';
                if (likesHTML || commentsHTML) {
                    interactionsHTML = `<div class="moment-interactions">${likesHTML}${commentsHTML}</div>`;
                }

                // ç§»é™¤æ—§çš„åº•éƒ¨æ“ä½œæŒ‰é’®,æ”¹ä¸ºå³ä¸Šè§’èœå•

                return `
                    <div class="moment-card" data-moment-id="${moment.id}">
                        <div class="moment-avatar" onclick="WeChatUI.openCharFromMoment('${moment.authorId}')" style="cursor: pointer;">
                            <img src="${moment.authorAvatar || 'https://via.placeholder.com/44'}" alt="${moment.authorName}">
                        </div>
                        <div class="moment-body">
                            <div class="moment-author">${moment.authorName}</div>
                            <div class="moment-content">${moment.content}</div>
                            ${imagesHTML}
                            ${moment.location ? `<div class="moment-location"><i class="fa-solid fa-location-dot"></i>${moment.location}</div>` : ''}
                            <div class="moment-time">${WeChatUI.formatMomentTime(moment.timestamp)}</div>
                            <div class="moment-actions">
                                <button class="moment-action-btn ${isLiked ? 'liked' : ''}" onclick="WeChatUI.toggleLike('${moment.id}')">
                                    <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i>
                                </button>
                                <button class="moment-action-btn" onclick="WeChatUI.showCommentInput('${moment.id}')">
                                    <i class="fa-regular fa-comment"></i>
                                </button>
                                <button class="moment-action-btn" onclick="WeChatUI.shareMoment('${moment.id}')">
                                    <i class="fa-solid fa-share"></i>
                                </button>
                                <button class="moment-action-btn" onclick="WeChatUI.summonInteraction('${moment.id}')">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i>å¬å”¤
                                </button>
                            </div>
                            ${interactionsHTML}
                        </div>
                        <!-- å³ä¸Šè§’èœå•æŒ‰é’® -->
                        <div class="moment-menu-container">
                            <button class="moment-menu-btn" onclick="WeChatUI.toggleMomentMenu('${moment.id}', event)">
                                <i class="fa-solid fa-ellipsis"></i>
                            </button>
                            <!-- ä¸‹æ‹‰èœå• -->
                            <div class="moment-menu-dropdown" id="moment-menu-${moment.id}" style="display: none;">
                                <div class="moment-menu-item" onclick="WeChatUI.editMoment('${moment.id}'); WeChatUI.closeMomentMenu('${moment.id}');">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                    <span>ç¼–è¾‘</span>
                                </div>
                                <div class="moment-menu-item moment-menu-item-danger" onclick="WeChatUI.deleteMoment('${moment.id}'); WeChatUI.closeMomentMenu('${moment.id}');">
                                    <i class="fa-solid fa-trash"></i>
                                    <span>åˆ é™¤</span>
                                </div>
                                <div class="moment-menu-item" onclick="WeChatUI.closeMomentMenu('${moment.id}');">
                                    <i class="fa-solid fa-xmark"></i>
                                    <span>å–æ¶ˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // æ‰“å¼€å‘å¸ƒæœ‹å‹åœˆç¼–è¾‘å™¨
            WeChatUI.openMomentsEditor = function () {
                const modal = document.getElementById('modal-publish-moment');
                if (!modal) return;

                modal.classList.remove('hidden');
                document.getElementById('moment-content-input').value = '';
                document.getElementById('moment-location-input').value = '';
                document.getElementById('moment-images-preview').innerHTML = '';
                WeChatUI.momentDraftImages = [];

                // ç»‘å®šå›¾ç‰‡é€‰æ‹©äº‹ä»¶
                const picker = document.getElementById('moment-image-picker');
                if (picker) {
                    picker.onchange = WeChatUI.handleMomentImageSelect;
                }
            };

            // å…³é—­å‘å¸ƒæœ‹å‹åœˆç¼–è¾‘å™¨
            WeChatUI.closeMomentsEditor = function () {
                const modal = document.getElementById('modal-publish-moment');
                if (modal) modal.classList.add('hidden');
            };

            // å¤„ç†å›¾ç‰‡é€‰æ‹©
            WeChatUI.momentDraftImages = [];
            WeChatUI.handleMomentImageSelect = async function (e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                // é™åˆ¶æœ€å¤š9å¼ 
                if (WeChatUI.momentDraftImages.length + files.length > 9) {
                    Utils.showToast('æœ€å¤šåªèƒ½é€‰æ‹©9å¼ å›¾ç‰‡');
                    return;
                }

                for (const file of files) {
                    try {
                        // ä½¿ç”¨ Utils.compressImage å‹ç¼©å›¾ç‰‡
                        const compressed = await Utils.compressImage(file, 800, 0.8);
                        WeChatUI.momentDraftImages.push(compressed);
                    } catch (err) {
                        console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', err);
                    }
                }

                // æ›´æ–°é¢„è§ˆ
                WeChatUI.updateMomentImagesPreview();
                e.target.value = ''; // æ¸…ç©ºinput
            };

            // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
            WeChatUI.updateMomentImagesPreview = function () {
                const preview = document.getElementById('moment-images-preview');
                if (!preview) return;

                if (WeChatUI.momentDraftImages.length === 0) {
                    preview.innerHTML = '';
                    return;
                }

                let html = '';
                WeChatUI.momentDraftImages.forEach((img, idx) => {
                    html += `
                        <div class="moment-image-preview-item">
                            <img src="${img}" alt="é¢„è§ˆ">
                            <div class="remove-btn" onclick="WeChatUI.removeMomentImage(${idx})">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    `;
                });
                preview.innerHTML = html;
            };

            // ç§»é™¤å›¾ç‰‡
            WeChatUI.removeMomentImage = function (index) {
                WeChatUI.momentDraftImages.splice(index, 1);
                WeChatUI.updateMomentImagesPreview();
            };

            // å‘å¸ƒæœ‹å‹åœˆ
            WeChatUI.publishMoment = async function () {
                const content = document.getElementById('moment-content-input').value.trim();
                const location = document.getElementById('moment-location-input').value.trim();

                if (!content && WeChatUI.momentDraftImages.length === 0) {
                    Utils.showToast('è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡');
                    return;
                }

                const userProfile = AppStorage.get('wechat_user_profile', {});

                const moment = {
                    id: `moment_${Date.now()}`,
                    authorId: 'user',
                    authorName: userProfile.name || 'æˆ‘',
                    authorAvatar: userProfile.avatar || '',
                    isUser: true,
                    content,
                    images: [...WeChatUI.momentDraftImages],
                    location,
                    timestamp: Date.now(),
                    likes: [],
                    comments: []
                };

                const moments = AppStorage.get('wechat_moments', []);
                moments.unshift(moment);
                AppStorage.set('wechat_moments', moments);

                WeChatUI.closeMomentsEditor();
                WeChatUI.renderMomentsList();
                Utils.showToast('å‘å¸ƒæˆåŠŸ');
            };

            // ç‚¹èµ/å–æ¶ˆç‚¹èµ
            WeChatUI.toggleLike = function (momentId) {
                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) return;

                const userId = 'user';
                const index = moment.likes.indexOf(userId);

                if (index > -1) {
                    moment.likes.splice(index, 1);
                } else {
                    moment.likes.push(userId);
                }

                AppStorage.set('wechat_moments', moments);
                WeChatUI.renderMomentsList();
            };

            // æ˜¾ç¤ºè¯„è®ºè¾“å…¥
            WeChatUI.showCommentInput = function (momentId) {
                Utils.showPrompt('å‘è¡¨è¯„è®º', 'è¯´ç‚¹ä»€ä¹ˆ...', async (commentText) => {
                    if (!commentText || !commentText.trim()) return;
                    await WeChatUI.addComment(momentId, commentText.trim());
                });
            };

            // æ·»åŠ è¯„è®º
            WeChatUI.addComment = async function (momentId, content) {
                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) return;

                const userProfile = AppStorage.get('wechat_user_profile', {});

                const comment = {
                    id: `comment_${Date.now()}`,
                    authorId: 'user',
                    authorName: userProfile.name || 'æˆ‘',
                    content,
                    timestamp: Date.now()
                };

                moment.comments.push(comment);
                AppStorage.set('wechat_moments', moments);

                // AI è‡ªåŠ¨å›å¤ (å¦‚æœä¸æ˜¯æˆ‘è‡ªå·±çš„åŠ¨æ€)
                if (!moment.isUser && moment.authorId) {
                    try {
                        const char = AppStorage.get('wechat_chars', {})[moment.authorId];
                        if (char) {
                            const prompt = `ä½ çœ‹åˆ°${userProfile.name || 'ç”¨æˆ·'}åœ¨ä½ çš„æœ‹å‹åœˆè¯„è®ºäº†:"${content}"ã€‚è¯·ç”Ÿæˆä¸€æ¡ç®€çŸ­è‡ªç„¶çš„å›å¤(10-30å­—)ã€‚`;
                            const reply = await SettingsLogic.generateLLM(prompt, moment.authorId);

                            const aiComment = {
                                id: `comment_${Date.now()}_ai`,
                                authorId: moment.authorId,
                                authorName: moment.authorName,
                                content: reply.trim(),
                                timestamp: Date.now() + 1000
                            };

                            moment.comments.push(aiComment);
                            AppStorage.set('wechat_moments', moments);
                        }
                    } catch (err) {
                        console.error('[Moments] AIå›å¤å¤±è´¥:', err);
                    }
                }

                WeChatUI.renderMomentsList();
            };

            // AI ç”Ÿæˆæœ‹å‹åœˆ
            WeChatUI.generateMoments = async function () {
                Utils.showToast('AIæ­£åœ¨ç”Ÿæˆæœ‹å‹åœˆ...');

                const chars = AppStorage.get('wechat_chars', {});
                const allCharIds = Object.keys(chars);

                if (allCharIds.length === 0) {
                    Utils.showToast('æ²¡æœ‰å¯ç”¨çš„è§’è‰²');
                    return;
                }

                for (const cid of allCharIds) {
                    const char = chars[cid];

                    // ç§»é™¤æœ€è¿‘èŠå¤©å†…å®¹ï¼Œè®©AIç”Ÿæˆç‹¬ç«‹çš„å¿ƒæƒ…åŠ¨æ€
                    const recentMsgs = '';

                    const prompt = `ä½ æ˜¯${char.name}ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œç”Ÿæˆä¸€æ¡çœŸå®è‡ªç„¶çš„æœ‹å‹åœˆåŠ¨æ€ï¼Œå†…å®¹æ˜¯ä½ ä¸ªäººçš„å¿ƒæƒ…ã€ç”Ÿæ´»æ„Ÿæ‚Ÿæˆ–æ—¥å¸¸åˆ†äº«ï¼Œè€Œä¸æ˜¯å›å¤ä»»ä½•äººçš„æ¶ˆæ¯ã€‚

ã€æœ‹å‹åœˆç‰¹ç‚¹ã€‘
1. å†…å®¹é£æ ¼ï¼šæ—¥å¸¸ç”Ÿæ´»ã€å¿ƒæƒ…æ„Ÿæ‚Ÿã€å·¥ä½œå­¦ä¹ ã€å…´è¶£çˆ±å¥½ç­‰
2. è¯­æ°”è¦æ±‚ï¼šç¬¦åˆä½ çš„æ€§æ ¼ï¼Œå¯ä»¥è½»æ¾éšæ„ã€ä¹Ÿå¯ä»¥æ–‡è‰ºæ·±æ²‰
3. é•¿åº¦è¦æ±‚ï¼š15-80å­—ï¼Œç®€æ´æœ‰åŠ›
4. è¡¨æƒ…ä½¿ç”¨ï¼šé€‚å½“ä½¿ç”¨emojiè¡¨æƒ…ï¼ˆå¦‚ğŸ˜ŠğŸŒŸğŸ’•ç­‰ï¼‰ï¼Œä½†ä¸è¦è¿‡åº¦
5. çœŸå®æ„Ÿï¼šåƒçœŸå®çš„äººå‘æœ‹å‹åœˆï¼Œå†…å®¹å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä»–äººæ— å…³ï¼Œä¸è¦æåŠä»»ä½•å¯¹è¯å†…å®¹æˆ–ç”¨æˆ·ï¼Œå†…å®¹è¦è‡ªç„¶
6. æ ¼å¼è¦æ±‚ï¼šç›´æ¥è¾“å‡ºæœ‹å‹åœˆæ­£æ–‡ï¼Œä¸è¦åŠ "æœ‹å‹åœˆï¼š"ç­‰å‰ç¼€

ã€ä½ çš„äººè®¾ã€‘
${char.prompt || char.persona || 'è¿™æ˜¯ä¸€ä¸ªæ™®é€šè§’è‰²'}

ã€ç”Ÿæˆç¤ºä¾‹ã€‘
- ä»Šå¤©æ‹åˆ°è¶…ç¾çš„æ™šéœğŸŒ…
- ç»ˆäºæŠŠé‚£æœ¬ä¹¦çœ‹å®Œäº†ï¼Œç»“å±€æ²¡æƒ³åˆ°æ˜¯è¿™æ ·...
- å‘¨äº”å•¦ï¼è¿™å‘¨ç´¯æ­»äº†ğŸ˜´
- æ–°å‘ç°çš„å°åº—ï¼Œç¯å¢ƒå’Œå’–å•¡éƒ½è¶…èµâ˜•

ç°åœ¨è¯·ç”Ÿæˆä¸€æ¡æœ‹å‹åœˆåŠ¨æ€ï¼ˆåªè¾“å‡ºå†…å®¹ï¼Œä¸è¦å…¶ä»–è¯´æ˜ï¼‰ï¼š`;

                    try {
                        const content = await SettingsLogic.generateLLM(prompt, cid);
                        const trimmedContent = content.trim();

                        // æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹æ˜¯å¦ä¸ºç©º
                        if (!trimmedContent || trimmedContent === '') {
                            console.error(`[Moments] AIç”Ÿæˆå†…å®¹ä¸ºç©º (${char.name})`);
                            continue;
                        }

                        const moment = {
                            id: `moment_${Date.now()}_${cid}`,
                            authorId: cid,
                            authorName: char.name,
                            authorAvatar: char.avatar,
                            isUser: false,
                            content: trimmedContent,
                            images: [],
                            location: '',
                            timestamp: Date.now(),
                            likes: WeChatUI.generateRandomLikes(allCharIds, cid),
                            comments: []
                        };

                        const moments = AppStorage.get('wechat_moments', []);
                        moments.unshift(moment);
                        AppStorage.set('wechat_moments', moments);
                    } catch (err) {
                        console.error(`[Moments] AIç”Ÿæˆå¤±è´¥ (${char.name}):`, err);
                    }
                }

                WeChatUI.renderMomentsList();
                Utils.showToast('AIæœ‹å‹åœˆç”Ÿæˆå®Œæˆ');
            };

            // ç”Ÿæˆéšæœºç‚¹èµ
            WeChatUI.generateRandomLikes = function (allCharIds, excludeId) {
                const availableIds = allCharIds.filter(id => id !== excludeId);
                const count = Math.floor(Math.random() * 4); // 0-3ä¸ªç‚¹èµ
                const likes = [];

                for (let i = 0; i < count && availableIds.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * availableIds.length);
                    likes.push(availableIds[randomIndex]);
                    availableIds.splice(randomIndex, 1);
                }

                return likes;
            };

            // åˆ†äº«æœ‹å‹åœˆåˆ°èŠå¤©
            WeChatUI.shareMoment = function (momentId) {
                WeChatUI.tempShareMomentId = momentId;
                const chars = AppStorage.get('wechat_chars', {});
                const list = document.getElementById('share-contact-list');

                if (!list) {
                    Utils.showToast('åˆ†äº«æ¡†æœªæ‰¾åˆ°');
                    return;
                }

                const charsArray = Object.values(chars);
                if (charsArray.length === 0) {
                    Utils.showToast('æš‚æ— å¯åˆ†äº«çš„å¥½å‹');
                    return;
                }

                list.innerHTML = charsArray.map(c => `
                    <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer border border-transparent hover:border-blue-100 transition-all"
                         onclick="WeChatUI.confirmShareMoment('${c.id}')">
                        <img src="${c.avatar || WeChatUI.getRandomAvatar()}" class="w-10 h-10 rounded-lg bg-gray-200 object-cover">
                        <span class="text-gray-800 font-medium">${c.name}</span>
                    </div>
                `).join('');

                const modal = document.getElementById('modal-share-select');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            };

            // ç¡®è®¤åˆ†äº«æœ‹å‹åœˆ
            WeChatUI.confirmShareMoment = function (charId) {
                const momentId = WeChatUI.tempShareMomentId;
                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);

                if (!moment) {
                    Utils.showToast('æœ‹å‹åœˆä¸å­˜åœ¨');
                    return;
                }

                // æ„é€ åˆ†äº«å¡ç‰‡æ•°æ® - ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
                const cardData = {
                    id: moment.id,
                    author: moment.authorName,
                    text: moment.content || '[å›¾ç‰‡åŠ¨æ€]',
                    image: (moment.images && moment.images.length) ? moment.images[0] : ''
                };

                // å…³é—­åˆ†äº«å¼¹çª—
                const modal = document.getElementById('modal-share-select');
                if (modal) modal.classList.add('hidden');

                // åˆ‡æ¢åˆ°èŠå¤©é¡µé¢
                WeChatUI.loadChat(charId);

                // å‘é€æœ‹å‹åœˆå¡ç‰‡
                setTimeout(() => {
                    WeChatUI.pushMessage('moment_card', JSON.stringify(cardData), 'user', 'moment_card', null, charId);
                    Utils.showToast('åˆ†äº«æˆåŠŸ');
                }, 100);
            };

            // å¬å”¤äº’åŠ¨
            WeChatUI.summonInteraction = async function (momentId) {
                Utils.showToast('æ­£åœ¨å¬å”¤å¥½å‹äº’åŠ¨...');

                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) return;

                const chars = AppStorage.get('wechat_chars', {});
                const charIds = Object.keys(chars).filter(id => id !== moment.authorId);

                if (charIds.length === 0) {
                    Utils.showToast('æ²¡æœ‰å¯å¬å”¤çš„å¥½å‹');
                    return;
                }

                // éšæœºç‚¹èµ
                const likeCount = Math.floor(Math.random() * 3) + 1;
                const likeFriends = charIds.sort(() => Math.random() - 0.5).slice(0, likeCount);
                likeFriends.forEach(id => {
                    if (!moment.likes.includes(id)) {
                        moment.likes.push(id);
                    }
                });

                // éšæœºè¯„è®º
                const commentCount = Math.floor(Math.random() * 3);
                const commentFriends = charIds.sort(() => Math.random() - 0.5).slice(0, commentCount);

                for (const charId of commentFriends) {
                    const char = chars[charId];
                    try {
                        const prompt = `ä½ çœ‹åˆ°æœ‹å‹${moment.authorName}å‘çš„æœ‹å‹åœˆ:"${moment.content}"ã€‚è¯·ç”Ÿæˆä¸€æ¡ç®€çŸ­çš„ç‚¹èµè¯„è®º(5-20å­—)ã€‚`;
                        const commentText = await SettingsLogic.generateLLM(prompt, charId);

                        moment.comments.push({
                            id: `comment_${Date.now()}_${charId}`,
                            authorId: charId,
                            authorName: char.name,
                            content: commentText.trim(),
                            timestamp: Date.now()
                        });
                    } catch (err) {
                        console.error(`[Moments] å¬å”¤è¯„è®ºå¤±è´¥ (${char.name}):`, err);
                    }
                }

                AppStorage.set('wechat_moments', moments);
                WeChatUI.renderMomentsList();
                Utils.showToast('äº’åŠ¨å¬å”¤æˆåŠŸ');
            };

            // èœå•æ§åˆ¶å‡½æ•°
            WeChatUI.toggleMomentMenu = function (momentId, event) {
                event.stopPropagation();
                const menu = document.getElementById(`moment-menu-${momentId}`);
                if (!menu) return;

                // å…³é—­å…¶ä»–æ‰€æœ‰èœå•
                document.querySelectorAll('.moment-menu-dropdown').forEach(m => {
                    if (m.id !== `moment-menu-${momentId}`) {
                        m.style.display = 'none';
                    }
                });

                // åˆ‡æ¢å½“å‰èœå•
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            };

            WeChatUI.closeMomentMenu = function (momentId) {
                const menu = document.getElementById(`moment-menu-${momentId}`);
                if (menu) menu.style.display = 'none';
            };

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰èœå•
            document.addEventListener('click', function () {
                document.querySelectorAll('.moment-menu-dropdown').forEach(m => {
                    m.style.display = 'none';
                });
            });

            // ä»æœ‹å‹åœˆå¤´åƒæ‰“å¼€è§’è‰²ä¸»é¡µ
            WeChatUI.openCharFromMoment = function (authorId) {
                if (authorId === 'user') {
                    // ç”¨æˆ·è‡ªå·±çš„åŠ¨æ€ï¼Œæ‰“å¼€"æˆ‘"é¡µé¢
                    WeChatUI.switchTab('me');
                } else {
                    // å…¶ä»–è§’è‰²ï¼Œæ‰“å¼€èŠå¤©å¹¶æ˜¾ç¤ºè§’è‰²è®¾ç½®
                    const chars = AppStorage.get('wechat_chars', {});
                    if (chars[authorId]) {
                        WeChatUI.loadChat(authorId);
                        // å»¶è¿Ÿä¸€ä¸‹å†æ‰“å¼€è®¾ç½®ï¼Œç¡®ä¿èŠå¤©ç•Œé¢å·²åŠ è½½
                        setTimeout(() => {
                            WeChatUI.openCharSettings(authorId);
                        }, 100);
                    }
                }
            };

            // ç¼–è¾‘åŠ¨æ€ï¼ˆæ‰€æœ‰åŠ¨æ€éƒ½å¯ç¼–è¾‘ï¼‰
            WeChatUI.editMoment = function (momentId) {
                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if (!moment) return;

                WeChatUI.openMomentsEditor();
                document.getElementById('moment-content-input').value = moment.content;
                document.getElementById('moment-location-input').value = moment.location || '';
                WeChatUI.momentDraftImages = [...moment.images];
                WeChatUI.updateMomentImagesPreview();

                // ä¿å­˜ä¿®æ”¹æ—¶ç›´æ¥è¦†ç›–
                WeChatUI.editingMomentId = momentId;
                const publishBtn = document.querySelector('#modal-publish-moment button[onclick*="publishMoment"]');
                if (publishBtn) {
                    publishBtn.onclick = () => WeChatUI.saveEditedMoment();
                }
            };

            // ä¿å­˜ç¼–è¾‘çš„åŠ¨æ€
            WeChatUI.saveEditedMoment = function () {
                const content = document.getElementById('moment-content-input').value.trim();
                const location = document.getElementById('moment-location-input').value.trim();

                if (!content && WeChatUI.momentDraftImages.length === 0) {
                    Utils.showToast('è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©å›¾ç‰‡');
                    return;
                }

                const moments = AppStorage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === WeChatUI.editingMomentId);
                if (!moment) return;

                moment.content = content;
                moment.location = location;
                moment.images = [...WeChatUI.momentDraftImages];

                AppStorage.set('wechat_moments', moments);
                WeChatUI.closeMomentsEditor();
                WeChatUI.renderMomentsList();
                Utils.showToast('ä¿®æ”¹æˆåŠŸ');

                // é‡ç½®ä¸ºå‘å¸ƒæ¨¡å¼
                delete WeChatUI.editingMomentId;
                const publishBtn = document.querySelector('#modal-publish-moment button[onclick*="publishMoment"]');
                if (publishBtn) {
                    publishBtn.onclick = () => WeChatUI.publishMoment();
                }
            };

            // åˆ é™¤æˆ‘çš„åŠ¨æ€
            WeChatUI.deleteMoment = function (momentId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ')) return;

                const moments = AppStorage.get('wechat_moments', []);
                const index = moments.findIndex(m => m.id === momentId);
                if (index > -1) {
                    moments.splice(index, 1);
                    AppStorage.set('wechat_moments', moments);
                    WeChatUI.renderMomentsList();
                    Utils.showToast('å·²åˆ é™¤');
                }
            };

            // ç›‘å¬æœ‹å‹åœˆé¡µé¢æ‰“å¼€ï¼Œè‡ªåŠ¨æ¸²æŸ“åˆ—è¡¨
            const momentsObserver = new MutationObserver(() => {
                const momentsPage = document.getElementById('subpage-moments');
                if (momentsPage && momentsPage.classList.contains('translate-x-0')) {
                    // é¡µé¢å·²æ‰“å¼€ï¼Œæ¸²æŸ“åˆ—è¡¨
                    WeChatUI.renderMomentsList();
                }
            });

            // å¼€å§‹è§‚å¯Ÿ
            const momentsPage = document.getElementById('subpage-moments');
            if (momentsPage) {
                momentsObserver.observe(momentsPage, {
                    attributes: true,
                    attributeFilter: ['class']
                });

                // ã€ä¿®å¤ã€‘é¡µé¢åŠ è½½æ—¶ç«‹å³æ¸²æŸ“ä¸€æ¬¡ï¼Œä¸ç­‰å¾…MutationObserver
                WeChatUI.renderMomentsList();
            }

            console.log('[MomentsUI] Moments UI initialized');

            // è‡ªåŠ¨å‘å¸ƒåŠ¨æ€ (Ported from MomentsOS)
            WeChatUI.startAutoPost = function () {
                // æ¸…é™¤æ—§å®šæ—¶å™¨
                if (WeChatUI.autoMomentTimer) clearInterval(WeChatUI.autoMomentTimer);

                const settings = AppStorage.get('wechat_moments_settings', {
                    privacy: { aiPost: false } // é»˜è®¤å…³é—­è‡ªåŠ¨ç”Ÿæˆ
                });
                // åªæœ‰æ˜ç¡®è®¾ç½®ä¸ºtrueæ—¶æ‰å¼€å¯
                const aiPost = settings.privacy && settings.privacy.aiPost === true;

                if (aiPost) {
                    const freqMap = { 'never': 0, 'low': 120, 'medium': 60, 'high': 30 };
                    let interval = freqMap[(settings.ai && settings.ai.autoGenFreq) || 'medium'] || 60;

                    if (interval > 0) {
                        console.log(`[MomentsUI] è‡ªåŠ¨å‘å¸ƒå·²å¼€å¯: æ¯ ${interval} åˆ†é’Ÿ`);
                        WeChatUI.autoMomentTimer = setInterval(() => {
                            WeChatUI.generateMoments();
                        }, interval * 60 * 1000);
                    } else {
                        console.log('[MomentsUI] è‡ªåŠ¨å‘å¸ƒå·²å…³é—­');
                    }
                } else {
                    console.log('[MomentsUI] è‡ªåŠ¨å‘å¸ƒå·²ç¦ç”¨ (éšç§è®¾ç½®)');
                }
            };
            WeChatUI.startAutoPost();
            // --- Moments Settings Logic ---

            // æ‰“å¼€æœ‹å‹åœˆè®¾ç½®
            WeChatUI.openMomentsSettings = function () {
                const settings = AppStorage.get('wechat_moments_settings', {
                    profile: { backgroundImage: '', bio: '', avatar: '', name: '' },
                    display: { limit: 10, autoload: true },
                    privacy: { aiInteract: true, aiPost: true }
                });

                // Profile
                document.getElementById('moments-settings-bg').src = settings.profile.backgroundImage || 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80';
                document.getElementById('moments-settings-avatar').src = settings.profile.avatar || AppStorage.get('wechat_user_profile', {}).avatar || '';
                document.getElementById('moments-settings-name').textContent = settings.profile.name || AppStorage.get('wechat_user_profile', {}).name || 'ä¹”ä¹”';
                document.getElementById('moments-setting-bio').value = settings.profile.bio || '';

                // Display
                const limitSelect = document.getElementById('moments-setting-limit');
                if (limitSelect) limitSelect.value = settings.display.limit || 10;

                const autoloadCheck = document.getElementById('moments-setting-autoload');
                if (autoloadCheck) autoloadCheck.checked = settings.display.autoload !== false;

                // Privacy
                const aiInteractCheck = document.getElementById('moments-setting-ai-interact');
                if (aiInteractCheck) aiInteractCheck.checked = settings.privacy.aiInteract !== false;

                const aiPostCheck = document.getElementById('moments-setting-ai-post');
                if (aiPostCheck) aiPostCheck.checked = settings.privacy.aiPost !== false;

                // ç›´æ¥ç”Ÿæˆå¥½å‹åˆ—è¡¨
                const chars = AppStorage.get('wechat_chars', {});
                const npcs = AppStorage.get('wechat_npcs', {});
                const friendsList = document.getElementById('friends-list');

                if (friendsList) {
                    // åˆå¹¶æ‰€æœ‰å¥½å‹æ•°æ®
                    const allFriends = [];

                    // æ·»åŠ èŠå¤©è§’è‰²
                    if (chars && typeof chars === 'object') {
                        Object.values(chars).forEach(char => {
                            allFriends.push({
                                id: char.id,
                                name: char.name,
                                avatar: char.avatar,
                                description: char.persona || 'èŠå¤©è§’è‰²'
                            });
                        });
                    }

                    // æ·»åŠ NPCè§’è‰²
                    if (npcs && typeof npcs === 'object') {
                        Object.values(npcs).forEach(npc => {
                            allFriends.push({
                                id: npc.id,
                                name: npc.name,
                                avatar: npc.avatar,
                                description: npc.personality || 'NPCè§’è‰²'
                            });
                        });
                    }

                    // æ£€æŸ¥æ˜¯å¦æœ‰å¥½å‹æ•°æ®
                    if (allFriends.length === 0) {
                        friendsList.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— å¥½å‹æ•°æ®</div>';
                    } else {
                        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
                        friendsList.innerHTML = allFriends.map(friend => `
                            <div class="friend-item flex items-center justify-between p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <div class="flex items-center gap-3">
                                    <img src="${friend.avatar || WeChatUI.getRandomAvatar()}" class="w-10 h-10 rounded-full object-cover">
                                    <div class="friend-info">
                                        <div class="font-medium text-gray-800">${friend.name}</div>
                                        <div class="text-xs text-gray-500">${friend.description}</div>
                                    </div>
                                </div>
                                <label class="friend-checkbox-container">
                                    <input type="checkbox" class="friend-checkbox" value="${friend.id}" data-char-name="${friend.name}">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        `).join('');
                    }
                }

                const modal = document.getElementById('modal-moments-settings');
                modal.classList.remove('hidden');
                modal.classList.add('show');
            };

            // å…³é—­æœ‹å‹åœˆè®¾ç½®
            WeChatUI.closeMomentsSettings = function () {
                const modal = document.getElementById('modal-moments-settings');
                modal.classList.add('hidden');
                modal.classList.remove('show');
            };

            // ä¿å­˜è®¾ç½®
            WeChatUI.saveMomentsSettings = function () {
                const bg = document.getElementById('moments-settings-bg').src;
                const avatar = document.getElementById('moments-settings-avatar').src;
                const bio = document.getElementById('moments-setting-bio').value;
                const limit = parseInt(document.getElementById('moments-setting-limit').value);
                const autoload = document.getElementById('moments-setting-autoload').checked;
                const aiInteract = document.getElementById('moments-setting-ai-interact').checked;
                const aiPost = document.getElementById('moments-setting-ai-post').checked;

                const settings = {
                    profile: { backgroundImage: bg, bio, avatar, name: document.getElementById('moments-settings-name').textContent },
                    display: { limit, autoload },
                    privacy: { aiInteract, aiPost }
                };

                AppStorage.set('wechat_moments_settings', settings);
                Utils.showToast('è®¾ç½®å·²ä¿å­˜');
                WeChatUI.closeMomentsSettings();
                WeChatUI.renderMomentsList(); // Refresh list to apply changes

                // Update user profile globally if avatar changed
                const userProfile = AppStorage.get('wechat_user_profile', {});
                if (avatar && avatar !== userProfile.avatar) {
                    userProfile.avatar = avatar;
                    AppStorage.set('wechat_user_profile', userProfile);
                }
            };

            // Image Upload handlers
            WeChatUI.triggerBgSelect = () => document.getElementById('moment-bg-input').click();
            WeChatUI.triggerAvatarSelect = () => document.getElementById('moment-avatar-input').click();

            WeChatUI.handleBgUpload = function (input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => document.getElementById('moments-settings-bg').src = e.target.result;
                    reader.readAsDataURL(input.files[0]);
                }
            };

            WeChatUI.handleAvatarUpload = function (input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => document.getElementById('moments-settings-avatar').src = e.target.result;
                    reader.readAsDataURL(input.files[0]);
                }
            };

            // Clear Data
            WeChatUI.clearMomentsData = function (type) {
                if (!confirm(type === 'user' ? 'ç¡®å®šè¦æ¸…ç©ºæˆ‘å‘å¸ƒçš„æ‰€æœ‰æœ‹å‹åœˆå—ï¼Ÿ' : 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰AIç”Ÿæˆçš„æœ‹å‹åœˆå—ï¼Ÿ')) return;

                let moments = AppStorage.get('wechat_moments', []);
                if (type === 'user') {
                    moments = moments.filter(m => !m.isUser);
                } else {
                    moments = moments.filter(m => m.isUser);
                }

                AppStorage.set('wechat_moments', moments);
                WeChatUI.renderMomentsList();
                Utils.showToast('æ•°æ®å·²æ¸…ç©º');
            };

            // ç”Ÿæˆéšæœºå¤´åƒ
            WeChatUI.getRandomAvatar = function () {
                // ä½¿ç”¨é»˜è®¤å¤´åƒæ•°ç»„
                const defaultAvatars = [
                    'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100&h=100&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=100&h=100&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=100&h=100&fit=crop&crop=face',
                    'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=100&h=100&fit=crop&crop=face'
                ];
                // éšæœºé€‰æ‹©ä¸€ä¸ªå¤´åƒ
                return defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];
            };

            // ç”Ÿæˆå¥½å‹åˆ—è¡¨
            WeChatUI.generateFriendsList = function () {
                const chars = AppStorage.get('wechat_chars', {});
                const friendsList = document.getElementById('friends-list');

                if (friendsList) {
                    if (Object.keys(chars).length === 0) {
                        friendsList.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— å¥½å‹æ•°æ®</div>';
                    } else {
                        friendsList.innerHTML = Object.values(chars).map(char => `
                            <div class="friend-item flex items-center justify-between p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                <div class="flex items-center gap-3">
                                    <img src="${char.avatar || WeChatUI.getRandomAvatar()}" class="w-10 h-10 rounded-full object-cover">
                                    <div class="friend-info">
                                        <div class="font-medium text-gray-800">${char.name}</div>
                                        <div class="text-xs text-gray-500">${char.persona || 'æ™®é€šè§’è‰²'}</div>
                                    </div>
                                </div>
                                <label class="friend-checkbox-container">
                                    <input type="checkbox" class="friend-checkbox" value="${char.id}" data-char-name="${char.name}">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                        `).join('');
                    }
                }
            };

            // æ¸…ç©ºæ‰€æœ‰æœ‹å‹åœˆ
            WeChatUI.clearAllMoments = function () {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ‹å‹åœˆå—ï¼Ÿ')) {
                    AppStorage.set('wechat_moments', []);
                    WeChatUI.renderMomentsList();
                    Utils.showToast('æ‰€æœ‰æœ‹å‹åœˆå·²æ¸…ç©º');
                }
            };

            // æ¸…ç©ºé€‰ä¸­å¥½å‹çš„æœ‹å‹åœˆ
            WeChatUI.clearSelectedFriendsMoments = function () {
                const selectedCheckboxes = document.querySelectorAll('.friend-checkbox:checked');
                if (selectedCheckboxes.length === 0) {
                    Utils.showToast('è¯·å…ˆé€‰æ‹©å¥½å‹');
                    return;
                }

                const selectedCharIds = Array.from(selectedCheckboxes).map(cb => cb.value);
                const selectedCharNames = Array.from(selectedCheckboxes).map(cb => cb.dataset.charName);

                if (confirm(`ç¡®å®šè¦æ¸…ç©ºä»¥ä¸‹å¥½å‹çš„æœ‹å‹åœˆå—ï¼Ÿ\n${selectedCharNames.join('\n')}`)) {
                    const moments = AppStorage.get('wechat_moments', []);
                    const filteredMoments = moments.filter(m => !selectedCharIds.includes(m.authorId));
                    AppStorage.set('wechat_moments', filteredMoments);
                    WeChatUI.renderMomentsList();
                    Utils.showToast(`${selectedCharNames.length}ä½å¥½å‹çš„æœ‹å‹åœˆå·²æ¸…ç©º`);
                }
            };

        })();
    </script>
    <!-- Moments Settings Modal -->
    <div id="modal-moments-settings" class="modal-overlay hidden">
        <div class="modal-box w-full h-full max-w-none rounded-none bg-slate-50 flex flex-col p-0 overflow-hidden">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-100 flex-shrink-0">
                <button onclick="WeChatUI.closeMomentsSettings()"
                    class="w-8 h-8 flex items-center justify-center rounded-full active:bg-gray-100">
                    <i class="fa-solid fa-chevron-left text-gray-600"></i>
                </button>
                <div class="font-bold text-base text-gray-800">æœ‹å‹åœˆè®¾ç½®</div>
                <div class="w-8"></div>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4">

                <!-- Profile Section -->
                <div class="settings-group">
                    <div class="settings-group-title">ä¸ªäººèµ„æ–™</div>
                    <div class="settings-profile-preview" id="moments-settings-preview"
                        onclick="WeChatUI.triggerBgSelect()">
                        <img id="moments-settings-bg" class="settings-profile-bg"
                            src="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=800&q=80">
                        <img id="moments-settings-avatar" class="settings-profile-avatar" src="">
                        <div id="moments-settings-name" class="settings-profile-name">ä¹”ä¹”</div>
                        <div
                            class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                            <span class="text-white text-sm font-bold"><i
                                    class="fa-solid fa-camera mr-1"></i>æ›´æ¢èƒŒæ™¯</span>
                        </div>
                    </div>

                    <div class="settings-item flex items-center justify-between">
                        <span class="settings-item-label">ä¸ªæ€§ç­¾å</span>
                        <div class="flex items-center gap-2 flex-1 ml-4">
                            <input type="text" id="moments-setting-bio"
                                class="text-right text-sm text-gray-600 bg-transparent outline-none flex-1"
                                placeholder="è®¾ç½®ä¸ªæ€§ç­¾å">
                            <button onclick="document.getElementById('moments-setting-bio').value=''"
                                class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">æ¸…é™¤</button>
                        </div>
                    </div>

                    <div class="settings-item flex items-center justify-between">
                        <span class="settings-item-label">ä¸ªäººèµ„æ–™èƒŒæ™¯</span>
                        <button onclick="WeChatUI.clearMomentsBg()"
                            class="text-xs bg-red-50 text-red-500 px-3 py-1 rounded-full">æ¸…é™¤èƒŒæ™¯</button>
                    </div>

                    <div class="settings-item">
                        <span class="settings-item-label">æœ‹å‹åœˆå¤´åƒ</span>
                        <div class="flex gap-2">
                            <button onclick="WeChatUI.triggerAvatarSelect()"
                                class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full">æ›´æ¢å¤´åƒ</button>
                            <button onclick="WeChatUI.clearMomentsAvatar()"
                                class="text-xs bg-red-50 text-red-500 px-3 py-1 rounded-full">æ¸…é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- Display Section -->
                <div class="settings-group">
                    <div class="settings-group-title">æ˜¾ç¤ºè®¾ç½®</div>
                    <div class="settings-item">
                        <div class="flex flex-col">
                            <span class="settings-item-label">æ¯é¡µåŠ è½½æ•°é‡</span>
                            <span class="settings-item-desc">å•æ¬¡æ»‘åŠ¨åŠ è½½çš„åŠ¨æ€æ¡æ•°</span>
                        </div>
                        <select id="moments-setting-limit" class="settings-select">
                            <option value="5">5æ¡</option>
                            <option value="10" selected>10æ¡</option>
                            <option value="20">20æ¡</option>
                            <option value="50">50æ¡</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <div class="flex flex-col">
                            <span class="settings-item-label">å›¾ç‰‡è‡ªåŠ¨åŠ è½½</span>
                        </div>
                        <label class="toggle-switch scale-75">
                            <input type="checkbox" id="moments-setting-autoload" checked>
                        </label>
                    </div>
                </div>

                <!-- Friends List Display Settings -->
                <div class="settings-group">
                    <div class="settings-group-title">æ˜¾ç¤ºè®¾ç½®</div>
                    <div class="settings-item">
                        <span class="settings-item-label">æ­¤å¤„å¯æŸ¥çœ‹å·²ç¼“å­˜çš„å¥½å‹æ•°æ®ï¼š</span>
                    </div>
                    <div class="p-2 bg-gray-50 rounded-lg max-h-40 overflow-y-auto mb-4">
                        <div id="friends-list">
                            <!-- å¥½å‹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="WeChatUI.clearAllMoments()"
                            class="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-red-600 active:scale-95 transition-all">
                            æ¸…ç©ºæ‰€æœ‰æœ‹å‹åœˆ
                        </button>
                        <button onclick="WeChatUI.clearSelectedFriendsMoments()"
                            class="flex-1 bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-orange-600 active:scale-95 transition-all">
                            æ¸…ç©ºé€‰ä¸­å¥½å‹æœ‹å‹åœˆ
                        </button>
                    </div>
                </div>

                <!-- Privacy & AI Section -->
                <div class="settings-group">
                    <div class="settings-group-title">éšç§ä¸AI</div>
                    <div class="settings-item">
                        <div class="flex flex-col">
                            <span class="settings-item-label">å…è®¸AIè‡ªåŠ¨äº’åŠ¨</span>
                            <span class="settings-item-desc">è‡ªåŠ¨è¯„è®ºå’Œç‚¹èµä½ çš„åŠ¨æ€</span>
                        </div>
                        <label class="toggle-switch scale-75">
                            <input type="checkbox" id="moments-setting-ai-interact" checked>
                        </label>
                    </div>

                    <div class="settings-item">
                        <div class="flex flex-col">
                            <span class="settings-item-label">å…è®¸AIè‡ªåŠ¨å‘å¸–</span>
                            <span class="settings-item-desc">æ ¹æ®å‰§æƒ…è‡ªåŠ¨ç”ŸæˆåŠ¨æ€</span>
                        </div>
                        <label class="toggle-switch scale-75">
                            <input type="checkbox" id="moments-setting-ai-post" checked>
                        </label>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="settings-group">
                    <div class="settings-group-title">æ•°æ®ç®¡ç†</div>
                    <div class="settings-item" onclick="WeChatUI.clearMomentsData('user')">
                        <span class="settings-item-label text-red-500">æ¸…ç©ºæˆ‘çš„æœ‹å‹åœˆ</span>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                    <div class="settings-item" onclick="WeChatUI.clearMomentsData('ai')">
                        <span class="settings-item-label text-red-500">æ¸…ç©ºAIæœ‹å‹åœˆ</span>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    </div>
                </div>

                <div class="p-4">
                    <button onclick="WeChatUI.saveMomentsSettings()"
                        class="w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-green-600 active:scale-95 transition-all">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>

            <!-- Hidden Inputs for Image Upload -->
            <input type="file" id="moment-bg-input" accept="image/*" class="hidden"
                onchange="WeChatUI.handleBgUpload(this)">
            <input type="file" id="moment-avatar-input" accept="image/*" class="hidden"
                onchange="WeChatUI.handleAvatarUpload(this)">
        </div>
    </div>





    <style>
        /* --- Advanced Music Player CSS --- */
        .music-player {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.93), rgba(40, 40, 40, 0.88));
            backdrop-filter: blur(30px) saturate(150%);
            border-radius: 20px;
            /* Slightly smaller radius */
            padding: 15px 20px 20px;
            /* Reduced padding */
            width: 85%;
            /* Slightly narrower */
            max-width: 360px;
            /* Reduced max width */
            max-height: 80vh;
            /* Reduced slightly to ensure it fits on smaller screens */
            /* Reduced slightly to ensure it fits on smaller screens */
            display: none;
            flex-direction: column;
            /* Enable flex column */
            overflow: hidden;
            /* Hide overflow on container */

            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.7),
                0 0 0 1px rgba(204, 170, 102, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(204, 170, 102, 0.25);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20002;
            display: none;
        }

        .player-content-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 5px;
            scrollbar-width: none;
        }

        .player-content-scroll::-webkit-scrollbar {
            display: none;
        }

        .music-player::-webkit-scrollbar {
            display: none;
        }

        /* Hide webkit scrollbar */

        .music-player.active {
            display: flex;
            /* Changed from block to flex */
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* é¡¶éƒ¨æ§åˆ¶æ  */
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            /* Reduced margin */
            padding-bottom: 5px;
            /* Reduced padding */
        }

        .listening-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            flex: 1;
        }

        .header-btn {
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn i {
            font-size: 18px;
        }

        .header-btn:hover {
            color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        /* å¤´åƒåŒºåŸŸ - é¡¶éƒ¨å±…ä¸­ */
        .avatars-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            /* Reduced from 18px */
            position: relative;
            height: 60px;
            /* Reduced from 75px */
            padding-top: 0;
        }

        .avatar-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0px;
            z-index: 10;
        }

        /* å£°çº¹èƒŒæ™¯ç¯ç»•å¤´åƒ */
        .avatar-wrapper::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            /* Reduced from 200px */
            height: 60px;
            /* Reduced from 80px */
            background: radial-gradient(ellipse at center,
                    rgba(204, 170, 102, 0.05) 0%,
                    transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }

        .avatar {
            width: 45px;
            /* Reduced from 52px */
            height: 45px;
            /* Reduced from 52px */
            border-radius: 50%;
            border: 2.5px solid rgba(204, 170, 102, 0.8);
            box-shadow: 0 4px 15px rgba(204, 170, 102, 0.5),
                0 0 0 3px rgba(26, 26, 26, 0.6);
            object-fit: cover;
            position: relative;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .avatar:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(204, 170, 102, 0.7);
        }

        /* çˆ±å¿ƒæ³¡æ³¡ */
        .heart-bubble {
            position: relative;
            width: 24px;
            height: 24px;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heart-bubble svg {
            width: 20px;
            height: 20px;
            filter: drop-shadow(0 0 8px rgba(255, 100, 150, 0.6));
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            10% {
                transform: scale(1.2);
            }

            20% {
                transform: scale(1);
            }

            30% {
                transform: scale(1.2);
            }

            40% {
                transform: scale(1);
            }
        }

        /* çˆ±å¿ƒæ³¡æ³¡ç²’å­æ•ˆæœ */
        .heart-bubble::before,
        .heart-bubble::after {
            content: 'â™¥';
            position: absolute;
            font-size: 8px;
            color: rgba(255, 100, 150, 0.4);
            animation: floatUp 3s ease-in-out infinite;
        }

        .heart-bubble::before {
            left: -8px;
            animation-delay: 0.5s;
        }

        .heart-bubble::after {
            right: -8px;
            animation-delay: 1.5s;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }

            20% {
                opacity: 1;
                transform: translateY(-5px) scale(1);
            }

            100% {
                transform: translateY(-25px) scale(0.5);
                opacity: 0;
            }
        }

        /* å£°çº¹åŠ¨ç”» - æ‹‰é•¿åˆ°è¾¹ç¼˜ */
        .sound-wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none;
            align-items: center;
            gap: 2px;
            width: 99%;
            justify-content: center;
            z-index: 1;
        }

        .sound-wave.active {
            display: flex;
        }

        .wave-bar {
            width: 3px;
            background: linear-gradient(to top, #ccaa66, #d4af37);
            border-radius: 2px;
            animation: wave 0.8s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(204, 170, 102, 0.6);
        }

        .wave-bar:nth-child(1) {
            height: 12px;
            animation-delay: 0s;
        }

        .wave-bar:nth-child(2) {
            height: 20px;
            animation-delay: 0.1s;
        }

        .wave-bar:nth-child(3) {
            height: 28px;
            animation-delay: 0.15s;
        }

        .wave-bar:nth-child(4) {
            height: 35px;
            animation-delay: 0.2s;
        }

        .wave-bar:nth-child(5) {
            height: 28px;
            animation-delay: 0.25s;
        }

        .wave-bar:nth-child(6) {
            height: 20px;
            animation-delay: 0.3s;
        }

        .wave-bar:nth-child(7) {
            height: 12px;
            animation-delay: 0.35s;
        }

        @keyframes wave {

            0%,
            100% {
                transform: scaleY(0.4);
                opacity: 0.4;
            }

            50% {
                transform: scaleY(1);
                opacity: 1;
            }
        }

        /* æ­Œè¯åŒºåŸŸ - å¡æ‹‰OKé£æ ¼ */
        .lyrics-section {
            background: linear-gradient(135deg, rgba(204, 170, 102, 0.08), rgba(212, 175, 55, 0.08));
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 10px;
            /* Reduced from 15px */
            min-height: 40px;
            /* Reduced from 50px */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid rgba(204, 170, 102, 0.15);
            position: relative;
            overflow: hidden;
        }

        .lyrics-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(204, 170, 102, 0.15), transparent);
            transition: left 0.5s;
        }

        .lyrics-section:hover::before {
            left: 100%;
        }

        .lyrics-section:hover {
            background: linear-gradient(135deg, rgba(204, 170, 102, 0.12), rgba(212, 175, 55, 0.12));
            border-color: rgba(204, 170, 102, 0.3);
        }

        .lyrics-text {
            text-align: center;
            font-size: 12px;
            /* Slightly smaller text */
            line-height: 1.6;
            color: #ccaa66;
            font-weight: 500;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(204, 170, 102, 0.3);
        }

        /* ç¢Ÿç‰‡åŒºåŸŸ - ä¼˜åŒ–è¾¹æ¡† */
        .disc-section {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
            /* Reduced from 18px */
        }

        .disc-container {
            width: 140px;
            /* Reduced from 170px */
            height: 140px;
            /* Reduced from 170px */
            position: relative;
        }

        .disc {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8),
                inset 0 0 20px rgba(204, 170, 102, 0.1);
            position: relative;
            transition: transform 0.3s;
            border: 1px solid rgba(204, 170, 102, 0.2);
        }

        .disc.spinning {
            animation: spin 12s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .disc-center {
            width: 30px;
            /* Reduced from 35px */
            height: 30px;
            /* Reduced from 35px */
            background: radial-gradient(circle, #1a1a1a, #0a0a0a);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid rgba(204, 170, 102, 0.3);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        /* ä¸“è¾‘å°é¢ - é“ºæ»¡å”¤ç‰‡ */
        .album-cover {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .song-title {
            font-size: 17px;
            font-weight: 600;
            color: #ccaa66;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(204, 170, 102, 0.3);
        }

        .song-artist {
            font-size: 12px;
            color: #999;
        }

        /* è¿›åº¦æ¡ */
        .progress-section {
            margin-bottom: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #ccaa66, #d4af37);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
            box-shadow: 0 0 10px rgba(204, 170, 102, 0.5);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }

        /* æ§åˆ¶æŒ‰é’® - ç™½è‰²ç®€æ´é£æ ¼ */
        .controls {
            display: flex !important;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-bottom: 15px;
            opacity: 1 !important;
            visibility: visible !important;
            z-index: 100;
            background: none;
            min-height: 60px;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 10px;
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            transform: scale(1.15);
            color: rgba(255, 255, 255, 1);
        }

        .control-btn i {
            font-size: 24px;
        }

        .control-btn.play-pause i {
            font-size: 52px;
            color: rgba(255, 255, 255, 0.95);
        }

        .control-btn.play-pause:hover i {
            color: #ffffff;
        }

        /* åº•éƒ¨å·¥å…·æ  - ç™½è‰²ç®€æ´é£æ ¼ */
        .toolbar {
            display: flex;
            justify-content: space-around;
            padding: 12px 0 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .toolbar-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn i {
            font-size: 19px;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        .toolbar-btn.active {
            background: rgba(204, 170, 102, 0.15);
            color: #d4af37;
        }

        /* å¼¹çª—é®ç½© */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 30000 !important;
            /* Much higher than music player */
            backdrop-filter: blur(8px);
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Fix: Ensure removing 'hidden' is enough to show it */
        .modal-overlay:not(.hidden) {
            display: flex;
        }

        /* å¼¹çª—å®¹å™¨ */
        .modal {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border-radius: 20px;
            padding: 25px;
            width: 90%;
            max-width: 420px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9),
                0 0 1px rgba(204, 170, 102, 0.3);
            border: 1px solid rgba(204, 170, 102, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(204, 170, 102, 0.15);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #ccaa66;
            text-shadow: 0 0 10px rgba(204, 170, 102, 0.3);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
            line-height: 1;
        }

        .modal-close:hover {
            color: #ccaa66;
            transform: rotate(90deg);
        }

        /* æœç´¢å¼¹çª— */
        .search-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .search-input {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(204, 170, 102, 0.2);
            border-radius: 10px;
            font-size: 14px;
            color: #ccc;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(204, 170, 102, 0.5);
            box-shadow: 0 0 15px rgba(204, 170, 102, 0.2);
        }

        .source-select {
            padding: 12px;
            border: 1px solid rgba(204, 170, 102, 0.2);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
            cursor: pointer;
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #ccaa66, #d4af37);
            color: #1a1a1a;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(204, 170, 102, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(204, 170, 102, 0.5);
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .search-item {
            padding: 12px;
            border-bottom: 1px solid rgba(204, 170, 102, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
        }

        .search-item:hover {
            background: rgba(204, 170, 102, 0.1);
        }

        .search-item-cover {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid rgba(204, 170, 102, 0.2);
        }

        .search-item-info {
            flex: 1;
        }

        .search-item-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 3px;
            color: #ccc;
        }

        .search-item-artist {
            font-size: 12px;
            color: #888;
        }

        /* æ’­æ”¾åˆ—è¡¨å¼¹çª— */
        .playlist-items {
            max-height: 450px;
            overflow-y: auto;
        }

        .playlist-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            border: 1px solid rgba(204, 170, 102, 0.1);
        }

        .playlist-item:hover {
            background: rgba(204, 170, 102, 0.1);
            transform: translateX(3px);
        }

        .playlist-item.playing {
            background: linear-gradient(to right, rgba(204, 170, 102, 0.2), rgba(212, 175, 55, 0.15));
            border-color: rgba(204, 170, 102, 0.3);
            box-shadow: 0 0 15px rgba(204, 170, 102, 0.2);
        }

        .song-name {
            font-weight: 500;
            color: #ccc;
            font-size: 14px;
        }

        .delete-btn {
            color: #ff6666;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            transition: transform 0.2s;
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        .add-local-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, rgba(204, 170, 102, 0.2), rgba(212, 175, 55, 0.2));
            color: #ccaa66;
            border: 1px solid rgba(204, 170, 102, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .add-local-btn:hover {
            background: linear-gradient(to right, rgba(204, 170, 102, 0.3), rgba(212, 175, 55, 0.3));
            box-shadow: 0 0 15px rgba(204, 170, 102, 0.3);
        }

        .lyrics-display {
            background: linear-gradient(135deg, rgba(204, 170, 102, 0.08), rgba(212, 175, 55, 0.08));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(204, 170, 102, 0.2);
        }

        .lyrics-display-text {
            text-align: center;
            font-size: 15px;
            line-height: 1.8;
            color: #ccaa66;
            font-weight: 500;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(204, 170, 102, 0.3);
        }

        .lyrics-control-group {
            margin-bottom: 18px;
        }

        .lyrics-control-label {
            display: block;
            margin-bottom: 8px;
            color: #999;
            font-size: 13px;
            font-weight: 500;
        }

        .lyrics-control-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(204, 170, 102, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        input[type="color"] {
            height: 45px;
            cursor: pointer;
        }

        input[type="range"] {
            accent-color: #ccaa66;
        }

        .mode-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            flex: 1;
            background: rgba(204, 170, 102, 0.1);
            border: 1px solid rgba(204, 170, 102, 0.2);
            color: #888;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(204, 170, 102, 0.25), rgba(212, 175, 55, 0.25));
            color: #d4af37;
            border-color: rgba(204, 170, 102, 0.5);
            box-shadow: 0 0 15px rgba(204, 170, 102, 0.3);
        }

        .info-message {
            background: rgba(204, 170, 102, 0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #ccaa66;
            text-align: center;
            border: 1px solid rgba(204, 170, 102, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 13px;
        }
    </style>

    <script>
        // ä¸€èµ·å¬æ­Œé›†æˆé€»è¾‘ (é«˜çº§ç‰ˆ)
        (function () {
            // ç¡®ä¿ DOM åŠ è½½å®Œæˆ
            window.addEventListener('load', () => {
                console.log('Together Music init (Advanced)...');
                initMusicPlayer();
                // è‡ªåŠ¨æ¸…ç†æ— æ•ˆè¡¨æƒ…
                if (window.WeChatUI && window.WeChatUI.cleanInvalidEmojis) {
                    window.WeChatUI.cleanInvalidEmojis();
                }
            });

            // å…¨å±€å˜é‡
            let playlist = [];
            let currentIndex = 0;
            let isPlaying = false;
            let isShuffling = false;
            let repeatMode = 'off';
            let currentLyrics = '';
            let audio, playBtn, disc, progressBar, progressFill, soundWave, infoMessage;
            let totalPlayTime = 0; // parseInt(localStorage.getItem('totalPlayTime') || '0');
            let lastUpdateTime = 0;

            function sendSysMsg(msg) {
                if (window.WeChatUI && window.WeChatUI.pushMessage) {
                    const cid = document.getElementById('subpage-chat-detail')?.dataset.charId || window.WeChatUI.currentChatId;
                    if (cid) {
                        WeChatUI.pushMessage('system', msg, 'system', 'system', null, cid);
                    }
                }
            }

            function initMusicPlayer() {
                injectEntryButton(); // æ³¨å…¥å…¥å£æŒ‰é’®
                startCommandMonitor(); // å¯åŠ¨æŒ‡ä»¤ç›‘å¬

                // å°è¯•åˆå§‹åŒ– DOM å¼•ç”¨ (å¯èƒ½éœ€è¦ç­‰å¾… HTML æ³¨å…¥)
                // ç”±äºæˆ‘ä»¬åŒæ—¶æ›¿æ¢äº† HTMLï¼Œè¿™é‡Œåº”è¯¥èƒ½è·å–åˆ°
                setTimeout(() => {
                    initDOM();
                }, 500);
            }

            function initDOM() {
                audio = document.getElementById('audio');
                playBtn = document.getElementById('play-btn');
                disc = document.getElementById('disc');
                progressBar = document.getElementById('progress-bar');
                progressFill = document.getElementById('progress-fill');
                soundWave = document.getElementById('sound-wave');
                infoMessage = document.getElementById('info-message');

                if (!audio) {
                    console.log('Music Player DOM not ready, retrying...');
                    setTimeout(initDOM, 500);
                    return;
                }

                // åŠ è½½æ•°æ®
                loadPlaylistFromStorage();
                updateListeningTime();
                bindEvents();
                exposeGlobalAPI(); // æš´éœ² API
            }

            function bindEvents() {
                // Audio Events
                audio.addEventListener('play', () => {
                    lastUpdateTime = Date.now();
                    isPlaying = true;
                    updateUI();

                    const userName = AppStorage.get('wechat_user_profile', {})?.name || 'æˆ‘';
                    const song = playlist[currentIndex];
                    if (song) {
                        sendSysMsg(`${userName} æ­£åœ¨æ’­æ”¾: ${song.song} - ${song.singer}`);
                    }
                });
                audio.addEventListener('pause', () => {
                    isPlaying = false;
                    updateUI();

                    const userName = AppStorage.get('wechat_user_profile', {})?.name || 'æˆ‘';
                    sendSysMsg(`${userName} æš‚åœäº†æ’­æ”¾`);

                    if (lastUpdateTime > 0) {
                        totalPlayTime += Math.floor((Date.now() - lastUpdateTime) / 1000);
                        localStorage.setItem('totalPlayTime', totalPlayTime.toString());
                        updateListeningTime();
                        lastUpdateTime = 0;
                    }
                });
                audio.addEventListener('timeupdate', () => {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    if (progressFill) progressFill.style.width = percent + '%';
                    const curTimeEl = document.getElementById('current-time');
                    if (curTimeEl) curTimeEl.textContent = formatTime(audio.currentTime);
                });
                audio.addEventListener('ended', handleEnded);
                audio.addEventListener('loadedmetadata', () => {
                    const totTimeEl = document.getElementById('total-time');
                    if (totTimeEl) totTimeEl.textContent = formatTime(audio.duration);
                });

                // Progress Bar Click
                if (progressBar) {
                    progressBar.addEventListener('click', (e) => {
                        const percent = e.offsetX / progressBar.offsetWidth;
                        audio.currentTime = percent * audio.duration;
                    });
                }

                // Update time loop
                setInterval(() => {
                    if (!audio.paused && lastUpdateTime > 0) {
                        const playedSeconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
                        totalPlayTime += playedSeconds;
                        localStorage.setItem('totalPlayTime', totalPlayTime.toString());
                        updateListeningTime();
                        lastUpdateTime = Date.now();
                    }
                }, 10000);

                // Controls
                document.getElementById('play-btn').addEventListener('click', togglePlay);
                document.getElementById('prev-btn').addEventListener('click', playPrevious);
                document.getElementById('next-btn').addEventListener('click', playNext);

                // Toolbar
                document.getElementById('open-search-btn').addEventListener('click', () => showModal('search-modal'));
                document.getElementById('open-playlist-btn').addEventListener('click', () => { renderPlaylist(); showModal('playlist-modal'); });
                document.getElementById('shuffle-btn').addEventListener('click', toggleShuffle);
                document.getElementById('repeat-btn').addEventListener('click', toggleRepeat);
                document.getElementById('floating-lyrics-btn').addEventListener('click', () => { /* Placeholder for desktop specific feature */ });

                // Modals
                document.getElementById('close-search-modal').addEventListener('click', () => hideModal('search-modal'));
                document.getElementById('close-playlist-modal').addEventListener('click', () => hideModal('playlist-modal'));
                document.getElementById('music-close-btn').addEventListener('click', shutdownPlayer);
                document.getElementById('minimize-btn').addEventListener('click', closePlayer);

                // Search
                document.getElementById('search-btn').addEventListener('click', executeSearch);
                document.getElementById('add-url-btn').addEventListener('click', addUrlSong);

                // Lyrics Click
                const lyricSec = document.getElementById('lyrics-section-click');
                if (lyricSec) lyricSec.addEventListener('click', () => showModal('search-modal'));

                // Local File
                const addLocalBtn = document.getElementById('add-local-btn');
                const fileInput = document.getElementById('file-input');
                if (addLocalBtn && fileInput) {
                    addLocalBtn.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const url = URL.createObjectURL(file);
                            const song = { song: file.name.replace(/\.[^/.]+$/, ""), singer: 'æœ¬åœ°æ–‡ä»¶', url: url, cover: '', source: 'local' };
                            playlist.push(song);
                            renderPlaylist();
                            alert('å·²æ·»åŠ æœ¬åœ°æ­Œæ›²');
                        }
                    });
                }
            }

            function updateUI() {
                if (isPlaying) {
                    playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    disc.classList.add('spinning');
                    soundWave.classList.add('active');
                } else {
                    playBtn.innerHTML = '<i class="fas fa-play"></i>';
                    disc.classList.remove('spinning');
                    soundWave.classList.remove('active');
                }
            }

            function handleEnded() {
                if (repeatMode === 'one') {
                    audio.currentTime = 0;
                    audio.play();
                } else if (repeatMode === 'all' || (playlist.length > 0 && currentIndex < playlist.length - 1)) {
                    playNext();
                } else {
                    isPlaying = false;
                    updateUI();
                }
            }

            function togglePlay() {
                if (playlist.length === 0) return;
                if (isPlaying) audio.pause();
                else audio.play();
            }

            function playNext() {
                if (playlist.length === 0) return;
                if (isShuffling) currentIndex = Math.floor(Math.random() * playlist.length);
                else currentIndex = (currentIndex + 1) % playlist.length;
                loadSong(currentIndex);
                audio.play();
            }

            function playPrevious() {
                if (playlist.length === 0) return;
                currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
                loadSong(currentIndex);
                audio.play();
            }

            function toggleShuffle() {
                isShuffling = !isShuffling;
                document.getElementById('shuffle-btn').classList.toggle('active', isShuffling);
                if (isShuffling) { repeatMode = 'off'; document.getElementById('repeat-btn').classList.remove('active'); }
            }

            function toggleRepeat() {
                const modes = ['off', 'one', 'all'];
                let idx = modes.indexOf(repeatMode);
                repeatMode = modes[(idx + 1) % modes.length];
                const btn = document.getElementById('repeat-btn');
                btn.classList.toggle('active', repeatMode !== 'off');
                const icon = btn.querySelector('i');
                if (repeatMode === 'off') icon.className = 'fas fa-redo';
                else if (repeatMode === 'one') icon.className = 'fas fa-redo-alt';
                else icon.className = 'fas fa-sync';

                if (repeatMode !== 'off') { isShuffling = false; document.getElementById('shuffle-btn').classList.remove('active'); }
            }

            async function loadSong(index) {
                if (!playlist[index]) return;
                currentIndex = index;
                const song = playlist[index];
                audio.src = song.url;

                document.getElementById('song-title').textContent = song.song;
                document.getElementById('song-artist').textContent = song.singer;

                // Sync avatars explicitly on song load
                syncAvatars();

                const cover = document.getElementById('album-cover');
                if (cover) cover.src = song.cover || 'https://via.placeholder.com/115/ccaa66/1a1a1a?text=Music';

                const lyricsText = document.getElementById('lyrics-text');
                if (song.id && song.source && song.source !== 'url' && song.source !== 'local') {
                    if (lyricsText) lyricsText.textContent = 'â™ª æ­£åœ¨åŠ è½½æ­Œè¯...';
                    const lyric = await getLyrics(song.id, song.source);
                    if (lyricsText) lyricsText.textContent = lyric;
                } else {
                    if (lyricsText) lyricsText.textContent = 'â™ª ' + song.song + ' - ' + song.singer;
                }
                renderPlaylist();
                savePlaylistToStorage();

                if (window.MusicPlayer.onSongChange) window.MusicPlayer.onSongChange(song);
            }

            async function executeSearch() {
                const input = document.getElementById('search-input').value.trim();
                const source = document.getElementById('source-select').value;
                if (!input) return;

                const infoMsg = document.getElementById('info-message');
                const resList = document.getElementById('search-results');
                infoMsg.style.display = 'block'; infoMsg.textContent = 'æœç´¢ä¸­...';
                resList.innerHTML = '';

                let musicname = input;
                let singer = '';
                if (input.includes('-')) {
                    const parts = input.split('-');
                    singer = parts[0].trim();
                    musicname = parts[1].trim();
                }

                try {
                    const results = await searchMusic(musicname, singer, source);
                    if (results.length > 0) {
                        infoMsg.textContent = `æ‰¾åˆ° ${results.length} é¦–æ­Œæ›²`;
                        renderSearchResults(results, resList);
                    } else {
                        infoMsg.textContent = 'æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²';
                    }
                } catch (e) {
                    infoMsg.textContent = 'æœç´¢å‡ºé”™';
                    console.error(e);
                }
            }

            function renderSearchResults(results, container) {
                results.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `
                         ${song.cover ? `<img src="${song.cover}" class="search-item-cover">` : '<div class="search-item-cover" style="background:#333"></div>'}
                         <div class="search-item-info">
                            <div class="search-item-title">${song.song}</div>
                             <div class="search-item-artist">${song.singer} - ${song.source}</div>
                         </div>
                    `;
                    item.onclick = async () => {
                        item.style.opacity = '0.5';
                        const songData = await getSongUrl(song);
                        if (songData) {
                            playlist.push(songData);
                            savePlaylistToStorage();
                            renderPlaylist();
                            if (playlist.length === 1 || !isPlaying) { loadSong(playlist.length - 1); audio.play(); }
                            alert('å·²æ·»åŠ ');
                        } else {
                            alert('æ— æ³•è·å–æ’­æ”¾é“¾æ¥');
                        }
                        item.style.opacity = '1';
                    };
                    container.appendChild(item);
                });
            }

            function Http_Get(url) {
                return new Promise((resolve, reject) => {
                    fetch(url).then(res => res.json()).then(resolve).catch(resolve);
                });
            }

            async function getLyrics(id, source) {
                let url = '';
                if (source === 'ç½‘æ˜“äº‘') url = `https://api.vkeys.cn/v2/music/netease?id=${id}&type=lyric`;
                else if (source === 'QQéŸ³ä¹') url = `https://api.vkeys.cn/v2/music/tencent?id=${id}&type=lyric`;
                else return 'â™ª ...';
                const res = await Http_Get(url);
                return res?.data?.lyric || 'â™ª æš‚æ— æ­Œè¯';
            }

            async function searchMusic(name, singer, source) {
                name = name.replace(/\s/g, "");
                let results = [];
                if (source === 'all' || source === 'netease') {
                    let url = `https://api.vkeys.cn/v2/music/netease?word=${name}`;
                    if (singer) url += `-${singer}`;
                    const res = await Http_Get(url);
                    if (res?.data) {
                        res.data.forEach(d => {
                            if (d.id) results.push({ id: d.id, song: d.song, singer: d.singer, cover: d.cover, source: 'ç½‘æ˜“äº‘' });
                        });
                    }
                }
                return results;
            }

            async function getSongUrl(songInfo) {
                const url = `https://api.vkeys.cn/v2/music/netease?id=${songInfo.id}`;
                const res = await Http_Get(url);
                if (res?.data?.url) {
                    return { ...songInfo, url: res.data.url };
                }
                return null;
            }

            function loadPlaylistFromStorage() {
                try {
                    const saved = localStorage.getItem('musicPlaylist');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.playlist) playlist = data.playlist;
                        if (data.currentIndex) currentIndex = data.currentIndex;
                    }
                } catch (e) { }
            }

            function savePlaylistToStorage() {
                localStorage.setItem('musicPlaylist', JSON.stringify({ playlist, currentIndex, timestamp: Date.now() }));
            }

            function renderPlaylist() {
                const el = document.getElementById('playlist');
                if (!el) return;
                el.innerHTML = '';
                if (playlist.length === 0) { el.innerHTML = '<div class="empty-state">æš‚æ— æ­Œæ›²</div>'; return; }
                playlist.forEach((song, i) => {
                    const item = document.createElement('div');
                    item.className = 'playlist-item ' + (i === currentIndex ? 'playing' : '');
                    item.innerHTML = `<span class="song-name">${song.song}</span><span class="delete-btn">ğŸ—‘</span>`;
                    item.querySelector('.delete-btn').onclick = (e) => {
                        e.stopPropagation();
                        playlist.splice(i, 1);
                        if (currentIndex >= i && currentIndex > 0) currentIndex--;
                        renderPlaylist();
                        savePlaylistToStorage();
                    };
                    item.onclick = () => { loadSong(i); audio.play(); };
                    el.appendChild(item);
                });
            }

            function addUrlSong() {
                const input = document.getElementById('url-input');
                if (input && input.value) {
                    playlist.push({ song: 'URL Song', singer: 'Unknown', url: input.value, source: 'url' });
                    renderPlaylist();
                    savePlaylistToStorage();
                    alert('Added');
                }
            }

            function updateListeningTime() {
                const el = document.getElementById('listening-time');
                if (el) {
                    const m = Math.floor(totalPlayTime / 60);
                    el.textContent = `å·²ç»ä¸€èµ·å¬äº†${m}åˆ†é’Ÿ`;
                }
            }

            function formatTime(s) {
                if (isNaN(s)) return '0:00';
                const m = Math.floor(s / 60);
                const sc = Math.floor(s % 60);
                return `${m}:${sc < 10 ? '0' : ''}${sc}`;
            }

            function showModal(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('show');
                    el.classList.remove('hidden');
                }
            }
            function hideModal(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('show');
                    el.classList.add('hidden');
                }
            }
            function closePlayer() {
                const el = document.querySelector('.music-player');
                if (el) el.classList.remove('active');
            }

            function shutdownPlayer() {
                if (audio) audio.pause();
                closePlayer();
            }

            // é‡æ–°ç»‘å®šå…³é—­å’Œæœ€å°åŒ–æŒ‰é’®äº‹ä»¶ï¼Œç¡®ä¿å®ƒä»¬èƒ½æ­£å¸¸å·¥ä½œ
            document.getElementById('music-close-btn')?.addEventListener('click', shutdownPlayer);
            document.getElementById('minimize-btn')?.addEventListener('click', closePlayer);

            // --- é€‚é…å™¨ ---
            function exposeGlobalAPI() {
                // ä½¿ç”¨å¤–éƒ¨å®šä¹‰çš„ sendSysMsg

                window.MusicPlayer = {
                    open: function () {
                        const el = document.querySelector('.music-player');
                        if (el) {
                            el.classList.remove('active');
                            setTimeout(() => el.classList.add('active'), 10);
                            const userName = AppStorage.get('wechat_user_profile', {})?.name || 'æˆ‘';
                            sendSysMsg(`${userName} å¯åŠ¨äº†ä¸€èµ·å¬æ­Œ`);
                            syncAvatars();
                        }
                    },
                    play: function () {
                        if (playlist.length > 0) audio.play();
                    },
                    pause: function () {
                        audio.pause();
                    },
                    next: function () {
                        playNext();
                        // è‡ªåŠ¨è§¦å‘ audio 'play' äº‹ä»¶å‘é€é€šçŸ¥
                    },
                    prev: playPrevious,
                    switchSong: async function (name) {
                        // 1. å…ˆæ£€æŸ¥åˆ—è¡¨é‡Œæœ‰æ²¡æœ‰
                        const idx = playlist.findIndex(s => s.song.toLowerCase().includes(name.toLowerCase()));
                        if (idx >= 0) {
                            loadSong(idx);
                            audio.play();
                            // å¦‚æœæ’­æ”¾å™¨æ²¡å¼€ï¼Œæ‰“å¼€å®ƒ
                            const player = document.querySelector('.music-player');
                            if (player && !player.classList.contains('active')) player.classList.add('active');
                            return;
                        }

                        // 2. åˆ—è¡¨æ²¡æœ‰ï¼Œæ‰§è¡Œè‡ªåŠ¨æœç´¢
                        try {
                            const source = document.getElementById('source-select') ? document.getElementById('source-select').value : 'netease';
                            let musicname = name;
                            let singer = '';

                            // ç®€å•æ‹†åˆ† "æ­Œå-æ­Œæ‰‹"
                            if (name.includes('-')) {
                                const parts = name.split('-');
                                singer = parts[0].trim();
                                musicname = parts[1].trim();
                            }

                            // æ˜¾ç¤ºæœç´¢ä¸­çš„æç¤º
                            if (typeof WeChatUI !== 'undefined' && WeChatUI.showToast) {
                                WeChatUI.showToast(`AIæ­£åœ¨æœç´¢: ${name}...`);
                            }

                            // è°ƒç”¨å†…éƒ¨ searchMusic
                            const results = await searchMusic(musicname, singer, source);

                            if (results && results.length > 0) {
                                // é»˜è®¤é€‰ç¬¬ä¸€ä¸ª
                                const topSong = results[0];

                                // è·å–é“¾æ¥
                                const songData = await getSongUrl(topSong);

                                if (songData) {
                                    // åŠ å…¥åˆ—è¡¨
                                    playlist.push(songData);
                                    savePlaylistToStorage();
                                    renderPlaylist();

                                    // æ’­æ”¾
                                    loadSong(playlist.length - 1);
                                    audio.play();

                                    // æ‰“å¼€æ’­æ”¾å™¨ç•Œé¢
                                    const player = document.querySelector('.music-player');
                                    if (player && !player.classList.contains('active')) {
                                        player.classList.add('active');
                                    }

                                    if (typeof sendSysMsg === 'function') {
                                        sendSysMsg(`AI è‡ªåŠ¨ç‚¹æ’­äº†: ${songData.song}`);
                                    }
                                } else {
                                    if (typeof WeChatUI !== 'undefined') WeChatUI.appendSystemMessage(`æ‰¾åˆ° "${topSong.song}" ä½†æ— æ³•æ’­æ”¾`);
                                }
                            } else {
                                if (typeof WeChatUI !== 'undefined') WeChatUI.appendSystemMessage(`æœªæ‰¾åˆ°æ­Œæ›²: ${name}`);
                            }
                        } catch (e) {
                            console.error('[SwitchSong] Error:', e);
                        }
                    },
                    // æ–°å¢ï¼šä¾›AIè°ƒç”¨çš„æ·»åŠ æ­Œæ›²æ¥å£
                    addSong: function (songData) {
                        playlist.push(songData);
                        renderPlaylist();
                        const userName = AppStorage.get('wechat_user_profile', {})?.name || 'æˆ‘';
                        sendSysMsg(`${userName} æ·»åŠ äº†æ­Œæ›²: ${songData.song} - ${songData.singer}`);
                    }
                };
            }

            function injectEntryButton() {
                const check = setInterval(() => {
                    const regenBtn = document.getElementById('btn-regenerate');
                    if (document.getElementById('music-entry-btn')) { clearInterval(check); return; }
                    if (regenBtn && regenBtn.parentNode) {
                        const icon = document.createElement('i');
                        icon.id = 'music-entry-btn';
                        icon.className = 'fa-solid fa-music cursor-pointer hover:text-yellow-500 transition-colors duration-200';
                        icon.title = 'ä¸€èµ·å¬æ­Œ';
                        icon.onclick = (e) => {
                            e.stopPropagation();
                            const player = document.querySelector('.music-player');
                            if (player) {
                                player.classList.toggle('active');
                                if (player.classList.contains('active')) {
                                    syncAvatars(); // Sync avatars on manual open
                                }
                            }
                        };
                        if (regenBtn.nextSibling) regenBtn.parentNode.insertBefore(icon, regenBtn.nextSibling);
                        else regenBtn.parentNode.appendChild(icon);
                        clearInterval(check);
                    }
                }, 1000);
            }

            function startCommandMonitor() {
                setInterval(() => {
                    const msgs = document.querySelectorAll('.msg-row');
                    if (msgs.length === 0) return;
                    const lastMsg = msgs[msgs.length - 1];
                    if (lastMsg.dataset.musicProcessed) return;
                    const contentEl = lastMsg.querySelector('.msg-content');
                    if (!contentEl) return;
                    const text = contentEl.innerText;
                    const match = text.match(/\[MUSIC:\s*(.*?)\s*\]/);
                    if (match) {
                        lastMsg.dataset.musicProcessed = 'true';
                        const parts = match[1].trim().split(' ');
                        const action = parts[0].toLowerCase();
                        const data = parts.slice(1).join(' ');
                        console.log('[Music] AI Command:', action, data);
                        if (window.MusicPlayer) {
                            if (action === 'play') window.MusicPlayer.play();
                            if (action === 'pause') window.MusicPlayer.pause();
                            if (action === 'next') window.MusicPlayer.next();
                            if (action === 'open') window.MusicPlayer.open();
                        }
                    }
                }, 1500);
            }

            function addSystemMessageSafe(text) {
                if (window.WeChatUI && window.WeChatUI.appendSystemMessage) {
                    WeChatUI.appendSystemMessage(text);
                } else if (typeof appendSystemMessage === 'function') {
                    appendSystemMessage(text);
                } else {
                    console.log('[System]', text);
                }
            }

            function syncAvatars() {
                const userAvatarImg = document.getElementById('music-player-user-avatar');
                const charAvatarImg = document.getElementById('music-player-char-avatar');

                let userSrc = '';
                let charSrc = '';

                // PRIORITY 1: Direct DOM Input Read (Most accurate for current settings state)
                try {
                    const directUserVal = document.getElementById('user-avatar-data') ? document.getElementById('user-avatar-data').value : '';
                    if (directUserVal && directUserVal.length > 50) userSrc = directUserVal;
                } catch (e) { }

                // PRIORITY 2: AppStorage / LocalStorage
                try {
                    if (!userSrc) {
                        const userProfile = AppStorage.get('wechat_user_profile', {});
                        if (userProfile.avatar) userSrc = userProfile.avatar;
                    }

                    // Get Character
                    const chatDetailEl = document.getElementById('subpage-chat-detail');
                    if (chatDetailEl && chatDetailEl.dataset.charId) {
                        const cid = chatDetailEl.dataset.charId;
                        const chars = AppStorage.get('wechat_chars', {});
                        if (chars[cid]) {
                            // Character Avatar
                            if (chars[cid].avatar) charSrc = chars[cid].avatar;

                            // User Persona Avatar (Specific to this chat - Overrides global profile if present)
                            if (chars[cid].userAvatar) userSrc = chars[cid].userAvatar;
                        }
                    }
                } catch (e) {
                    console.error('[Music] Error syncing avatars from storage:', e);
                }

                // PRIORITY 3: Scan Chat Messages
                if (!userSrc) {
                    const userMsgImg = document.querySelector('.msg-row.self .msg-avatar img');
                    if (userMsgImg) userSrc = userMsgImg.src;
                }
                if (!charSrc) {
                    const charMsgs = Array.from(document.querySelectorAll('.msg-row:not(.self) .msg-avatar img'));
                    if (charMsgs.length > 0) charSrc = charMsgs[charMsgs.length - 1].src;
                }

                // PRIORITY 4: Global Fallback Variables (Only if absolutely nothing else found)
                if (!userSrc && window.userAvatar) userSrc = window.userAvatar;
                if (!charSrc && window.charAvatar) charSrc = window.charAvatar;

                // Defaults
                if (!userSrc) userSrc = 'https://api.dicebear.com/7.x/avataaars/svg?seed=user';
                if (!charSrc) charSrc = 'https://api.dicebear.com/7.x/avataaars/svg?seed=char';

                console.log('[Music] Syncing avatars:', userSrc, charSrc);
                if (userAvatarImg) userAvatarImg.src = userSrc;
                if (charAvatarImg) charAvatarImg.src = charSrc;
            }

            // Init call
            setTimeout(syncAvatars, 1000); // Delay sync to ensure DOM is ready
            injectEntryButton();
            startCommandMonitor();
            exposeGlobalAPI(); // Expose API immediately

        })();

        // ===== æ”¯ä»˜äº¤äº’ä¿®å¤è„šæœ¬ =====
        (function () {
            console.log('===== åˆå§‹åŒ–æ”¯ä»˜äº¤äº’ä¿®å¤åŠŸèƒ½ =====');

            // 1. æ‹¦æˆªå¹¶éšè— [Payment Interaction] æ¶ˆæ¯
            // æ£€æŸ¥å½“å‰ç¯å¢ƒæ˜¯å¦æœ‰WeChatUIå¯¹è±¡
            if (typeof WeChatUI !== 'undefined') {
                // ä¿å­˜åŸå§‹çš„æ¶ˆæ¯å‘é€å‡½æ•°
                const originalSendMessage = WeChatUI.sendMessage;

                // é‡å†™sendMessageä»¥æ‹¦æˆªAIå›å¤
                WeChatUI.sendMessage = function (...args) {
                    // è°ƒç”¨åŸå§‹å‡½æ•°
                    const result = originalSendMessage.apply(this, args);

                    // ç­‰å¾…AIå›å¤åå¤„ç†
                    setTimeout(() => {
                        const chatContainer = document.getElementById('chat-messages-container');
                        if (!chatContainer) return;

                        const messages = chatContainer.querySelectorAll('.msg-row.other .chat-bubble');
                        messages.forEach(bubble => {
                            if (bubble.dataset.paymentProcessed) return;

                            const content = bubble.textContent || bubble.innerText;
                            // ã€ä¿®å¤ã€‘æ”¯æŒå¤šç§Payment Interactionæ ¼å¼:
                            // 1. Reject=[å€¼] - æ ‡å‡†æ ¼å¼
                            // 2. Reject=null - AIç›´æ¥è¿”å›null
                            // 3. Receive=[å€¼] æˆ– Receive=null
                            const paymentPattern = /\[Payment Interaction\]:?\s*Receive=(\[([^\]]+)\]|null|[^\s,]+),?\s*Reject=(\[([^\]]+)\]|null|[^\s,]+)/gi;

                            if (paymentPattern.test(content)) {
                                console.log('[æ”¯ä»˜äº¤äº’] æ£€æµ‹åˆ°æ”¯ä»˜æŒ‡ä»¤ï¼Œéšè—æ˜¾ç¤º');
                                bubble.dataset.paymentProcessed = 'true';

                                // ç§»é™¤æ”¯ä»˜æŒ‡ä»¤æ–‡æœ¬
                                let newContent = content.replace(/\[Payment Interaction\]:?\s*Receive=(\[([^\]]+)\]|null|[^\s,]+),?\s*Reject=(\[([^\]]+)\]|null|[^\s,]+)/gi, '').trim();

                                // å¦‚æœå»é™¤åä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤æ¶ˆæ¯
                                if (!newContent || newContent === '') {
                                    newContent = 'å¥½çš„';
                                }

                                // æ›´æ–°æ°”æ³¡å†…å®¹
                                bubble.innerHTML = newContent.replace(/\n/g, '<br>');
                            }
                        });
                    }, 1000);

                    return result;
                };

                console.log('âœ… å·²å¯ç”¨æ”¯ä»˜æŒ‡ä»¤æ‹¦æˆª');
            }

            // 2. æ·»åŠ çº¢åŒ…/è½¬è´¦å¡ç‰‡ç‚¹å‡»åŠŸèƒ½
            setTimeout(() => {
                const chatContainer = document.getElementById('chat-messages-container');
                if (chatContainer) {
                    // ç§»é™¤å·²æœ‰çš„ç‚¹å‡»ç›‘å¬å™¨(å¦‚æœå­˜åœ¨)
                    const oldListener = chatContainer._paymentClickListener;
                    if (oldListener) {
                        chatContainer.removeEventListener('click', oldListener);
                    }

                    // åˆ›å»ºæ–°çš„ç‚¹å‡»ç›‘å¬å™¨
                    const paymentClickListener = function (e) {
                        // æŸ¥æ‰¾æ˜¯å¦ç‚¹å‡»äº†è½¬è´¦/çº¢åŒ…å¡ç‰‡
                        const card = e.target.closest('.pay-card');
                        if (!card) return;

                        // æ£€æŸ¥æ˜¯å¦å·²ç»é¢†å–/æ‹’ç»
                        if (card.classList.contains('received') || card.classList.contains('rejected')) {
                            console.log('[æ”¯ä»˜äº¤äº’] è¯¥æ”¯ä»˜å·²å¤„ç†');
                            return;
                        }

                        // ä»çˆ¶å…ƒç´ ä¸­æå–æ¶ˆæ¯ç´¢å¼•å’Œç±»å‹
                        const msgRow = card.closest('.msg-row');
                        if (!msgRow) return;

                        // å°è¯•ä»æ°”æ³¡ä¸­æå–æ”¯ä»˜ç±»å‹
                        const bubble = card.closest('.chat-bubble');
                        let paymentType = 'transfer';
                        if (bubble) {
                            if (bubble.classList.contains('bubble-redpacket')) {
                                paymentType = 'redpacket';
                            } else if (bubble.classList.contains('bubble-transfer')) {
                                paymentType = 'transfer';
                            }
                        }

                        // æå–é‡‘é¢å’Œå¤‡æ³¨
                        const amountEl = card.querySelector('.pay-title');
                        const noteEl = card.querySelector('.pay-desc');
                        const amount = amountEl ? amountEl.textContent.replace('Â¥', '').trim() : '0';
                        const note = noteEl ? noteEl.textContent.trim() : '';

                        console.log(`[æ”¯ä»˜äº¤äº’] ç‚¹å‡»${paymentType === 'redpacket' ? 'çº¢åŒ…' : 'è½¬è´¦'}`, amount, note);

                        // æ˜¾ç¤ºé¢†å–å¼¹çª—
                        if (paymentType === 'redpacket') {
                            // çº¢åŒ…å¼¹çª—
                            const modal = document.getElementById('modal-open-redpacket');
                            if (modal) {
                                // è·å–å½“å‰è§’è‰²ä¿¡æ¯
                                const chatDetail = document.getElementById('subpage-chat-detail');
                                const charId = chatDetail ? chatDetail.dataset.charId : '';

                                // è·å–è§’è‰²å¤´åƒ
                                let avatar = 'https://api.dicebear.com/7.x/avataaars/svg?seed=char';
                                if (charId) {
                                    try {
                                        const chars = JSON.parse(localStorage.getItem('wechat_chars') || '{}');
                                        if (chars[charId] && chars[charId].avatar) {
                                            avatar = chars[charId].avatar;
                                        }
                                    } catch (e) { }
                                }

                                // è®¾ç½®å¼¹çª—å†…å®¹
                                const avatarContainer = document.getElementById('rp-open-avatar');
                                if (avatarContainer) avatarContainer.innerHTML = `<img src="${avatar}">`;

                                const msgEl = document.getElementById('rp-open-msg');
                                if (msgEl) msgEl.textContent = note || 'æ­å–œå‘è´¢,å¤§å‰å¤§åˆ©';

                                // é‡ç½®å¼¹çª—çŠ¶æ€
                                const resultView = document.getElementById('rp-result-view');
                                if (resultView) resultView.classList.remove('active');

                                const openBtn = document.querySelector('.rp-open-btn');
                                if (openBtn) openBtn.style.display = 'flex';

                                const rejectBtn = document.getElementById('rp-reject-btn');
                                if (rejectBtn) rejectBtn.style.display = 'block';

                                // æ˜¾ç¤ºå¼¹çª—
                                modal.classList.remove('hidden');
                                modal.style.display = 'flex';
                            }
                        } else {
                            // è½¬è´¦å¼¹çª—
                            const modal = document.getElementById('modal-payment-action');
                            if (modal) {
                                // è®¾ç½®å¼¹çª—å†…å®¹
                                const titleEl = document.getElementById('payment-action-title');
                                if (titleEl) titleEl.textContent = 'æ”¶åˆ°è½¬è´¦';

                                const amountTextEl = document.getElementById('payment-action-amount');
                                if (amountTextEl) amountTextEl.textContent = `Â¥${amount}`;

                                const descEl = document.getElementById('payment-action-desc');
                                if (descEl) descEl.innerHTML = `è½¬è´¦å¤‡æ³¨: ${note}`;

                                // æ˜¾ç¤ºå¼¹çª—
                                modal.classList.remove('hidden');
                                modal.style.display = 'flex';
                            }
                        }
                    };

                    // ä¿å­˜ç›‘å¬å™¨å¼•ç”¨å¹¶æ·»åŠ 
                    chatContainer._paymentClickListener = paymentClickListener;
                    chatContainer.addEventListener('click', paymentClickListener);

                    console.log('[æ”¯ä»˜äº¤äº’] âœ… å·²æ·»åŠ æ”¯ä»˜å¡ç‰‡ç‚¹å‡»åŠŸèƒ½');
                } else {
                    console.warn('[æ”¯ä»˜äº¤äº’] âš ï¸ æœªæ‰¾åˆ°èŠå¤©å®¹å™¨å…ƒç´ ');
                }
            }, 1000);

            // ===== ã€æ–°å¢ã€‘è‡ªåŠ¨å‘ŠçŸ¥AIçº¢åŒ…/è½¬è´¦IDåŠŸèƒ½ =====
            (function () {
                console.log('[æ”¯ä»˜äº¤äº’] ===== åˆå§‹åŒ–çº¢åŒ…/è½¬è´¦IDè‡ªåŠ¨é€šçŸ¥ =====');

                // æ‰¾åˆ°å¹¶æ‹¦æˆªsendMessageå‡½æ•°
                if (typeof WeChatUI !== 'undefined' && WeChatUI.sendMessage) {
                    const originalSendMessage = WeChatUI.sendMessage;

                    WeChatUI.sendMessage = function (...args) {
                        // è°ƒç”¨åŸå§‹å‡½æ•°
                        const result = originalSendMessage.apply(this, args);

                        // å»¶è¿Ÿæ£€æŸ¥æ˜¯å¦å‘é€äº†æ”¯ä»˜æ¶ˆæ¯
                        setTimeout(() => {
                            try {
                                const chatDetail = document.getElementById('subpage-chat-detail');
                                if (!chatDetail) return;

                                const charId = chatDetail.dataset.charId;
                                if (!charId) return;

                                // è¯»å–èŠå¤©æ•°æ®
                                const chars = JSON.parse(localStorage.getItem('wechat_chars') || '{}');
                                const char = chars[charId];
                                if (!char || !char.msgs || char.msgs.length === 0) return;

                                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
                                const lastMsg = char.msgs[char.msgs.length - 1];

                                // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å‘é€çš„çº¢åŒ…æˆ–è½¬è´¦
                                if (lastMsg.role === 'user' && (lastMsg.type === 'redpacket' || lastMsg.type === 'transfer')) {
                                    const messageId = lastMsg.id || Date.now().toString();
                                    const shortId = messageId.toString().slice(-4); // ä½¿ç”¨æœ€å4ä½ä½œä¸ºID

                                    const paymentType = lastMsg.type === 'redpacket' ? 'çº¢åŒ…' : 'è½¬è´¦';
                                    const paymentTypeEn = lastMsg.type === 'redpacket' ? 'redpacket' : 'transfer';

                                    // æå–é‡‘é¢å’Œå¤‡æ³¨
                                    let amount = '0';
                                    let note = 'æ— å¤‡æ³¨';

                                    if (lastMsg.note) {
                                        if (typeof lastMsg.note === 'object') {
                                            amount = lastMsg.note.amount || '0';
                                            note = lastMsg.note.note || note;
                                        } else {
                                            note = lastMsg.note;
                                        }
                                    }
                                    if (lastMsg.amount) {
                                        amount = lastMsg.amount;
                                    }

                                    // æ„å»ºç³»ç»Ÿæç¤ºæ¶ˆæ¯
                                    const systemHint = `[ç³»ç»Ÿæç¤º] ç”¨æˆ·å‘é€äº†${paymentType}ï¼ŒID=${shortId}ï¼Œé‡‘é¢=Â¥${amount}ï¼Œå¤‡æ³¨="${note}"ã€‚\n` +
                                        `åœ¨Payment Interactionä¸­ä½¿ç”¨IDè¿›è¡Œæ“ä½œï¼š\n` +
                                        `- é¢†å–: Receive=[é¢†å–${paymentType}: ${shortId}]\n` +
                                        `- æ‹’ç»: Reject=[æ‹’ç»${paymentType}: ${shortId}]\n` +
                                        `æˆ–ä½¿ç”¨ç®€åŒ–æ ¼å¼: [é¢†å–${paymentType}: ${shortId}] æˆ– [æ‹’ç»${paymentType}: ${shortId}]`;

                                    // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯å¯¹è±¡
                                    const hintMsg = {
                                        id: Date.now().toString() + '_hint',
                                        role: 'system',
                                        type: 'system',
                                        content: systemHint,
                                        timestamp: Date.now()
                                    };

                                    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
                                    char.msgs.push(hintMsg);
                                    localStorage.setItem('wechat_chars', JSON.stringify(chars));

                                    // åˆ·æ–°èŠå¤©ç•Œé¢
                                    if (typeof WeChatUI.loadChat === 'function') {
                                        WeChatUI.loadChat(charId);
                                    }

                                    console.log(`[æ”¯ä»˜äº¤äº’] å·²é€šçŸ¥AIï¼š${paymentType} ID=${shortId}, é‡‘é¢=Â¥${amount}`);
                                }
                            } catch (e) {
                                console.error('[æ”¯ä»˜äº¤äº’] IDé€šçŸ¥å¤±è´¥:', e);
                            }
                        }, 600);

                        return result;
                    };

                    console.log('[æ”¯ä»˜äº¤äº’] âœ… å·²å¯ç”¨çº¢åŒ…/è½¬è´¦IDè‡ªåŠ¨é€šçŸ¥åŠŸèƒ½');
                } else {
                    console.warn('[æ”¯ä»˜äº¤äº’] âš ï¸ WeChatUI.sendMessageæœªæ‰¾åˆ°ï¼Œæ— æ³•å¯ç”¨IDé€šçŸ¥');
                }
            })();

            console.log('========== æ”¯ä»˜äº¤äº’ä¿®å¤å®Œæˆï¼==========');
            console.log('åŠŸèƒ½è¯´æ˜:');
            console.log('1. AIçš„æ”¯ä»˜æŒ‡ä»¤ä¼šè¢«è‡ªåŠ¨éšè—');
            console.log('2. å¯ä»¥ç‚¹å‡»çº¢åŒ…/è½¬è´¦å¡ç‰‡è¿›è¡Œé¢†å–');

        })(); // æ”¯ä»˜äº¤äº’ä¿®å¤è„šæœ¬ç»“æŸ

        // ===== å…¨å±€é”™è¯¯å¤„ç†æ¡†æ¶ =====
        console.log('===== åˆå§‹åŒ–å…¨å±€é”™è¯¯å¤„ç† =====');

        // 1. å…¨å±€é”™è¯¯æ•è·
        window.addEventListener('error', function (event) {
            console.error('[å…¨å±€é”™è¯¯]', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });

            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
            if (typeof Utils !== 'undefined' && Utils.showToast) {
                Utils.showToast('âš ï¸ å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }

            // é˜²æ­¢é»˜è®¤é”™è¯¯æç¤º
            event.preventDefault();
        });

        // 2. Promise é”™è¯¯æ•è·
        window.addEventListener('unhandledrejection', function (event) {
            console.error('[Promiseé”™è¯¯]', event.reason);

            if (typeof Utils !== 'undefined' && Utils.showToast) {
                Utils.showToast('âš ï¸ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }

            event.preventDefault();
        });

        // 3. APIé”™è¯¯å¤„ç†åŒ…è£…å‡½æ•°
        window.safeAPICall = async function (apiFunction, errorMessage = 'æ“ä½œå¤±è´¥') {
            try {
                return await apiFunction();
            } catch (error) {
                console.error('[APIè°ƒç”¨é”™è¯¯]', error);
                if (typeof Utils !== 'undefined' && Utils.showToast) {
                    Utils.showToast(`âš ï¸ ${errorMessage}`);
                }
                return null;
            }
        };

        // 4. å®‰å…¨çš„JSONè§£æ
        window.safeJSONParse = function (jsonString, defaultValue = {}) {
            try {
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('[JSONè§£æé”™è¯¯]', error, jsonString);
                return defaultValue;
            }
        };

        // 5. localStorage å®‰å…¨åŒ…è£…
        window.safeLocalStorage = {
            get: function (key, defaultValue = null) {
                try {
                    const value = localStorage.getItem(key);
                    if (value === null) return defaultValue;
                    return safeJSONParse(value, defaultValue);
                } catch (error) {
                    console.error('[localStorageè¯»å–é”™è¯¯]', key, error);
                    return defaultValue;
                }
            },
            set: function (key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (error) {
                    console.error('[localStorageä¿å­˜é”™è¯¯]', key, error);
                    if (error.name === 'QuotaExceededError') {
                        if (typeof Utils !== 'undefined' && Utils.showToast) {
                            Utils.showToast('âš ï¸ å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·æ¸…ç†æ•°æ®');
                        }
                    }
                    return false;
                }
            }
        };

        // 6. è¾“å…¥éªŒè¯å·¥å…·
        window.validateInput = {
            notEmpty: function (value, fieldName = 'è¾“å…¥') {
                if (!value || value.trim() === '') {
                    if (typeof Utils !== 'undefined' && Utils.showToast) {
                        Utils.showToast(`âš ï¸ ${fieldName}ä¸èƒ½ä¸ºç©º`);
                    }
                    return false;
                }
                return true;
            },
            isNumber: function (value, fieldName = 'æ•°å€¼') {
                if (isNaN(value)) {
                    if (typeof Utils !== 'undefined' && Utils.showToast) {
                        Utils.showToast(`âš ï¸ ${fieldName}å¿…é¡»æ˜¯æ•°å­—`);
                    }
                    return false;
                }
                return true;
            },
            maxLength: function (value, max, fieldName = 'è¾“å…¥') {
                if (value && value.length > max) {
                    if (typeof Utils !== 'undefined' && Utils.showToast) {
                        Utils.showToast(`âš ï¸ ${fieldName}ä¸èƒ½è¶…è¿‡${max}ä¸ªå­—ç¬¦`);
                    }
                    return false;
                }
                return true;
            }
        };

        // 7. é˜²å¾¡æ€§ç¼–ç¨‹ - æ£€æŸ¥å…³é”®å¯¹è±¡æ˜¯å¦å­˜åœ¨
        window.ensureObjectExists = function (obj, objName) {
            if (typeof obj === 'undefined') {
                console.warn(`[è­¦å‘Š] ${objName} æœªå®šä¹‰`);
                return false;
            }
            return true;
        };

        console.log('âœ… å…¨å±€é”™è¯¯å¤„ç†å·²å¯ç”¨');
        console.log('- æœªæ•è·é”™è¯¯æ‹¦æˆª');
        console.log('- Promiseé”™è¯¯æ‹¦æˆª');
        console.log('- APIé”™è¯¯åŒ…è£…');
        console.log('- localStorageå®‰å…¨åŒ…è£…');
        console.log('- è¾“å…¥éªŒè¯å·¥å…·');

    </script>

    <!-- æ ¸å¿ƒæ’­æ”¾å™¨ -->
    <div class="music-player">
        <!-- å³ä¸Šè§’æ§åˆ¶æŒ‰é’® -->
        <div class="player-header">
            <button class="header-btn" id="minimize-btn" title="æœ€å°åŒ–"><i class="fas fa-chevron-left"></i></button>
            <div class="listening-time" id="listening-time">å·²ç»ä¸€èµ·å¬äº†0å°æ—¶</div>
            <button class="header-btn" id="music-close-btn" title="å…³é—­"><i class="fas fa-times"></i></button>
        </div>
        <!-- ä¸­é—´æ»šåŠ¨åŒºåŸŸ -->
        <div class="player-content-scroll">
            <!-- å¤´åƒåŒºåŸŸ -->
            <div class="avatars-section">
                <div class="avatar-wrapper">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=char" alt="è§’è‰²" class="avatar"
                        id="music-player-char-avatar">

                    <!-- çˆ±å¿ƒæ³¡æ³¡ -->
                    <div class="heart-bubble">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
                                fill="url(#heartGradient)" />
                            <defs>
                                <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ff6b9d;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#ffc3d4;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>

                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user" alt="ç”¨æˆ·" class="avatar"
                        id="music-player-user-avatar">
                </div>

                <!-- å£°çº¹åŠ¨ç”» -->
                <div class="sound-wave" id="sound-wave">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            </div>

            <!-- æ­Œè¯åŒºåŸŸï¼ˆç®€åŒ–ï¼Œç‚¹å‡»æ‰“å¼€è®¾ç½®ï¼‰ -->
            <div class="lyrics-section" id="lyrics-section-click">
                <div class="lyrics-text" id="lyrics-text">ğŸµ ç‚¹å‡»æœç´¢æ·»åŠ æ­Œæ›²</div>
            </div>

            <!-- ç¢Ÿç‰‡åŒºåŸŸ -->
            <div class="disc-section">
                <div class="disc-container">
                    <div class="disc" id="disc">
                        <img src="https://via.placeholder.com/115/ccaa66/1a1a1a?text=Music" alt="ä¸“è¾‘å°é¢"
                            class="album-cover" id="album-cover">
                        <div class="disc-center"></div>
                    </div>
                </div>
            </div>

            <!-- æ­Œæ›²ä¿¡æ¯ (Moved inside) -->
            <!-- æ­Œæ›²ä¿¡æ¯ (Moved inside) -->
            <div class="song-info">
                <div class="song-title" id="song-title">æœªæ’­æ”¾</div>
                <div class="song-artist" id="song-artist">-</div>
            </div>
        </div>

        <!-- æ­Œæ›²ä¿¡æ¯ (Moved inside) -->


        <!-- è¿›åº¦æ¡ -->
        <div class="progress-section">
            <div class="progress-bar" id="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="time-display">
                <span id="current-time">0:00</span>
                <span id="total-time">0:00</span>
            </div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’® -->
        <div class="controls">
            <button class="control-btn" id="prev-btn"><i class="fas fa-step-backward"></i></button>
            <button class="control-btn play-pause" id="play-btn"><i class="fas fa-play"></i></button>
            <button class="control-btn" id="next-btn"><i class="fas fa-step-forward"></i></button>
        </div>

        <!-- åº•éƒ¨å·¥å…·æ  -->
        <div class="toolbar">
            <button class="toolbar-btn" id="open-search-btn" title="æœç´¢æ­Œæ›²"><i class="fas fa-search"></i></button>
            <button class="toolbar-btn" id="open-playlist-btn" title="æ’­æ”¾åˆ—è¡¨"><i class="fas fa-list"></i></button>
            <button class="toolbar-btn" id="shuffle-btn" title="éšæœºæ’­æ”¾"><i class="fas fa-random"></i></button>
            <button class="toolbar-btn" id="repeat-btn" title="å¾ªç¯æ¨¡å¼"><i class="fas fa-redo"></i></button>
            <button class="toolbar-btn" id="floating-lyrics-btn" title="æµ®åŠ¨æ­Œè¯"><i
                    class="fas fa-comment-dots"></i></button>
        </div>
    </div>

    <!-- æœç´¢å¼¹çª— -->
    <div class="modal-overlay hidden" id="search-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ” æœç´¢æ­Œæ›²</span>
                <button class="modal-close" id="close-search-modal">Ã—</button>
            </div>

            <div class="search-header">
                <input type="text" class="search-input" id="search-input" placeholder="æ­Œæ›²åæˆ– æ­Œæ‰‹-æ­Œæ›²å...">
                <select class="source-select" id="source-select">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="netease">ç½‘æ˜“</option>
                    <option value="qq">QQ</option>
                </select>
            </div>
            <button class="search-btn" id="search-btn"><i class="fas fa-search"></i> å¼€å§‹æœç´¢</button>

            <!-- URLæ·»åŠ  -->
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(204, 170, 102, 0.15);">
                <input type="text" class="search-input" id="url-input" placeholder="æˆ–è¾“å…¥éŸ³ä¹URLç›´æ¥æ·»åŠ ..."
                    style="margin-bottom: 8px;">
                <button class="search-btn" id="add-url-btn"
                    style="background: linear-gradient(to right, rgba(204, 170, 102, 0.3), rgba(212, 175, 55, 0.3));"><i
                        class="fas fa-link"></i> æ·»åŠ URL</button>
            </div>

            <div class="info-message" id="info-message" style="display: none;"></div>
            <div class="search-results" id="search-results"></div>
        </div>
    </div>

    <!-- æ’­æ”¾åˆ—è¡¨å¼¹çª— -->
    <div class="modal-overlay hidden" id="playlist-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸ“‹ æ’­æ”¾åˆ—è¡¨</span>
                <button class="modal-close" id="close-playlist-modal">Ã—</button>
            </div>

            <button class="add-local-btn" id="add-local-btn"><i class="fas fa-folder"></i> æ·»åŠ æœ¬åœ°éŸ³ä¹</button>

            <div class="mode-controls">
                <button class="mode-btn" id="mode-shuffle-btn"><i class="fas fa-random"></i> éšæœº</button>
                <button class="mode-btn" id="mode-repeat-btn"><i class="fas fa-redo"></i> å¾ªç¯</button>
            </div>

            <div class="playlist-items" id="playlist">
                <div class="empty-state">æš‚æ— æ­Œæ›²ï¼Œç‚¹å‡»æœç´¢æ·»åŠ å§ï½</div>
            </div>
        </div>
    </div>

    <!-- æ­Œè¯è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay hidden" id="lyrics-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">ğŸµ æ­Œè¯è®¾ç½®</span>
                <button class="modal-close" id="close-lyrics-modal">Ã—</button>
            </div>

            <div class="lyrics-display">
                <div class="lyrics-display-text" id="lyrics-display-text">ğŸµ æ’­æ”¾æ­Œæ›²åæ˜¾ç¤ºæ­Œè¯</div>
            </div>

            <div class="lyrics-control-group">
                <label class="lyrics-control-label">æ­Œè¯é¢œè‰²</label>
                <input type="color" id="lyrics-color" class="lyrics-control-input" value="#ccaa66">
            </div>

            <div class="lyrics-control-group">
                <label class="lyrics-control-label">å­—ä½“å¤§å°</label>
                <input type="range" id="lyrics-size" class="lyrics-control-input" min="12" max="24" value="13">
            </div>
        </div>
    </div>

    <!-- æœ¬åœ°ä¸Šä¼  -->
    <input type="file" id="file-input" accept="audio/*" style="display:none;">

    <audio id="audio" preload="metadata"></audio>
    <style>
        /* ä¿®å¤ç¼–è¾‘å¼¹çª—é«˜åº¦é—®é¢˜ */
        #modal-edit-msg .modal-box {
            display: flex;
            flex-direction: column;
            height: auto;
            max-height: 85vh;
        }

        #edit-msg-list {
            flex: 1;
            min-height: 200px;
            overflow-y: auto;
        }
    </style>
    <!-- é€šç”¨è¾“å…¥å¼¹çª— -->
    <div id="modal-param-prompt" class="modal-overlay hidden" style="z-index: 9999;">
        <div class="bg-white rounded-lg p-6 w-80 shadow-2xl animate-scale-in">
            <h3 id="param-prompt-title" class="text-lg font-bold mb-4">è¾“å…¥å†…å®¹</h3>
            <input type="text" id="param-prompt-input"
                class="w-full border p-2 rounded mb-4 focus:ring-2 ring-green-500 outline-none" placeholder="">
            <div class="flex justify-end gap-2">
                <button onclick="Utils.cancelPrompt()"
                    class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                <button onclick="Utils.confirmPrompt()"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«é€‰æ‹©å¼¹çª— -->
    <div id="modal-share-select" class="modal-overlay hidden" style="z-index: 9999;">
        <div class="bg-white rounded-lg w-80 max-h-[80vh] flex flex-col shadow-2xl animate-scale-in overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold">é€‰æ‹©å¥½å‹</h3>
                <button onclick="document.getElementById('modal-share-select').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            <div id="share-contact-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

</body>

</html>
<script>
    /* --------------------------------------------------------------
       5ï¸âƒ£ æœç´¢èŠå¤©è®°å½•å¹¶è·³è½¬ï¼ˆå®Œæ•´å®ç°ï¼‰
       -------------------------------------------------------------- */
    const SearchChat = {
        matches: [],          // æ‰€æœ‰åŒ¹é…çš„æ°”æ³¡å…ƒç´ 
        curIdx: -1,          // å½“å‰é«˜äº®ç´¢å¼•

        init() {
            // ç­‰å¾… subapp-content æ¸²æŸ“åå†è·å–æœç´¢æ¡†
            setTimeout(() => {
                const input = document.getElementById('search-input');
                const resultBox = document.getElementById('search-results');
                if (!input) return; // å¦‚æœæœç´¢æ¡†è¿˜æ²¡æ¸²æŸ“ï¼Œç¨åå¯èƒ½éœ€è¦æ‰‹åŠ¨è§¦å‘ä¸»è¦æ¸²æŸ“

                // å®æ—¶æœç´¢
                input.addEventListener('input', e => {
                    const kw = e.target.value.trim();
                    const container = document.getElementById('search-results');
                    if (!container) return;

                    if (!kw) {
                        container.innerHTML = '';
                        container.classList.add('hidden');
                        this.matches = [];
                        return;
                    }
                    this.search(kw, container);
                });

                // å›è½¦ç›´æ¥è·³åˆ°ç¬¬ä¸€æ¡
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter' && this.matches.length) {
                        e.preventDefault();
                        this.jumpTo(0);
                    }
                });

                // é”®ç›˜ä¸Šä¸‹åˆ‡æ¢
                document.addEventListener('keydown', e => {
                    if (!this.matches.length) return;
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const next = (this.curIdx + 1) % this.matches.length;
                        this.jumpTo(next);
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prev = (this.curIdx - 1 + this.matches.length) % this.matches.length;
                        this.jumpTo(prev);
                    }
                });
            }, 1000);
        },

        // åœ¨å½“å‰èŠå¤©çª—å£ä¸­æœç´¢å…³é”®å­—
        search(keyword, resultBox) {
            resultBox.innerHTML = '';
            this.matches = [];
            this.curIdx = -1;

            // é¡¹ç›®ä¸­èŠå¤©æ°”æ³¡ä½¿ç”¨ .msg-rowï¼ˆè‹¥å®é™…ç±»åä¸åŒè¯·è‡ªè¡Œæ›¿æ¢ï¼‰
            const bubbles = document.querySelectorAll('.msg-row');
            bubbles.forEach(bubble => {
                const txt = bubble.innerText || bubble.textContent;
                if (txt && txt.includes(keyword)) {
                    this.matches.push(bubble);
                    const item = document.createElement('div');
                    item.className = 'search-item flex items-center gap-2 p-2 cursor-pointer hover:bg-gray-100';
                    const highlighted = txt.replace(
                        new RegExp(`(${keyword})`, 'gi'),
                        '<mark class="bg-yellow-200">$1</mark>'
                    );
                    item.innerHTML = `<i class="fa-solid fa-magnifying-glass text-gray-500"></i>
                                 <span class="truncate text-sm text-gray-800">${highlighted}</span>`;
                    item.onclick = () => this.jumpTo(this.matches.length - 1);
                    resultBox.appendChild(item);
                }
            });

            if (!this.matches.length) {
                resultBox.innerHTML = `<div class="p-2 text-gray-500 text-sm">æœªæ‰¾åˆ° â€œ${keyword}â€</div>`;
            }
            resultBox.classList.remove('hidden');
        },

        // è·³è½¬å¹¶é«˜äº®ç¬¬ n æ¡åŒ¹é…
        jumpTo(idx) {
            if (!this.matches[idx]) return;
            // æ¸…é™¤ä¸Šä¸€æ¬¡é«˜äº®
            this.matches.forEach(b => {
                b.classList.remove('bg-yellow-100', 'ring-2', 'ring-yellow-400', 'transition-colors', 'duration-500');
            });
            const target = this.matches[idx];
            target.classList.add('bg-yellow-100', 'ring-2', 'ring-yellow-400', 'transition-colors', 'duration-500');

            // å…³é”®ä¿®å¤ï¼šç›´æ¥è°ƒç”¨ scrollIntoView
            // å¦‚æœè¿˜æ— æ•ˆï¼Œå¯èƒ½æ˜¯çˆ¶å®¹å™¨ overflow é—®é¢˜ï¼Œè¿™é‡Œå¼ºåˆ¶æŠŠ block è®¾ä¸º center
            try {
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) { /* ignore */ }

            // é¢å¤–å°è¯•ï¼šè‹¥æœ‰ç‰¹å®šçˆ¶å®¹å™¨ IDï¼Œå¯ä½¿ç”¨ scrollTop è®¡ç®—
            const chatList = document.getElementById('chat-list') || document.querySelector('.chat-container');
            if (chatList && chatList.scrollTo) {
                // ç®€å•çš„è®¡ç®—ï¼Œä¸ä¸€å®šç²¾ç¡®ï¼Œä½œä¸ºä¿åº•
                // chatList.scrollTo({ top: target.offsetTop - 150, behavior: 'smooth' });
            }
            this.curIdx = idx;

            // 2ç§’åè‡ªåŠ¨æ·¡å‡ºé«˜äº®
            setTimeout(() => {
                target.classList.remove('bg-yellow-100', 'ring-2', 'ring-yellow-400');
            }, 2000);
        }
    };

    // é¡µé¢åŠ è½½å®Œæ¯•ååˆå§‹åŒ–æœç´¢åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => SearchChat.init());

    // [Fixed] Removed buggy WeChatUI.pushMessage override that was breaking payment display and persistence.
    // The original WeChatUI.pushMessage and loadChat functions correctly handle redpackets and transfers.




</script>
<style>
    /* ğŸ”Ÿ Mindscape (Inner Voice) - ORIGINAL RESTORED */
    #inner-voice-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        font-family: 'Noto Serif SC', serif;
    }

    #inner-voice-modal.active {
        display: flex;
        animation: voiceModalFadeIn 0.4s ease;
    }

    @keyframes voiceModalFadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .voice-modal-content {
        width: 90%;
        max-width: 380px;
        max-height: 85vh;
        height: auto;
        background: radial-gradient(circle at 50% 0%, #2a2520 0%, #0a0a0c 85%);
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.06'/%3E%3C/svg%3E"),
            radial-gradient(circle at 50% 0%, #2a2520 0%, #0a0a0c 85%);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-top: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 40px 80px rgba(0, 0, 0, 0.95), inset 0 0 40px rgba(0, 0, 0, 0.6);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    #voice-effect-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
        mix-blend-mode: screen;
    }

    .voice-modal-header {
        padding: 20px 24px;
        z-index: 10;
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(10, 10, 12, 0.8);
    }

    .header-title {
        font-family: 'Cormorant Garamond', serif;
        font-size: 16px;
        letter-spacing: 6px;
        color: #e6dcc0;
        text-transform: uppercase;
    }

    .voice-modal-header-btn {
        background: transparent;
        border: none;
        color: #8c7e63;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .voice-modal-header-btn:hover {
        color: #e6dcc0;
        text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);
    }

    .voice-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        z-index: 2;
        display: flex;
        flex-direction: column;
        gap: 24px;
        scrollbar-width: thin;
        scrollbar-color: rgba(212, 175, 55, 0.3) transparent;
    }

    .voice-modal-body::-webkit-scrollbar {
        width: 4px;
    }

    .voice-modal-body::-webkit-scrollbar-thumb {
        background-color: rgba(212, 175, 55, 0.3);
        border-radius: 2px;
    }

    .voice-header-group {
        text-align: center;
        margin-bottom: 5px;
    }

    .voice-char-avatar-box {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 12px;
        padding: 3px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        outline: 1px solid rgba(212, 175, 55, 0.4);
        outline-offset: 4px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    .voice-char-avatar-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        filter: brightness(0.9);
    }

    .voice-char-name {
        font-size: 24px;
        color: #e6dcc0;
        letter-spacing: 3px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    }

    .voice-char-meta {
        font-size: 12px;
        color: #8c7e63;
        letter-spacing: 2px;
        margin-top: 6px;
        font-family: 'Cormorant Garamond', serif;
        font-style: italic;
    }

    .voice-card-inner {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 12px;
        padding: 24px 20px;
        text-align: center;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .voice-card-inner::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 1px;
        height: 20px;
        background: linear-gradient(to bottom, #d4af37, transparent);
    }

    .voice-label-center {
        font-size: 11px;
        color: #8c7e63;
        letter-spacing: 4px;
        margin-bottom: 12px;
        display: block;
    }

    .voice-text-inner {
        font-size: 15px;
        color: #dcdcdc;
        line-height: 1.9;
        font-weight: 300;
    }

    .voice-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .voice-info-block {
        position: relative;
        padding-left: 10px;
        border-left: 2px solid rgba(255, 255, 255, 0.05);
    }

    .voice-label {
        font-size: 10px;
        color: #8c7e63;
        margin-bottom: 6px;
        letter-spacing: 2px;
    }

    .voice-text-content {
        font-size: 13px;
        color: #a0a0a0;
        line-height: 1.6;
        text-align: justify;
        font-weight: 300;
    }

    .voice-modal-footer {
        padding: 16px 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(10, 10, 12, 0.8);
        z-index: 10;
        flex-shrink: 0;
    }

    .footer-count {
        font-size: 10px;
        color: #555;
        letter-spacing: 2px;
    }

    .effect-badge {
        font-size: 10px;
        color: #8c7e63;
        opacity: 0.8;
        letter-spacing: 1px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 4px 8px;
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
    }

    .effect-badge:hover {
        color: #e6dcc0;
        border-color: #8c7e63;
    }

    .voice-history-card {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        padding: 12px;
        border-left: 2px solid #8c7e63;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .voice-history-time {
        font-size: 10px;
        color: #666;
        margin-bottom: 4px;
        font-family: 'Cormorant Garamond', serif;
    }

    .voice-history-preview {
        font-size: 12px;
        color: #aaa;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<!-- Inner Voice Modal -->
<div id="inner-voice-modal" onclick="if(event.target.id === 'inner-voice-modal') InnerVoiceUI.closeModal()">
    <div class="voice-modal-content" onclick="event.stopPropagation()">
        <canvas id="voice-effect-canvas"></canvas>

        <div class="voice-modal-header">
            <button onclick="InnerVoiceUI.closeModal()" class="voice-modal-header-btn"><i
                    class="fa-solid fa-xmark"></i></button>
            <div class="header-title">Mindscape</div>
            <div class="flex gap-2">
                <button onclick="InnerVoiceUI.toggleManageMode()" class="voice-modal-header-btn" title="å†å²è®°å½•"><i
                        class="fa-solid fa-clock-rotate-left"></i></button>
                <button onclick="InnerVoiceUI.deleteCurrent()" class="voice-modal-header-btn" title="åˆ é™¤å½“å‰"><i
                        class="fa-solid fa-trash-can" style="font-size: 14px;"></i></button>
            </div>
        </div>

        <div class="voice-modal-body">
            <div id="voice-character-view">
                <div class="voice-header-group">
                    <div class="voice-char-avatar-box">
                        <img id="voice-char-avatar" src="" alt="Avatar">
                    </div>
                    <div class="voice-char-name" id="voice-char-name">Character</div>
                    <div class="voice-char-meta" id="voice-char-mood">Current Mood / ...</div>
                </div>

                <div class="voice-grid">
                    <div class="voice-card-inner">
                        <span class="voice-label-center">Â· å†… å¿ƒ ç‹¬ ç™½ Â·</span>
                        <div class="voice-text-inner" id="voice-thoughts-text">...</div>
                    </div>

                    <div class="voice-row mt-6">
                        <div class="voice-info-block">
                            <div class="voice-label">OUTFIT ç©¿æ­</div>
                            <div class="voice-text-content" id="voice-outfit-text">...</div>
                        </div>
                        <div class="voice-info-block">
                            <div class="voice-label">SCENE ç¯å¢ƒ</div>
                            <div class="voice-text-content" id="voice-scene-text">...</div>
                        </div>
                    </div>

                    <div class="voice-info-block mt-6">
                        <div class="voice-label">ACTION å§¿æ€</div>
                        <div class="voice-text-content" id="voice-action-text">...</div>
                    </div>
                </div>
            </div>

            <div id="voice-history-view" class="hidden">
                <div id="voice-history-list" class="flex flex-col gap-2">
                </div>
            </div>
        </div>

        <div class="voice-modal-footer">
            <span class="footer-count" id="voice-index-indicator">NO. --</span>
            <div class="effect-badge" id="effect-name-badge" onclick="InnerVoiceUI.toggleEffect()">åˆ‡æ¢ç‰¹æ•ˆ</div>
        </div>
    </div>
</div>

<script>
    // --- WalletLogic Definition (Global) ---
    window.WalletLogic = {
        // è·å–è§’è‰²é’±åŒ…æ•°æ®
        getCharWalletData: function (charId) {
            const wallets = AppStorage.get('char_wallets', {});
            if (!wallets[charId]) {
                wallets[charId] = {
                    balance: 0.00,
                    transactions: []
                };
                AppStorage.set('char_wallets', wallets);
            }
            return wallets[charId];
        },

        // ä¿å­˜è§’è‰²é’±åŒ…æ•°æ®
        saveCharWalletData: function (charId, data) {
            const wallets = AppStorage.get('char_wallets', {});
            wallets[charId] = data;
            AppStorage.set('char_wallets', wallets);
        },

        addTransaction: function (charId, transaction) {
            const data = this.getCharWalletData(charId);
            const amount = parseFloat(transaction.amount);

            // Update balance based on type
            if (transaction.type === 'income' || transaction.type === 'received') {
                data.balance += amount;
            } else {
                data.balance -= amount;
            }

            data.transactions.unshift({
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                ...transaction,
                timestamp: Date.now()
            });

            this.saveCharWalletData(charId, data);
        }
    };

    // --- SearchPhoneUI Share Extension (Fixed) ---
    // ä¿®å¤ç‰ˆï¼šä½¿ç”¨æ­£ç¡®çš„æ•°æ®æºä»localStorageè¯»å–
    SearchPhoneUI.getAppDataByIndex = function (appName, index) {
        const cid = SearchPhoneUI.targetCharId;
        if (!cid) {
            console.error('[åˆ†äº«] æœªæ‰¾åˆ°ç›®æ ‡è§’è‰²ID');
            return null;
        }

        const allData = AppStorage.get('wechat_search_phone_data', {});
        const charData = allData[cid] || {};
        const appData = charData[appName];

        if (!appData) {
            console.warn(`[åˆ†äº«] ${appName} æ•°æ®ä¸ºç©º`);
            return null;
        }

        if (Array.isArray(appData)) {
            return appData[index] || null;
        }
        return appData;
    };

    SearchPhoneUI.shareItem = function (appName, index) {
        const appData = SearchPhoneUI.getAppDataByIndex(appName, index);
        if (!appData) {
            Utils.showToast('æ²¡æœ‰å¯åˆ†äº«çš„å†…å®¹');
            return;
        }

        // 1. è·å–æ‰€æœ‰å¥½å‹/èŠå¤©å¯¹è±¡
        const chars = AppStorage.get('wechat_chars', {});
        const activeChars = Object.values(chars).filter(c => !c.deleted);

        console.log('[åˆ†äº«] æ‰¾åˆ°å¥½å‹æ•°é‡:', activeChars.length);

        if (activeChars.length === 0) {
            Utils.showToast('æ²¡æœ‰å¯åˆ†äº«çš„å¥½å‹');
            return;
        }

        // 2. ç”Ÿæˆå¥½å‹åˆ—è¡¨HTML
        const friendsListHtml = activeChars.map(c => {
            const avatar = c.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(c.id)}`;
            const name = (c.nickname || c.name || 'æœªå‘½å').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `
                <div class="share-friend-item" data-cid="${c.id}" data-app="${appName}" data-index="${index}" style="display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; border-radius: 8px; transition: background 0.2s;">
                    <img src="${avatar}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background: #e5e7eb;">
                    <div style="font-weight: 500; color: #111827;">${name}</div>
                </div>
            `;
        }).join('');

        // 3. æ„å»ºå¼¹çª—Modalï¼ˆå±…ä¸­æ˜¾ç¤ºï¼‰
        const modalHtml = `
    <div id="modal-share-contact" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id==='modal-share-contact') this.remove()">
        <div style="background: white; width: 90%; max-width: 320px; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; max-height: 70vh; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);" onclick="event.stopPropagation()">
            <div style="padding: 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f9fafb;">
                <span style="font-weight: bold; color: #1f2937;">åˆ†äº«ç»™...</span>
                <button onclick="document.getElementById('modal-share-contact').remove()" style="color: #6b7280; background: none; border: none; cursor: pointer; font-size: 24px; padding: 0; width: 28px; height: 28px; line-height: 1;">&times;</button>
            </div>
            <div id="share-friend-list" style="overflow-y: auto; padding: 8px;">
                ${friendsListHtml}
            </div>
        </div>
    </div>
    `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // 4. ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.share-friend-item').forEach(item => {
            item.onmouseover = () => item.style.background = '#f3f4f6';
            item.onmouseout = () => item.style.background = 'transparent';
            item.onclick = () => {
                const cid = item.dataset.cid;
                const app = item.dataset.app;
                const idx = parseInt(item.dataset.index);
                SearchPhoneUI.doShareToChat(cid, app, idx);
            };
        });
    };

    SearchPhoneUI.doShareToChat = function (cid, appName, index) {
        // ç§»é™¤ Modal
        document.getElementById('modal-share-contact')?.remove();

        const appData = SearchPhoneUI.getAppDataByIndex(appName, index);
        if (!appData) {
            Utils.showToast('è·å–æ•°æ®å¤±è´¥');
            return;
        }

        // æ„å»ºå¡ç‰‡ HTML
        let cardTitle = "æœªçŸ¥åˆ†äº«";
        let cardDesc = "ç‚¹å‡»æŸ¥çœ‹";
        let cardIcon = "fa-share-alt";

        if (appName === 'diary') {
            cardTitle = appData.title || "ç§å¯†æ—¥è®°";
            cardDesc = (appData.content || "").substring(0, 30) + "...";
            cardIcon = "fa-book";
        } else if (appName === 'notes') {
            cardTitle = "å¤‡å¿˜å½•: " + (appData.title || "æ¸…å•");
            cardDesc = `åŒ…å« ${appData.items?.length || 0} ä¸ªé¡¹ç›®`;
            cardIcon = "fa-sticky-note";
        } else if (appName === 'footprint') {
            cardTitle = "è¶³è¿¹åˆ†äº«";
            // å¤„ç†è¶³è¿¹æ•°æ®ç»“æ„ï¼šå¯èƒ½æ˜¯ {locations: [...]} æˆ–ç›´æ¥æ˜¯æ•°ç»„
            let locationText = "";
            if (appData.locations && Array.isArray(appData.locations)) {
                const loc = appData.locations[index] || appData.locations[0];
                locationText = `${loc.time || ''} @ ${loc.place || ''}`;
            } else if (appData.time && appData.place) {
                locationText = `${appData.time} @ ${appData.place}`;
            }
            cardDesc = locationText || "æŸ¥çœ‹ä½ç½®ä¿¡æ¯";
            cardIcon = "fa-map-location-dot";
        } else if (appName === 'weibo') {
            cardTitle = "å¾®åšåŠ¨æ€";
            cardDesc = (appData.content || appData.text || "").substring(0, 30) + "...";
            cardIcon = "fa-comment-dots";
        }

        const cardHtml = `
    <div class="shared-app-card" 
         data-app="${appName}" 
         data-index="${index}" 
         data-target-cid="${SearchPhoneUI.targetCharId}" 
         onclick="window.handleSharedCardClick(this)"
         style="background: white; border: 1px solid #eee; border-radius: 8px; overflow: hidden; max-width: 240px; cursor: pointer; transition: transform 0.2s;" 
         onmouseover="this.style.transform='scale(1.02)'" 
         onmouseout="this.style.transform='scale(1)'">
        <div style="padding: 10px 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f5f5f5;">
             <div style="width: 32px; height: 32px; background: #f0f9ff; color: #0284c7; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                <i class="fa-solid ${cardIcon}"></i>
             </div>
             <div style="font-size: 14px; font-weight: bold; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${cardTitle}</div>
        </div>
        <div style="padding: 8px 12px; font-size: 12px; color: #666; line-height: 1.4;">
            ${cardDesc}
        </div>
        <div style="padding: 6px 12px; background: #fafafa; font-size: 10px; color: #999; display: flex; justify-content: space-between;">
            <span>æ¥è‡ª ${appName === 'diary' ? 'ç§˜å¯†æ—¥è®°' : appName === 'footprint' ? 'åœ°å›¾è¶³è¿¹' : appName === 'weibo' ? 'å¾®åš' : appName === 'notes' ? 'å¤‡å¿˜å½•' : 'åº”ç”¨'}</span>
            <i class="fa-solid fa-angle-right"></i>
        </div>
    </div>
    `;

        // å‘é€ç»™ç›®æ ‡è§’è‰² (ä½œä¸º "User" å‘é€)
        SearchPhoneUI.closeSubApp();
        WeChatUI.openChatDetail(cid);
        setTimeout(() => {
            const chars = AppStorage.get('wechat_chars', {});
            if (chars[cid]) {
                if (!chars[cid].msgs) chars[cid].msgs = [];
                chars[cid].msgs.push({
                    role: 'user', // æˆ‘å‘é€çš„
                    type: 'html', // ç‰¹æ®Šç±»å‹æ”¯æŒ HTML
                    content: cardHtml,
                    timestamp: Date.now()
                });
                AppStorage.set('wechat_chars', chars);
                WeChatUI.loadChat(cid); // åˆ·æ–°

                // âœ… æ‰‹åŠ¨ç»‘å®šå¡ç‰‡ç‚¹å‡»äº‹ä»¶ï¼ˆinnerHTMLä¼šç§»é™¤onclickå±æ€§ï¼‰
                setTimeout(() => {
                    document.querySelectorAll('.shared-app-card').forEach(card => {
                        if (!card.dataset.bound) {
                            card.dataset.bound = 'true';
                            card.addEventListener('click', function () {
                                window.handleSharedCardClick(this);
                            });
                            console.log('[äº‹ä»¶ç»‘å®š] ç»‘å®šå¡ç‰‡ç‚¹å‡»äº‹ä»¶', card.dataset);
                        }
                    });
                }, 100);

                // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼ï¼‰
                setTimeout(() => {
                    const chatContainer = document.querySelector('.chat-messages');
                    if (chatContainer) {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                }, 100);
            }
        }, 500);

        Utils.showToast('å·²åˆ†äº«ï¼Œå³ä½¿æ‚¨ç°åœ¨å¤„äº"æ²‰é»˜"çŠ¶æ€ï¼Œå¡ç‰‡ä¹Ÿå·²é€è¾¾');
    };


    // âœ… å…¨å±€å‡½æ•°ï¼šå¤„ç†åˆ†äº«å¡ç‰‡ç‚¹å‡»ï¼ˆç‰ˆæœ¬ï¼šv2025-12-28-21:55ï¼‰
    // âœ… è‡ªåŠ¨æ¸…ç†è¡¥ä¸ï¼šç›‘å¬æ¨¡æ€æ¡†å…³é—­ï¼Œè‡ªåŠ¨è¿˜åŸæ ·å¼å’Œä½ç½®
    setTimeout(() => {
        const modal = document.getElementById('modal-phone-subapp');
        if (modal) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        // å¦‚æœæ£€æµ‹åˆ°æœ‰äººè¯•å›¾å…³é—­å®ƒï¼ˆæ·»åŠ  translate-y-fullï¼‰
                        if (modal.classList.contains('translate-y-full')) {
                            // 1. æ¸…é™¤å¼ºåˆ¶æ ·å¼
                            modal.style.position = '';
                            modal.style.inset = '';
                            modal.style.zIndex = '';
                            modal.style.display = '';
                            modal.style.transform = '';

                            // 2. éšè—ï¼ˆç¡®ä¿ä¸å ä½ï¼‰
                            modal.style.display = 'none';
                        }
                    }
                });
            });
            observer.observe(modal, { attributes: true });
        }
    }, 2000);

    // âœ… å…¨å±€å‡½æ•°ï¼šå¤„ç†åˆ†äº«å¡ç‰‡ç‚¹å‡»ï¼ˆç‰ˆæœ¬ï¼šv2025-12-29-00:15 ç»ˆææ¬å®¶ç‰ˆï¼‰
    window.handleSharedCardClick = function (cardElement) {
        // 1. è·å–å‚æ•°
        const appName = cardElement.dataset.app;
        const index = parseInt(cardElement.dataset.index);
        const targetCid = cardElement.dataset.targetCid;

        if (!appName || isNaN(index) || !targetCid) {
            console.error('å¡ç‰‡æ•°æ®é”™è¯¯', { appName, index, targetCid });
            Utils.showToast('å¡ç‰‡æ•°æ®é”™è¯¯');
            return;
        }

        // 2. å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å¼€å†²çª
        setTimeout(() => {
            let searchPhoneModal = document.getElementById('modal-phone-subapp');
            if (!searchPhoneModal) {
                console.error('æ‰¾ä¸åˆ°æŸ¥æ‰‹æœºæ¨¡æ€æ¡†');
                return;
            }

            // 3. æ¬å®¶é€»è¾‘ï¼šå°†æ¨¡æ€æ¡†ç§»åŠ¨åˆ° body ç›´æ¥å­å…ƒç´ ï¼Œè„±ç¦»å±‚çº§é™åˆ¶
            if (searchPhoneModal.parentElement !== document.body) {
                document.body.appendChild(searchPhoneModal);
            }

            // 4. å¼ºåˆ¶æ ·å¼æ“ä½œ
            searchPhoneModal.classList.remove('translate-y-full');
            searchPhoneModal.style.position = 'fixed'; // ç¡®ä¿å›ºå®šå®šä½
            searchPhoneModal.style.inset = '0'; // å…¨å±è¦†ç›–
            searchPhoneModal.style.zIndex = '99999'; // é¡¶çº§å±‚çº§
            searchPhoneModal.style.display = 'flex';
            searchPhoneModal.style.transform = 'translateY(0)'; // å¼ºåˆ¶ä½ç§»å½’é›¶

            // 5. åˆå§‹åŒ– UI
            if (typeof SearchPhoneUI !== 'undefined' && SearchPhoneUI.init) {
                SearchPhoneUI.init();
            }

            // 6. æ‰§è¡Œå†…éƒ¨è·³è½¬æµç¨‹
            setTimeout(() => {
                SearchPhoneUI.openCharPhone(targetCid);

                setTimeout(() => {
                    SearchPhoneUI.openSubApp(appName);

                    setTimeout(() => {
                        const container = document.getElementById('subapp-content');
                        if (container && (appName === 'diary' || appName === 'notes')) {
                            container.dataset.diaryEntryIdx = index;
                            SearchPhoneUI.renderSubAppContent();
                        }
                    }, 150);
                }, 150);
            }, 100);

        }, 10);
    };


    // âœ… å…¨å±€äº‹ä»¶å§”æ‰˜ï¼šä½¿ç”¨æ•è·é˜¶æ®µç›‘å¬å¡ç‰‡ç‚¹å‡»ï¼Œä¼˜å…ˆäºå…¶ä»–ç›‘å¬å™¨
    document.addEventListener('click', function (e) {
        const card = e.target.closest('.shared-app-card');
        if (card) {
            console.log('[å…¨å±€å§”æ‰˜-æ•è·] æ£€æµ‹åˆ°å¡ç‰‡ç‚¹å‡»', card);
            e.stopPropagation();
            e.preventDefault();
            window.handleSharedCardClick(card);
        }
    }, true); // â† ä½¿ç”¨æ•è·é˜¶æ®µï¼ˆtrueï¼‰ï¼Œä¼˜å…ˆå¤„ç†


    // ========== ç»“æŸï¼šåˆ†äº«å¡ç‰‡ç‚¹å‡»å¤„ç† ==========


    // [New] Hidden System Message for Call Signaling
    WeChatUI.sendHiddenSystemMessage = async function (charId, prompt, callback) {
        console.log('[WeChatUI] Sending hidden system message:', prompt);
        const chars = AppStorage.get('wechat_chars', {});
        const char = chars[charId];
        if (!char) return;

        // Construct context using existing history
        // Construct context using existing history
        const historyLimit = 20;
        const msgs = (char.msgs || []).slice(-historyLimit);

        // 1. Placeholder System Message (For Persona Injection)
        let apiMessages = [{ role: 'system', content: '' }];

        // 2. History Messages
        const historyApiMsgs = msgs.map(m => ({
            role: m.role === 'user' ? 'user' : 'assistant',
            content: typeof m.content === 'string' ? m.content : (Array.isArray(m.content) ? JSON.stringify(m.content) : String(m.content))
        }));
        apiMessages = apiMessages.concat(historyApiMsgs);

        // 3. Signaling Prompt
        apiMessages.push({ role: 'system', content: prompt });

        try {
            const reply = await SettingsLogic.generateLLM(apiMessages, charId, 'call_signal');
            if (callback && reply) callback(reply.trim());
        } catch (e) {
            console.error('Hidden message failed', e);
        }
    };

    // =========================================================================
    // ğŸ“ CallLogic - WeChat Voice/Video Call Implementation (Enhanced)
    // =========================================================================
    const CallLogic = {
        state: 'IDLE', // IDLE, OUTGOING, INCOMING, CONNECTED
        callType: 'audio', // audio, video
        charId: null,
        recognition: null,
        isMuted: false,
        startTime: 0,
        timerInterval: null,
        currentEmotion: 'neutral', // neutral, happy, sad, angry, surprised, etc.
        currentContext: {
            outfit: '',
            scene: '',
            action: ''
        },

        // --- Initialization ---
        init() {
            // Setup STT
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                if (this.recognition) {
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'zh-CN'; // Default Chinese

                    const micIcon = document.getElementById('icon-mic');
                    this.recognition.onstart = () => {
                        console.log('[Recognition] Started');
                        if (micIcon) {
                            micIcon.classList.add('text-green-400', 'animate-pulse');
                        }
                    };
                    this.recognition.onend = () => {
                        console.log('[Recognition] Ended');
                        if (micIcon) {
                            micIcon.classList.remove('text-green-400', 'animate-pulse');
                        }
                        if (this.isActive) this.recognition.start();
                    };
                    this.recognition.onerror = (e) => console.error('[Recognition] Error:', e);
                    this.recognition.onresult = (e) => {
                        let interim = '';
                        for (let i = e.resultIndex; i < e.results.length; ++i) {
                            if (e.results[i].isFinal) {
                                this.handleUserSpeech(e.results[i][0].transcript);
                            } else {
                                interim += e.results[i][0].transcript;
                            }
                        }
                        const sttPreview = document.getElementById('call-stt-preview');
                        if (sttPreview) sttPreview.textContent = interim;
                    };
                }
            } else {
                console.warn('Browser does not support Speech Recognition');
            }
        },

        // --- Outgoing Call (User -> AI) ---
        startCall(cid, type) {
            this.charId = cid;
            this.callType = type;
            this.state = 'OUTGOING';
            this.initiator = 'user'; // Track initiator

            const subEl = document.getElementById('call-ai-subtitle');
            if (subEl) subEl.textContent = '';

            const chars = AppStorage.get('wechat_chars', {});
            const char = chars[cid];
            if (!char) return;

            // UI Setup
            this.showOverlay(char, 'outgoing');
            this.playRingtone('outgoing');

            // Logic: Send System Prompt to AI
            setTimeout(() => {
                const prompt = `[System: User is initiating a ${type} call. Do you accept? Reply with SHORT text (e.g. "å–‚ï¼Ÿ") to accept, or start with [REJECT] to decline. Do NOT continue roleplay yet.]`;

                // We use a helper to send hidden message
                WeChatUI.sendHiddenSystemMessage(cid, prompt, (replyText) => {
                    if (replyText.includes('[REJECT]')) {
                        this.handleRemoteReject(replyText);
                    } else {
                        this.handleRemoteAccept(replyText);
                    }
                });
            }, 500);
        },

        // --- Incoming Call (AI -> User) ---
        startIncomingCall(cid, type) {
            this.charId = cid;
            this.callType = type;
            this.state = 'INCOMING';
            this.initiator = 'ai'; // Track initiator

            const subEl = document.getElementById('call-ai-subtitle');
            if (subEl) subEl.textContent = '';

            const chars = AppStorage.get('wechat_chars', {});
            const char = chars[cid];
            if (!char) return;

            this.showOverlay(char, 'incoming');
            this.playRingtone('incoming');
        },

        // --- Actions ---
        acceptCall() {
            this.state = 'CONNECTED';
            console.log('[CallLogic] Call accepted');
            this.stopRingtone();
            this.updateLayout('connected');
            this.startTimer();
            if (this.callType === 'video') this.startVideo();
            this.startListening();

            // Notify AI we accepted
            WeChatUI.sendHiddenSystemMessage(this.charId, '[System: User accepted the call.]', (reply) => {
                this.speakAI(reply);
            });
        },

        rejectCall() {
            console.log('[CallLogic] User rejected call');
            this.stopRingtone();
            this.hideOverlay();
            WeChatUI.sendHiddenSystemMessage(this.charId, '[System: User rejected the call.]');
            this.reset();
        },

        endCall() {
            const duration = this.getDurationStr();
            console.log(`[CallLogic] Ending call. Duration: ${duration}`);
            this.stopRingtone();
            this.stopListening();
            this.stopVideo();
            this.hideOverlay();

            // Insert Summary Card (initiator's perspective)
            if (this.charId) {
                const typeText = this.callType === 'video' ? 'è§†é¢‘é€šè¯' : 'è¯­éŸ³é€šè¯';
                const summary = `[${typeText}] é€šè¯æ—¶é•¿ ${duration}`;
                // å‘èµ·äººè§†è§’ï¼šå¦‚æœæ˜¯ç”¨æˆ·å‘èµ·çš„ï¼Œroleä¸ºuserï¼›å¦‚æœæ˜¯AIå‘èµ·çš„ï¼Œroleä¸ºai
                const msgRole = this.initiator === 'user' ? 'user' : 'ai';

                console.log(`[CallLogic] Logging call. Initiator: ${this.initiator}, Role: ${msgRole}`);
                WeChatUI.pushMessage('call_log', summary, msgRole, null, null, this.charId);
            }
            this.reset();
        },

        handleRemoteAccept(firstReply) {
            this.state = 'CONNECTED';
            console.log('[CallLogic] Remote accepted call');
            this.stopRingtone();
            this.updateLayout('connected');
            this.startTimer();
            if (this.callType === 'video') this.startVideo();
            this.startListening();
            this.speakAI(firstReply);
        },

        handleRemoteReject(reason) {
            console.log('[CallLogic] Remote rejected call. Reason:', reason);
            document.getElementById('call-status').textContent = "å¯¹æ–¹å¿™çº¿ä¸­";
            setTimeout(() => {
                this.hideOverlay();
                const cleanReason = reason.replace(/\[REJECT\]/g, '').trim();
                WeChatUI.pushMessage('text', cleanReason, 'assistant', null, null, this.charId);
                this.reset();
            }, 2000);
        },

        handleUserSpeech(text) {
            if (!text || this.state !== 'CONNECTED') return;
            console.log('[CallLogic] User STT:', text);
            document.getElementById('call-stt-preview').textContent = text;

            // 1. Push user voice message as HIDDEN (to keep context without cluttering UI)
            WeChatUI.pushMessage('voice', text, 'user', null, null, this.charId, { hidden: true });

            // 2. Trigger AI Response
            const chars = AppStorage.get('wechat_chars', {});
            const char = chars[this.charId];
            if (!char) return;

            const msgs = (char.msgs || []).slice(-30); // Use 30 messages for more context during call
            let apiMessages = [{ role: 'system', content: '' }];

            const historyApiMsgs = msgs.map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: typeof m.content === 'string' ? m.content : (Array.isArray(m.content) ? JSON.stringify(m.content) : String(m.content))
            }));

            // Add extra emphasis to the voice constraint in the current turn
            if (historyApiMsgs.length > 0 && historyApiMsgs[historyApiMsgs.length - 1].role === 'user') {
                historyApiMsgs[historyApiMsgs.length - 1].content += "\n(System: Remember, we are in a voice call. Spoken words only.)";
            }
            apiMessages = apiMessages.concat(historyApiMsgs);

            SettingsLogic.generateLLM(apiMessages, this.charId, 'call_signal').then(reply => {
                if (reply) {
                    // 1. Extract Inner Voice before cleaning
                    const voiceData = InnerVoiceUI.parseVoiceData(reply);
                    if (voiceData) {
                        this.updateEmotionalState(voiceData);
                        // Store in history too
                        InnerVoiceUI.addVoice(reply, this.charId);
                    }

                    let cleanReply = reply.replace(/###/g, '')
                        .replace(/\[\s*INNER_VOICE\s*\][\s\S]*?\[\s*\/\s*INNER_VOICE\s*\]/gi, '')
                        .replace(/\[è¡¨æƒ…åŒ….*?\]/g, '')
                        .replace(/\{[\s\S]*?\}/g, '')
                        .replace(/<[^>]*>/g, '')
                        .replace(/\*.*?\*/g, '')
                        .trim();

                    this.speakAI(cleanReply);
                    // Push AI reply as HIDDEN too for context
                    WeChatUI.pushMessage('text', cleanReply, 'assistant', null, null, this.charId, { hidden: true });
                }
            });
        },

        updateEmotionalState(voiceData) {
            console.log('[CallLogic] Updating emotional state:', voiceData);
            this.currentContext = {
                outfit: voiceData.ç€è£… || voiceData.outfit || '',
                scene: voiceData.ç¯å¢ƒ || voiceData.scene || '',
                action: voiceData.è¡Œä¸º || voiceData.action || ''
            };

            const mind = voiceData.å¿ƒå£° || voiceData.thoughts || voiceData.mind || '';

            // Map mind/thoughts to basic emotions
            let emotion = 'neutral';
            if (/å¼€å¿ƒ|å¿«ä¹|ç¬‘|æ„‰æ‚¦|æœŸå¾…|å¥½æ„Ÿ|å–œæ¬¢|çˆ±/.test(mind)) emotion = 'happy';
            else if (/éš¾è¿‡|ä¼¤å¿ƒ|å“­|ç´¯|ç—›è‹¦|å¤±æœ›|å¹æ°”|å¯¹ä¸èµ·|é—æ†¾|ä¸èˆ|æ±‚ä½ /.test(mind)) emotion = 'sad';
            else if (/æ»š|è®¨åŒ|çƒ¦|æ€’|å¿«ç‚¹|åˆ«|é—­å˜´|å²‚æœ‰æ­¤ç†|ä¸å¯ç†å–»/.test(mind)) emotion = 'angry';
            else if (/æƒŠ|å¤©å‘|å“‡|ä»€ä¹ˆ|ï¼Ÿ/.test(mind)) emotion = 'surprised';

            this.currentEmotion = emotion;
            this.updateVisuals();
        },

        updateVisuals() {
            const backdrop = document.getElementById('call-backdrop');
            if (!backdrop) return;

            // Map emotion to colors/blur
            const emotionStyles = {
                neutral: { bg: 'rgba(0,0,0,0.6)', blur: '15px' },
                happy: { bg: 'rgba(255,105,180,0.3)', blur: '10px' },
                sad: { bg: 'rgba(70,130,180,0.4)', blur: '25px' },
                angry: { bg: 'rgba(139,0,0,0.4)', blur: '5px' },
                surprised: { bg: 'rgba(255,215,0,0.3)', blur: '12px' }
            };

            const style = emotionStyles[this.currentEmotion] || emotionStyles.neutral;
            backdrop.style.backgroundColor = style.bg;
            backdrop.style.backdropFilter = `blur(${style.blur})`;

            // Toggle ripple color if active
            const ripple = document.getElementById('call-avatar-ripple');
            if (ripple) {
                const colors = { happy: 'bg-pink-400/30', sad: 'bg-blue-400/30', angry: 'bg-red-600/30', surprised: 'bg-yellow-400/30', neutral: 'bg-white/20' };
                ripple.className = `absolute inset-0 rounded-2xl animate-ping ${colors[this.currentEmotion] || colors.neutral}`;
            }
        },

        // Called by WeChatUI when AI replies during call
        onAIResponse(text, msgObject) {
            if (this.state !== 'CONNECTED') return;

            const subtitleEl = document.getElementById('call-ai-subtitle');

            // ã€é‡è¦ã€‘åœ¨è¿™é‡Œæå– Inner Voice (å¦‚æœå°šæœªæå–)
            if (text.includes('[INNER_VOICE]')) {
                const voiceData = InnerVoiceUI.parseVoiceData(text);
                if (voiceData) this.updateEmotionalState(voiceData);
            }

            // ã€ä¿®å¤ã€‘æ¸…ç†å­—å¹•æ–‡æœ¬ (å»é™¤ HTML æ ‡ç­¾ã€Inner Voiceã€JSON å’Œ ###)
            let cleanText = text.replace(/###/g, '')
                .replace(/\[\s*INNER_VOICE\s*\][\s\S]*?\[\s*\/\s*INNER_VOICE\s*\]/gi, '')
                .replace(/\[\s*INNER_VOICE\s*\][\s\S]*?(\n|$)/gi, '')
                .replace(/\[\s*\/\s*INNER_VOICE\s*\]/gi, '')
                .replace(/\[è¡¨æƒ…åŒ….*?\]/g, '')
                .replace(/\{[\s\S]*?\}/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/\*.*?\*/g, '')
                .trim();

            cleanText = cleanText.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"').replace(/&#39;/g, "'");

            subtitleEl.textContent = cleanText;
            subtitleEl.classList.remove('opacity-0', 'translate-y-4');

            // ã€UI ä¼˜åŒ–ã€‘æ»šåŠ¨å¼å­—å¹•æ¡†
            subtitleEl.style.maxHeight = '140px';
            subtitleEl.style.overflowY = 'auto';
            subtitleEl.style.whiteSpace = 'pre-wrap';
            subtitleEl.style.pointerEvents = 'auto';
            subtitleEl.style.background = 'rgba(0,0,0,0.3)';
            subtitleEl.style.padding = '10px';
            subtitleEl.style.borderRadius = '8px';

            // TTS
            if (window.SettingsLogic && SettingsLogic.generateTTS) {
                const chars = AppStorage.get('wechat_chars', {});
                // Stop any previous speech
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                if (window.WeChatUI && WeChatUI.currentTTSAudio) {
                    WeChatUI.currentTTSAudio.pause();
                    WeChatUI.currentTTSAudio = null;
                }

                SettingsLogic.generateTTS(cleanText, chars[this.charId]).then(url => {
                    if (this.state !== 'CONNECTED') return; // Double check state

                    if (url === 'browser-tts-done') {
                        // Browser TTS handled itself
                        document.getElementById('call-avatar-ripple').classList.remove('hidden');
                        // No easy 'onstart' for browser TTS here without changing generateTTS, 
                        // but it's acceptable for now.
                        setTimeout(() => {
                            document.getElementById('call-avatar-ripple').classList.add('hidden');
                            subtitleEl.classList.add('opacity-0', 'translate-y-4');
                        }, cleanText.length * 200 + 1000);
                    } else if (url) {
                        const audio = new Audio(url);
                        WeChatUI.currentTTSAudio = audio;
                        audio.play();
                        document.getElementById('call-avatar-ripple').classList.remove('hidden');
                        audio.onended = () => {
                            document.getElementById('call-avatar-ripple').classList.add('hidden');
                            setTimeout(() => {
                                subtitleEl.classList.add('opacity-0', 'translate-y-4');
                            }, 2000);
                        };
                    }
                });
            }
        },

        speakAI(text) {
            // 1. Clean Text (CRITICAL FIX for Inner Voice Leak via handleRemoteAccept)
            let cleanText = text.replace(/###/g, '')
                // Strict Block Removal with Case Insensitivity and Space Tolerance
                .replace(/\[\s*INNER_VOICE\s*\][\s\S]*?\[\s*\/\s*INNER_VOICE\s*\]/gi, '')
                .replace(/\[\s*INNER_VOICE\s*\][\s\S]*?(\n|$)/gi, '')
                .replace(/\[\s*\/\s*INNER_VOICE\s*\]/gi, '')
                .replace(/\[è¡¨æƒ…åŒ….*?\]/g, '')
                .replace(/\{[\s\S]*?\}/g, '')
                .replace(/<[^>]*>/g, '')
                .replace(/\*.*?\*/g, '')
                .trim();
            this.onAIResponse(cleanText, { text: cleanText });
        },

        showOverlay(char, mode) {
            const overlay = document.getElementById('call-overlay');
            overlay.classList.remove('hidden');
            document.getElementById('call-name').textContent = char.name;
            document.getElementById('call-avatar').src = char.avatar;
            document.getElementById('call-status').textContent = mode === 'outgoing' ? 'æ­£åœ¨å‘¼å«...' : 'é‚€è¯·ä½ è¿›è¡Œè¯­éŸ³é€šè¯...';
            this.updateLayout(mode);

            // Optional: Video Background
            if (this.callType === 'video' && char.call_assets) {
                // Try to find video asset... (Placeholder for now)
            }
        },

        startVideo() {
            // Check User Avatar
            const profile = AppStorage.get('wechat_user_profile', {});
            const userAvatar = profile.avatar; // Base64

            const videoEl = document.getElementById('local-video-preview');
            // Create or Find Avatar Img Container
            let avatarEl = document.getElementById('local-video-avatar');

            if (!avatarEl && videoEl) {
                avatarEl = document.createElement('img');
                avatarEl.id = 'local-video-avatar';
                avatarEl.style.width = '100%';
                avatarEl.style.height = '100%';
                avatarEl.style.objectFit = 'cover';
                avatarEl.className = videoEl.className;
                videoEl.parentElement.appendChild(avatarEl);
            }

            if (userAvatar && avatarEl) {
                // Use Avatar Image
                avatarEl.src = userAvatar;
                avatarEl.classList.remove('hidden');
                if (videoEl) videoEl.classList.add('hidden');

                // Get Audio Only
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            window.localStream = stream;
                        })
                        .catch(e => console.error('Audio access denied:', e));
                }
            } else {
                // Fallback to Camera
                if (avatarEl) avatarEl.classList.add('hidden');
                if (videoEl) videoEl.classList.remove('hidden');

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                        .then(stream => {
                            if (videoEl) {
                                videoEl.srcObject = stream;
                                videoEl.parentElement.classList.remove('hidden');
                            }
                            window.localStream = stream;
                        })
                        .catch(e => console.error('Camera access denied:', e));
                }
            }
        },

        stopVideo() {
            if (window.localStream) {
                window.localStream.getTracks().forEach(track => track.stop());
                window.localStream = null;
            }
            const videoEl = document.getElementById('local-video-preview');
            if (videoEl) {
                videoEl.srcObject = null;
                videoEl.parentElement.classList.add('hidden');
            }
            const avatarEl = document.getElementById('local-video-avatar');
            if (avatarEl) avatarEl.remove();
        },

        hideOverlay() { document.getElementById('call-overlay').classList.add('hidden'); },

        updateLayout(mode) {
            const activeControls = document.getElementById('call-controls-active');
            const incomingControls = document.getElementById('call-controls-incoming');
            if (mode === 'connected' || mode === 'outgoing') { // Show active controls for outgoing to allow cancel
                activeControls.classList.remove('hidden');
                incomingControls.classList.add('hidden');
                if (mode === 'connected') document.getElementById('call-status').textContent = "00:00";
            } else if (mode === 'incoming') {
                activeControls.classList.add('hidden');
                incomingControls.classList.remove('hidden');
            }
        },

        startListening() {
            this.isActive = true;
            try { this.recognition && this.recognition.start(); } catch (e) { }
        },
        stopListening() {
            this.isActive = false;
            this.recognition && this.recognition.stop();
        },

        playRingtone(type) {
            // Simple synthetic ringtone
            if (this.ringtoneTimer) clearInterval(this.ringtoneTimer);
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const playBeep = () => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    if (type === 'incoming') {
                        // Double beep for incoming
                        osc.frequency.setValueAtTime(800, ctx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.1, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                        osc.start();
                        osc.stop(ctx.currentTime + 0.5);
                    } else {
                        // Long low beep for outgoing
                        osc.frequency.setValueAtTime(440, ctx.currentTime);
                        gain.gain.setValueAtTime(0.05, ctx.currentTime);
                        osc.start();
                        osc.stop(ctx.currentTime + 1.0);
                    }
                };
                playBeep();
                this.ringtoneTimer = setInterval(playBeep, type === 'incoming' ? 1500 : 2000);
            } catch (e) { console.error('AudioContext error', e); }
        },
        stopRingtone() {
            if (this.ringtoneTimer) clearInterval(this.ringtoneTimer);
            this.ringtoneTimer = null;
        },

        startTimer() {
            this.startTime = Date.now();
            this.timerInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - this.startTime) / 1000);
                const min = Math.floor(diff / 60).toString().padStart(2, '0');
                const sec = (diff % 60).toString().padStart(2, '0');
                document.getElementById('call-status').textContent = `${min}:${sec}`;
            }, 1000);
        },
        stopTimer() { clearInterval(this.timerInterval); },
        getDurationStr() { return document.getElementById('call-status').textContent; },
        reset() { this.state = 'IDLE'; this.stopTimer(); this.charId = null; },
        toggleMute() {
            this.isMuted = !this.isMuted;
            document.getElementById('icon-mic').className = this.isMuted ? 'fa-solid fa-microphone-slash text-red-500' : 'fa-solid fa-microphone text-xl';
            if (this.isMuted) this.stopListening(); else this.startListening();
        },
        toggleInput() {
            const box = document.getElementById('call-input-box');
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                box.classList.remove('translate-y-10', 'opacity-0');
                document.getElementById('input-call-text').focus();
            } else { box.classList.add('translate-y-10', 'opacity-0'); }
        },
        sendText() {
            const input = document.getElementById('input-call-text');
            if (input.value) { this.handleUserSpeech(input.value); input.value = ''; this.toggleInput(); }
        }
    };

    document.addEventListener('DOMContentLoaded', () => CallLogic.init());
</script>

<!-- [New] Call UI Overlay -->
<div id="call-overlay" class="fixed inset-0 z-[9999] hidden flex flex-col items-center justify-between text-white"
    style="background-color: #111; background-size: cover; background-position: center; transition: opacity 0.3s ease;">
    <!-- Backdrop filter for blur -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-md z-0 transition-all duration-1000" id="call-backdrop">
    </div>

    <!-- Video Background (Optional) -->
    <video id="call-bg-video"
        class="absolute inset-0 w-full h-full object-cover z-0 hidden opacity-0 transition-opacity duration-1000" loop
        muted playsinline></video>

    <!-- Top Info -->
    <div class="z-10 mt-20 flex flex-col items-center transform transition-transform duration-500" id="call-info-panel">
        <div class="relative">
            <img id="call-avatar" src="" class="w-28 h-28 rounded-2xl shadow-2xl border border-white/10 object-cover">
            <!-- Ripple for talking/ringing -->
            <div id="call-avatar-ripple" class="absolute inset-0 rounded-2xl animate-ping bg-white/20 hidden"></div>
        </div>
        <h2 id="call-name" class="mt-6 text-2xl font-bold tracking-wide drop-shadow-lg">Character Name</h2>
        <p id="call-status" class="mt-2 text-sm text-gray-300 font-medium">æ­£åœ¨ç­‰å¾…æ¥å¬...</p>
    </div>

    <!-- Center Visualization / Video -->
    <div class="z-10 flex-1 flex flex-col items-center justify-center w-full px-4 relative">
        <!-- Local Video (PiP) -->
        <div id="local-video-container"
            class="absolute top-4 right-4 w-28 h-40 bg-black/50 rounded-xl overflow-hidden hidden border border-white/20 shadow-2xl transition-all duration-300 hover:scale-105">
            <video id="local-video-preview" class="w-full h-full object-cover transform -scale-x-100" autoplay muted
                playsinline></video>
        </div>

        <!-- Subtitle / Stt Result -->
        <div id="call-subtitle-container" class="mt-auto mb-10 w-full max-w-md text-center px-4">
            <!-- User STT Preview -->
            <p id="call-stt-preview" class="text-white/60 text-sm italic mb-3 min-h-[20px] transition-all duration-200">
            </p>
            <!-- AI Subtitle -->
            <div class="relative">
                <p id="call-ai-subtitle"
                    class="text-white font-medium text-lg leading-relaxed drop-shadow-md bg-black/20 backdrop-blur-sm px-4 py-2 rounded-xl inline-block transition-all duration-300 transform translate-y-4 opacity-0">
                    <!-- AI text goes here -->
                </p>
            </div>
        </div>
    </div>

    <!-- Bottom Controls -->
    <div class="z-10 mb-16 w-full px-12">
        <!-- Connected Controls -->
        <div id="call-controls-active" class="grid grid-cols-3 gap-8 items-center justify-items-center hidden">
            <!-- Mute -->
            <button id="btn-call-mute" onclick="CallLogic.toggleMute()"
                class="flex flex-col items-center gap-2 group transition-transform active:scale-95">
                <div
                    class="w-16 h-16 rounded-full bg-white/10 group-active:bg-white/20 flex items-center justify-center backdrop-blur-sm transition-all border border-white/10 hover:bg-white/15">
                    <i class="fa-solid fa-microphone text-xl" id="icon-mic"></i>
                </div>
                <span class="text-xs text-gray-300">éº¦å…‹é£</span>
            </button>

            <!-- Hangup -->
            <button onclick="CallLogic.endCall()"
                class="flex flex-col items-center gap-2 group transition-transform active:scale-90">
                <div
                    class="w-20 h-20 rounded-full bg-red-500 shadow-lg shadow-red-500/40 flex items-center justify-center hover:bg-red-600 transition-all">
                    <i class="fa-solid fa-phone-slash text-2xl text-white"></i>
                </div>
                <span class="text-xs text-gray-300">æŒ‚æ–­</span>
            </button>

            <!-- Input/Keyboard -->
            <button id="btn-call-input" onclick="CallLogic.toggleInput()"
                class="flex flex-col items-center gap-2 group transition-transform active:scale-95">
                <div
                    class="w-16 h-16 rounded-full bg-white/10 group-active:bg-white/20 flex items-center justify-center backdrop-blur-sm transition-all border border-white/10 hover:bg-white/15">
                    <i class="fa-solid fa-keyboard text-xl"></i>
                </div>
                <span class="text-xs text-gray-300">è¾“å…¥</span>
            </button>
        </div>

        <!-- Incoming Call Controls -->
        <div id="call-controls-incoming" class="flex justify-between items-end w-full px-8 hidden">
            <!-- Reject -->
            <button onclick="CallLogic.rejectCall()" class="flex flex-col items-center gap-3 group">
                <div
                    class="w-16 h-16 rounded-full bg-red-500 shadow-lg flex items-center justify-center animate-bounce-slight hover:bg-red-600 transition-colors">
                    <i class="fa-solid fa-phone-slash text-xl text-white"></i>
                </div>
                <span class="text-sm">æ‹’ç»</span>
            </button>

            <!-- Accept -->
            <button onclick="CallLogic.acceptCall()" class="flex flex-col items-center gap-3 group">
                <div
                    class="w-16 h-16 rounded-full bg-green-500 shadow-lg flex items-center justify-center animate-bounce-slight hover:bg-green-600 transition-colors">
                    <i class="fa-solid fa-phone text-xl text-white animate-pulse"></i>
                </div>
                <span class="text-sm">æ¥å¬</span>
            </button>
        </div>
    </div>

    <!-- Floating Input (Hidden by default) -->
    <div id="call-input-box"
        class="absolute bottom-40 left-6 right-6 z-20 hidden transform transition-all duration-300 translate-y-10 opacity-0 bg-gray-900/90 backdrop-blur-xl rounded-2xl p-2 border border-white/10 shadow-2xl">
        <div class="flex gap-2 items-center">
            <input type="text" id="input-call-text"
                class="bg-transparent border-none text-white placeholder-gray-400 flex-1 px-3 py-2 focus:ring-0 text-base"
                placeholder="ä¸æ–¹ä¾¿è¯´è¯ï¼Ÿæ‰“å­—ç»™TA...">
            <button onclick="CallLogic.sendText()"
                class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center transition-colors">
                <i class="fa-solid fa-paper-plane text-xs"></i>
            </button>
        </div>
    </div>

    <!-- Hidden audio element for Ringtones -->
    <audio id="audio-ringtone" loop></audio>
</div>
<!-- ã€æ–°å¢ã€‘æŸ¥æ‰‹æœºæ¨¡å¼ä¸‹çš„å°ç»„ä»¶ç‹¬ç«‹æ€§æ”¯æŒ -->
<script>
    (function () {
        // å®šæœŸæ£€æŸ¥ SearchPhoneUI æ˜¯å¦åŠ è½½å®Œæˆ
        const checkInit = setInterval(() => {
            if (window.SearchPhoneUI) {
                clearInterval(checkInit);
                initSearchPhoneHooks();
            }
        }, 500);

        function initSearchPhoneHooks() {
            // Hook SearchPhoneUI ç›¸å…³æ–¹æ³•
            const targets = ['open', 'init', 'render'];
            let hooked = false;

            targets.forEach(method => {
                if (typeof SearchPhoneUI[method] === 'function') {
                    const original = SearchPhoneUI[method];
                    SearchPhoneUI[method] = function () {
                        const result = original.apply(this, arguments);
                        // å¦‚æœè®¾ç½®äº† targetCharIdï¼Œè¯´æ˜è¿›å…¥äº†æŸ¥æ‰‹æœºæ¨¡å¼
                        if (SearchPhoneUI.targetCharId) {
                            applyCharWidgets(SearchPhoneUI.targetCharId);
                        }
                        return result;
                    };
                    hooked = true;
                }
            });

            // å¦‚æœæ²¡æ‰¾åˆ°æ–¹æ³• hook, å°è¯•ç›‘å¬ onclick äº‹ä»¶ä½œä¸ºè¡¥å……
            if (!hooked) {
                document.addEventListener('click', (e) => {
                    const searchIcon = e.target.closest('#icon-search') || e.target.closest('[onclick*="openApp(\'search\')"]');
                    if (searchIcon) {
                        setTimeout(() => {
                            if (SearchPhoneUI.targetCharId) {
                                applyCharWidgets(SearchPhoneUI.targetCharId);
                            }
                        }, 500);
                    }
                });
            }
        }

        function applyCharWidgets(charId) {
            console.log('[SearchPhone] Applying widgets for char:', charId);
            const saveKey = 'theme_config_' + charId;
            const charTheme = AppStorage.get(saveKey, {});
            const globalTheme = AppStorage.get('theme_config', {});

            // æ„é€ æ··åˆé…ç½®ï¼šå…¨å±€åŸºç¡€ + è§’è‰²ç»„ä»¶
            // æ³¨æ„ï¼šæˆ‘ä»¬å¿…é¡»ç¡®ä¿ t.widgets å­˜åœ¨ï¼Œå¦åˆ™ ThemeLogic.apply ä¸ä¼šæ›´æ–° DOM
            const widgets = charTheme.widgets || {};

            const appliedTheme = {
                ...globalTheme,
                widgets: widgets,
                widgetTransforms: charTheme.widgetTransforms || {}
            };

            ThemeLogic.apply(appliedTheme);
        }

        // ç›‘å¬é€€å‡ºæŸ¥æ‰‹æœº
        const originalCloseApp = window.closeApp;
        window.closeApp = function () {
            if (originalCloseApp) originalCloseApp.apply(this, arguments);

            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœå½“å‰æ˜¯åœ¨å…³é—­ SearchAppï¼Œåˆ™æ¢å¤å…¨å±€
            // è¿™é‡Œæˆ‘ä»¬å‡è®¾ closeApp è¢«è°ƒç”¨æ„å‘³ç€å¹¶ä¸æ˜¯åœ¨ SearchPhone å†…éƒ¨æ“ä½œ
            // æˆ–è€…æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ SearchPhoneUI çŠ¶æ€?

            // å»¶è¿Ÿæ¢å¤ï¼Œç¡®ä¿ UI åˆ‡æ¢å®Œæˆ
            setTimeout(() => {
                const globalTheme = AppStorage.get('theme_config', {});
                ThemeLogic.apply(globalTheme);
            }, 100);
        };
    })();
</script>

<!-- [Auto-Fix] Phone UI Interaction Patch -->
<script>
    (function () {
        console.log('[Fix] Initializing Phone UI Auto-Repair...');

        // 1. Monkey-patch SearchPhoneUI.closeSubApp
        const fixInterval = setInterval(() => {
            if (typeof SearchPhoneUI !== 'undefined' && SearchPhoneUI.closeSubApp) {
                console.log('[Fix] SearchPhoneUI found, applying patch...');

                const originalClose = SearchPhoneUI.closeSubApp;
                SearchPhoneUI.closeSubApp = function () {
                    console.log('[Fix] Closing app via patched function...');
                    // Call original
                    originalClose.apply(this, arguments);

                    // FORCE RESET UI State
                    setTimeout(() => {
                        console.log('[Fix] Resetting UI state after app close');
                        document.body.style.overflow = '';
                        document.body.style.pointerEvents = 'auto';

                        const desktop = document.getElementById('search-page-desktop');
                        if (desktop) desktop.style.pointerEvents = 'auto';

                        const select = document.getElementById('search-page-select');
                        if (select) select.style.pointerEvents = 'auto';

                        const appSearch = document.getElementById('app-search');
                        if (appSearch) appSearch.style.pointerEvents = 'auto';
                    }, 100);
                };

                clearInterval(fixInterval);
            }
        }, 500);

        // 2. Global Watchdog (Safety Net)
        setInterval(() => {
            const subAppModal = document.getElementById('modal-phone-subapp');
            // If modal exists and is hidden (translated away)
            if (subAppModal && subAppModal.classList.contains('translate-y-full')) {
                // Check if body is locked
                if (document.body.style.pointerEvents === 'none') {
                    console.log('[Fix] Watchdog: Detected stuck pointer-events, resetting...');
                    document.body.style.pointerEvents = 'auto';
                }
                if (document.body.style.overflow === 'hidden') {
                    // Only reset overflow if we are NOT in another modal
                    const visibleOverlays = document.querySelectorAll('.modal-overlay:not(.hidden)');
                    if (visibleOverlays.length === 0) {
                        console.log('[Fix] Watchdog: Detected stuck overflow, resetting...');
                        document.body.style.overflow = '';
                    }
                }
            }
        }, 2000);
    })();
</script>

</body>

</html>