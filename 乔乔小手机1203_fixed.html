<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>乔乔小手机 OS</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e1b4b">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Embed Manifest -->
    <link rel="manifest" id="manifest-placeholder">

    <style>
        /* Base Fonts & Vars */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        :root {
            --app-bg-color: #f0fdf4; --text-color: #166534; 
            --glass-border: rgba(16, 185, 129, 0.3); --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(217, 249, 233, 0.8));
            --accent-color: #34d399; --input-bg: rgba(255, 255, 255, 0.95);
            --wechat-green: #10b981; --bubble-self: #d1fae5; --bubble-other: #ffffff;
            --transfer-color: #f59e0b; --redpacket-color: #ef4444;
            --light-pink: #fce7f3; --light-green: #d1fae5; --light-yellow: #fef3c7;
            --light-purple: #ede9fe; --blue-pink-gradient: linear-gradient(135deg, #bae6fd, #fbcfe8);
        }
        body { font-family: 'Noto Sans SC', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; background-color: var(--app-bg-color); color: var(--text-color); }

        /* Wallpaper */
        #wallpaper-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%); background-size: cover; background-position: center; z-index: -2; transition: background-image 0.5s ease; }

        /* UI Components */
        .glass-panel { background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(255,255,255,0.6)); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.9); box-shadow: 0 4px 20px 0 rgba(56, 189, 248, 0.15); }
        .glass-bar { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-top: 1px solid rgba(56, 189, 248, 0.2); }
        .glass-icon { background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(240, 253, 244, 0.8)); backdrop-filter: blur(12px); border: 2px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 20px rgba(56, 189, 248, 0.15), inset 0 2px 5px rgba(255, 255, 255, 0.8); transition: transform 0.2s, box-shadow 0.2s; overflow: hidden; display: flex; align-items: center; justify-content: center; border-radius: 20px; }
        .glass-icon:active { transform: scale(0.92); filter: brightness(1.1); }
        .glass-icon img, .widget-img { width: 100%; height: 100%; object-fit: cover; }

        /* App Window */
        .app-window { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(40px); z-index: 100; transform: translateX(100%); transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; overflow: hidden; }
        .app-window.active { transform: translateX(0); }
        .app-header { height: 56px; display: flex; align-items: center; padding: 0 16px; margin-top: 30px; border-bottom: 1px solid rgba(56, 189, 248, 0.2); background: rgba(255,255,255,0.9); flex-shrink: 0; z-index: 50; }
        .app-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 80px; }

        /* Inputs */
        .setting-input { width: 100%; background: var(--input-bg); border: 1px solid var(--glass-border); padding: 10px; border-radius: 8px; color: var(--text-color); margin-bottom: 8px; font-size: 13px; transition: 0.3s; }
        .setting-input:focus { outline: none; border-color: var(--accent-color); background: rgba(56, 189, 248, 0.15); }
        .url-input-group { display: flex; gap: 8px; margin-bottom: 12px; } .url-input-group input { margin-bottom: 0; flex: 1; } .url-input-group button { width: auto; padding: 0 16px; }
        select.setting-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; } select.setting-input option { background-color: #ffffff; color: #1e293b; }
        /* 主按钮：修改为清新的淡蓝色渐变 (Baby Blue) */
        .setting-btn { background: linear-gradient(135deg, #A5D8FF, #74C0FC); color: white; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 600; text-align: center; border: 1px solid rgba(255,255,255,0.5); width: 100%; transition: 0.2s; box-shadow: 0 4px 10px rgba(165, 216, 255, 0.4); } .setting-btn:active { transform: scale(0.96); }
        /* 次级按钮：修改为极淡的蓝灰色背景 */
        .setting-btn.secondary { background: rgba(165, 216, 255, 0.15); border: 1px solid rgba(165, 216, 255, 0.5); color: #5c7cfa; } .setting-btn.danger { background: linear-gradient(135deg, #ef4444, #be123c); }
        .section-title { font-size: 12px; color: #0ea5e9; margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; opacity: 0.8; }

        /* Desktop Swiper */
        .app-pages-container { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100%; height: 100%; cursor: grab; }
        .app-pages-container.active { cursor: grabbing; }
        .app-page { min-width: 100%; height: 100%; scroll-snap-align: start; padding: 1.5rem 1rem; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: min-content min-content min-content auto; gap: 1rem; align-content: start; overflow-y: auto; }

        /* WeChat Specific */
        .wechat-tab-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; gap: 2px; } .wechat-tab-btn.active { color: var(--wechat-green); }
        .sub-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 60; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; } .sub-view.active { transform: translateX(0); }
        
        /* Chat Bubble System */
        .msg-row { display: flex; gap: 5px; margin-bottom: 15px; align-items: flex-start; padding: 0 5px; transition: background 0.2s; }
        .msg-row.self { flex-direction: row-reverse; }
        
        /* Checkbox for Multi-select */
        .msg-checkbox { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #666; margin-top: 10px; margin-right: 10px; flex-shrink: 0; display: none; align-items: center; justify-content: center; }
        .msg-row.self .msg-checkbox { margin-right: 0; margin-left: 10px; }
        .multiselect-mode .msg-checkbox { display: flex; }
        .msg-checkbox.checked { background: var(--wechat-green); border-color: var(--wechat-green); }
        .msg-checkbox.checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 10px; color: white; }
        
        /* Unread Badge */
        .unread-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #111; }

        .msg-avatar { width: 40px; height: 40px; overflow: hidden; flex-shrink: 0; background: #333; }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .msg-avatar.circle { border-radius: 50%; }
        .msg-avatar.square { border-radius: 6px; }
        
        /* Avatar Box for Chat List and Contacts */
        .avatar-box { width: 48px; height: 48px; border-radius: 6px; overflow: hidden; flex-shrink: 0; background: #e5e7eb; display: flex; align-items: center; justify-content: center; }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Chat List Item - Fixed Height */
        #tab-chat > div[onclick] { 
            min-height: 72px; 
            height: 72px; 
            box-sizing: border-box;
        }
        
        /* Chat List Preview Text - Prevent Overflow */
        #tab-chat > div[onclick] .text-sm.truncate {
            max-height: 20px;
            overflow: hidden;
            line-height: 20px;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        /* Chat Image Messages */
        .msg-image { max-width: 250px; max-height: 400px; width: auto; height: auto; border-radius: 6px; overflow: hidden; display: block; }
        .msg-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
        /* Ensure image container doesn't exceed bubble width */
        .msg-content .msg-image { max-width: min(250px, 80vw); }
        .msg-content { max-width: 85%; position: relative; display: flex; flex-direction: column; }
        .chat-bubble { padding: 8px 12px; border-radius: 6px; font-size: 15px; line-height: 1.5; word-wrap: break-word; position: relative; min-height: 36px; display: flex; flex-direction: column; justify-content: center; }
        .msg-row.other .chat-bubble { background-color: var(--bubble-other); color: #000; }
        .msg-row.self .chat-bubble { background-color: var(--bubble-self); color: #000; }
        
        /* Timestamp Outside Bubble */
        .msg-time-outside { font-size: 9px; opacity: 0.8; color: #64748b; margin-top: 4px; padding: 0 2px; }
        .msg-row.self .msg-time-outside { align-self: flex-end; text-align: right; }
        .msg-row.other .msg-time-outside { align-self: flex-start; text-align: left; }

        /* System Message */
        .msg-system { text-align: center; font-size: 12px; color: rgba(255,255,255,0.3); margin: 10px 0; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .msg-system span { background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; cursor: default; }
        .msg-system.clickable span { cursor: pointer; text-decoration: underline; }
        .msg-system .time { font-size: 9px; margin-bottom: 4px; opacity: 0.7; background: transparent; padding: 0; text-decoration: none !important; }
        .msg-error span { background: rgba(220, 38, 38, 0.6); color: white; }

        /* Triangles */
        .msg-row.other .chat-bubble::before { content: ""; position: absolute; top: 14px; left: -6px; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-right: 6px solid var(--bubble-other); }
        .msg-row.self .chat-bubble::before { content: ""; position: absolute; top: 14px; right: -6px; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 6px solid var(--bubble-self); }
        
        /* Red Packet & Transfer Styles */
        .pay-card { width: 230px; display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; padding: 0 !important; background: transparent !important; cursor: pointer; transition: opacity 0.2s, filter 0.2s; position: relative; }
        .pay-card.received, .pay-card.rejected { opacity: 0.7; filter: grayscale(0.8); cursor: default; }
        .pay-top { padding: 15px; display: flex; align-items: center; gap: 12px; color: white; height: 60px; }
        .pay-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); border-radius: 50%; font-size: 18px; }
        .pay-info { display: flex; flex-direction: column; justify-content: center; }
        .pay-title { font-size: 15px; font-weight: 500; line-height: 1.2; }
        .pay-desc { font-size: 12px; opacity: 0.8; line-height: 1.2; margin-top: 2px; }
        .pay-bottom { background: white; padding: 6px 12px; font-size: 11px; color: #888; }

        /* Specific Bubble Colors & Triangles */
        .bubble-transfer { background-color: var(--transfer-color) !important; padding: 0 !important; }
        .bubble-redpacket { background-color: var(--redpacket-color) !important; padding: 0 !important; }
        /* HTML专用气泡样式 */
        .bubble-html { padding: 12px !important; border-radius: 8px !important; overflow: hidden !important; }
        /* 为HTML气泡添加特殊背景效果 */
        .msg-row.other .bubble-html { background: linear-gradient(135deg, #ffffff, #f8fafc) !important; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important; }
        .msg-row.self .bubble-html { background: linear-gradient(135deg, #d1fae5, #a7f3d0) !important; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15) !important; }
        /* HTML气泡的三角样式 */
        .msg-row.other .bubble-html::before { border-right-color: #ffffff !important; }
        .msg-row.self .bubble-html::before { border-left-color: #d1fae5 !important; }
        /* HTML隔离容器样式 */
        .html-isolated-container {
            all: initial !important;
            width: 100% !important;
            height: auto !important;
            overflow: auto !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            color: #333 !important;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            display: block !important;
        }
        .html-isolated-container * {
            all: initial !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
            color: #333 !important;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            display: inline !important;
        }
        /* 重置部分常用标签 */
        .html-isolated-container h1, .html-isolated-container h2, .html-isolated-container h3 {
            font-size: 20px !important;
            font-weight: bold !important;
            margin: 10px 0 !important;
            display: block !important;
        }
        .html-isolated-container p {
            margin: 10px 0 !important;
            display: block !important;
        }
        .html-isolated-container button {
            background: #34d399 !important;
            color: white !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            margin: 5px 0 !important;
            display: inline-block !important;
        }
        .html-isolated-container div {
            display: block !important;
        }
        .msg-row.self .bubble-transfer::before { border-left-color: var(--transfer-color) !important; }
        .msg-row.other .bubble-transfer::before { border-right-color: var(--transfer-color) !important; }
        .msg-row.self .bubble-redpacket::before { border-left-color: var(--redpacket-color) !important; }
        .msg-row.other .bubble-redpacket::before { border-right-color: var(--redpacket-color) !important; }

        /* Voice Bubble Styles */
        .voice-container { display: flex; flex-direction: column; align-items: flex-start; width: 100%; }
        .voice-bubble { cursor: pointer; display: flex; align-items: center; gap: 8px; min-width: 80px; width: 100%; }
        .voice-icon { font-size: 16px; transition: opacity 0.2s; display: flex; align-items: center; }
        .voice-playing .voice-icon i { animation: wifi-pulse 1s infinite; }
        @keyframes wifi-pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }
        .voice-text { font-size: 13px; color: inherit; margin-top: 0; padding-top: 0; border-top: 1px solid rgba(0,0,0,0.1); width: 100%; max-height: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease; }
        .voice-text.expanded { margin-top: 8px; padding-top: 6px; max-height: 200px; opacity: 0.8; }
        
        /* Spinner Fixed */
        .spinner-container { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
        .spinner-rotate { animation: spin 1s linear infinite; transform-origin: center; font-size: 16px; width: 16px; height: 16px; line-height: 16px; text-align: center; display: block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Toggle & Modal */
        .toggle-switch { appearance: none; width: 40px; height: 20px; background: #444; border-radius: 20px; position: relative; cursor: pointer; outline: none; transition: background 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch:checked { background: var(--wechat-green); } .toggle-switch:checked::after { transform: translateX(20px); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        /* 【修改】背景改为纯白，文字改为深灰，阴影变柔和 */
        .modal-box { background: #ffffff; color: #333333; width: 85%; max-width: 300px; border-radius: 16px; padding: 20px; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Open Red Packet Modal */
        .redpacket-modal { background: #d95940; color: #fce5cd; text-align: center; border: none; position: relative; overflow: visible; height: 400px; display: flex; flex-direction: column; align-items: center; width: 300px; border-radius: 16px; }
        .rp-top-curve { position: absolute; top: -50px; left: -10%; width: 120%; height: 100px; background: #d95940; border-radius: 50%; z-index: 0; border: 2px solid rgba(0,0,0,0.05); }
        .rp-user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fce5cd; margin-top: 40px; z-index: 1; overflow: hidden; background: #333; }
        .rp-user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .rp-msg { font-size: 16px; margin-top: 10px; z-index: 1; font-weight: bold; padding: 0 20px; }
        .rp-open-btn { width: 90px; height: 90px; background: #fce5cd; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #333; font-size: 36px; font-weight: bold; margin-top: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 1; transition: transform 0.5s; }
        .rp-open-btn.spinning { animation: flip-vertical-bck 0.6s infinite; }
        @keyframes flip-vertical-bck { 0% { transform: translateZ(0) rotateY(0); } 100% { transform: translateZ(-260px) rotateY(-360deg); } }
        
        .rp-result { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; padding-top: 40px; background: white; border-radius: 16px; color: black; z-index: 10; }
        .rp-result.active { display: flex; }
        .rp-amount { font-size: 48px; font-weight: bold; color: #d95940; margin-top: 20px; }
        .rp-amount span { font-size: 16px; font-weight: normal; color: #888; }

        /* Payment Action Modal (Unified) */
        #modal-payment-action .modal-box {
            background: #f2f2f2;
            color: black;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .payment-success-icon { font-size: 60px; color: var(--wechat-green); margin-bottom: 20px; }
        .payment-amount { font-size: 40px; font-weight: bold; margin-bottom: 5px; }
        .payment-desc { color: #888; font-size: 14px; margin-bottom: 40px; }
        .payment-btn { background: var(--wechat-green); color: white; border-radius: 6px; padding: 12px 0; width: 80%; font-size: 16px; font-weight: 500; margin-bottom: 20px; }
        .payment-reject-link { color: #576b95; font-size: 13px; cursor: pointer; margin-top: auto; }

        /* Worldbook App Styles */
        .wb-list-item { background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; color: #166534; }
        .wb-list-item:active { background: rgba(56, 189, 248, 0.15); transform: scale(0.98); }
        .wb-entry { border-left: 3px solid var(--accent-color); background: rgba(56, 189, 248, 0.1); padding: 10px; margin-bottom: 8px; border-radius: 0 8px 8px 0; color: #166534; }
        
        /* Collapsible Worldbook in Character Settings */
        .wb-collapsible { border-bottom: 1px solid rgba(0,0,0,0.1); }
        .wb-collapsible-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: pointer; user-select: none; transition: background 0.2s; color: #166534; }
        .wb-collapsible-header:hover { background: rgba(56, 189, 248, 0.1); }
        .wb-collapsible-header:active { background: rgba(56, 189, 248, 0.2); }
        .wb-collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .wb-collapsible-content.expanded { max-height: 500px; transition: max-height 0.3s ease-in; }
        .wb-collapsible-icon { transition: transform 0.3s; }
        .wb-collapsible-icon.expanded { transform: rotate(90deg); }

        /* Context Menu */
        #context-menu { position: fixed; background: #2b2b2b; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 9999; width: 140px; display: none; padding: 5px 0; border: 1px solid #333; }
        .ctx-item { padding: 10px 15px; font-size: 14px; color: white; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .ctx-item i { width: 16px; text-align: center; font-size: 12px; opacity: 0.7; }
        .ctx-item:active { background: #444; }
        .ctx-divider { height: 1px; background: #333; margin: 4px 0; }
        
        /* Contact Context Menu */
        #contact-context-menu { position: fixed; background: #2b2b2b; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 9999; width: 140px; border: 1px solid #333; display: none; }

        /* Inner Voice Card */
        /* Inner Voice Card - Hidden by default */
        #inner-voice-card { display: none !important; }
        
        /* Inner Voice Modal - Character Info Style */
        #inner-voice-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; }
        #inner-voice-modal.active { display: flex; }
        .voice-modal-content { 
            background: #f8f8f8; 
            width: 85%; 
            max-width: 500px; 
            max-height: 85vh; 
            border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .voice-modal-content::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(248, 248, 248, 0.85);
            z-index: 0;
        }
        .voice-modal-content > * {
            position: relative;
            z-index: 1;
        }
        .voice-modal-header { 
            padding: 15px 20px; 
            background: #fff; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e0e0e0;
        }
        .voice-modal-header-left { display: flex; align-items: center; gap: 10px; }
        .voice-modal-header-right { display: flex; gap: 8px; }
        .voice-modal-header-btn { 
            width: 32px; 
            height: 32px; 
            border-radius: 8px; 
            border: none; 
            background: #f0f0f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }
        .voice-modal-header-btn:hover { background: #e0e0e0; }
        .voice-modal-body { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background: #f8f8f8;
        }
        .voice-character-info { 
            text-align: center; 
            margin-bottom: 20px; 
        }
        .voice-character-avatar { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            margin: 0 auto 10px; 
            border: 3px solid #fff; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            object-fit: cover;
        }
        .voice-character-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .voice-character-name { 
            font-size: 20px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 5px; 
        }
        .voice-character-baby { 
            font-size: 14px; 
            color: #666; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
        }
        .voice-section { 
            background: #fffef7; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e8e5d3;
            position: relative;
            transform: rotate(-0.5deg);
        }
        .voice-section:nth-child(even) {
            transform: rotate(0.5deg);
        }
        .voice-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: repeating-linear-gradient(90deg, transparent, transparent 8px, #d4af37 8px, #d4af37 10px);
        }
        .voice-section-label { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 600; 
            margin-bottom: 10px; 
        }
        .voice-section-label.pink { background: #ffebee; color: #c2185b; }
        .voice-section-label.green { background: #e8f5e9; color: #2e7d32; }
        .voice-section-label.blue { background: #e3f2fd; color: #1565c0; }
        .voice-section-content { 
            font-size: 14px; 
            line-height: 1.6; 
            color: #333; 
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        .voice-stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px; }
        .voice-stamp-item { 
            background: #fffef7; 
            border: 2px solid #d4af37; 
            border-style: dashed;
            padding: 15px; 
            position: relative; 
            cursor: pointer; 
            transition: all 0.3s; 
            min-height: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: rotate(-1deg);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(212, 175, 55, 0.1) 2px, rgba(212, 175, 55, 0.1) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(212, 175, 55, 0.1) 2px, rgba(212, 175, 55, 0.1) 4px);
        }
        .voice-stamp-item::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            border: 2px solid #d4af37;
            border-radius: 50%;
            background: radial-gradient(circle, #fffef7 30%, transparent 30%);
            box-shadow: inset 0 0 0 2px #fffef7;
        }
        .voice-stamp-item::after {
            content: '邮';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #d4af37;
        }
        .voice-stamp-item:nth-child(even) {
            transform: rotate(1deg);
        }
        .voice-stamp-item:hover { transform: translateY(-3px) rotate(0deg) scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        .voice-stamp-item.selected { border-color: #4a90e2; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3); }
        .voice-stamp-item .stamp-checkbox { position: absolute; top: 8px; right: 8px; width: 22px; height: 22px; border: 2px solid #999; border-radius: 50%; display: none; background: #fff; }
        .voice-stamp-item.selected .stamp-checkbox { display: flex; align-items: center; justify-content: center; background: #4a90e2; border-color: #4a90e2; }
        .voice-stamp-item.selected .stamp-checkbox::after { content: '✓'; color: white; font-size: 14px; font-weight: bold; }
        .voice-stamp-content { font-size: 11px; line-height: 1.5; color: #333; margin-bottom: 10px; min-height: 80px; }
        .voice-stamp-time { font-size: 9px; color: #666; position: absolute; bottom: 8px; left: 12px; font-family: monospace; }
        .voice-stamp-actions { position: absolute; bottom: 8px; right: 8px; display: flex; gap: 4px; }
        .voice-stamp-actions button { width: 26px; height: 26px; border-radius: 4px; border: 1px solid #ddd; background: #fff; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .voice-stamp-actions button:hover { background: #f0f0f0; }
        .voice-stamp-actions .btn-edit { color: #4a90e2; border-color: #4a90e2; }
        .voice-stamp-actions .btn-delete { color: #e74c3c; border-color: #e74c3c; }
        .voice-edit-form { background: #fff; border: 2px dashed #999; border-radius: 4px; padding: 15px; margin-top: 15px; }
        .voice-edit-form textarea { width: 100%; background: #fafafa; border: 1px solid #ddd; border-radius: 4px; padding: 10px; color: #333; font-size: 12px; min-height: 120px; resize: vertical; font-family: inherit; }
        .voice-edit-form .form-actions { display: flex; gap: 10px; margin-top: 10px; }
        .voice-modal-footer { padding: 12px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .voice-modal-footer .footer-left { display: flex; gap: 10px; }
        .voice-modal-footer .footer-right { display: flex; gap: 10px; }
        
        /* Toast */
        #toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 14px 28px; border-radius: 30px; font-size: 16px; font-weight: 700; z-index: 999999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; box-shadow: 0 8px 30px rgba(0,0,0,0.6); display: flex; align-items: center; gap: 10px; border: 2px solid rgba(255,255,255,0.2); }
        
        /* Global Notification Modal */
        #global-notification-modal { position: fixed; top: 10px; left: 10px; right: 10px; background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 16px; padding: 15px; z-index: 99999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideDownNotify 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideDownNotify { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notify-content { display: flex; align-items: center; gap: 12px; }
        .notify-avatar { width: 40px; height: 40px; border-radius: 8px; overflow: hidden; flex-shrink: 0; background: #333; }
        .notify-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .notify-text { flex: 1; min-width: 0; }
        .notify-name { font-weight: bold; font-size: 14px; margin-bottom: 2px; }
        .notify-msg { font-size: 12px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Emoji Panel */
        #emoji-panel { background: #222; border-top: 1px solid #333; height: 180px; overflow-y: auto; display: none; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 10px; margin-top: 10px; border-radius: 8px; }
        .emoji-btn { width: 100%; aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: #333; cursor: pointer; }
        .emoji-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* Multi-select Bar */
        #multiselect-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; display: none; align-items: center; justify-content: space-around; background: #1f1f1f; border-top: 1px solid #333; z-index: 100; }
        .multiselect-mode #multiselect-bar { display: flex; }
        
        /* Settings Emoji Grid */
        .emoji-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-height: 250px; overflow-y: auto; }
        .emoji-item { background: #333; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid #444; display: flex; flex-direction: column; }
        .emoji-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
        .emoji-btn { display: flex; flex-direction: column; align-items: center; width: 100%; cursor: pointer; }
        
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } } .animate-heartbeat { animation: heartbeat 1.5s infinite; }
        
        .weather-icon { font-size: 36px; margin-bottom: 5px; }
        
        /* Recall Viewer */
        #modal-recall-view .modal-box { text-align: center; }
    </style>
    <style id="user-custom-css"></style>
</head>
<body class="h-screen w-screen flex flex-col relative text-shadow-sm" onclick="WeChatUI.hideContextMenu()">

    <!-- Wallpaper -->
    <div id="wallpaper-layer"></div>

    <!-- Status Bar -->
    <div id="status-bar" class="w-full h-8 flex justify-between items-center px-6 text-xs font-bold tracking-wide pt-2 z-[999] fixed top-0 left-0 text-white drop-shadow-md pointer-events-none">
        <div id="clock-small">00:00</div>
        <div class="flex items-center gap-3"><i class="fa-solid fa-signal"></i><i class="fa-solid fa-wifi"></i><div class="flex items-center gap-1"><span id="battery-level">--%</span><i id="battery-icon" class="fa-solid fa-battery-three-quarters"></i></div></div>
    </div>
    
    <!-- Global Notification -->
    <div id="global-notification-modal" onclick="WeChatUI.handleNotificationClick()">
        <div class="notify-content">
            <div class="notify-avatar"><img id="notify-avatar-img" src=""></div>
            <div class="notify-text">
                <div class="notify-name" id="notify-title">Title</div>
                <div class="notify-msg" id="notify-body">Message content...</div>
            </div>
            <div class="text-xs text-gray-400">现在</div>
        </div>
    </div>

    <!-- Generic Prompt Modal -->
    <div id="modal-prompt" class="modal-overlay hidden">
        <div class="modal-box">
            <h3 id="prompt-title" class="font-bold mb-4">输入</h3>
            <input type="text" id="prompt-input" class="setting-input mb-4" placeholder="请输入内容">
            <div class="flex gap-2">
                <button onclick="Utils.cancelPrompt()" class="setting-btn secondary flex-1">取消</button>
                <button onclick="Utils.confirmPrompt()" class="setting-btn flex-1">确定</button>
            </div>
        </div>
    </div>

    <!-- Desktop -->
    <main id="desktop" class="flex-1 w-full h-full z-10 pt-8">
        <div class="app-pages-container" id="app-swiper">
            <!-- Page 1 -->
            <div class="app-page">
                <div class="col-span-4 glass-panel rounded-[24px] p-6 flex flex-col justify-center items-start h-40 relative overflow-hidden group"><div class="absolute -right-6 -top-6 opacity-10 text-[9rem] text-gray-800"><i class="fa-regular fa-clock"></i></div><div id="clock-large" class="text-6xl font-thin tracking-tighter text-gray-800 drop-shadow-sm">12:00</div><div id="date-large" class="text-lg text-blue-600 mt-2 pl-1 font-medium tracking-widest uppercase">2024年1月1日 星期一</div></div>
                <div onclick="openApp('settings'); SettingsUI.openPage('weather', '天气设置')" class="col-span-2 glass-panel rounded-[24px] p-5 flex flex-col justify-between h-32 relative overflow-hidden cursor-pointer"><div class="flex justify-between items-start"><i class="fa-solid fa-location-dot text-xl text-blue-600"></i><span class="text-[10px] bg-blue-500/30 px-2 py-1 rounded-full text-blue-50 backdrop-blur-md border border-blue-400/20">映射</span></div><div><div class="text-sm text-blue-600">当前位置</div><div class="text-xl font-bold truncate text-gray-800" id="desktop-location-text">虚拟城市</div></div></div>
                <div class="col-span-2 glass-panel rounded-[24px] p-5 flex flex-col justify-between h-32 relative overflow-hidden"><div class="absolute -right-4 -bottom-4 text-7xl opacity-20 text-yellow-500" id="desktop-weather-bg-icon"><i class="fa-solid fa-sun"></i></div><div class="text-right text-4xl font-light text-gray-800 flex flex-col items-end"><i class="fa-solid fa-sun weather-icon text-yellow-500" id="desktop-weather-icon"></i><span id="desktop-temp">24°</span></div><div><div class="text-sm text-blue-600" id="desktop-weather-desc">晴朗</div><div class="text-xs text-blue-400">AQI 35</div></div></div>
                <!-- Apps -->
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('wechat')"><div id="icon-wechat" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path><path d="M17 11a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2z"></path></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">微信</span></div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('worldbook')"><div id="icon-worldbook" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">世界书</span></div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('search')"><div id="icon-search" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">查手机</span></div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('weibo')"><div id="icon-weibo" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">微博</span></div>
            </div>
            <!-- Page 2 -->
            <div class="app-page">
                <!-- Empty rows for spacing - increased height for more top space -->
                <div class="col-span-4 h-60"></div>
                
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('settings')"><div id="icon-settings" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">设置</span></div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('couple')"><div id="icon-couple" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f472b6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">情侣空间</span></div>
                <div class="col-span-1 flex flex-col items-center gap-2 cursor-pointer app-icon-wrapper group" onclick="openApp('games')"><div id="icon-games" class="w-[50px] h-[50px] rounded-xl flex items-center justify-center shadow-lg glass-icon group-active:scale-90"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12"></rect><path d="M12 12v8"></path><path d="M8 12l4 4 4-4"></path><path d="M12 4v8"></path></svg></div><span class="text-xs text-gray-800 font-medium drop-shadow-sm tracking-wide">小游戏</span></div>
                <div class="col-span-1"></div>
                
                <div class="col-span-2 glass-panel rounded-[24px] overflow-hidden relative aspect-square"><div class="absolute inset-0 flex flex-col items-center justify-center opacity-50 pointer-events-none"><i class="fa-regular fa-image text-3xl mb-2"></i><span class="text-xs">组件 1</span></div><div id="widget-img-card1" class="absolute inset-0 w-full h-full pointer-events-none"></div></div>
                <div class="col-span-2 glass-panel rounded-[24px] overflow-hidden relative aspect-square"><div class="absolute inset-0 flex flex-col items-center justify-center opacity-50 pointer-events-none"><i class="fa-regular fa-star text-3xl mb-2"></i><span class="text-xs">组件 2</span></div><div id="widget-img-card2" class="absolute inset-0 w-full h-full pointer-events-none"></div></div>
            </div>
        </div>
        <div class="fixed bottom-8 left-0 w-full flex justify-center gap-2 pointer-events-none"><div id="dot-1" class="w-1.5 h-1.5 rounded-full bg-white shadow-lg transition-all"></div><div id="dot-2" class="w-1.5 h-1.5 rounded-full bg-white/20 transition-all"></div></div>
    </main>

    <!-- Worldbook App -->
    <div id="app-worldbook" class="app-window text-gray-800">
        <div class="app-header bg-white/95 backdrop-blur-xl border-b border-gray-200 justify-between">
            <button onclick="closeApp()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="font-bold text-lg tracking-wide text-green-600">世界书管理</div>
            <div class="flex gap-2">
                <button onclick="WorldbookUI.showCategoryManager()" class="w-8 h-8 flex items-center justify-center rounded-full bg-purple-100 text-purple-600" title="管理分类"><i class="fa-solid fa-tags"></i></button>
                <button onclick="WorldbookUI.showGroupManager()" class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600" title="管理分组"><i class="fa-solid fa-layer-group"></i></button>
                <button onclick="WorldbookUI.createNewBook()" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-100 text-blue-600"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>
        <div class="app-content p-4">
            <!-- Filter Bar -->
            <div class="flex gap-2 mb-4">
                <select id="wb-category-filter" class="setting-input mb-0 flex-1 text-sm" onchange="WorldbookUI.renderList()">
                    <option value="">所有分类</option>
                </select>
                <select id="wb-group-filter" class="setting-input mb-0 flex-1 text-sm" onchange="WorldbookUI.renderList()">
                    <option value="">所有分组</option>
                </select>
            </div>
            <!-- Book List -->
            <div id="wb-list-container">
                <!-- Book List -->
            </div>
        </div>
        
        <!-- Edit View (Overlay) -->
        <div id="wb-edit-view" class="fixed inset-0 bg-white z-50 hidden flex-col">
             <div class="app-header bg-white/95 border-b border-gray-200 justify-between">
                <button onclick="WorldbookUI.closeEdit()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                <input type="text" id="wb-edit-name" class="bg-transparent font-bold text-lg text-center outline-none text-gray-800" placeholder="世界书名称">
                <button onclick="WorldbookUI.addEntry()" class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <!-- Category and Group Selection -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">分类</label>
                        <select id="wb-edit-category" class="setting-input mb-0 text-sm">
                            <option value="">无分类</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">分组</label>
                        <select id="wb-edit-group" class="setting-input mb-0 text-sm">
                            <option value="">无分组</option>
                        </select>
                    </div>
                </div>
                <!-- Entries -->
                <div class="space-y-4" id="wb-entry-list">
                    <!-- Entries -->
                </div>
            </div>
        </div>
        
        <!-- Category Manager Modal -->
        <div id="wb-category-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">管理分类</h3>
                    <button onclick="WorldbookUI.hideCategoryManager()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-800 text-white/80"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="wb-new-category-name" class="setting-input mb-0 flex-1" placeholder="新分类名称">
                    <button onclick="WorldbookUI.addCategory()" class="setting-btn secondary w-auto whitespace-nowrap">添加</button>
                </div>
                <div id="wb-category-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Category List -->
                </div>
            </div>
        </div>
        
        <!-- Group Manager Modal -->
        <div id="wb-group-modal" class="modal-overlay hidden">
            <div class="modal-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">管理分组</h3>
                    <button onclick="WorldbookUI.hideGroupManager()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-800 text-white/80"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="wb-new-group-name" class="setting-input mb-0 flex-1" placeholder="新分组名称">
                    <button onclick="WorldbookUI.addGroup()" class="setting-btn secondary w-auto whitespace-nowrap">添加</button>
                </div>
                <div id="wb-group-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Group List -->
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS APP (Full) -->
    <div id="app-settings" class="app-window text-gray-800">
        <div class="app-header"><button onclick="SettingsUI.handleBack()" class="w-10 h-10 flex items-center justify-center rounded-full active:bg-gray-100 text-gray-600"><i class="fa-solid fa-chevron-left text-lg"></i></button><span id="settings-title" class="ml-2 font-bold text-lg tracking-wider text-gray-800">设置中心</span></div>
        <div class="app-content" id="settings-main-menu">
            <div class="space-y-4">
                <div onclick="SettingsUI.openPage('api', 'API 连接')" class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer"><div class="flex items-center gap-5"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center shadow-lg text-xl text-blue-600"><i class="fa-solid fa-robot"></i></div><div><div class="font-bold text-lg">API 连接</div><div class="text-xs text-blue-400/80 mt-1">OpenAI, 模型管理</div></div></div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i></div>
                <div onclick="SettingsUI.openPage('theme', '个性化')" class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer"><div class="flex items-center gap-5"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-100 to-pink-200 flex items-center justify-center shadow-lg text-xl text-pink-600"><i class="fa-solid fa-wand-magic-sparkles"></i></div><div><div class="font-bold text-lg">个性化</div><div class="text-xs text-pink-400/80 mt-1">壁纸, 图标, 桌面组件</div></div></div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i></div>
                <div onclick="SettingsUI.openPage('tts', '语音服务')" class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer"><div class="flex items-center gap-5"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center shadow-lg text-xl text-green-600"><i class="fa-solid fa-microphone-lines"></i></div><div><div class="font-bold text-lg">语音服务</div><div class="text-xs text-green-400/80 mt-1">TTS, MiniMax</div></div></div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i></div>
                <div onclick="SettingsUI.openPage('weather', '天气设置')" class="glass-panel p-5 rounded-[20px] flex items-center justify-between active:scale-[0.98] transition-all cursor-pointer"><div class="flex items-center gap-5"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center shadow-lg text-xl text-yellow-600"><i class="fa-solid fa-cloud-sun"></i></div><div><div class="font-bold text-lg">天气与地点</div><div class="text-xs text-yellow-400/80 mt-1">位置映射, 虚拟城市</div></div></div><i class="fa-solid fa-chevron-right text-xs opacity-50"></i></div>
            </div>
        </div>
        
        <!-- API Page -->
        <div class="app-content hidden" id="settings-page-api">
            <h3 class="section-title">配置文件</h3><div class="glass-panel p-1 rounded-2xl mb-6"><select id="api-config-select" class="w-full bg-transparent border-none text-green-600 p-3 outline-none text-sm" onchange="SettingsLogic.loadAPIConfig(this.value)"><option value="default">默认配置</option></select></div>
            <h3 class="section-title">接口详情</h3><div class="space-y-3"><input type="text" id="api-name" placeholder="配置名称 (如: GPT-4)" class="setting-input"><input type="text" id="api-url" placeholder="接口地址 (https://api.openai.com/v1)" class="setting-input"><input type="password" id="api-key" placeholder="API Key (sk-...)" class="setting-input"><div class="flex gap-2"><input type="text" id="api-model" placeholder="模型ID (自动拉取或手填)" class="setting-input flex-1 mb-0 font-mono text-xs"><button onclick="SettingsLogic.fetchModels()" class="setting-btn secondary w-auto whitespace-nowrap"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> 拉取</button></div><select id="api-model-select" class="setting-input hidden transition-all border-blue-400/50 bg-blue-900/40 text-blue-100" onchange="document.getElementById('api-model').value = this.value"><option value="" disabled selected>▼ 选择模型</option></select></div>
            <h3 class="section-title flex justify-between"><span>思维活跃度 (Temp)</span><span id="temp-display" class="text-blue-600">0.7</span></h3><div class="glass-panel p-4 rounded-2xl mb-6"><input type="range" id="api-temp" min="0" max="2" step="0.1" value="0.7" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="document.getElementById('temp-display').textContent=this.value"></div>
            <div class="grid grid-cols-2 gap-3 mt-8"><button onclick="SettingsLogic.saveAPI()" class="setting-btn col-span-2 shadow-lg shadow-blue-500/20">保存配置</button><button onclick="SettingsLogic.createNewAPI()" class="setting-btn secondary">新建配置</button><button onclick="SettingsLogic.deleteAPI()" class="setting-btn danger">删除配置</button><button onclick="Utils.showToast('测试提醒成功！')" class="setting-btn secondary col-span-2">测试提醒</button></div>
        </div>

        <!-- Theme Page -->
        <div class="app-content hidden" id="settings-page-theme">
            <h3 class="section-title">壁纸</h3><div class="glass-panel rounded-xl p-2 mb-3"><div id="wallpaper-preview-box" class="w-full h-32 rounded-lg bg-gray-800/50 flex items-center justify-center overflow-hidden relative border border-white/10"><span class="text-xs text-white/30 absolute">预览</span></div></div><div class="space-y-2"><div class="url-input-group"><input type="text" id="wallpaper-url-input" placeholder="壁纸 URL..." class="setting-input"><button class="setting-btn secondary" onclick="ThemeLogic.applyUrl('wallpaper')"><i class="fa-solid fa-check"></i></button></div><div class="grid grid-cols-2 gap-3"><button class="setting-btn secondary text-xs py-3" onclick="document.getElementById('upload-wallpaper').click()"><i class="fa-solid fa-upload"></i> 本地</button><button class="setting-btn secondary text-xs py-3" onclick="ThemeLogic.resetWallpaper()"><i class="fa-solid fa-rotate-left"></i> 默认</button></div></div><input type="file" id="upload-wallpaper" accept="image/*" class="hidden" onchange="ThemeLogic.handleImageUpload('wallpaper', this)">
            <h3 class="section-title">图标</h3><div class="glass-panel p-3 rounded-2xl mb-2 flex items-center gap-3"><div id="icon-preview-box" class="w-14 h-14 rounded-xl bg-gray-700 shadow-inner flex items-center justify-center overflow-hidden shrink-0 border border-white/20"></div><div class="flex-1"><select id="icon-selector" class="w-full bg-white/5 border border-white/10 rounded-lg text-white p-2 text-sm outline-none" onchange="ThemeLogic.updateIconPreview()"><option value="icon-wechat">微信</option><option value="icon-worldbook">世界书</option><option value="icon-search">查手机</option><option value="icon-weibo">微博</option><option value="icon-settings">设置</option><option value="icon-couple">情侣空间</option><option value="icon-games">小游戏</option></select></div></div><div class="space-y-2"><div class="url-input-group"><input type="text" id="icon-url-input" placeholder="图标 URL..." class="setting-input"><button class="setting-btn secondary" onclick="ThemeLogic.applyUrl('icon')"><i class="fa-solid fa-check"></i></button></div><button class="setting-btn secondary w-full mb-4" onclick="document.getElementById('upload-icon').click()">本地上传</button></div><input type="file" id="upload-icon" accept="image/*" class="hidden" onchange="ThemeLogic.handleImageUpload('icon', this)">
            <h3 class="section-title">组件</h3><div class="grid grid-cols-2 gap-4 mb-4"><div class="space-y-2"><div class="text-xs text-center opacity-70">组件 1</div><div id="widget1-preview-box" class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20"></div><input type="text" id="widget1-url-input" placeholder="图片 URL..." class="setting-input text-xs"><div class="grid grid-cols-2 gap-1"><button class="setting-btn secondary text-xs px-1" onclick="ThemeLogic.applyUrl('card1')">应用</button><button class="setting-btn secondary text-xs px-1" onclick="ThemeLogic.triggerWidgetUpload('card1')">上传</button></div></div><div class="space-y-2"><div class="text-xs text-center opacity-70">组件 2</div><div id="widget2-preview-box" class="w-full aspect-square rounded-xl bg-gray-700 overflow-hidden border border-white/20"></div><input type="text" id="widget2-url-input" placeholder="图片 URL..." class="setting-input text-xs"><div class="grid grid-cols-2 gap-1"><button class="setting-btn secondary text-xs px-1" onclick="ThemeLogic.applyUrl('card2')">应用</button><button class="setting-btn secondary text-xs px-1" onclick="ThemeLogic.triggerWidgetUpload('card2')">上传</button></div></div></div><input type="file" id="upload-widget" accept="image/*" class="hidden" onchange="ThemeLogic.handleWidgetUpload(this)">
            <h3 class="section-title">全局字体设置</h3>
            <div class="glass-panel p-4 rounded-2xl mb-4">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">字体颜色</label>
                        <input type="color" id="font-color" value="#166534" class="w-full h-10 rounded-lg cursor-pointer">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">字体阴影</label>
                        <input type="text" id="font-shadow" placeholder="例如: 0 2px 4px rgba(0,0,0,0.3)" class="setting-input">
                    </div>
                    <div class="url-input-group">
                        <input type="text" id="font-url" placeholder="字体 URL..." class="setting-input">
                        <button class="setting-btn secondary" onclick="ThemeLogic.applyFontUrl()"><i class="fa-solid fa-check"></i></button>
                    </div>
                    <button class="setting-btn secondary text-xs w-full" onclick="ThemeLogic.restoreDefaultFont()">恢复默认字体</button>
                </div>
            </div>
            
            <h3 class="section-title">全局背景美化</h3>
            <div class="glass-panel rounded-xl p-2 mb-3">
                <div id="global-bg-preview-box" class="w-full h-32 rounded-lg bg-gray-800/50 flex items-center justify-center overflow-hidden relative border border-white/10">
                    <span class="text-xs text-white/30 absolute">预览</span>
                </div>
            </div>
            <div class="space-y-2">
                <div class="url-input-group">
                    <input type="text" id="global-bg-url-input" placeholder="全局背景 URL..." class="setting-input">
                    <button class="setting-btn secondary" onclick="ThemeLogic.applyGlobalBgUrl()"><i class="fa-solid fa-check"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button class="setting-btn secondary text-xs py-3" onclick="document.getElementById('upload-global-bg').click()"><i class="fa-solid fa-upload"></i> 本地</button>
                    <button class="setting-btn secondary text-xs py-3" onclick="ThemeLogic.resetGlobalBg()"><i class="fa-solid fa-rotate-left"></i> 默认</button>
                </div>
            </div>
            <input type="file" id="upload-global-bg" accept="image/*" class="hidden" onchange="ThemeLogic.handleGlobalBgUpload(this)">
            
            <h3 class="section-title">美化预设管理</h3>
            <div class="glass-panel p-4 rounded-2xl mb-4">
                <div class="flex gap-2 mb-3">
                    <input type="text" id="preset-name" placeholder="预设名称" class="setting-input flex-1">
                    <button class="setting-btn" onclick="ThemeLogic.savePreset()">保存预设</button>
                </div>
                <div class="mb-3">
                    <select id="preset-select" class="setting-input" onchange="ThemeLogic.loadPreset(this.value)">
                        <option value="">选择预设...</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button class="setting-btn secondary flex-1" onclick="ThemeLogic.deletePreset()">删除预设</button>
                    <button class="setting-btn secondary flex-1" onclick="ThemeLogic.resetAll()">重置全局美化</button>
                </div>
            </div>
            
            <h3 class="section-title">CSS</h3>
            <textarea id="theme-css" placeholder="自定义 CSS..." class="setting-input h-20 font-mono text-xs"></textarea>
            <div class="flex gap-2 mb-4">
                <button class="setting-btn flex-1" onclick="ThemeLogic.saveTheme()">保存美化</button>
                <button class="setting-btn secondary flex-1" onclick="ThemeLogic.restoreDefaultCSS()">恢复默认CSS</button>
            </div>
        </div>
        
        <!-- TTS Page -->
        <div class="app-content hidden" id="settings-page-tts"><h3 class="section-title">语音引擎</h3><div class="glass-panel p-4 rounded-2xl mb-6"><select id="tts-engine" class="bg-blue-900/40 border border-blue-500/30 text-white p-2 rounded-lg outline-none text-sm w-full" onchange="SettingsLogic.toggleTTSSettings()"><option value="browser">本地 Browser TTS</option><option value="minimax">MiniMax 云端语音</option></select><button onclick="SettingsLogic.testTTS()" class="setting-btn secondary text-xs w-full mt-4">测试发音</button></div><div id="minimax-settings" class="space-y-3 hidden"><h3 class="section-title">MiniMax 参数</h3><input type="text" id="minimax-group-id" placeholder="Group ID" class="setting-input"><input type="password" id="minimax-api-key" placeholder="API Key" class="setting-input"><h3 class="section-title">模型与音色</h3><div class="flex gap-2"><input type="text" id="minimax-model-id" placeholder="Model ID" class="setting-input flex-1 mb-0"><button onclick="SettingsLogic.fetchMinimaxModels()" class="setting-btn secondary w-auto"><i class="fa-solid fa-cloud-arrow-down"></i></button></div><select id="minimax-model-select" class="setting-input hidden" onchange="document.getElementById('minimax-model-id').value = this.value"><option value="" disabled selected>▼ 选择模型</option></select><h3 class="section-title">音色 ID</h3><input type="text" id="minimax-voice-id" placeholder="Voice ID (例: male-qn-qingse)" class="setting-input"></div><button onclick="SettingsLogic.saveTTS()" class="setting-btn w-full mt-8 shadow-lg">保存设置</button></div>
        
        <!-- Weather Page -->
        <div class="app-content hidden" id="settings-page-weather">
            <h3 class="section-title">地点设置</h3>
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-400">桌面显示的虚拟地点</label>
                    <input type="text" id="weather-virtual-loc" placeholder="例如：哥谭市" class="setting-input">
                </div>
                <div>
                    <label class="text-xs text-gray-400">映射的真实地点 (获取天气用)</label>
                    <input type="text" id="weather-real-loc" placeholder="例如：New York" class="setting-input">
                    <p class="text-[10px] text-gray-500 mt-1">* 请输入真实的城市英文名或拼音，以便准确获取天气</p>
                </div>
                <button onclick="WeatherLogic.saveWeatherConfig()" class="setting-btn mt-4">保存并更新天气</button>
            </div>
        </div>

        <!-- Worldbook Page (NEW) -->
    </div>

    <!-- WECHAT APP (Enhanced) -->
    <div id="app-wechat" class="app-window bg-[#f0fdf4]">
        <div class="app-header justify-between bg-white/95 backdrop-blur-xl border-b border-green-200">
            <button onclick="closeApp()" class="w-8 h-8 flex items-center justify-center rounded-full bg-green-100 text-green-600"><i class="fa-solid fa-xmark"></i></button>
            <div class="font-bold text-lg tracking-wide text-gray-800" id="wechat-header-title">微信</div>
            <div class="flex gap-4 text-xl text-gray-600"><button onclick="WeChatUI.openAddMenu()"><i class="fa-solid fa-circle-plus"></i></button></div>
            <div id="wechat-add-menu" class="absolute top-14 right-2 w-40 bg-white rounded-lg shadow-xl hidden z-[100] border border-green-200"><div onclick="WeChatUI.startCreateChar()" class="p-3 border-b border-green-100 flex items-center gap-3 text-sm text-gray-800 active:bg-green-50"><i class="fa-solid fa-user-plus text-green-500"></i> 创建角色</div></div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-[#f0fdf4]">
            <div id="tab-chat" class="w-full overflow-y-auto pb-4" style="height: calc(100% - 50px); background-color: var(--app-bg-color);"></div>
            <div id="tab-contacts" class="w-full overflow-y-auto hidden" style="height: calc(100% - 50px); background-color: var(--app-bg-color);"><div class="p-2"><div class="bg-green-100 p-3 rounded-lg flex items-center gap-3 mb-2" onclick="WeChatUI.startCreateChar()"><div class="w-10 h-10 bg-green-500 rounded-md flex items-center justify-center"><i class="fa-solid fa-user-plus text-white"></i></div><span class="text-gray-800">创建虚拟角色</span></div><div id="contacts-list-container"></div></div></div>
            <div id="tab-discovery" class="w-full overflow-y-auto hidden" style="height: calc(100% - 50px); background-color: var(--app-bg-color);"><div onclick="WeChatUI.openSubPage('subpage-moments')" class="flex items-center justify-between p-4 border-b border-green-200 bg-white/90 mt-2 cursor-pointer"><div class="flex items-center gap-3"><i class="fa-solid fa-spinner text-green-500 text-xl"></i><span class="text-gray-800">朋友圈</span></div><i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i></div></div>
            <div id="tab-me" class="w-full overflow-y-auto hidden" style="height: calc(100% - 50px); background-color: var(--app-bg-color);">
                <!-- 个人信息区域 -->
                <div class="p-6 bg-white/90 flex items-center gap-4 mb-2">
                    <div class="w-16 h-16 rounded-lg bg-gray-700 overflow-hidden cursor-pointer" onclick="WeChatUI.openAvatarUpload()">
                        <img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=User" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div id="user-name" class="text-xl font-bold cursor-pointer" onclick="WeChatUI.editUserName()">我</div>
                        <div class="text-xs text-gray-400 mt-1">微信号: admin</div>
                    </div>
                </div>
                
                <!-- 钱包功能 -->
                <div class="p-4 bg-[#191919] rounded-lg mx-4 mb-4 cursor-pointer" onclick="WeChatUI.openWallet()">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center text-white">
                                <i class="fa-solid fa-wallet text-xl"></i>
                            </div>
                            <div>
                                <div class="font-medium">钱包</div>
                                <div class="text-xs text-gray-400">管理你的余额和交易</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-500"></i>
                    </div>
                </div>
            </div>
            
            <!-- 钱包页面 -->
            <div id="subpage-wallet" class="sub-view bg-[#000]">
                <div class="app-header justify-between bg-white/95 border-b border-gray-200">
                    <button onclick="WeChatUI.closeSubPage('subpage-wallet')" class="w-10 h-full"><i class="fa-solid fa-chevron-left"></i></button>
                    <span class="font-bold">钱包</span>
                    <div class="w-10"></div>
                </div>
                <div class="app-content p-4">
                    <!-- 余额显示 -->
                    <div class="bg-[#191919] rounded-lg p-6 mb-6 text-center">
                        <div class="text-sm text-gray-400 mb-2">当前余额</div>
                        <div class="text-4xl font-bold text-green-500 mb-4" id="wallet-balance">¥0.00</div>
                        <button onclick="WeChatUI.openRechargeModal()" class="bg-green-500 text-white px-6 py-2 rounded-full font-medium">充值</button>
                    </div>
                    
                    <!-- 交易记录 -->
                    <div>
                        <div class="font-medium text-lg mb-4">交易记录</div>
                        <div id="transaction-list" class="space-y-3">
                            <!-- 交易记录将动态生成 -->
                            <div class="text-center text-gray-500 text-sm py-8">暂无交易记录</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 头像上传模态框 -->
            <div id="modal-avatar-upload" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">修改头像</h3>
                    <div class="space-y-3">
                        <button onclick="document.getElementById('avatar-file-input').click()" class="setting-btn w-full">
                            <i class="fa-solid fa-upload mr-2"></i>从相册选择
                        </button>
                        <button onclick="WeChatUI.generateRandomAvatar()" class="setting-btn secondary w-full">
                            <i class="fa-solid fa-magic mr-2"></i>随机生成
                        </button>
                        <button onclick="document.getElementById('modal-avatar-upload').classList.add('hidden')" class="setting-btn secondary w-full">
                            <i class="fa-solid fa-xmark mr-2"></i>取消
                        </button>
                    </div>
                    <input type="file" id="avatar-file-input" class="hidden" accept="image/*" onchange="WeChatUI.handleAvatarUpload(this)">
                </div>
            </div>
            
            <!-- 充值模态框 -->
            <div id="modal-recharge" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">充值</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">充值金额</label>
                            <input type="number" id="recharge-amount" placeholder="请输入充值金额" class="setting-input" min="0.01" step="0.01" value="100">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="document.getElementById('recharge-amount').value = '10'" class="setting-btn secondary">¥10</button>
                            <button onclick="document.getElementById('recharge-amount').value = '50'" class="setting-btn secondary">¥50</button>
                            <button onclick="document.getElementById('recharge-amount').value = '100'" class="setting-btn secondary">¥100</button>
                            <button onclick="document.getElementById('recharge-amount').value = '200'" class="setting-btn secondary">¥200</button>
                            <button onclick="document.getElementById('recharge-amount').value = '500'" class="setting-btn secondary">¥500</button>
                            <button onclick="document.getElementById('recharge-amount').value = '1000'" class="setting-btn secondary">¥1000</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="document.getElementById('modal-recharge').classList.add('hidden')" class="setting-btn secondary">取消</button>
                            <button onclick="WeChatUI.confirmRecharge()" class="setting-btn">确认充值</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 修改用户名模态框 -->
            <div id="modal-edit-username" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3 class="font-bold mb-4">修改用户名</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">新用户名</label>
                            <input type="text" id="edit-username-input" placeholder="请输入新的用户名" class="setting-input">
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="WeChatUI.cancelEditUsername()" class="setting-btn secondary">取消</button>
                            <button onclick="WeChatUI.confirmEditUsername()" class="setting-btn">确认</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="glass-bar h-14 flex w-full pb-2 pt-1 z-50">
            <div onclick="WeChatUI.switchTab('chat')" id="btn-tab-chat" class="wechat-tab-btn active"><i class="fa-regular fa-comment"></i><span>微信</span></div>
            <div onclick="WeChatUI.switchTab('contacts')" id="btn-tab-contacts" class="wechat-tab-btn"><i class="fa-regular fa-address-book"></i><span>通讯录</span></div>
            <div onclick="WeChatUI.switchTab('discovery')" id="btn-tab-discovery" class="wechat-tab-btn"><i class="fa-regular fa-compass"></i><span>发现</span></div>
            <div onclick="WeChatUI.switchTab('me')" id="btn-tab-me" class="wechat-tab-btn"><i class="fa-regular fa-user"></i><span>我</span></div>
        </div>

        <!-- Chat Detail -->
        <div id="subpage-chat-detail" class="sub-view bg-[#f8fafc]">
            <div class="app-header justify-between bg-white/95 border-b border-gray-200">
                <button onclick="WeChatUI.closeSubPage('subpage-chat-detail')" class="w-10 h-full"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="flex flex-col items-center"><span class="font-bold text-gray-800" id="chat-title">AI</span><span class="text-[10px] text-green-500" id="chat-online-status">在线</span></div>
                <div class="flex items-center gap-3 pr-2">
                    <button onclick="InnerVoiceUI.openModal()" class="w-8 h-8 rounded-full bg-pink-500/20 text-pink-500 flex items-center justify-center animate-heartbeat text-xs border border-pink-500/30 relative" title="心声"><i class="fa-solid fa-heart"></i></button>
                    <button onclick="WeChatUI.openCharSettings()" class="w-8 h-8"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
            
            <!-- Inner Voice Modal -->
            <div id="inner-voice-modal" onclick="if(event.target.id === 'inner-voice-modal') InnerVoiceUI.closeModal()">
                <div class="voice-modal-content" onclick="event.stopPropagation()">
                    <div class="voice-modal-header">
                        <div class="voice-modal-header-left">
                            <button onclick="InnerVoiceUI.closeModal()" class="voice-modal-header-btn" style="color: #e74c3c;"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="voice-modal-header-right">
                            <button onclick="InnerVoiceUI.toggleEditMode()" class="voice-modal-header-btn" id="voice-edit-btn" title="编辑"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="InnerVoiceUI.openBgUpload()" class="voice-modal-header-btn" title="背景图"><i class="fa-solid fa-image"></i></button>
                            <button onclick="InnerVoiceUI.toggleManageMode()" class="voice-modal-header-btn" id="voice-manage-btn" title="管理"><i class="fa-solid fa-list"></i></button>
                            <button onclick="InnerVoiceUI.showHistory()" class="voice-modal-header-btn" title="历史"><i class="fa-solid fa-clock"></i></button>
                        </div>
                    </div>
                    <div class="voice-modal-body">
                        <!-- Character Info View -->
                        <div id="voice-character-view">
                            <div class="voice-character-info">
                                <img id="voice-character-avatar" class="voice-character-avatar" src="" alt="角色头像">
                                <div class="voice-character-name" id="voice-character-name">角色名称</div>
                                <div class="voice-character-baby">
                                    <img id="voice-baby-avatar" src="" alt="宝贝" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; overflow: hidden;">
                                    <span>宝贝: <span id="voice-baby-name">-</span></span>
                                </div>
                            </div>
                            <div class="voice-section">
                                <div class="voice-section-label pink">服装</div>
                                <div class="voice-section-content" id="voice-outfit-content">-</div>
                            </div>
                            <div class="voice-section">
                                <div class="voice-section-label" style="background: #fff3e0; color: #e65100;">环境</div>
                                <div class="voice-section-content" id="voice-env-content">-</div>
                            </div>
                            <div class="voice-section">
                                <div class="voice-section-label blue">心声</div>
                                <div class="voice-section-content" id="voice-inner-content">-</div>
                            </div>
                            <div class="voice-section">
                                <div class="voice-section-label green">行为</div>
                                <div class="voice-section-content" id="voice-action-content">-</div>
                            </div>
                        </div>
                        
                        <!-- History/Stamp View -->
                        <div id="voice-history-view" class="hidden">
                            <div id="voice-stamp-container" class="voice-stamp-grid">
                                <!-- Voice stamps will be rendered here -->
                            </div>
                        </div>
                        
                        <!-- Edit Form -->
                        <div id="voice-edit-container" class="hidden">
                            <div class="voice-edit-form">
                                <textarea id="voice-edit-textarea" placeholder="编辑心声内容..."></textarea>
                                <div class="form-actions">
                                    <button onclick="InnerVoiceUI.saveEdit()" class="px-4 py-2 bg-green-500 text-white rounded text-xs">保存</button>
                                    <button onclick="InnerVoiceUI.cancelEdit()" class="px-4 py-2 bg-gray-500 text-white rounded text-xs">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="voice-modal-footer">
                        <div class="footer-left">
                            <button onclick="InnerVoiceUI.selectAll()" class="px-3 py-1 bg-blue-500/30 text-blue-200 rounded text-xs" id="voice-select-all-btn" style="display:none;">全选</button>
                            <button onclick="InnerVoiceUI.deleteSelected()" class="px-3 py-1 bg-red-500/30 text-red-200 rounded text-xs" id="voice-delete-selected-btn" style="display:none;">删除选中</button>
                        </div>
                        <div class="footer-right">
                            <span class="text-xs text-gray-400" id="voice-count">共 0 条</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative flex-1 overflow-hidden">
                <!-- Background Layer -->
                <div id="chat-bg-layer" class="absolute inset-0 bg-cover bg-center z-0 transition-all"></div>
                <!-- Messages -->
                <div class="absolute inset-0 overflow-y-auto p-4 space-y-4 z-10" id="chat-messages-container"></div>
            </div>
            
            <div class="bg-white/90 border-t border-gray-200 p-2 pb-safe relative z-50">
                <!-- Toolbar -->
                <div class="flex gap-6 px-2 pb-3 text-gray-600 text-xl items-center relative">
                    <i class="fa-regular fa-face-smile cursor-pointer hover:text-gray-800" onclick="WeChatUI.showEmojiPicker()"></i>
                    <i class="fa-regular fa-image cursor-pointer hover:text-gray-800" onclick="document.getElementById('chat-img-upload').click()"></i>
                    <i class="fa-solid fa-arrow-right-arrow-left cursor-pointer hover:text-blue-600" onclick="WeChatUI.showTransferModal('transfer')"></i>
                    <i class="fa-solid fa-envelope cursor-pointer hover:text-red-500" onclick="WeChatUI.showTransferModal('redpacket')"></i>
                    <i class="fa-solid fa-microphone cursor-pointer hover:text-green-500" onclick="WeChatUI.toggleVoiceMode()" id="btn-voice-mode"></i>
                    <i class="fa-solid fa-rotate-right cursor-pointer hover:text-blue-500" onclick="WeChatUI.regenerateLastReply()" id="btn-regenerate" title="重新生成"></i>
                </div>
                
                <div class="flex gap-2 items-end">
                    <textarea id="chat-input" class="flex-1 bg-white border border-gray-300 rounded-lg p-2 text-gray-800 text-sm max-h-24 min-h-[40px] focus:ring-0 resize-none" rows="1" placeholder="发送消息..."></textarea>
                    <div class="flex flex-col gap-1">
                        <button onclick="WeChatUI.sendUserMessage(false)" class="bg-gray-700 text-white text-xs px-3 py-2 rounded-lg font-bold">发送</button>
                        <button onclick="WeChatUI.sendUserMessage(true)" class="bg-green-600 text-white text-xs px-3 py-2 rounded-lg font-bold">生成</button>
                    </div>
                </div>
                
                <!-- Emoji Panel -->
                <div id="emoji-panel"></div>
            </div>
            
            <!-- Multi-select Bar -->
            <div id="multiselect-bar">
                <button class="text-gray-400" onclick="WeChatUI.exitMultiSelectMode()"><i class="fa-solid fa-xmark"></i></button>
                <button class="text-red-500" onclick="WeChatUI.deleteSelectedMessages()"><i class="fa-solid fa-trash"></i></button>
            </div>
            
            <input type="file" id="chat-img-upload" class="hidden" onchange="WeChatUI.handleChatImage(this)">
        </div>

        <!-- Create/Edit Char -->
        <div id="subpage-char-settings" class="sub-view bg-white text-gray-800 overflow-y-auto">
            <div class="app-header bg-white/95 border-b border-gray-200 sticky top-0"><button onclick="WeChatUI.closeSubPage('subpage-char-settings')" class="w-10 h-full text-gray-800"><i class="fa-solid fa-chevron-left"></i></button><span class="font-bold text-gray-800" id="char-settings-title">角色设置</span><button onclick="WeChatUI.saveCharacter()" class="ml-auto text-green-600 font-bold text-sm bg-green-100 px-3 py-1 rounded">保存</button></div>
            <div class="p-4 space-y-6">
                <!-- Avatar -->
                <div class="flex items-center gap-4">
                    <div class="w-20 h-20 bg-gray-200 border border-gray-300 flex items-center justify-center overflow-hidden" id="char-avatar-preview"><span class="text-xs text-gray-600">头像</span></div>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="char-name" class="setting-input mb-0" placeholder="角色名字" readonly>
                        <div class="flex gap-2"><button class="setting-btn secondary text-xs py-1" onclick="document.getElementById('char-upload-file').click()">本地上传</button><button class="setting-btn secondary text-xs py-1" onclick="WeChatUI.promptAvatarUrl()">URL上传</button></div>
                        <input type="file" id="char-upload-file" class="hidden" onchange="WeChatUI.handleAvatarFile(this)">
                        <input type="hidden" id="char-avatar-data">
                        <div class="flex items-center gap-2 mt-1"><span class="text-xs text-gray-600">形状:</span><select id="char-avatar-shape" class="bg-white border border-gray-300 text-xs p-1 rounded"><option value="square">方形</option><option value="circle">圆形</option></select></div>
                    </div>
                </div>
                <!-- Persona -->
                <div><h3 class="section-title">我的人设 (User Persona)</h3><input type="text" id="char-user-name" class="setting-input" placeholder="我的名字"><div class="flex items-center gap-2"><div class="w-10 h-10 bg-gray-200 rounded overflow-hidden" id="user-avatar-preview"></div><button class="setting-btn secondary text-xs flex-1" onclick="document.getElementById('user-upload-file').click()">上传我的头像</button><input type="file" id="user-upload-file" class="hidden" onchange="WeChatUI.handleUserAvatarFile(this)"><input type="hidden" id="user-avatar-data"></div></div>
                <div><h3 class="section-title">角色设定</h3><input type="text" id="char-nickname" class="setting-input" placeholder="昵称备注"><textarea id="char-prompt" class="setting-input h-32" placeholder="Prompt..."></textarea></div>
                
                <!-- Worldbook Integration -->
                <div>
                    <h3 class="section-title">关联世界书</h3>
                    <div class="glass-panel p-3 rounded-lg" id="char-worldbook-list">
                        <div class="text-xs text-gray-500 text-center py-2">暂无世界书，请在桌面App中创建</div>
                    </div>
                </div>

                <!-- Time Awareness -->
                <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2"><span class="text-sm text-gray-800">时间感知</span><input type="checkbox" id="char-time-aware" class="toggle-switch"></div>
                <div id="virtual-time-container" class="hidden mb-2"><input type="text" id="char-virtual-time" class="setting-input" placeholder="虚拟时间 (如: 2077年 晚上8点)"></div>

                <!-- Memory -->
                <div><h3 class="section-title">记忆与总结</h3>
                    <div class="grid grid-cols-2 gap-2 text-center mb-3"><div class="glass-panel p-2 rounded-lg"><div class="text-xs text-gray-600">总聊天条数</div><div class="font-mono text-blue-600 text-lg" id="stat-chat-count">0</div></div><div class="glass-panel p-2 rounded-lg"><div class="text-xs text-gray-600">上下文Token</div><div class="font-mono text-purple-600 text-lg" id="stat-token-count">0</div></div></div>
                    <div class="mb-2"><label class="text-xs text-gray-600 ml-1">上下文记忆条数</label><input type="number" id="char-context-limit" class="setting-input mt-1" placeholder="默认 20 条"></div>
                    <div class="mb-2"><label class="text-xs text-gray-600 ml-1">自动总结条数</label><input type="number" id="char-summary-limit" class="setting-input mt-1" placeholder="默认 50 条"></div>
                    <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2"><span class="text-sm text-gray-800">自动总结</span><input type="checkbox" id="char-auto-summary" class="toggle-switch"></div>
                    <textarea id="char-summary-prompt" class="setting-input h-20" placeholder="总结提示词..."></textarea>
                    <div class="flex gap-2"><button class="setting-btn secondary text-xs" onclick="WeChatUI.triggerManualSummary()">手动总结</button><button class="setting-btn secondary text-xs" onclick="WeChatUI.openMemoryLib()">记忆管理库</button></div>
                </div>
                <!-- Chat Export/Import -->
                <div>
                    <h3 class="section-title">聊天记录</h3>
                    <div class="flex gap-2">
                        <button class="setting-btn secondary flex-1 text-xs" onclick="WeChatUI.exportChatHistory()">导出聊天记录</button>
                        <button class="setting-btn secondary flex-1 text-xs" onclick="WeChatUI.importChatHistory()">导入聊天记录</button>
                    </div>
                </div>
                <!-- NPC Binding -->
                <div>
                    <h3 class="section-title flex justify-between">
                        <span>绑定NPC</span>
                        <button onclick="WeChatUI.openNPCManager()" class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fa-solid fa-users mr-1"></i>管理NPC
                        </button>
                    </h3>
                    <div class="glass-panel p-3 rounded-lg mb-2">
                        <div id="npc-binding-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- NPC binding list will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <!-- Emojis -->
                <div>
                    <h3 class="section-title flex justify-between">
                        <span>表情包库</span>
                        <button onclick="WeChatUI.openEmojiCategories()" class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fa-solid fa-tags mr-1"></i>分类
                        </button>
                    </h3>
                    <div class="flex gap-2 mb-2">
                        <select id="emoji-category-select" class="setting-input text-xs flex-1 mb-0" onchange="WeChatUI.filterEmojisByCategory()">
                            <option value="">所有分类</option>
                            <option value="default">默认分类</option>
                        </select>
                        <button class="setting-btn secondary text-xs" onclick="WeChatUI.openEmojiUpload()">上传</button>
                    </div>
                    <div id="emoji-grid" class="emoji-grid mb-2"></div>
                </div>
                
                <!-- Emoji Category Modal -->
                <div id="modal-emoji-categories" class="modal-overlay hidden">
                    <div class="modal-box">
                        <h3 class="font-bold mb-3">表情包分类管理</h3>
                        <div class="mb-3">
                            <input type="text" id="new-category-name" class="setting-input" placeholder="新分类名称">
                            <button onclick="WeChatUI.addEmojiCategory()" class="setting-btn w-full mt-2">添加分类</button>
                        </div>
                        <div id="emoji-categories-list" class="space-y-2 max-h-40 overflow-y-auto mb-3">
                            <!-- Categories will be rendered here -->
                        </div>
                        <button class="setting-btn secondary w-full" onclick="document.getElementById('modal-emoji-categories').classList.add('hidden')">关闭</button>
                    </div>
                </div>
                
                <!-- Voice -->
                <div>
                    <h3 class="section-title">语音 (TTS)</h3>
                    <div class="flex items-center justify-between glass-panel p-3 rounded-lg mb-2">
                        <span class="text-sm">启用 TTS</span>
                        <input type="checkbox" id="char-tts-enabled" class="toggle-switch">
                    </div>
                    <input type="text" id="char-voice-id" class="setting-input" placeholder="角色 Voice ID (MiniMax)">
                    <div class="flex items-center gap-2"><span class="text-xs text-gray-400">语速</span><input type="range" id="char-voice-speed" min="0.5" max="2" step="0.1" value="1.0" class="flex-1 h-1 bg-gray-700 rounded-lg accent-green-500"></div>
                </div>

                <!-- Bubble & Background Style (Enhanced) -->
                <div>
                    <h3 class="section-title">气泡与背景</h3>
                    <div class="relative w-full h-48 rounded-lg overflow-hidden border border-white/10 mb-3 bg-[#111] flex flex-col justify-center p-3" id="preview-chat-container">
                        <div id="preview-chat-bg" class="absolute inset-0 bg-cover bg-center transition-all duration-300 z-0"></div>
                        <div class="msg-row other relative z-10"><div class="msg-avatar square" id="preview-avatar-other"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default50"></div><div class="msg-content"><div class="chat-bubble" id="preview-bubble-other">角色回复的消息<span class="msg-timestamp">12:00</span></div></div></div>
                        <div class="msg-row self relative z-10"><div class="msg-avatar square" id="preview-avatar-self"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default50"></div><div class="msg-content"><div class="chat-bubble" id="preview-bubble-self">我的消息<span class="msg-timestamp">12:01</span></div></div></div>
                    </div>
                    <div class="flex items-center gap-2 mb-2"><span class="text-xs text-gray-400">字体大小</span><input type="range" id="char-bubble-size" min="12" max="30" step="1" value="15" class="flex-1 h-1 bg-gray-700 rounded-lg accent-green-500" oninput="WeChatUI.updateBgPreview()"><span class="text-xs w-6 text-right" id="val-bubble-size">15</span></div>
                    <input type="text" id="char-bubble-css" class="setting-input" placeholder="气泡 CSS (实时预览)" oninput="WeChatUI.updateBgPreview()">
                    <div class="flex gap-2 mb-3"><select id="bubble-preset-select" class="setting-input mb-0 flex-1" onchange="WeChatUI.loadBubblePreset()"><option value="" disabled selected>选择预设...</option></select><button class="setting-btn secondary w-auto text-xs whitespace-nowrap" onclick="WeChatUI.saveBubblePreset()">保存预设</button><button class="setting-btn danger w-auto text-xs whitespace-nowrap" onclick="WeChatUI.deleteBubblePreset()"><i class="fa-solid fa-trash"></i></button></div>
                    <div class="space-y-3 mt-2">
                        <div class="flex gap-2"><input type="text" id="char-chat-bg" class="setting-input mb-0 flex-1" placeholder="背景图 URL" oninput="WeChatUI.updateBgPreview()"><button class="setting-btn secondary w-auto text-xs whitespace-nowrap px-3" onclick="document.getElementById('char-bg-upload').click()">相册</button><input type="file" id="char-bg-upload" class="hidden" onchange="WeChatUI.handleChatBgFile(this)"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><div class="flex justify-between text-xs text-gray-400 mb-1"><span>模糊度</span><span id="val-blur">0px</span></div><input type="range" id="char-bg-blur" min="0" max="20" step="1" value="0" class="w-full h-1 bg-gray-700 rounded-lg accent-blue-500" oninput="WeChatUI.updateBgPreview()"></div>
                            <div><div class="flex justify-between text-xs text-gray-400 mb-1"><span>透明度</span><span id="val-opacity">100%</span></div><input type="range" id="char-bg-opacity" min="0" max="1" step="0.1" value="1" class="w-full h-1 bg-gray-700 rounded-lg accent-blue-500" oninput="WeChatUI.updateBgPreview()"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-create-name" class="modal-overlay hidden"><div class="modal-box text-center"><h3 class="text-lg font-bold mb-4">创建新角色</h3><input type="text" id="new-char-name-input" class="setting-input text-center text-lg" placeholder="输入名字"><div class="grid grid-cols-2 gap-3 mt-4"><button class="setting-btn secondary" onclick="document.getElementById('modal-create-name').classList.add('hidden')">取消</button><button class="setting-btn" onclick="WeChatUI.confirmCreateName()">确定</button></div></div></div>
        <div id="modal-memory-lib" class="modal-overlay hidden"><div class="modal-box h-[400px] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">记忆管理库</h3><button onclick="document.getElementById('modal-memory-lib').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button></div><div class="flex-1 overflow-y-auto bg-black/20 rounded p-2 mb-2 text-xs text-gray-400 text-center">暂无记忆摘要</div><button class="setting-btn danger text-xs">批量删除</button></div></div>
        <div id="modal-emoji-upload" class="modal-overlay hidden"><div class="modal-box"><h3 class="font-bold mb-2">批量上传表情包 URL</h3><div class="mb-2"><label class="block text-sm text-gray-400 mb-1">表情包类型</label><select id="emoji-type-select" class="setting-input"><option value="exclusive">专属表情包 (仅当前角色可用)</option><option value="global">全局表情包 (所有角色可用)</option></select></div><textarea id="emoji-url-input" class="setting-input h-32" placeholder="每行一个链接..."></textarea><div class="grid grid-cols-2 gap-3"><button class="setting-btn secondary" onclick="document.getElementById('modal-emoji-upload').classList.add('hidden')">取消</button><button class="setting-btn" onclick="WeChatUI.confirmEmojiUpload()">导入</button></div></div></div>
        
        <!-- Manual Summary Modal -->
        <div id="modal-manual-summary" class="modal-overlay hidden">
            <div class="modal-box">
                <h3 class="font-bold mb-4">手动总结</h3>
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">总结区间</label>
                    <input type="text" id="summary-range-input" placeholder="例如: 5-20 (总结第5到20条消息)" class="setting-input">
                    <div class="text-xs text-gray-500 mt-1">输入格式: 开始编号-结束编号</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="WeChatUI.cancelManualSummary()" class="setting-btn secondary flex-1">取消</button>
                    <button onclick="WeChatUI.confirmManualSummary()" class="setting-btn flex-1">确定</button>
                </div>
            </div>
        </div>
        
        <!-- Transfer Modal -->
        <div id="modal-transfer" class="modal-overlay hidden">
            <div class="modal-box text-center">
                <h3 class="text-lg font-bold mb-4" id="transfer-title">转账</h3>
                <input type="number" id="transfer-amount" class="setting-input text-center text-2xl font-bold text-yellow-400" placeholder="0.00">
                <input type="text" id="transfer-note" class="setting-input" placeholder="备注 (可选)">
                <div class="grid grid-cols-2 gap-3 mt-4"><button class="setting-btn secondary" onclick="document.getElementById('modal-transfer').classList.add('hidden')">取消</button><button class="setting-btn" onclick="WeChatUI.confirmTransfer()">支付</button></div>
            </div>
        </div>

        <!-- Payment Action Modal (Unified) -->
        <div id="modal-payment-action" class="modal-overlay hidden">
            <div class="modal-box text-center" style="background:#f2f2f2; color:black;">
                <div id="payment-action-icon" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mx-auto mb-4 text-2xl text-white"><i class="fa-solid fa-sack-dollar"></i></div>
                <h3 class="text-lg font-bold mb-2" id="payment-action-title">收到转账</h3>
                <div class="text-3xl font-bold mb-2" id="payment-action-amount">¥0.00</div>
                <div class="text-gray-500 text-sm mb-6" id="payment-action-desc">备注</div>
                <div class="grid grid-cols-2 gap-3">
                    <button class="setting-btn danger" onclick="WeChatUI.processPaymentAction('rejected')">退还</button>
                    <button class="setting-btn" style="background: #f7931a;" onclick="WeChatUI.processPaymentAction('received')">收下</button>
                </div>
            </div>
        </div>

        <!-- Open Red Packet Modal (QQ Style) -->
        <div id="modal-open-redpacket" class="modal-overlay hidden">
            <div class="redpacket-modal w-[300px] rounded-2xl relative overflow-visible">
                <div class="rp-top-curve"></div>
                <button onclick="document.getElementById('modal-open-redpacket').classList.add('hidden')" class="absolute top-2 left-2 text-white/50 text-xl z-10"><i class="fa-solid fa-xmark"></i></button>
                <div class="rp-user-avatar" id="rp-open-avatar"><img src=""></div>
                <div class="rp-msg text-[#fce5cd] mt-2 font-bold" id="rp-open-msg">恭喜发财，大吉大利</div>
                <div class="rp-open-btn" onclick="WeChatUI.triggerOpenPacket()">開</div>
                
                <!-- Result View (Initially hidden) -->
                <div id="rp-result-view" class="rp-result">
                     <h3 class="text-[#d95940] font-bold text-lg">已存入零钱</h3>
                     <div class="rp-amount"><span>¥</span><span id="rp-result-amount">0.00</span></div>
                     <div class="text-gray-400 text-xs mt-auto mb-4 cursor-pointer" onclick="document.getElementById('modal-open-redpacket').classList.add('hidden')">关闭</div>
                </div>
                
                <div class="mt-8 text-white/50 text-xs cursor-pointer hover:text-white" id="rp-reject-btn" onclick="WeChatUI.triggerRejectPacket()">拒收红包</div>
                <div class="mt-auto text-white/30 text-xs pb-4" id="rp-detail-link">查看领取详情 ></div>
            </div>
        </div>

        <!-- Recalled Message Viewer -->
        <div id="modal-recall-view" class="modal-overlay hidden">
             <div class="modal-box text-center">
                 <h3 class="font-bold mb-4 text-gray-400">撤回的消息</h3>
                 <div id="recall-content-text" class="text-white text-sm bg-gray-800 p-4 rounded-lg break-all"></div>
                 <button class="setting-btn secondary mt-4" onclick="document.getElementById('modal-recall-view').classList.add('hidden')">关闭</button>
             </div>
        </div>
        <div id="modal-edit-msg" class="modal-overlay hidden">
            <div class="modal-box w-full max-w-md flex flex-col" style="max-height: 85vh;">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700/10">
                    <h3 class="font-bold text-lg">编辑与拆分消息</h3>
                    <button onclick="document.getElementById('modal-edit-msg').classList.add('hidden')" class="text-gray-500 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="edit-msg-list" class="flex-1 overflow-y-auto space-y-3 p-1 pr-2"></div>
                <div class="mt-3 pt-3 border-t border-gray-700/10 flex flex-col gap-3">
                    <button class="setting-btn secondary text-sm py-3 border-dashed border-2 border-gray-300 hover:border-blue-400 hover:text-blue-500 bg-gray-50" onclick="WeChatUI.addEditBlock()"><i class="fa-solid fa-plus mr-1"></i>添加下一条消息</button>
                    <div class="grid grid-cols-2 gap-3">
                        <button class="setting-btn secondary" onclick="document.getElementById('modal-edit-msg').classList.add('hidden')">取消</button>
                        <button class="setting-btn shadow-lg shadow-blue-500/30" onclick="WeChatUI.confirmEditMsg()">保存更改</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Context Menu -->
        <div id="context-menu" class="hidden">
            <div class="ctx-item" onclick="WeChatUI.ctxEdit()"><i class="fa-solid fa-pen"></i> 编辑</div>
            <div class="ctx-item" onclick="WeChatUI.ctxCopy()"><i class="fa-regular fa-copy"></i> 复制</div>
            <div class="ctx-item" onclick="WeChatUI.ctxQuote()"><i class="fa-solid fa-quote-left"></i> 引用</div>
            <div class="ctx-item" onclick="WeChatUI.ctxRevoke()"><i class="fa-solid fa-rotate-left"></i> 撤回</div>
            <div class="ctx-item" onclick="WeChatUI.ctxFav()"><i class="fa-regular fa-star"></i> 收藏</div>
            <div class="ctx-item" onclick="WeChatUI.enterMultiSelectMode()"><i class="fa-solid fa-check-double"></i> 多选</div>
            <div class="ctx-divider"></div>
            <div class="ctx-item text-red-400" onclick="WeChatUI.ctxDelete()"><i class="fa-solid fa-trash"></i> 删除</div>
        </div>
        
        <!-- Contact Context Menu -->
        <div id="contact-context-menu" class="hidden" style="position: fixed; background: #2b2b2b; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 9999; width: 140px; border: 1px solid #333;">
            <div class="ctx-item text-red-400" onclick="WeChatUI.deleteContact()"><i class="fa-solid fa-trash"></i> 删除好友</div>
        </div>
        
        <!-- Toast -->
        <div id="toast"></div>
        
        <!-- NPC Management Modal -->
        <div id="modal-npc-manager" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">NPC管理</h3>
                    <button onclick="document.getElementById('modal-npc-manager').classList.add('hidden')" class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="flex justify-end gap-2 mb-3">
                    <button onclick="WeChatUI.startCreateNPC()" class="setting-btn secondary text-sm">
                        <i class="fa-solid fa-plus mr-1"></i>添加NPC
                    </button>
                    <button onclick="WeChatUI.openRandomNPCModal()" class="setting-btn secondary text-sm">
                        <i class="fa-solid fa-dice mr-1"></i>随机生成
                    </button>
                </div>
                <div id="npc-list" class="max-h-60 overflow-y-auto mb-3">
                    <!-- NPC list will be rendered here -->
                </div>
                <button class="setting-btn secondary w-full" onclick="document.getElementById('modal-npc-manager').classList.add('hidden')">关闭</button>
            </div>
        </div>
        
        <!-- NPC Form Modal -->
        <div id="modal-npc-form" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 id="npc-form-title" class="font-bold">创建NPC</h3>
                    <button onclick="document.getElementById('modal-npc-form').classList.add('hidden')" class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <input type="hidden" id="npc-id">
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">关联角色</label>
                        <select id="npc-char-select" class="setting-input">
                            <!-- Character options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">NPC名称</label>
                        <input type="text" id="npc-name" class="setting-input" placeholder="输入NPC名称">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">头像</label>
                        <div class="flex gap-2">
                            <input type="text" id="npc-avatar" class="setting-input flex-1" placeholder="输入头像URL">
                            <button class="setting-btn secondary text-xs" onclick="document.getElementById('npc-upload-file').click()">上传</button>
                        </div>
                        <input type="file" id="npc-upload-file" class="hidden" onchange="WeChatUI.handleNPCAvatarFile(this)">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">人设描述</label>
                        <textarea id="npc-personality" class="setting-input h-20" placeholder="输入NPC的性格、背景等描述"></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="setting-btn secondary flex-1" onclick="document.getElementById('modal-npc-form').classList.add('hidden')">取消</button>
                    <button class="setting-btn flex-1" onclick="WeChatUI.saveNPC()">保存</button>
                    <button class="setting-btn secondary flex-1" onclick="WeChatUI.addNPCToList()">加入列表</button>
                </div>
            </div>
        </div>
        
        <!-- Random NPC Modal -->
        <div id="modal-random-npc" class="modal-overlay hidden">
            <div class="modal-box" style="max-width: 400px;">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold">随机生成NPC</h3>
                    <button onclick="document.getElementById('modal-random-npc').classList.add('hidden')" class="text-gray-500 hover:text-gray-400">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">关联角色</label>
                        <select id="random-npc-char-select" class="setting-input">
                            <!-- Character options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">生成数量</label>
                        <select id="random-npc-count" class="setting-input">
                            <option value="1">1个</option>
                            <option value="2">2个</option>
                            <option value="3">3个</option>
                            <option value="5">5个</option>
                            <option value="10">10个</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">生成类型</label>
                        <select id="random-npc-type" class="setting-input">
                            <option value="friend">朋友</option>
                            <option value="family">家人</option>
                            <option value="colleague">同事</option>
                            <option value="stranger">陌生人</option>
                            <option value="random">随机类型</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="setting-btn secondary flex-1" onclick="document.getElementById('modal-random-npc').classList.add('hidden')">取消</button>
                    <button class="setting-btn flex-1" onclick="WeChatUI.generateRandomNPCs()">生成</button>
                </div>
            </div>
        </div>
        
        <!-- Global Notification -->
        <div id="global-notification-modal" onclick="WeChatUI.handleNotificationClick()">
            <div class="notify-content">
                <div class="notify-avatar"><img id="notify-avatar-img" src=""></div>
                <div class="notify-text">
                    <div class="notify-name" id="notify-title">Title</div>
                    <div class="notify-msg" id="notify-body">Message content...</div>
                </div>
                <div class="text-xs text-gray-400">现在</div>
            </div>
        </div>
            <div id="subpage-moments-notices" class="sub-view bg-[#111] overflow-y-auto">
        <div class="fixed top-0 left-0 w-full h-14 z-50 flex justify-between items-center px-4 bg-[#111] border-b border-gray-800 text-white">
            <button onclick="WeChatUI.closeSubPage('subpage-moments-notices')" class="w-8 h-8 flex items-center justify-center">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <span class="font-bold">消息</span>
            <div class="w-8"></div>
        </div>
        <div class="mt-14" id="moments-notices-list"></div>
    </div>


        <div id="subpage-moments" class="sub-view bg-[#f0f2f5] overflow-y-auto">
            <!-- Top Nav Bar -->
            <div class="fixed top-0 left-0 w-full h-14 z-50 flex justify-between items-center px-4 bg-white border-b border-gray-200">
                <button onclick="WeChatUI.closeSubPage('subpage-moments')" class="w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-chevron-left text-gray-700"></i>
                </button>
                <span class="font-bold text-gray-900">朋友圈</span>
                <div class="flex gap-4">
                    <button onclick="WeChatUI.generateMoments()" class="w-8 h-8 flex items-center justify-center text-gray-700" title="生成朋友圈">
                        <i class="fa-solid fa-magic"></i>
                    </button>
                    <button onclick="WeChatUI.openMomentsEditor()" class="w-8 h-8 flex items-center justify-center text-gray-700" title="发朋友圈">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- Moments Header with Background -->
            <div class="relative w-full h-64 mt-14" id="moments-header">
                <div class="absolute inset-0 bg-gradient-to-b from-gray-800 to-gray-900" id="moments-bg-layer"></div>
                <img id="moments-bg" src="" class="w-full h-full object-cover opacity-60">
                <div class="absolute inset-0 flex flex-col items-center justify-end pb-8">
                    <!-- Avatar -->
                    <div class="w-20 h-20 rounded-full bg-white border-3 border-white overflow-hidden mb-3 z-10">
                        <img id="moments-avatar" src="" class="w-full h-full object-cover">
                    </div>
                    <!-- Name and Bio -->
                    <div class="text-center">
                        <div class="font-bold text-xl text-white" id="moments-name">我</div>
                        <div class="text-sm text-white/80 mt-1" id="moments-bio">暂无个性签名</div>
                    </div>
                    <!-- Settings Button -->
                    <button onclick="WeChatUI.openMomentsSettings()" class="absolute top-4 right-4 text-white bg-black/30 backdrop-blur-sm px-3 py-1 rounded-full text-sm flex items-center gap-1">
                        <i class="fa-solid fa-cog text-xs"></i>
                        <span>设置</span>
                    </button>
                </div>
            </div>
            
            <!-- Moments List -->
            <div class="px-4 py-2 space-y-6" id="moments-list">
                <!-- Moments will be rendered here -->
            </div>
        </div>
        
        <!-- User Moments Page -->
        <div id="subpage-user-moments" class="sub-view bg-[#f0f2f5] overflow-y-auto">
            <!-- Top Nav Bar -->
            <div class="fixed top-0 left-0 w-full h-14 z-50 flex justify-between items-center px-4 bg-white border-b border-gray-200">
                <button onclick="WeChatUI.closeSubPage('subpage-user-moments')" class="w-8 h-8 flex items-center justify-center">
                    <i class="fa-solid fa-chevron-left text-gray-700"></i>
                </button>
                <span class="font-bold text-gray-900" id="user-moments-title">用户朋友圈</span>
                <div class="w-8"></div>
            </div>
            
            <!-- User Profile Header -->
            <div class="relative w-full h-64 mt-14" id="user-moments-header">
                <!-- Background Image -->
                <img id="user-moments-bg" src="https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800&q=80" class="w-full h-full object-cover opacity-60">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-gray-900"></div>
                <div class="absolute inset-0 flex flex-col items-center justify-end pb-6">
                    <!-- Avatar -->
                    <div class="w-20 h-20 rounded-full bg-white border-2 border-white overflow-hidden mb-3">
                        <img id="user-moments-avatar" src="" class="w-full h-full object-cover">
                    </div>
                    <!-- Name -->
                    <div class="font-bold text-lg text-white" id="user-moments-name">用户名</div>
                    <!-- Bio -->
                    <div class="text-sm text-white/80 mt-1" id="user-moments-bio">个性签名</div>
                </div>
            </div>
            
            <!-- User Moments List -->
            <div class="px-4 py-2 space-y-6" id="user-moments-list">
                <!-- User moments will be rendered here -->
            </div>
        </div>
        
        <!-- Moments Editor Modal -->
        <div id="modal-moments-editor" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-3xl h-[80vh] flex flex-col bg-white">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="font-bold">发朋友圈</h3>
                        <button onclick="document.getElementById('modal-moments-editor').classList.add('hidden')" class="text-gray-500">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="flex gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full overflow-hidden">
                                <img id="editor-avatar" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <textarea id="moments-content" class="w-full border-none outline-none resize-none placeholder-gray-400 text-gray-900" rows="4" placeholder="分享你的心情..."></textarea>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div id="moments-image-preview" class="grid grid-cols-3 gap-2"></div>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('moments-image-input').click()" class="flex items-center gap-1 text-blue-500 text-sm">
                                    <i class="fa-solid fa-image"></i>
                                    <span>从相册选择</span>
                                </button>
                                <input type="file" id="moments-image-input" class="hidden" accept="image/*" multiple onchange="WeChatUI.handleMomentsImageUpload()">
                                <button onclick="WeChatUI.generateMomentsImage()" class="flex items-center gap-1 text-blue-500 text-sm">
                                    <i class="fa-solid fa-magic"></i>
                                    <span>AI配图</span>
                                </button>
                            </div>
                            
                            <!-- Visibility Settings -->
                            <div class="space-y-2">
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <i class="fa-solid fa-eye"></i>
                                    <span class="font-medium">谁可以看</span>
                                </div>
                                <div class="space-y-1 pl-7">
                                    <div class="flex items-center gap-2">
                                        <input type="radio" id="moments-visibility-all" name="moments-visibility" value="all" checked class="w-4 h-4 text-blue-500">
                                        <label for="moments-visibility-all" class="text-sm text-gray-700">公开 (所有人可见)</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="radio" id="moments-visibility-partial" name="moments-visibility" value="partial" class="w-4 h-4 text-blue-500">
                                        <label for="moments-visibility-partial" class="text-sm text-gray-700">部分可见</label>
                                    </div>
                                    <div id="moments-visibility-char-list" class="pl-6 hidden">
                                        <!-- Char list will be rendered here when partial visibility is selected -->
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="radio" id="moments-visibility-only-me" name="moments-visibility" value="only_me" class="w-4 h-4 text-blue-500">
                                        <label for="moments-visibility-only-me" class="text-sm text-gray-700">仅自己可见</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="radio" id="moments-visibility-private" name="moments-visibility" value="private" class="w-4 h-4 text-blue-500">
                                        <label for="moments-visibility-private" class="text-sm text-gray-700">私密 (所有人不可见)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <i class="fa-solid fa-location-dot"></i>
                                <input type="text" id="moments-location" class="border-none outline-none placeholder-gray-400" placeholder="添加位置">
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t">
                        <button onclick="WeChatUI.publishMoments()" class="setting-btn w-full">发布</button>
                    </div>
                </div>
            </div>
            
            <!-- Moments AI Image Modal -->
            <div id="modal-moments-ai-image" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-2xl bg-white">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="font-bold">AI 配图</h3>
                        <button onclick="document.getElementById('modal-moments-ai-image').classList.add('hidden')" class="text-gray-500">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">图片描述</label>
                            <input type="text" id="ai-image-prompt" class="setting-input w-full" placeholder="请输入图片描述，例如：向日葵、海滩日落">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="WeChatUI.generateMomentsImageWithPrompt()" class="setting-btn flex-1">生成图片</button>
                            <button onclick="document.getElementById('modal-moments-ai-image').classList.add('hidden')" class="setting-btn secondary">取消</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Moments Share Modal -->
            <div id="modal-moments-share" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-2xl bg-white">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="font-bold">分享到聊天</h3>
                        <button onclick="document.getElementById('modal-moments-share').classList.add('hidden')" class="text-gray-500">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <h4 class="font-medium text-gray-700">选择聊天对象</h4>
                        </div>
                        <div id="share-chat-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Chat list will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Moments Options Modal -->
            <div id="modal-moments-options" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-xs bg-white">
                    <div class="space-y-1">
                        <button id="moment-option-edit" class="w-full text-left p-4 hover:bg-gray-50 rounded-t-lg">
                            <i class="fa-solid fa-pen-to-square mr-2 text-gray-500"></i>
                            <span>编辑</span>
                        </button>
                        <button id="moment-option-delete" class="w-full text-left p-4 hover:bg-gray-50 text-red-600">
                            <i class="fa-solid fa-trash mr-2 text-red-500"></i>
                            <span>删除</span>
                        </button>
                        <button onclick="document.getElementById('modal-moments-options').classList.add('hidden')" class="w-full text-left p-4 hover:bg-gray-50 rounded-b-lg">
                            <i class="fa-solid fa-xmark mr-2 text-gray-500"></i>
                            <span>取消</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Moments Edit Modal -->
            <div id="modal-moments-edit" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-3xl h-[80vh] flex flex-col bg-white">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="font-bold">编辑朋友圈</h3>
                        <button onclick="document.getElementById('modal-moments-edit').classList.add('hidden')" class="text-gray-500">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="flex gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full overflow-hidden">
                                <img id="edit-moment-avatar" src="" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <textarea id="edit-moments-content" class="w-full border-none outline-none resize-none placeholder-gray-400 text-gray-900" rows="4" placeholder="分享你的心情..."></textarea>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div id="edit-moments-image-preview" class="grid grid-cols-3 gap-2"></div>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <input type="checkbox" id="edit-moments-only-me" class="w-4 h-4">
                                <label for="edit-moments-only-me">仅自己可见</label>
                            </div>
                            <div class="flex items-center gap-2 text-sm text-gray-500">
                                <i class="fa-solid fa-location-dot"></i>
                                <input type="text" id="edit-moments-location" class="border-none outline-none placeholder-gray-400" placeholder="添加位置">
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t">
                        <button onclick="WeChatUI.saveEditedMoment()" class="setting-btn w-full">保存</button>
                    </div>
                </div>
            </div>

            <!-- Moments Settings Modal -->
            <div id="modal-moments-settings" class="modal-overlay hidden">
                <div class="modal-box w-full max-width-2xl bg-white">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h3 class="font-bold">朋友圈设置</h3>
                        <button onclick="document.getElementById('modal-moments-settings').classList.add('hidden')" class="text-gray-500">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div>
                            <h4 class="font-medium mb-2">个性签名</h4>
                            <div class="flex gap-2 flex-wrap items-end">
                                <input type="text" id="input-moments-bio" class="bg-gray-100 border border-gray-300 text-gray-900 p-2 rounded flex-1 min-w-[150px]" placeholder="输入个性签名">
                                <button onclick="WeChatUI.applyMomentsBgUrl()" class="bg-gray-200 text-gray-900 px-4 py-2 rounded border border-gray-300 whitespace-nowrap">保存</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2">朋友圈背景</h4>
                            <div class="flex gap-3 flex-wrap">
                                <div class="w-20 h-12 rounded overflow-hidden border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer" onclick="document.getElementById('moments-bg-input').click()">
                                    <i class="fa-solid fa-plus text-gray-400"></i>
                                </div>
                                <input type="file" id="moments-bg-input" class="hidden" accept="image/*" onchange="WeChatUI.handleMomentsBgUpload(this)">
                                <div class="flex-1 min-w-[150px]">
                                    <input type="text" id="moments-bg-url" class="w-full bg-gray-100 border border-gray-300 text-gray-900 p-2 rounded" placeholder="输入背景图URL">
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2">AI朋友圈频率</h4>
                            <select id="moments-frequency" class="bg-gray-100 border border-gray-300 text-gray-900 p-2 rounded w-full">
                                <option value="daily">每天</option>
                                <option value="weekly">每周</option>
                                <option value="monthly">每月</option>
                                <option value="never">从不</option>
                            </select>
                        </div>
                        <div class="pt-2">
                            <button onclick="WeChatUI.applyMomentsBgUrl()" class="w-full bg-gray-200 text-gray-900 px-4 py-2 rounded border border-gray-300">保存所有设置</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utils
        const Utils = {
            compressImage: (file, maxWidth = 512, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width; height = img.height;
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(file);
                });
            },
            
            // 将中文翻译为英文
            translateToEnglish: async (chineseText) => {
                try {
                    // 检查是否已经是英文（简单判断：如果不包含中文字符，直接返回）
                    if (!/[\u4e00-\u9fa5]/.test(chineseText)) {
                        return chineseText;
                    }
                    
                    // 使用Google Translate API进行翻译
                    const response = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=en&dt=t&q=${encodeURIComponent(chineseText)}`);
                    const data = await response.json();
                    return data[0][0][0];
                } catch (error) {
                    console.error('翻译失败:', error);
                    // 翻译失败时，返回原始文本，但添加英文提示
                    return chineseText + ' (Please use English description for better results)';
                }
            },
            showToast: (msg) => {
                // 简单可靠的toast实现，确保能显示
                const toast = document.createElement('div');
                
                // 使用更简单直接的样式，避免复杂CSS导致的显示问题
                toast.style.position = 'fixed';
                toast.style.top = '50%';
                toast.style.left = '50%';
                toast.style.transform = 'translate(-50%, -50%)';
                toast.style.background = 'rgba(0, 0, 0, 0.95)';
                toast.style.color = 'white';
                toast.style.padding = '16px 24px';
                toast.style.borderRadius = '8px';
                toast.style.fontSize = '16px';
                toast.style.fontWeight = 'bold';
                toast.style.zIndex = '999999';
                toast.style.opacity = '1';
                toast.style.visibility = 'visible';
                toast.style.display = 'block';
                toast.style.textAlign = 'center';
                toast.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.8)';
                toast.style.border = 'none';
                toast.style.pointerEvents = 'none';
                toast.style.fontFamily = 'Arial, sans-serif';
                
                // 设置文本内容
                toast.textContent = msg;
                
                // 确保添加到body
                document.body.appendChild(toast);
                
                // 3秒后移除
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            },
            playAudio: (url) => { const a = new Audio(url); a.play().catch(e => alert('播放失败: ' + e)); },
            formatTimeDiff: (ms) => {
                const s = Math.floor(ms/1000);
                if(s < 60) return 'just now';
                const m = Math.floor(s/60);
                if(m < 60) return `${m} mins ago`;
                const h = Math.floor(m/60);
                if(h < 24) return `${h} hours ago`;
                return `${Math.floor(h/24)} days ago`;
            },
            formatCurrentTime: () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const weekday = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][now.getDay()];
                // 【修改】强制24小时制，AI看这个绝对不会晕
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${weekday} ${hour}:${minute}`;
            },
            formatTimeDiffDetailed: (ms) => {
                const s = Math.floor(ms/1000);
                if(s < 60) return '刚刚';
                const m = Math.floor(s/60);
                if(m < 60) return `${m}分钟前`;
                const h = Math.floor(m/60);
                if(h < 24) return `${h}小时前`;
                const d = Math.floor(h/24);
                if(d < 7) return `${d}天前`;
                const w = Math.floor(d/7);
                if(w < 4) return `${w}周前`;
                const mo = Math.floor(d/30);
                return `${mo}个月前`;
            },
            formatChatTime: (ts) => {
                if (!ts) return '';
                const date = new Date(ts);
                const now = new Date();
                const diffDay = now.getDate() - date.getDate();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                if (now.toDateString() === date.toDateString()) return `${hours}:${minutes}`;
                if (diffDay === 1) return `昨天 ${hours}:${minutes}`;
                if (diffDay < 7 && diffDay > 0) return `${['日','一','二','三','四','五','六'][date.getDay()]} ${hours}:${minutes}`;
                return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${hours}:${minutes}`;
            },
            // 通用输入弹窗相关
            promptCallback: null,
            
            // 显示通用输入弹窗
            showPrompt: (title, placeholder, callback) => {
                document.getElementById('prompt-title').textContent = title;
                document.getElementById('prompt-input').placeholder = placeholder;
                document.getElementById('prompt-input').value = '';
                Utils.promptCallback = callback;
                document.getElementById('modal-prompt').classList.remove('hidden');
            },
            
            // 取消通用输入弹窗
            cancelPrompt: () => {
                document.getElementById('modal-prompt').classList.add('hidden');
                Utils.promptCallback = null;
            },
            
            // 确认通用输入弹窗
            confirmPrompt: () => {
                const value = document.getElementById('prompt-input').value;
                if(Utils.promptCallback) {
                    Utils.promptCallback(value);
                }
                document.getElementById('modal-prompt').classList.add('hidden');
                Utils.promptCallback = null;
            }
        };

        function updateSystem() {
            const now = new Date();
            const time = now.toTimeString().slice(0,5);
            document.getElementById('clock-small').textContent = time; document.getElementById('clock-large').textContent = time;
            document.getElementById('date-large').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][now.getDay()]}`;
        }
        setInterval(updateSystem, 1000); updateSystem();
        if ('getBattery' in navigator) navigator.getBattery().then(b => { document.getElementById('battery-level').textContent = Math.round(b.level*100) + '%'; });

        // Navigation
        const swiper = document.getElementById('app-swiper');
        let isDown=false, startX, scrollLeft, isDragging=false;
        if(swiper) {
            swiper.addEventListener('mousedown', e => { isDown=true; isDragging=false; swiper.classList.add('active'); swiper.style.scrollSnapType='none'; startX=e.pageX-swiper.offsetLeft; scrollLeft=swiper.scrollLeft; });
            swiper.addEventListener('mouseleave', () => { isDown=false; swiper.classList.remove('active'); swiper.style.scrollSnapType='x mandatory'; });
            swiper.addEventListener('mouseup', () => { isDown=false; swiper.classList.remove('active'); swiper.style.scrollSnapType='x mandatory'; setTimeout(()=>isDragging=false,10); });
            swiper.addEventListener('mousemove', e => { if(!isDown)return; e.preventDefault(); const x=e.pageX-swiper.offsetLeft; const walk=(x-startX)*1.5; if(Math.abs(walk)>5)isDragging=true; swiper.scrollLeft=scrollLeft-walk; });
        }

        function openApp(appId) {
            if(isDragging) return;
            if (appId === 'wechat') { document.getElementById('app-wechat').classList.add('active'); WeChatUI.renderList(); }
            else if (appId === 'settings') { document.getElementById('app-settings').classList.add('active'); SettingsUI.init(); }
            else if (appId === 'worldbook' || appId === 'app-worldbook') { document.getElementById('app-worldbook').classList.add('active'); WorldbookUI.renderList(); }
            else { const icon = document.getElementById('icon-' + appId); if(icon) { icon.style.transform = "scale(0.95)"; setTimeout(() => icon.style.transform = "", 150); } alert(appId + ' 正在加载核心...'); }
        }
        function closeApp() { document.querySelectorAll('.app-window').forEach(el => el.classList.remove('active')); }

        const Storage = { 
            get: (k, d) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(d)); } catch(e) { return d; } }, 
            set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) { if(e.name==='QuotaExceededError') alert('空间已满'); } } 
        };

        // Weather Logic
        const WeatherLogic = {
            init: () => {
                const config = Storage.get('weather_config', { virtualLoc: '虚拟城市', realLoc: '' });
                document.getElementById('weather-virtual-loc').value = config.virtualLoc;
                document.getElementById('weather-real-loc').value = config.realLoc;
                WeatherLogic.updateDisplay(config);
            },
            saveWeatherConfig: () => {
                const config = {
                    virtualLoc: document.getElementById('weather-virtual-loc').value || '虚拟城市',
                    realLoc: document.getElementById('weather-real-loc').value
                };
                Storage.set('weather_config', config);
                WeatherLogic.updateDisplay(config);
                if (config.realLoc) WeatherLogic.fetchRealWeather(config.realLoc);
                Utils.showToast('天气设置已保存');
            },
            updateDisplay: (config) => {
                document.getElementById('desktop-location-text').textContent = config.virtualLoc;
            },
            fetchRealWeather: async (city) => {
                const weathers = [
                    { icon: 'fa-sun', desc: '晴朗', temp: '25°', color: 'text-yellow-300' },
                    { icon: 'fa-cloud-rain', desc: '小雨', temp: '18°', color: 'text-blue-300' },
                    { icon: 'fa-cloud', desc: '多云', temp: '22°', color: 'text-gray-300' },
                    { icon: 'fa-bolt', desc: '雷阵雨', temp: '20°', color: 'text-purple-300' }
                ];
                const w = weathers[Math.floor(Math.random() * weathers.length)];
                document.getElementById('desktop-weather-icon').className = `fa-solid ${w.icon} weather-icon`;
                document.getElementById('desktop-weather-bg-icon').innerHTML = `<i class="fa-solid ${w.icon}"></i>`;
                document.getElementById('desktop-weather-bg-icon').className = `absolute -right-4 -bottom-4 text-7xl opacity-20 ${w.color}`;
                document.getElementById('desktop-temp').textContent = w.temp;
                document.getElementById('desktop-weather-desc').textContent = w.desc;
            }
        };

        // Settings Logic
        const SettingsUI = {
            init: () => { SettingsLogic.initAPI(); ThemeLogic.init(); SettingsLogic.initTTS(); WeatherLogic.init(); },
            openPage: (pid, title) => { document.getElementById('settings-main-menu').classList.add('hidden'); document.getElementById('settings-page-'+pid).classList.remove('hidden'); document.getElementById('settings-title').textContent=title; },
            handleBack: () => { if(document.getElementById('settings-main-menu').classList.contains('hidden')) { document.getElementById('settings-main-menu').classList.remove('hidden'); document.querySelectorAll('[id^="settings-page-"]').forEach(el => el.classList.add('hidden')); document.getElementById('settings-title').textContent='设置中心'; } else closeApp(); }
        };
        const SettingsLogic = {
            configs: [], currentId: null,
            initAPI: () => {
                SettingsLogic.configs = Storage.get('api_configs', [{id: 'default', name: '默认设置', url: 'http://127.0.0.1:7861/v1', key: 'pwd', model: '流式抗截断/gemini-2.5-pro-preview-06-05-nothinking', temp: 0.7}]);
                SettingsLogic.currentId = Storage.get('current_api_id', 'default');
                const sel = document.getElementById('api-config-select'); sel.innerHTML = SettingsLogic.configs.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); sel.value = SettingsLogic.currentId;
                SettingsLogic.loadAPIConfig(SettingsLogic.currentId);
            },
            loadAPIConfig: (id) => {
                SettingsLogic.currentId = id; const config = SettingsLogic.configs.find(c => c.id === id); if(!config) return;
                document.getElementById('api-name').value = config.name; document.getElementById('api-url').value = config.url; document.getElementById('api-key').value = config.key; document.getElementById('api-model').value = config.model; document.getElementById('api-temp').value = config.temp; document.getElementById('temp-display').textContent = config.temp;
                Storage.set('current_api_id', id);
            },
            saveAPI: () => {
                const newConfig = { id: SettingsLogic.currentId, name: document.getElementById('api-name').value, url: document.getElementById('api-url').value, key: document.getElementById('api-key').value, model: document.getElementById('api-model').value, temp: document.getElementById('api-temp').value };
                const idx = SettingsLogic.configs.findIndex(c => c.id === SettingsLogic.currentId); if (idx !== -1) SettingsLogic.configs[idx] = newConfig;
                Storage.set('api_configs', SettingsLogic.configs); Utils.showToast('保存成功');
            },
            createNewAPI: () => { const newId = 'config_' + Date.now(); SettingsLogic.configs.push({ id: newId, name: '新配置', url: '', key: '', model: '', temp: 0.7 }); SettingsLogic.initAPI(); document.getElementById('api-config-select').value = newId; SettingsLogic.loadAPIConfig(newId); },
            deleteAPI: () => { if (SettingsLogic.configs.length <= 1) return alert('无法删除'); if (!confirm('删除?')) return; SettingsLogic.configs = SettingsLogic.configs.filter(c => c.id !== SettingsLogic.currentId); SettingsLogic.currentId = SettingsLogic.configs[0].id; Storage.set('api_configs', SettingsLogic.configs); SettingsLogic.initAPI(); },
            fetchModels: async (event) => {
                const urlInput = document.getElementById('api-url');
                const keyInput = document.getElementById('api-key');
                const btn = event ? event.currentTarget : document.querySelector('[onclick*="SettingsLogic.fetchModels()"]');

                if(!urlInput.value || !keyInput.value) return Utils.showToast('请填写完整的接口地址和密钥');
                
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="spinner-container"><i class="fa-solid fa-spinner spinner-rotate"></i></div>';
                btn.disabled = true;
                
                try {
                    let targetUrl = urlInput.value.trim();
                    if(targetUrl.endsWith('/')) targetUrl = targetUrl.slice(0, -1);
                    if(targetUrl.endsWith('/chat/completions')) targetUrl = targetUrl.replace('/chat/completions', '');
                    if(!targetUrl.endsWith('/models')) targetUrl += '/models';

                    // 检查当前页面是否通过本地文件协议打开
                    if (window.location.protocol === 'file:') {
                        Utils.showToast('⚠️ 本地文件模式下可能存在跨域限制，建议使用HTTP服务器运行');
                    }

                    const res = await fetch(targetUrl, {
                        method: 'GET',
                        headers: { 
                            'Authorization': `Bearer ${keyInput.value.trim()}`,
                            'Content-Type': 'application/json'
                        },
                        // 添加mode和credentials选项，提高跨浏览器兼容性
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(`Status ${res.status}: ${errText}`);
                    }
                    
                    const data = await res.json();
                    const models = Array.isArray(data) ? data : (data.data || []);
                    
                    if (models.length === 0) throw new Error('未找到模型数据');
                    
                    const select = document.getElementById('api-model-select');
                    select.innerHTML = '<option value="" disabled selected>▼ 请选择模型</option>' + 
                        models.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
                    select.classList.remove('hidden');
                    
                    Utils.showToast(`✨ 成功获取 ${models.length} 个模型！`);
                    
                    if(models.length > 0) {
                        document.getElementById('api-model').value = models[0].id;
                        select.value = models[0].id;
                    }

                } catch (e) {
                    let errorMsg = '拉取失败: ' + e.message;
                    console.error('模型拉取错误详情:', e);
                    console.error('错误类型:', e.name);
                    console.error('错误堆栈:', e.stack);
                    
                    if (e.message.includes('NetworkError') || e.name === 'NetworkError') {
                        errorMsg = '网络连接失败，请检查网络设置或接口地址是否正确';
                    } else if (e.message.includes('CORS') || e.name === 'TypeError' && e.message.includes('cors')) {
                        errorMsg = '跨域错误！建议：1. 使用HTTP服务器运行页面 2. 检查API是否支持CORS 3. 尝试使用代理';
                        // 针对Chrome浏览器的特殊提示
                        if (navigator.userAgent.indexOf('Chrome') > -1) {
                            errorMsg += '\nChrome对本地文件的跨域限制更严格，强烈建议使用HTTP服务器';
                        }
                    } else if (e.message.includes('401')) {
                        errorMsg = '认证失败，请检查API密钥是否正确';
                    } else if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
                        errorMsg = '请求失败！可能原因：1. 接口地址错误 2. 网络连接问题 3. 浏览器安全限制';
                        // 针对本地文件模式的特殊提示
                        if (window.location.protocol === 'file:') {
                            errorMsg += '\n本地文件模式下，Chrome浏览器可能不允许发送跨域请求，请尝试使用HTTP服务器运行页面';
                        }
                    }
                    Utils.showToast(errorMsg);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },
            initTTS: () => {
                const tts = Storage.get('tts_config', {engine: 'browser', minimax: {}});
                document.getElementById('tts-engine').value = tts.engine || 'browser'; document.getElementById('minimax-group-id').value = tts.minimax.groupId || ''; document.getElementById('minimax-api-key').value = tts.minimax.apiKey || ''; document.getElementById('minimax-voice-id').value = tts.minimax.voiceId || ''; document.getElementById('minimax-model-id').value = tts.minimax.modelId || 'speech-01-turbo';
                SettingsLogic.toggleTTSSettings();
            },
            toggleTTSSettings: () => { document.getElementById('minimax-settings').className = document.getElementById('tts-engine').value === 'minimax' ? 'space-y-3' : 'space-y-3 hidden'; },
            fetchMinimaxModels: async (event) => {
                const groupId = document.getElementById('minimax-group-id').value;
                const apiKey = document.getElementById('minimax-api-key').value;
                const btn = event ? event.currentTarget : document.querySelector('[onclick*="SettingsLogic.fetchMinimaxModels()"]');
                
                if(!groupId || !apiKey) return Utils.showToast('请填写完整的Group ID和API Key');
                
                const originalText = btn.innerHTML;
                btn.innerHTML = '<div class="spinner-container"><i class="fa-solid fa-spinner spinner-rotate"></i></div>';
                btn.disabled = true;
                
                try {
                    // 检查当前页面是否通过本地文件协议打开
                    if (window.location.protocol === 'file:') {
                        Utils.showToast('⚠️ 本地文件模式下可能存在跨域限制，建议使用HTTP服务器运行');
                    }

                    const res = await fetch('https://api.minimax.chat/v1/models', {
                        method: 'GET',
                        headers: { 
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json',
                            'GroupId': groupId
                        },
                        // 添加mode和credentials选项，提高跨浏览器兼容性
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    
                    if (!res.ok) {
                        const errText = await res.text();
                        throw new Error(`Status ${res.status}: ${errText}`);
                    }
                    
                    const data = await res.json();
                    const models = data.models || [];
                    
                    if (models.length === 0) throw new Error('未找到模型数据');
                    
                    const select = document.getElementById('minimax-model-select');
                    select.innerHTML = '<option value="" disabled selected>▼ 请选择模型</option>' + 
                        models.map(m => `<option value="${m.model}">${m.model}</option>`).join('');
                    select.classList.remove('hidden');
                    
                    Utils.showToast(`✨ 成功获取 ${models.length} 个MiniMax模型！`);
                    
                    if(models.length > 0) {
                        document.getElementById('minimax-model-id').value = models[0].model;
                        select.value = models[0].model;
                    }
                } catch (e) {
                    let errorMsg = 'MiniMax模型拉取失败: ' + e.message;
                    console.error('MiniMax模型拉取错误详情:', e);
                    console.error('错误类型:', e.name);
                    console.error('错误堆栈:', e.stack);
                    
                    if (e.message.includes('NetworkError') || e.name === 'NetworkError') {
                        errorMsg = '网络连接失败，请检查网络设置';
                    } else if (e.message.includes('CORS') || e.name === 'TypeError' && e.message.includes('cors')) {
                        errorMsg = '跨域错误！建议：1. 使用HTTP服务器运行页面 2. 检查网络环境是否允许访问MiniMax API';
                        // 针对Chrome浏览器的特殊提示
                        if (navigator.userAgent.indexOf('Chrome') > -1) {
                            errorMsg += '\nChrome对本地文件的跨域限制更严格，强烈建议使用HTTP服务器';
                        }
                    } else if (e.message.includes('401')) {
                        errorMsg = '认证失败，请检查Group ID和API密钥是否正确';
                    } else if (e.name === 'TypeError' && e.message.includes('Failed to fetch')) {
                        errorMsg = '请求失败！可能原因：1. 网络连接问题 2. 浏览器安全限制 3. MiniMax API访问限制';
                        // 针对本地文件模式的特殊提示
                        if (window.location.protocol === 'file:') {
                            errorMsg += '\n本地文件模式下，Chrome浏览器可能不允许发送跨域请求，请尝试使用HTTP服务器运行页面';
                        }
                    }
                    Utils.showToast(errorMsg);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            },
            testTTS: async () => {
                if (document.getElementById('tts-engine').value === 'browser') return speechSynthesis.speak(new SpeechSynthesisUtterance("测试语音"));
                const btn = event.target; const txt = btn.innerHTML; btn.innerHTML = '...';
                try {
                    const res = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${document.getElementById('minimax-group-id').value}`, {
                        method: 'POST', headers: { 'Authorization': `Bearer ${document.getElementById('minimax-api-key').value}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ voice_id: document.getElementById('minimax-voice-id').value, text: "测试语音", model: document.getElementById('minimax-model-id').value })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    Utils.playAudio(URL.createObjectURL(await res.blob()));
                } catch (e) { alert(e.message); } finally { btn.innerHTML = txt; }
            },
            saveTTS: () => { Utils.showToast('保存成功'); Storage.set('tts_config', { engine: document.getElementById('tts-engine').value, minimax: { apiKey: document.getElementById('minimax-api-key').value, groupId: document.getElementById('minimax-group-id').value, voiceId: document.getElementById('minimax-voice-id').value, modelId: document.getElementById('minimax-model-id').value } }); },
            generateLLM: async (messages, cid) => {
    // 1. 获取配置
    const config = SettingsLogic.configs.find(c => c.id === SettingsLogic.currentId);
    if (!config || !config.key) throw new Error("请检查API配置");

    const chars = Storage.get('wechat_chars', {});
    const char = chars[cid];
    
    // --- 世界书与记忆注入 ---
    const books = Storage.get('wechat_worldbooks', {});
    let worldInfo = "";
    if (char && char.worldbookEntries) {
        char.worldbookEntries.forEach(entryId => {
            const [bookId, entryIdx] = entryId.split('_');
            const book = books[bookId];
            if (book && book.entries && book.entries[parseInt(entryIdx)]) {
                const entry = book.entries[parseInt(entryIdx)];
                if (entry.enabled && entry.content) worldInfo += `[World Info: ${entry.content}]\n`;
            }
        });
    }
    let memoryInfo = "";
    if (char && char.memory && char.memory.length > 0) {
        // 【修改】不再限制条数，全部注入！
        // 告诉 AI 这是不可反驳的历史事实
        memoryInfo += "\n[System Note - Historical Memory (Fact)]:\n";
        char.memory.forEach(m => {
            if (m.type === 'summary') {
                const dateStr = new Date(m.timestamp).toLocaleString();
                memoryInfo += `- [${dateStr}] ${m.content}\n`;
            }
        });
        memoryInfo += "[End of History]\n";
    }

    // 2. 准备API地址
    let endpoint = config.url.replace(/\/$/, '');
    if (!endpoint.endsWith('/chat/completions')) {
        if (endpoint.endsWith('/v1')) endpoint += '/chat/completions';
        else endpoint += '/v1/chat/completions';
    }

    // 处理 System Prompt
    if (messages && messages.length > 0 && messages[0].role === 'system') {
        messages[0].content = worldInfo + memoryInfo + messages[0].content;
    }

    // 3. 【核心】构建历史记录 & 智能省流
    const historyLimit = char ? (char.contextLimit || 20) : 20;
    const historyMsgs = char && char.msgs ? char.msgs.slice(-historyLimit) : [];
    
    // 找出包含真实数据的图片索引
    const imageIndices = historyMsgs.map((m, i) => (m.type === 'image' && m.originalContent) ? i : -1).filter(i => i !== -1);
    // 只保留最后一张图片发给 AI
    const activeImageIndices = imageIndices.slice(-1); 

    const apiMessages = messages && messages.length > 0 ? [messages[0]] : [];

    historyMsgs.forEach((m, index) => {
        let contentPayload;

        // 如果是"最近一张"图片 -> 发送真实数据
        if (m.type === 'image' && m.originalContent && activeImageIndices.includes(index)) {
            contentPayload = [
                { type: "text", text: m.content.includes(':') ? m.content : "这是用户发送的图片" },
                { type: "image_url", image_url: { url: m.originalContent, detail: "low" } }
            ];
        } 
        // 如果是"老图片" -> 发送文字占位符
        else if (m.type === 'image') {
            contentPayload = "[用户之前发送过一张图片，已省略]";
        } 
                           
        // 处理朋友圈分享，转成文字发给 AI
        else if (m.type === 'moment_share') {
            let shareData = m.content;
            if (typeof shareData === 'string') {
                 try { shareData = JSON.parse(shareData); } catch(e) { shareData = { text: shareData }; }
            }
            contentPayload = '[系统提示: 用户分享了一条朋友圈链接。作者：' + (shareData.author || '好友') + ', 内容："' + shareData.text + '"。请对此进行互动评论。]';
        }
        // 普通文本
        else {
            let textContent = m.content;
            if (m.type === 'transfer') textContent = `[转账: ${m.amount}元]`;
            if (m.type === 'redpacket') textContent = `[红包: ${m.note}]`;
            if (m.type === 'voice') textContent = `[语音: "${m.text}"]`;
            contentPayload = textContent;
        }

        if (contentPayload) {
            apiMessages.push({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: contentPayload
            });
        }
    });

    // 4. 发送请求
    const payload = {
        model: config.model,
        messages: apiMessages,
        temperature: parseFloat(config.temp) || 0.7,
        max_tokens: 1024
    };

    const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!res.ok) {
        let errorMsg = `HTTP ${res.status}`;
        try {
            const errorData = await res.json();
            if (errorData.error) errorMsg += `: ${errorData.error.message}`;
            if (JSON.stringify(errorData).includes('image') || JSON.stringify(errorData).includes('vision')) {
                errorMsg += " (当前模型可能不支持识图，请尝试 GPT-4o)";
            }
        } catch (e) { errorMsg += `: ${await res.text()}`; }
        throw new Error(errorMsg);
    }
    const data = await res.json();
    return data.choices[0].message.content;
},
            generateTTS: async (text, charSettings) => {
                const globalTTS = Storage.get('tts_config', {engine: 'browser', minimax: {}});
                if (globalTTS.engine === 'browser') {
                    speechSynthesis.speak(new SpeechSynthesisUtterance(text));
                    return null; 
                } else {
                    const apiKey = globalTTS.minimax.apiKey;
                    const groupId = globalTTS.minimax.groupId;
                    const voiceId = charSettings.voiceId || globalTTS.minimax.voiceId;
                    const modelId = globalTTS.minimax.modelId || 'speech-01-turbo';
                    const speed = charSettings.voiceSpeed || 1.0;

                    try {
                        const res = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${groupId}`, {
                            method: 'POST', 
                            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ voice_id: voiceId, text: text, model: modelId, speed: parseFloat(speed) })
                        });
                        if (!res.ok) throw new Error('API Error');
                        const blob = await res.blob();
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                    } catch(e) {
                        console.error("TTS Gen Failed", e);
                        return null;
                    }
                }
            }
        };
        const ThemeLogic = { 
            init: () => {
                const t = Storage.get('theme_config', {});
                ThemeLogic.apply(t);
                ThemeLogic.loadPresets();
                ThemeLogic.updateFontSettings();
                ThemeLogic.updateGlobalBgPreview();
            },
            apply: (t) => {
                document.getElementById('user-custom-css').innerHTML = t.css || '';
                if(t.wallpaper) document.getElementById('wallpaper-layer').style.backgroundImage = `url(${t.wallpaper})`;
                if(t.icons) Object.keys(t.icons).forEach(k => { const el = document.getElementById(k); if(el) { el.innerHTML=`<img src="${t.icons[k]}">`; el.className="w-[60px] h-[60px] rounded-xl glass-icon shadow-lg"; } });
                if(t.widgets) { if(t.widgets.card1) document.getElementById('widget-img-card1').innerHTML=`<img src="${t.widgets.card1}" class="widget-img">`; if(t.widgets.card2) document.getElementById('widget-img-card2').innerHTML=`<img src="${t.widgets.card2}" class="widget-img">`; }
                
                // Apply global font settings
                if(t.font) {
                    document.body.style.color = t.font.color || '#166534';
                    document.body.style.textShadow = t.font.shadow || '';
                    if(t.font.url) {
                        const style = document.createElement('style');
                        style.textContent = `@import url('${t.font.url}'); body { font-family: 'CustomFont', 'Noto Sans SC', sans-serif; }`;
                        document.head.appendChild(style);
                    }
                }
                
                // Apply global background
                if(t.globalBg) {
                    document.documentElement.style.setProperty('--app-bg-color', `url(${t.globalBg})`);
                    document.body.style.backgroundImage = `url(${t.globalBg})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                }
            },
            saveTheme: () => {
                const t = Storage.get('theme_config', { icons: {}, widgets: {}, font: {}, globalBg: '' });
                t.css = document.getElementById('theme-css').value;
                
                // Save font settings
                t.font = {
                    color: document.getElementById('font-color').value,
                    shadow: document.getElementById('font-shadow').value,
                    url: document.getElementById('font-url').value
                };
                
                // Save global background
                t.globalBg = document.getElementById('global-bg-url-input').value;
                
                Storage.set('theme_config', t);
                ThemeLogic.apply(t);
                Utils.showToast('美化保存');
            },
            
            // Global Font Settings
            applyFontUrl: () => {
                const url = document.getElementById('font-url').value;
                if(url) {
                    const t = Storage.get('theme_config', { font: {} });
                    t.font.url = url;
                    Storage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    Utils.showToast('字体应用成功');
                }
            },
            updateFontSettings: () => {
                const t = Storage.get('theme_config', { font: {} });
                document.getElementById('font-color').value = t.font.color || '#166534';
                document.getElementById('font-shadow').value = t.font.shadow || '';
                document.getElementById('font-url').value = t.font.url || '';
            },
            restoreDefaultFont: () => {
                const t = Storage.get('theme_config', { font: {} });
                t.font = {
                    color: '#166534',
                    shadow: '',
                    url: ''
                };
                Storage.set('theme_config', t);
                ThemeLogic.apply(t);
                ThemeLogic.updateFontSettings();
                Utils.showToast('字体已恢复默认');
            },
            
            // Global Background Settings
            applyGlobalBgUrl: () => {
                const url = document.getElementById('global-bg-url-input').value;
                if(url) {
                    const t = Storage.get('theme_config', {});
                    t.globalBg = url;
                    Storage.set('theme_config', t);
                    ThemeLogic.apply(t);
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('全局背景应用成功');
                }
            },
            handleGlobalBgUpload: (input) => {
                if (input.files[0]) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        const t = Storage.get('theme_config', {});
                        t.globalBg = base64;
                        Storage.set('theme_config', t);
                        ThemeLogic.apply(t);
                        document.getElementById('global-bg-url-input').value = base64;
                        ThemeLogic.updateGlobalBgPreview();
                        Utils.showToast('全局背景上传成功');
                    });
                }
            },
            resetGlobalBg: () => {
                const t = Storage.get('theme_config', {});
                t.globalBg = '';
                Storage.set('theme_config', t);
                document.documentElement.style.setProperty('--app-bg-color', '#f0fdf4');
                document.body.style.backgroundImage = '';
                document.body.style.backgroundSize = 'auto';
                document.body.style.backgroundPosition = 'static';
                document.body.style.backgroundAttachment = 'scroll';
                document.getElementById('global-bg-url-input').value = '';
                ThemeLogic.updateGlobalBgPreview();
                Utils.showToast('全局背景已重置');
            },
            updateGlobalBgPreview: () => {
                const t = Storage.get('theme_config', {});
                document.getElementById('global-bg-preview-box').style.backgroundImage = t.globalBg ? `url(${t.globalBg})` : '';
            },
            
            // Preset Management
            loadPresets: () => {
                const presets = Storage.get('theme_presets', {});
                const select = document.getElementById('preset-select');
                select.innerHTML = '<option value="">选择预设...</option>' + 
                    Object.keys(presets).map(name => `<option value="${name}">${name}</option>`).join('');
            },
            savePreset: () => {
                const name = document.getElementById('preset-name').value;
                if(!name) return Utils.showToast('请输入预设名称');
                
                const t = Storage.get('theme_config', { icons: {}, widgets: {}, font: {}, globalBg: '' });
                const presets = Storage.get('theme_presets', {});
                presets[name] = t;
                Storage.set('theme_presets', presets);
                
                document.getElementById('preset-name').value = '';
                ThemeLogic.loadPresets();
                Utils.showToast('预设保存成功');
            },
            loadPreset: (name) => {
                if(!name) return;
                const presets = Storage.get('theme_presets', {});
                const preset = presets[name];
                if(preset) {
                    Storage.set('theme_config', preset);
                    ThemeLogic.apply(preset);
                    ThemeLogic.updateFontSettings();
                    document.getElementById('theme-css').value = preset.css || '';
                    document.getElementById('global-bg-url-input').value = preset.globalBg || '';
                    ThemeLogic.updateWallpaperPreview();
                    ThemeLogic.updateIconPreview();
                    ThemeLogic.updateWidgetPreviews();
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('预设加载成功');
                }
            },
            deletePreset: () => {
                const name = document.getElementById('preset-select').value;
                if(!name) return Utils.showToast('请选择要删除的预设');
                
                const presets = Storage.get('theme_presets', {});
                delete presets[name];
                Storage.set('theme_presets', presets);
                ThemeLogic.loadPresets();
                Utils.showToast('预设删除成功');
            },
            
            // Reset and Restore Defaults
            resetAll: () => {
                if(confirm('确定要重置所有美化设置吗？')) {
                    Storage.set('theme_config', {});
                    ThemeLogic.apply({});
                    ThemeLogic.updateFontSettings();
                    document.getElementById('theme-css').value = '';
                    document.getElementById('global-bg-url-input').value = '';
                    ThemeLogic.updateWallpaperPreview();
                    ThemeLogic.updateIconPreview();
                    ThemeLogic.updateWidgetPreviews();
                    ThemeLogic.updateGlobalBgPreview();
                    Utils.showToast('全局美化已重置');
                }
            },
            restoreDefaultCSS: () => {
                document.getElementById('theme-css').value = '';
                Utils.showToast('CSS已恢复默认');
            },
            
            // Other methods
            applyUrl: (type) => { /* Reuse logic */ },
            handleImageUpload: (type, input) => { if (input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { const t = Storage.get('theme_config', { icons: {}, widgets: {} }); if(type==='wallpaper') t.wallpaper = base64; else t.icons[document.getElementById('icon-selector').value] = base64; Storage.set('theme_config', t); ThemeLogic.apply(t); if(type==='wallpaper') ThemeLogic.updateWallpaperPreview(); else ThemeLogic.updateIconPreview(); }); },
            handleWidgetUpload: (input) => { if (input.files[0] && ThemeLogic.currentWidget) Utils.compressImage(input.files[0]).then(base64 => { const t = Storage.get('theme_config', { icons: {}, widgets: {} }); t.widgets[ThemeLogic.currentWidget] = base64; Storage.set('theme_config', t); ThemeLogic.apply(t); ThemeLogic.updateWidgetPreviews(); }); },
            triggerWidgetUpload: (id) => { ThemeLogic.currentWidget = id; document.getElementById('upload-widget').click(); },
            resetWallpaper: () => { const t = Storage.get('theme_config', {}); t.wallpaper = ''; Storage.set('theme_config', t); document.getElementById('wallpaper-layer').style.backgroundImage=''; ThemeLogic.updateWallpaperPreview(); },
            updateWallpaperPreview: () => { const t = Storage.get('theme_config', {}); document.getElementById('wallpaper-preview-box').style.backgroundImage = t.wallpaper ? `url(${t.wallpaper})` : ''; },
            updateIconPreview: () => { const t = Storage.get('theme_config', { icons: {} }); const k = document.getElementById('icon-selector').value; document.getElementById('icon-preview-box').innerHTML = t.icons[k] ? `<img src="${t.icons[k]}">` : ''; },
            updateWidgetPreviews: () => { const t = Storage.get('theme_config', { widgets: {} }); ['card1', 'card2'].forEach(id => document.getElementById(id==='card1'?'widget1-preview-box':'widget2-preview-box').innerHTML = t.widgets[id] ? `<img src="${t.widgets[id]}">` : ''); }
        };

        // Worldbook Logic
        const WorldbookUI = {
            books: {},
            categories: {},
            groups: {},
            init: () => {
                WorldbookUI.books = Storage.get('wechat_worldbooks', {});
                WorldbookUI.categories = Storage.get('wechat_worldbook_categories', {});
                WorldbookUI.groups = Storage.get('wechat_worldbook_groups', {});
            },
            renderList: () => {
                WorldbookUI.init();
                const container = document.getElementById('wb-list-container');
                const categoryFilter = document.getElementById('wb-category-filter')?.value || '';
                const groupFilter = document.getElementById('wb-group-filter')?.value || '';
                
                let list = Object.values(WorldbookUI.books);
                
                // Apply filters
                if (categoryFilter) {
                    list = list.filter(b => b.categoryId === categoryFilter);
                }
                if (groupFilter) {
                    list = list.filter(b => b.groupId === groupFilter);
                }
                
                if (list.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-20">暂无世界书，点击右上角 + 创建</div>';
                } else {
                    container.innerHTML = list.map(b => {
                        const category = b.categoryId ? WorldbookUI.categories[b.categoryId] : null;
                        const group = b.groupId ? WorldbookUI.groups[b.groupId] : null;
                        return `
                        <div class="wb-list-item" onclick="WorldbookUI.openEdit('${b.id}')">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-bold text-green-600 mb-1">${b.name || '未命名'}</div>
                                    <div class="text-xs text-gray-400 mb-2">${(b.entries || []).length} 个条目</div>
                                    <div class="flex gap-2 flex-wrap">
                                        ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-2 py-0.5 rounded">${category.name}</span>` : ''}
                                        ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-2 py-0.5 rounded">${group.name}</span>` : ''}
                                    </div>
                                </div>
                                <div class="text-gray-400 ml-2"><i class="fa-solid fa-chevron-right"></i></div>
                            </div>
                        </div>
                    `;
                    }).join('');
                }
                
                // Update filter dropdowns
                WorldbookUI.updateFilters();
            },
            updateFilters: () => {
                const categoryFilter = document.getElementById('wb-category-filter');
                const groupFilter = document.getElementById('wb-group-filter');
                
                if (categoryFilter) {
                    categoryFilter.innerHTML = '<option value="">所有分类</option>' + 
                        Object.values(WorldbookUI.categories).map(cat => 
                            `<option value="${cat.id}">${cat.name}</option>`
                        ).join('');
                }
                
                if (groupFilter) {
                    groupFilter.innerHTML = '<option value="">所有分组</option>' + 
                        Object.values(WorldbookUI.groups).map(grp => 
                            `<option value="${grp.id}">${grp.name}</option>`
                        ).join('');
                }
                
                // Update edit form dropdowns
                const editCategory = document.getElementById('wb-edit-category');
                const editGroup = document.getElementById('wb-edit-group');
                
                if (editCategory) {
                    editCategory.innerHTML = '<option value="">无分类</option>' + 
                        Object.values(WorldbookUI.categories).map(cat => 
                            `<option value="${cat.id}">${cat.name}</option>`
                        ).join('');
                }
                
                if (editGroup) {
                    editGroup.innerHTML = '<option value="">无分组</option>' + 
                        Object.values(WorldbookUI.groups).map(grp => 
                            `<option value="${grp.id}">${grp.name}</option>`
                        ).join('');
                }
            },
            createNewBook: () => {
                Utils.showPrompt('创建世界书', '输入世界书名称:', (name) => {
                    if(!name) return;
                    const id = 'wb_' + Date.now();
                    WorldbookUI.books[id] = { id, name, entries: [], categoryId: null, groupId: null };
                    Storage.set('wechat_worldbooks', WorldbookUI.books);
                    WorldbookUI.renderList();
                });
            },
            openEdit: (id) => {
                WorldbookUI.currentBookId = id;
                const book = WorldbookUI.books[id];
                document.getElementById('wb-edit-name').value = book.name || '';
                document.getElementById('wb-edit-category').value = book.categoryId || '';
                document.getElementById('wb-edit-group').value = book.groupId || '';
                WorldbookUI.updateFilters();
                WorldbookUI.renderEntries();
                document.getElementById('wb-edit-view').classList.remove('hidden');
                document.getElementById('wb-edit-view').classList.add('flex');
            },
            closeEdit: () => {
                 const name = document.getElementById('wb-edit-name').value;
                 const categoryId = document.getElementById('wb-edit-category').value || null;
                 const groupId = document.getElementById('wb-edit-group').value || null;
                 if(WorldbookUI.currentBookId && WorldbookUI.books[WorldbookUI.currentBookId]) {
                     WorldbookUI.books[WorldbookUI.currentBookId].name = name;
                     WorldbookUI.books[WorldbookUI.currentBookId].categoryId = categoryId;
                     WorldbookUI.books[WorldbookUI.currentBookId].groupId = groupId;
                     Storage.set('wechat_worldbooks', WorldbookUI.books);
                 }
                 document.getElementById('wb-edit-view').classList.add('hidden');
                 document.getElementById('wb-edit-view').classList.remove('flex');
                 WorldbookUI.renderList();
                 // Also update settings list if open
                 WorldbookUI.renderSettingsList();
            },
            renderEntries: () => {
                const book = WorldbookUI.books[WorldbookUI.currentBookId];
                const container = document.getElementById('wb-entry-list');
                container.innerHTML = book.entries.map((e, idx) => `
                    <div class="glass-panel p-3 rounded-lg relative">
                        <div class="mb-2">
                            <input type="text" class="w-full bg-black/30 border border-white/10 rounded px-2 py-1 text-sm mb-2" placeholder="条目标题" value="${e.title || ''}" onchange="WorldbookUI.updateEntry(${idx}, 'title', this.value)">
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="bg-black/30 border border-white/10 rounded px-2 py-1 text-xs w-1/3" placeholder="关键词 (逗号分隔)" value="${e.keys}" onchange="WorldbookUI.updateEntry(${idx}, 'keys', this.value)">
                            <div class="flex-1 flex justify-end gap-2">
                                <label class="flex items-center gap-1 text-xs"><input type="checkbox" ${e.enabled?'checked':''} onchange="WorldbookUI.updateEntry(${idx}, 'enabled', this.checked)"> 启用</label>
                                <button class="text-red-400 text-xs" onclick="WorldbookUI.deleteEntry(${idx})"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <textarea class="w-full bg-black/30 border border-white/10 rounded p-2 text-xs h-20 resize-none" placeholder="内容设定..." onchange="WorldbookUI.updateEntry(${idx}, 'content', this.value)">${e.content}</textarea>
                    </div>
                `).join('');
            },
            addEntry: () => {
                const book = WorldbookUI.books[WorldbookUI.currentBookId];
                book.entries.push({ title: '', keys: '', content: '', enabled: true });
                Storage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderEntries();
            },
            updateEntry: (idx, field, val) => {
                const book = WorldbookUI.books[WorldbookUI.currentBookId];
                book.entries[idx][field] = val;
                Storage.set('wechat_worldbooks', WorldbookUI.books);
            },
            deleteEntry: (idx) => {
                if(!confirm('删除此条目?')) return;
                const book = WorldbookUI.books[WorldbookUI.currentBookId];
                book.entries.splice(idx, 1);
                Storage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderEntries();
            },
            // Category Management
            showCategoryManager: () => {
                WorldbookUI.init();
                WorldbookUI.renderCategoryList();
                document.getElementById('wb-category-modal').classList.remove('hidden');
            },
            hideCategoryManager: () => {
                document.getElementById('wb-category-modal').classList.add('hidden');
            },
            renderCategoryList: () => {
                const container = document.getElementById('wb-category-list');
                const categories = Object.values(WorldbookUI.categories);
                if (categories.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">暂无分类</div>';
                } else {
                    container.innerHTML = categories.map(cat => {
                        const bookCount = Object.values(WorldbookUI.books).filter(b => b.categoryId === cat.id).length;
                        return `
                            <div class="flex items-center justify-between glass-panel p-3 rounded-lg">
                                <div>
                                    <div class="font-medium">${cat.name}</div>
                                    <div class="text-xs text-gray-400">${bookCount} 个世界书</div>
                                </div>
                                <button onclick="WorldbookUI.deleteCategory('${cat.id}')" class="text-red-400 text-xs px-2 py-1 rounded bg-red-500/20"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                    }).join('');
                }
            },
            addCategory: () => {
                const name = document.getElementById('wb-new-category-name').value.trim();
                if (!name) {
                    alert('请输入分类名称');
                    return;
                }
                const id = 'cat_' + Date.now();
                WorldbookUI.categories[id] = { id, name };
                Storage.set('wechat_worldbook_categories', WorldbookUI.categories);
                document.getElementById('wb-new-category-name').value = '';
                WorldbookUI.renderCategoryList();
                WorldbookUI.updateFilters();
            },
            deleteCategory: (id) => {
                if (!confirm('确定删除此分类？分类下的世界书将变为无分类。')) return;
                delete WorldbookUI.categories[id];
                // Remove category from books
                Object.values(WorldbookUI.books).forEach(book => {
                    if (book.categoryId === id) {
                        book.categoryId = null;
                    }
                });
                Storage.set('wechat_worldbook_categories', WorldbookUI.categories);
                Storage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderCategoryList();
                WorldbookUI.updateFilters();
                WorldbookUI.renderList();
            },
            // Group Management
            showGroupManager: () => {
                WorldbookUI.init();
                WorldbookUI.renderGroupList();
                document.getElementById('wb-group-modal').classList.remove('hidden');
            },
            hideGroupManager: () => {
                document.getElementById('wb-group-modal').classList.add('hidden');
            },
            renderGroupList: () => {
                const container = document.getElementById('wb-group-list');
                const groups = Object.values(WorldbookUI.groups);
                if (groups.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">暂无分组</div>';
                } else {
                    container.innerHTML = groups.map(grp => {
                        const bookCount = Object.values(WorldbookUI.books).filter(b => b.groupId === grp.id).length;
                        return `
                            <div class="flex items-center justify-between glass-panel p-3 rounded-lg">
                                <div>
                                    <div class="font-medium">${grp.name}</div>
                                    <div class="text-xs text-gray-400">${bookCount} 个世界书</div>
                                </div>
                                <button onclick="WorldbookUI.deleteGroup('${grp.id}')" class="text-red-400 text-xs px-2 py-1 rounded bg-red-500/20"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                    }).join('');
                }
            },
            addGroup: () => {
                const name = document.getElementById('wb-new-group-name').value.trim();
                if (!name) {
                    alert('请输入分组名称');
                    return;
                }
                const id = 'grp_' + Date.now();
                WorldbookUI.groups[id] = { id, name };
                Storage.set('wechat_worldbook_groups', WorldbookUI.groups);
                document.getElementById('wb-new-group-name').value = '';
                WorldbookUI.renderGroupList();
                WorldbookUI.updateFilters();
            },
            deleteGroup: (id) => {
                if (!confirm('确定删除此分组？分组下的世界书将变为无分组。')) return;
                delete WorldbookUI.groups[id];
                // Remove group from books
                Object.values(WorldbookUI.books).forEach(book => {
                    if (book.groupId === id) {
                        book.groupId = null;
                    }
                });
                Storage.set('wechat_worldbook_groups', WorldbookUI.groups);
                Storage.set('wechat_worldbooks', WorldbookUI.books);
                WorldbookUI.renderGroupList();
                WorldbookUI.updateFilters();
                WorldbookUI.renderList();
            },
            // Interface for Character Settings
            renderSettingsList: () => {
                WorldbookUI.init();
                const cid = WeChatUI.currentChatId;
                const char = Storage.get('wechat_chars', {})[cid];
                const selectedEntries = char ? char.worldbookEntries || [] : []; // Array of entry IDs: "bookId_entryIdx"
                
                const allBooks = WorldbookUI.books;
                const container = document.getElementById('char-worldbook-list');
                
                if(Object.keys(allBooks).length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">暂无世界书，请在桌面世界书App中创建</div>';
                    return;
                }
                
                container.innerHTML = Object.values(allBooks).map((b, bookIdx) => {
                    const category = b.categoryId ? WorldbookUI.categories[b.categoryId] : null;
                    const group = b.groupId ? WorldbookUI.groups[b.groupId] : null;
                    const entries = b.entries || [];
                    const bookId = `wb-collapse-${b.id}`;
                    
                    // Count selected entries for this book
                    const selectedCount = entries.filter((entry, idx) => {
                        const entryId = `${b.id}_${idx}`;
                        return selectedEntries.includes(entryId);
                    }).length;
                    
                    if(entries.length === 0) {
                        return `
                        <div class="wb-collapsible">
                            <div class="wb-collapsible-header" onclick="WorldbookUI.toggleCollapse('${bookId}')">
                                <div class="flex items-center gap-2 flex-1">
                                    <i class="fa-solid fa-chevron-right wb-collapsible-icon text-xs text-gray-400"></i>
                                    <div class="flex-1">
                                        <div class="text-sm font-medium">${b.name || '未命名'}</div>
                                        <div class="flex gap-2 mt-1">
                                            ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-1.5 py-0.5 rounded">${category.name}</span>` : ''}
                                            ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-1.5 py-0.5 rounded">${group.name}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">暂无条目</div>
                            </div>
                            <div class="wb-collapsible-content" id="${bookId}">
                                <div class="px-4 pb-2 text-xs text-gray-500">暂无条目</div>
                            </div>
                        </div>
                        `;
                    }
                    
                    return `
                    <div class="wb-collapsible">
                        <div class="wb-collapsible-header" onclick="WorldbookUI.toggleCollapse('${bookId}')">
                            <div class="flex items-center gap-2 flex-1">
                                <i class="fa-solid fa-chevron-right wb-collapsible-icon text-xs text-gray-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-medium">${b.name || '未命名'}</div>
                                    <div class="flex gap-2 mt-1">
                                        ${category ? `<span class="text-xs bg-purple-500/30 text-purple-200 px-1.5 py-0.5 rounded">${category.name}</span>` : ''}
                                        ${group ? `<span class="text-xs bg-indigo-500/30 text-indigo-200 px-1.5 py-0.5 rounded">${group.name}</span>` : ''}
                                        <span class="text-xs text-gray-400">${entries.length} 条目</span>
                                        ${selectedCount > 0 ? `<span class="text-xs bg-green-500/30 text-green-200 px-1.5 py-0.5 rounded">已选 ${selectedCount}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="wb-collapsible-content" id="${bookId}">
                            <div class="px-4 pb-3 space-y-1 max-h-60 overflow-y-auto">
                                ${entries.map((entry, idx) => {
                                    const entryId = `${b.id}_${idx}`;
                                    const isSelected = selectedEntries.includes(entryId);
                                    const entryTitle = entry.title || `条目 ${idx + 1}`;
                                    return `
                                    <label class="flex items-center gap-2 p-1.5 rounded hover:bg-white/5 cursor-pointer">
                                        <input type="checkbox" class="toggle-switch" style="width:32px;height:16px" 
                                            ${isSelected ? 'checked' : ''} 
                                            onchange="WorldbookUI.toggleEntryForChar('${cid}', '${entryId}', this.checked)">
                                        <span class="text-xs flex-1">${entryTitle}</span>
                                    </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            },
            toggleCollapse: (bookId) => {
                const content = document.getElementById(bookId);
                const icon = content.previousElementSibling.querySelector('.wb-collapsible-icon');
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            },
            toggleEntryForChar: (cid, entryId, checked) => {
                const chars = Storage.get('wechat_chars', {});
                let char = chars[cid];
                
                // 如果char不存在，创建一个新的char对象
                if(!char) {
                    char = chars[cid] = {};
                }
                
                if(!char.worldbookEntries) char.worldbookEntries = [];
                
                if(checked) {
                    if(!char.worldbookEntries.includes(entryId)) char.worldbookEntries.push(entryId);
                } else {
                    char.worldbookEntries = char.worldbookEntries.filter(id => id !== entryId);
                }
                Storage.set('wechat_chars', chars);
            },
            // Injection Logic
            scanAndInject: (text) => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const char = Storage.get('wechat_chars', {})[cid];
                if(!char || !char.worldbookEntries || char.worldbookEntries.length === 0) return '';
                
                const allBooks = Storage.get('wechat_worldbooks', {});
                let injectedContent = '';
                
                char.worldbookEntries.forEach(entryId => {
                    const [bookId, entryIdx] = entryId.split('_');
                    const book = allBooks[bookId];
                    if(book && book.entries && book.entries[parseInt(entryIdx)]) {
                        const entry = book.entries[parseInt(entryIdx)];
                        if(!entry.enabled || !entry.content) return;
                        const keys = entry.keys ? entry.keys.split(/[,，]/).map(k => k.trim()).filter(k => k) : [];
                        // Logic: If no keys defined, always inject (global lore). If keys defined, scan text.
                        let match = false;
                        if (keys.length === 0) {
                            match = true;
                        } else {
                            match = keys.some(k => text.includes(k));
                        }
                        
                        if(match) {
                            const entryTitle = entry.title ? `[${entry.title}]` : '';
                            injectedContent += `[World Info${entryTitle}: ${entry.content}]\n`;
                        }
                    }
                });
                
                return injectedContent;
            }
        };

        // Inner Voice UI
        const InnerVoiceUI = {
            currentCharId: null,
            editMode: false,
            manageMode: false,
            editingId: null,
            selectedIds: new Set(),
            init: () => {
                InnerVoiceUI.currentCharId = document.getElementById('subpage-chat-detail')?.dataset.charId;
            },
            openModal: () => {
                InnerVoiceUI.init();
                InnerVoiceUI.renderCharacterView();
                InnerVoiceUI.updateBg();
                document.getElementById('voice-character-view').classList.remove('hidden');
                document.getElementById('voice-history-view').classList.add('hidden');
                document.getElementById('voice-edit-container').classList.add('hidden');
                InnerVoiceUI.editMode = false;
                InnerVoiceUI.manageMode = false;
                InnerVoiceUI.updateUI();
                document.getElementById('inner-voice-modal').classList.add('active');
            },
            closeModal: () => {
                document.getElementById('inner-voice-modal').classList.remove('active');
                InnerVoiceUI.editMode = false;
                InnerVoiceUI.manageMode = false;
                InnerVoiceUI.editingId = null;
                InnerVoiceUI.selectedIds.clear();
                InnerVoiceUI.updateUI();
            },
            renderStamps: () => {
                if (!InnerVoiceUI.currentCharId) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = (char.innerVoices || []).slice().reverse(); // 反转数组，最新的在上面
                const container = document.getElementById('voice-stamp-container');
                const countEl = document.getElementById('voice-count');
                
                countEl.textContent = `共 ${voices.length} 条`;
                
                if (voices.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">暂无心声记录</div>';
                    return;
                }
                
                container.innerHTML = voices.map((voice, idx) => {
                    const voiceId = voice.id || `voice_${idx}`;
                    const isSelected = InnerVoiceUI.selectedIds.has(voiceId);
                    const timeStr = new Date(voice.timestamp).toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    const content = voice.content || '无内容';
                    const preview = content.length > 50 ? content.substring(0, 50) + '...' : content;
                    
                    return `
                        <div class="voice-stamp-item ${isSelected ? 'selected' : ''}" data-id="${voiceId}">
                            <div class="stamp-checkbox"></div>
                            <div class="voice-stamp-content">${preview}</div>
                            <div class="voice-stamp-time">${timeStr}</div>
                            <div class="voice-stamp-actions">
                                <button class="btn-edit" onclick="InnerVoiceUI.startEdit('${voiceId}')" title="编辑"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn-delete" onclick="InnerVoiceUI.deleteVoice('${voiceId}')" title="删除"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click handler for selection in manage mode
                if (InnerVoiceUI.manageMode) {
                    container.querySelectorAll('.voice-stamp-item').forEach(item => {
                        item.onclick = (e) => {
                            if (e.target.closest('.voice-stamp-actions')) return;
                            const id = item.dataset.id;
                            if (InnerVoiceUI.selectedIds.has(id)) {
                                InnerVoiceUI.selectedIds.delete(id);
                            } else {
                                InnerVoiceUI.selectedIds.add(id);
                            }
                            InnerVoiceUI.renderStamps();
                        };
                    });
                } else {
                    // Add click handler for viewing in normal mode
                    container.querySelectorAll('.voice-stamp-item').forEach(item => {
                        item.onclick = (e) => {
                            if (e.target.closest('.voice-stamp-actions')) return;
                            const id = item.dataset.id;
                            InnerVoiceUI.viewVoice(id);
                        };
                    });
                }
            },
            toggleEditMode: () => {
                InnerVoiceUI.editMode = !InnerVoiceUI.editMode;
                InnerVoiceUI.manageMode = false;
                InnerVoiceUI.updateUI();
            },
            toggleManageMode: () => {
                InnerVoiceUI.manageMode = !InnerVoiceUI.manageMode;
                InnerVoiceUI.editMode = false;
                InnerVoiceUI.selectedIds.clear();
                InnerVoiceUI.updateUI();
                InnerVoiceUI.renderStamps();
            },
            updateUI: () => {
                document.getElementById('voice-edit-container').classList.toggle('hidden', !InnerVoiceUI.editMode);
                document.getElementById('voice-select-all-btn').style.display = InnerVoiceUI.manageMode ? 'block' : 'none';
                document.getElementById('voice-delete-selected-btn').style.display = InnerVoiceUI.manageMode ? 'block' : 'none';
                document.getElementById('voice-edit-btn').textContent = InnerVoiceUI.editMode ? '取消编辑' : '编辑';
                document.getElementById('voice-manage-btn').textContent = InnerVoiceUI.manageMode ? '取消管理' : '管理';
            },
            startEdit: (voiceId = null) => {
                // Use current viewing ID if no voiceId provided
                const targetVoiceId = voiceId || InnerVoiceUI.currentViewingId;
                if (!targetVoiceId) return;
                
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                const voice = voices.find(v => (v.id || `voice_${voices.indexOf(v)}`) === targetVoiceId);
                
                if (voice) {
                    InnerVoiceUI.editingId = targetVoiceId;
                    document.getElementById('voice-edit-textarea').value = voice.content || '';
                    document.getElementById('voice-edit-container').classList.remove('hidden');
                    // Update UI state
                    InnerVoiceUI.editMode = true;
                    InnerVoiceUI.manageMode = false;
                    InnerVoiceUI.selectedIds.clear();
                    InnerVoiceUI.updateUI();
                }
            },
            saveEdit: () => {
                if (!InnerVoiceUI.editingId) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                const newContent = document.getElementById('voice-edit-textarea').value.trim();
                if (!newContent) {
                    alert('内容不能为空');
                    return;
                }
                const idx = voices.findIndex(v => (v.id || `voice_${voices.indexOf(v)}`) === InnerVoiceUI.editingId);
                if (idx !== -1) {
                    voices[idx].content = newContent;
                    voices[idx].timestamp = Date.now();
                    char.innerVoices = voices;
                    Storage.set('wechat_chars', chars);
                    // Cancel edit mode
                    InnerVoiceUI.cancelEdit();
                    // Update current view if we're viewing a specific voice
                    if (InnerVoiceUI.currentViewingId) {
                        // Re-render the current viewing voice
                        InnerVoiceUI.renderCharacterView(InnerVoiceUI.currentViewingId);
                    } else {
                        // Update current voice
                        InnerVoiceUI.updateCurrentVoice();
                    }
                    // Update history stamps
                    InnerVoiceUI.renderStamps();
                }
            },
            cancelEdit: () => {
                InnerVoiceUI.editingId = null;
                document.getElementById('voice-edit-textarea').value = '';
                document.getElementById('voice-edit-container').classList.add('hidden');
                // Update UI state
                InnerVoiceUI.editMode = false;
                InnerVoiceUI.updateUI();
                // If we're viewing a specific voice, re-render it
                if (InnerVoiceUI.currentViewingId) {
                    InnerVoiceUI.renderCharacterView(InnerVoiceUI.currentViewingId);
                }
            },
            deleteVoice: (voiceId) => {
                if (!confirm('确定要删除这条心声吗？')) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                const idx = voices.findIndex(v => (v.id || `voice_${voices.indexOf(v)}`) === voiceId);
                if (idx !== -1) {
                    // Check if we're deleting the currently viewed voice
                    const isCurrentViewed = InnerVoiceUI.currentViewingId === voiceId;
                    voices.splice(idx, 1);
                    char.innerVoices = voices;
                    Storage.set('wechat_chars', chars);
                    
                    // Update UI
                    InnerVoiceUI.renderStamps();
                    
                    // If we deleted the currently viewed voice
                    if (isCurrentViewed) {
                        // Clear current viewing ID
                        InnerVoiceUI.currentViewingId = null;
                        // Render character view with latest voice
                        InnerVoiceUI.renderCharacterView();
                    } else {
                        // Just update current voice
                        InnerVoiceUI.updateCurrentVoice();
                    }
                }
            },
            selectAll: () => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                if (InnerVoiceUI.selectedIds.size === voices.length) {
                    InnerVoiceUI.selectedIds.clear();
                } else {
                    voices.forEach((v, idx) => {
                        InnerVoiceUI.selectedIds.add(v.id || `voice_${idx}`);
                    });
                }
                InnerVoiceUI.renderStamps();
            },
            deleteSelected: () => {
                if (InnerVoiceUI.selectedIds.size === 0) {
                    alert('请先选择要删除的心声');
                    return;
                }
                if (!confirm(`确定要删除选中的 ${InnerVoiceUI.selectedIds.size} 条心声吗？`)) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                char.innerVoices = voices.filter((v, idx) => !InnerVoiceUI.selectedIds.has(v.id || `voice_${idx}`));
                Storage.set('wechat_chars', chars);
                InnerVoiceUI.selectedIds.clear();
                InnerVoiceUI.renderStamps();
                InnerVoiceUI.updateCurrentVoice();
            },
            updateCurrentVoice: () => {
                // Don't auto-show the card, only update when modal is open
                if (document.getElementById('inner-voice-modal').classList.contains('active')) {
                    InnerVoiceUI.renderCharacterView();
                }
            },
            openBgUpload: () => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-box" onclick="event.stopPropagation()">
                        <h3 class="font-bold mb-4">设置背景图</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">背景图URL</label>
                                <input type="text" id="voice-bg-url-input" class="setting-input" placeholder="输入图片URL">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="InnerVoiceUI.confirmBgUpload()" class="setting-btn flex-1">确认</button>
                                <button onclick="document.getElementById('voice-bg-file-input').click()" class="setting-btn secondary flex-1">本地上传</button>
                                <button onclick="InnerVoiceUI.removeBg()" class="setting-btn secondary">清除</button>
                                <button onclick="this.closest('.modal-overlay').remove()" class="setting-btn secondary">取消</button>
                            </div>
                            <input type="file" id="voice-bg-file-input" class="hidden" accept="image/*" onchange="InnerVoiceUI.handleBgFileUpload(this)">
                        </div>
                    </div>
                `;
                modal.onclick = () => modal.remove();
                document.body.appendChild(modal);
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (char && char.voiceBg) {
                    document.getElementById('voice-bg-url-input').value = char.voiceBg;
                }
            },
            confirmBgUpload: () => {
                const url = document.getElementById('voice-bg-url-input').value.trim();
                if (!url) {
                    alert('请输入图片URL');
                    return;
                }
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char) return;
                char.voiceBg = url;
                Storage.set('wechat_chars', chars);
                InnerVoiceUI.updateBg();
                document.querySelector('.modal-overlay').remove();
                Utils.showToast('背景图已设置');
            },
            handleBgFileUpload: (input) => {
                if (input.files[0]) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        const chars = Storage.get('wechat_chars', {});
                        const char = chars[InnerVoiceUI.currentCharId];
                        if (!char) return;
                        char.voiceBg = base64;
                        Storage.set('wechat_chars', chars);
                        InnerVoiceUI.updateBg();
                        document.querySelector('.modal-overlay').remove();
                        Utils.showToast('背景图已上传');
                    });
                }
            },
            removeBg: () => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char) return;
                delete char.voiceBg;
                Storage.set('wechat_chars', chars);
                InnerVoiceUI.updateBg();
                document.querySelector('.modal-overlay').remove();
                Utils.showToast('背景图已清除');
            },
            updateBg: () => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char) return;
                const modalContent = document.querySelector('.voice-modal-content');
                if (modalContent) {
                    if (char.voiceBg) {
                        modalContent.style.backgroundImage = `url(${char.voiceBg})`;
                    } else {
                        modalContent.style.backgroundImage = '';
                    }
                }
            },
            // View specific voice record
            viewVoice: (voiceId) => {
                // Render the specific voice in character view
                InnerVoiceUI.renderCharacterView(voiceId);
                // Switch to character view
                document.getElementById('voice-character-view').classList.remove('hidden');
                document.getElementById('voice-history-view').classList.add('hidden');
                document.getElementById('voice-edit-container').classList.add('hidden');
                // Update UI state
                InnerVoiceUI.editMode = false;
                InnerVoiceUI.manageMode = false;
                InnerVoiceUI.editingId = null;
                InnerVoiceUI.selectedIds.clear();
                InnerVoiceUI.updateUI();
            },
            
            renderCharacterView: (voiceId = null) => {
                if (!InnerVoiceUI.currentCharId) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                const voices = char.innerVoices || [];
                
                // Update character info
                document.getElementById('voice-character-avatar').src = char.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default100';
                document.getElementById('voice-character-name').textContent = char.name || '角色名称';
                if (char.userAvatar) {
                    document.getElementById('voice-baby-avatar').src = char.userAvatar;
                    document.getElementById('voice-baby-avatar').style.display = 'inline-block';
                } else {
                    document.getElementById('voice-baby-avatar').style.display = 'none';
                }
                document.getElementById('voice-baby-name').textContent = char.userName || '-';
                
                // Get voice to display
                let voiceToDisplay = null;
                if (voiceId) {
                    // Find specific voice by ID
                    voiceToDisplay = voices.find(v => (v.id || `voice_${voices.indexOf(v)}`) === voiceId);
                } else if (voices.length > 0) {
                    // Use latest voice
                    voiceToDisplay = voices[voices.length - 1];
                }
                
                // Render voice content
                if (voiceToDisplay) {
                    const content = voiceToDisplay.content || '';
                    
                    // Parse content to extract sections - support both single line and multi-line
                    const outfitMatch = content.match(/着装[：:]\s*([^\n]+(?:\n(?!环境|心声|行为)[^\n]+)*)/);
                    const envMatch = content.match(/环境[：:]\s*([^\n]+(?:\n(?!着装|心声|行为)[^\n]+)*)/);
                    const voiceMatch = content.match(/心声[：:]\s*([^\n]+(?:\n(?!着装|环境|行为)[^\n]+)*)/);
                    const actionMatch = content.match(/行为[：:]\s*([^\n]+(?:\n(?!着装|环境|心声)[^\n]+)*)/);
                    
                    document.getElementById('voice-outfit-content').textContent = outfitMatch ? outfitMatch[1].trim() : '-';
                    document.getElementById('voice-env-content').textContent = envMatch ? envMatch[1].trim() : '-';
                    document.getElementById('voice-inner-content').textContent = voiceMatch ? voiceMatch[1].trim() : '-';
                    document.getElementById('voice-action-content').textContent = actionMatch ? actionMatch[1].trim() : '-';
                    
                    // Store the current voice ID for editing
                    InnerVoiceUI.currentViewingId = voiceId;
                } else {
                    document.getElementById('voice-outfit-content').textContent = '-';
                    document.getElementById('voice-env-content').textContent = '-';
                    document.getElementById('voice-inner-content').textContent = '-';
                    document.getElementById('voice-action-content').textContent = '-';
                    InnerVoiceUI.currentViewingId = null;
                }
            },
            showHistory: () => {
                document.getElementById('voice-character-view').classList.add('hidden');
                document.getElementById('voice-history-view').classList.remove('hidden');
                InnerVoiceUI.renderStamps();
            },
            addVoice: (content) => {
                InnerVoiceUI.init();
                if (!InnerVoiceUI.currentCharId || !content) return;
                const chars = Storage.get('wechat_chars', {});
                const char = chars[InnerVoiceUI.currentCharId];
                if (!char.innerVoices) char.innerVoices = [];
                const voiceId = `voice_${Date.now()}`;
                char.innerVoices.push({
                    id: voiceId,
                    content: content,
                    timestamp: Date.now()
                });
                Storage.set('wechat_chars', chars);
                // Don't auto-show, only update if modal is open
                if (document.getElementById('inner-voice-modal').classList.contains('active')) {
                    InnerVoiceUI.renderCharacterView();
                }
            }
        };

        // WeChat Logic
        const WeChatUI = {
            currentChatId: null,
            ctxTargetMsg: null,
            isVoiceMode: false,
            isMultiSelect: false,
            lastNotifyTime: 0,
            
            switchTab: (id) => {
                document.querySelectorAll('.wechat-tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-tab-'+id).classList.add('active');
                ['chat','contacts','discovery','me'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden')); document.getElementById('tab-'+id).classList.remove('hidden');
                document.getElementById('wechat-header-title').textContent = {'chat':'微信','contacts':'通讯录','discovery':'发现','me':''}[id];
                if(id==='chat'||id==='contacts') WeChatUI.renderList();
            },
            openAddMenu: () => document.getElementById('wechat-add-menu').classList.toggle('hidden'),
            
            startCreateChar: () => {
                document.getElementById('wechat-add-menu').classList.add('hidden');
                document.getElementById('new-char-name-input').value = '';
                document.getElementById('modal-create-name').classList.remove('hidden');
            },
            confirmCreateName: () => {
                const name = document.getElementById('new-char-name-input').value.trim();
                if(!name) return alert('请输入名字');
                document.getElementById('modal-create-name').classList.add('hidden');
                WeChatUI.currentChatId = 'char_' + Date.now();
                const chars = Storage.get('wechat_chars', {});
                chars[WeChatUI.currentChatId] = { id: WeChatUI.currentChatId, name: name, avatar: '', msgs: [], emojis: [], unread: 0 };
                Storage.set('wechat_chars', chars);
                WeChatUI.openCharSettings(true);
            },
            // Initialize default test user if empty
            checkInit: () => {
                const chars = Storage.get('wechat_chars', {});
                if(Object.keys(chars).length === 0) {
                    const id = 'char_test_001';
                    chars[id] = { 
                        id: id, name: '测试酱', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Test', 
                        msgs: [{role: 'ai', content: '你好！我是测试酱，欢迎来到小手机系统。你可以试试发个红包或者撤回消息哦！', timestamp: Date.now(), type:'text'}], 
                        emojis: [], unread: 0, prompt: '你是一个活泼可爱的测试助手。' 
                    };
                    Storage.set('wechat_chars', chars);
                }
                
                // Initialize NPCs storage if empty
                const npcs = Storage.get('wechat_npcs', {});
                if(Object.keys(npcs).length === 0) {
                    Storage.set('wechat_npcs', {});
                }
                
                // Initialize moments storage if empty
                const moments = Storage.get('wechat_moments', []);
                if(moments.length === 0) {
                    Storage.set('wechat_moments', []);
                }
                
                // Initialize user profile if empty
                const userProfile = Storage.get('wechat_user_profile', {});
                if(Object.keys(userProfile).length === 0) {
                    Storage.set('wechat_user_profile', {
                        name: '我',
                        avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=User',
                        momentsBg: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800&q=80',
                        momentsFrequency: 'daily' // daily, weekly, monthly, never
                    });
                }
                
                // Start the scheduled moments generation if not already running
                if (!WeChatUI.momentsTimer) {
                    WeChatUI.startScheduledMoments();
                }
            },
            
            // Scheduled moments generation
            momentsTimer: null,
            
            // Calculate next generation time based on frequency
            getNextGenerationTime: (frequency) => {
                const now = new Date();
                const nextTime = new Date(now);
                
                switch(frequency) {
                    case 'daily':
                        nextTime.setDate(now.getDate() + 1);
                        nextTime.setHours(9, 0, 0, 0); // 每天早上9点
                        break;
                    case 'weekly':
                        nextTime.setDate(now.getDate() + (7 - now.getDay()));
                        nextTime.setHours(9, 0, 0, 0); // 每周一早上9点
                        break;
                    case 'monthly':
                        nextTime.setMonth(now.getMonth() + 1);
                        nextTime.setDate(1);
                        nextTime.setHours(9, 0, 0, 0); // 每月1号早上9点
                        break;
                    default:
                        return null; // Never generate
                }
                
                return nextTime;
            },
            
            // Start the scheduled moments generation
            startScheduledMoments: () => {
                // Clear existing timer if any
                if (WeChatUI.momentsTimer) {
                    clearTimeout(WeChatUI.momentsTimer);
                    WeChatUI.momentsTimer = null;
                }
                
                // Check frequency and schedule next generation
                const userProfile = Storage.get('wechat_user_profile', {});
                const frequency = userProfile.momentsFrequency || 'daily';
                
                if (frequency === 'never') {
                    return; // Don't generate moments automatically
                }
                
                // Get next generation time
                const nextTime = WeChatUI.getNextGenerationTime(frequency);
                if (!nextTime) {
                    return;
                }
                
                // Calculate delay in milliseconds
                const delay = nextTime.getTime() - Date.now();
                
                // Schedule the next generation
                WeChatUI.momentsTimer = setTimeout(async () => {
                    // Generate moments
                    await WeChatUI.generateMoments();
                    
                    // Schedule the next generation
                    WeChatUI.startScheduledMoments();
                }, delay);
            },
            
            // Update scheduled moments when frequency changes
            updateScheduledMoments: () => {
                WeChatUI.startScheduledMoments();
            },
            // NPC Management
            openNPCManager: () => {
                const modal = document.getElementById('modal-npc-manager');
                modal.classList.remove('hidden');
                WeChatUI.renderNPCList();
            },
            openRandomNPCModal: () => {
                const modal = document.getElementById('modal-random-npc');
                const charSelect = document.getElementById('random-npc-char-select');
                
                // Populate character options
                const chars = Storage.get('wechat_chars', {});
                const charOptions = Object.values(chars).map(char => `
                    <option value="${char.id}">${char.name}</option>
                `).join('');
                charSelect.innerHTML = charOptions;
                
                modal.classList.remove('hidden');
            },
            renderNPCList: () => {
                const npcs = Storage.get('wechat_npcs', {});
                const list = document.getElementById('npc-list');
                
                if(Object.keys(npcs).length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">暂无NPC，请添加</div>';
                    return;
                }
                
                list.innerHTML = Object.values(npcs).map(npc => `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg mb-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-md overflow-hidden">
                                <img src="${npc.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default40'}" alt="${npc.name}" class="w-full h-full object-cover">
                            </div>
                            <div>
                                <div class="font-medium">${npc.name}</div>
                                <div class="text-xs text-gray-500 truncate max-w-[200px]">${npc.personality || '暂无人设'}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="WeChatUI.editNPC('${npc.id}')" class="text-blue-400 hover:text-blue-300 text-sm">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="WeChatUI.deleteNPC('${npc.id}')" class="text-red-400 hover:text-red-300 text-sm">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },
            startCreateNPC: () => {
                document.getElementById('npc-form-title').textContent = '创建NPC';
                document.getElementById('npc-id').value = '';
                document.getElementById('npc-name').value = '';
                document.getElementById('npc-avatar').value = '';
                document.getElementById('npc-personality').value = '';
                
                // Populate character options
                WeChatUI.populateCharSelect();
                
                document.getElementById('modal-npc-form').classList.remove('hidden');
            },
            editNPC: (id) => {
                const npcs = Storage.get('wechat_npcs', {});
                const npc = npcs[id];
                if(!npc) return;
                
                document.getElementById('npc-form-title').textContent = '编辑NPC';
                document.getElementById('npc-id').value = id;
                document.getElementById('npc-name').value = npc.name;
                document.getElementById('npc-avatar').value = npc.avatar || '';
                document.getElementById('npc-personality').value = npc.personality || '';
                
                // Populate character options and set selected value
                WeChatUI.populateCharSelect(npc.associatedChar);
                
                document.getElementById('modal-npc-form').classList.remove('hidden');
            },
            populateCharSelect: (selectedCharId = '') => {
                const chars = Storage.get('wechat_chars', {});
                const charSelect = document.getElementById('npc-char-select');
                
                const charOptions = Object.values(chars).map(char => `
                    <option value="${char.id}" ${selectedCharId === char.id ? 'selected' : ''}>${char.name}</option>
                `).join('');
                charSelect.innerHTML = charOptions;
            },
            addNPCToList: () => {
                const charId = document.getElementById('npc-char-select').value;
                const npcId = document.getElementById('npc-id').value;
                
                if(!charId || !npcId) return alert('请先保存NPC并选择关联角色');
                
                const chars = Storage.get('wechat_chars', {});
                const npcs = Storage.get('wechat_npcs', {});
                
                if(!chars[charId] || !npcs[npcId]) return alert('角色或NPC不存在');
                
                // Add NPC to character's bound NPCs
                if(!chars[charId].boundNPCs) chars[charId].boundNPCs = [];
                if(!chars[charId].boundNPCs.includes(npcId)) {
                    chars[charId].boundNPCs.push(npcId);
                    Storage.set('wechat_chars', chars);
                    Utils.showToast('NPC已添加到角色列表');
                } else {
                    Utils.showToast('NPC已在角色列表中');
                }
            },
            saveNPC: () => {
                const id = document.getElementById('npc-id').value;
                const name = document.getElementById('npc-name').value.trim();
                const avatar = document.getElementById('npc-avatar').value.trim();
                const personality = document.getElementById('npc-personality').value.trim();
                const charId = document.getElementById('npc-char-select').value;
                
                if(!name) return alert('请输入NPC名字');
                
                const npcs = Storage.get('wechat_npcs', {});
                const npcId = id || 'npc_' + Date.now();
                
                npcs[npcId] = {
                    id: npcId,
                    name: name,
                    avatar: avatar,
                    personality: personality,
                    associatedChar: charId
                };
                
                Storage.set('wechat_npcs', npcs);
                document.getElementById('modal-npc-form').classList.add('hidden');
                WeChatUI.renderNPCList();
            },
            deleteNPC: (id) => {
                if(!confirm('确定删除此NPC吗？')) return;
                
                const npcs = Storage.get('wechat_npcs', {});
                delete npcs[id];
                Storage.set('wechat_npcs', npcs);
                
                // Remove this NPC from all characters' bound NPCs
                const chars = Storage.get('wechat_chars', {});
                Object.values(chars).forEach(char => {
                    if(char.boundNPCs) {
                        char.boundNPCs = char.boundNPCs.filter(npcId => npcId !== id);
                    }
                });
                Storage.set('wechat_chars', chars);
                
                WeChatUI.renderNPCList();
            },
            generateRandomNPCs: async () => {
                const charId = document.getElementById('random-npc-char-select').value;
                const count = parseInt(document.getElementById('random-npc-count').value);
                const type = document.getElementById('random-npc-type').value;
                
                if(!charId) return alert('请选择关联角色');
                
                const chars = Storage.get('wechat_chars', {});
                const char = chars[charId];
                if(!char) return alert('角色不存在');
                
                // Generate random NPCs
                const npcs = Storage.get('wechat_npcs', {});
                const newNPCs = [];
                
                // Name lists for different genders
                const maleNames = ['张伟', '李强', '王芳', '刘勇', '陈静', '杨明', '赵娜', '黄伟', '周强', '吴芳'];
                const femaleNames = ['李娜', '王静', '张敏', '刘芳', '陈丽', '杨芳', '赵静', '黄静', '周芳', '吴静'];
                
                // Personality templates for different types
                const personalityTemplates = {
                    friend: [
                        '性格开朗，喜欢交朋友，经常组织聚会',
                        '爱好广泛，喜欢运动和旅行，是个乐观主义者',
                        '心思细腻，善于倾听，是个很好的倾诉对象',
                        '幽默风趣，总能给身边的人带来快乐',
                        '热情好客，喜欢烹饪，经常邀请朋友到家里做客'
                    ],
                    family: [
                        '温柔体贴，非常关心家人，是家庭的核心',
                        '严厉但公正，对家人要求严格但充满爱心',
                        '慈祥善良，喜欢照顾晚辈，总是把最好的留给家人',
                        '活泼可爱，像个永远长不大的孩子，给家庭带来欢乐',
                        '成熟稳重，是家庭的顶梁柱，遇到事情总能冷静处理'
                    ],
                    colleague: [
                        '工作认真负责，是团队中的骨干成员',
                        '聪明伶俐，总能想出好点子，解决工作中的难题',
                        '为人谦逊，乐于助人，经常帮助同事解决问题',
                        '效率极高，总是能提前完成任务，是个工作狂',
                        '善于沟通，是团队中的协调者，总能化解矛盾'
                    ],
                    stranger: [
                        '神秘莫测，总是独来独往，很少与人交流',
                        '热情主动，喜欢与人攀谈，很快就能熟络起来',
                        '看起来很普通，但似乎隐藏着不为人知的秘密',
                        '举止优雅，气质不凡，给人一种高贵的感觉',
                        '穿着随意，看起来很随和，容易让人产生亲近感'
                    ]
                };
                
                for(let i = 0; i < count; i++) {
                    // Generate random gender
                    const gender = Math.random() > 0.5 ? 'male' : 'female';
                    
                    // Generate random name
                    const nameList = gender === 'male' ? maleNames : femaleNames;
                    const name = nameList[Math.floor(Math.random() * nameList.length)] + Math.floor(Math.random() * 100);
                    
                    // Generate random type if needed
                    const actualType = type === 'random' ? Object.keys(personalityTemplates)[Math.floor(Math.random() * Object.keys(personalityTemplates).length)] : type;
                    
                    // Generate random personality
                    const templates = personalityTemplates[actualType];
                    const personality = templates[Math.floor(Math.random() * templates.length)];
                    
                    // Generate avatar using Pollinations API
                    const avatarPrompt = `${gender === 'male' ? 'male' : 'female'} person, portrait, cartoon style, ${actualType === 'friend' ? 'friendly' : actualType === 'family' ? 'warm' : actualType === 'colleague' ? 'professional' : 'mysterious'}, simple background`;
                    const avatarUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(avatarPrompt)}?width=128&height=128&seed=${Math.random() * 1000000}`;
                    
                    // Create NPC object
                    const npcId = 'npc_random_' + Date.now() + '_' + i;
                    const npc = {
                        id: npcId,
                        name: name,
                        avatar: avatarUrl,
                        personality: personality,
                        type: actualType,
                        gender: gender,
                        associatedChar: charId
                    };
                    
                    npcs[npcId] = npc;
                    newNPCs.push(npcId);
                }
                
                // Save NPCs to storage
                Storage.set('wechat_npcs', npcs);
                
                // Associate NPCs with the character
                if(!char.boundNPCs) char.boundNPCs = [];
                char.boundNPCs.push(...newNPCs);
                Storage.set('wechat_chars', chars);
                
                // Close modal and refresh UI
                document.getElementById('modal-random-npc').classList.add('hidden');
                WeChatUI.renderNPCList();
                Utils.showToast(`成功生成${count}个NPC`);
            },
            // Calculate token count based on message content
            calculateTokenCount: (messages) => {
    if (!messages || messages.length === 0) return 0;
    
    let totalTokens = 0;
    messages.forEach(msg => {
        // 如果是图片，只算 100 Token 意思一下
        if (msg.type === 'image') {
            totalTokens += 100; 
        } 
        else if (msg.content) {
            const content = msg.content;
            const chineseChars = (content.match(/[\u4e00-\u9fa5]/g) || []).length;
            const englishWords = (content.match(/\b[a-zA-Z]+\b/g) || []).length;
            const otherChars = content.length - chineseChars - englishWords;
            totalTokens += chineseChars + englishWords + Math.ceil(otherChars * 0.5);
        }
    });
    return totalTokens;
},
            
            openCharSettings: (isNew = false) => {
                const cid = isNew ? WeChatUI.currentChatId : document.getElementById('subpage-chat-detail').dataset.charId;
                if(!cid) return;
                WeChatUI.currentChatId = cid;
                const c = Storage.get('wechat_chars', {})[cid];
                document.getElementById('char-name').value = c.name;
                WeChatUI.renderAvatarPreview('char-avatar-preview', c.avatar);
                document.getElementById('char-avatar-data').value = c.avatar || '';
                document.getElementById('char-nickname').value = c.nickname || '';
                document.getElementById('char-prompt').value = c.prompt || '';
                document.getElementById('char-user-name').value = c.userName || '';
                WeChatUI.renderAvatarPreview('user-avatar-preview', c.userAvatar);
                document.getElementById('user-avatar-data').value = c.userAvatar || '';
                // document.getElementById('char-worldbook').checked = c.worldbook || false; // Deprecated checkbox
                document.getElementById('stat-chat-count').textContent = (c.msgs || []).length;
                
                // Calculate and display token count
                const tokenCount = WeChatUI.calculateTokenCount(c.msgs || []);
                document.getElementById('stat-token-count').textContent = tokenCount;
                
                document.getElementById('char-context-limit').value = c.contextLimit || 20;
                document.getElementById('char-summary-limit').value = c.summaryLimit || 50;
                document.getElementById('char-auto-summary').checked = c.autoSummary || false;
                document.getElementById('char-summary-prompt').value = c.summaryPrompt || '请以第三人称总结上下文对话中的关键信息，包括主要话题、重要事件、人物关系和关键细节，存入记忆库。保持简洁明了，重点突出。';
                
                document.getElementById('char-avatar-shape').value = c.avatarShape || 'square';
                document.getElementById('char-bubble-css').value = c.bubbleCss || '';
                document.getElementById('char-chat-bg').value = c.chatBg || '';
                document.getElementById('char-bg-blur').value = c.bgBlur || 0;
                document.getElementById('char-bg-opacity').value = c.bgOpacity !== undefined ? c.bgOpacity : 1;
                document.getElementById('char-bubble-size').value = c.bubbleFontSize || 15;
                document.getElementById('char-tts-enabled').checked = c.ttsEnabled || false;
                document.getElementById('char-voice-id').value = c.voiceId || '';
                document.getElementById('char-voice-speed').value = c.voiceSpeed || 1.0;
                document.getElementById('char-time-aware').checked = c.timeAware || false;
                document.getElementById('char-virtual-time').value = c.virtualTime || '';
                WeChatUI.toggleTimeSetting();
                WeChatUI.updateBgPreview();
                WeChatUI.updateEmojiCategories();
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
                
                // Render NPC binding list
                WeChatUI.renderNPCBindingList(cid);
                
                // Render Worldbook List for this char
                WorldbookUI.renderSettingsList();

                document.getElementById('subpage-char-settings').classList.add('active');
            HistoryManager.push('subpage-char-settings');
            },
            renderNPCBindingList: (cid) => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[cid];
                const npcs = Storage.get('wechat_npcs', {});
                const npcList = Object.values(npcs);
                const bindingList = document.getElementById('npc-binding-list');
                
                if(npcList.length === 0) {
                    bindingList.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">暂无NPC，请先添加NPC</div>';
                    return;
                }
                
                const boundNPCs = c.boundNPCs || [];
                bindingList.innerHTML = npcList.map(npc => {
                    const isBound = boundNPCs.includes(npc.id);
                    return `
                        <div class="flex items-center justify-between p-2 bg-gray-800/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-md overflow-hidden">
                                    <img src="${npc.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default32'}" alt="${npc.name}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium truncate">${npc.name}</div>
                                    <div class="text-xs text-gray-500 truncate">${npc.personality || '暂无人设'}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" 
                                       id="npc-bound-${npc.id}" 
                                       ${isBound ? 'checked' : ''} 
                                       onchange="WeChatUI.toggleNPCBinding('${cid}', '${npc.id}')"
                                       class="toggle-switch">
                            </div>
                        </div>
                    `;
                }).join('');
            },
            toggleNPCBinding: (cid, npcId) => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[cid];
                if(!c.boundNPCs) c.boundNPCs = [];
                
                const index = c.boundNPCs.indexOf(npcId);
                if(index > -1) {
                    c.boundNPCs.splice(index, 1);
                } else {
                    c.boundNPCs.push(npcId);
                }
                
                Storage.set('wechat_chars', chars);
                WeChatUI.renderNPCBindingList(cid);
            },
            saveCharacter: () => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                c.name = document.getElementById('char-name').value;
                c.avatar = document.getElementById('char-avatar-data').value;
                c.nickname = document.getElementById('char-nickname').value;
                c.prompt = document.getElementById('char-prompt').value;
                c.userName = document.getElementById('char-user-name').value;
                c.userAvatar = document.getElementById('user-avatar-data').value;
                // c.worldbook = document.getElementById('char-worldbook').checked; // Managed by WorldbookUI now
                c.contextLimit = parseInt(document.getElementById('char-context-limit').value) || 20;
                c.summaryLimit = parseInt(document.getElementById('char-summary-limit').value) || 50;
                c.autoSummary = document.getElementById('char-auto-summary').checked;
                c.summaryPrompt = document.getElementById('char-summary-prompt').value;
                c.avatarShape = document.getElementById('char-avatar-shape').value;
                c.bubbleCss = document.getElementById('char-bubble-css').value;
                c.bubbleFontSize = document.getElementById('char-bubble-size').value;
                c.chatBg = document.getElementById('char-chat-bg').value;
                c.bgBlur = document.getElementById('char-bg-blur').value;
                c.bgOpacity = document.getElementById('char-bg-opacity').value;
                c.ttsEnabled = document.getElementById('char-tts-enabled').checked;
                c.voiceId = document.getElementById('char-voice-id').value;
                c.voiceSpeed = document.getElementById('char-voice-speed').value;
                c.timeAware = document.getElementById('char-time-aware').checked;
                c.virtualTime = document.getElementById('char-virtual-time').value;
                Storage.set('wechat_chars', chars);
                Utils.showToast('角色已保存');
                document.getElementById('subpage-char-settings').classList.remove('active');
                WeChatUI.renderList();
                if(document.getElementById('subpage-chat-detail').classList.contains('active')) WeChatUI.loadChat(c.id);
            },
            toggleTimeSetting: () => {
                const isAware = document.getElementById('char-time-aware').checked;
                const container = document.getElementById('virtual-time-container');
                if(isAware) container.classList.add('hidden');
                else container.classList.remove('hidden');
            },
            promptAvatarUrl: () => { Utils.showPrompt('上传头像', '输入图片URL:', (url) => { if(url) { document.getElementById('char-avatar-data').value = url; WeChatUI.renderAvatarPreview('char-avatar-preview', url); } }); },
            handleAvatarFile: (input) => { if(input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('char-avatar-data').value = base64; WeChatUI.renderAvatarPreview('char-avatar-preview', base64); }); },
            handleUserAvatarFile: (input) => { if(input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('user-avatar-data').value = base64; WeChatUI.renderAvatarPreview('user-avatar-preview', base64); }); },
            handleNPCAvatarFile: (input) => { if(input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('npc-avatar').value = base64; }); },
            renderAvatarPreview: (id, src) => { document.getElementById(id).innerHTML = src ? `<img src="${src}">` : '<span class="text-xs text-gray-400">头像</span>'; },
            openEmojiUpload: () => document.getElementById('modal-emoji-upload').classList.remove('hidden'),
            confirmEmojiUpload: () => {
                const input = document.getElementById('emoji-url-input').value;
                const lines = input.split('\n').filter(line => line.trim());
                const emojis = [];
                const selectedCategory = document.getElementById('emoji-category-select')?.value || 'default';
                const emojiType = document.getElementById('emoji-type-select')?.value || 'exclusive';
                
                lines.forEach(line => {
                    const match = line.match(/^(.*?)\s*：\s*`?([^`]+)`?$/);
                    if (match) {
                        const name = match[1].trim();
                        const url = match[2].trim();
                        emojis.push({ name, url, category: selectedCategory, type: emojiType });
                    } else {
                        const simpleMatch = line.match(/^(.*?)\s*:\s*`?([^`]+)`?$/);
                        if (simpleMatch) {
                            const name = simpleMatch[1].trim();
                            const url = simpleMatch[2].trim();
                            emojis.push({ name, url, category: selectedCategory, type: emojiType });
                        } else {
                            emojis.push({ name: '未知表情', url: line.trim(), category: selectedCategory, type: emojiType });
                        }
                    }
                });
                
                const chars = Storage.get('wechat_chars', {}); 
                const c = chars[WeChatUI.currentChatId];
                
                if (emojiType === 'global') {
                    // Save to global emojis
                    let globalEmojis = Storage.get('wechat_global_emojis', []);
                    globalEmojis.push(...emojis);
                    Storage.set('wechat_global_emojis', globalEmojis);
                } else {
                    // Save to character-specific emojis
                    if(!c.emojis) c.emojis = [];
                    if(!c.emojiCategories) c.emojiCategories = ['default'];
                    c.emojis.push(...emojis); 
                    Storage.set('wechat_chars', chars);
                }
                
                WeChatUI.updateEmojiCategories();
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
                document.getElementById('modal-emoji-upload').classList.add('hidden');
            },
            openEmojiCategories: () => {
                const modal = document.getElementById('modal-emoji-categories');
                modal.classList.remove('hidden');
                WeChatUI.renderEmojiCategories();
            },
            renderEmojiCategories: () => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const categories = c.emojiCategories || ['default'];
                const list = document.getElementById('emoji-categories-list');
                
                list.innerHTML = categories.map((category, index) => {
                    if(category === 'default') {
                        return `<div class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                            <span class="text-sm">${category === 'default' ? '默认分类' : category}</span>
                            <span class="text-xs text-gray-500">不可删除</span>
                        </div>`;
                    }
                    return `<div class="flex items-center justify-between p-2 bg-gray-800/50 rounded-lg">
                        <span class="text-sm">${category}</span>
                        <button onclick="WeChatUI.deleteEmojiCategory(${index})" class="text-xs text-red-400 hover:text-red-300">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>`;
                }).join('');
            },
            addEmojiCategory: () => {
                const name = document.getElementById('new-category-name').value.trim();
                if(!name) return;
                
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                if(!c.emojiCategories) c.emojiCategories = ['default'];
                
                if(!c.emojiCategories.includes(name)) {
                    c.emojiCategories.push(name);
                    Storage.set('wechat_chars', chars);
                    WeChatUI.renderEmojiCategories();
                    WeChatUI.updateEmojiCategories();
                    document.getElementById('new-category-name').value = '';
                }
            },
            deleteEmojiCategory: (index) => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                if(!c.emojiCategories || index === 0) return;
                
                const categoryToDelete = c.emojiCategories[index];
                c.emojiCategories.splice(index, 1);
                
                // 将该分类下的表情包移到默认分类
                c.emojis.forEach(emoji => {
                    if(emoji.category === categoryToDelete) {
                        emoji.category = 'default';
                    }
                });
                
                Storage.set('wechat_chars', chars);
                WeChatUI.renderEmojiCategories();
                WeChatUI.updateEmojiCategories();
                WeChatUI.renderEmojiGrid(c.emojis);
            },
            updateEmojiCategories: () => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const categories = c.emojiCategories || ['default'];
                const select = document.getElementById('emoji-category-select');
                
                if(select) {
                    const currentValue = select.value;
                    select.innerHTML = `<option value="">所有分类</option>` + 
                        categories.map(category => `<option value="${category}">${category === 'default' ? '默认分类' : category}</option>`).join('');
                    select.value = currentValue;
                }
            },
            filterEmojisByCategory: () => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const selectedCategory = document.getElementById('emoji-category-select').value;
                const allEmojis = WeChatUI.getAllEmojis();
                
                if(selectedCategory === '') {
                    WeChatUI.renderEmojiGrid(allEmojis);
                } else {
                    const filtered = allEmojis.filter(emoji => emoji.category === selectedCategory);
                    WeChatUI.renderEmojiGrid(filtered);
                }
            },
            renderEmojiGrid: (list) => {
                document.getElementById('emoji-grid').innerHTML = list.map((emoji, index) => `
                    <div class="emoji-item relative">
                        <img src="${emoji.url || emoji}" alt="${emoji.name || '表情'}">
                        <div class="text-[10px] text-center text-gray-400 truncate px-1 py-0.5 bg-black/50">${emoji.name || '未知表情'}</div>
                        <div class="absolute top-1 left-1 bg-blue-500/80 text-white text-[6px] px-1.5 py-0.5 rounded-full">
                            ${emoji.type === 'global' ? '全局' : '专属'}
                        </div>
                        <button onclick="WeChatUI.deleteEmoji(${index})" class="absolute top-1 right-1 w-5 h-5 bg-red-500/80 text-white rounded-full flex items-center justify-center text-[8px] hover:bg-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },
            getAllEmojis: () => {
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const globalEmojis = Storage.get('wechat_global_emojis', []);
                const charEmojis = c.emojis || [];
                return [...globalEmojis, ...charEmojis];
            },
            deleteEmoji: (index) => {
                const allEmojis = WeChatUI.getAllEmojis();
                const globalEmojis = Storage.get('wechat_global_emojis', []);
                const chars = Storage.get('wechat_chars', {});
                const c = chars[WeChatUI.currentChatId];
                const charEmojis = c.emojis || [];
                
                if (index < globalEmojis.length) {
                    // Delete from global emojis
                    globalEmojis.splice(index, 1);
                    Storage.set('wechat_global_emojis', globalEmojis);
                } else {
                    // Delete from character emojis
                    const charIndex = index - globalEmojis.length;
                    if(charEmojis.length > charIndex) {
                        charEmojis.splice(charIndex, 1);
                        c.emojis = charEmojis;
                        Storage.set('wechat_chars', chars);
                    }
                }
                
                WeChatUI.renderEmojiGrid(WeChatUI.getAllEmojis());
                Utils.showToast('表情包已删除');
            },
            showEmojiPicker: () => {
                const panel = document.getElementById('emoji-panel');
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                const c = chars[cid];
                const globalEmojis = Storage.get('wechat_global_emojis', []);
                const charEmojis = c.emojis || [];
                const allEmojis = [...globalEmojis, ...charEmojis];
                
                if (panel.style.display === 'grid') {
                    panel.style.display = 'none';
                } else {
                    // 1. 清除旧样式干扰
                    panel.removeAttribute('style');
                    
                    // 2. 设置面板样式 (浅灰底色，固定高度，三列布局)
                    panel.style.display = 'grid';
                    panel.style.gridTemplateColumns = 'repeat(3, 1fr)'; // 3列，像图二那样
                    panel.style.gap = '10px';
                    panel.style.padding = '15px';
                    panel.style.backgroundColor = '#F2F2F2'; // 浅灰色背景
                    panel.style.height = '260px'; // 加高面板，方便浏览
                    panel.style.overflowY = 'auto';
                    panel.style.borderTop = '1px solid #e5e5e5';
                    panel.style.marginTop = '0'; 
                    
                    if (allEmojis.length > 0) {
                        panel.innerHTML = allEmojis.map((emoji, index) => {
                            const name = emoji.name || '表情';
                            // 注意：这里没有使用 emoji-btn 类，完全避免样式冲突
                            return `
                            <div class="bg-white rounded-xl p-2 flex flex-col items-center cursor-pointer shadow-sm relative border border-gray-200 active:scale-95 transition-transform" 
                                 style="height: 110px; min-height: 110px;"
                                 onclick="WeChatUI.pushMessage('image', '${emoji.url || emoji}', 'user', 'image', '${encodeURIComponent(name)}')">
                                
                                <div class="flex-1 w-full flex items-center justify-center overflow-hidden p-1">
                                    <img src="${emoji.url || emoji}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                </div>
                                
                                <div class="text-[10px] text-gray-600 truncate w-full text-center mt-1 h-4 leading-4">
                                    ${name}
                                </div>
                                
                                <div class="absolute top-1 right-1 text-[8px] px-1.5 py-0.5 rounded-full ${emoji.type === 'global' ? 'bg-blue-50 text-blue-400' : 'bg-pink-50 text-pink-400'}">
                                    ${emoji.type === 'global' ? '全' : '专'}
                                </div>
                            </div>
                            `;
                        }).join('');
                    } else {
                        panel.innerHTML = '<div class="col-span-3 text-center text-gray-400 text-sm py-10">暂无表情包<br>请去“角色设置”添加</div>';
                    }
                    
                    // 滚动到底部
                    setTimeout(() => document.getElementById('chat-messages-container').scrollTop = 99999, 100);
                }
            },
            // 打开记忆库并渲染列表
            openMemoryLib: () => {
                const cid = WeChatUI.currentChatId;
                if (!cid) return;
                const char = Storage.get('wechat_chars', {})[cid];
                
                // 1. 找到容器
                const container = document.querySelector('#modal-memory-lib .overflow-y-auto');
                if (!container) return;

                // 2. 读取数据
                const memories = char.memory || [];
                
                // 3. 渲染
                if (memories.length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-400 text-center py-10">暂无记忆摘要<br>（自动总结达到条数触发，或点击“手动总结”）</div>';
                } else {
                    container.innerHTML = memories.map((m, idx) => `
                        <div class="bg-gray-800/50 p-3 rounded-lg mb-2 text-left relative group border border-white/5">
                            <div class="text-[10px] text-green-500 mb-1 flex justify-between">
                                <span>📅 ${new Date(m.timestamp).toLocaleString()}</span>
                                <span class="bg-blue-500/20 px-1 rounded text-blue-300">摘要</span>
                            </div>
                            <div class="text-xs text-gray-300 leading-relaxed whitespace-pre-wrap select-text">${m.content}</div>
                            <button onclick="WeChatUI.deleteMemory('${cid}', ${idx})" class="absolute top-2 right-2 text-red-400 opacity-60 hover:opacity-100 p-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
                document.getElementById('modal-memory-lib').classList.remove('hidden');
            },

            // 删除单条记忆
            deleteMemory: (cid, idx) => {
                if (!confirm('确定删除这条记忆吗？')) return;
                const chars = Storage.get('wechat_chars', {});
                if (chars[cid] && chars[cid].memory) {
                    chars[cid].memory.splice(idx, 1);
                    Storage.set('wechat_chars', chars);
                    WeChatUI.openMemoryLib(); // 刷新显示
                    Utils.showToast('已删除');
                }
            },
            
            // 手动触发总结
            triggerManualSummary: () => {
                const cid = WeChatUI.currentChatId;
                if(!cid) return;
                
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char || !char.msgs || char.msgs.length === 0) {
                    Utils.showToast('没有可总结的聊天记录');
                    return;
                }
                
                // 显示手动总结弹窗
                document.getElementById('modal-manual-summary').classList.remove('hidden');
            },
            
            // 取消手动总结
            cancelManualSummary: () => {
                document.getElementById('modal-manual-summary').classList.add('hidden');
            },
            
            // 确认手动总结
            confirmManualSummary: async () => {
                const cid = WeChatUI.currentChatId;
                if(!cid) return;
                
                const rangeInput = document.getElementById('summary-range-input').value.trim();
                const rangeRegex = /^(\d+)-(\d+)$/;
                const match = rangeInput.match(rangeRegex);
                
                let startIndex, endIndex;
                
                if (match) {
                    // 解析用户输入的区间
                    startIndex = parseInt(match[1]) - 1; // 转换为0-based索引
                    endIndex = parseInt(match[2]); // 转换为不包含的结束索引
                } else {
                    // 默认总结所有消息
                    startIndex = 0;
                    endIndex = undefined;
                }
                
                // 隐藏弹窗
                document.getElementById('modal-manual-summary').classList.add('hidden');
                
                // 生成总结
                await WeChatUI.generateSummary(cid, startIndex, endIndex);
            },
            
            // 生成总结
            generateSummary: async (cid, startIndex = undefined, endIndex = undefined) => {
    const chars = Storage.get('wechat_chars', {});
    const char = chars[cid];
    if(!char || !char.msgs || char.msgs.length === 0) return;
    
    Utils.showToast('正在分析上下文...');

    const summaryPrompt = char.summaryPrompt || '请以第三人称总结上下文对话中的关键信息，包括主要话题、重要事件、人物关系和关键细节，存入记忆库。保持简洁明了，重点突出。';
    
    const msgs = char.msgs;
    let targetMsgs;
    
    if (startIndex !== undefined && endIndex !== undefined) {
        targetMsgs = msgs.slice(startIndex, endIndex);
    } else if (startIndex !== undefined) {
        targetMsgs = msgs.slice(startIndex);
    } else {
        const summaryLimit = char.summaryLimit || 50;
        targetMsgs = msgs.slice(-summaryLimit);
    }
    
    if (targetMsgs.length === 0) {
        Utils.showToast('指定区间内没有消息');
        return;
    }
    
    // 【清洗数据】把图片Base64替换成短文本
    const cleanMessages = [
        { role: 'system', content: summaryPrompt },
        ...targetMsgs.map(msg => {
            let contentStr = msg.content;
            if (msg.type === 'image') contentStr = '[用户发送了一张图片]'; 
            else if (msg.type === 'voice') contentStr = `[语音: ${msg.text}]`;
            else if (msg.type === 'redpacket') contentStr = `[红包: ${msg.note}]`;
            
            return {
                role: msg.role === 'user' ? 'user' : 'assistant',
                content: contentStr
            };
        })
    ];
    
    try {
        const summary = await SettingsLogic.generateLLM(cleanMessages, cid);
        WeChatUI.saveSummaryToMemory(cid, summary);
        Utils.showToast('总结已生成并存入记忆库');
        
        if(document.getElementById('subpage-char-settings').classList.contains('active')){
            const tokenCount = WeChatUI.calculateTokenCount(char.msgs || []);
            document.getElementById('stat-token-count').textContent = tokenCount;
        }
    } catch (error) {
        console.error('生成总结失败:', error);
        // 显示真实错误
        Utils.showToast('错误: ' + error.message);
    }
},
            
            // 保存总结到记忆库
            saveSummaryToMemory: (cid, summary) => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char) return;
                
                // 初始化记忆库
                if(!char.memory) char.memory = [];
                
                // 添加新总结
                const memoryItem = {
                    id: Date.now(),
                    type: 'summary',
                    content: summary,
                    timestamp: new Date().toISOString()
                };
                
                char.memory.push(memoryItem);
                Storage.set('wechat_chars', chars);
            },
            
            // 通用记忆注入函数
            injectMemory: (cid, content, type = 'summary') => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char) return;
                
                // 初始化记忆库
                if(!char.memory) char.memory = [];
                
                // 添加新记忆
                const memoryItem = {
                    id: Date.now(),
                    type: type,
                    content: content,
                    timestamp: new Date().toISOString()
                };
                
                char.memory.push(memoryItem);
                Storage.set('wechat_chars', chars);
            },
            
            // 通知角色关于用户的新朋友圈
            notifyCharsAboutNewMoment: (moment) => {
                const chars = Storage.get('wechat_chars', {});
                const userProfile = Storage.get('wechat_user_profile', {name:'我'});
                
                // 遍历所有角色，发送通知
                Object.keys(chars).forEach(cid => {
                    const char = chars[cid];
                    if(char && char.memory) {
                        // 注入记忆
                        const memoryContent = `${userProfile.name}在朋友圈发布了一条动态："${moment.content}"`;
                        WeChatUI.injectMemory(cid, memoryContent, 'moment');
                        
                        // 可以在这里添加AI互动逻辑，让角色主动评论或点赞
                    }
                });
            },
            
            // 检查是否需要自动总结
            checkAutoSummary: (cid) => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char || !char.autoSummary) return;
                
                const msgs = char.msgs || [];
                const summaryLimit = char.summaryLimit || 50;
                
                // 检查是否达到总结条数
                if(msgs.length >= summaryLimit && msgs.length % summaryLimit === 0) {
                    WeChatUI.generateSummary(cid);
                }
            },
            
            // 导出聊天记录
            exportChatHistory: () => {
                const cid = WeChatUI.currentChatId;
                if(!cid) return;
                
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char || !char.msgs || char.msgs.length === 0) {
                    Utils.showToast('没有可导出的聊天记录');
                    return;
                }
                
                // 构建聊天记录文本
                let chatText = `${char.name} 聊天记录\n`;
                chatText += `生成时间：${new Date().toLocaleString()}\n\n`;
                
                char.msgs.forEach(msg => {
                    const time = new Date(msg.timestamp || Date.now()).toLocaleString();
                    const role = msg.role === 'user' ? '我' : char.name;
                    chatText += `${time} ${role}: ${msg.content}\n\n`;
                });
                
                // 创建下载链接
                const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${char.name}_聊天记录_${new Date().getTime()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                Utils.showToast('聊天记录已导出');
            },
            
            // 导入聊天记录
            importChatHistory: () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        WeChatUI.parseImportedChat(content);
                    };
                    reader.readAsText(file, 'utf-8');
                };
                input.click();
            },
            
            // 解析导入的聊天记录
            parseImportedChat: (content) => {
                const cid = WeChatUI.currentChatId;
                if(!cid) return;
                
                const chars = Storage.get('wechat_chars', {});
                const char = chars[cid];
                if(!char) return;
                
                // 这里可以根据实际的聊天记录格式进行解析
                // 暂时简单处理，将每行作为一条消息
                const lines = content.split('\n').filter(line => line.trim());
                const importedMsgs = [];
                
                lines.forEach(line => {
                    // 简单判断消息角色
                    if(line.includes('我:')) {
                        importedMsgs.push({
                            role: 'user',
                            content: line.replace(/^.*我:/, '').trim(),
                            timestamp: Date.now()
                        });
                    } else if(line.includes(char.name + ':')) {
                        importedMsgs.push({
                            role: 'ai',
                            content: line.replace(new RegExp(`^.*${char.name}:`), '').trim(),
                            timestamp: Date.now()
                        });
                    }
                });
                
                // 合并聊天记录
                if(!char.msgs) char.msgs = [];
                char.msgs = [...char.msgs, ...importedMsgs];
                
                Storage.set('wechat_chars', chars);
                Utils.showToast(`成功导入 ${importedMsgs.length} 条聊天记录`);
                
                // 更新聊天界面
                if(document.getElementById('subpage-chat-detail').classList.contains('active')) {
                    WeChatUI.loadChat(cid);
                }
            },
            handleChatBgFile: (input) => { if(input.files[0]) Utils.compressImage(input.files[0]).then(base64 => { document.getElementById('char-chat-bg').value = base64; WeChatUI.updateBgPreview(); }); },
            updateBgPreview: () => {
                const url = document.getElementById('char-chat-bg').value; const css = document.getElementById('char-bubble-css').value; const blur = document.getElementById('char-bg-blur').value; const opacity = document.getElementById('char-bg-opacity').value; const fontSize = document.getElementById('char-bubble-size').value;
                const bgEl = document.getElementById('preview-chat-bg');
                bgEl.style.backgroundImage = url ? `url(${url})` : 'none';
                bgEl.style.filter = `blur(${blur}px) opacity(${opacity})`;
                const styleStr = `${css}; font-size: ${fontSize}px;`;
                document.getElementById('preview-bubble-self').style.cssText = styleStr; document.getElementById('preview-bubble-other').style.cssText = styleStr;
                const shape = document.getElementById('char-avatar-shape').value; const cls = shape==='circle'?'rounded-full':'rounded-md';
                document.getElementById('preview-avatar-other').className = `msg-avatar ${cls}`; document.getElementById('preview-avatar-self').className = `msg-avatar ${cls}`;
            },
            loadPresetsList: () => {
                const presets = Storage.get('bubble_presets', {}); const sel = document.getElementById('bubble-preset-select');
                sel.innerHTML = '<option value="" disabled selected>选择预设...</option>' + Object.keys(presets).map(k => `<option value="${k}">${k}</option>`).join('');
            },
            saveBubblePreset: () => {
                Utils.showPrompt('保存预设', '输入预设名称:', (name) => {
                    if(!name) return;
                    const presets = Storage.get('bubble_presets', {});
                    presets[name] = { css: document.getElementById('char-bubble-css').value, fontSize: document.getElementById('char-bubble-size').value };
                    Storage.set('bubble_presets', presets); 
                    WeChatUI.loadPresetsList();
                });
            },
            loadBubblePreset: () => {
                const name = document.getElementById('bubble-preset-select').value; const presets = Storage.get('bubble_presets', {});
                if(presets[name]) { document.getElementById('char-bubble-css').value = presets[name].css; document.getElementById('char-bubble-size').value = presets[name].fontSize; WeChatUI.updateBgPreview(); }
            },
            deleteBubblePreset: () => {
                const name = document.getElementById('bubble-preset-select').value; if(!name) return;
                const presets = Storage.get('bubble_presets', {}); delete presets[name]; Storage.set('bubble_presets', presets); WeChatUI.loadPresetsList();
            },
            renderList: () => {
                const chars = Storage.get('wechat_chars', {});
                const npcs = Storage.get('wechat_npcs', {});
                
                const html = Object.values(chars).map(c => {
                    const lastMsg = c.msgs && c.msgs.length > 0 ? c.msgs[c.msgs.length - 1] : null;
                    let previewText = '';
                    if (lastMsg) {
                        if (lastMsg.type === 'image') previewText = '[图片]';
                        else if (lastMsg.type === 'voice') previewText = '[语音]';
                        else if (lastMsg.type === 'transfer') previewText = '[转账]';
                        else if (lastMsg.type === 'redpacket') previewText = '[红包]';
                        else {
                            // Strip HTML tags and limit length to prevent overflow
                            const text = String(lastMsg.content || '').replace(/<[^>]*>/g, '').trim();
                            previewText = text || '';
                        }
                    }
                    const timeDisplay = lastMsg && lastMsg.timestamp ? Utils.formatChatTime(lastMsg.timestamp) : '';
                    const unreadBadge = c.unread > 0 ? `<div class="unread-badge">${c.unread}</div>` : '';
                    return `<div onclick="WeChatUI.openChatDetail('${c.id}')" oncontextmenu="WeChatUI.showContactMenu(event, '${c.id}')" class="flex items-center gap-3 p-4 border-b border-gray-200 active:bg-gray-100 cursor-pointer relative"><div class="avatar-box relative"><img src="${c.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50'}">${unreadBadge}</div><div class="flex-1 min-w-0"><div class="flex justify-between items-baseline"><span class="font-medium text-base text-gray-900">${c.name}</span><span class="text-xs text-gray-500">${timeDisplay}</span></div><div class="text-sm text-gray-600 truncate">${previewText}</div></div></div>`;
                }).join('');
                document.getElementById('tab-chat').innerHTML = html || '<div class="text-gray-500 text-center mt-10 text-xs">暂无消息</div>';
                
                // Render contacts tab with NPCs under their associated characters
                let contactsHtml = '';
                Object.values(chars).forEach(char => {
                    // Add character
                    contactsHtml += `<div onclick="WeChatUI.openChatDetail('${char.id}')" oncontextmenu="WeChatUI.showContactMenu(event, '${char.id}')" class="flex items-center gap-3 p-3 border-b border-gray-200/50 active:bg-gray-100 rounded-lg"><div class="avatar-box"><img src="${char.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50'}"></div><span class="text-gray-900">${char.name}</span></div>`;
                    
                    // Add associated NPCs
                    const associatedNPCs = Object.values(npcs).filter(npc => npc.associatedChar === char.id);
                    if(associatedNPCs.length > 0) {
                        contactsHtml += `<div class="ml-12 pl-2 space-y-1 mb-2">`;
                        associatedNPCs.forEach(npc => {
                            contactsHtml += `<div onclick="WeChatUI.openNPCChat('${npc.id}', '${char.id}')" class="flex items-center gap-2 p-2 bg-gray-100/30 rounded-lg text-sm active:bg-gray-200/50">
                                <div class="w-6 h-6 rounded-full overflow-hidden">
                                    <img src="${npc.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default24'}" class="w-full h-full object-cover">
                                </div>
                                <span class="text-gray-900">${npc.name}</span>
                                <span class="text-xs text-gray-600">(${npc.type})</span>
                            </div>`;
                        });
                        contactsHtml += `</div>`;
                    }
                });
                document.getElementById('contacts-list-container').innerHTML = contactsHtml || '<div class="text-gray-500 text-center mt-10 text-xs">暂无联系人</div>';
            },
            openChatDetail: (id) => {
                const chars = Storage.get('wechat_chars', {});
                if(chars[id]) {
                    chars[id].unread = 0;
                    Storage.set('wechat_chars', chars);
                }
                WeChatUI.renderList();
                WeChatUI.loadChat(id);
                document.getElementById('subpage-chat-detail').dataset.charId = id;
                document.getElementById('subpage-chat-detail').dataset.npcId = '';
                document.getElementById('subpage-chat-detail').classList.add('active');
                HistoryManager.push('subpage-chat-detail');
            },
            openNPCChat: (npcId, charId) => {
                const chars = Storage.get('wechat_chars', {});
                const char = chars[charId];
                const npcs = Storage.get('wechat_npcs', {});
                const npc = npcs[npcId];
                
                if(!char || !npc) return;
                
                // Set chat detail data
                document.getElementById('subpage-chat-detail').dataset.charId = charId;
                document.getElementById('subpage-chat-detail').dataset.npcId = npcId;
                
                // Update chat title and avatar
                document.getElementById('chat-title').textContent = npc.name;
                
                // Load chat messages
                WeChatUI.loadChat(charId, npcId);
                
                // Show chat detail
                document.getElementById('subpage-chat-detail').classList.add('active');
  
                WeChatUI.renderList();
            },
            loadChat: (id, npcId = '') => {
                const c = Storage.get('wechat_chars', {})[id];
                const npcs = Storage.get('wechat_npcs', {});
                const npc = npcId ? npcs[npcId] : null;
                
                if(!c) return;
                
                // 1. 设置标题
                document.getElementById('chat-title').textContent = npc ? npc.name : c.name;
                
                // 2. 设置背景
                const bgLayer = document.getElementById('chat-bg-layer');
                if(c.chatBg) { bgLayer.style.backgroundImage = `url(${c.chatBg})`; bgLayer.style.filter = `blur(${c.bgBlur||0}px) opacity(${c.bgOpacity!==undefined?c.bgOpacity:1})`; } else { bgLayer.style.backgroundImage = ''; bgLayer.style.filter = ''; }
                
                // 3. 准备消息数据
                const shapeClass = c.avatarShape === 'circle' ? 'circle' : 'square';
                const msgs = c.msgs || [{role: 'ai', content: '你好！', timestamp: Date.now()}];
                let lastTime = 0;
                
                // 更新心声状态
                InnerVoiceUI.currentCharId = id;
                InnerVoiceUI.updateCurrentVoice();

                // 4. 渲染消息列表 (核心修改部分)
                document.getElementById('chat-messages-container').innerHTML = msgs.map((m, idx) => {
                    const msgNumber = idx + 1; 
                    const isSelf = m.role === 'user';
                    // 如果是 NPC 模式，AI 的消息显示 NPC 头像，否则显示角色头像
                    const avatar = isSelf ? (c.userAvatar||'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50') : (npc ? npc.avatar : c.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50');
                    
                    let contentHtml = m.content;
                    let bubbleClass = `chat-bubble`;
                    let timeHtml = '';
                    const msgTime = m.timestamp || Date.now(); 
                    if (msgTime - lastTime > 5 * 60 * 1000) { timeHtml = `<div class="msg-system"><span>${Utils.formatChatTime(msgTime)}</span></div>`; lastTime = msgTime; }
                    
                    // --- 消息类型渲染逻辑 ---
                    

                    // A. 文本消息和HTML消息 (处理 HTML 安全和换行)
                    if (m.type === 'text' || m.type === 'html') {
                        let processedContent = m.content.replace(/```[\w]*\n?/g, '').replace(/```/g, '').trim();
                        const hasHTML = m.type === 'html' || /<[^>]+>/.test(processedContent);
                        if (hasHTML) {
                            // 1. 移除完整HTML文档标签，只保留内容
                            processedContent = processedContent
                                .replace(/<!DOCTYPE[^>]*>/gi, '')
                                .replace(/<html[^>]*>[\s\S]*?<body[^>]*>/gi, '')
                                .replace(/<\/body>[\s\S]*?<\/html>/gi, '')
                                .replace(/<head[^>]*>[\s\S]*?<\/head>/gi, '')
                                .trim();
                            
                            // 2. 允许部分安全 HTML 标签
                            contentHtml = processedContent
                                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                                .replace(/<iframe[^>]*>[\s\S]*?<\/iframe>/gi, '')
                                .replace(/src\s*=\s*["']?`([^`]+)`["']?/gi, 'src="$1"') // 修复反引号路径
                                .replace(/onclick="document\.getElementById\('dice-face'\)\.innerText/g, 'onclick="this.previousElementSibling.innerText');
                            
                            // 3. 添加样式隔离容器
                            contentHtml = `<div class="html-isolated-container">${contentHtml}</div>`;
                            
                            // 添加专用的HTML气泡类名
                            bubbleClass += ' bubble-html';
                        } else {
                            contentHtml = processedContent.replace(/\n/g, '<br>');
                        }
                    }
                    
                    // B. 【核心修复】图片消息 (统一处理表情包和普通图片)
                    else if (m.type === 'image') {
                        // 优先使用 originalContent (真实URL)，如果没有则尝试用 content
                        let imgSrc = m.originalContent || m.content;
                        
                        // 简单判断是否是有效的图片链接或Base64
                        if (imgSrc && (imgSrc.startsWith('http') || imgSrc.startsWith('data:image') || imgSrc.startsWith('blob:'))) {
                             // 点击图片可以放大预览
                             contentHtml = `<div class="msg-image"><img src="${imgSrc}" style="cursor:zoom-in;" onclick="window.open(this.src, '_blank')"></div>`;
                        } else {
                             contentHtml = `<div class="text-gray-500 text-xs">[${m.content}]</div>`;
                        }
                    }

                                        
                    // 【新增】朋友圈分享卡片渲染
                    else if (m.type === 'moment_share') {
                        // 兼容处理：如果是字符串，尝试转对象
                        let share = m.content;
                        if (typeof share === 'string') {
                            try { share = JSON.parse(share); } catch(e) { share = { text: share }; }
                        }
                        
                        contentHtml = `
                        <div class="bg-white p-3 rounded-lg flex gap-3 cursor-pointer hover:bg-gray-50 border border-gray-200" style="width: 240px;" onclick="WeChatUI.openSubPage('subpage-moments')">
                            <div class="w-12 h-12 bg-gray-200 shrink-0 overflow-hidden rounded">
                                ${share.image ? `<img src="${share.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-share-nodes text-xl"></i></div>'}
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <div class="text-xs text-gray-900 line-clamp-2 leading-relaxed font-medium">${share.text || '分享朋友圈'}</div>
                                <div class="text-[10px] text-gray-400 mt-1 flex items-center gap-1">
                                    <i class="fa-regular fa-compass"></i> 朋友圈 · ${share.author || '好友'}
                                </div>
                            </div>
                        </div>`;
                    }
                                        // 【新增】朋友圈分享卡片渲染
                    else if (m.type === 'moment_share') {
                        let share = m.content;
                        // 兼容处理：如果是字符串，尝试转对象
                        if (typeof share === 'string') { try{ share=JSON.parse(share) }catch(e){ share={text:share} } }
                        
                        contentHtml = `
                        <div class="bg-white p-3 rounded-lg flex gap-3 cursor-pointer hover:bg-gray-50 border border-gray-200" style="width: 240px;" onclick="WeChatUI.openSubPage('subpage-moments')">
                            <div class="w-12 h-12 bg-gray-200 shrink-0 overflow-hidden rounded">
                                ${share.image ? `<img src="${share.image}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-share-nodes text-xl"></i></div>'}
                            </div>
                            <div class="flex-1 min-w-0 flex flex-col justify-center">
                                <div class="text-xs text-gray-900 line-clamp-2 leading-relaxed font-medium">${share.text || '分享朋友圈'}</div>
                                <div class="text-[10px] text-gray-400 mt-1 flex items-center gap-1">
                                    <i class="fa-regular fa-compass"></i> 朋友圈 · ${share.author || '好友'}
                                </div>
                            </div>
                        </div>`;
                    }

                    // C. 转账消息
                                        else if(m.type === 'transfer') {
                        bubbleClass += ` bubble-transfer`;
                        const cardClass = m.status === 'received' || m.status === 'rejected' ? 'pay-card received' : 'pay-card';
                        let statusText = '微信转账';
                        if (m.status === 'received') statusText = '已收款';
                        if (m.status === 'rejected') statusText = '已退还';
                        contentHtml = `<div class="${cardClass}" onclick="WeChatUI.handlePaymentClick(${idx}, 'transfer', '${m.role}')"><div class="pay-top"><div class="pay-icon"><i class="fa-solid fa-arrow-right-arrow-left"></i></div><div class="pay-info"><div class="pay-title">¥${m.amount}</div><div class="pay-desc">${m.note}</div></div></div><div class="pay-bottom">${statusText}</div></div>`;
                    }
                    
                    // D. 红包消息
                    else if(m.type === 'redpacket') {
                        bubbleClass += ` bubble-redpacket`;
                        const cardClass = m.status === 'received' || m.status === 'rejected' ? 'pay-card received' : 'pay-card';
                        let statusText = '微信红包';
                        if (m.status === 'received') statusText = '已领取';
                        if (m.status === 'rejected') statusText = '已退还';
                        contentHtml = `<div class="${cardClass}" onclick="WeChatUI.handlePaymentClick(${idx}, 'redpacket', '${m.role}')"><div class="pay-top"><div class="pay-icon"><i class="fa-solid fa-envelope"></i></div><div class="pay-info"><div class="pay-title">${m.note}</div><div class="pay-desc">领取红包</div></div></div><div class="pay-bottom">${statusText}</div></div>`;
                    }
                    
                    // E. 语音消息
                    else if(m.type === 'voice') {
                        const expandedClass = m.expanded ? 'expanded' : '';
                        const playingClass = m.playing ? 'voice-playing' : '';
                        contentHtml = `<div class="voice-container"><div class="voice-bubble ${playingClass}" onclick="WeChatUI.toggleVoiceText(${idx}, '${id}', '${m.role}')"><div class="voice-icon"><i class="fa-solid fa-wifi rotate-90"></i></div><span class="voice-duration">3"</span></div><div class="voice-text ${expandedClass}">${m.text}</div></div>`;
                    }
                    
                    // F. 系统/错误消息
                    else if(m.type === 'system') {
                        if (m.isRecall) return `<div class="msg-system clickable" onclick="WeChatUI.showRecalled('${m.originalContent}')"><span class="time">${Utils.formatChatTime(msgTime)}</span><span>${m.content} (点击查看)</span></div>`;
                        return `<div class="msg-system"><span class="time">${Utils.formatChatTime(msgTime)}</span><span>${m.content}</span></div>`;
                    }
                    else if(m.type === 'error') return `<div class="msg-system msg-error"><span>${m.content}</span></div>`;

                    // 5. 组装最终气泡
                    const contentWrapper = `<div class="${bubbleClass}" style="${c.bubbleCss}; font-size: ${c.bubbleFontSize || 15}px;">
                        <div class="absolute top-1 ${isSelf ? 'right-1' : 'left-1'} text-[8px] text-gray-400 opacity-0">${msgNumber}</div>
                        ${contentHtml}
                    </div>`;
                    
                    const timestampHtml = `<div class="msg-time-outside">${new Date(msgTime).toTimeString().slice(0,5)}</div>`;
                    
                    return `${timeHtml}<div class="msg-row ${isSelf?'self':'other'}" oncontextmenu="WeChatUI.showContextMenu(event, ${idx})" style="position: relative;">
                        <div class="msg-checkbox" onclick="WeChatUI.toggleSelect(${idx}, this)"></div>
                        <div class="msg-avatar ${shapeClass}"><img src="${avatar}"></div>
                        <div class="msg-content" oncontextmenu="WeChatUI.showContextMenu(event, ${idx})">
                            ${contentWrapper}${timestampHtml}
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('chat-messages-container').scrollTop = 99999;
            },            handlePaymentClick: (idx, type, role) => {
                 const cid = document.getElementById('subpage-chat-detail').dataset.charId; const chars = Storage.get('wechat_chars', {}); const msg = chars[cid].msgs[idx];
                 if (msg.status === 'received' || msg.status === 'rejected') {
                     if(type === 'redpacket' && msg.status === 'received') {
                         const modal = document.getElementById('modal-open-redpacket');
                         modal.classList.remove('hidden');
                         document.getElementById('rp-open-avatar').innerHTML = `<img src="${chars[cid].avatar}">`;
                         document.getElementById('rp-open-msg').textContent = msg.note || '恭喜发财';
                         document.querySelector('.rp-open-btn').style.display = 'none';
                         document.getElementById('rp-reject-btn').style.display = 'none';
                         document.getElementById('rp-result-view').classList.add('active');
                         document.getElementById('rp-result-amount').textContent = msg.receivedAmount || '0.00';
                     }
                     return; 
                 }
                 if (role === 'ai') {
                     if (type === 'redpacket') {
                        const modal = document.getElementById('modal-open-redpacket');
                        modal.classList.remove('hidden');
                        document.getElementById('rp-open-avatar').innerHTML = `<img src="${chars[cid].avatar}">`;
                        document.getElementById('rp-open-msg').textContent = msg.note || '恭喜发财，大吉大利';
                        document.getElementById('rp-result-view').classList.remove('active');
                        document.querySelector('.rp-open-btn').style.display = 'flex';
                        document.getElementById('rp-reject-btn').style.display = 'block';
                        modal.dataset.targetIdx = idx;
                        modal.dataset.charId = cid;
                     } else {
                        document.getElementById('payment-action-title').textContent = '收到转账';
                        document.getElementById('payment-action-amount').textContent = `¥${msg.amount}`;
                        document.getElementById('payment-action-desc').innerHTML = `转账备注: ${msg.note}`;
                        document.getElementById('modal-payment-action').classList.remove('hidden');
                        document.getElementById('modal-payment-action').dataset.targetIdx = idx;
                     }
                 } else { Utils.showToast('等待对方确认收款'); }
            },
            triggerOpenPacket: () => {
                 const btn = document.querySelector('.rp-open-btn');
                 btn.classList.add('spinning');
                 setTimeout(() => {
                     btn.classList.remove('spinning');
                     WeChatUI.processRedPacketOpen('received');
                 }, 1000);
            },
            triggerRejectPacket: () => {
                 WeChatUI.processRedPacketOpen('rejected');
            },
            processRedPacketOpen: (action) => {
                const modal = document.getElementById('modal-open-redpacket');
                const idx = modal.dataset.targetIdx;
                const cid = modal.dataset.charId;
                if (!cid) return; // 如果没有角色ID，直接返回
                
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid]) return; // 如果角色不存在，直接返回
                if(!chars[cid].msgs) chars[cid].msgs = [];
                
                const msg = chars[cid].msgs[idx];
                if(!msg) return; // 如果消息不存在，直接返回
                
                msg.status = action;
                const actionText = action === 'received' ? '领取' : '退还';
                
                // Use stored amount if exists, otherwise random (for legacy messages)
                let amount = msg.amount ? parseFloat(msg.amount) : parseFloat((Math.random() * 100).toFixed(2));
                msg.receivedAmount = amount; // Persist

                const sysMsg = { role: 'system', type: 'system', content: `你${actionText}了${chars[cid].name}的红包`, timestamp: Date.now() };
                chars[cid].msgs.splice(parseInt(idx) + 1, 0, sysMsg);
                
                if (action === 'received') {
                     document.getElementById('rp-result-amount').textContent = amount;
                     document.querySelector('.rp-open-btn').style.display = 'none';
                     document.getElementById('rp-reject-btn').style.display = 'none';
                     document.getElementById('rp-result-view').classList.add('active');
                     Utils.showToast(`已存入零钱: ¥${amount.toFixed(2)}`);
                     
                     // 更新钱包余额
                     WeChatUI.updateWalletBalance('income', amount, `领取了${chars[cid].name}的红包`);
                } else {
                     document.getElementById('modal-open-redpacket').classList.add('hidden');
                }
                Storage.set('wechat_chars', chars);
                WeChatUI.loadChat(cid);
            },
            processPaymentAction: (action) => {
                const idx = document.getElementById('modal-payment-action').dataset.targetIdx;
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // 如果不在聊天详情页面，直接返回
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid]) return; // 如果角色不存在，直接返回
                if(!chars[cid].msgs) chars[cid].msgs = [];
                
                const msg = chars[cid].msgs[idx];
                if(!msg) return; // 如果消息不存在，直接返回
                
                msg.status = action; 
                const actionText = action === 'received' ? '收款' : '退还'; 
                const typeText = msg.type === 'transfer' ? '转账' : '红包';
                const sysMsg = { role: 'system', type: 'system', content: `你${actionText}了${chars[cid].name}的${typeText}`, timestamp: Date.now() };
                chars[cid].msgs.splice(parseInt(idx) + 1, 0, sysMsg);
                
                // 更新钱包余额
                if (action === 'received') {
                    const amount = parseFloat(msg.amount || '0');
                    WeChatUI.updateWalletBalance('income', amount, `收到${chars[cid].name}的${typeText}`);
                    Utils.showToast(`已存入零钱: ¥${amount.toFixed(2)}`);
                }
                
                Storage.set('wechat_chars', chars);
                document.getElementById('modal-payment-action').classList.add('hidden');
                WeChatUI.loadChat(cid);
            },
            showGlobalNotification: (name, msg, avatar, charId) => {
                const modal = document.getElementById('global-notification-modal');
                document.getElementById('notify-title').textContent = name;
                document.getElementById('notify-body').textContent = msg;
                document.getElementById('notify-avatar-img').src = avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50';
                // 存储聊天ID，用于点击通知时直接导航
                modal.dataset.charId = charId || '';
                modal.style.display = 'block';
                setTimeout(() => { modal.style.display = 'none'; }, 4000);
            },
            handleNotificationClick: () => {
                const modal = document.getElementById('global-notification-modal');
                modal.style.display = 'none';
                openApp('wechat');
                
                // 获取存储的聊天ID
                const charId = modal.dataset.charId;
                if (charId) {
                    // 导航到聊天详情页
                    const chars = Storage.get('wechat_chars', {});
                    if (chars[charId]) {
                        // 重置未读计数
                        chars[charId].unread = 0;
                        Storage.set('wechat_chars', chars);
                        
                        // 渲染列表并加载聊天
                        WeChatUI.renderList();
                        WeChatUI.loadChat(charId);
                        
                        // 确保聊天详情页可见
                        document.getElementById('subpage-chat-detail').dataset.charId = charId;
                        document.getElementById('subpage-chat-detail').classList.add('active');
                    }
                }
            },
            toggleVoiceText: (idx, cid, role) => {
                const chars = Storage.get('wechat_chars', {}); const msg = chars[cid].msgs[idx]; msg.expanded = !msg.expanded;
                if (role === 'ai' && chars[cid].ttsEnabled) {
                     if (!msg.playing) {
                         msg.playing = true; Storage.set('wechat_chars', chars); WeChatUI.loadChat(cid); 
                         const playEnd = () => { const currentChars = Storage.get('wechat_chars', {}); if(currentChars[cid] && currentChars[cid].msgs[idx]) { currentChars[cid].msgs[idx].playing = false; Storage.set('wechat_chars', currentChars); WeChatUI.loadChat(cid); } };
                         if (msg.audioUrl) { const audio = new Audio(msg.audioUrl); audio.onended = playEnd; audio.play().catch(e => { alert('播放失败: ' + e); playEnd(); }); } else {
                             SettingsLogic.generateTTS(msg.text, chars[cid]).then(url => { if(url) { msg.audioUrl = url; const updatedChars = Storage.get('wechat_chars', {}); updatedChars[cid].msgs[idx].audioUrl = url; Storage.set('wechat_chars', updatedChars); const audio = new Audio(url); audio.onended = playEnd; audio.play(); } else { playEnd(); } });
                         }
                     } else { msg.playing = false; }
                }
                Storage.set('wechat_chars', chars); WeChatUI.loadChat(cid);
            },
            toggleVoiceMode: () => { WeChatUI.isVoiceMode = !WeChatUI.isVoiceMode; document.getElementById('btn-voice-mode').style.color = WeChatUI.isVoiceMode ? '#4ade80' : 'gray'; document.getElementById('chat-input').placeholder = WeChatUI.isVoiceMode ? '输入文字转语音...' : '发送消息...'; },
            regenerateLastReply: () => {
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                const c = chars[cid];
                if (!c || !c.msgs) return;
                
                // Find last user message
                const lastUserMsgIdx = c.msgs.map((m, i) => ({...m, idx: i})).reverse().find(m => m.role === 'user');
                if (!lastUserMsgIdx) {
                    Utils.showToast('没有可重新生成的消息');
                    return;
                }
                
                // Remove all messages after last user message (including the user message itself, then we'll add it back)
                const userMsg = c.msgs[lastUserMsgIdx.idx];
                c.msgs = c.msgs.slice(0, lastUserMsgIdx.idx);
                Storage.set('wechat_chars', chars);
                WeChatUI.loadChat(cid);
                
                // Add user message back and regenerate
                setTimeout(() => {
                    c.msgs.push(userMsg);
                    Storage.set('wechat_chars', chars);
                    WeChatUI.loadChat(cid);
                    WeChatUI.sendUserMessage(true);
                }, 100);
            },
            showTransferModal: (type) => { document.getElementById('modal-transfer').classList.remove('hidden'); document.getElementById('transfer-title').textContent = type==='transfer'?'转账':'发红包'; document.getElementById('modal-transfer').dataset.type = type; },
            confirmTransfer: () => { const amount = document.getElementById('transfer-amount').value; const note = document.getElementById('transfer-note').value || (document.getElementById('modal-transfer').dataset.type==='transfer'?'转账':'恭喜发财'); if(!amount && document.getElementById('modal-transfer').dataset.type==='transfer') return; WeChatUI.pushMessage('transfer', { amount, note }, 'user', document.getElementById('modal-transfer').dataset.type); document.getElementById('modal-transfer').classList.add('hidden'); },
            handleChatImage: (input) => { 
    if(input.files[0]) {
        // 修改：512px宽度，0.6质量
        Utils.compressImage(input.files[0], 512, 0.6).then(base64 => {
            WeChatUI.pushMessage('image', base64);
        });
    }
},
            sendUserMessage: (generate) => {
    const inputEl = document.getElementById('chat-input'); 
    const text = inputEl.value; 
    const cid = document.getElementById('subpage-chat-detail').dataset.charId; 
    const chars = Storage.get('wechat_chars', {}); 
    const c = chars[cid];

    if(text) { 
        const type = WeChatUI.isVoiceMode ? 'voice' : 'text'; 
        WeChatUI.pushMessage(type, text); 
        inputEl.value = ''; 
    }

    if(generate) {
        const statusEl = document.getElementById('chat-online-status'); 
        statusEl.textContent = '正在输入...';
        
        const tempId = 'temp_' + Date.now(); 
        const tempMsg = `<div id="${tempId}" class="chat-bubble other" style="background:transparent;border:1px solid #333;color:#888;"><div class="spinner-container"><i class="fa-solid fa-spinner spinner-rotate"></i></div><span class="ml-2">正在输入...</span></div>`;
        const container = document.getElementById('chat-messages-container'); 
        container.insertAdjacentHTML('beforeend', `<div class="msg-row other"><div class="msg-avatar"><img src="${c.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default50'}"></div><div class="msg-content">${tempMsg}</div></div>`); 
        container.scrollTop = 99999;

        // --- 时间感知 ---
        let timeContext = '';
        if (c.timeAware) {
            const now = new Date();
            const hour = now.getHours();
            let period = '';
            if (hour >= 0 && hour < 5) period = '凌晨';
            else if (hour >= 5 && hour < 9) period = '早晨';
            else if (hour >= 9 && hour < 12) period = '上午';
            else if (hour >= 12 && hour < 14) period = '中午';
            else if (hour >= 14 && hour < 18) period = '下午';
            else if (hour >= 18 && hour < 23) period = '晚上';
            else period = '深夜';
            timeContext = `Current Real Time: ${Utils.formatCurrentTime()} (${period})`;
        }

        // --- 状态与NPC ---
        let latestVoice = '';
        if (c.innerVoices && c.innerVoices.length > 0) {
            const lastVoice = c.innerVoices[c.innerVoices.length - 1].content;
            latestVoice = `\n[Last State: ${lastVoice.substring(0, 100)}...]\n`; 
        }
        const npcs = Storage.get('wechat_npcs', {});
        const boundNPCs = c.boundNPCs || [];
        let npcInfo = boundNPCs.length > 0 ? 'Bound NPCs active.\n' : '';

        // --- 核心 Prompt (强制心声) ---
        let systemPrompt = `[Roleplay Protocol]
1. YOU ARE "${c.name}".
2. Tone: Casual, separate sentences naturally.
3. Persona: ${c.prompt || 'A friendly friend.'}
4. User: ${c.userName || 'User'}.
${timeContext}${latestVoice}
[Available Features]
- 转账: [转账: 100元] - 用户向你转账100元
- 红包: [红包: 新年快乐] - 用户向你发送带有"新年快乐"备注的红包
- 朋友圈: 用户可以发布、分享、点赞和评论朋友圈
- 点赞: 你可以点赞用户或好友的朋友圈动态
- 评论: 你可以评论用户或好友的朋友圈动态
- 图片: 用户可以发送图片消息
- 语音: 用户可以发送语音消息
- 表情包: 你可以使用表情包进行互动
- 分享: 用户可以分享朋友圈链接给你
[重要：如何使用手机功能]
- 当你需要使用手机内置功能时，不要使用HTML格式，请使用指定格式
- 系统会自动将这些格式转换为实际功能消息

【红包功能】
- 格式：[红包: 备注内容] 或 [红包: 金额 备注内容]
- 例如：[红包: 给你买糖吃!] 或 [红包: 88.88 生日快乐]

【转账功能】
- 格式：[转账: 金额 备注内容]
- 例如：[转账: 520.00 情人节快乐] 或 [转账: 100.00 还你钱]

【语音功能】
- 格式：[语音: 语音文本内容]
- 例如：[语音: 你好，我是测试酱！]

【图片功能】
- 格式：[图片: 图片描述]
- 例如：[图片: 一张可爱的猫图片]

【表情包功能】
- 格式：[表情包: 表情包名称]
- 例如：[表情包: 开心] 或 [表情包: 生气]

【朋友圈互动】
- 点赞格式：[点赞: 朋友圈内容]
- 评论格式：[评论: 评论内容]
- 分享格式：[分享: 分享内容]
- 例如：[点赞: 今天天气真好！] 或 [评论: 这个风景真漂亮！]

- 不要手动编写HTML或其他格式来表示手机内置功能
- 使用自然的语言表达，系统会处理所有手机功能的实际实现
[HTML使用规则]
- 你可以生成好玩的、创意性的HTML内容，但只能用于非手机功能的场景
- 禁止用HTML模拟或实现手机内置功能（如红包、转账、聊天界面等）
- HTML内容应该是有趣的、可视化的、互动性的，比如小游戏、动画效果、创意排版等
- HTML内容要安全，禁止包含恶意代码或危险操作
- 保持HTML内容简洁，避免过于复杂的结构
[Messaging Style]
- Keep normal text simple and natural
- Separate sentences naturally with newlines
- Fix broken parentheses: (text) should be on one line.
- IMPORTANT: Please separate sentences with \n (newline character) when appropriate. This will help with better message display.
${npcInfo}
[MANDATORY OUTPUT FORMAT]
You MUST append the following JSON block at the VERY END of your response. Do not wrap it in markdown code blocks.
[INNER_VOICE]
{"着装":"...","环境":"...","心声":"...","行为":"..."}
[/INNER_VOICE]`;

        const history = (c.msgs || []).slice(-(c.contextLimit||20)).map(m => {
            let content = m.content;
            if(m.type === 'image') content = m.content.includes(':') ? `[图片: ${m.content.split(':')[0]}]` : `[图片]`;
            return { role: m.role === 'user' ? 'user' : 'assistant', content: content };
        }).filter(m => m.content && typeof m.content === 'string');

        // 注入当前时间纠正幻觉
        if (c.timeAware && history.length > 0 && history[history.length-1].role === 'user') {
            history[history.length-1].content += `\n(System: Current time is ${Utils.formatCurrentTime()}. Ignore old timestamps.)`;
        }

        const apiMessages = [{role: 'system', content: systemPrompt}, ...history];

        // --- 发送请求 ---
        SettingsLogic.generateLLM(apiMessages, cid).then(reply => {
            const tempEl = document.getElementById(tempId); 
            if(tempEl) tempEl.closest('.msg-row').remove();

            if(!reply) { 
                WeChatUI.pushMessage('error', 'AI 返回了空内容', 'system'); 
                return;
            }

            // 1. 提取并清洗心声
            const innerVoiceMatch = reply.match(/\[INNER_VOICE\]([\s\S]*?)\[\/INNER_VOICE\]/i);
            if (innerVoiceMatch) {
                try {
                    let voiceJsonStr = innerVoiceMatch[1].trim().replace(/```[\w]*/g, '').replace(/```/g, '').trim();
                    const jsonMatch = voiceJsonStr.match(/\{[\s\S]*\}/); // 提取JSON部分
                    if (jsonMatch) {
                        const voiceJson = JSON.parse(jsonMatch[0]);
                        const voiceText = `着装：${voiceJson.着装||'-'}\n环境：${voiceJson.环境||'-'}\n心声：${voiceJson.心声||'-'}\n行为：${voiceJson.行为||'-'}`;
                        InnerVoiceUI.addVoice(voiceText);
                    }
                    // 从回复中彻底移除心声块，防止显示给用户
                    reply = reply.replace(/\[INNER_VOICE\][\s\S]*?\[\/INNER_VOICE\]/gi, '').trim();
                } catch (e) { console.error("心声解析失败", e); }
            }
            
            // 2. 预处理 (HTML保护 + 括号修复)
            let cleanReply = reply.replace(/```html/gi, '').replace(/```/g, '').trim();
            cleanReply = cleanReply.replace(/\n\s*([)）])/g, '$1');

            const messageQueue = [];
            const htmlBlocks = [];
            
            // 检查整个回复是否包含HTML标签
            const containsHTML = /<[^>]+>/.test(cleanReply);
            
            if (containsHTML) {
                // 提取HTML标签前的文本内容
                const htmlStartIndex = cleanReply.search(/<[^>]+>/);
                const textContent = cleanReply.substring(0, htmlStartIndex).trim();
                const htmlContent = cleanReply.substring(htmlStartIndex).trim();
                
                // 如果有文本内容，先发送文本消息
                if (textContent) {
                    messageQueue.push(textContent);
                }
                
                // 发送HTML消息
                messageQueue.push(htmlContent);
            } else {
                // 3. 分句逻辑 - 不再使用标点符号，直接依赖AI返回的换行符
                const paragraphs = cleanReply.split('\n');
                paragraphs.forEach(p => {
                    p = p.trim();
                    if (!p) return;
                    // 直接使用AI返回的内容作为句子，不再使用正则表达式分句
                    messageQueue.push(p);
                });
            }

            // 4. 播放消息
            const processQueue = async () => {
                if (messageQueue.length === 0) {
                    document.getElementById('chat-online-status').textContent = '在线';
                    return;
                }
                
                let msgContent = messageQueue.shift();
                
                const parseImageUrls = (text) => {
                    const imageUrlPattern = /(?<!<img[^>]*src=")(https?:\/\/[^\s"']+\.(png|jpg|jpeg|gif|svg|bmp|webp)|data:image\/[^;]+;base64,[^"']+)/gi;
                    return text.replace(imageUrlPattern, (url) => `<img src="${url.replace(/"/g, '')}" style="max-width: 250px; border-radius: 6px; display: block; margin: 4px 0;">`);
                };

                if(msgContent.startsWith('/redpacket')) { const parts = msgContent.split(' '); WeChatUI.pushMessage('redpacket', { note: parts.slice(2).join(' ') || '恭喜发财', amount: parts[1] }, 'ai'); } 
                else if(msgContent.startsWith('/transfer')) { const parts = msgContent.split(' '); WeChatUI.pushMessage('transfer', { note: parts.slice(2).join(' ') || '转账', amount: parts[1] }, 'ai'); } 
                else if(msgContent.startsWith('/voice')) { const text = msgContent.substring(7); WeChatUI.pushMessage('voice', text, 'ai'); } 
                // 识别AI发送的红包格式：[红包: 备注] 或 [红包: 金额 备注] 
                else if(msgContent.match(/^\[红包:[^\]]+\]$/)) {
                    const redPacketMatch = msgContent.match(/^\[红包:\s*([^\]]+)\]$/);
                    if(redPacketMatch) {
                        const content = redPacketMatch[1].trim();
                        let amount = '88.88'; // 默认金额
                        let note = '恭喜发财';
                        
                        // 尝试提取金额和备注，格式：金额 备注
                        const parts = content.split(/\s+/);
                        if(parts.length >= 2 && !isNaN(parseFloat(parts[0]))) {
                            amount = parts[0];
                            note = parts.slice(1).join(' ');
                        } else {
                            note = content;
                        }
                        
                        WeChatUI.pushMessage('redpacket', { note: note, amount: amount }, 'ai');
                    }
                }
                else {
                    // 检查消息是否包含HTML标签
                    const hasHTML = /<[^>]+>/.test(msgContent);
                    if (hasHTML) {
                        // 如果包含HTML标签，使用html类型
                        WeChatUI.pushMessage('html', msgContent, 'ai');
                    } else {
                        // 否则使用text类型
                        WeChatUI.pushMessage('text', parseImageUrls(msgContent), 'ai');
                    }
                }
                
                const delay = Math.min(2000, Math.max(800, msgContent.length * 50));
                await new Promise(r => setTimeout(r, delay));
                processQueue();
            };
            processQueue();

        }).catch(err => { 
            const tempEl = document.getElementById(tempId); 
            if(tempEl) tempEl.closest('.msg-row').remove(); 
            WeChatUI.pushMessage('error', 'API错误: ' + err.message, 'system'); 
            document.getElementById('chat-online-status').textContent = '离线'; 
        });
    }
},
            pushMessage: (type, content, role='user', msgType, emojiName) => { 
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return;
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid]) return;
                if(!chars[cid].msgs) chars[cid].msgs = [];
                
                // 基础消息对象
                let msgObj = { 
                    role, 
                    type: msgType || type, 
                    content: content, 
                    timestamp: Date.now() 
                };
                
                // === 【核心修改：表情包逻辑】 ===
                if (type === 'image') {
                    // 1. 记录原始图片 URL (用于给 UI 显示，也用于发给 AI 识图)
                    msgObj.originalContent = content; 
                    
                    // 2. 处理 AI 看到的文本 (让 AI 理解含义)
                    if (emojiName) {
                        try {
                            const decodedName = decodeURIComponent(emojiName);
                            // 存为 "[表情包: 名字]"，AI 既能看图又能看字
                            msgObj.content = `[表情包: ${decodedName}]`; 
                        } catch(e) {
                            msgObj.content = `[表情包]`; 
                        }
                    } else {
                        // 如果没有名字，就叫 "[图片]"
                        msgObj.content = `[图片]`;
                    }
                }
                // ================================
                
                // 其他类型保持不变
                if(type === 'transfer' || msgType === 'transfer') msgObj = { ...msgObj, role, type: 'transfer', amount: content.amount, note: content.note, content: '转账', status: null };
                if(type === 'redpacket' || msgType === 'redpacket') msgObj = { ...msgObj, role, type: 'redpacket', note: content.note, content: '红包', amount: content.amount, status: null };
                if(type === 'voice' || msgType === 'voice') msgObj = { ...msgObj, role, type: 'voice', text: content, content: 'Voice', expanded: false, playing: false };
                if(type === 'error') msgObj = { role: 'system', type: 'error', content: content };
                
                chars[cid].msgs.push(msgObj);
                WeChatUI.checkAutoSummary(cid);
                
                const isActiveChat = chatDetailEl.classList.contains('active') && chatDetailEl.dataset.charId === cid;
                if (!isActiveChat && role === 'ai') {
                    chars[cid].unread = (chars[cid].unread || 0) + 1;
                    WeChatUI.showGlobalNotification(chars[cid].name, msgType === 'text' ? content : `[${msgType}]`, chars[cid].avatar, cid);
                }
                
                if (role === 'user' && (msgType === 'redpacket' || msgType === 'transfer')) {
                    const amount = parseFloat(content.amount || '0');
                    const typeText = msgType === 'redpacket' ? '红包' : '转账';
                    WeChatUI.updateWalletBalance('expense', amount, `向${chars[cid].name}发送${typeText}`);
                }
                
                Storage.set('wechat_chars', chars); 
                WeChatUI.loadChat(cid); 
                WeChatUI.renderList(); 
            },
            showContextMenu: (e, idx) => {
                e.preventDefault();
                if(WeChatUI.isMultiSelect) return;
                WeChatUI.ctxTargetMsg = idx;
                const menu = document.getElementById('context-menu');
                menu.style.display = 'block';
                // Get menu dimensions after displaying it
                menu.style.opacity = '0'; // Temporarily hide to get dimensions
                const menuRect = menu.getBoundingClientRect();
                menu.style.opacity = '1';
                // Calculate position to keep menu within viewport
                let top = e.clientY;
                let left = e.clientX;
                // Adjust for bottom overflow
                if (top + menuRect.height > window.innerHeight) {
                    top = window.innerHeight - menuRect.height - 5; // 5px padding
                }
                // Adjust for top overflow
                if (top < 0) {
                    top = 5; // 5px padding
                }
                // Adjust for right overflow
                if (left + menuRect.width > window.innerWidth) {
                    left = window.innerWidth - menuRect.width - 5; // 5px padding
                }
                // Adjust for left overflow
                if (left < 0) {
                    left = 5; // 5px padding
                }
                menu.style.top = top + 'px';
                menu.style.left = left + 'px';
            },
            hideContextMenu: () => {
                document.getElementById('context-menu').style.display = 'none';
                document.getElementById('contact-context-menu').style.display = 'none';
            },
            ctxCopy: () => { 
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // 如果不在聊天详情页面，直接返回
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid] || !chars[cid].msgs) return; // 如果角色或消息不存在，直接返回
                
                const msg = chars[cid].msgs[WeChatUI.ctxTargetMsg];
                if(msg && msg.type==='text') { 
                    navigator.clipboard.writeText(msg.content); 
                    Utils.showToast('已复制'); 
                } 
            },
            ctxQuote: () => { 
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // 如果不在聊天详情页面，直接返回
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid] || !chars[cid].msgs) return; // 如果角色或消息不存在，直接返回
                
                const msg = chars[cid].msgs[WeChatUI.ctxTargetMsg];
                if(msg) {
                    document.getElementById('chat-input').value = `「引用」\n` + document.getElementById('chat-input').value;
                }
            },
            ctxDelete: () => { 
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // 如果不在聊天详情页面，直接返回
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid] || !chars[cid].msgs) return; // 如果角色或消息不存在，直接返回
                
                chars[cid].msgs.splice(WeChatUI.ctxTargetMsg, 1); 
                Storage.set('wechat_chars', chars); 
                WeChatUI.loadChat(cid); 
                WeChatUI.renderList(); 
            },
            ctxRevoke: () => { 
                const chatDetailEl = document.getElementById('subpage-chat-detail');
                if (!chatDetailEl) return; // 如果不在聊天详情页面，直接返回
                
                const cid = chatDetailEl.dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                if(!chars[cid] || !chars[cid].msgs) return; // 如果角色或消息不存在，直接返回
                
                const oldContent = chars[cid].msgs[WeChatUI.ctxTargetMsg]?.content;
                if(oldContent) {
                    chars[cid].msgs[WeChatUI.ctxTargetMsg] = {role:'system', type:'system', content:'撤回了一消息', isRecall: true, originalContent: oldContent, timestamp: Date.now()};
                    Storage.set('wechat_chars', chars); 
                    WeChatUI.loadChat(cid); 
                }
            },
            showRecalled: (content) => {
                document.getElementById('recall-content-text').textContent = content;
                document.getElementById('modal-recall-view').classList.remove('hidden');
            },
            ctxFav: () => Utils.showToast('已收藏'),
                        // 打开编辑器
            ctxEdit: () => { 
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                const msg = chars[cid].msgs[WeChatUI.ctxTargetMsg];
                
                // 清空列表
                const list = document.getElementById('edit-msg-list');
                if(list) {
                    list.innerHTML = ''; 
                    // 添加当前消息作为第一个编辑块
                    WeChatUI.addEditBlock(msg); 
                    document.getElementById('modal-edit-msg').classList.remove('hidden'); 
                }
            },

            // 【核心】动态添加编辑块 (支持图一那样的卡片)
            addEditBlock: (data = null) => {
                const container = document.getElementById('edit-msg-list');
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-gray-200 relative group shadow-sm hover:shadow-md transition-shadow";
                
                // 设置默认值
                const role = data ? data.role : 'user';
                const type = data ? data.type : 'text';
                let content = '';
                
                if (data) {
                    if (data.type === 'voice') content = data.text;
                    else if (data.type === 'image') content = data.originalContent || data.content;
                    else if (data.type === 'redpacket' || data.type === 'transfer') content = data.note;
                    else content = data.content;
                }
                
                div.innerHTML = `
                    <button onclick="if(document.getElementById('edit-msg-list').children.length > 1) this.parentElement.remove();" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-red-50 transition-colors">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                    <div class="flex gap-2 mb-2 pr-8">
                        <select class="edit-block-role setting-input mb-0 text-xs py-1 h-8 w-20 bg-gray-50 border-gray-200 focus:bg-white">
                            <option value="user" ${role==='user'?'selected':''}>我</option>
                            <option value="ai" ${role==='ai'?'selected':''}>AI</option>
                            <option value="system" ${role==='system'?'selected':''}>系统</option>
                        </select>
                        <select class="edit-block-type setting-input mb-0 text-xs py-1 h-8 flex-1 bg-gray-50 border-gray-200 focus:bg-white">
                            <option value="text" ${type==='text'?'selected':''}>文本</option>
                            <option value="html" ${type==='html'?'selected':''}>HTML</option>
                            <option value="image" ${type==='image'?'selected':''}>图片/表情包 URL</option>
                            <option value="voice" ${type==='voice'?'selected':''}>语音条</option>
                            <option value="redpacket" ${type==='redpacket'?'selected':''}>红包</option>
                            <option value="transfer" ${type==='transfer'?'selected':''}>转账</option>
                        </select>
                    </div>
                    <textarea class="edit-block-content w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm min-h-[80px] focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500 transition-all resize-y placeholder-gray-400" placeholder="请输入消息内容...">${content}</textarea>
                `;
                container.appendChild(div);
                setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'end' }), 50);
            },

            // 保存更改 (一次性处理所有消息块)
            confirmEditMsg: () => { 
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                
                const blocks = document.querySelectorAll('#edit-msg-list > div');
                const newMsgs = [];
                
                blocks.forEach(div => {
                    const role = div.querySelector('.edit-block-role').value;
                    const type = div.querySelector('.edit-block-type').value;
                    const content = div.querySelector('.edit-block-content').value;
                    
                    let msg = { role, type, content, timestamp: Date.now() };
                    
                    if(type === 'voice') { msg.text = content; msg.content = 'Voice'; }
                    else if(type === 'image') { msg.originalContent = content; msg.content = '[图片]'; }
                    else if(type === 'redpacket') { msg.note = content || '恭喜发财'; msg.content = '红包'; msg.amount = '88.88'; }
                    else if(type === 'transfer') { msg.note = content || '转账'; msg.content = '转账'; msg.amount = '520.00'; }
                    else if(type === 'html') { msg.type = 'html'; } // 保留HTML类型，不转换为文本类型
                    
                    newMsgs.push(msg);
                });
                
                if(newMsgs.length === 0) return;
                
                // 将原位置的一条消息，替换为新编辑的 N 条消息
                chars[cid].msgs.splice(WeChatUI.ctxTargetMsg, 1, ...newMsgs);
                
                Storage.set('wechat_chars', chars);
                document.getElementById('modal-edit-msg').classList.add('hidden');
                WeChatUI.loadChat(cid);
                Utils.showToast('修改已保存');
            },
            
            // 保留空函数，防止报错
            insertMsgBelow: () => {}, 

            enterMultiSelectMode: () => {
                WeChatUI.isMultiSelect = true;
                document.getElementById('subpage-chat-detail').classList.add('multiselect-mode');
            },
            exitMultiSelectMode: () => {
                WeChatUI.isMultiSelect = false;
                document.getElementById('subpage-chat-detail').classList.remove('multiselect-mode');
                document.querySelectorAll('.msg-checkbox').forEach(el => el.classList.remove('checked'));
            },
            toggleSelect: (idx, el) => {
                if(!WeChatUI.isMultiSelect) return;
                el.classList.toggle('checked');
                el.dataset.idx = idx;
            },
            deleteSelectedMessages: () => {
                const selectedEls = document.querySelectorAll('.msg-checkbox.checked');
                if(selectedEls.length === 0) return;
                if(!confirm(`确定删除?`)) return;
                const cid = document.getElementById('subpage-chat-detail').dataset.charId;
                const chars = Storage.get('wechat_chars', {});
                const indicesToDelete = Array.from(selectedEls).map(el => parseInt(el.dataset.idx)).sort((a,b) => b-a);
                indicesToDelete.forEach(idx => {
                    chars[cid].msgs.splice(idx, 1);
                });
                Storage.set('wechat_chars', chars);
                WeChatUI.exitMultiSelectMode();
                WeChatUI.loadChat(cid);
            },
            
            // Contact Management
            showContactMenu: (e, id) => {
                e.preventDefault();
                e.stopPropagation();
                WeChatUI.ctxTargetContact = id;
                const menu = document.getElementById('contact-context-menu');
                menu.style.display = 'block';
                menu.style.opacity = '1';
                let top = e.clientY;
                let left = e.clientX;
                if (top + 100 > window.innerHeight) top = window.innerHeight - 100;
                if (left + 140 > window.innerWidth) left = window.innerWidth - 140;
                menu.style.top = top + 'px';
                menu.style.left = left + 'px';
            },
            deleteContact: () => {
                if(confirm('确定删除该好友吗？所有聊天记录将丢失。')) {
                    const chars = Storage.get('wechat_chars', {});
                    delete chars[WeChatUI.ctxTargetContact];
                    Storage.set('wechat_chars', chars);
                    WeChatUI.renderList();
                    Utils.showToast('好友已删除');
                }
                document.getElementById('contact-context-menu').style.display = 'none';
            },

            closeSubPage: (id) => {
                HistoryManager.back();
            },

            // 个人信息相关功能
            
            // 打开头像上传
            openAvatarUpload: () => {
                document.getElementById('modal-avatar-upload').classList.remove('hidden');
            },

            // 处理头像上传
            handleAvatarUpload: (input) => {
                if(input.files[0]) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        // 更新用户头像
                        const userProfile = Storage.get('wechat_user_profile', {});
                        userProfile.avatar = base64;
                        Storage.set('wechat_user_profile', userProfile);
                        
                        // 更新UI
                        document.getElementById('user-avatar').src = base64;
                        document.getElementById('editor-avatar').src = base64;
                        document.getElementById('moments-avatar').src = base64;
                        document.getElementById('user-moments-avatar').src = base64;
                        
                        // 关闭模态框
                        document.getElementById('modal-avatar-upload').classList.add('hidden');
                        
                        // 显示提示
                        Utils.showToast('头像已更新');
                    });
                }
            },

            // 编辑用户名
            editUserName: () => {
                const userProfile = Storage.get('wechat_user_profile', {});
                // 显示内部弹窗
                document.getElementById('edit-username-input').value = userProfile.name || '我';
                document.getElementById('modal-edit-username').classList.remove('hidden');
            },

            // 取消修改用户名
            cancelEditUsername: () => {
                document.getElementById('modal-edit-username').classList.add('hidden');
            },

            // 确认修改用户名
            confirmEditUsername: () => {
                const userProfile = Storage.get('wechat_user_profile', {});
                const newName = document.getElementById('edit-username-input').value;
                
                if(newName && newName.trim()) {
                    userProfile.name = newName.trim();
                    Storage.set('wechat_user_profile', userProfile);
                    
                    // 更新UI
                    document.getElementById('user-name').textContent = newName.trim();
                    document.getElementById('moments-name').textContent = newName.trim();
                    
                    // 显示提示
                    Utils.showToast('用户名已更新');
                }
                
                // 关闭弹窗
                document.getElementById('modal-edit-username').classList.add('hidden');
            },

            // 钱包相关功能
            
            // 初始化钱包
            initWallet: () => {
                const wallet = Storage.get('wechat_wallet', null);
                if(!wallet) {
                    Storage.set('wechat_wallet', { balance: 0, transactions: [] });
                }
            },

            // 打开钱包页面
            openWallet: () => {
                // 初始化钱包数据
                WeChatUI.initWallet();
                
                // 打开钱包页面
                WeChatUI.openSubPage('subpage-wallet');
                
                // 加载钱包数据（页面显示后再加载）
                WeChatUI.loadWalletData();
            },

            // 加载钱包数据
            loadWalletData: () => {
                const wallet = Storage.get('wechat_wallet', { balance: 0, transactions: [] });
                
                // 更新余额显示
                document.getElementById('wallet-balance').textContent = `¥${wallet.balance.toFixed(2)}`;
                
                // 更新交易记录
                const transactionList = document.getElementById('transaction-list');
                if(wallet.transactions.length === 0) {
                    transactionList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">暂无交易记录</div>';
                    return;
                }
                
                // 按时间倒序排列
                const sortedTransactions = [...wallet.transactions].sort((a, b) => b.timestamp - a.timestamp);
                
                transactionList.innerHTML = sortedTransactions.map(t => `
                    <div class="bg-[#191919] rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg ${t.type === 'recharge' ? 'bg-green-500' : 'bg-red-500'} flex items-center justify-center text-white">
                                    <i class="fa-solid ${t.type === 'recharge' ? 'fa-plus' : 'fa-minus'} text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-medium">${t.type === 'recharge' ? '充值' : t.type === 'send' ? '转账' : '收入'}</div>
                                    <div class="text-xs text-gray-400">${new Date(t.timestamp).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="text-lg font-bold ${t.type === 'recharge' ? 'text-green-500' : 'text-red-500'}">
                                ${t.type === 'recharge' ? '+' : '-'}` + `¥${Math.abs(t.amount).toFixed(2)}</div>
                        </div>
                        ${t.description ? `<div class="text-xs text-gray-500 mt-2">${t.description}</div>` : ''}
                    </div>
                `).join('');
            },

            openSubPage: (id) => {
                if(id === 'subpage-moments') {
                    WeChatUI.loadMoments();
                }
                document.getElementById(id).classList.add('active');
                HistoryManager.push(id);
            },
            // --- 核心渲染：朋友圈列表显示 ---
            loadMoments: () => {
                const userProfile = Storage.get('wechat_user_profile', {});
                document.getElementById('moments-name').textContent = userProfile.name || '我';
                document.getElementById('moments-avatar').src = userProfile.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=Default64';
                document.getElementById('moments-bg').src = userProfile.momentsBg || 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800&q=80';
                document.getElementById('moments-bio').textContent = userProfile.bio || '暂无个性签名';
                document.getElementById('editor-avatar').src = userProfile.avatar;
                
                const moments = Storage.get('wechat_moments', []);
                const notices = Storage.get('wechat_social_notices', []);
                const unreadCount = notices.filter(n => !n.read).length;
                const momentsList = document.getElementById('moments-list');
                
                // 1. 新消息提醒
                let noticeHtml = '';
                if (unreadCount > 0) {
                    const lastNotice = notices[0];
                    noticeHtml = `
                    <div onclick="WeChatUI.openSocialNotices()" class="mx-auto w-40 bg-[#333] rounded-[5px] py-2 px-3 flex items-center justify-center gap-2 mb-6 cursor-pointer relative -mt-8 shadow-lg z-20">
                        <div class="w-8 h-8 rounded-[4px] overflow-hidden"><img src="${lastNotice.actorAvatar}" class="w-full h-full object-cover"></div>
                        <span class="text-white text-sm font-medium">${unreadCount}条新消息</span>
                        <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                    </div>`;
                }
                
                // 2. 列表渲染
                moments.sort((a, b) => b.timestamp - a.timestamp);
                const listHtml = moments.map(moment => {
                    let author = { name: '我', avatar: userProfile.avatar };
                    if(moment.authorType !== 'user') {
                        const chars = Storage.get('wechat_chars', {});
                        const npcs = Storage.get('wechat_npcs', {});
                        if(moment.authorType === 'char' && chars[moment.authorId]) author = chars[moment.authorId];
                        if(moment.authorType === 'npc' && npcs[moment.authorId]) author = npcs[moment.authorId];
                    }
                    
                    const safeName = encodeURIComponent(author.name || '未知');
                    const safeAvatar = encodeURIComponent(author.avatar || '');
                    
                    // 图片链接解析逻辑
                    let displayContent = moment.content;
                    let inlineImages = [];
                    const urlRegex = /(https?:\/\/[^\s]+?\.(?:png|jpg|jpeg|gif|webp))/gi;
                    displayContent = displayContent.replace(urlRegex, (match) => {
                        inlineImages.push(match);
                        return ''; 
                    });
                    const allImages = [...(moment.images || []), ...inlineImages];
                    
                    const imagesHtml = allImages.length > 0 ? 
                        `<div class="grid grid-cols-3 gap-1 mt-2">${allImages.map(img => `<div class="aspect-square bg-gray-200 overflow-hidden cursor-pointer" onclick="window.open('${img}')"><img src="${img}" class="w-full h-full object-cover"></div>`).join('')}</div>` : '';
                    
                    const commentsHtml = moment.comments && moment.comments.length > 0 ? 
                        `<div class="mt-2 bg-[#f7f7f7] p-2 rounded text-sm leading-6">
                            ${moment.comments.map(c => `<div onclick="WeChatUI.replyToComment(${moment.id}, '${encodeURIComponent(c.author)}')"><span class="text-[#576b95] font-medium">${c.author}</span>：<span class="text-[#111]">${c.content}</span></div>`).join('')}
                        </div>` : '';

                    // 自己的朋友圈显示删除按钮
                    const isMine = moment.authorType === 'user';
                    const menuButton = isMine ? `<div class="text-[#576b95] text-xl cursor-pointer px-2" onclick="WeChatUI.showMomentOptions(${moment.id})"><i class="fa-solid fa-ellipsis"></i></div>` : '';

                    return `
                    <div class="bg-white p-4 border-b border-gray-100 mb-2 relative">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-[4px] overflow-hidden cursor-pointer" onclick="WeChatUI.openUserMomentsPage('${moment.authorType}', '${moment.authorId}', '${safeName}', '${safeAvatar}')">
                                <img src="${author.avatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div class="text-[#576b95] font-bold cursor-pointer" onclick="WeChatUI.openUserMomentsPage('${moment.authorType}', '${moment.authorId}', '${safeName}', '${safeAvatar}')">${author.name}</div>
                                    ${menuButton}
                                </div>
                                <div class="text-[15px] text-gray-900 mt-1 mb-1 leading-normal whitespace-pre-wrap">${displayContent}</div>
                                ${imagesHtml}
                                <div class="mt-2 text-xs text-gray-400">
                                    <span>${Utils.formatChatTime(moment.timestamp)}</span>
                                </div>
                                ${moment.likes && moment.likes.length > 0 ? `<div class="flex items-center gap-2 mt-2 text-sm text-gray-500"><i class="fa-solid fa-heart text-red-500"></i><span>${moment.likes.join('、')}</span></div>` : ''}
                                ${commentsHtml}
                                <div class="flex justify-between items-center mt-3 text-sm text-gray-500 border-t border-gray-100 pt-3">
                                    <button class="flex items-center gap-1 hover:text-blue-500" onclick="WeChatUI.likeMoment(${moment.id})"><i class="fa-regular fa-heart"></i><span>点赞</span></button>
                                    <button class="flex items-center gap-1 hover:text-blue-500" onclick="WeChatUI.commentMoment(${moment.id})"><i class="fa-regular fa-comment"></i><span>评论</span></button>
                                    <button class="flex items-center gap-1 hover:text-blue-500" onclick="WeChatUI.shareMoment(${moment.id})"><i class="fa-regular fa-share-from-square"></i><span>分享</span></button>
                                    <button class="flex items-center gap-1 hover:text-blue-500" onclick="WeChatUI.summonInteractions(${moment.id})"><i class="fa-solid fa-users"></i><span>召唤互动</span></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                momentsList.innerHTML = noticeHtml + listHtml;
            },

            // --- 核心逻辑：生成、互动、通知 ---

            // 1. 生成朋友圈 (AI)
            generateMoments: async () => {
                // 获取AI配置，检查是否可以调用API
                const apiConfigs = Storage.get('api_configs', [{id: 'default', name: '默认设置', url: '', key: '', model: '', temp: 0.7}]);
                const currentApiId = Storage.get('current_api_id', 'default');
                const apiConfig = apiConfigs.find(c => c.id === currentApiId) || {};
                if (!apiConfig.key || !apiConfig.url) {
                    Utils.showToast('AI连接未配置，无法生成朋友圈');
                    return;
                }
                
                const chars = Storage.get('wechat_chars', {});
                const npcs = Storage.get('wechat_npcs', {});
                const moments = Storage.get('wechat_moments', []);
                const allAuthors = [...Object.values(chars), ...Object.values(npcs)];
                if(allAuthors.length === 0) return Utils.showToast('暂无角色或NPC');
                Utils.showToast('朋友们正在分享生活...');
                
                const num = Math.floor(Math.random() * 2) + 1;
                const selected = allAuthors.sort(() => 0.5 - Math.random()).slice(0, num);
                
                for(const author of selected) {
                    try {
                        const isChar = author.id.startsWith('char_');
                        const prompt = `你是${author.name}，${isChar ? author.prompt : author.personality}。请发一条朋友圈。格式：第一行文案，第二行[有图]或[无图]，第三行图片Prompt`;
                        const res = await SettingsLogic.generateLLM([{role: 'user', content: prompt}], author.id);
                        const lines = res.split('\n').filter(l => l.trim());
                        
                        let imgUrl = '';
                        if(res.includes('[有图]') && lines.length > 2) {
                            const p = lines[2].replace(/\[.*?\]/g, '').trim();
                            if(p) imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(p)}?width=800&height=800`;
                        }

                        const newMoment = {
                            id: Date.now() + Math.random(),
                            authorId: author.id,
                            authorType: isChar ? 'char' : 'npc',
                            content: lines[0] || '分享生活',
                            images: imgUrl ? [imgUrl] : [],
                            likes: [],
                            comments: [],
                            timestamp: Date.now()
                        };
                        moments.push(newMoment);
                        Storage.set('wechat_moments', moments);
                        if(WeChatUI.triggerMomentsInteraction) setTimeout(() => WeChatUI.triggerMomentsInteraction(newMoment), 3000);
                    } catch(e) {
                        console.error('生成朋友圈失败:', e);
                        Utils.showToast('生成朋友圈时发生错误');
                    }
                }
                WeChatUI.loadMoments();
                Utils.showToast('朋友圈已更新');
            },

            // 2. 互动引擎 - 只通过AI生成互动
            triggerMomentsInteraction: async (moment) => {
                const chars = Storage.get('wechat_chars', {});
                const others = Object.values(chars).filter(c => c.id !== moment.authorId);
                if(others.length === 0) return;
                
                // 获取AI配置，检查是否可以调用API
                const apiConfigs = Storage.get('api_configs', [{id: 'default', name: '默认设置', url: '', key: '', model: '', temp: 0.7}]);
                const currentApiId = Storage.get('current_api_id', 'default');
                const apiConfig = apiConfigs.find(c => c.id === currentApiId) || {};
                if (!apiConfig.key || !apiConfig.url) {
                    Utils.showToast('AI连接未配置，无法生成互动');
                    return;
                }
                
                const interactors = others.sort(() => 0.5 - Math.random()).slice(0, 2);

                for (const char of interactors) {
                    await new Promise(r => setTimeout(r, 2000));
                    const moments = Storage.get('wechat_moments', []);
                    const current = moments.find(m => m.id === moment.id);
                    if(!current) continue;

                    try {
                        // 决定互动类型
                        const interactionType = Math.random() > 0.4 ? 'like' : 'comment';
                        
                        if (interactionType === 'like') {
                            if(!current.likes) current.likes = [];
                            if(!current.likes.includes(char.name)) {
                                current.likes.push(char.name);
                                if(current.authorType === 'user') WeChatUI.addSocialNotice('like', char, '赞了你', current);
                            }
                        } else {
                            // 通过AI生成评论内容
                            const prompt = `你的朋友发了：“${current.content}”。请以${char.name}口吻回复一句。只输出内容，不要添加任何额外格式。`;
                            const text = await SettingsLogic.generateLLM([{role: 'user', content: prompt}], char.id);
                            
                            if(text && text.trim()) {
                                if(!current.comments) current.comments = [];
                                current.comments.push({ 
                                    author: char.name, 
                                    content: text.trim(), 
                                    timestamp: Date.now() 
                                });
                                if(current.authorType === 'user') WeChatUI.addSocialNotice('comment', char, text.trim(), current);
                            }
                        }
                        
                        Storage.set('wechat_moments', moments);
                        if(document.getElementById('subpage-moments').classList.contains('active')) WeChatUI.loadMoments();
                    } catch(e) {
                        console.error('生成互动失败:', e);
                        // 不显示错误提示，避免影响用户体验
                    }
                }
            },

            // 3. 通知系统
            addSocialNotice: (type, actor, content, moment) => {
                const notices = Storage.get('wechat_social_notices', []);
                notices.unshift({
                    id: Date.now(), type, actorName: actor.name, actorAvatar: actor.avatar, content,
                    momentImg: moment.images?.[0]||'', momentText: moment.content, read: false, timestamp: Date.now()
                });
                Storage.set('wechat_social_notices', notices);
                WeChatUI.showGlobalNotification(actor.name, content, actor.avatar);
                if(document.getElementById('subpage-moments').classList.contains('active')) WeChatUI.loadMoments();
            },

            // 4. 分享与用户详情
            openUserMomentsPage: (authorType, authorId, encName, encAvatar) => {
                const name = decodeURIComponent(encName || '');
                const avatar = decodeURIComponent(encAvatar || '');
                document.getElementById('user-moments-title').textContent = name;
                document.getElementById('user-moments-name').textContent = name;
                document.getElementById('user-moments-avatar').src = avatar;
                
                const page = document.getElementById('subpage-user-moments');
                page.dataset.userId = authorId;
                page.dataset.userType = authorType;
                
                let bgUrl = '';
                let bio = '';
                if(authorType === 'user') {
                    const p = Storage.get('wechat_user_profile', {});
                    bgUrl = p.momentsBg; bio = p.bio || '暂无个性签名';
                } else {
                    const chars = Storage.get('wechat_chars', {}); const npcs = Storage.get('wechat_npcs', {});
                    let target = authorType === 'char' ? chars[authorId] : npcs[authorId];
                    if (target) {
                        bio = target.bio || (target.prompt || target.personality || '').substring(0, 30);
                        bgUrl = target.momentsBg || `https://image.pollinations.ai/prompt/scenery ${encodeURIComponent(target.name)}?width=800&height=600`;
                    }
                }
                document.getElementById('user-moments-bg').src = bgUrl || 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800&q=80';
                document.getElementById('user-moments-bio').textContent = bio;
                WeChatUI.renderUserMomentsList(authorId, authorType);
                WeChatUI.openSubPage('subpage-user-moments');
            },
            
            renderUserMomentsList: (authorId, authorType) => {
                const moments = Storage.get('wechat_moments', []);
                const list = moments.filter(m => m.authorId === authorId).sort((a,b) => b.timestamp - a.timestamp);
                const el = document.getElementById('user-moments-list');
                el.innerHTML = list.length === 0 ? '<div class="text-center text-gray-500 py-10">暂无动态</div>' :
                    list.map(m => `<div class="bg-white rounded-lg p-4 mb-4 shadow-sm"><div class="text-xs text-gray-400 mb-2">${Utils.formatChatTime(m.timestamp)}</div><div class="text-sm text-gray-800">${m.content}</div>${m.images?.length?`<div class="mt-2"><img src="${m.images[0]}" class="w-32 h-32 object-cover rounded"></div>`:''}<div class="mt-2 border-t pt-2 flex justify-end gap-3 text-gray-500 text-xs"><span onclick="WeChatUI.likeMoment(${m.id})"><i class="fa-regular fa-heart"></i> ${m.likes?.length||0}</span><span onclick="WeChatUI.commentMoment(${m.id})"><i class="fa-regular fa-comment"></i> ${m.comments?.length||0}</span></div></div>`).join('');
            },

            openSocialNotices: () => {
                const notices = Storage.get('wechat_social_notices', []);
                const list = document.getElementById('moments-notices-list');
                notices.forEach(n => n.read = true);
                Storage.set('wechat_social_notices', notices);
                list.innerHTML = notices.map(n => `<div class="flex gap-3 p-4 border-b border-gray-800 bg-[#111]"><div class="w-10 h-10 rounded overflow-hidden shrink-0"><img src="${n.actorAvatar}" class="w-full h-full object-cover"></div><div class="flex-1 min-w-0"><div class="flex justify-between"><span class="text-[#576b95] font-bold text-sm">${n.actorName}</span><span class="text-xs text-gray-500">${Utils.formatChatTime(n.timestamp)}</span></div><div class="text-white text-sm mt-1">${n.type==='like' ? '赞了你' : n.content}</div></div><div class="w-12 h-12 bg-gray-800 shrink-0 overflow-hidden ml-2">${n.momentImg ? `<img src="${n.momentImg}" class="w-full h-full object-cover">` : `<div class="text-gray-500 text-[10px] p-1">${n.momentText}</div>`}</div></div>`).join('');
                WeChatUI.openSubPage('subpage-moments-notices');
            },

            // 5. 分享功能 (UI弹窗逻辑)
            shareMoment: (momentId) => {
                const moments = Storage.get('wechat_moments', []);
                const m = moments.find(x => x.id === momentId);
                if(!m) return;
                
                let authorName = '我';
                if(m.authorType === 'char') authorName = Storage.get('wechat_chars', {})[m.authorId]?.name || '好友';
                else if(m.authorType === 'npc') authorName = Storage.get('wechat_npcs', {})[m.authorId]?.name || 'NPC';

                const sharePayload = { type: 'moment_share', text: m.content, image: m.images?.[0] || '', author: authorName };
                if(WeChatUI.currentChatId) {
                    WeChatUI.pushMessage('moment_share', sharePayload, 'user', 'moment_share');
                    Utils.showToast('已分享');
                    WeChatUI.closeSubPage('subpage-moments');
                } else {
                    WeChatUI.showShareContactList(sharePayload);
                }
            },
            showShareContactList: (payload) => {
                WeChatUI.tempSharePayload = payload;
                const modal = document.getElementById('modal-moments-share');
                const list = document.getElementById('share-chat-list');
                const chars = Storage.get('wechat_chars', {});
                list.innerHTML = Object.keys(chars).length === 0 ? '<div class="text-center text-gray-500 py-4">暂无联系人</div>' : 
                    Object.values(chars).map(c => `<div class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded-lg" onclick="WeChatUI.confirmShareTo('${c.id}')"><div class="w-10 h-10 rounded-lg overflow-hidden bg-gray-200"><img src="${c.avatar}" class="w-full h-full object-cover"></div><span class="font-medium text-gray-800">${c.name}</span></div>`).join('');
                modal.classList.remove('hidden');
            },
            confirmShareTo: (cid) => {
                if(!WeChatUI.tempSharePayload) return;
                // 直接处理聊天打开和消息发送，避免历史记录混乱
                const chars = Storage.get('wechat_chars', {});
                if(chars[cid]) {
                    chars[cid].unread = 0;
                    Storage.set('wechat_chars', chars);
                }
                WeChatUI.renderList();
                WeChatUI.loadChat(cid);
                document.getElementById('subpage-chat-detail').dataset.charId = cid;
                document.getElementById('subpage-chat-detail').dataset.npcId = '';
                document.getElementById('subpage-chat-detail').classList.add('active');
                
                // 立即发送消息，不需要延迟
                WeChatUI.pushMessage('moment_share', WeChatUI.tempSharePayload, 'user', 'moment_share');
                WeChatUI.tempSharePayload = null;
                document.getElementById('modal-moments-share').classList.add('hidden');
                document.getElementById('subpage-moments').classList.remove('active');
                Utils.showToast('已分享');
            },

            // 6. UI交互 (点赞/评论/召唤/编辑/删除)
            likeMoment: (id) => {
                const moments = Storage.get('wechat_moments', []);
                const m = moments.find(x => x.id === id);
                if(m) {
                    if(!m.likes) m.likes = [];
                    const name = Storage.get('wechat_user_profile', {name:'我'}).name;
                    if(!m.likes.includes(name)) m.likes.push(name);
                    else m.likes = m.likes.filter(n => n !== name);
                    Storage.set('wechat_moments', moments);
                    WeChatUI.loadMoments();
                }
            },
            commentMoment: (id) => {
                Utils.showPrompt('评论', '输入内容:', (val) => {
                    if(!val) return;
                    const moments = Storage.get('wechat_moments', []);
                    const m = moments.find(x => x.id === id);
                    if(m) {
                        if(!m.comments) m.comments = [];
                        m.comments.push({author: Storage.get('wechat_user_profile', {name:'我'}).name, content: val, timestamp: Date.now()});
                        Storage.set('wechat_moments', moments);
                        WeChatUI.loadMoments();
                    }
                });
            },
            replyToComment: (momentId, encName) => {
                const name = decodeURIComponent(encName);
                Utils.showPrompt(`回复 ${name}`, `回复内容:`, (val) => {
                    if(!val) return;
                    const moments = Storage.get('wechat_moments', []);
                    const m = moments.find(x => x.id === momentId);
                    if(m) {
                        m.comments.push({author: '我', content: `回复 ${name}：${val}`, timestamp: Date.now()});
                        Storage.set('wechat_moments', moments);
                        WeChatUI.loadMoments();
                        if(document.getElementById('subpage-user-moments').classList.contains('active')) {
                            const p = document.getElementById('subpage-user-moments');
                            WeChatUI.renderUserMomentsList(p.dataset.userId, p.dataset.userType);
                        }
                    }
                });
            },
            summonInteractions: (id) => {
                const moments = Storage.get('wechat_moments', []);
                const m = moments.find(x => x.id === id);
                if(m) {
                    // 获取AI配置，检查是否可以调用API
                    const apiConfigs = Storage.get('api_configs', [{id: 'default', name: '默认设置', url: '', key: '', model: '', temp: 0.7}]);
                    const currentApiId = Storage.get('current_api_id', 'default');
                    const apiConfig = apiConfigs.find(c => c.id === currentApiId) || {};
                    if (!apiConfig.key || !apiConfig.url) {
                        Utils.showToast('AI连接未配置，无法召唤互动');
                        return;
                    }
                    WeChatUI.triggerMomentsInteraction(m);
                    Utils.showToast('正在召唤互动...');
                }
            },
            
            openMomentsEditor: () => {
                document.getElementById('modal-moments-editor').classList.remove('hidden');
                document.getElementById('moments-content').value = '';
                document.getElementById('moments-image-preview').innerHTML = '';
                WeChatUI.tempMomentsImages = [];
            },
            handleMomentsImageUpload: () => {
                const input = document.getElementById('moments-image-input');
                if(input.files && input.files[0]) {
                    Utils.compressImage(input.files[0]).then(base64 => {
                        if(!WeChatUI.tempMomentsImages) WeChatUI.tempMomentsImages = [];
                        WeChatUI.tempMomentsImages.push(base64);
                        WeChatUI.renderMomentsImgPreview();
                    });
                }
            },
            generateMomentsImage: () => {
                Utils.showPrompt('AI配图', '画面描述:', (val) => {
                    if(!val) return;
                    const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(val)}?width=800&height=800`;
                    if(!WeChatUI.tempMomentsImages) WeChatUI.tempMomentsImages = [];
                    WeChatUI.tempMomentsImages.push(url);
                    WeChatUI.renderMomentsImgPreview();
                });
            },
            generateMomentsImageWithPrompt: () => { /* 兼容旧调用 */ WeChatUI.generateMomentsImage(); },
            renderMomentsImgPreview: () => {
                const container = document.getElementById('moments-image-preview');
                container.innerHTML = (WeChatUI.tempMomentsImages || []).map(img => 
                    `<div class="aspect-square bg-gray-200 rounded overflow-hidden relative"><img src="${img}" class="w-full h-full object-cover"><div onclick="this.parentElement.remove()" class="absolute top-0 right-0 bg-black/50 text-white w-5 h-5 flex items-center justify-center cursor-pointer">×</div></div>`
                ).join('');
            },
            publishMoments: () => {
                const content = document.getElementById('moments-content').value.trim();
                const images = WeChatUI.tempMomentsImages || [];
                if(!content && images.length === 0) return Utils.showToast('写点什么吧');

                const moments = Storage.get('wechat_moments', []);
                const newMoment = {
                    id: Date.now(), authorId: 'user', authorType: 'user',
                    content: content, images: images, likes: [], comments: [], timestamp: Date.now()
                };
                moments.push(newMoment);
                Storage.set('wechat_moments', moments);
                
                document.getElementById('modal-moments-editor').classList.add('hidden');
                WeChatUI.loadMoments();
                Utils.showToast('发布成功');
                WeChatUI.triggerMomentsInteraction(newMoment);
                
                // 通知所有角色关于用户的新朋友圈
                WeChatUI.notifyCharsAboutNewMoment(newMoment);
            },

            openMomentsSettings: () => {
                const p = Storage.get('wechat_user_profile', {});
                document.getElementById('input-moments-bio').value = p.bio || '';
                document.getElementById('moments-bg-url').value = p.momentsBg || '';
                document.getElementById('modal-moments-settings').classList.remove('hidden');
            },
            handleMomentsBgUpload: (input) => {
                if(input.files[0]) Utils.compressImage(input.files[0]).then(b64 => { document.getElementById('moments-bg-url').value = b64; });
            },
            applyMomentsBgUrl: () => {
                const p = Storage.get('wechat_user_profile', {});
                p.bio = document.getElementById('input-moments-bio').value;
                p.momentsBg = document.getElementById('moments-bg-url').value;
                p.momentsFrequency = document.getElementById('moments-frequency').value;
                Storage.set('wechat_user_profile', p);
                WeChatUI.loadMoments();
                document.getElementById('modal-moments-settings').classList.add('hidden');
                Utils.showToast('设置已保存');
            },
            
            showMomentOptions: (momentId) => {
                WeChatUI.currentMomentId = momentId;
                const m = Storage.get('wechat_moments', []).find(x => x.id === momentId);
                if(!m) return;
                if(m.authorType !== 'user') return Utils.showToast('只能操作自己的动态');
                
                // Set up event listeners for options
                document.getElementById('moment-option-edit').onclick = () => {
                    WeChatUI.editMoment(momentId);
                    document.getElementById('modal-moments-options').classList.add('hidden');
                };
                
                document.getElementById('moment-option-delete').onclick = () => {
                    WeChatUI.deleteMoment(momentId);
                    document.getElementById('modal-moments-options').classList.add('hidden');
                };
                
                // Open options modal
                document.getElementById('modal-moments-options').classList.remove('hidden');
            },
            editMoment: (momentId) => {
                // Get the moment to edit
                const moments = Storage.get('wechat_moments', []);
                const moment = moments.find(m => m.id === momentId);
                if(!moment) return;
                
                // Set up edit modal with current moment data
                const userProfile = Storage.get('wechat_user_profile', {});
                document.getElementById('edit-moment-avatar').src = userProfile.avatar || 'https://via.placeholder.com/40';
                document.getElementById('edit-moments-content').value = moment.content;
                document.getElementById('edit-moments-only-me').checked = moment.onlyMe || false;
                document.getElementById('edit-moments-location').value = moment.location || '';
                
                // Render current images
                const preview = document.getElementById('edit-moments-image-preview');
                if(moment.images && moment.images.length > 0) {
                    preview.innerHTML = moment.images.map(img => `<div class="aspect-square rounded overflow-hidden relative">
                        <img src="${img}" class="w-full h-full object-cover">
                        <button class="absolute top-1 right-1 w-5 h-5 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70" onclick="this.parentElement.remove()">
                            <i class="fa-solid fa-xmark text-xs"></i>
                        </button>
                    </div>`).join('');
                } else {
                    preview.innerHTML = '';
                }
                
                // Store current moment id for saving
                WeChatUI.currentEditingMomentId = momentId;
                
                // Open edit modal
                document.getElementById('modal-moments-edit').classList.remove('hidden');
            },
            saveEditedMoment: () => {
                const momentId = WeChatUI.currentEditingMomentId;
                if(!momentId) return;
                
                // Get updated data from form
                const content = document.getElementById('edit-moments-content').value.trim();
                if(!content) return alert('请输入朋友圈内容');
                
                const preview = document.getElementById('edit-moments-image-preview');
                const images = Array.from(preview.querySelectorAll('img')).map(img => img.src);
                
                // Update moment data
                const moments = Storage.get('wechat_moments', []);
                const momentIndex = moments.findIndex(m => m.id === momentId);
                if(momentIndex === -1) return;
                
                moments[momentIndex] = {
                    ...moments[momentIndex],
                    content: content,
                    images: images,
                    onlyMe: document.getElementById('edit-moments-only-me').checked,
                    location: document.getElementById('edit-moments-location').value.trim() || ''
                };
                
                // Save to storage
                Storage.set('wechat_moments', moments);
                
                // Close modal and reload moments
                document.getElementById('modal-moments-edit').classList.add('hidden');
                WeChatUI.loadMoments();
                Utils.showToast('朋友圈已更新');
            },
            deleteMoment: (id) => {
                if(!confirm('确定删除?')) return;
                let moments = Storage.get('wechat_moments', []);
                moments = moments.filter(m => m.id !== (id || WeChatUI.currentMomentId));
                Storage.set('wechat_moments', moments);
                WeChatUI.loadMoments();
                document.getElementById('modal-moments-options').classList.add('hidden');
                Utils.showToast('已删除');
            },

            sendSystemNotification: (message) => {
                WeChatUI.showGlobalNotification('系统', message, '');
            },
            updateWalletBalance: (type, amount, description) => {
                const wallet = Storage.get('wechat_wallet', { balance: 0, transactions: [] });
                
                if(type === 'income') {
                    wallet.balance += amount;
                } else if(type === 'expense') {
                    wallet.balance -= amount;
                }
                
                // 添加交易记录
                wallet.transactions.push({
                    id: Date.now(),
                    type: type,
                    amount: amount,
                    description: description,
                    timestamp: Date.now()
                });
                
                // 保存钱包数据
                Storage.set('wechat_wallet', wallet);
            },
        }; // <--- WeChatUI 对象的完美句号


        // Enter key
        document.getElementById('chat-input').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); WeChatUI.sendUserMessage(false); } });

        // Init
        WeChatUI.checkInit();
        SettingsUI.init();
        WeChatUI.renderList();
        
        // --- 新增：原生浏览器历史记录支持 (按手机返回键关闭页面) ---
        window.addEventListener('popstate', (e) => {
            // 查找所有当前处于激活状态的子页面
            const activeSubViews = document.querySelectorAll('.sub-view.active');
            const activeApps = document.querySelectorAll('.app-window.active');
            
            // 优先关闭最上层的子页面
            if (activeSubViews.length > 0) {
                const topView = activeSubViews[activeSubViews.length - 1];
                topView.classList.remove('active');
            } 
            // 如果没有子页面，但有打开的App，则关闭App
            else if (activeApps.length > 0) {
                const topApp = activeApps[activeApps.length - 1];
                topApp.classList.remove('active');
            }
        });

        // 统一页面管理
        const HistoryManager = {
            push: (id) => {
                history.pushState({ viewId: id }, '', '');
            },
            back: () => {
                history.back();
            }
        };
    </script>
</body>
</html>
